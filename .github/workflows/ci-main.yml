name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  checks: # checks that don't need a wesnoth binary
    runs-on: ubuntu-latest
    container:
      image: wesnoth/wesnoth:2404-master
      options: --tty # docker create options
      env:
        CLICOLOR_FORCE: 1

    steps:
      - uses: actions/


# run after all other jobs have completed to check overall build status
  notification:
    runs-on: ubuntu-latest
    needs: [checks, ubuntu]
    if: failure() && github.event_name == 'push'

    steps:
      - name: Discord Notification
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: error
          webhookUrl: ${{ secrets.DISCORD_CI_WEBHOOK }}
          description: |-
            pusher: ${{ github.actor }}
            commit: ${{ github.event.head_commit.message }}
            commit url: ${{ github.event.head_commit.url }}
      - name: Prepare message
        if: github.event_name == 'push'
        env:
          MSG: ${{ github.event.head_commit.message }}
        run: |
          printf COMMIT_SUBJECT=%s "${MSG}" | head -n 1 >> "$GITHUB_ENV"
      - name: IRC Notification
        uses: rectalogic/notify-irc@v1
        with:
          channel: ${{ vars.IRC_CHANNEL }}
          server: ${{ vars.IRC_SERVER }}
          nickname: ${{ vars.IRC_NICK }} # is also used for sasl username
          sasl_password: ${{ secrets.IRC_SASL_PASSWORD }}
          message: "‚ùå ${{ github.workflow }} workflow run ${{ github.run_number }} failed on \x0306${{ github.ref_name }}\x0F: ${{ env.COMMIT_SUBJECT }} by \x0315${{ github.actor }}\x0F: \x0302${{ github.event.head_commit.url }}\x0F"
