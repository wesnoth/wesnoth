#!/bin/sh

if [ $# -ne 1 ]; then
	echo "Syntax: $0 <wesnoth version>"
	exit 1
fi

VERSION=$1
SITE=$HOME/public_html
SOURCE=$HOME/source
TRUNK=$SOURCE/trunk/
STABLE=$SOURCE/1.2/

if ! [ -d $SOURCE ]; then
	echo "$SOURCE not found."
	exit 1
fi

case $VERSION in
	1.2 )	cd $STABLE || exit 1
	;;
	1.3.* ) cd $TRUNK || exit 1
	;;
	trunk ) cd $TRUNK || exit 1
		rm -rf $SITE/$VERSION
	;;
	* ) 	echo "Unknown version."
		exit 1
	;;
esac
if [ -d $SITE/$VERSION ]; then
	echo "$SITE/$VERSION already exists."
	exit 1
fi
echo 'svn update...'
svn update
svn status
cd data/tools/unit_tree/ || exit 1
if [ "$VERSION" != "trunk" ]; then
	# insert a link for the new version
	sed -i -e "s,\(<p><a href=\"trunk/index.html\">Trunk</a></p>\),<p><a href=\"$VERSION/index.html\">Development ($VERSION)</a></p>\n\1," $SITE/index.html
	# make sure we update with the right version
	sed -i -e "s/\(my \$version = '\).*\(';\)/\1$VERSION\2/" units.pl
fi
./units.pl
# move the generated files to their proper place
mv files $SITE/$VERSION
cp -p templates/units.css $SITE/$VERSION
# revert to prevent future conflicts if $version changed
svn revert units.pl
