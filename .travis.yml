language: cpp
sudo:     required

services:
    - docker

matrix:
  include:
    - compiler: clang
      env: CXXSTD=11 NLS=true TOOL=scons
      
    - compiler: gcc
      env: CXXSTD=14 NLS=false TOOL=scons
      
    - compiler: gcc
      env: CXXSTD=11 NLS=false TOOL=scons OPT=-O0
      
    - compiler: gcc
      env: CXXSTD=11 NLS=false TOOL=cmake
      
    - compiler: clang
      env: CXXSTD=11 NLS=false TOOL=scons OPT=-O0
      
    - compiler: clang
      env: CXXSTD=11 NLS=false TOOL=cmake
      
    - os: osx
      compiler: clang
      env: CXXSTD=11 NLS=false TOOL=scons OPT=-O0

before_install:
    - export TARGETS="wesnoth wesnothd campaignd boost_unit_tests"
    - export EXTRA_FLAGS_RELEASE=""
    - export WML_TESTS=true
    - export CPP_TESTS=false
    - export PLAY_TEST=true
    - export MP_TEST=true
    - export WML_TEST_TIME=15

    - if [ "$NLS" == "true" ]; then
          export TARGETS="translations";
          export WML_TESTS=false;
          export CPP_TESTS=false;
          export PLAY_TEST=false;
          export MP_TEST=false;
      fi
    - if [ "$OPT" == "-O0" ]; then
          export EXTRA_FLAGS_RELEASE="-O0";
          export PLAY_TEST=false;
          export MP_TEST=false;
          export WML_TEST_TIME=20;
      fi

install:
    - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
          travis_wait ./utils/travis/install_deps.sh;
          export CXXFLAGS="-I/usr/local/opt/openssl/include $CFLAGS";
          export LDFLAGS="-L/usr/local/opt/openssl/lib $LDFLAGS";
      else
          docker build -t wesnoth-ubuntu:16.04 .;
      fi

script: 
    - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
          ./utils/travis/check_utf8.sh;
          ./utils/travis/utf8_bom_dog.sh;
          $CXX --version;
          scons cxxtool=$CXX ctool=$CC --debug=time build=release extra_flags_config="-pipe" extra_flags_release="$EXTRA_FLAGS_RELEASE" strict=true $TARGETS cxx_std=$CXXSTD nls=$NLS jobs=2;
      else
          export DISPLAY=:99.0;
          /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1024x768x24;
          
          if [ "$TOOL" == "cmake"  ]; then
              docker run wesnoth-ubuntu:16.04 bash -c "$CXX --version; cmake -DCMAKE_BUILD_TYPE=Release -DEXTRA_FLAGS_CONFIG="-pipe" -DEXTRA_FLAGS_RELEASE="$EXTRA_FLAGS_RELEASE" -DENABLE_STRICT_COMPILATION=true -DENABLE_NLS=$NLS -DENABLE_TESTS=$CPP_TESTS && make VERBOSE=1 -j2";
          else
              docker run wesnoth-ubuntu:16.04 bash -c "$CXX --version; scons cxxtool=$CXX ctool=$CC --debug=time build=release extra_flags_config="-pipe" extra_flags_release="$EXTRA_FLAGS_RELEASE" strict=true $TARGETS cxx_std=$CXXSTD nls=$NLS jobs=2";
          fi
      fi

after_failure:
    - if [ -f "errors.log" ]; then
          echo -e "\n*** \n*\n* Errors reported in wml unit tests, here is errors.log...\n*\n*** \n";
          cat errors.log;
      fi
    - ./utils/travis/test_executor.sh;

notifications:
    email: false
    irc:
        channels:
            - "chat.freenode.net#wesnoth-dev"
        template:
            - "\x02%{repository}\x0f#\x0312%{build_number}\x0f (\x0307%{branch}\x0f - \x02%{commit}\x0f : \x0303%{author}\x0f): \x02%{message}\x0f"
            - "Build details : \x0302%{build_url}\x0f"
        on_success: change
        on_failure: always
