#####
# API(s) being tested: [attacks][filter_student]
##
# Actions:
# Give a third unit (teacher, next to alice) a weapon special ability where the student's opponent damage is calculated with a formula.
# Have alice attack with their weapon.
##
# Expected end state:
# alice has taken 6 damage.
#####

{GENERIC_UNIT_TEST "affect_adjacent_apply_to_opponent_formula" (
    [event]
        name=start

        [modify_unit]
            [filter]
            [/filter]
            attacks_left=1
        [/modify_unit]
        [modify_unit]
            [filter]
                id=alice
            [/filter]
            level=5
        [/modify_unit]
        
        #move alice
        [do_command]
            [move]
                x=7,12
                y=3,3
            [/move]
        [/do_command]

        #adjacent to alice but not to bob
        [unit]
            id="teacher"
            type="test_attack_dummy"
            level=10
            x,y=11,3
            [modifications]
                [object]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [damage]
                                affect_allies=yes
                                ## self=teacher, stident=alive, other=bob, so 10 - 5 +1  = 6
                                value="(level - student.level + other.level)"
                                apply_to=opponent
                                [affect_adjacent]
                                    adjacent=n,ne,se,s,sw,nw
                                [/affect_adjacent]
                            [/damage]
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [do_command]
            [attack]
                weapon=0
                [source]
                    x,y=12,3
                [/source]
                [destination]
                    x,y=13,3
                [/destination]
            [/attack]
        [/do_command]

        [store_unit]
            [filter]
                id=alice
            [/filter]
            variable=alice
        [/store_unit]

        # 100 -6 = 94
        {ASSERT ({VARIABLE_CONDITIONAL alice.hitpoints equals 94})}

        {SUCCEED}
    [/event]
) SIDE1_LEADER="test_attack_dummy" SIDE2_LEADER="test_attack_dummy"}
