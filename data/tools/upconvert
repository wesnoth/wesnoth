#!/usr/bin/env python
#
# Up-convert UMC between versions.
#
# Note about the 1.3.1 -> 1.3.2 map conversion: terrain codes will only be
# spotted and converted when preceded by space, comma, or equal sign.

import sys, os, re, getopt

filemoves = {
    # Older includes all previous to 1.3.1.
    "older" : (
    	("creepy.ogg", "underground.ogg"),
        ("eagle.wav", "gryphon-shriek-1.ogg"),
        ("lightning.wav", "lightning.ogg"),	# Bug fix
    ),
    "1.3.1" : (
        # Peasant images moved to a new directory
        ("human-loyalists/peasant.png", "human-peasants/peasant.png"),
        ("human-loyalists/peasant-attack.png", "human-peasants/peasant-attack.png"),
        ("human-loyalists/peasant-attack2.png", "human-peasants/peasant-attack2.png"),
        ("human-loyalists/peasant-ranged.png", "human-peasants/peasant-ranged.png"),
        ("human-loyalists/peasant-idle-1.png", "human-peasants/peasant-idle-1.png"),
        ("human-loyalists/peasant-idle-2.png", "human-peasants/peasant-idle-2.png"),
        ("human-loyalists/peasant-idle-3.png", "human-peasants/peasant-idle-3.png"),
        ("human-loyalists/peasant-idle-4.png", "human-peasants/peasant-idle-4.png"),
        ("human-loyalists/peasant-idle-5.png", "human-peasants/peasant-idle-5.png"),
        ("human-loyalists/peasant-idle-6.png", "human-peasants/peasant-idle-6.png"),
        ("human-loyalists/peasant-idle-7.png", "human-peasants/peasant-idle-7.png"),
        # All Great Mage attacks were renamed
        ("great-mage-attack-magic1.png", "great-mage-attack-magic-1.png"),
        ("great-mage-attack-magic2.png", "great-mage-attack-magic-2.png"),
        ("great-mage+female-attack-magic1.png", "great-mage+female-attack-magic-1.png"),
        ("great-mage+female-attack-magic2.png", "great-mage+female-attack-magic-2.png"),
        ("great-mage-attack-staff1.png", "great-mage-attack-staff-1.png"),
        ("great-mage-attack-staff2.png", "great-mage-attack-staff-2.png"),
        ("great-mage+female-attack-staff1.png", "great-mage+female-attack-staff-1.png"),
        ("great-mage+female-attack-staff2.png", "great-mage+female-attack-staff-2.png"),
        # All Arch Mage attacks were renamed
        ("arch-mage-attack-magic1.png", "arch-mage-attack-magic-1.png"),
        ("arch-mage-attack-magic2.png", "arch-mage-attack-magic-2.png"),
        ("arch-mage+female-attack-magic1.png", "arch-mage+female-attack-magic-1.png"),
        ("arch-mage+female-attack-magic2.png", "arch-mage+female-attack-magic-2.png"),
        ("arch-mage-attack-staff1.png", "arch-mage-attack-staff-1.png"),
        ("arch-mage-attack-staff2.png", "arch-mage-attack-staff-2.png"),
        ("arch-mage+female-attack-staff1.png", "arch-mage+female-attack-staff-1.png"),
        ("arch-mage+female-attack-staff2.png", "arch-mage+female-attack-staff-2.png"),
        # All Red Mage attacks were renamed
        ("red-mage-attack-magic1.png", "red-mage-attack-magic-1.png"),
        ("red-mage-attack-magic2.png", "red-mage-attack-magic-2.png"),
        ("red-mage+female-attack-magic1.png", "red-mage+female-attack-magic-1.png"),
        ("red-mage+female-attack-magic2.png", "red-mage+female-attack-magic-2.png"),
        ("red-mage-attack-staff1.png", "red-mage-attack-staff-1.png"),
        ("red-mage-attack-staff2.png", "red-mage-attack-staff-2.png"),
        ("red-mage+female-attack-staff1.png", "red-mage+female-attack-staff-1.png"),
        ("red-mage+female-attack-staff2.png", "red-mage+female-attack-staff-2.png"),
	# Timothy Pinkham supplied titles for two of his music files.
        # Zhaytee supplied a title for wesnoth-1.ogg
	# gameplay03.ogg, and and wesnoth-[25].ogg already had titles.
	("gameplay01.ogg", "knolls.ogg"),
	("gameplay02.ogg", "wanderer.ogg"),
	("gameplay03.ogg", "battle.ogg"),
        ("wesnoth-1.ogg", "revelation.ogg"),
        ("wesnoth-2.ogg", "loyalists.ogg"),
        ("wesnoth-5.ogg", "northerners.ogg"),
    ),
    # An empty sentinel value at end is required.
    # Always have the current version here.
    "1.3.2" : (),
}

# 1.3.1 -> 1.3.2 terrain conversions
terrain_conversions = {
    re.compile(r"(?<=[ ,=])Bww([|/\\])\b") : "Ww^Bw\\1",
    re.compile(r"(?<=[ ,=])Bwo([|/\\])\b") : "Wo^Bw\\1",
    re.compile(r"(?<=[ ,=])Bss([|/\\])\b") : "Ss^Bw\\1",
    re.compile(r"(?<=[ ,=])Dc\b") : "Dd^Dc",
    re.compile(r"(?<=[ ,=])Dr\b") : "Dd^Dr",
    re.compile(r"(?<=[ ,=])Do\b") : "Dd^Do",
    re.compile(r"(?<=[ ,=])Fa\b") : "Aa^Fpa",
    re.compile(r"(?<=[ ,=])Fet\b") : "Gg^Fet",
    re.compile(r"(?<=[ ,=])Ff\b") : "Gs^Fp",
    re.compile(r"(?<=[ ,=])Ft\b") : "Gs^Ft",
    re.compile(r"(?<=[ ,=])Rfvs\b") : "Re^Gvs",
    re.compile(r"(?<=[ ,=])Uf\b") : "Uu^Uf",
    re.compile(r"(?<=[ ,=])Uui\b") : "Uu^Ii",
    re.compile(r"(?<=[ ,=])Uhi\b") : "Uh^Ii",
    re.compile(r"(?<=[ ,=])Vda\b") : "Dd^Vda",
    re.compile(r"(?<=[ ,=])Vdt\b") : "Dd^Vdt",
    re.compile(r"(?<=[ ,=])Vea\b") : "Aa^Vea",
    re.compile(r"(?<=[ ,=])Veg\b") : "Gg^Ve",
    re.compile(r"(?<=[ ,=])Vha\b") : "Aa^Vha",
    re.compile(r"(?<=[ ,=])Vhg\b") : "Gg^Vh",
    re.compile(r"(?<=[ ,=])Vhh\b") : "Hh^Vhh",
    re.compile(r"(?<=[ ,=])Vhha\b") : "Ha^Vhha",
    re.compile(r"(?<=[ ,=])Vhm\b") : "Mm^Vhh",
    re.compile(r"(?<=[ ,=])Vht\b") : "Gs^Vht",
    re.compile(r"(?<=[ ,=])Vu\b") : "Uu^Vu",
    re.compile(r"(?<=[ ,=])Vud\b") : "Uu^Vud",
    re.compile(r"(?<=[ ,=])Vwm\b") : "Ww^Vm",
    re.compile(r"(?<=[ ,=])Vs\b") : "Ss^Vhs",
    re.compile(r"(?<=[ ,=])Vsm\b") : "Ss^Vm",
    re.compile(r"(?<=[ ,=])Xm\b") : "Mm^Xm"
    }

def allcfgfiles(dir):
    "Get the names of all .cfg files under dir, ignoring .svn directories."
    datafiles = []
    os.path.walk(dir,
                 lambda arg, dir, names: datafiles.extend(map(lambda x: os.path.normpath(os.path.join(dir, x)), names)),
                 None)
    datafiles = filter(lambda x: ".svn" not in x, datafiles)
    datafiles = filter(lambda x: x.endswith(".cfg") or ('maps' in x and os.path.isfile(x)), datafiles)
    return datafiles

    def help():
        sys.stderr.write("""\
Usage: upconvert [options]
    Convert Battle of Wesnoth WML from older versions to newer ones.
    Options may be any of these:
    -h, --help                 Emit this help message and quit
    -d, --dryrun               List changes but don't perform them.
    -o, --oldversion           Specify version to begin with.
    -v, --verbose              List files as they are examined.
""")

def mapconvert2(mapline):
    "Convert a map line from 1.3.1 multiletter format to 1.3.2 format."
    for (old, new) in terrain_conversions.items():
        mapline = old.sub(new, mapline)
    return mapline

if __name__ == '__main__':
    (options, arguments) = getopt.getopt(sys.argv[1:], "dho:v", [
	"help",
        "oldversion=",
	"dryrun",
        "verbose",
        ])
    oldversion = 'older'
    dryrun = False
    verbose = False
    for (switch, val) in options:
        if switch in ('-h', '--help'):
            help()
            sys.exit(0)
        elif switch in ('-o', '--oldversion'):
            oldversion = val
        elif switch in ('-v', '--verbose'):
            verbose = True
        elif switch in ('-d', '--dryrun'):
            dryrun = True

    # Compute the series of version upgrades to perform, and describe it.
    versions = filemoves.keys()
    versions.sort()
    versions = [versions[-1]] + versions[:-1]	# Move 'older' to front
    if oldversion in versions:
        versions = versions[versions.index(oldversion):]
    else:
        print >>sys.stderr, "upconvert: unrecognized version."
        sys.exit(1)
    explain = "Performing upgrades for:"
    for i in range(len(versions)-1):
        explain += " %s -> %s," % (versions[i],  versions[i+1])
    sys.stdout.write(explain[:-1] + ".\n")
    fileconversions = map(lambda x: filemoves[x], versions[:-1])

    # Perform resource file substitutions
    ofp = None
    for fn in allcfgfiles("."):
        if verbose:
            print fn
        if dryrun:
            ifp = open(fn)
        else:
            os.rename(fn, fn + "-bak")
            ifp = open(fn + "-bak")
            ofp = open(fn, "w")
        modified = False
        for (i, line) in enumerate(ifp):
            transformed = line
            # Filename conversions
            if ".cfg" in fn:
                for step in fileconversions:
                    for (old, new) in step:
                        transformed = transformed.replace(old, new)
            # Map-format conversions
            if "1.3.1" in versions and 'message' not in transformed:
                transformed = mapconvert2(transformed)
            if ofp:
                ofp.write(transformed)
            if transformed != line:
                if not 'maps' in fn:
                    print "%s, line %d: %s -> %s" % \
                          (fn, i+1, line.strip(), transformed.strip())
                modified = True
        if ofp:
            ofp.close()
            if not modified:
                # Nothing changed, move the backup file back into place.
                os.rename(fn + "-bak", fn)
        if modified and 'maps' in fn:
            print "%s modified." % fn

# upconvert ends here
