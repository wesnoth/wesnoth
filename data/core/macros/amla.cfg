#textdomain wesnoth-help
#this file contains macros for After Max Level Advancement (AMLA)

#define AMLA_EFFECTS_HEAL_AND_RAISE_XP
    [effect]
        apply_to=max_experience
        increase=20%
    [/effect]
    [effect]
        apply_to=hitpoints
        heal_full=yes
    [/effect]
    [effect]
        apply_to=status
        remove=poisoned
    [/effect]
    [effect]
        apply_to=status
        remove=slowed
    [/effect]
#enddef

#define AMLA_DEFAULT
    # Canned definition of the default AMLA.
    [advancement]
        strict_amla=yes
        max_times=100
        id=amla_default
        description= _ "Max HP bonus +3, Max XP +20%"
        image="icons/amla-default.png"
        [effect]
            apply_to=hitpoints
            increase_total=3
        [/effect]
        {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
    [/advancement]
#enddef

# Include this resource in your [campaign] tag to replace the default +3hp AMLA with more powerful AMLA choices.
# All max-level units gain a +8hp AMLA option, and units with melee/ranged attacks gain options for increased melee/ranged damage.
# Units whose melee attacks all have 1 strike gain a +4 melee dmg option. Units whose melee attacks all have <=2 strikes gain a +2 melee dmg option. Otherwise, units gain a +1 melee dmg option.
# The same pattern follows for ranged attacks.
#
# The optional `use_stronger_amlas_filter` variable can be used to modify which units this macro affects. `use_stronger_amlas_filter` defaults to `side=1`
[resource]
    id=use_stronger_amlas

    #############################
    # INITIALIZE AMLA FILTER
    #############################
    [event]
        name=prestart
        [filter_condition]
            [variable]
                name=use_stronger_amlas_filter
                equals=$null
            [/variable]
        [/filter_condition]
        [set_variable]
            name=use_stronger_amlas_filter.side
            value=1
        [/set_variable]
    [/event]

    #############################
    # IMPLEMENT AMLAS
    #############################
    [event]
        name=pre advance
        first_time_only=no
        [insert_tag]
            name=filter
            variable=use_stronger_amlas_filter
        [/insert_tag]
        [filter]
            [not]
                id=$amla_currently_advancing_id
            [/not]
        [/filter]

        #--------------------
        # SKIP IF NOT MAX-LEVEL
        #--------------------
        [if]
            [variable]
                name=unit.advances_to
                equals=""
            [/variable]
            [then]
                #--------------------
                # AVOID RECURSION
                #--------------------
                # modifying a unit re-triggers "pre advance", so avoid infinite recursion
                [set_variable]
                    name=amla_currently_advancing_id
                    value=$unit.id
                [/set_variable]

                #--------------------
                # RESET AMLAS
                #--------------------
                [remove_object]
                    object_id=universal_amlas_object
                    id=$unit.id
                [/remove_object]

                #--------------------
                # ADD AMLAS
                #--------------------
                [modify_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    [object]
                        id=universal_amlas_object
                        [effect]
                            apply_to=remove_advancement
                            amlas=amla_default
                        [/effect]
                        [effect]
                            apply_to=new_advancement

                            #--------------------
                            # HITPOINTS
                            #--------------------
                            # +8 hitpoints
                            [advancement]
                                id=hitpoints_increase
                                description= _ "Gain +8 hitpoints."
                                strict_amla=yes
                                major_amla=yes # so that the XP bar is blue, so that the player can differentiate between campaigns with custom AMLAs (blue) and campaigns without (purple)
                                max_times=-1
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=8
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]

                            #--------------------
                            # MELEE DAMAGE
                            #--------------------
                            # +4 melee damage
                            [advancement]
                                id=melee_increase1
                                description= _ "Gain +4 melee damage."
                                strict_amla=yes
                                max_times=-1
                                [filter]
                                    [has_attack]
                                        range=melee
                                        number=1
                                    [/has_attack]
                                    [not]
                                        [has_attack]
                                            range=melee
                                            number=2-99
                                        [/has_attack]
                                    [/not]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=4
                                    range=melee
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]

                            # +2 melee damage
                            [advancement]
                                id=melee_increase2
                                description= _ "Gain +2 melee damage."
                                strict_amla=yes
                                max_times=-1
                                [filter]
                                    [has_attack]
                                        range=melee
                                        number=2
                                    [/has_attack]
                                    [not]
                                        [has_attack]
                                            range=melee
                                            number=3-99
                                        [/has_attack]
                                    [/not]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=2
                                    range=melee
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]

                            # +1 melee damage
                            [advancement]
                                id=melee_increase3
                                description= _ "Gain +1 melee damage."
                                strict_amla=yes
                                max_times=-1
                                [filter]
                                    [has_attack]
                                        range=melee
                                        number=3-99
                                    [/has_attack]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=1
                                    range=melee
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]

                            #--------------------
                            # RANGED DAMAGE
                            #--------------------
                            # +4 ranged damage
                            [advancement]
                                id=ranged_increase1
                                description= _ "Gain +4 ranged damage."
                                strict_amla=yes
                                max_times=-1
                                [filter]
                                    [has_attack]
                                        range=ranged
                                        number=1
                                    [/has_attack]
                                    [not]
                                        [has_attack]
                                            range=ranged
                                            number=2-99
                                        [/has_attack]
                                    [/not]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=4
                                    range=ranged
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]

                            # +2 ranged damage
                            [advancement]
                                id=ranged_increase2
                                description= _ "Gain +2 ranged damage."
                                strict_amla=yes
                                max_times=-1
                                [filter]
                                    [has_attack]
                                        range=ranged
                                        number=2
                                    [/has_attack]
                                    [not]
                                        [has_attack]
                                            range=ranged
                                            number=3-99
                                        [/has_attack]
                                    [/not]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=2
                                    range=ranged
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]

                            # +1 ranged damage
                            [advancement]
                                id=ranged_increase3
                                description= _ "Gain +1 ranged damage."
                                strict_amla=yes
                                max_times=-1
                                [filter]
                                    [has_attack]
                                        range=ranged
                                        number=3-99
                                    [/has_attack]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=1
                                    range=ranged
                                [/effect]
                                {AMLA_EFFECTS_HEAL_AND_RAISE_XP}
                            [/advancement]
                        [/effect]
                    [/object]
                [/modify_unit]

                #--------------------
                # RESET AMLAS
                #--------------------
                [event]
                    name=post advance
                    [clear_variable]
                        name=amla_currently_advancing_id
                    [/clear_variable]
                    [remove_object]
                        object_id=universal_amlas_object
                        id=$unit.id
                    [/remove_object]
                [/event]
            [/then]
        [/if]
    [/event]
[/resource]
