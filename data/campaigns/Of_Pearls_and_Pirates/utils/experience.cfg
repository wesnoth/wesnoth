#textdomain wesnoth-pap

#
# the 'experience_modifier' attribute doesn't adjust existing units' XP when difficulty is changed. Fix that here by forcing a unit rebuild
#
#define EXPERIENCE_MODIFIER_GLOBAL
    # difficulty can only be changed at the beginning of a scenario
    # so, modify any units whose initial XP modifier doesn't match the current difficulty
    [event]
        name=prestart,refresh_experience
        first_time_only=no
        [store_unit]
            {FILTER()}
            variable=preload_modify_xp_units
        [/store_unit]
        [foreach]
            array=preload_modify_xp_units
            [do]
                {STORE_UNIT_VAR id=$this_item.id id premodified_unit_id}
                {STORE_UNIT_VAR id=$this_item.id     experience     premodified_experience}
                {STORE_UNIT_VAR id=$this_item.id max_experience premodified_max_experience}
                # modify XP to force a unit rebuild
                # if we modify something other than XP this doesn't work
                # [remove_object] doesn't work on units with x,y=recall,recall so use lua instead
                {GIVE_OBJECT_TO id=$this_item.id (id=xp_modifier_object {EFFECT max_experience increase=1})}
                [lua]
                    code = << local units = wesnoth.units.find{ id=wml.variables['premodified_unit_id'] }
                            if (units and units[1]) then units[1]:remove_modifications{ id='xp_modifier_object' } end >>
                [/lua]
                {CLEAR_VARIABLE premodified_unit_id}
                # adjust current XP
                [modify_unit]
                    {FILTER id=$this_item.id}
                    experience="$( floor($this_unit.max_experience * $premodified_experience / $premodified_max_experience) )"
                [/modify_unit]

                # sometimes, for some inexplicable reason, $premodified_max_experience is already multiplied by the new experience_modifier.
                # in these cases, we might accidentally end up with units at more than 100% XP. Prevent this from happening here.
                {STORE_UNIT_VAR id=$this_item.id     experience     postmodified_experience}
                {STORE_UNIT_VAR id=$this_item.id max_experience postmodified_max_experience}
                [if] {VARIABLE_CONDITIONAL postmodified_experience greater_than_equal_to $postmodified_max_experience}
                    [then]
                        [modify_unit]
                            {FILTER id=$this_item.id}
                            experience="$( $postmodified_max_experience - 7 )"
                        [/modify_unit]
                    [/then]
                [/if]

                # clean up after ourselves
                {CLEAR_VARIABLE premodified_unit_id,premodified_experience,premodified_max_experience}
                {CLEAR_VARIABLE postmodified_experience,postmodified_max_experience}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE preload_modify_xp_units}
    [/event]
#enddef

#define EXPERIENCE_MODIFIER_SCENARIO
    experience_modifier={ON_DIFFICULTY4 70 90 100 100}
#enddef
