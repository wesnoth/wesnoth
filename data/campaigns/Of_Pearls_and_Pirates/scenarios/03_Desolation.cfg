#textdomain wesnoth-pap

#define SCENARIO_TURN_LIMIT
12#enddef

[scenario]
    id=03_Desolation
    map_file=03_Desolation.map
    name= _ "Desolation"
    next_scenario=04_Lee_Shore
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    {DEFAULT_SCHEDULE_DUSK}
    {ADD_WEATHER_RAIN}
    turns={SCENARIO_TURN_LIMIT}

    {INTRO_AND_SCENARIO_MUSIC silence.ogg into_the_shadows.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}

    [story]
        [part]
            {PAP_BIGMAP}
            story= _ "Under Thea’s command, the villagers appointed a handful of guards with instructions to keep a watchful eye on the horizon. Should trouble return — or Constable Elyn — they were to send a messenger immediately."
        [/part]
        [part]
            {PAP_BIGMAP}
            story= _ "The rest of the militia provisioned themselves and set off on foot. Guided by the merfolk, they followed the coast, tracking the fleeing naga clockwise around the peninsula."
        [/part]
    [/story]
    {PAP_TRACK {JOURNEY_STAGE3}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {PLAYER_SIDE "Expensive Peasant,Expensive Woodsman,Merman Fighter,Merman Hunter" SHROUD=yes}
    {STARTING_VILLAGES 1 4}
    
    #############################
    # WOLVES
    #############################
    [side]
        side=2
        color=blue
        controller=ai
        id=leader2
        type={ON_DIFFICULTY4 "Great Wolf" Direwolf Direwolf Direwolf}
        {ADD_MODIFICATION({TRAIT_STRONG}{TRAIT_RESILIENT})}
        facing=sw
        recruit=Wolf
        gold={ON_DIFFICULTY4 15 30 45 60}
        income={ON_DIFFICULTY4 4 10 16 22} # few villages, no upkeep
        team_name=wolves
        user_team_name= _ "Wild Wolves"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 6} # just far enough to attack the nearby swamp hexes
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Great Wolf" {ON_DIFFICULTY4 0 1 1 2}}

    # dummy fishing boat side
    [side]
        side=3
        color=white
        controller=null # this prevents the boats from rest-healing
        team_name=good,wolves
        hidden=yes
    [/side]
    [side]
        side=4
        color=red
        controller=null # this prevents the boats from rest-healing
        team_name=good,wolves
        hidden=yes
    [/side]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {SET_LABEL 30 12 _"Stuxton"}
        
        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE scenery/blood-trail-1.png  34 12}
        {PLACE_IMAGE scenery/gore-3.png         29 12}
        {PLACE_IMAGE scenery/blood-1.png        28 11}
        {PLACE_IMAGE scenery/gore-1.png         32  8}
        {PLACE_IMAGE scenery/blood-2.png        24 12}
        {PLACE_IMAGE scenery/blood-trail-2.png   7  9}
        
        {PLACE_IMAGE scenery/wreck-2.png        36 13}
        {PLACE_IMAGE "scenery/wreck-2.png~FL()" 26 15}
        {PLACE_IMAGE scenery/wreck.png          23 14}
        
        {PLACE_IMAGE scenery/village-human-burned1.png 10 11}
        {PLACE_IMAGE scenery/village-human-burned2.png 24 10}
        {PLACE_IMAGE scenery/village-human-burned3.png 29 11}
        {PLACE_IMAGE scenery/village-human-burned4.png 34 10}
        {PLACE_IMAGE scenery/village-human-burned1.png 32 14}
        {PLACE_IMAGE scenery/trash.png 31 13}
        
        #############################
        # WOLF'S "KEEP"
        #############################
        {PLACE_IMAGE scenery/keep-overlay-high.png 22 1}
        {PLACE_IMAGE scenery/keep-overlay-low.png  21 1}
        {PLACE_IMAGE scenery/keep-overlay-low.png  23 1}
        
        #############################
        # INITIAL WOLVES
        #############################
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "none" "Wolf" "Wolf"       "Great Wolf"})  4  3 {GUARDIAN}}
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "Wolf" "Wolf" "Great Wolf" "Great Wolf"}) 13  6 {GUARDIAN}}
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "Wolf" "Wolf" "Great Wolf" "Great Wolf"})  7  9 {GUARDIAN}}
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "none" "Wolf" "Wolf"       "Great Wolf"})  3 17 {GUARDIAN}}
        
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "none" "Wolf" "Wolf"       "Great Wolf"}) 43  1 {GUARDIAN}}
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "Wolf" "Wolf" "Great Wolf" "Great Wolf"}) 39  4 {GUARDIAN}}
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "Wolf" "Wolf" "Great Wolf" "Great Wolf"}) 37  2 {GUARDIAN}}
        {LOYAL_UNITC 2 ({ON_DIFFICULTY4 "none" "Wolf" "Wolf"       "Great Wolf"}) 32  2 {GUARDIAN}}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Wolf" "Wolf" "Great Wolf" "Great Wolf"}) 26 9 facing=se}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "Wolf" "Wolf"       "Great Wolf"}) 27 8 facing=se}
        
        #############################
        # FISHING BOATS
        #############################
        {NAMED_UNIT 3 "Fishing Boat" 40 3 skiff1 _"Great White" facing=sw} {HITPOINTS 61}
        {NAMED_UNIT 3 "Fishing Boat"  6 7 skiff2 _"The Garard"  facing=se} {HITPOINTS 37}
        {GIVE_OBJECT_TO id=skiff1 ({EFFECT movement set=0})}
        {GIVE_OBJECT_TO id=skiff2 ({EFFECT movement set=0})}
        
        #############################
        # THEA
        #############################
        {RECALL_XY Diondra 43 12}
        {MODIFY_UNIT side=1 facing sw}
        {REDRAW}
        {SCROLL_TO 43 11}
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        {DELAY 500}
        
        #############################
        # APPROACHING STUXTON
        #############################
        [message]
            speaker=Diondra
            message= _ "Your feet are lead, woman of Rochem. How can we pursue creatures of the water when you are bound to land? Have you no swift gryphons or sleek boats to carry you hence?"
        [/message]
        [message]
            speaker=Thea
            message= _ "Good mermaid, most of us are farmers, not fishers. Elyn took our best seaworthy boat, and— well, you know that story..."
        [/message]
        [message]
            speaker=Thea
            message= _ "But we’re almost upon the fishing village of Stuxton. Mayhaps they’ve had trouble with pirates too. Even if they aren’t willing to join us, I’m sure they’ll let us borrow of their fishing fleet."
        [/message]
        {MOVE_UNIT id=Thea 42 10} {REDRAW}
        {MOVE_UNIT id=Thea 41 10} {REDRAW}
        {MOVE_UNIT id=Thea 40 10} {REDRAW}
        {MOVE_UNIT id=Thea 39 10} {REDRAW}
        {MOVE_UNIT id=Thea 38  9} {REDRAW}
        {MOVE_UNIT id=Thea 37 10} {REDRAW}
        {MOVE_UNIT id=Thea 36 10} {REDRAW}
        {MOVE_UNIT id=Thea 35 11} {REDRAW}
        {MOVE_UNIT id=Thea 34 11} {REDRAW}
        {MOVE_UNIT id=Thea 33 12} {REDRAW}
        {MOVE_UNIT id=Thea 32 11} {REDRAW}
        {MOVE_UNIT id=Diondra 34 13} {REDRAW}
        
        #############################
        # HIGHLIGHT THE BOATS
        #############################
        [modify_side]
            side=1
            shroud=no
        [/modify_side]
        [message]
            speaker=Thea
            message= _ "What?! Stuxton lies in ruins! Wolves feast on corpses in the streets!"
        [/message]
        [message]
            speaker=Diondra
            message= _ "There was clearly a battle here, one which has left several bodies. But only several. Most of the village humans are unaccounted for — they are certainly not still living here."
        [/message]
        [message]
            speaker=Diondra
            message= _ "Still here, however, are their boats. Get them, Thea."
        [/message]
#define TOGGLE_GOHERE X Y
        {DELAY 250}
        [hide_unit]
            x,y={X},{Y}
        [/hide_unit]
        {PLACE_IMAGE items/gohere.png {X} {Y}}
        {DELAY 250}
        {REMOVE_IMAGE {X} {Y}}
        [unhide_unit]
            x,y={X},{Y}
        [/unhide_unit]
#enddef
        {REVEAL x,y,radius=40,3,1}
        {SCROLL_TO 40 3}
        {TOGGLE_GOHERE 40 3}
        {TOGGLE_GOHERE 40 3}
        {TOGGLE_GOHERE 40 3}
        {TOGGLE_GOHERE 40 3}
        
        {REVEAL x,y,radius=6,7,1}
        {SCROLL_TO 6 7}
        {TOGGLE_GOHERE 6 7}
        {TOGGLE_GOHERE 6 7}
        {TOGGLE_GOHERE 6 7}
        {TOGGLE_GOHERE 6 7}
        
        #############################
        # SPLIT YOUR FORCES
        #############################
        [message]
            speaker=Thea
            message= _ "I can do that. The two boats still afloat are damaged and taking on water. We may have to split our forces if we want to claim both before they sink."
        [/message]
        [message]
            speaker=Thea
            message= _ "This will be a quick expedition, but that doesn’t mean we should let down our guard. The forest echoes with the howls of wolves..."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Move any unit adjacent to both fishing skiffs"
                show_turn_counter=yes
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Thea or Diondra"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # WOLF LEADER DIE
    #############################
    [event]
        name=die
        {FILTER id=leader2}
        {ACHIEVE s03}
        [message]
            speaker=Thea
            message= _ "The worst of the wolves are dealt with, but we must still reach the last boats before they sink."
        [/message]
    [/event]
    
    #############################
    # SKIFFS CAPTURED
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_ADJACENT id=skiff1,skiff2} )}
        [message]
            speaker=$unit.id
            message= _ "I’ve reached the first skiff! The damage doesn’t look bad. I think I can get it seaworthy again."
        [/message]
        {MODIFY_UNIT (id=skiff1,skiff2 {FILTER_ADJACENT id=$unit.id}) side 4}
        {FULL_HEAL (id=skiff1,skiff2 {FILTER_ADJACENT id=$unit.id})}
        {MOVE_UNIT (id=skiff1,skiff2 {FILTER_ADJACENT id=$unit.id}) 31 15}
        [message]
            speaker=Thea
            message= _ "Halfway done, everyone. We’ll need both skiffs to carry us all."
        [/message]
        [event]
            name=moveto
            {FILTER( side=1 {FILTER_ADJACENT id=skiff1,skiff2} )}
            [message]
                speaker=$unit.id
                message= _ "I’m repairing the second skiff! There’s more bodies inside. It looks like a family tried to hide here."
            [/message]
            {MODIFY_UNIT (id=skiff1,skiff2 {FILTER_ADJACENT id=$unit.id}) side 4}
            {FULL_HEAL (id=skiff1,skiff2 {FILTER_ADJACENT id=$unit.id})}
            {MOVE_UNIT (id=skiff1,skiff2 {FILTER_ADJACENT id=$unit.id}) 28 15}
            [message]
                speaker=Thea
                message= _ "Pa used to take me here for festivals, back when. I knew some of these dead... Was there anything we could have done?"
            [/message]
            {DELAY 500}
            [message]
                speaker=Thea
                message= _ "Forget it. Come on, everyone. Let’s get away from this dead place."
            [/message]
            [endlevel]
                result=victory
                bonus=yes
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
    [/event]
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=turn $({SCENARIO_TURN_LIMIT}-3)
        [if] {HAVE_UNIT side,count=3,2-99} {THEN(
            [message]
                speaker=Thea
                message=_"The boats are taking on too much water. We have to hurry and reach them before they sink!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Thea
                message=_"The last boat is taking on too much water. We have to hurry and reach it before it sinks!"
            [/message]
        )} [/if]
    [/event]
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        {KILL side=3 ANIMATE=yes}
        [if] {HAVE_UNIT side,count=3,2-99} {THEN(
            [message]
                speaker=Thea
                message=_"The last boats have sunk! Without boats we can’t keep up with the merfolk. You’ll have to go ahead without us, Diondra..."
            [/message]
        )} {ELSE(
            [message]
                speaker=Thea
                message=_"The last boat has sunk! Without both boats we can’t keep up with the merfolk. You’ll have to go ahead without us, Diondra..."
            [/message]
        )} [/if]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
