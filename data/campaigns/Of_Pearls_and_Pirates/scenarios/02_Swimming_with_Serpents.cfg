#textdomain wesnoth-pap

#define SCENARIO_TURN_LIMIT
{ON_DIFFICULTY4 25 30 30 30}#enddef

[scenario]
    id=02_Swimming_with_Serpents
    map_file=02_Swimming_with_Serpents.map
    name= _ "Swimming with Serpents"
    next_scenario=03_Desolation
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    {DEFAULT_SCHEDULE}
    turns={SCENARIO_TURN_LIMIT}

    {INTRO_AND_SCENARIO_MUSIC silence.ogg siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC the_dangerous_symphony.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}

    [story]
        [part]
            {PAP_BIGMAP}
            #po: S02 intro. Alderman Rael left the village months ago, and has not returned.
            story= _ "But Rael did not return. Autumn turned to winter, winter to spring, and trouble once again returned to the Peninsula of Pearls."
        [/part]
    [/story]
    {PAP_TRACK {JOURNEY_STAGE2}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {PLAYER_SIDE "Peasant,Woodsman"}
    {STARTING_VILLAGES 1 8}
    [modify_unit_type]
        type=Peasant
        set_cost=16
    [/modify_unit_type]
    [modify_unit_type]
        type=Woodsman
        set_cost=20
    [/modify_unit_type]

    #############################
    # PIRATES
    #############################
    [side]
        side=2
        color=green
        controller=ai
        recruit=Naga Fighter
        # high gold, but low income. Most of their forces should be depleted by the time the merfolk arrive
        # on Easy, make sure we still have enough to recruit at least 2 units, or else things look silly
        gold={ON_DIFFICULTY4 30 60 90 120}
        income={ON_DIFFICULTY4 -2 0 2 4}
        team_name=pirates
        user_team_name= _ "Naga"
        {FLAG_VARIANT6 ragged}
        no_leader=yes
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 0} # make him stay in his (land) encampment so he's easier to kill. Don't let him move onto the nearby 70% coastal reef
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Naga Warrior" {ON_DIFFICULTY4 0 1 1 2}}

    [side]
        side=3
        color=blue
        controller=ai
        recruit=Naga Dirkfang
        gold={ON_DIFFICULTY4 30 60 90 120}
        income={ON_DIFFICULTY4 -2 0 2 4}
        team_name=pirates
        user_team_name= _ "Naga"
        {FLAG_VARIANT6 ragged}
        no_leader=yes
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 5}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Naga Ophidian" {ON_DIFFICULTY4 0 1 2 2}}

    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3 offensive 0.6 0.2}
        {AUTOENRAGE 2 0}
        {AUTOENRAGE 3 0}
        {RETREAT_WHEN_WEAK 2 {ON_DIFFICULTY4 0-0 0-1 0-2 0-2} (
            {GOAL_LOCATION 3 x,y=25,23}
            {GOAL_LOCATION 3 x,y=24,23}
            {GOAL_LOCATION 2 x,y=22,24}
        )}
        {RETREAT_WHEN_WEAK 3 {ON_DIFFICULTY4 0-0 0-1 0-2 0-2} (
            {GOAL_LOCATION 3 x,y=40,11}
            {GOAL_LOCATION 3 x,y=40,12}
            {GOAL_LOCATION 2 x,y=41,11}
        )}
    [/event]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {SET_LABEL 18 9 _"Rochelm"}
        {NAMED_UNIT 1 "Fishing Boat" 22 10 skiff "" facing=sw}
        {RECALL_XY Elyn 15 10}
        {NAMED_UNIT 1 Woodsman 24 24 Lookout _"Lookout" facing=se}
        {SCROLL_TO 13 23}
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        {DELAY 500}

        #############################
        # EXPLAINING THE CROWN
        #############################
        [message]
            speaker=Lookout
            message= _ "Constable Elyn, sir! Ship on the horizon! I don’t recognize the trim... and it has black sails!"
        [/message]
        [message]
            speaker=Thea
            message= _ "Pirates again? Why has the Crown not dealt with this!"
        [/message]
        [message]
            speaker=Elyn
            message= _ "I’m sure Pa would’ve told the army about the thieves who attacked us. The lords must be too busy to pay any mind to free-holds like us. But maybe the merfolk—"
        [/message]

        #############################
        # LADY MAUDIE ARRIVES
        #############################
        [unit]
            {SINGLEUNITWML_MAUDIE}
            x,y=34,26 # 1 hex above the bottom, so the ship is still visible despite the message
            side=2
            facing=nw
            animate=yes
        [/unit]
        [message]
            speaker=Maudie
            #po: Maudie is speaking to adults, not children. "Children" is used in a demeaning way here.
            message= _ "Hello, children. This is a shakedown. Empty your treasury or we’ll come and take the pearls ourselves."
        [/message]
        [message]
            speaker=Elyn
            message= _ "Pirate filth. Like hell you will. What do you say, lads?"
        [/message]
        [message]
            speaker=Lookout
            #po: The speaker is shouting a cheer and preparing to attack his enemy. Can be translated into any kind of cheer, but please stay consistent with the other instances of "Rah!"
            message= _ "Rah!"
        [/message]
        [message]
            speaker=Maudie
            message= _ "Charming. My new allies will make short work of you."
        [/message]

        #############################
        # CREATE NAGA
        #############################
        {MOVE_UNIT id=Maudie 29 25}
        {NAMED_UNIT 2 "Naga Warrior" 28 24 leader2 _"Pseail" canrecruit=yes} {FACING nw} {ANIMATE}
        {ADD_MODIFICATION({TRAIT_STRONG}{TRAIT_RESILIENT})}
        {MOVE_UNIT id=leader2 25 24}
        {ANIMATE_HARM id=leader2 999 range=melee id=Lookout}
        # use land encampments instead of water ones so that the naga's defense is lower. Too-high defense can be frustrating for new players
        {MODIFY_TERRAIN Ker 25 24} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Cer 26 24} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Cer 25 23} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Cer 24 23} {REDRAW} {DELAY 150}

        {MOVE_UNIT id=Maudie 37 17}
        {NAMED_UNIT 3 "Naga Ringcaster" 38 16 leader3 _"Briloss" canrecruit=yes} {FACING ne} {ANIMATE}
        {ADD_MODIFICATION({TRAIT_QUICK}{TRAIT_RESILIENT})}
        {MOVE_UNIT id=leader3 41 12}
        {MODIFY_UNIT id=leader3 facing sw}
        [message]
            speaker=leader3
            message= _ "Hisss... We are ready, Missstresss."
        [/message]
        [message]
            speaker=Maudie
            message= _ "Kill their warriors, then shackle the others and march them north. I’ve more important places to be. Ta ta!"
        [/message]
        {MOVE_UNIT id=Maudie 34 24}
        {KILL id=Maudie}

        #############################
        # RAEL GOES FOR HELP
        #############################
        [message]
            speaker=Thea
            message= _ "Snake monsters! The pirates have brought naga!"
        [/message]
        [message]
            speaker=Elyn
            message= _ "Curse it all! Thea, rally the farmers and keep yourself safe. I’ve got to take the old skiff and warn the merfolk that naga are here."
        [/message]
        [message]
            speaker=Thea
            message= _ "Rally the farmers? What farmers? Most of our fighting-age men are away with Dad."
        [/message]
        [object]
            {FILTER id=Thea}
            duration=turn
            image=attacks/fist-human.png
            name=_"Manpower Shortage"
            description=_"Peasants and Woodsmen cost twice as much to recruit (but not to recall)."
        [/object]
        [message]
            speaker=Thea
            message= _ "Besides, the army hasn’t helped us. What makes you think the merfolk will?"
        [/message]
        [message]
            speaker=Elyn
            message= _ "Merfolk are ancient enemies of the naga, and are part of the kingdom just the same as us. They’ll help us, but I have to get the word out!"
        [/message]
        {KILL id=Elyn}
        {FAKE_UNIT_MOVE 18 22 9 10  1 "Javelineer" ()}
        {MOVE_UNIT id=skiff 42 17}
        {KILL id=skiff}
        {DELAY 250}
        [message]
            speaker=Thea
            message= _ "First Dad leaves, then my brother... It was nice while it lasted. I guess it’s up to me now."
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Survive until reinforcements arrive on turn 13, then defeat the enemy leaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Thea"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #############################
    # HINT: TERRAIN AND VILLAGES
    #############################
    [event]
        name=turn 2
        {FILTER_CONDITION({VARIABLE_CONDITIONAL enable_tutorial_elements equals yes})}
        [message]
            speaker=Thea
            message= _ "Careful, everyone. Naga are powerful in water, but clumsier than we are on land. Don’t fight on the coast. Flee inland if we need to, and then cut them to pieces!"
        [/message]
        [display_tip]
            title=_"Mixed Terrain"
            message=_"Some hexes are <i><b>mixtures of multiple terrain types.</b></i> Bridges, for example,
count as both shallow water and flat land — whichever is better for the 
unit passing through.

If you’re confused about a unit’s defense (chance to evade) or movement 
on a particular hex and want to see exactly what terrains are included,
right-click the hex and select <i>Terrain Description</i>."
        [/display_tip]
        [message]
            speaker=Thea
            message= _ "But we can’t afford to give up too many villages either. We’ll have a hard time recovering if our enemies’ gold reserves get out of hand."
        [/message]
        [display_tip]
            title=_"Village Control"
            message=_"Remember that each village you own generates 1 gold per turn,
and supports 1 unit’s worth of upkeep. Level 2 units cost 2
upkeep, level 3 units cost 3 upkeep, etc. But level 0 units,
like Peasants and Woodsmen, cost no upkeep at all.

<i><b>Enemies collect income and pay upkeep just like you do</b></i>,
so capturing just a small handful of villages from your
opponents can make a big difference."
        [/display_tip]
    [/event]

    #############################
    # MERFOLK REINFORCEMENTS ARRIVE
    #############################
    [event]
        name=turn 12
        [message]
            speaker=Thea
            #po: Thea is waiting for her brother Elyn to return, bringing merfolk soldiers to help fight
            message= _ "I see movement on the horizon! Something is coming closer... it’ll reach us in barely an hour. Is Elyn finally back?"
        [/message]
    [/event]
    [event]
        name=turn 13
        # at dawn, so they'll fight at their strongest
        [unit]
            {SINGLEUNITWML_AISIUA}
            x,y=41,20
            side=1
            facing=nw
            animate=yes
        [/unit]
        {GENERIC_UNIT 1 "Merman Fighter" 42 18} {FACING sw} {ANIMATE}
        {GENERIC_UNIT 1 "Merman Fighter" 42 19} {FACING sw} {ANIMATE}
        {GENERIC_UNIT 1 "Merman Fighter" 42 21} {FACING sw} {ANIMATE}
        {GENERIC_UNIT 1 "Merman Fighter" 41 22} {FACING sw} {ANIMATE}
        {GENERIC_UNIT 1 "Merman Hunter"  42 22} {FACING sw} {ANIMATE}
        {GENERIC_UNIT 1 "Merman Hunter"  42 23} {FACING sw} {ANIMATE}
        [message]
            speaker=Diondra
            #po: "two-legs" is meant to be a neutral (not insulting) term for humans
            message= _ "Hail, two-legs! I see you are imperiled! I knew I smelled the stench of naga."
        [/message]
        [message]
            side=1
            race=human
            {NOT id=Thea}
            message= _ "Hooray! The merfolk have come! Constable Elyn has brought the merfolk!"
        [/message]
        [message]
            speaker=Diondra
            message= _ "Elyn? I know no such man. We come hunting a ship with black sails. It has been the cause of much mischief in our waters."
        [/message]
        [message]
            speaker=Thea
            message= _ "That’s the same ship that launched this attack on our village. But you say my brother isn’t with you? What can have happened to him?"
        [/message]
        [message]
            speaker=Diondra
            message= _ "This is a matter for after the battle. First, we must aid you against these vermin!"
        [/message]
        [object]
            {FILTER id=Thea} duration=turn
            image="misc/blank-hex.png~SCALE(72,144)~BLIT(units/merfolk/fighter.png~RC(magenta>  red),0,0)~BLIT(units/merfolk/hunter.png~RC(magenta>red),0,72)"
            name=_"New Recruits"
            description=_"Merman Fighters and Hunters are level 1 units: proper fighters, unlike your untrained Peasants and Woodsmen." + "

" + _"Compared with level 1 Spearmen and Bowmen, Merman Fighters and Hunters have improved defense (chance to evade) and speed, but lower damage."
        [/object]
        [allow_recruit]
            side=1
            type=Merman Fighter,Merman Hunter
        [/allow_recruit]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat the enemy leaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Thea or Diondra"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=last breath
        {FILTER id=leader2,leader3}
        {FILTER_CONDITION({NOT({HAVE_UNIT id=Diondra})})}
        {ACHIEVE s02}
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # NAGA LEADERS DIE
    #############################
    # it's not possbible to defeat both the naga before merfolk arrive, because one of their leaders is blocked off by deep water
    # thus, we don't need to handle that case
    [event]
        name=last breath
        {FILTER id=leader2,leader3}
        {FILTER_CONDITION({NOT({HAVE_UNIT id=leader2,leader3})})}

        #------------------------
        # NAGA FLEES
        #------------------------
        [message]
            speaker=unit
            message= _ "Accursssed mermaid! We are lossst... I mussst essscape..."
        [/message]
        {MOVE_UNIT id=$unit.id 28 27}
        [store_unit]
            {FILTER id=$unit.id}
            variable=stored_naga
            kill=yes
        [/store_unit]
        {CUTSCENE_ENEMIES_RETREAT 2,3  "$($this_item.x)" 27}

        #------------------------
        # ALDERMAN THEA
        #------------------------
        [message]
            speaker=Diondra
            message= _ "Begone! Flee and cower in your dark caves and silent grottos!"
        [/message]
        [message]
            side=1
            race=human
            {NOT id=Thea}
            message= _ "Thank you for helping us, mermaid of the bay! But what do we do now? Many of us are hurt. Our leader is away at war, and our constable is missing — or dead."
        [/message]
        [message]
            speaker=Thea
            message= _ "No, my brother couldn’t be... not like that. It’d take more than a few snakes to kill Constable Elyn Nicolin. I know we’ll see him again."
        [/message]
        [message]
            side=1
            race=human
            {NOT id=Thea}
            message= _ "But he’s not here now. What happens the next time the pirates come, Constable Thea?"
        [/message]
        [message]
            speaker=Thea
            message= _ "Constable Thea? I’m not— err..."
        [/message]
        {MODIFY_UNIT id=Thea name _"Constable Thea"}
        [message]
            speaker=Thea
            message= _ "Alright. Mermaid, are you willing to take the fight to these pirates?"
        [/message]
        [message]
            speaker=Diondra
            message= _ "Of course. The fleeing naga follow the coast south and west. I must go in pursuit!"
        [/message]
        [message]
            speaker=Thea
            #po: "What do you say, lads?" echoes Rael's and Elyn's words earlier
            message= _ "Then that is where we’ll go too. We won’t cower in fear until the next attack, or wait for outside aid that may never come. We’re going to get out there, hunt down that pirate lady and put an end to this! What do you say, lads?"
        [/message]
        [message]
            side=1
            race=human
            {NOT id=Thea}
            #po: The speaker is shouting a cheer and preparing to attack his enemy. Can be translated into any kind of cheer, but please stay consistent with the other instances of "Rah!"
            message= _ "Rah!"
        [/message]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=turn $({SCENARIO_TURN_LIMIT}-5)
        [message]
            speaker=Diondra
            message=_"We will not fight here forever, villagers. The black ship is our real quarry! Let us swiftly vanquish these naga and be done with it."
        [/message]
    [/event]
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        [message]
            speaker=Diondra
            message=_"I cannot fight on behalf of your village any longer, humans. I must pursue the black ship before it escapes us! You will have to finish this battle yourselves."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
