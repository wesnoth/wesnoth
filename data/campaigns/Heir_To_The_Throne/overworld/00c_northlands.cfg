#textdomain wesnoth-h2tt
#wmlindent: start ignoring

#######################################################################################################################################################
#                                                                  S22 - GLAMDROL
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 19 9 _"Glamdrol Fortress"}
    {PLACE_PORT 11 10}
[/event]
{PLACE_POI 18 10 s22
    APPROACH_RADIUS=3 # can't be less than this, or it's possible to reach a secondary POI without triggering INCOMPLETE_APPROACHED

    SCENARIO_FILE=22_Glamdrol
    (PREVIEW_WML=
        title=_"Glamdrol"
        difficulty=2
        gold=2
        otherlabel=_"Item for Konrad: <span color='#EFBF04'><b>whenever one of Konrad’s living soldiers dies,
all others gain regeneration for one turn.</b></span>"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {GENERIC_UNIT 10 "Orcish Warlord" 19  9} {FACING se} {LEADER}
        {GENERIC_UNIT 10 "Orcish Grunt"   18  9} {FACING sw}
        {GENERIC_UNIT 10 "Orcish Grunt"   20 10} {FACING ne}
        {GENERIC_UNIT 10 "Orcish Archer"  20  9} {FACING se}
        {GENERIC_UNIT 10 "Orcish Archer"  18  8} {FACING ne}
        {GENERIC_UNIT 10 "Orcish Warrior" 16  9} {FACING ne}

        {GENERIC_UNIT  8 "Orcish Ruler" 22  7} {FACING sw} {LEADER}
        {GENERIC_UNIT  8 "Troll"        21  7} {FACING sw}
        {GENERIC_UNIT  8 "Troll Whelp"  22  8} {FACING sw}

        [capture_village]
            side=10
            x,y=17,9
            radius=6
        [/capture_village]

        # northwest
        {PLACE_IMAGE bigmap/poi-battle.png 17 8}
        [event]
            name=enter hex
            first_time_only=no
            {FILTER id,x,y=Konrad,17,8}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s22 id=$unit.id}
        [/event]

        # southeast
        {PLACE_IMAGE bigmap/poi-battle.png 21 10}
        [event]
            name=enter hex
            first_time_only=no
            {FILTER id,x,y=Konrad,21,10}
            {VARIABLE s10_from_west yes}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s22 id=$unit.id}
        [/event]
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Konrad
            message=_"We approach the walls of a great orcish fortress. Glamdrol!"
        [/message]
        [message]
            speaker=Konrad
            message=_"Most orcish tribes live a nomadic lifestyle, but Delfador says they take great pride in possessing Glamdrol — or in defeating the last possessor."
        [/message]
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Orcs often raid Wesnoth’s villages and towns, stealing whatever gold and valuables they can find. Perhaps it’s time we gave them a taste of their own medicine!"
        [/message]
        # determine where Konrad spawns on the scenario map
        {DO_AT_COORDS id=Konrad (
            {IF} {VARIABLE_CONDITIONAL coordX less_than    18} {THEN( {VARIABLE s22_from nw} )}{/IF}
            {IF} {VARIABLE_CONDITIONAL coordX equals       18} {THEN( {VARIABLE s22_from sw} )}{/IF}
            {IF} {VARIABLE_CONDITIONAL coordX greater_than 18} {THEN( {VARIABLE s22_from se} )}{/IF}
        )}
    )

    #############################
    # COMPLETED
    #############################
    #------------------------
    # COMPLETED PRESTART
    #------------------------
    (COMPLETED_PRESTART=
        {PLACE_IMAGE "units/orcs/grunt-ne-die-8.png~RC(magenta>red)" 20 10}
        {PLACE_IMAGE "units/orcs/grunt-die-8.png~RC(magenta>red)"    15  8}

        {IF} {VARIABLE_CONDITIONAL bm_s22_all_enemies_defeated equals yes} {THEN(
            {IF} {VARIABLE_CONDITIONAL bm_s22_gold_cost greater_than 0} {THEN(
                # stoneskins take posession
                {GENERIC_UNIT  5 "Orcish Ruler" 19 19} {FACING sw} {LEADER}
                {GENERIC_UNIT  5 "Troll"        20  9} {FACING sw}
                {GENERIC_UNIT  5 "Troll Whelp"  17 10} {FACING sw}
                {TEAM_COLOR_OVERRIDE x,y=19,19 black}
                {TEAM_COLOR_OVERRIDE x,y=20,7  black}
                {TEAM_COLOR_OVERRIDE x,y=22,8  black}
                [capture_village]
                    side=5
                    x,y=17,9
                    radius=6
                [/capture_village]
            )} {ELSE(
                # no orcs at all. City in ruins
                {MODIFY_TERRAIN Gd^Dr 18  9}
                {MODIFY_TERRAIN Gd^Dr 19  9}
                {MODIFY_TERRAIN Gd^Dr 21 10}
                {MODIFY_TERRAIN Gd^Dr 22  8}
            )} {/IF}
        )} {ELSE(
            # original owners still control the city
            {MODIFY_TERRAIN Gd^Dr 18  9}
            {MODIFY_TERRAIN Gd^Dr 21 10}
            {GENERIC_UNIT 10 "Orcish Crossbowman" 19  9} {FACING se} {LEADER}
            {GENERIC_UNIT 10 "Orcish Grunt"       18  9} {FACING sw}
            {GENERIC_UNIT 10 "Orcish Grunt"       21 10} {FACING ne}
            {GENERIC_UNIT 10 "Orcish Archer"      18  8} {FACING ne}
            {GENERIC_UNIT 10 "Orcish Warrior"     16  9} {FACING ne}
            [capture_village]
                side=10
                x,y=17,9
                radius=6
            [/capture_village]
        )} {/IF}
    )
    #------------------------
    # JUSTCOMPLETED START
    #------------------------
    (JUSTCOMPLETED_START=
        # if we paid the stoneskins...
        {IF} {VARIABLE_CONDITIONAL bm_s22_gold_cost greater_than 0} {THEN(
            [gold]
                side=1
                amount="$(0-$bm_s22_gold_cost)"
            [/gold]
            [store_gold]
                side=1
            [/store_gold]
            {IF} {VARIABLE_CONDITIONAL gold less_than 0} {THEN(
                [modify_side]
                    side=1
                    gold=0
                [/modify_side]
                [message]
                    speaker=Konrad
                    message= _ "We have ventured into a great stronghold of the orcs and escaped! We had to give up all of our carryover gold to satisfy our agreement with the Stoneskins, but at least we made it through."
                [/message]
            )} {ELSE(
                {IF} {VARIABLE_CONDITIONAL gold less_than 100} {THEN(
                    [message]
                        speaker=Konrad
                        message= _ "We have ventured into a great stronghold of the orcs and escaped! Now, after paying our agreed-upon $bm_s22_gold_cost gold to our Stoneskin friends, we still have $gold gold remaining for our next battle."
                    [/message]
                )} {ELSE(
                    [message]
                        speaker=Konrad
                        message= _ "We have ventured into a great stronghold of the orcs and escaped! And we have been well-rewarded for it! Even after paying our agreed-upon $bm_s22_gold_cost gold to our Stoneskin friends, we still have $gold gold remaining for our next battle."
                    [/message]
                )} {/IF}
            )} {/IF}
        )}
        # if we didn't pay the stoneskins...
        {ELSE(
            [store_gold]
                side=1
            [/store_gold]
            {IF} {VARIABLE_CONDITIONAL gold less_than 100} {THEN(
                [message]
                    speaker=Konrad
                    message= _ "We have ventured into a great stronghold of the orcs and escaped! Although we only managed to pillage $gold gold for our next battle, at least we have survived."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message= _ "We have ventured into a great stronghold of the orcs and escaped! And we have been well-rewarded for it, for we now have $gold gold stockpiled for our next battle."
                [/message]
            )} {/IF}
        )} {/IF}

        # if we got the horn...
        {IF} {VARIABLE_CONDITIONAL s22_horn_obtained equals yes} {THEN(
            [message]
                speaker=Konrad
                message= _ "Perhaps most importantly, we defeated the orcs’ shaman and took her magical horn! I shall wear it myself, and blow it whenever its magic is in need."
            [/message]
            {OBJECT_HORN(
                {FILTER id=Konrad}
                image="icons/warhorn.png"
                name=_"Horn of Glamdrol"
                description=_"This nondescript horn is infused with powerful orcish magic. Whenever one of Konrad’s living soldiers dies, all others gain regeneration for one turn."
            )}
        )}
        # if we didn't get teh horn...
        {ELSE(
            [message]
                speaker=Konrad
                message= _ "If only we had been able to defeat the orcs’ shaman and claim her magical horn..."
            [/message]
        )} {/IF}
        {CLEAR_VARIABLE gold,s22_horn_obtained,s22_from}
    )
    #------------------------
    # COMPLETED MOVETO
    #------------------------
    (COMPLETED_MOVETO=
        {IF} {VARIABLE_CONDITIONAL bm_s22_all_enemies_defeated equals yes} {THEN(
            {IF} {VARIABLE_CONDITIONAL bm_s22_gold_cost greater_than 0} {THEN(
                [message]
                    speaker=Konrad
                    message= _ "With the original orcish owners wiped out, our friends in the Stoneskin clan now hold the city."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message= _ "Glamdrol has been wiped clean of orcs!"
                [/message]
            )} {/IF}
        )} {ELSE(
            [message]
                speaker=Konrad
                message= _ "We’d best keep our distance. The orcs will be watching for any more raids!"
            [/message]
        )} {/IF}
    )
}

#######################################################################################################################################################
#                                                                    BAY OF JOTHA
#######################################################################################################################################################
# give the player an opportunity to recruit a Netcaster and get access to slow
# much cheaper if we've already completed bay of pearls, both 1) as a thematic "reward", and 2) because Jotha is redundant if you can level netcasters normally
#############################
# CREATE JOTHA
#############################
[event]
    name=prestart
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_jotha_recruited not_equals yes})}
    {NAMED_NOTRAIT_UNIT 4 "Merman Netcaster" 18 1 Jotha _"Jotha"} {FACING sw}
    {ADD_MODIFICATION({TRAIT_STRONG}{TRAIT_RESILIENT})}
[/event]
#############################
# KONRAD APPROACHES
#############################
[event]
    name=moveto
    first_time_only=no
    {FILTER( id=Konrad {FILTER_LOCATION x,y,radius=17,1,4 })}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_jotha_recruited not_equals yes})}

    #------------------------
    # INTRODUCTIONS
    #------------------------
    {IF} {VARIABLE_CONDITIONAL bm_jotha_recruited not_equals visited} {THEN(
        [message]
            speaker=Jotha
            message=_"What do you want? You here to trade? Jotha’s got nothin’ to trade but some old fish."
        [/message]
        [message]
            speaker=Konrad
            message=_"Is this your home, strange merman? The bay is warm, but fishing alone so far north must make for a lonely life."
        [/message]
    )} {/IF}
    {VARIABLE bm_jotha_recruited visited}
    [store_gold]
        side=1
    [/store_gold]

    #------------------------
    # COMPLETED BAY OF PEARLS
    #------------------------
    {IF} {VARIABLE_CONDITIONAL status_s04 equals completed} {THEN(
        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message=_"Let me make you an offer. Come join my army, and fight for a righteous cause instead of slaving away as a trawler! We already have merfolk among our number — you’ll feel right at home."
        [/message]
        [message]
            speaker=Jotha
            message=_"Other merfolk, you say? Hmm... I’ll give you a discount for that, but I still ain’t working fer free. 10 gold and I’ll join you, and you’ll still have to pay to recall me each battle."
        [/message]
        [message]
            speaker=Konrad
            [option]
                message=_"Pay 10 gold"
                [command]
                    {VARIABLE jotha_cost 10}
                [/command]
            [/option]
            [option]
                message=_"Decline"
                [command]
                    {CLEAR_VARIABLE gold,jotha_cost}
                    [return][/return]
                [/command]
            [/option]
        [/message]
    )}
    #------------------------
    # DIDN'T COMPLETE BAY OF PEARLS
    #------------------------
    {ELSE(
        [message]
            speaker=Konrad
            message=_"Let me make you an offer. Come join my army, and fight for a righteous cause instead of slaving away as a trawler! I would be glad to welcome one of the noble mermen to our ranks."
        [/message]
        [message]
            speaker=Jotha
            message=_"Join your army, you say? Hmm... I wouldn’t mind getting out o’ this pond, but I still ain’t working fer free. 30 gold and I’ll join you, and you’ll still have to pay to recall me each battle."
        [/message]
        [message]
            speaker=Konrad
            [option]
                message=_"Pay 30 gold."
                [command]
                    {VARIABLE jotha_cost 30}
                [/command]
            [/option]
            [option]
                message=_"Decline"
                [command]
                    {CLEAR_VARIABLE gold,jotha_cost}
                    [return][/return]
                [/command]
            [/option]
        [/message]
    )} {/IF}

    #------------------------
    # NOT ENOUGH GOLD
    #------------------------
    {IF} {VARIABLE_CONDITIONAL gold less_than $jotha_cost} {THEN(
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"I would like to agree to your offer, but I don’t have enough gold right now. Would you consider lowering your price?"
        [/message]
        [message]
            speaker=Jotha
            message=_"No gold, no Jotha. Now go away and stop bothering me."
        [/message]
        {CLEAR_VARIABLE gold,jotha_cost}
        [return][/return]
    )} {/IF}

    #------------------------
    # RECRUIT MERMAN
    #------------------------
    [gold]
        side=1
        amount="$(0-$jotha_cost)"
    [/gold]
    {SOUND gold.ogg}
    [message]
        speaker=Konrad {KONRAD_VARIATION glad}
        message=_"Welcome to the rebellion against Asheviere, friend merman. I am glad to have you on our side."
    [/message]
    {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Jotha $stored_konrad.x $stored_konrad.y} {MODIFY_UNIT id=Jotha side 1} {PUT_TO_RECALL_LIST id=Jotha} )}

    {VARIABLE bm_jotha_recruited yes}
    {CLEAR_VARIABLE gold,jotha_cost}
[/event]

#######################################################################################################################################################
#                                                                S23 - NORTHERN WINTER
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 37 6 _"Ashen’s Maw"}

    # this scenario is more challenging in winter and less challenging in spring/autumn and especially summer
    {IF} {VARIABLE_CONDITIONAL bm_tod.id contains winter} {THEN( 
        {VARIABLE s23_difficulty 2}
    )} {ELSE(
        {VARIABLE s23_difficulty 1}
    )} {/IF}

    {IF} {VARIABLE_CONDITIONAL bm_tod.id contains spring} {THEN(  {VARIABLE s23_file 23_Northern_Spring} {VARIABLE s23_title _"Northern Spring"}  )} {/IF}
    {IF} {VARIABLE_CONDITIONAL bm_tod.id contains summer} {THEN(  {VARIABLE s23_file 23_Northern_Summer} {VARIABLE s23_title _"Northern Summer"}  )} {/IF}
    {IF} {VARIABLE_CONDITIONAL bm_tod.id contains autumn} {THEN(  {VARIABLE s23_file 23_Northern_Autumn} {VARIABLE s23_title _"Northern Autumn"}  )} {/IF}
    {IF} {VARIABLE_CONDITIONAL bm_tod.id contains winter} {THEN(  {VARIABLE s23_file 23_Northern_Winter} {VARIABLE s23_title _"Northern Winter"}  )} {/IF}

    # add snow
    [item]
        halo=terrain/snow/[0001~0033].png
        x,y=26-34,6-11
    [/item]
[/event]
{PLACE_POI 31 9 s23
    SCENARIO_FILE=$s23_file
    (PREVIEW_WML=
        title=$s23_title
        difficulty=$s23_difficulty
        gold=1
        companion1=units/alchemist/alchemist.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {UNSTORE_NPC Jeniver x,y=31,8 side,facing=3,sw}
        {GENERIC_UNIT 7 (Frost Stoat) 34 8} {FACING sw}
        {GENERIC_UNIT 7 (Icemonax)    29 9} {FACING nw}
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Jeniver
            message="<span size='small'>" + _"... three parts essence of bark, one part yeti tongue..." + "</span>"
        [/message]
        [message]
            speaker=Konrad
            message=_"Hello, strange woman! What are you doing alone so far north? And in the middle of a blizzard too!"
        [/message]
        [message]
            speaker=Jeniver
            message="<span size='small'>" + _"... a distillation of fire, elixir of the right-eye..." + "</span>"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"Hello? Hello!? ...she’s very engrossed in something, and still hasn’t noticed us."
        [/message]
    )
    (INCOMPLETE_MOVETO=
        {IF} {VARIABLE_CONDITIONAL bm_tod.id contains winter} {THEN( 
            [message]
                speaker=Konrad
                message=_"The Northlands are a dangerous place to be wandering alone, especially in the center of such a fierce snowstorm, and <b><i>especially</i></b> in the middle of winter. We should speak to this woman and see if she needs any help."
            [/message]
        )} {ELSE(
            [message]
                speaker=Konrad
                message=_"The Northlands are a dangerous place to be wandering alone, especially in the center of such a fierce snowstorm. We should speak to this woman and see if she needs any help."
            [/message]
        )} {/IF}
        # determine where Konrad spawns on the scenario map
        {IF} {VARIABLE_CONDITIONAL previous_x greater_than_equal_to 32}
            {THEN({VARIABLE s23_from e})}
            {ELSE({VARIABLE s23_from w})}
        {/IF}
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {CLEAR_VARIABLE s23_from}
    )
    (JUSTCOMPLETED_START=

    )
    (COMPLETED_MOVETO=

    )
}

#######################################################################################################################################################
#                                                                S24 - AN OLD FRIEND
#######################################################################################################################################################
#############################
# GATEKEEPERS
#############################
[event]
    name=prestart
    {SET_LABEL 30 21 _"Wesmere Forest"}
    {IF} {VARIABLE_CONDITIONAL bm_wesmere_unlocked not_equals yes} {THEN(
        {GENERIC_UNIT 2 (Elvish Fighter) 31 19} {FACING nw} {ROLE wesmere_guard}
        {GENERIC_UNIT 2 (Elvish Ranger)  27 24} {FACING nw} {ROLE wesmere_guard}
        {GENERIC_UNIT 2 (Elvish Fighter) 37 21} {FACING ne} {ROLE wesmere_guard}
    )} {ELSE(
        {GENERIC_UNIT 2 (Elvish Fighter) 28 24} {FACING nw}
        {GENERIC_UNIT 2 (Elvish Ranger)  28 21} {FACING nw}
        {GENERIC_UNIT 2 (Elvish Fighter) 37 23} {FACING ne}
    )} {/IF}

    [capture_village]   
        side=2
        x,y=31,22
        radius=4
    [/capture_village]
[/event]
[event]
    name=enter hex
    first_time_only=no
    {FILTER( id=Konrad {FILTER_ADJACENT role=wesmere_guard} )}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_wesmere_unlocked not_equals yes})}

    [cancel_action]
    [/cancel_action]
    #------------------------
    # INTRODUCTIONS
    #------------------------
    {IF} {VARIABLE_CONDITIONAL bm_wesmere_unlocked not_equals visited} {THEN(
        [message]
            role=wesmere_guard {FILTER_ADJACENT id=Konrad}
            message=_"By order of the lady Chantal, Wesmere forest is closed to outsiders. Be off with you."
        [/message]
        [message]
            speaker=Konrad
            message=_"Good elf, I am Konrad, heir to the throne of Wesnoth, child of the Aethenwood and ally of Wesmere. I am no outsider, but come as a friend!"
        [/message]
        [message]
            role=wesmere_guard {FILTER_ADJACENT id=Konrad}
            message=_"Apologies, but I have my orders. None can enter here. Even you, Your Royal Highness."
        [/message]
    )} {ELSE(
        [message]
            role=wesmere_guard {FILTER_ADJACENT id=Konrad}
            message=_"By order of the lady Chantal, Wesmere forest is closed to outsiders. Even you, Your Royal Highness."
        [/message]
    )} {/IF}

    #------------------------
    # IS KALENZ HERE?
    #------------------------
    {IF} {HAVE_UNIT id,side,search_recall_list=Kalenz,1,yes} {THEN(
        {MOVE_UNDER_KONRAD( {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Kalenz $stored_konrad.x "$($stored_konrad.y+1)"} )}
        [message]
            speaker=Kalenz
            message=_"Even me, guard of Wesmere?"
        [/message]
        [message]
            role=wesmere_guard {FILTER_ADJACENT id=Konrad}
            message=_"High Lord Kalenz! Speaking to me!?"
        [/message]
        [message]
            role=wesmere_guard {FILTER_ADJACENT id=Konrad}
            message=_"Err, well, I was told not to let anyone in... but surely you and any companions of yours are an exception. Go on, and speak to your granddaughter."
        [/message]
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kalenz $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz} )}
        {VARIABLE bm_wesmere_unlocked yes}
    )} {ELSE(
        [message]
            speaker=Konrad
            message=_"How strange..."
        [/message]
        {MOVE_UNIT id=Konrad $x2 $y2}
        {VARIABLE bm_wesmere_unlocked visited}
    )} {/IF}
[/event]

#############################
# POI
#############################
#define S24_NOT_COMPLETED_PRESTART
    {GENERIC_UNIT 2 (Elvish Sorceress) 34 22} {FACING sw}
    {GENERIC_UNIT 2 (Elvish Shaman)    31 25} {FACING nw}
    {GENERIC_UNIT 2 (Elvish Archer)    32 21} {FACING nw}
#enddef
# NOTE - if Kalenz "dies" and status_s24 not_equals completed, status gets set to failed (unified_characters.cfg GLOBAL__HERODEATHS)
{PLACE_POI 32 22 s24
    APPROACH_RADIUS=2

    SCENARIO_FILE=24_An_Old_Friend
    (PREVIEW_WML=
        title=_"An Old Friend"
        difficulty=1
        gold=1
        recruit1=units/elves-wood/shaman.png
        otherlabel=_"<b>-OR-</b> (choose one reward)"
        companion1=units/elves-wood/shyde.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {UNSTORE_NPC Chantal x,y=33,23 side,facing=2,se}
        {S24_NOT_COMPLETED_PRESTART}
    )
    (INCOMPLETE_APPROACHED=
        {MOVE_UNDER_KONRAD( {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Kalenz $stored_konrad.x "$($stored_konrad.y+1)"} )}
        [message]
            speaker=Chantal
            message=_"Great-grandfather?! What is the meaning of this?"
        [/message]
        [message]
            speaker=Kalenz
            message=_"What is the meaning of this, indeed. The borders of Wesmere closed, even to Konrad and his retinue? What sort of trouble ails you, Chantal?"
        [/message]
        [message]
            speaker=Chantal
            message=_"An old friend has returned, Kalenz.... I had hoped to put off this confrontation, but I know it is for the best that you are here, and that my hand is forced."
        [/message]
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kalenz $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz} )}
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Chantal
            message=_"This is a matter of a personal nature, Konrad. If you do not object, I would prefer if Kalenz and I did this alone."
        [/message]
    )

    #############################
    # FAILED
    #############################
    (FAILED_PRESTART=
        {UNSTORE_NPC Chantal x,y=33,23 side,facing=2,se}
        {S24_NOT_COMPLETED_PRESTART}
    )
    (FAILED_MOVETO=
        [message]
            speaker=Chantal
            message=_"This is a matter of a personal nature, Konrad. Kalenz is not here, and I would rather handle things myself."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {IF} {VARIABLE_CONDITIONAL stored_chantal.length greater_than 0} {THEN(
            {GENERIC_UNIT 2 (Elvish Sorceress) 33 23} {FACING sw}
            {GENERIC_UNIT 2 (Elvish Shaman)    34 22} {FACING nw}
            {GENERIC_UNIT 2 (Elvish Shaman)    31 25} {FACING nw}
            {GENERIC_UNIT 2 (Elvish Archer)    32 21} {FACING nw}
        )} {ELSE(
            {S24_NOT_COMPLETED_PRESTART}
        )} {/IF}
    )
    (JUSTCOMPLETED_START=
        {UNSTORE_NPC Chantal x,y=33,23 side,facing=2,nw}
        [message]
            speaker=Chantal
            message=_"Thank you for your patience, Konrad. Kalenz and I are finished with our task."
        [/message]
        [message]
            speaker=Chantal
            message=_"As my heart begins to heal, so shall we elves help to heal your army. Though most of us must stay here to protect our domain, the shamans of Wesmere are ready to follow you." + "

" + _ "Or, if you wish, I can personally accompany you on your quest to overthrow the dark queen."
        [/message]
        [message]
            speaker=Konrad
            [option]
                message=_"Learn to recruit Elvish Shamans"
                [command]
                    [message]
                        speaker=Chantal
                        message=_"I am glad we can help you, Konrad, for the dark queen has many deaths to answer for. Asheviere will rue the day she made an enemy of the elves."
                    [/message]
                    {NEW_RECRUIT1 (Elvish Shaman) _"Konrad can now recruit Elvish Shamans!" elves-wood/shaman.png}
                [/command]
            [/option]
            [option]
                message=_"Gain Chantal as a loyal companion"
                [command]
                    [message]
                        speaker=Chantal
                        message=_"I am glad to join you on your quest, Konrad, for the dark queen has many deaths to answer for. Asheviere will rue the day she made an enemy of the elves."
                    [/message]
                    {MODIFY_UNIT id=Chantal side 1}
                    {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Chantal $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Chantal} )}
                [/command]
            [/option]
        [/message]
    )
    (COMPLETED_MOVETO=
        # nothing. If I ever do add a line here, remember that Chantal may either be on her keep or in Konrad's recall list
    )
}

#######################################################################################################################################################
#                                                                  SAURIAN TRAINING
#######################################################################################################################################################
#############################
# HELPER MACRO
#############################
#define TRAINING_MONTAGE COST DESC TRAINING_EFFECTS
    #------------------------
    # DEDUCT GOLD
    #------------------------
    [store_gold]
        side=1
    [/store_gold]
    {IF} {VARIABLE_CONDITIONAL gold less_than {COST}} {THEN(
        [message]
            speaker=Konrad
            message=_"I would like to agree to your offer, but I don’t have enough gold! Perhaps another time, lizard."
        [/message]
        [return][/return]
    )} {/IF}
    {CLEAR_VARIABLE gold}
    [gold]
        side=1
        amount="$(0-{COST})"
    [/gold]
    {SOUND gold.ogg}

    #------------------------
    # FADE SCREEN OUT AND IN
    #------------------------
    {FADE_MUSIC_OUT 500}
    {SCREEN_FADER 0,0,0 255 500}
    {SOUND magicmissile.wav} {DELAY 300}
    {SOUND magicmissile.wav} {DELAY 300}
    {SOUND magicmissile.wav} {DELAY 300}
    {DELAY 500}
    {SOUND human-hit-1.ogg} {DELAY 500}
    {SOUND human-hit-5.ogg} {DELAY 500}
    {SOUND magic-faeriefire-miss.ogg} {DELAY 750}
    {SCREEN_FADER 0,0,0 0   500}
    {FADE_MUSIC_IN 500}

    #------------------------
    # GIVE OBJECT TO KONRAD
    #------------------------
    [message]
        speaker=Konrad
        message=_"Whew! This has been grueling, but I feel as light on my feet as a fencer. I am grateful for your tutelage, Tirix."
    [/message]
    [object]
        {FILTER id=Konrad}
        id=saurian_training
        image=attacks/foot-boot.png
        name=_"Saurian Footwork"
        description={DESC}
        {TRAINING_EFFECTS}
    [/object]
    {VARIABLE bm_skirmisher_trained yes}
#enddef

#############################
# CREATE SAURIANS
#############################
# the saurians are accessible from BOTH sides of the swamp
# thus, this event can be done either before or after the Sceptre
[event]
    name=prestart
    {NAMED_UNIT   2 "Saurian Ambusher" 66 27 Tirix _"Tirix" ()} {FACING nw} {ROLE saurian_tutor}
    {GENERIC_UNIT 2 "Saurian Augur"    69 27                  } {FACING se} {ROLE saurian_tutor}
[/event]
#############################
# KONRAD APPROACHES
#############################
[event]
    name=moveto
    first_time_only=no
    {FILTER( id=Konrad {FILTER_LOCATION(radius=2 {FILTER role=saurian_tutor})} )}
    {FIRE_EVENT bm_check_for_saurian_skip} # used by 00_The_Great_Continent

    #------------------------
    # NOT YET TRAINED
    #------------------------
    {IF} {VARIABLE_CONDITIONAL bm_skirmisher_trained not_equals yes} {THEN(
        {IF} {VARIABLE_CONDITIONAL bm_skirmisher_trained not_equals visited} {THEN(
            [message]
                speaker=Tirix
                #po: Slow, slow! It is disgusting how all you tall ones are so slow!
                message=_"Ssslow, ssslow! It isss disssgusssting how you tall onesss are all ssso ssslow!"
            [/message]
            [message]
                speaker=Konrad
                message=_"What do you mean, lizard? Both my legs and my sword-arm are perfectly quick — as you will soon find out if you wish me any ill-intent."
            [/message]
            [message]
                speaker=Tirix
                #po: Psssh... I know your kind; tall, and clumsy. Tirix can teach you speed... yes, speed... But only if you pay. It shall not be cheap.
                message=_"Psssh... I know your kind; tall, and clumsssy. Tirix can teach you ssspeed... yesss, ssspeed... But only if you pay. It ssshall not be cheap."
            [/message]
        )} {ELSE(
            [message]
                speaker=Tirix
                message=_"Have you returned to learn the waysss of ssspeed, human?"
            [/message]
        )} {/IF}
        {VARIABLE bm_skirmisher_trained visited}

        #------------------------
        # NO TIME FOR TRAINING
        #------------------------
        # when we're rushing to meet Delfador at the Sceptre, disable the saurian training shop.
        # 1) if Konrad's in too much of a hurry to fight, it doesn't make sense that he could stop and take time to train with some random saurians
        # 2) don't let the player bypass the usual overworld barriers to reaching this part of the map
        {IF} {VARIABLE_CONDITIONAL bm_turns equals $bm_milestone_scepter} {THEN(
            [message]
                speaker=Konrad
                message=_"You are kind to offer, but I am hurrying north to meet with my mentor, and have no time to spare for lengthy training. Perhaps we will meet again another day."
            [/message]
        )}
        #------------------------
        # TRAINING OPTIONS
        #------------------------
        {ELSE(
            [message]
                speaker=Konrad
                [option]
                    message=_"50 gold; physical training: <b>Konrad gains +1MP</b>"
                    [command]
                        {TRAINING_MONTAGE 50
                            _"After rigorous physical training with the saurians of the Swamp of Dread, Konrad has gained <b>+1MP</b>."
                            ({EFFECT movement increase=1})
                        }
                    [/command]
                [/option]
                [option]
                    message=_"100 gold; magical training: <b>Konrad gains +2MP</b>"
                    [command]
                        {TRAINING_MONTAGE 100
                            _"After rigorous physical and magical training with the saurians of the Swamp of Dread, Konrad has gained <b>+2MP</b>."
                            ({EFFECT movement increase=2})
                        }
                    [/command]
                [/option]
                [option]
                    # this is expensive, but is a great way for Konrad (with the Sceptre) to assassinate Asheviere in the final scenario
                    message=_"150 gold; legendary training: <b>Konrad gains +2MP and <i>skirmisher</i></b>"
                    [command]
                        {TRAINING_MONTAGE 150
                            _"After rigorous physical and magical training with the saurians of the Swamp of Dread, Konrad has gained <b>+2MP</b> and the <b><i>skirmisher</i></b> ability."
                            ({EFFECT movement increase=2} {EFFECT new_ability (
                                [abilities]
                                    {ABILITY_SKIRMISHER}
                                [/abilities]
                            )})
                        }
                    [/command]
                [/option]
                [option]
                    message=_"Decline"
                    [command]
                    [/command]
                [/option]
            [/message]
        )} {/IF}
    )}
    #------------------------
    # ALREADY TRAINED
    #------------------------
    {ELSE(
        [message]
            speaker=Tirix
            message=_"Good, good, much better. Not so ssslow any more! I have no time or interessst in more training."
        [/message]
    )} {/IF}
[/event]

#define ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA KONRAD_OR_NOBODY
    {IF} {VARIABLE_CONDITIONAL bm_fall_of_knalga_explained not_equals yes} {THEN(
        #------------------------
        # HAVE ULFDAIN
        #------------------------
        {IF} {HAVE_UNIT( side,search_recall_list=1,yes {AND id=Ulfdain} )} {THEN(
            [cancel_action]
            [/cancel_action]
            {VARIABLE bm_fall_of_knalga_explained yes}
            {MOVE_UNDER_KONRAD( {RECALL_XY Ulfdain $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Ulfdain "$($stored_konrad.x-1)" $stored_konrad.y} )}
            [message]
                speaker={KONRAD_OR_NOBODY}
                message=_"What happened here was such a tragedy... do you know anything more than I do, Ulfdain?"
            [/message]
            [message]
                speaker=Ulfdain
                message=_"Aye... ’twas a time of doom an’ great deeds, o’ fire an’ blood an’ slaughter. My father an’ his father alike perished defendin’ th’ West Gate, an’ soon after fell the Doors, an’ our King Thunedain with them."
            [/message]
            [message]
                speaker=Ulfdain
                message=_"The better part o’ our spirit died in those years. E’er since, us dwarves’ve been a people in decline, sniveling in our tunnels, th’ dyin’ dregs of a once-proud people. Or betrayin’ their kin to start anew in human lands, like me..."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"I’ve never-before heard you speak so grimly, Ulfdain. I’m sorry for your loss. Is there nothing we can do to restore Knalga to its former glory?"
            [/message]
            [message]
                speaker=Ulfdain
                message=_"Not lest ye’ can fight off all the orcs o’ the north, an’ trolls an’ undead besides. No, there ain’t no use cryin’ over it. Ah’ve given up hope; it’s only death in battle tha’ I wish fer now..."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Ulfdain $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Ulfdain} )}
        )}
        #------------------------
        # HAVE DWARF
        #------------------------
        {ELSEIF} {HAVE_UNIT( side,search_recall_list=1,yes {AND race=dwarf,gryphon} )} {THEN(
            [cancel_action]
            [/cancel_action]
            {VARIABLE bm_fall_of_knalga_explained yes}
            {STORE_UNIT_VAR ( side,x,y=1,recall,recall {AND race=dwarf,gryphon} ) id dwarf_id}
            {MOVE_UNDER_KONRAD( {RECALL_XY $dwarf_id $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=$dwarf_id "$($stored_konrad.x-1)" $stored_konrad.y} )}
            [message]
                speaker={KONRAD_OR_NOBODY}
                message=_"What happened here was such a tragedy... is there nothing we can do to restore Knalga to its former glory? Do you know anything more than I do, my dwarvish friend?"
            [/message]
            [message]
                speaker=$dwarf_id
                message=_"Aye, but ’tis not a time we dwarves like to talk about. The West Gate fallen, the Dwarven Doors sacked..."
            [/message]
            [message]
                speaker=$dwarf_id
                message=_"No, there ain’t nothin’ ye can do, not unless ye’ can fight off all the orcs o’ the north, an’ trolls an’ undead besides. Us dwarves’re doomed to be a people in decline, sniveling in our tunnels, th’ dyin’ dregs of a once-proud people..."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=$dwarf_id $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=$dwarf_id} )}
            {CLEAR_VARIABLE dwarf_id}
        )} {/ELSEIF}
        #------------------------
        # NO DWARVES
        #------------------------
        {ELSE(
            # say nothing. Don't set bm_fall_of_knalga_explained until we have dwarf who can explain this
        )} {/IF}
    )} {/IF}
#enddef

#######################################################################################################################################################
#                                                              S26 - THE DWARVEN DOORS
#######################################################################################################################################################
#define S26_PRESTART
    #------------------------
    # ORCS
    #------------------------
    {GENERIC_UNIT 10 "Orcish Warrior"     47 17} {FACING se} {LEADER}
    {GENERIC_UNIT 10 "Orcish Crossbowman" 50 16} {FACING sw} {LEADER}
    {GENERIC_UNIT 10 "Orcish Warrior"     50 18} {FACING sw} {LEADER}
    {GENERIC_UNIT 10 "Orcish Grunt"       48 17} {FACING ne}
    {GENERIC_UNIT 10 "Orcish Grunt"       53 19} {FACING ne}
    {GENERIC_UNIT 10 "Orcish Archer"      52 19} {FACING se}
    {GENERIC_UNIT 10 "Wolf Rider"         54 20} {FACING se}
    {GENERIC_UNIT 10 "Orcish Grunt"       45 19} {FACING ne}
    {GENERIC_UNIT 10 "Orcish Grunt"       47 21} {FACING se}
    {GENERIC_UNIT 10 "Orcish Archer"      46 20} {FACING sw} {ROLE doors_orc}

    #------------------------
    # SLAVES
    #------------------------
    {GENERIC_UNIT 5 "Peasant"  47 19} {FACING sw}
    {GENERIC_UNIT 5 "Peasant"  48 19} {FACING se}
    {GENERIC_UNIT 5 "Woodsman" 47 20} {FACING sw} {ROLE doors_woodsman}
    {GENERIC_UNIT 5 "Peasant"  49 20} {FACING se}
    {GENERIC_UNIT 5 "Peasant"  52 20} {FACING se} # 52,21 is used by the lisar-approaches-sceptre event
    {GENERIC_UNIT 5 "Peasant"  51 20} {FACING se}
    {GENERIC_UNIT 5 "Woodsman" 44 20} {FACING se}
#enddef
[event]
    name=prestart
    {SET_LABEL 48 18 _"Dwarven Doors"}
[/event]
{PLACE_POI 49 19 s26 # if I change snum, also change the secondary POI's fire_event
    SCENARIO_FILE=26_The_Dwarven_Doors
    (PREVIEW_WML=
        title=_"The Dwarven Doors"
        difficulty=2
        gold=2
        recruit1=units/human-peasants/peasant.png
        recruit2=units/human-peasants/woodsman.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {S26_PRESTART}

        #------------------------
        # SECONDARY POIS
        #------------------------
        {REMOVE_IMAGE 49 19}

        # southeast
        {PLACE_IMAGE bigmap/poi-battle.png 48 16}
        [event]
            name=enter hex
            first_time_only=no
            {FILTER id,x,y=Konrad,48,16}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s26 id=$unit.id}
        [/event]

        # southwest
        {PLACE_IMAGE bigmap/poi-battle.png 50 20}
        [event]
            name=enter hex
            first_time_only=no
            {FILTER id,x,y=Konrad,50,20}
            {VARIABLE s10_from_west yes}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s26 id=$unit.id}
        [/event]
    )
    (INCOMPLETE_APPROACHED=
        # nothing. Handle "approach" manually, so we can properly explain the fall of knalga
    )
    (INCOMPLETE_MOVETO=
        {IF} {VARIABLE_CONDITIONAL previous_y less_than 18} {THEN(
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"The once-thriving free city of Dwarven Doors is filled with slaves and their orcish masters. We can fight our way north to reach the caves of Knalga, while freeing as many slaves as possible on our way!"
            [/message]
            {VARIABLE s26_from n}
        )} {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"The once-thriving free city of Dwarven Doors is filled with slaves and their orcish masters. We can fight our way south to exit the caves of Knalga, while freeing as many slaves as possible on our way!"
            [/message]
            {VARIABLE s26_from s}
        )} {/IF}
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {IF} {VARIABLE_CONDITIONAL bm_s26_total_victory equals yes} {THEN(
            # orcs are all dead and slaves are all rescued
            {PLACE_IMAGE "units/orcs/grunt-ne-die-8.png~RC(magenta>red)"      49 18}
            {PLACE_IMAGE "units/orcs/grunt-die-8.png~RC(magenta>red)"         52 20}
            {PLACE_IMAGE "units/orcs/grunt-ne-die-8.png~RC(magenta>red)~FL()" 50 19}
            {PLACE_IMAGE "units/orcs/grunt-die-8.png~RC(magenta>red)~FL()"    48 21}
        )} {ELSE(
            {S26_PRESTART}
        )} {/IF}
    )
    (JUSTCOMPLETED_START=
        {IF} {VARIABLE_CONDITIONAL s26_from equals n} {THEN(
            {MOVE_UNIT id=Konrad 47 15}
        )} {ELSE(
            {MOVE_UNIT id=Konrad 49 22}
        )} {/IF}
        {CLEAR_VARIABLE s26_from}

        {IF} {VARIABLE_CONDITIONAL bm_s26_total_victory equals yes} {THEN(
            [message]
                speaker=Konrad
                message=_"We have cleared the Doors of orcs! It sounds as though they mean to return in the future, but at least for now we will be able to pass unmolested."
            [/message]
        )} {ELSE(
            [message]
                speaker=Konrad
                message=_"We have fought our way through the Doors! The orcs know better than to try to fight us again in the future, but neither can we rescue any more of their slaves while they are on alert. At least we will henceforth be able to pass unmolested."
            [/message]
        )} {/IF}
        {FIRE_EVENT check_for_knalgan_resurgence}
    )
    (COMPLETED_MOVETO=
    )
}
#############################
# CUSTOM APPROACH EVENT
#############################
[event]
    name=enter hex
    {FILTER( side=1 {FILTER_LOCATION( x,y,radius=49,19,4 )} )}
    # repeat this "approach" event every single time we load the bigmap. Handle which specific dialogues to say (if any) in special detail

    # the first time, play regular approach dialogue
    {IF} {VARIABLE_CONDITIONAL approached_s26_initial not_equals yes} {THEN(
        [cancel_action]
        [/cancel_action]
        {VARIABLE approached_s26_initial yes}
        {DELAY 250}
        {ANIMATE_HARM role=doors_orc 4 range=melee role=doors_woodsman}
        [message]
            role=doors_orc
            message=_"Get back to work, pinkskin! Show your masters a proper work ethic and maybe you’ll be spared the lash!"
        [/message]
        {DELAY 250}
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Slaves? This is a travesty! Weren’t the Dwarven Doors once a great center of civilization?"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Their alliance with Knalga was strong, but even man and dwarf together could not stop the orcish war-horde. And now it’s a slave city under the heel of the orcs!"
        [/message]
        {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA nobody}
    )}
    # for future times, only try to explain the fall of knalga
    {ELSE(
        {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA Konrad}
    )} {/IF}
[/event]

#######################################################################################################################################################
#                                                                S28 - THE LOST GENERAL
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 40 12 _"Caverns of Chaincolt"}
    {IF} {VARIABLE_CONDITIONAL turn_number equals $bm_milestone_scepter}
         {VARIABLE_CONDITIONAL status_s28 not_equals in_progress}
         {VARIABLE_CONDITIONAL status_s28 not_equals completed}
    {THEN(
        {VARIABLE status_s28 failed}
    )} {/IF}
[/event]
{PLACE_POI 39 12 s28
    SCENARIO_FILE=28_The_Lost_General
    (PREVIEW_WML=
        title=_"The Lost General"
        preview=bigmap/preview-shroud.png
        difficulty=1
        gold=2
        otherlabel=_"Weapon for Konrad: <span color='#EFBF04'><b>+3 melee damage, <i>drains</i> special on melee attacks</b></span>"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        # place a skeleton so that the player knows there's undead here, and brings anti-undead units
        {GENERIC_UNIT 6 Revenant 40 11} {FACING se} {HITPOINTS 35} # wesred, because it's one of Lionel's troops
        # place trolls to block off entrances, so that there's 3 distinct passageways (matching the in-scenario map)
        {GENERIC_UNIT 8 "Troll"       39 13} {FACING sw} {HITPOINTS 15}
        {GENERIC_UNIT 8 "Troll Whelp" 41 12} {FACING nw}
        {GENERIC_UNIT 8 "Troll Whelp" 37 13} {FACING sw}
    )
    (INCOMPLETE_APPROACHED=
        # nothing. Handle "approach" manually, so we can properly explain the fall of knalga
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message=_"These old halls were ruined long ago, but there may still be something of value inside."
        [/message]
        {IF} {VARIABLE_CONDITIONAL previous_x equals 39} {THEN( {VARIABLE s28_from nw} )}{/IF} # determine where Konrad spawns on the scenario map
        {IF} {VARIABLE_CONDITIONAL previous_x equals 38} {THEN( {VARIABLE s28_from sw} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL previous_x equals 40} {THEN( {VARIABLE s28_from se} )}{/IF}
    )

    #############################
    # FAILED
    #############################
    (FAILED_PRESTART=
    )
    (FAILED_MOVETO=
        [message]
            speaker=Konrad
            message= _ "The trolls that used to inhabit these old halls have gone; either killed off or merely moved. There might have been treasure here, once, but all that is left now is rubble and excrement."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {CLEAR_VARIABLE s28_from}
    )
    (JUSTCOMPLETED_START=
        [message]
            speaker=Konrad
            message=_"I’m glad to be out into the sun and fresh air again. I’m don’t despise caves so much as an elf, but I’m no dwarf either."
        [/message]
        {FIRE_EVENT check_for_knalgan_resurgence}
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message=_"There’s nothing more of value here — at least nothing that we have the time or skill to unearth."
        [/message]
    )
}
#############################
# CUSTOM APPROACH EVENT
#############################
[event]
    name=enter hex
    {FILTER( side=1 {FILTER_LOCATION( x,y,radius=39,13,4 )} )}
    # repeat this "approach" event every single time we load the bigmap. Handle which specific dialogues to say (if any) in special detail

    # the first time, play regular approach dialogue
    {IF} {VARIABLE_CONDITIONAL approached_s28_initial not_equals yes} {THEN(
        [cancel_action]
        [/cancel_action]
        {VARIABLE approached_s28_initial yes}
        [message]
            speaker=Konrad
            message=_"The West Gate of Knalga! I learned about this place... it was a terrible tragedy when the kingdom of the dwarves was shattered by the orcs and their allies. Now all that’s left here are trolls and ruins."
        [/message]
        {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA nobody}
    )}
    # for future times, only try to explain the fall of knalga
    {ELSE(
        {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA Konrad}
    )} {/IF}
[/event]

#######################################################################################################################################################
#                                                                S29 - EAST KNALGA
#######################################################################################################################################################
#define S29_PRESTART
    {SET_LABEL 49 13 _"Greater Knalga"}
    {PLACE_IMAGE "items/bones.png"      38 12}
    {PLACE_IMAGE "items/bones.png~FL()" 45 13}
    {PLACE_IMAGE "items/bones.png"      41 14}

    {NAMED_UNIT   5 "Dwarvish Stalwart"    50 12 Geldar  _"Geldar"  ()} {FACING sw} {HITPOINTS 45}
    {NAMED_UNIT   5 "Dwarvish Lord"        53 12 Relgorn _"Relgorn" ()} {FACING sw} {LEADER}
    {GENERIC_UNIT 5 "Dwarvish Dragonguard" 55 13} {FACING ne}
    {GENERIC_UNIT 5 "Dwarvish Guardsman"   56 11} {FACING ne}

    {PLACE_IMAGE terrain/village/dwarven.png 53 13} # can't use a real village here, because we need to block Konrad from moving through the hex
#enddef
{PLACE_POI 51 12 s29
    # one player couldn't figure out how to get past this POI and reach Delfador. Reduce the radius to 1 to make this easier
    APPROACH_RADIUS=1
    SCENARIO_FILE=29_Digging_for_Dwarves
    (PREVIEW_WML=
        title=_"Digging for Dwarves"
        preview=bigmap/preview-shroud.png
        difficulty=1
        gold=0
        recruitlabel=_"New Recruits
<i><b>Choose Two</b></i>:"
        recruit1=units/dwarves/fighter.png
        recruit2=units/dwarves/guard.png
        recruit3=units/dwarves/thunderer/thunderer.png
        recruit4=units/dwarves/ulfserker.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {S29_PRESTART}

        # moved POI; the actual POI is in impassable mountains, so that the approach radius works correctly
        {REMOVE_IMAGE 51 12}
        {PLACE_IMAGE bigmap/poi-battle.png 52 12}
        [event]
            name=enter hex
            first_time_only=no
            {FILTER id,x,y=Konrad,52,12}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s29 id=$unit.id}
        [/event]
    )
    (INCOMPLETE_APPROACHED=
        #------------------------
        # KNALGANS ARE SUSPICIOUS
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_s29_dwarves_suspicious equals yes} {THEN(
            [message]
                speaker=Geldar
                message=_"What now, human? I already told ye, no-one gets in without someone to vouch for ’em."
            [/message]
        )} {ELSE(
            [message]
                speaker=Geldar
                message=_"Another attack! Up axes, and make ready to repel the invaders!"
            [/message]
            [message]
                speaker=Konrad
                message=_"Peace, dwarves of Knalga! I am a man of Wesnoth, not an orc or a troll, and I come as a friend."
            [/message]
            [message]
                speaker=Geldar
                message=_"A man? Haven’t seen many o’ yer kind since our friends at the Doors fell, an’ you ain’t one o’ their’s. Who says we should trust ye?"
            [/message]
        )} {/IF}

        #------------------------
        # VOUCH FOR KONRAD
        #------------------------
        # Ulfdain
        {IF} {HAVE_UNIT id,side,search_recall_list=Ulfdain,1,yes} {THEN(
            {MOVE_UNDER_KONRAD(
                {RECALL_XY Ulfdain $stored_konrad.x $stored_konrad.y}
                {MOVE_UNIT id=Ulfdain "$($stored_konrad.x-1)" $stored_konrad.y}
                {MODIFY_UNIT id=Ulfdain facing se}
            )}
            [message]
                speaker=Ulfdain
                message=_"Let us in, ye chicken-hearted cad! Cannae a dwarf return to ’is home without bein’ set upon like some horde o’ trolls?"
            [/message]
            [message]
                speaker=Geldar
                message=_"I dunno..."
            [/message]
            {IF} {HAVE_UNIT id,type=Ulfdain,"Dwarvish Bloodaxe"} {THEN(
                [message]
                    speaker=Relgorn
                    message=_"Ulfdain!? I ain’t seen you in years, not since you left fer Wesnoth— an’ yer a Bloodaxe now too!? Get across th’ bridge then, quickly-now, afore th’ orcs find ye."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Relgorn
                    message=_"Ulfdain!? I ain’t seen you in years, not since you left fer Wesnoth! Get across th’ bridge then, quickly-now, afore th’ orcs find ye."
                [/message]
            )} {/IF}
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Ulfdain $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Ulfdain} )}
            {CLEAR_VARIABLE bm_s29_dwarves_suspicious}
        )}

        # Uncle Somf
        {ELSEIF} {HAVE_UNIT id,side,search_recall_list=Somf,1,yes} {THEN(
            {MOVE_UNDER_KONRAD(
                {RECALL_XY Somf $stored_konrad.x $stored_konrad.y}
                {MOVE_UNIT id=Somf "$($stored_konrad.x-1)" $stored_konrad.y}
                {MODIFY_UNIT id=Somf facing se}
            )}
            [message]
                speaker=Somf
                message=_"I’m from the Doors, your old human allies! And I’m free now, thanks to this boy Konrad and his army! They’re good people, and I’ll vouch for ’em."
            [/message]
            [message]
                speaker=Geldar
                message=_"I dunno..."
            [/message]
            [message]
                speaker=Relgorn
                message=_"Ah, let ’em in, Geldar. They ain’t orcs, trolls, or undead, an’ that’s good enough for now."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Somf $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Somf} )}
            {CLEAR_VARIABLE bm_s29_dwarves_suspicious}
        )}{/ELSEIF}

        # Dwarven Doors peasant
        {ELSEIF} {VARIABLE_CONDITIONAL status_s26 equals completed} {THEN(
            {MOVE_UNDER_KONRAD(
                {GENERIC_UNIT 1 Peasant $stored_konrad.x $stored_konrad.y} {ROLE doors_vouch_peasant}
                {MOVE_UNIT role=doors_vouch_peasant "$($stored_konrad.x-1)" $stored_konrad.y}
                {MODIFY_UNIT role=doors_vouch_peasant facing se}
            )}
            [message]
                role=doors_vouch_peasant
                message=_"I’m from the Doors, your old human allies! And I’m free now, thanks to this boy Konrad and his army! They’re good people, and I’ll vouch for ’em."
            [/message]
            [message]
                speaker=Geldar
                message=_"I dunno..."
            [/message]
            [message]
                speaker=Relgorn
                message=_"Ah, let ’em in, Geldar. They ain’t orcs, trolls, or undead, an’ that’s good enough for me."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=doors_vouch_peasant $stored_konrad.x $stored_konrad.y} {KILL role=doors_vouch_peasant} )}
            {CLEAR_VARIABLE bm_s29_dwarves_suspicious}
        )}{/ELSEIF}

        # generic dwarf
        {ELSEIF} {HAVE_UNIT race,side,search_recall_list=dwarf,1,yes} {THEN(
            {MOVE_UNDER_KONRAD(
                [recall]
                    race=dwarf
                    side=1
                    x,y=$stored_konrad.x,$stored_konrad.y
                [/recall]
                {MODIFY_UNIT x,y=$stored_konrad.x,$stored_konrad.y role doors_vouch_dwarf}
                {MOVE_UNIT role=doors_vouch_dwarf "$($stored_konrad.x-1)" $stored_konrad.y}
                {MODIFY_UNIT role=doors_vouch_dwarf facing se}
            )}
            [message]
                role=doors_vouch_peasant
                message=_"Ah’m a dwarf, gatekeeper, an’ I’ll vouch for them. Lower yer axes an’ let us in, ye hear?"
            [/message]
            [message]
                speaker=Geldar
                message=_"I dunno..."
            [/message]
            [message]
                speaker=Relgorn
                message=_"Ah, let ’em in, Geldar. They ain’t orcs, trolls, or undead, an’ that’s good enough for me."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=doors_vouch_dwarf $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST role=doors_vouch_dwarf} )}
            {CLEAR_VARIABLE bm_s29_dwarves_suspicious}
        )}{/ELSEIF}

        # nobody to vouch for Konrad
        {ELSE(
            {IF} {VARIABLE_CONDITIONAL bm_s29_dwarves_suspicious equals yes} {THEN(
                # say nothing; we already spoke about this
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message=_"I am Konrad, nephew of Garard, son of Arand and heir to the throne of Wesnoth! I give my word — you can trust me, dwarf."
                [/message]
                [message]
                    speaker=Geldar
                    message=_"Hmph. So you say. We’ve had pretenders workin’ for th’ orcs try an’ sneak in here before. Even if you really are a prince, you ain’t gettin’ ’cross the east bridge lest ye’ve got someone to vouch for ye."
                [/message]
            )} {/IF}
            {MOVE_UNIT id=Konrad $previous_x $previous_y}
            {VARIABLE bm_s29_dwarves_suspicious yes}
            {CLEAR_VARIABLE approached_s29}
        )} {/IF}

        #------------------------
        # EXPLAINING THE SCENARIO
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_s29_dwarves_suspicious not_equals yes} {THEN(
            {MOVE_UNIT id=Konrad 52 12}
            [message]
                speaker=Relgorn
                message=_"What brings you to th’ East Gate o’ Knalga, friends? You be wantin’ somethin’ from us, don’t you?"
            [/message]
            [message]
                speaker=Konrad
                message=_"Well, to be honest, people usually want something from <i><b>me</b></i> instead. I help with a problem someone is having, and then they send some spare fighters to join my army. Can you and I arrange anything like that?"
            [/message]
            [message]
                speaker=Geldar
                message=_"Spare fighters? I ain’t heard a jest that good since th’ trolls got Durrasil! Yer walkin’ through the corpse o’ our empire, fallen to rot an’ ruin, an’ ye got the gall to ask if we have extra axe-arms to send out with ye?"
            [/message]
            [message]
                speaker=Relgorn
                message=_"I’m afraid Geldar’s right. But problems — now problems we’ve got plenty of. Orc attacks, troll attacks, undead attacks. ’an now down in th’ mines—"
            [/message]
            [message]
                speaker=Geldar
                message=_"Relgorn, hush. That ain’t somethin’ fer outsiders to hear about."
            [/message]
            [message]
                speaker=Relgorn
                message=_"Do ye got a better idea? We already tried t’ split ourselves up an’ help, an’ tha’s when trolls took the gatehouse!"
            [/message]
            {DELAY 250}
            [message]
                speaker=Relgorn
                message=_"Listen, human... I’m only trustin’ you ’cause you been vouched for, unnerstand? All ye need to know is that some o’ our people’re trapped in a cave-in down in th’ old mines. You get ’em out, we’ll make it worth yer while."
            [/message]
            {VARIABLE skip_moveto_dialogue yes}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s29 id=$unit.id}
            {CLEAR_VARIABLE skip_moveto_dialogue}
        )} {/IF}
    )
    (INCOMPLETE_MOVETO=
        {IF} {VARIABLE_CONDITIONAL skip_moveto_dialogue not_equals yes} {THEN(
            [message]
                speaker=Relgorn
                message=_"Some o’ our people’re trapped in a cave-in down in th’ old mines. Tha’s all ye need to know. You get ’em out, an’ we’ll make it worth yer while."
            [/message]
        )} {/IF}
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {S29_PRESTART}
    )
    (JUSTCOMPLETED_START=
        {TELEPORT_UNIT id=Konrad 52 12} # this also fires the moveto
        {FIRE_EVENT check_for_knalgan_resurgence}
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Ragaril
            message=_"Thank ye again, Konrad. May ye have better luck saving your home than we’ve had for ours."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                  KNALGAN RESURGENCE
#######################################################################################################################################################
#define RESURGENCE_UNITS WML
    {GENERIC_UNIT 5 "Dwarvish Fighter"      40 11} {FACING se} {WML}
    {GENERIC_UNIT 5 "Dwarvish Fighter"      42 12} {FACING sw} {WML}
    {GENERIC_UNIT 5 "Dwarvish Thunderguard" 47 13} {FACING nw} {WML}
    {GENERIC_UNIT 5 "Dwarvish Guardsman"    48 15} {FACING sw} {WML}
    {GENERIC_UNIT 5 "Dwarvish Fighter"      45 15} {FACING se} {WML}
#enddef
#############################
# TRIGGER RESURGENCE
#############################
[event]
    name=check_for_knalgan_resurgence
    [filter_condition]
        {VARIABLE_CONDITIONAL status_s26 equals completed}
        {VARIABLE_CONDITIONAL status_s28 equals completed}
        {VARIABLE_CONDITIONAL status_s29 equals completed}
        {VARIABLE_CONDITIONAL bm_s26_total_victory   equals yes}
        {VARIABLE_CONDITIONAL bm_s29_refused_payment equals yes}
        {VARIABLE_CONDITIONAL bm_knalgans_resurged not_equals yes}
    [/filter_condition]

    {STORE_UNIT_VAR id=Relgorn x relgornX}
    {STORE_UNIT_VAR id=Relgorn y relgornY}
    {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=Relgorn $coordX $coordY})}
    [message]
        speaker=Relgorn
        message=_"What’s this? Konrad, ye’ve chased the orcs out o’ the Doors, wiped out th’ trolls an’ undead squattin’ in our halls, and e’en trustworthily helped us in the heart o’ Knalga itself."
    [/message]
    [message]
        speaker=Relgorn
        message=_"I know that the trolls’ll return. I know that the orcs’ll return, an’ that many o’ the Doors-folk are still with ’em, enslaved. But ye’ve given us dwarves more breathin’ room than we’ve had in many a year."
    [/message]
    {RESURGENCE_UNITS {ANIMATE}}
    [message]
        speaker=Relgorn
        message=_"I know ye said ye dinnae want any reward fer helpin’ us, but yer gettin’ one anyway. I’m sendin’ the best lads in Knalga to help you fight that queen o’ yers."
    [/message]
    {NEW_RECRUIT4
        (Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,Dwarvish Ulfserker)
        _"Konrad can now recruit Dwarvish Fighters, Guardsmen, Thunderers, and Ulfserkers!"
        dwarves/fighter.png dwarves/guard.png dwarves/thunderer/thunderer.png dwarves/ulfserker.png
    }
    {MOVE_UNIT id=Relgorn $relgornX $relgornY}
    {CLEAR_VARIABLE relgornX,relgornY}

    {VARIABLE bm_knalgans_resurged yes}
[/event]
#############################
# RESURGENCE PRESTART
#############################
[event]
    name=prestart
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_knalgans_resurged equals yes})}
    {RESURGENCE_UNITS ()}
[/event]

#######################################################################################################################################################
#                                                                      S90 - WHIRLPOOL
#######################################################################################################################################################
{PLACE_POI 2 1 s90
    APPROACH_RADIUS=0

    SCENARIO_FILE=00_The_Great_Continent
    (PREVIEW_WML=
        title="???"
        otherlabel= _"Passing through this whirlpool will warp reality,
letting Konrad play an unlimited number of scenarios
and disabling timed events that force him to move on.

For each extra scenario you play over the normal 
number, Asheviere will gain +$s50_extra_income_per_scenario bonus income
in the final scenario.

Using the whirlpool is probably not balanced, and
will disable all achievements (except for <i>“Asleep
at the Wheel”</i>). Are you sure?"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {REMOVE_IMAGE 2 1} # remove the normal POI image
        {PLACE_IMAGE scenery/whirlpool.png 2 1}
    )
    (INCOMPLETE_APPROACHED=
    )
    (INCOMPLETE_MOVETO=
        {VARIABLE s50_extra_income_per_scenario {ON_DIFFICULTY4 4 8 12 16}}
        [message]
            speaker=Konrad
            message=_"There is a strange whirlpool here, clearly magical in nature... I wonder what would happen if we allowed ourselves to be pulled in?"
        [/message]
    )
    (INCOMPLETE_BEFORE_SCENARIO=
        {VARIABLE bm_milestone_finale_original $bm_milestone_finale}
        {VARIABLE bm_milestone_scepter 99}
        {VARIABLE bm_milestone_finale  99}
        {VARIABLE bm_show_whirlpool_objectives yes}
        {VARIABLE bm_whirlpool_disable_achievements yes}
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {REMOVE_IMAGE 2 1} # remove the normal POI image
    )
    (JUSTCOMPLETED_START=
        # Konrad reappears on land, not as a boat
        [message]
            speaker=Konrad
            message=_"Oh... my head! What just happened?"
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"There is nothing here of note. Was there ever?"
        [/message]
    )
}


#undef S24_NOT_COMPLETED_PRESTART
#undef TRAINING_MONTAGE
#undef ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA
#undef S26_PRESTART
#undef S29_PRESTART
#undef RESURGENCE_UNITS
#wmlindent: stop ignoring
