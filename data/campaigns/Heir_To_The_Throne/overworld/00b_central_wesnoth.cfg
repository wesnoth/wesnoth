#textdomain wesnoth-h2tt
#wmlindent: start ignoring

#######################################################################################################################################################
#                                                                  S13 - FORT TAHN
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 36 57 _"Fort Tahn" }
    {BRAZIER_DYNAMIC_OVERWORLD 35 55}
[/event]
{PLACE_POI 36 55 s13
    SCENARIO_FILE=13_Fort_Tahn
    (PREVIEW_WML=
        title=_"Fort Tahn"
        difficulty=1
        gold=2
        otherlabel=_"Weapon for Konrad: <span color='#EFBF04'><b>+3 strikes, <i>slows</i> and <i>arcane</i> specials on bow attacks</b></span>"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        [capture_village]
            side=6
            x,y=30-55,50-99
        [/capture_village]
        # block off access to Merle until this scenario is completed
        {GENERIC_UNIT 6 "Master Bowman" 36 57} {FACING ne} {LEADER} {ROLE fort_tahn_leader1}
        {GENERIC_UNIT 6 "Bowman"        35 57} {FACING ne}
        {GENERIC_UNIT 6 "Bowman"        34 55} {FACING se}
        {GENERIC_UNIT 6 "Javelineer"    38 56} {FACING sw} {LEADER} {ROLE fort_tahn_leader2}
        {GENERIC_UNIT 6 "Peasant"       37 56} {FACING sw}
        {GENERIC_UNIT 6 "Spearman"      38 55} {FACING ne}
    )
    (INCOMPLETE_APPROACHED=
        [message]
            role=fort_tahn_leader1
            message= _ "Incredible craftsmanship! Just incredible! I’ve never seen a bow like this before in my life! From the Aethenwood, you say?"
        [/message]
        [message]
            role=fort_tahn_leader2
            message= _ "Pulled it out of one of their halls as we was burning it down. When you’ve done testing it, we’re excited to get it back home to Westin along with the rest of our loot."
        [/message]
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message= _ "This archer is holding an Aethenwood Moonbow! It’s a travesty for such a treasure to be even touched by one of Asheviere’s villains, much less pillaged from the ruins of my home! We have to get it back!"
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {MODIFY_TERRAIN Ch^Dr 35 57}
        {MODIFY_TERRAIN Rp^Dr 36 57}
        {MODIFY_TERRAIN Rp^Dr 37 56}
        [multihex_image]
            image="units/human-loyalists/lieutenant-die-9.png~RC(magenta>wesred)"
            x,y=37,56
        [/multihex_image]
        {PLACE_IMAGE_SUBMERGED "units/human-peasants/peasant-die10.png~RC(magenta>wesred)" 35 58}
    )
    (JUSTCOMPLETED_START=
        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message= _ "Good work, everyone! We have reclaimed a powerful heirloom of the elves, and with the sacking of Fort Tahn we are one step closer to our eventual victory over Asheviere."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message= _ "Fort Tahn will rebuild in time, but by driving off the garrison we have dealt a small, yet meaningful blow against Asheviere."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                    DULATUS HILLS
#######################################################################################################################################################
#############################
# CREATE MERLE
#############################
[event]
    name=prestart
    {SET_LABEL 51 52 _"Dulatus Hills" }

    # if we haven't recruited Merle, create him
    {IF} {VARIABLE_CONDITIONAL bm_merle_recruited not_equals yes} {THEN(
        {NAMED_NOTRAIT_UNIT 4 Ruffian 50 55 Merle _"Merle"} {FACING sw}
        {ADD_MODIFICATION( {TRAIT_STRONG} {TRAIT_RESILIENT} )}

        # if status_31 is completed, Merle moves eastwards
        {IF} {VARIABLE_CONDITIONAL status_s31 equals completed} {THEN(
            {TELEPORT_UNIT id=Merle 68 41}
            {MODIFY_UNIT id=Merle facing nw}
            {GENERIC_UNIT 4 Peasant 69 42} {FACING se} 
        )} {/IF}
    )} {/IF}
[/event]

#############################
# KONRAD APPROACHES
#############################
[event]
    name=moveto
    first_time_only=no
    {FILTER( id=Konrad {FILTER_LOCATION( radius=2 {FILTER id=Merle} )})}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_merle_recruited not_equals yes})}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_merle_ignored   not_equals yes})}

    [cancel_action]
    [/cancel_action]
    #------------------------
    # BEFORE S31
    #------------------------
    {IF} {VARIABLE_CONDITIONAL status_s31 not_equals completed} {THEN(
        # first time meeting Merle
        {IF} {VARIABLE_CONDITIONAL bm_merle_recruited not_equals visited} {THEN(
            [message]
                speaker=Merle
                message=_"Hullo, stranger. What brings you to these forsaken parts?"
            [/message]
            [message]
                speaker=Konrad
                message=_"I am Konrad, son of Arand and heir to Garard’s throne! I’m on a quest to depose the evil queen Asheviere!"
            [/message]
            [message]
                speaker=Merle
                message=_"Here in the Dulatus, we don’ want no queen. Don’ much want no prince or king neither, though."
            [/message]
            [message]
                speaker=Merle
                message=_"Once, these hills was rich with gold, an’ granite. King Garard took most o’ it to pay fer his wars, an’ his bride Asheviere took the rest. Now we’ve got nothin’ but empty mines an’ dusty vaults."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"I’m sorry for your misfortunes, friend. Perhaps we can work together for the benefit of us both."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"You have the facilities to store things of value, and we sometimes have more gold and supplies than we wish to carry with us on our march. If you store and guard our excess gold for us now, once I overthrow Asheviere and assume the throne I will be happy to help revitalize the Dulatus."
            [/message]
            [message]
                speaker=Merle
                message=_"Hmm... I suppose we’ve got nothin’ else to do. You’re not worried we’re gonna steal it, or sell ye out to the queen?"
            [/message]
            [message]
                speaker=Konrad
                message=_"You yourself said that you have no love for Asheviere. I am no fool ready to squander my earnings, but I would rather take a risk and make a friend than live my life in distrust."
            [/message]
            [message]
                speaker=Merle
                message=_"Alright, kid. It’s a deal. We’ll hang onto your extra gold, free of charge."
            [/message]
            {VARIABLE bm_merle_stored_gold 0}
            {VARIABLE bm_merle_recruited visited}
        )}
        # not the first time we've met Merle
        {ELSE(
            [message]
                speaker=Merle
                message=_"Welcome back, prince. What business have you here?"
            [/message]
        )} {/IF}
    )}
    #------------------------
    # AFTER S31
    #------------------------
    {ELSE(
        # first time meeting Merle. Banking isn't available unless we met him earlier
        {IF} {VARIABLE_CONDITIONAL bm_merle_recruited not_equals visited} {THEN(
            [message]
                speaker=Merle
                message=_"So you’s that prince everyone’s so excited about, on his way to fight Asheviere. I don’ want no queen. Don’ much want no prince or king neither, though."
            [/message]
            {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar "$($stored_konrad.x-1)" $stored_konrad.y} )}
            [message]
                speaker=Lisar
                message=_"Konrad, we don’t have time to stop and chat with villagers; especially not ones who scoff at the very idea of royalty. Let’s keep moving."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar} )}
            {VARIABLE bm_merle_ignored yes}
            {VARIABLE exit_loop yes}
        )}
        # first time seeing Merle in the east
        {ELSEIF} {VARIABLE_CONDITIONAL bm_merle_met_in_east not_equals yes} {THEN(
            [message]
                speaker=Merle
                message=_"Hullo again, Konrad! I thought you might have trouble getting back to our old hole in the Dulatus, so me an’ some of the boys set up shop here instead."
            [/message]
            {VARIABLE bm_merle_met_in_east yes}
        )} {/ELSEIF}
        # not the first time we've met Merle
        {ELSE(
            [message]
                speaker=Merle
                message=_"Welcome back, prince. Soon I might be calling you “king.”"
            [/message]
        )} {/IF}
        {VARIABLE bm_merle_east_spoken_to yes}
    )} {/IF}

    #------------------------
    # DEPOSIT OR WITHDRAW GOLD
    #------------------------
    [while]
        {VARIABLE_CONDITIONAL exit_loop not_equals yes}
        [do]
            [store_gold]
                side=1
            [/store_gold]
            [message]
                speaker=Konrad
                #po: $bm_merle_stored_gold may be between 0 and 100. $gold may be between 0 and infinity
                message=_"I have $bm_merle_stored_gold gold stored with Merle, and $gold gold in my coffers."
                #------------------------
                # DEPOSIT GOLD
                #------------------------
                [option]
                    message=_"Deposit 10 gold"
                    [show_if]
                        {VARIABLE_CONDITIONAL gold greater_than_equal_to 10}
                    [/show_if]
                    [command]
                        {IF} {VARIABLE_CONDITIONAL bm_merle_stored_gold less_than 100} {THEN(
                            [gold]
                                side=1
                                amount=-10
                            [/gold]
                            {VARIABLE_OP bm_merle_stored_gold add 10}
                            {SOUND gold.ogg}
                        )}
                        #------------------------
                        # MAX GOLD
                        #------------------------
                        {ELSE(
                            [message]
                                speaker=Merle
                                message=_"More than one hundred gold? I ain’t comfortable holdin’ onto all that for you, Konrad. I ain’t gonna steal it, but some o’ the boys aren’t so honest as me, an’ these days there’s bandits in th’ countryside too. You carry around the rest o’ yer coin yerself, alright?"
                            [/message]
                            [message]
                                speaker=Merle
                                message=_"Or, if ye really want, I thinks you’ve got enough money here to hire our whole village into yer army. If that’s the way ye wanted to go, I think most of us’d be willing."
                            [/message]
                            [message]
                                speaker=Konrad
                                [option]
                                    message=_"Hire Merle’s village (lose all stored gold, learn to recruit Ruffians)"
                                    [command]
                                        [message]
                                            speaker=Merle
                                            message=_"Alright, then, we’re with you. Whether this works out for us or not, at least it’s better than sittin’ around this old town waiting to rot."
                                        [/message]
                                        {CLEAR_VARIABLE bm_merle_stored_gold}
                                        {NEW_RECRUIT1 (Ruffian) _"Konrad can now recruit Ruffians!" human-peasants/ruffian.png}
                                        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Merle $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Merle} )}
                                        {VARIABLE bm_merle_recruited yes}
                                        {VARIABLE exit_loop yes}
                                    [/command]
                                [/option]
                                [option]
                                    message=_"Leave"
                                    [command]
                                        {VARIABLE exit_loop yes}
                                    [/command]
                                [/option]
                            [/message]
                        )} {/IF}
                    [/command]
                [/option]
                #------------------------
                # WITHDRAW GOLD
                #------------------------
                [option]
                    message=_"Withdraw 10 gold"
                    [show_if]
                        {VARIABLE_CONDITIONAL bm_merle_stored_gold greater_than_equal_to 10}
                    [/show_if]
                    [command]
                        [gold]
                            side=1
                            amount=10
                        [/gold]
                        {VARIABLE_OP bm_merle_stored_gold sub 10}
                        {SOUND net.wav}
                    [/command]
                [/option]
                [option]
                    message=_"Leave"
                    [command]
                        {VARIABLE exit_loop yes}
                    [/command]
                [/option]
            [/message]
        [/do]
    [/while]
    {CLEAR_VARIABLE gold,exit_loop}
[/event]    

#######################################################################################################################################################
#                                                                   S14 - GRYPHON MOUNTAIN
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 44 31 _"Gryphon Mountain"}
[/event]
{PLACE_POI 45 33 s14
    SCENARIO_FILE=14_Gryphon_Mountain
    (PREVIEW_WML=
        title=_"Gryphon Mountain"
        difficulty=1
        gold=1
        recruit1=units/dwarves/gryphon-rider.png
        recruit2=units/dwarves/scout.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {PLACE_IMAGE scenery/nest-empty.png 44 32}
        {GENERIC_UNIT 13 Gryphon  44 32} {FACING se} {LEADER}
        {GENERIC_UNIT 13 Gryphlet 45 32} {FACING se}
        {GENERIC_UNIT 13 Gryphlet 43 31} {FACING sw}
        {GENERIC_UNIT 13 Gryphlet 42 32} {FACING sw}
    )
    (INCOMPLETE_APPROACHED=
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message= _ "I’ve heard stories about the fabled Gryphon Mountain! I would much like a chance to gaze upon the majestic creatures."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {PLACE_IMAGE scenery/nest-empty.png 44 32}
        {IF} {VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes} {THEN(
            {GENERIC_UNIT 13 Gryphon  44 32} {FACING se} {LEADER}
            {GENERIC_UNIT 13 Gryphlet 43 32} {FACING sw}
            {GENERIC_UNIT 13 Gryphlet 45 31} {FACING se}
        )} {/IF}
    )
    (JUSTCOMPLETED_START=
        #------------------------
        # FOUGHT BURLIN
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_s14_fought_burlin equals yes} {THEN(
            {FIRE_EVENT_UNIT moveto id=Konrad}
        )}
        #------------------------
        # ALLIED WITH BURLIN
        #------------------------
        {ELSE(
            {NAMED_UNIT 2 "Dwarvish Pathfinder" 46 32 Burlin _"Burlin" ()} {ANIMATE} {LEADER} {FACING sw}
            [message]
                speaker=Burlin
                message= _ "Ah’m glad we could work together on this, kid. You collected the eggs, an’ now I’ll collect my profits!"
            [/message]
            {MOVE_UNIT id=Burlin 50 37} {KILL id=Burlin}
            [message]
                speaker=Konrad
                message= _ "Asheviere’s gold has blinded so many people. It’s how she controls the nobles, the army, the orcs... and it’s why peasants starve to death, their harvest all taken for taxes."
            [/message]
            [message]
                speaker=Konrad
                message= _ "That’s why we have to fight her. Not for my sake, but for the sake of all the peoples suffering under the dark queen’s lash."
            [/message]
        )} {/IF}
    )
    (COMPLETED_MOVETO=
        #------------------------
        # FOUGHT BURLIN
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_s14_fought_burlin equals yes} {THEN(
            {IF} {VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes} {THEN(
                [message]
                    speaker=Konrad
                    message= _ "Gryphon Mountain is at peace once again. I’m glad to see that the matriarch survived, and that her flock is recovering from the fighting..."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message= _ "Gryphon Mountain is at peace once again. If only our fighting hadn’t killed the matriarch and driven away her flock..."
                [/message]
            )} {/IF}
        )}
        #------------------------
        # ALLIED WITH BURLIN
        #------------------------
        {ELSE([message]
            speaker=Konrad
            message= _ "Gryphon Mountain stands silent and empty. We got what we needed."
        [/message])} {/IF}
    )
}

#######################################################################################################################################################
#                                                                   S15a - VALLEY OF DEATH, PART 1
#######################################################################################################################################################
[event]
    name=prestart
    {IF} {VARIABLE_CONDITIONAL status_s30 not_equals completed} {THEN(
        {ADD_MULTIHEX_WIND x,y=36-47,29-36 "~FL()"} # only before the sceptre, to save on CPU
    )} {/IF}
[/event]
{PLACE_POI 36 36 s15a
    SCENARIO_FILE=15a_Valley_of_Death_part1
    (PREVIEW_WML=
        title=_"Valley of Death"
        difficulty=1
        gold=1
        recruit1=units/human-loyalists/heavyinfantry.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {NAMED_UNIT   3 "Shock Trooper"     36 35 Kaelor _"Brother Kaelor" (canrecruit=yes)} {FACING se} {HITPOINTS 59} {TEAM_COLOR_OVERRIDE x,y=36,35 white}
        {GENERIC_UNIT 3 "Heavy Infantryman" 35 35                                          } {FACING sw} {HITPOINTS 27} {TEAM_COLOR_OVERRIDE x,y=35,35 white}

        {GENERIC_UNIT 8 "Deathblade"      37 35} {FACING sw} {LEADER} {HITPOINTS 36}
        {GENERIC_UNIT 8 "Revenant"        35 37} {FACING ne} {LEADER}
        {GENERIC_UNIT 8 "Skeleton"        38 35} {FACING sw}
        {GENERIC_UNIT 8 "Skeleton Archer" 37 36} {FACING sw} {HITPOINTS 5}
        {GENERIC_UNIT 8 "Skeleton"        36 37} {FACING se}
        {GENERIC_UNIT 8 "Skeleton"        33 37} {FACING ne}
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Kaelor
            message= _ "Press forward, brothers! We must vanquish these abominations and summon aid for our brethren, lest they fall to the darkness below!"
        [/message]
        {IF} {HAVE_UNIT id,side,search_recall_list=Moremirmu,1,yes} {THEN(
            {MOVE_UNDER_KONRAD( {RECALL_XY Moremirmu $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Moremirmu "$($stored_konrad.x+1)" $stored_konrad.y} )}
            {MODIFY_UNIT id=Konrad facing ne}
            {MODIFY_UNIT id=Moremirmu facing sw}
            [message]
                speaker=Moremirmu
                message= _ "Lo! Konrad, a fellow brother of the order stands in need! Shall we answer the call?"
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Moremirmu $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Moremirmu} )}
        )} {/IF}
    )
    (INCOMPLETE_MOVETO=
        {IF} {VARIABLE_CONDITIONAL previous_x less_than_equal_to 35} {THEN( {VARIABLE s15a_from_west yes} )}{/IF} # determine where Konrad spawns on the map
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
    )
    (JUSTCOMPLETED_START=
        {CLEAR_VARIABLE s15a_from_west}
        {IF} {HAVE_UNIT id,search_recall_list=Kaelor,yes} {THEN(
            {MOVE_UNDER_KONRAD( {RECALL_XY Kaelor "$($stored_konrad.x+1)" $stored_konrad.y} )}
            {MODIFY_UNIT id=Konrad facing ne}
            {MODIFY_UNIT id=Kaelor facing sw}
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kaelor $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kaelor} )}
        )} {/IF}
        {VARIABLE approached_s15b no} # the s15b event is different now, so let it trigger again
    )
    (COMPLETED_MOVETO=
    )
}

#######################################################################################################################################################
#                                                                   S15b - VALLEY OF DEATH, PART 2
#######################################################################################################################################################
{PLACE_POI 39 30 s15b
    SCENARIO_FILE=15b_Valley_of_Death_part2
    (PREVIEW_WML=
        title=_"Valley of Death II"
        difficulty=2
        gold=0
        recruit1=units/mage-to-whitemage.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {NAMED_UNIT   3 "White Mage" 40 30 Myrilell  _"Sister Myrilell"   (gender=female)} {FACING sw} {TEAM_COLOR_OVERRIDE x,y=40,30 white}
        {NAMED_UNIT   3 "Mage"       39 31 Gwatharry _"Gwatharry"                      ()} {FACING se} {TEAM_COLOR_OVERRIDE x,y=39,31 white}

        {IF} {VARIABLE_CONDITIONAL status_s15a not_equals completed} {THEN(
            {GENERIC_UNIT 3 "White Mage" 39 29} {FACING nw} {GENDER female} {TEAM_COLOR_OVERRIDE x,y=39,29 white}
            {GENERIC_UNIT 8 "Chocobone"       41 30} {FACING sw} # need these guys to block off the path from the Ford of Abez. We don't want players to easily reach Part II before Part I (only via the Carcyn port)
            {GENERIC_UNIT 8 "Skeleton"        40 28} {FACING sw} # (and we need to keep the Ford of Abez path, or else the player might get trapped if he completes Part II before Part I while the Sceptre triggers
            {GENERIC_UNIT 8 "Walking Corpse"  37 31} {FACING ne}
        )} {ELSE(
            {MODIFY_UNIT id=Gwatharry hitpoints 11}
            {GENERIC_UNIT 8 "Lich"            40 28} {FACING sw} {LEADER}
            {GENERIC_UNIT 8 "Skeleton Archer" 39 29} {FACING se}
            {GENERIC_UNIT 8 "Skeleton"        40 29} {FACING sw} {HITPOINTS 3}
            {GENERIC_UNIT 8 "Chocobone"       41 29} {FACING sw}
            {GENERIC_UNIT 8 "Skeleton Archer" 42 30} {FACING sw}
            {GENERIC_UNIT 8 "Lich"            38 31} {FACING ne} {LEADER}
            {GENERIC_UNIT 8 "Skeleton"        38 30} {FACING se} {HITPOINTS 11}
            {GENERIC_UNIT 8 "Chocobone"       40 31} {FACING nw} {HITPOINTS 28}
            {GENERIC_UNIT 8 "Walking Corpse"  36 30} {FACING se}
            {GENERIC_UNIT 8 "Walking Corpse"  37 33} {FACING se}
        )} {/IF}
    )
    (INCOMPLETE_APPROACHED=
        {IF} {VARIABLE_CONDITIONAL status_s15a not_equals completed} {THEN(
            [message]
                speaker=Myrilell
                message= _ "Fear not, Gwatharry, for Brother Kaelor has gone south to fetch help. May the light speed him on his journey."
            [/message]
            [message]
                speaker=Gwatharry
                message= _ "And may he return soon. The sacred seal continues to weaken, and undead are starting to slip through..."
            [/message]
        )} {ELSE(
            [message]
                speaker=Gwatharry
                message= _ "The seal is broken! The texts are burned! Yea, the very Light itself has forsaken us..."
            [/message]
            [message]
                speaker=Myrilell
                message= _ "Doubt not, brother, for our faith is our shield. The warriors have gone for aid, and aid shall soon come."
            [/message]
        )} {/IF}
    )
    (INCOMPLETE_MOVETO=
        {IF} {HAVE_UNIT id,side,search_recall_list=Moremirmu,1,yes} {THEN(
            [message]
                speaker=Myrilell
                message= _ "Strangers... and do I see Brother Moremirmu among their number? Your are sorely needed, Brother!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Myrilell
                message= _ "Are you the help we have been waiting for, stranger? Your aid would be most welcome."
            [/message]
        )} {/IF}
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {NAMED_UNIT   3 "White Mage" 40 30 Myrilell _"Sister Myrilell" (gender=female)} {FACING nw} {TEAM_COLOR_OVERRIDE x,y=40,30 white}
        {GENERIC_UNIT 3 "White Mage" 37 31} {TEAM_COLOR_OVERRIDE x,y=37,31 white} {FACING ne} 
        {GENERIC_UNIT 3 "Mage"       39 31} {TEAM_COLOR_OVERRIDE x,y=39,31 white} {FACING se} {GENDER female}
        {GENERIC_UNIT 3 "Mage"       38 29} {TEAM_COLOR_OVERRIDE x,y=38,29 white} {FACING se} {GENDER female}
    )
    (JUSTCOMPLETED_START=
        {FIRE_EVENT_UNIT moveto id=Konrad}
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Myrilell
            message= _ "Our home — and all the living of Irdya — are safe thanks to you, righteous prince. May the Lords of Light shine their blessings down upon you as you journey forth on your quest of inheritance."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                      THE GREY WOODS
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 27 33 _"Grey Wood"}
[/event]
[event]
    name=prestart
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_rogue_mages_recruited not_equals yes})}
    {NAMED_UNIT 8 "Shadow Mage" 30 33 Mya _"Mya" ()} {FACING se} {GENDER female}
[/event]
#############################
# KONRAD APPROACHES
#############################
[event]
    name=moveto
    first_time_only=no
    {FILTER( id=Konrad {FILTER_LOCATION x,y,radius=30,33,2 })}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_rogue_mages_recruited not_equals yes})}

    #------------------------
    # ALREADY NEGOTIATING
    #------------------------
    # if we're already negotiating with the rogue mages, skip all the dialogue
    {IF} {VARIABLE_CONDITIONAL bm_rogue_mages_recruited equals negotiating} {THEN(
        {FIRE_EVENT grey_woods_purchase_choice}
    )} 
    {ELSE(
        #------------------------
        # INITIAL IMPRESSIONS
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_rogue_mages_recruited not_equals visited} {THEN(
            [message]
                speaker=Konrad
                message=_"There is a cloaked figure watching me from the edge of the Grey Woods... Hello! Who’s there?"
            [/message]
        )} {/IF}

        #------------------------
        # MYA RUNS AWAY
        #------------------------
        {IF} {NOT({HAVE_UNIT id,side,search_recall_list=Harper,1,yes})} {THEN(
            {MOVE_UNIT id=Mya 27 34}
            {KILL id=Mya}

            # if this is the first time we've seen Mya run away, Konrad explains why he can't chase her.
            {IF} {VARIABLE_CONDITIONAL bm_rogue_mages_recruited not_equals visited} {THEN(
                [message]
                    speaker=Konrad
                    message=_"She’s fled! I’ve no hope of tracking anyone through such an overgrown forest."
                [/message]
            )} {/IF}

            # if we've completed Isle of the Damned I, outlaws recognize Shadow Mages and explain them to Konrad
            [if]
                {VARIABLE_CONDITIONAL status_s08a equals completed}
                {VARIABLE_CONDITIONAL bm_rogue_mages_explained not_equals yes}
                [then]
                    {MOVE_UNDER_KONRAD(
                        {GENERIC_UNIT 1 Footpad $stored_konrad.x $stored_konrad.y} {GENDER male} {ROLE grey_woods_explainer}
                        {MOVE_UNIT role=grey_woods_explainer "$($stored_konrad.x+1)" $stored_konrad.y}
                        {MODIFY_UNIT role=grey_woods_explainer facing sw}
                    )}
                    [message]
                        role=grey_woods_explainer
                        message=_"Konrad, that looked like a Shadow Mage! I heard stories about them from Baldras and Harper and some o’ the others. But I never met one. I were too young back then."
                    [/message]
                    {MOVE_UNDER_KONRAD( {MOVE_UNIT role=grey_woods_explainer $stored_konrad.x $stored_konrad.y} {KILL role=grey_woods_explainer} )}
                    {VARIABLE bm_rogue_mages_explained yes}
                [/then]
            [/if]
            {VARIABLE bm_rogue_mages_recruited visited}
        )}

        #------------------------
        # MYA RECOGNIZES HARPER
        #------------------------
        {ELSE(
            {MOVE_UNIT id=Mya 27 34}
            {MOVE_UNDER_KONRAD(
                {RECALL_XY Harper $stored_konrad.x $stored_konrad.y}
                {MOVE_UNIT id=Harper $stored_konrad.x "$($stored_konrad.y+1)"}
                {MODIFY_UNIT id=Harper facing sw}
            )}
            [message]
                speaker=Harper
                message=_"Hey, wait! You’re a Shadow Mage! One o’ Helicrom’s. Wait — it’s me, Harper!"
            [/message]
            [message]
                speaker=Harper
                message={ASIDE _"Konrad, I’ve told you stories about them Shadow Mages. How they helped Baldras an’ me bring down Halstead?"}
            [/message]
            {DELAY 250}
            {MODIFY_UNIT id=Mya facing se}
            {DELAY 250}
            {MOVE_UNIT id=Mya 29 34}
            [message]
                speaker=Mya
                message=_"Little Harper? This is a surprise. You’re marching alongside the prince Konrad?"
            [/message]
            [message]
                speaker=Mya
                message=_"And now you’ve brought him right to our doorstep. Last I remember, you outlaws were helping us destabilize the crown, not fighting to supplant and restore it."
            [/message]
            [message]
                speaker=Harper
                message=_"Hey now, it ain’t as bad as all that. Asheviere is the evil one, not Konrad!"
            [/message]
            [message]
                speaker=Mya
                message=_"Be that as it may, a strong throne is not in the interest of the Grey Woods. I believe Helicrom made that clear when you and he first met."
            [/message]
            [message]
                speaker=Konrad
                message=_"I understand that you want to be left alone, and I mean you no harm. Harper has vouched for me. Perhaps we can make a deal?

Help me overthrow Asheviere now, and once I am king I will ensure that none of the crown’s agents interfere with whatever your business is in the Grey Woods. Provided that business causes nobody any harm."
            [/message]
            [message]
                speaker=Mya
                message=_"I have no interest in collaborating with you. But I admit that some of our younger members care rather less about ideals and more about gold. They might be willing to follow you, if you can pay."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Harper $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Harper} )}
            {VARIABLE bm_rogue_mages_recruited negotiating}
            {FIRE_EVENT grey_woods_purchase_choice}
        )} {/IF}
    )} {/IF}
[/event]
#------------------------
# PURCHASE ROGUE MAGES
#------------------------
[event]
    name=grey_woods_purchase_choice
    first_time_only=no
    
    # choose whether or not to pay
    [message]
        speaker=Konrad
        [option]
            message=_"100 gold: learn to recruit Rogue Mages."
            [command]
            [/command]
        [/option]
        [option]
            message=_"Decline"
            [command]
                [return][/return]
            [/command]
        [/option]
    [/message]

    # not enough gold
    [store_gold]
        side=1
    [/store_gold]
    {IF} {VARIABLE_CONDITIONAL gold less_than 100} {THEN(
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"I would like to agree to your offer, but I don’t have enough gold right now. I’ll return when I can afford to pay."
        [/message]
    )} 

    # enough gold
    {ELSE(
        [gold]
            side=1
            amount=-100
        [/gold]
        {SOUND gold.ogg}
        [message]
            speaker=Konrad
            message=_"I agree to your offer. Thank you for your willingness to work with us — I vow to keep my word."
        [/message]
        {NEW_RECRUIT1 (Rogue Mage) _"Konrad can now recruit Rogue Mages!" rogue-mage/rogue-mage.png}
        {VARIABLE bm_rogue_mages_recruited yes}
    )} {/IF}
    {CLEAR_VARIABLE gold}
[/event]

#######################################################################################################################################################
#                                                                     S17 - CROSSROADS
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 35 43 _"Crossroads"}
[/event]
[event]
    name=prestart
    {IF} {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar']-5)>>)} {THEN( {VARIABLE s17_title _"Crossroads - 5 seasons remaining"} )} {/IF}
    {IF} {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar']-4)>>)} {THEN( {VARIABLE s17_title _"Crossroads - 4 seasons remaining"} )} {/IF}
    {IF} {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar']-3)>>)} {THEN( {VARIABLE s17_title _"Crossroads - 3 seasons remaining"} )} {/IF}
    {IF} {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar']-2)>>)} {THEN( {VARIABLE s17_title _"Crossroads - 2 seasons remaining"} )} {/IF}
    {IF} {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar']-1)>>)} {THEN( {VARIABLE s17_title _"Crossroads - 1 season remaining (last chance!)"} )} {/IF}
    {IF} {LUA(<<return wesnoth.current.turn>=(wml.variables['bm_milestone_elensefar']-0)>>)} 
         {VARIABLE_CONDITIONAL status_s17 not_equals in_progress}
         {VARIABLE_CONDITIONAL status_s17 not_equals completed}
    {THEN(
        {VARIABLE status_s17 failed}
    )} {/IF}
    {PLACE_IMAGE "misc/blank-hex.png~SCALE(72,72)~BLIT(items/mine-entrance.png~SCALE(32,32),16,32)" 34 42}
    {PLACE_IMAGE "misc/blank-hex.png~SCALE(72,72)~BLIT(items/mine-entrance.png~SCALE(32,32),32,0)"  34 42}
    {PLACE_IMAGE "misc/blank-hex.png~SCALE(72,72)~BLIT(items/mine-entrance.png~SCALE(32,32),16,40)" 35 42}
    {IF} {VARIABLE_CONDITIONAL status_s30 not_equals completed} {THEN(
        {ADD_MULTIHEX_WIND x,y=40-50,50-59 ()} # only before the sceptre, to save on CPU
    )} {/IF}
[/event]
{PLACE_POI 35 44 s17
    SCENARIO_FILE=17_Crossroads
    (PREVIEW_WML=
        title=$s17_title
        difficulty=2
        gold=1
        recruit1=units/dwarves/miner.png
        companion1=units/dwarves/ulfserker-laugh-1.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {UNSTORE_NPC Lisar x,y=36,42 side,facing=6,sw}
        {GENERIC_UNIT 6 "Knight"            36 43} {FACING sw}
        {GENERIC_UNIT 6 "Heavy Infantryman" 35 43} {FACING sw}
        {UNSTORE_NPC Ulfdain x,y=34,44 side,facing=5,se}
        {MODIFY_UNIT id=Ulfdain halo items/cage.png}
        {MODIFY_UNIT id=Ulfdain status.slowed yes}
        {MODIFY_TERRAIN Gg^Xo 34 44} # cage blocks travel, so the player is forced to go around. The scenario's starting position varies depending on where the player comes from
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Lisar
            message= _ "Hello, “cousin” — if you really are Konrad and not an imposter. I am Li’sar, princess of Wesnoth and my mother’s most able commander."
        [/message]
        [message]
            speaker=Lisar
            message= _ "I hear you are a man of the people, princeling. Will you rescue these helpless dwarven prisoners before I have them executed?"
        [/message]
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Lisar
            message= _ "Well, Konrad? Will you fight me, or leave my dwarven prisoners to a gruesome fate?"
        [/message]
        {IF} {VARIABLE_CONDITIONAL previous_x less_than_equal_to 34} {THEN( {VARIABLE s17_from_west yes} )}{/IF} # determine where Konrad spawns on the map
    )

    #############################
    # FAILED
    #############################
    (FAILED_MOVETO=
        [message]
            speaker=Konrad
            message= _ "The princess Li’sar used to be here with some prisoners, but they have gone now."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        [multihex_image]
            image="units/human-loyalists/horseman/horseman-se-die5.png~RC(magenta>wesred)~FL()"
            x,y=34,43
        [/multihex_image]
        [multihex_image]
            image="units/human-loyalists/duelist-die8.png~RC(magenta>wesred)~FL()"
            x,y=37,43
        [/multihex_image]
    )
    (JUSTCOMPLETED_START=
        {CLEAR_VARIABLE s17_from_west}
        {IF} {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar'])>>)} {THEN(
            {FIRE_EVENT_UNIT enter_hex id=Konrad}
            # if Elensefar has just fallen, Li'sar left mid-battle - so we can't show her cutscene here
        )}
        {ELSE(
            {UNSTORE_NPC Lisar x,y=36,43 side,hitpoints,facing=6,1,sw}
            [message]
                speaker=Lisar
                message= _ "You may have bested me today Konrad, but this isn’t over."
            [/message]
            {MOVE_UNIT id=Lisar 49 39}
            {MODIFY_UNIT id=Lisar facing sw}
            {FULL_HEAL id=Lisar}
        )} {/IF}
    )
    (COMPLETED_MOVETO=
        {IF} {HAVE_UNIT id,search_recall_list=Ulfdain,yes} {THEN(
            {MOVE_UNDER_KONRAD( {RECALL_XY Ulfdain $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Ulfdain "$($stored_konrad.x+1)" $stored_konrad.y} )}
            {MODIFY_UNIT id=Konrad facing se}
            {MODIFY_UNIT id=Ulfdain facing nw}
            [message]
                speaker=Ulfdain
                message= _ "Thank ye again for freein’ me! If I ever get my hands on that cowardly, sniveling, sissy, waste-o-space princess..."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Ulfdain $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Ulfdain} )}
        )} {/IF}
    )
}

#######################################################################################################################################################
#                                                                            TATH
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 51 35 _"Tath"}
    {GENERIC_UNIT 6 "Spearman"   52 35} {FACING se}
    {GENERIC_UNIT 6 "Swordsman"  51 34} {FACING sw}
    {GENERIC_UNIT 6 "Bowman"     53 39} {FACING se}
    [capture_village]
        side=6
        x,y=51,35
        radius=2
    [/capture_village]
[/event]
[event]
    name=moveto
    {FILTER( id=Konrad {FILTER_LOCATION x,y,radius=52,34,2} )}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL status_s31 not_equals completed})}
    [message]
        speaker=Konrad
        #po: referencing the tunnel used by Bazur and Isolde in Asheviere's Dogs
        message= _ "Delfador says that there was once a tunnel connecting Tath and Dan’Tonk. During the war it was used to great effect against the city defenders."
    [/message]
    [message]
        speaker=Konrad
        message= _ "But even if the tunnel still exists, and has not been deliberately collapsed by Asheviere, it is surely too well-guarded for us to attempt to use it."
    [/message]
[/event]
[event]
    name=moveto
    {FILTER( id=Konrad {FILTER_LOCATION x,y,radius=52,34,3} )}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL status_s31 equals completed})}
    [message]
        speaker=Konrad
        #po: referencing the "discipline" scenario of Asheviere's Dogs
        message= _ "Tath is a fine town, but not strategically significant enough to be worth fighting over. It never fully recovered from the damage it took during Asheviere’s rise to power."
    [/message]
[/event]

#######################################################################################################################################################
#                                                                    S18 - THE HIGHWAYMEN
#######################################################################################################################################################
[event]
    name=prestart
    {CLEAR_VARIABLE bm_lisar_at_dantonk}
    {IF} {VARIABLE_CONDITIONAL status_s17 equals completed}
     {OR({VARIABLE_CONDITIONAL status_s17 equals failed})}
        {THEN( {VARIABLE bm_lisar_at_dantonk yes} )}
    {/IF}
[/event]
#define DANTONK_PRESTART_WML
    {IF} {VARIABLE_CONDITIONAL bm_lisar_at_dantonk equals yes} {THEN(
        {UNSTORE_NPC Lisar x,y=49,39 side,facing=6,sw} # if "Crossroads" has been completed, Li'sar moves to here
    )} {ELSEIF} {VARIABLE_CONDITIONAL status_s02 equals $null} {THEN(
        {GENERIC_UNIT 6 Lieutenant 49 39} {FACING sw} {LEADER} # if "Elves Besieged" is still active, leave Isolde there on the bigmap
    )} {/ELSEIF} {ELSE(
        {UNSTORE_NPC Isolde x,y=49,39 side,facing=6,sw} # by default, Isolde is the leader here
    )} {/IF}

    {GENERIC_UNIT 6 "Spearman"   44 39} {FACING sw}
    {GENERIC_UNIT 6 "Spearman"   46 40} {FACING sw}
    {GENERIC_UNIT 6 "Bowman"     46 38} {FACING sw}
    {GENERIC_UNIT 6 "Spearman"   47 38} {FACING sw}
    {GENERIC_UNIT 6 "Pikeman"    47 39} {FACING sw}
    {GENERIC_UNIT 6 "Fencer"     50 39} {FACING se}
    {GENERIC_UNIT 6 "Longbowman" 50 38} {FACING sw}
    {GENERIC_UNIT 6 "Spearman"   51 37} {FACING sw}

    {GENERIC_UNIT 6 "Spearman"   49 42} {FACING sw} # these 2 are very important - they stop Konrad from traveling through dan'tonk even once POIs are disabled to force him into the Sceptre
    {GENERIC_UNIT 6 "Spearman"   50 41} {FACING se}

    [capture_village]
        side=6
        x,y=50,37
        radius=5
    [/capture_village]
#enddef

#############################
# S18 - DAN'TONK
#############################
[event]
    name=prestart
    {SET_LABEL 48 39 _"Dan’Tonk"}
    {BRAZIER_DYNAMIC_OVERWORLD 45 39}
    {BRAZIER_DYNAMIC_OVERWORLD 49 40}
    {BRAZIER_DYNAMIC_OVERWORLD 52 34}
[/event]
{PLACE_POI 48 39 s18
    APPROACH_RADIUS=3

    SCENARIO_FILE=18_The_Highwaymen
    (PREVIEW_WML=
        title=_"Dan’Tonk"
        difficulty=2
        gold=1
        recruit1=units/human-loyalists/fencer.png
        recruit2=units/human-loyalists/spearman.png
        recruit3=units/human-loyalists/bowman.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {DANTONK_PRESTART_WML}
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Konrad
            message= _ "Dan’Tonk. Delfador says this is the largest city in Wesnoth, and the source of most of Asheviere’s footmen."
        [/message]
        {IF} {VARIABLE_CONDITIONAL status_s10 equals completed} {THEN(
            [message]
                speaker=Konrad
                message= _ "It was also a staging ground for Asheviere’s invasion of Elensefar. Now that we’ve helped Maddock repel her attack, they’ve begun transporting soldiers and weapons from the front back towards Dan’Tonk."
            [/message]
        )}
        {ELSEIF} {LUA(<<return wesnoth.current.turn>=(wml.variables['bm_milestone_elensefar'])>>)} {THEN(
            [message]
                speaker=Konrad
                message= _ "It was also a staging ground for Asheviere’s invasion of Elensefar. Now that she’s taken the city, they’ve begun transporting soldiers and weapons from the front back towards Dan’Tonk."
            [/message]
        )} {/ELSEIF}
        {ELSE(
            [message]
                speaker=Konrad
                message= _ "It’s also the staging ground for Asheviere’s invasion of the west. As her attacks draw to a close, they’ve begun transporting soldiers and weapons from the front back towards Dan’Tonk."
            [/message]
        )} {/IF}
        [message]
            speaker=Konrad
            message= _ "Though the city itself is swarming with guards, if we strike fast we may be able to intercept and pilfer some of those inbound sabers, spears, and bows for our own arsenal!"
        [/message]
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message= _ "A fog has rolled in and several weapon shipments are approaching Dan’Tonk. Everyone, are we ready?"
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {DANTONK_PRESTART_WML}
    )
    (JUSTCOMPLETED_START=
        {MOVE_UNIT id=Konrad 43 37}
        {FIRE_EVENT_UNIT enter_hex id=Konrad} # clear shroud/fog
        # all rewards obtained
        {IF} {VARIABLE_CONDITIONAL dead_wagons greater_than_equal_to 11} {THEN(
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message= _ "We have ventured into the heart of Wesnoth, pillaged the queen’s weapons, and lived to tell the tale! From the wagons we’ve gathered a large collection of sabres, spears, and bows — everything we need to outfit new Fencers, Spearmen, and Bowmen!"
            [/message]
            {NEW_RECRUIT3 (Spearman,Bowman,Fencer) _"Konrad can now recruit Fencers, Spearmen, and Bowmen!" human-loyalists/fencer.png human-loyalists/spearman.png human-loyalists/bowman.png}
        )}
        # some rewards obtained
        {ELSEIF} {VARIABLE_CONDITIONAL dead_wagons greater_than_equal_to 8} {THEN(
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message= _ "We have ventured into the heart of Wesnoth and escaped — and with more weapons than we had before! Although we lack the supplies to outfit and promote Bowmen, we’ve pillaged a large collection of sabres and spears for our Fencers and Spearmen!"
            [/message]
            {NEW_RECRUIT2 (Spearman,Fencer) _"Konrad can now recruit Spearmen and Fencers!" human-loyalists/fencer.png human-loyalists/spearman.png}
        )} {/ELSEIF}
        # one reward obtained
        {ELSEIF} {VARIABLE_CONDITIONAL dead_wagons greater_than_equal_to 5} {THEN(
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message= _ "We have ventured into the heart of Wesnoth and escaped — and with more weapons than we had before! I wish we had managed to pillage more caravans, but we’ve at least obtained a large collection of sabres — perfect for training Fencers."
            [/message]
            {NEW_RECRUIT1 (Fencer) _"Konrad can now recruit Fencers!" human-loyalists/fencer.png}
        )} {/ELSEIF}
        # no rewards obtained
        {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message= _ "We have ventured into the heart of Wesnoth and escaped — but without enough pillage to train even a single new soldier type! We shall have to make-do with the weapons and fighters we already have."
            [/message]
        )} {/IF}
        {CLEAR_VARIABLE dead_wagons}
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message= _ "No point going back — the city surroundings are better-fortified now than ever, and we can’t expect the same trick to work twice."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                     S20 - FORD OF ABEZ
#######################################################################################################################################################
[event]
    name=prestart {SET_LABEL 47 27 _"The Ford of Abez"}
[/event]
{PLACE_POI 47 27 s20 # if I change coords, also change the {REMOVE_IMAGE} coords
    SCENARIO_FILE=20_The_Ford_of_Abez
    (PREVIEW_WML=
        title=_"The Ford of Abez"
        difficulty=1
        gold=0
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {UNSTORE_NPC Dosh x,y=47,26 side,facing=8,sw}
        {GENERIC_UNIT 8 "Orcish Grunt"   46 25} {FACING se} {ROLE ford_henchman1} # roles/locations are also used in the lisar-goes-north cutscene
        {GENERIC_UNIT 8 "Troll Whelp"    46 28} {FACING ne} {ROLE ford_henchman2}
        {GENERIC_UNIT 8 "Orcish Grunt"   49 24} {FACING sw} {ROLE ford_henchman3}
        {GENERIC_UNIT 8 "Troll Whelp"    50 25} {FACING sw} {ROLE ford_henchman4}
    )
    (INCOMPLETE_APPROACHED=
    )
    (INCOMPLETE_MOVETO=
        #############################
        # EXPLAIN THE FEE
        #############################
        # if this is our first time, initialize and explain the fee
        {IF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals $null} {THEN(
            {VARIABLE bm_ford_amount_paid 0}
            {VARIABLE bm_ford_cost 20}
            [message]
                speaker=Dosh
                message= _ "Crossin’ through Stoneskin ford? Dat’ll be $bm_ford_cost gold for passage, whelp." # duplicated when Li'sar crosses
            [/message]
        )} {/IF}
        # if we've paid exactly once, explain the "membership discount" and reduce the price
        {IF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals $bm_ford_cost} {THEN(
            [message]
                speaker=Dosh
                message= _ "You know da deal, softskin. Pay up."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message= _ "What!? But I already paid you!"
            [/message]
            {VARIABLE bm_ford_cost 10}
            [message]
                speaker=Dosh
                message= _ "Fee works every time, both ways. Das why Dosh be givin’ you the membership discount, see? Only $bm_ford_cost gold for repeat customers."
            [/message]
        )} {/IF}
        [store_gold]
            side=1
        [/store_gold]
        [message]
            speaker=Konrad
            message= _ ""
            #############################
            # PAY THE FEE
            #############################
            [option]
                message= _ "Pay ($bm_ford_cost gold)"
                [command]
                    #------------------------
                    # NOT ENOUGH GOLD
                    #------------------------
                    {IF} {VARIABLE_CONDITIONAL gold less_than $bm_ford_cost} {THEN(
                        [message]
                            speaker=Dosh
                            message= _ "You don’t got ’nuff gold, softskin. Come back later."
                        [/message]
                        {MOVE_UNIT id=Konrad $previous_x $previous_y}
                        {CLEAR_VARIABLE gold}
                        [return][/return] # skip the scenario popup
                    )}{/IF}

                    #------------------------
                    # PAY GOLD
                    #------------------------
                    {IF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals 0} {THEN(
                        [message]
                            speaker=Konrad
                            message= _ "This is practically highway robbery, but we don’t have time to stop and fight. Take your gold and let us through."
                        [/message]
                    )} {/IF}
                    [gold]
                        side=1
                        amount="$(0-$bm_ford_cost)"
                    [/gold]
                    {SOUND gold.ogg}
                    {VARIABLE_OP bm_ford_amount_paid add $bm_ford_cost}

                    #------------------------
                    # RECRUIT DOSH
                    #------------------------
                    {IF} {VARIABLE_CONDITIONAL bm_ford_amount_paid greater_than_equal_to 250} {THEN(
                        [message]
                            speaker=Dosh
                            message= _ "Wow. Two-hunnerd fifty gold... you make me richest troll who ever lived! Konrad good troll-friend."
                        [/message]
                        [message]
                            speaker=Dosh
                            message= _ "Now that Dosh so rich, no point runnin’ ford toll no more. Might as well join Konrad, help you out with throne. We done ’nuff time making friends. Now’s time for smashing bad guys."
                        [/message]
                        {MOVE_UNIT role=ford_henchman1 44 18} {KILL role=ford_henchman1}
                        {MOVE_UNIT role=ford_henchman2 46 21} {KILL role=ford_henchman2}
                        {MOVE_UNIT role=ford_henchman3 50 20} {KILL role=ford_henchman3}
                        {MOVE_UNIT role=ford_henchman4 54 20} {KILL role=ford_henchman4}
                        {MODIFY_UNIT id=Dosh side 1}
                        {MODIFY_UNIT id=Dosh canrecruit no}
                        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Dosh $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Dosh} )}
                        {VARIABLE status_s20 failed}
                        {REMOVE_IMAGE 47 27}
                    )}
                    {ELSEIF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals 100} {THEN( # make sure this "charging more" threshold aligns with the actual prices we charge
                        [message]
                            speaker=Dosh
                            message= _ "You okay in da head, softskin? Das one-hunnerd gold you done paid me.

Maybe Dosh otta be charging more... fifty gold next time. Only a real troll-friend would keep paying."
                        [/message]
                        {VARIABLE bm_ford_cost 50}
                    )} {/ELSEIF}
                    {ELSEIF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals 70} {THEN(
                        [message]
                            speaker=Dosh
                            message= _ "You payin’ Dosh a lot o’ coins, Konrad. My retirement fund got seventy gold in it now!"
                        [/message]
                    )} {/ELSEIF}
                    {ELSEIF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals 40} {THEN(
                        [message]
                            speaker=Dosh
                            message= _ "You a good customer, softskin. Das forty gold you done paid me so far."
                        [/message]
                    )} {/ELSEIF}
                    {ELSEIF} {VARIABLE_CONDITIONAL bm_ford_amount_paid less_than 40} {THEN(
                        [message]
                            speaker=Dosh
                            message= _ "Pleasure doin’ business with you."
                        [/message]
                    )}[ /elseif] {/IF}
                    {CLEAR_VARIABLE gold}
                    [return][/return] # skip the scenario popup
                [/command]
            [/option]
            #############################
            # REFUSE TO PAY
            #############################
            [option]
                message= _ "Refuse"
                [command]
                    {IF} {VARIABLE_CONDITIONAL bm_ford_amount_paid equals 0} {THEN(
                        [message]
                            speaker=Konrad {KONRAD_VARIATION mad}
                            message= _ "The heir of Wesnoth does not bow to extortion. Have at you, troll!"
                        [/message]
                    )}
                    {ELSEIF} {VARIABLE_CONDITIONAL bm_ford_amount_paid less_than 60} {THEN(
                        [message]
                            speaker=Konrad {KONRAD_VARIATION mad}
                            message= _ "Paying once was bad enough. I’m taking my gold back!"
                        [/message]
                    )} {/ELSEIF}
                    {/IF}
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE gold}

        {VARIABLE s20_from s}
        {IF} {VARIABLE_CONDITIONAL previous_x equals 48} {THEN( {VARIABLE s20_from n} )}{/IF}
    )

    #############################
    # FAILED
    #############################
    (FAILED_MOVETO=
        # remember, Dosh might be dead here
        {MOVE_UNDER_KONRAD(
            {RECALL_XY Dosh $stored_konrad.x $stored_konrad.y}
            {MOVE_UNIT id=Dosh "$($stored_konrad.x-1)" $stored_konrad.y}
            {MODIFY_UNIT id=Dosh facing se} {MODIFY_UNIT id=Konrad facing sw}
        )}
        [message]
            speaker=Dosh
            message= _ "Dosh glad Konrad and he didn’t have to fight. Fighting with Konrad much better than fighting against him!"
        [/message]
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Dosh $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Dosh} )}
    )

    #############################
    # COMPLETED
    #############################
    (JUSTCOMPLETED_PRESTART=
        {PLACE_IMAGE           "units/orcs/grunt-ne-die-8.png~RC(magenta>black)"   49 25}
        {PLACE_IMAGE           "units/orcs/grunt-die-8.png~RC(magenta>black)"      48 26}
        {PLACE_IMAGE_SUBMERGED "units/orcs/grunt-die-8.png~RC(magenta>black)~FL()" 45 27}
    )
    (JUSTCOMPLETED_START=
        {CLEAR_VARIABLE s20_from}
        [message]
            speaker=Konrad
            message= _ "We taught those highwaymen a lesson they won’t soon forget. Now the ford is free for all, as it should be."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message= _ "The ford is free for all to cross!"
        [/message]
    )
}

#undef DANTONK_PRESTART_WML
#wmlindent: stop ignoring
