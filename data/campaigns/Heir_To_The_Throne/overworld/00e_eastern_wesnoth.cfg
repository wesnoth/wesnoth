#textdomain wesnoth-h2tt
#wmlindent: start ignoring

#######################################################################################################################################################
#                                                                      S41 - SNOW PLAINS
#######################################################################################################################################################
{PLACE_POI 70 15 s41
    STATUS_S31=completed
    SCENARIO_FILE=41_Snow_Plains
    (PREVIEW_WML=
        title=_"Snow Plains"
        difficulty=2
        gold=1
        recruitlabel=_"Defeated Faction:"
        recruitcolor=wesred
        recruit1=units/orcs/grunt.png
        recruit2=units/orcs/warrior.png
        recruit3=units/trolls/grunt.png
        recruit4="units/human-magi/silver-mage+female.png"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {NAMED_UNIT 15 "Orcish Warlord" 70 13 urag_tifer _"Urag Fell-Handed" ()} {LEADER} {FACING se}
        {UNSTORE_NPC Mirya x,y=69,14 side,facing=6,se}
        [item]
            halo=items/cage.png
            x,y=69,14
        [/item]
        {GENERIC_UNIT 15 "Troll"          68 15} {FACING se}
        {GENERIC_UNIT 15 "Orcish Warrior" 68 15} {FACING se}
        {GENERIC_UNIT 15 "Orcish Grunt"   69 15} {FACING sw}
        {GENERIC_UNIT 15 "Orcish Grunt"   69 16} {FACING se}
        {GENERIC_UNIT 15 "Troll"          69 13} {FACING ne}
        [capture_village]   
            side=15
            x,y=70,15
            radius=3
        [/capture_village]
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Konrad
            message=_"Look there, in the cage! Is that who she seems to be?"
        [/message]
        {DELAY 250}
        [message]
            speaker=Mirya
            message=_"Then it’s agreed? You’ll release and repatriate me to my queen’s service, in return for a to-be-negotiated ransom from the royal treasury?"
        [/message]
        [message]
            speaker=urag_tifer
            #po: "witch" is a derogatory term here. Mirya (a Silver Mage) would probably prefer to be called a mage, or maybe a wizard.
            message=_"Rrr... deal. No more mucking around in these freezing mountains while the other chiefs feed like pigs in Wesnoth. Ha! Lucky for me that we happened to run into each other, witch."
        [/message]
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message=_"The fates must have a sense of humor — here is imprisoned the very mage who tried to burn us alive back in the volcano."
        [/message]
        [message]
            speaker=Konrad
            message=_"It sounds as though she stands on the verge of freedom. But if we strike now, we can prevent her from ever rejoining Asheviere."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {NAMED_UNIT 15 "Orcish Warlord" 70 13 urag_tifer _"Urag Fell-Handed" ()} {LEADER} {FACING se}
        {GENERIC_UNIT 15 "Goblin Spearman" 69 14} {FACING se}
        {GENERIC_UNIT 15 "Orcish Grunt"    71 15} {FACING sw}
        {PLACE_IMAGE "units/orcs/grunt-ne-die-8.png~RC(magenta>brown)" 70 14}
        {PLACE_IMAGE "units/orcs/grunt-die-8.png~RC(magenta>brown)"    69 16}
    )
    (JUSTCOMPLETED_START=
        [message]
            speaker=Konrad
            message=_"An ignominious end for a mage who’s caused us so much trouble.                

From what Li’sar tells me, Mirya has recruited orcish clans for Asheviere in the past. It is good that we stopped her before she could bring this one into their fold too."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=urag_tifer
            message=_"Get out of here, humans. You already got what you came for!"
        [/message]
    )
}

#######################################################################################################################################################
#                                                                S42 - A CRISIS OF LEADERSHIP
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 82 19 _"Whitefang Mountains"}
[/event]
{PLACE_POI 81 23 s42
    APPROACH_RADIUS=5

    STATUS_S31=completed
    SCENARIO_FILE=42_A_Crisis_of_Leadership
    (PREVIEW_WML=
        title=_"A Crisis of Leadership"
        difficulty=2
        gold=0
        recruitlabel=_"Defeated Faction:"
        recruitcolor=white
        recruit1=units/goblins/spearman.png
        recruit2=units/orcs/assassin.png
        recruit3=units/orcs/slayer.png # have two assassin line units to emphasize poison
        recruit4=units/orcs/archer.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {PLACE_IMAGE "items/whitefang-flag.png"      81 22}
        {PLACE_IMAGE "items/whitefang-flag.png~FL()" 86 21}

        {GENERIC_UNIT 9 "Orcish Sovereign"  83 22} {FACING sw} {LEADER}
        {GENERIC_UNIT 9 "Orcish Warrior"    82 22} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Assassin"   82 21} {FACING ne}
        {GENERIC_UNIT 9 "Orcish Assassin"   80 22} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Warrior"    80 21} {FACING sw}

        {GENERIC_UNIT 9 "Orcish Assassin"   84 23} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Nightblade" 86 20} {FACING sw} {LEADER}
        {GENERIC_UNIT 9 "Orcish Grunt"      87 21} {FACING sw}
        {GENERIC_UNIT 9 "Goblin Spearman"   88 23} {FACING se}
        {GENERIC_UNIT 9 "Goblin Spearman"   87 23} {FACING ne}

        {GENERIC_UNIT 9 "Orcish Grunt"      83 19} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Slayer"     80 19} {FACING sw} {LEADER}
        {GENERIC_UNIT 9 "Orcish Assassin"   79 23} {FACING nw}
        {GENERIC_UNIT 9 "Orcish Grunt"      79 19} {FACING se}
        {GENERIC_UNIT 9 "Goblin Spearman"   78 20} {FACING sw}

        {NAMED_UNIT 9 "Orcish Warlord" 82 23 Faghmok _"Fagh-mok the Flattered" profile=portraits/orcs/grunt-2.webp} {FACING sw}

        [capture_village]   
            side=9
            x,y=82,20
            radius=6
        [/capture_village]
    )
    (INCOMPLETE_APPROACHED=
        {MOVE_UNDER_KONRAD( {RECALL_XY Delfador $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Delfador $stored_konrad.x "$($stored_konrad.y+1)"} )}
        {MODIFY_UNIT id=Delfador facing ne}
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"Be cautious, Konrad. We approach the Whitefang mountains, home to a vast orcish clan of the same name. They are allies of Asheviere’s, and powerful enemies of ours."
        [/message]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"Even the great armies of yesteryear lacked the strength to defeat them in their home. We should do our best to slip quietly past."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Your warning comes too late, Delfador. One of their leaders has already spotted us!"
        [/message]
        {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=Faghmok "$($coordX+1)" $coordY})}

        [message]
            speaker=Faghmok
            message=_"Peace, pinkski— humans! Hah, don’t you look scared to see me. You must be the great prince Konrad!"
        [/message]
        [message]
            speaker=Faghmok
            #po: his real name is Fagh-mok the Flattered, but he's lying to make himself sound better.
            message=_"I am Fagh-mok the Honorable, honest warrior of the chief’s guard. The nasty queen Asheviere told us all sorts of things about you, prince. But I’m sure it’s all lies."
        [/message]
        [message]
            speaker=Konrad
            message=_"You are no friend of the dark queen, then? Yet your clan fights alongside her as an ally."
        [/message]
        [message]
            speaker=Faghmok
            message=_"They have been misled! Our foolish chief dares to oppose you, oh mighty Konrad! But if there were to be a new chief... myself, for example..."
        [/message]
        [message]
            speaker=Faghmok
            message=_"..."
        [/message]
        [message]
            speaker=Faghmok
            message=_"If you’re interested, come meet me just outside our camp."
        [/message]
        {MOVE_UNIT id=Faghmok 82 23}
        {MODIFY_UNIT id=Faghmok facing sw}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Delfador $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Delfador} )}
    )
    (INCOMPLETE_MOVETO=
        {IF} {VARIABLE_CONDITIONAL bm_s42_movedto not_equals yes} {THEN(
            [message]
                speaker=Faghmok
                message=_"Ha ha ha, I knew you’d come find me. Very good."
            [/message]
            [message]
                speaker=Faghmok
                message=_"I’m prepared to sneak you and three of your best soldiers into the center of our camp. Once you’re there, it’ll be up to you to kill the old chief — and then I can take over!"
            [/message]
            [message]
                speaker=Konrad
                message=_"Or, once we’re separated from our army you will capture us and turn us over to Asheviere. Why should I take such a great risk on the word of a stranger?"
            [/message]
            [message]
                speaker=Faghmok
                message=_"Bah, I don’t get to be chief unless you kill the old chief! But if you must have some guarantee... fine, I’ll stay prisoner with your army until you safely return. Now what do you say?"
            [/message]
        )} {ELSE(
            [message]
                speaker=Faghmok
                message=_"When you’re ready, I can sneak you and three of your best soldiers into the center of our camp. And then you can kill the chief! What do you say?"
            [/message]
        )} {/IF}
        [message]
            speaker=Konrad
            message=_"Hmm... If this is to be an assassination, we will need veterans with enough accuracy and power to quickly defeat enemies even within their own fortifications. Are we prepared?"
        [/message]
        {VARIABLE bm_s42_movedto yes}
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {CLEAR_VARIABLE bm_s42_movedto}

        {PLACE_IMAGE "items/whitefang-flag.png"      81 22}
        {PLACE_IMAGE "items/whitefang-flag.png~FL()" 86 21}

        {GENERIC_UNIT 9 "Orcish Warrior"     82 22} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Grunt"       82 21} {FACING ne} {HITPOINTS 10}
        {GENERIC_UNIT 9 "Orcish Assassin"    80 22} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Warrior"     85 22} {FACING sw} {HITPOINTS 10} {STATUS poisoned=yes}

        {GENERIC_UNIT 9 "Orcish Grunt"       84 23} {FACING sw} {HITPOINTS 22} {STATUS poisoned=yes}
        {GENERIC_UNIT 9 "Orcish Nightblade"  84 21} {FACING sw} {LEADER}
        {GENERIC_UNIT 9 "Orcish Grunt"       87 21} {FACING sw}
        {GENERIC_UNIT 9 "Goblin Spearman"    88 23} {FACING se} {HITPOINTS 10}
        {GENERIC_UNIT 9 "Goblin Spearman"    87 23} {FACING ne}

        {GENERIC_UNIT 9 "Orcish Grunt"       83 19} {FACING sw}
        {GENERIC_UNIT 9 "Orcish Crossbowman" 81 20} {FACING sw} {HITPOINTS 22} {STATUS poisoned=yes} {LEADER}
        {GENERIC_UNIT 9 "Orcish Grunt"       79 23} {FACING nw} {HITPOINTS 22}
        {GENERIC_UNIT 9 "Orcish Grunt"       79 19} {FACING se} {HITPOINTS 10}
        {GENERIC_UNIT 9 "Orcish Archer"      78 20} {FACING sw}

        {PLACE_IMAGE "units/orcs/grunt-ne-die-8.png~RC(magenta>white)" 83 22}
        {PLACE_IMAGE "units/orcs/grunt-die-8.png~RC(magenta>white)"    80 23}
        {PLACE_IMAGE "units/orcs/grunt-ne-die-8.png~RC(magenta>white)" 84 22}

        [capture_village]   
            side=9
            x,y=82,20
            radius=6
        [/capture_village]
    )
    (JUSTCOMPLETED_START=
        [message]
            speaker=Konrad
            message=_"With the Whitefangs embroiled in civil war, Asheviere is more vulnerable than ever! I wonder who the eventual victor will be..."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message=_"With the Whitefangs embroiled in civil war, Asheviere is more vulnerable than ever."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                S43 - CLIFFS OF THORIA
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 77 11 _"Arkan-Thoria"}
    {PLACE_WATERFALL se 83 14 ()}
    {PLACE_IMAGE scenery/wreck.png 83 14}
[/event]
{PLACE_POI 82 14 s43
    STATUS_S31=completed
    SCENARIO_FILE=43_Cliffs_of_Thoria
    (PREVIEW_WML=
        title=_"Cliffs of Thoria"
        difficulty=3
        gold=1
        recruitlabel=_"New Companion for Li’sar:"
        recruitcolor=lisarcolor
        recruit1=units/human-loyalists/lieutenant.png
        otherlabel=_"Reinforcements: <span color='#EFBF04'><b>Lisar will start future scenarios with double income and +50 gold.</b></span>"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {GENERIC_UNIT 7 "Drake Glider"  80 13} {FACING se}
        {GENERIC_UNIT 7 "Drake Burner"  81 14} {FACING sw}
        {GENERIC_UNIT 7 "Drake Clasher" 84 13} {FACING sw}
        {GENERIC_UNIT 7 "Fire Drake"    85 15} {FACING sw}
        {GENERIC_UNIT 7 "Drake Fighter" 86 14} {FACING sw}
        {GENERIC_UNIT 7 "Fire Drake"    87 13} {FACING se}
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Konrad
            message=_"Look — winged shapes swooping on the horizon. And I hear the shouts and screams of men! A battle is being fought on the river!"
        [/message]
        {IF} {HAVE_UNIT id,search_recall_list,side=Kalenz,yes,1} {THEN(
            {MOVE_UNDER_KONRAD( {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Kalenz "$($stored_konrad.x+1)" $stored_konrad.y} )}
            {MODIFY_UNIT id=Kalenz facing se}
            [message]
                speaker=Kalenz
                message=_"That is the river that is known as Longlier to men, called Arkan-thoria in my people’s ancient tongue. Its name means ‘The River of Bones’. Great and evil creatures lurk along its banks, its waters are not fit to drink, and it runs over the Cliffs of Thoria."
            [/message]
            [message]
                speaker=Kalenz
                message=_"It has been many centuries since any man or elf has passed over the Cliffs and survived. Be cautious, prince."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kalenz $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz} )}
        )} {/IF}
    )
    (INCOMPLETE_MOVETO=)

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {GENERIC_UNIT 7 "Drake Clasher" 83 13} {FACING se}
        {GENERIC_UNIT 7 "Drake Fighter" 85 14} {FACING sw}
        {GENERIC_UNIT 7 "Fire Drake"    86 12} {FACING se}
    )
    (JUSTCOMPLETED_START=
        {MODIFY_UNIT id=Konrad facing nw}
        {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar  x,y=$stored_konrad.x,$stored_konrad.y side=14} {MOVE_UNIT id=Lisar  81 15} {MODIFY_UNIT id=Lisar facing se} )}
        {MOVE_UNDER_KONRAD( {UNSTORE_NPC Warven x,y=$stored_konrad.x,$stored_konrad.y side=14} {MOVE_UNIT id=Warven 81 14} {MODIFY_UNIT id=Lisar facing se} )}
        [message]
            speaker=Warven
            message=_"I can’t thank you enough for saving me, Your Highness. I would have been dead a dozen times over."
        [/message]
        [message]
            speaker=Warven
            message=_"The rest of the survivors are a week’s march upriver. They’re in a pretty bad state right now, but give me a few animals and some supplies to go relieve them, and we’ll be ready to reinforce you for your next battles."
        [/message]
        {MOVE_UNIT id=Warven 70 9} {STORE_NPC Warven}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar} )}
        [object]
            {FILTER id=Konrad} duration=turn
            image=icons/helmet_conical.png
            name=_"Reinforcements"
            description=_"Lisar will start future scenarios with double income and +50 gold."
        [/object]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message=_"There are still some drakes here, but there’s no longer any reason to fight. We did a good thing by rescuing Warven and his allies."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                     GREY GROVE
#######################################################################################################################################################
# 1) warn the player the Lintanir (and a long conversation) is close
# 2) foreshadow the woses in Underground Channels
# 3) link the Underground Channels woses to the TDG Grey Grove woses
[event]
    name=prestart
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_approached_grey_grove not_equals yes})}
    {FILTER_CONDITION({VARIABLE_CONDITIONAL status_s44 not_equals completed})}
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION( x,y,radius=94,23,1 )} )}
        [cancel_action]
        [/cancel_action]
        [message]
            speaker=Konrad
            message=_"We’re approaching the outskirts of Lintanir forest. Delfador once told me about a grove of woses living here, but today the trees are silent. Wherever the woses are, I expect the elves of Lintanir will have much to speak with us about."
        [/message]
        {VARIABLE bm_approached_grey_grove yes}
    [/event]
[/event]

#######################################################################################################################################################
#                                                                S44 - UNDERGROUND CHANNELS
#######################################################################################################################################################
{PLACE_POI 95 27 s44
    APPROACH_RADIUS=0

    STATUS_S31=completed
    SCENARIO_FILE=44_Underground_Channels
    (PREVIEW_WML=
        title=_"Underground Channels"
        preview=bigmap/preview-shroud.png
        difficulty=2
        gold=2
        recruitlabel=_"New Recruit for Delfador:"
        recruit1=units/mechanical/granite-golem.png
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {GENERIC_UNIT 11 "Death Knight"       95 28} {FACING nw} {LEADER}
        {GENERIC_UNIT 11 "Skeleton"           95 29} {FACING nw}
        {GENERIC_UNIT 11 "Ghoul"              97 27} {FACING se}
        {GENERIC_UNIT 11 "Ghoul"              96 28} {FACING se} {HITPOINTS 5}
        {GENERIC_UNIT 16 "Saurian Skirmisher" 97 29} {FACING nw} {HITPOINTS 22}
        {MODIFY_UNIT x,y=97,29 status.poisoned yes}
        {GENERIC_UNIT 16 "Saurian Skirmisher" 98 28} {FACING sw}
        # No woses. In the "Grey Grove" event, Delfador wonders where the woses went, so let's not show them on the overworld here 
    )
    (INCOMPLETE_APPROACHED=
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message=_"The river travels underground here, and there is an awful stench of rot and decay. Has some undead creature taken up residence inside?"
        [/message]
        [message]
            speaker=Konrad
            message=_"I am not sure what benefit we could gain from fighting in such a place, but it is always our duty to destroy evil."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {NAMED_UNIT   5 "Ancient Wose" 96 27 Haralamdum _"Haralamdum" ()} {FACING sw}
        {GENERIC_UNIT 5 "Wose"         97 27                            } {FACING sw}
    )
    (JUSTCOMPLETED_START=
        [message]
            speaker=Haralamdum
            #po: Goodbye young Master Delfador, and Prince Konrad. Good luck. I hope my gift will be useful to you.
            message=_"Goodbye ... young Master Delfador ... Prince Konrad ... hum dum da dum ... and good luck. I hope my gift will be useful to you."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Haralamdum
            #po: Hello again.
            message=_"Hello ... again. Har alam dum ..."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                      LINTANIR FOREST
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 97 16 _"Lintanir Forest"}
[/event]
[event]
    name=prestart

    #############################
    # ELVES
    #############################
    {NAMED_UNIT       2 "Elvish Marshal"   98 20 Eloreis  _"Eloreis" ()} {FACING sw} {LEADER}
    {NAMED_LOYAL_UNIT 2 "Elvish Lady"      97 18 Parandra _"Parandra"  } {FACING sw} 

    {GENERIC_UNIT     2 "Elvish Archer"    95 18} {FACING nw}
    {GENERIC_UNIT     2 "Elvish Archer"    94 16} {FACING ne}
    {GENERIC_UNIT     2 "Elvish Captain"   99 16} {FACING se}
    {GENERIC_UNIT     2 "Elvish Sorceress" 98 15} {FACING se}
    {GENERIC_UNIT     2 "Elvish Hero"      99 20} {FACING se}
    {GENERIC_UNIT     2 "Elvish Hero"      96 13} {FACING nw}

    [event]
        name=enter hex
        {FILTER id,x,y=Konrad,92-99,18-21}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_met_lintanir not_equals yes})}
        [cancel_action]
        [/cancel_action]
        {VARIABLE bm_met_lintanir yes}

        {FADE_MUSIC_OUT 250}
        {INCIDENTAL_MUSIC elvish-theme.ogg}
        {FADE_MUSIC_IN 50}

        #############################
        # SPEAK WITH THE ELVES
        #############################
        #------------------------
        # INTRODUCTIONS
        #------------------------
        # terrain layout means we're guranteed to trigger this on 93,21 or 94,21
        # make the filter more generous in case we change terrain later, but knowing where Konrad is lets us hardcode some move positions
        {IF} {HAVE_UNIT id,search_recall_list,side=Kalenz,yes,1} {THEN(
            {IF} {HAVE_UNIT id,x,y=Konrad,93,21} {THEN(
                {MOVE_UNDER_KONRAD( {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Kalenz 94 21} {MODIFY_UNIT id=Kalenz facing ne} )}
            )} {ELSE(
                {MOVE_UNDER_KONRAD( {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Kalenz 93 21} {MODIFY_UNIT id=Kalenz facing ne} )}
            )} {/IF}
            [message]
                speaker=Kalenz
                message=_"At last! Friends, we have finally reached the Lintanir Forest, home of the North Elves. I was born not far east of here... more years ago than I care to remember."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"Hail, elves! I am Konrad, heir to the throne of Wesnoth and son of the Aethenwood. Lord Kalenz has told me much about his home in the Lintanir. I am honored to meet you."
            [/message]
            [message]
                speaker=Eloreis
                message=_"Greetings, Konrad. I have heard much about you as well. Welcome to the Lintanir Forest."
            [/message]
            {MOVE_UNIT id=Kalenz 98 18}
            {MODIFY_UNIT id=Kalenz facing sw}
        )}
        # we don't have Kalenz with us
        {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"Hail, elves! I am Konrad, heir to the throne of Wesnoth, son of the Aethenwood and friend of Lord Kalenz."
            [/message]
            [message]
                speaker=Eloreis
                message=_"Greetings, Konrad. I have heard much about you. Welcome to the Lintanir Forest, home of the North Elves."
            [/message]
        )} {/IF}
        {MOVE_UNIT id=Konrad 95 21}
        {MOVE_UNDER_KONRAD( {RECALL_XY Delfador $stored_konrad.x $stored_konrad.y}                      {MOVE_UNIT id=Delfador 95 20} {MODIFY_UNIT id=Delfador facing ne} )}
        {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar    96 21} {MODIFY_UNIT id=Lisar    facing ne} )}

        #------------------------
        # MEETING PARANDRA
        #------------------------
        [message]
            speaker=Parandra
            message=_"How quickly does the race of men mature! Only seventeen winters have passed since I last laid eyes on you, Konrad, yet you are now a grown man. A proven warrior stands before me!"
        [/message]
        [message]
            speaker=Konrad
            message=_"Forgive me, Elf, but I’m afraid I do not recall meeting you before. "
        [/message]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"Konrad, this is Parandra. When Asheviere first took power and her orcs began rampaging across Wesnoth, Parandra helped me rescue you from the royal palace."
        [/message]
        [message]
            speaker=Konrad
            message=_"I had no idea! Thank you, my lady. It is a pleasure to meet you again."
        [/message]
        [message]
            speaker=Lisar
            message=_"Rescued him from my mother? Seventeen years ago Konrad would’ve been an infant. What is this you’re talking about? "
        [/message]
        [message]
            id=Kalenz,Eloreis
            message=_"Your mother has much blood upon her hands, child. She has had many killed unjustly. When Konrad was an infant, she ordered all the princes put to death, so she could seize control."
        [/message]
        [message]
            speaker=Lisar
            message=_"Not long ago I would’ve decried such an obvious lie. But Konrad and Delfador have shown me many things of which I didn’t wish to believe regarding my mother. I trust that you speak the truth."
        [/message]
        {DELAY 500}

        #------------------------
        # LISAR WANTS TO BE QUEEN
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
            [message]
                speaker=Lisar
                message=_"But now I hold the Sceptre — our symbol of rulership — and my mother’s time as queen draws short. I have a chance to do better!"
            [/message]
            [message]
                speaker=Delfador
                message=_"Though you have the Sceptre, my lady, it is not your place to rule. Your line was tainted when Asheveire orchestrated her husband’s downfall."
            [/message]
        )} {ELSE(
            [message]
                speaker=Lisar
                message=_"But that is why I must take the Sceptre from you, Konrad — it is our symbol of rulership. My mother’s time as queen draws short. With the Sceptre, as queen, I have a chance to do better."
            [/message]
            [message]
                speaker=Delfador
                message=_"My lady, there is some good in you, but the throne is not yours to claim. Your line was tainted when Asheveire orchestrated her husband’s downfall."
            [/message]
        )} {/IF}
        [message]
            speaker=Delfador
            message=_"Konrad is the rightful heir; the son of Arand and nephew of Garard. I have raised him as my own, as penance for my part in Garard’s fall. Konrad shall be king."
        [/message]

        #------------------------
        # FORESHADOWING KONRAD'S PARENTAGE
        #------------------------
        {MOVE_UNIT   id=Parandra 92 18}
        {MODIFY_UNIT id=Parandra facing ne}
        [message]
            speaker=Parandra
            message=_"(gestures to Delfador)"
        [/message]
        {MOVE_UNIT   id=Delfador 93 18}
        {MODIFY_UNIT id=Delfador facing sw}
        [message]
            speaker=Parandra
            message="<span size='small'>"+_"Delfador, you have raised Konrad to be skillful and wise, honorable and just. A warrior who has respect, and appreciates peace. Yet the throne is not the place for him. You know of what I speak, Delfador."+"</span>"
        [/message]
        [message]
            speaker=Delfador
            message="<span size='small'>"+_"Parandra, what you say may seem right to some, but as long as you and I speak to no-one of what we know, I see no reason why Konrad would not best have the throne."+"</span>"
        [/message]
        [message]
            speaker=Parandra
            message="<span size='small'>"+_"In so many things you are right, Delfador, and your wisdom is unmatched in the world of men. But in this, you are mistaken. Li’sar is the heir. She should take the throne. Now that I have met her for myself, I am sure of it."+"</span>"
        [/message]
        [message]
            speaker=Delfador
            message="<span size='small'>"+_"Hmph. Perhaps you are right, perhaps not. We shall see."+"</span>"
        [/message]
        {DELAY 1000}

        #------------------------
        # GOODBYES (WITH KALENZ)
        #------------------------
        {IF} {HAVE_UNIT id,search_recall_list,side=Kalenz,yes,1} {THEN(
            [message]
                speaker=Kalenz
                message=_"*Ahem*"
            [/message]
            {DELAY 500}
            {MOVE_UNIT id=Kalenz 97 20}
            {DELAY 500}
            {IF} {VARIABLE_CONDITIONAL st_kalenz_explains_no_army equals yes} {THEN(
                [message]
                    speaker=Kalenz
                    message=_"... Konrad, I once promised you aid from my home, should we ever reach it. Now we have. The Lintanir has magic to offer you and your companions; aid on your quest against the dark queen."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Kalenz
                    message=_"... Konrad, you have proven yourself an enemy of Asheviere’s and a friend to the elves. The Lintanir has magic to offer you and your companions; aid on your quest against the dark queen."
                [/message]
            )} {/IF}
            [message]
                speaker=Kalenz
                message=_"We hold in our possession three objects of legend: a tome of wose lore, a chestplate of black steel, and a great sword of fire. Choose one, and it shall be yours."
            [/message]
            [message]
                speaker=Konrad
                message=_"You are as generous as you are wise, Lord Kalenz. Please, tell us more about these artifacts you offer."
            [/message]
            {FIRE_EVENT choose_lintanir_boon}
            [message]
                speaker=Kalenz
                message=_"Now I wish you luck, Konrad, and you Li’sar. Let us rest, and then once more go forth. Fortune has smiled upon us so far, despite great dangers. Perhaps she will continue to do so."
            [/message]
        )}
        #------------------------
        # GOODBYES (WITHOUT KALENZ)
        #------------------------
        {ELSE(  
            [message]
                speaker=Eloreis
                message=_"But enough introductions. Konrad, is the Lord Kalenz with you? There is much that the three of us ought to speak about."
            [/message]
            [message]
                speaker=Kalenz
                message=_"The good lord was injured in battle some time ago, and retreated eastwards towards Lintanir forest. He has not arrived safely? That is ill news, for he seemed a wise elf and a staunch ally."
            [/message]
            [message]
                speaker=Eloreis
                message=_"That bodes ill indeed. I do not believe he has perished, for Kalenz represents the best of us, and has survived many trials in times past. But I fear he has been waylaid by some mischief."
            [/message]
            [message]
                speaker=Eloreis
                message=_"I can do little but wish you luck, Konrad, and you Li’sar. Rest, and then go forth. Fortune has smiled upon you so far, despite great dangers. Perhaps she will continue to do so."
            [/message]
        )} {/IF}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kalenz   $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz}   )}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Delfador $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Delfador} )}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar    $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar}                )}
    [/event]
[/event]
#######################################################################################################################################################
[event]
    name=choose_lintanir_boon
    #############################
    # ASK ABOUT BOONS
    #############################
    #--------------------
    # ASK ABOUT WOSE LORE
    #--------------------
    [event]
        name=ask_about_lore
        first_time_only=no
        {IF} {VARIABLE_CONDITIONAL asked_lore not_equals yes} {THEN(
            [message]
                speaker=Konrad
                message= _ "I know little of woses, but I know they are not warriors. What secret lore might they have that could be of use on the battlefield?"
            [/message]
            [message]
                speaker=Kalenz
                message= _ "The ways of the wood; the art of moving quickly and unseen among the trees. It is a magical tome; a record of the life-sap of Elilmaldur-Rithrandil, eldest of the Green Isle."
            [/message]
            [message]
                speaker=Kalenz
                message= _ "To many, this tome would seem filled with meaningless tales of sticks and leaves. But you were raised in woods, Konrad. Should you choose to take it, I believe you will gain great affinity with the forest, its nature and ways, and all the creatures within it."
            [/message]
            {VARIABLE asked_lore yes}
        )} {/IF}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Taking the tome of Wose Lore will grant <b>Konrad</b> the <i>ambush</i> ability — invisibility in forest — as well as improved forest movement and 70% forest defense."
        [/message]
        [select_lintanir_boon]
        [/select_lintanir_boon]
    [/event]
    #--------------------
    # ASK ABOUT FLAMING SWORD
    #--------------------
    [event]
        name=ask_about_sword
        first_time_only=no
        {IF} {VARIABLE_CONDITIONAL asked_sword not_equals yes} {THEN(
            [message]
                speaker=Konrad
                message= _ "You called this a sword of fire, Kalenz, but it looks little different from my own. Is there a command word, perhaps?"
            [/message]
            {MOVE_UNIT id=Delfador 95 20}
            {MODIFY_UNIT id=Delfador facing se}
            [message]
                speaker=Delfador
                message= _ "This is a wizard’s sword, Konrad; I sense its power. With such an enchanted weapon, even one as old as me would make a capable swordsman."
            [/message]
            [message]
                speaker=Kalenz
                message= _ "Yes, it once belonged to Ila’alion, a mighty sorceresses. It was enchanted as a boon to her by your elvish friends in the south, but it brought her only disaster.

Her fellow enchantresses... well, one could say they were slow to come to Ila’alion’s aid as she held this very forest against an orcish incursion. They resented her arrogance as the bearer of the sword, and indignation is a powerful force amongst my people at times."
            [/message]
            {VARIABLE asked_sword yes}
        )} {/IF}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Taking the Flaming Sword will grant <b>Delfador</b> a new melee attack, hitting for 7-4 fire damage."
        [/message]
        [select_lintanir_boon]
        [/select_lintanir_boon]
    [/event]
    #--------------------
    # ASK ABOUT VOID ARMOR
    #--------------------
    [event]
        name=ask_about_armor
        first_time_only=no
        {IF} {VARIABLE_CONDITIONAL asked_armor not_equals yes} {THEN(
            [message]
                speaker=Lisar
                message= _ "That’s a spectacular piece of armor, Kalenz, and I don’t think it is elf-made. Not even among the best smiths of Weldyn have I seen its like. How did the Lintanir come by it?"
            [/message]
            [message]
                speaker=Kalenz
                message= _ "Many years ago, we were troubled by an undead lord of great power. Its axe clove our steel blades as if they were saplings, and its enchanted armor deflected our strongest magics and hottest fires."
            [/message]
            [message]
                speaker=Kalenz
                message= _ "Only at great length and great cost did we emerge triumphant, destroying the lord of the undead and taking its armor as spoil. If you choose to wear it, Li’sar, do so humbly — it was paid for in blood."
            [/message]
            {VARIABLE asked_armor yes}
        )} {/IF}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Taking the Void Armor will grant <b>Li’sar</b> immunity to slows, poison, fire damage, cold damage, and arcane damage."
        [/message]
        [select_lintanir_boon]
        [/select_lintanir_boon]
    [/event]
    #############################
    # TAKE BOONS
    #############################
    #--------------------
    # TAKE WOSE LORE
    #--------------------
    [event]
        name=take_lore
        [message]
            speaker=Kalenz
            message= _ "As you wish. The wose lore is yours."
        [/message]
        {GIVE_OBJECT_TO id=Konrad (
            id=boon_wose_lore
            image=icons/book.png
            name=_"Wose Lore"
            description=_"This massive book is filled with the Lore and Legends of the Wose. Konrad gains the <i>ambush</i> ability, improved forest movement, and 70% forest defense."
            {EFFECT new_ability (
                [abilities]
                    [dummy]
                        id=wose_lore
                        name=_"wose lore"
                        description=_"This unit has 70% defense, full movement, and invisibility in forest."
                    [/dummy]
                    {ABILITY_AMBUSH}
                [/abilities]
            )}
            {EFFECT movement_costs (replace=yes
                [movement_costs]
                    forest=1
                [/movement_costs]
            )}
            {EFFECT defense (replace=yes
                [defense]
                    forest=30
                [/defense]
            )}
        )}
        # disable the improved forest movement while we're on the bigmap, or else Konrad can get to inaccessible places
        {GIVE_OBJECT_TO id=Konrad (
            duration=scenario
            {EFFECT movement_costs (replace=yes
                [movement_costs]
                    forest=99
                [/movement_costs]
            )}
        )}
    [/event]
    #--------------------
    # TAKE FLAMING SWORD
    #--------------------
    [event]
        name=take_sword
        [message]
            speaker=Kalenz
            message= _ "As you wish. The flaming sword is yours."
        [/message]
        {GIVE_OBJECT_TO id=Delfador (
            id=boon_flaming_sword # used in smalltalk.cfg
            image=attacks/sword-flaming.png
            name=_"Flaming Sword"
            description=_"This massive blade was created centuries ago by long-forgotten elvish forgemasters, who imbued the bluish steel with an inner magical fire. Delfador gains a new melee attack, dealing 7-4 fire damage."
            {EFFECT new_attack (
                name=flaming sword # used for Delfador's animation
                icon=attacks/sword-flaming.png
                description= _ "flaming sword"
                type=fire
                range=melee
                damage=7
                number=4
            )}
        )}
    [/event]
    #--------------------
    # TAKE VOID ARMOR
    #--------------------
    [event]
        name=take_armor
        [message]
            speaker=Kalenz
            message= _ "As you wish. The void armor is yours."
        [/message]
        {GIVE_OBJECT_TO id=Lisar (
            id=boon_void_armor
            image=icons/breastplate2.png
            name=_"Void Armor"
            description=_"This beautiful chest plate is crafted from shimmering black steel. Li’sar gains immunity to slows, poison, fire damage, cold damage, and arcane damage."
            {EFFECT new_ability (
                [abilities]
                    [dummy]
                        id=void_armor
                        name=_"void armor"
                        description=_"This unit has immunity to slows, poison, fire damage, cold damage, and arcane damage."
                    [/dummy]
                [/abilities]
            )}
            {EFFECT status add=unpoisonable}
            {EFFECT status add=unslowable}
            {EFFECT resistance (replace=yes
                [resistance]
                    fire=0
                    cold=0
                    arcane=0
                [/resistance]
            )}
            {EFFECT image_mod add="PAL(FFFFFF,C6E7E7,94C6C6,638C94,31526B,182931,C5CFDA,66A5B2,A0B9B8 > b0b0b0,8c8c8c,3B3B3B,242424,0D0D0D,0D0D0D,3B3B3B,242424,242424)"}
        )}
    [/event]
    [select_lintanir_boon]
    [/select_lintanir_boon]
[/event]

#######################################################################################################################################################
#                                                                     FORT GARARD
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 80 30 _"Fort Garard"}
[/event]
[event]
    name=prestart
    {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_approached_fort_garard not_equals yes})}
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION( x,y,radius=80,31,2 )} )}

        [cancel_action]
        [/cancel_action]
        {MOVE_UNDER_KONRAD( {RECALL_XY Delfador $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Delfador $stored_konrad.x "$($stored_konrad.y+1)"} )}
        {MODIFY_UNIT id=Delfador facing ne}
        [message]
            speaker=Konrad
            message=_"The ruins of Fort Garard. This is where my father died."
        [/message]
        [message]
            speaker=Delfador
            message=_"Yes. You know the story. The darkest hour of my darkest day; a crime born of my haste and my arrogance. Had I been but a breath wiser that night, all might have been different..."
        [/message]
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Delfador $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Delfador} )}
        {VARIABLE bm_approached_fort_garard yes}
    [/event]
[/event]

#######################################################################################################################################################
#                                                                       ESTMARKS
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 80 43 _"Estmark Hills"}

    # these are the northern/southern outposts from EI. The timeline claims they were built in 470YW, around 50 years ago
    {SET_LABEL 82 40 "<span size='xx-small'>"+_"N. Outpost"+"</span>"}
    {GENERIC_UNIT 6 Spearman 82 40} {FACING se}
    {SET_LABEL 76 48 "<span size='xx-small'>"+_"S. Outpost"+"</span>"}
    {GENERIC_UNIT 6 Spearman 76 48} {FACING se}
[/event]

#######################################################################################################################################################
#                                                                       SORADOC
#######################################################################################################################################################
[event]
    name=prestart
    {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals completed} )}

    {SET_LABEL 79 35 _"Parthyn"}
    {SET_LABEL 72 37 _"Soradoc"}

    {GENERIC_UNIT 6 Lieutenant 73 38} {FACING ne} {LEADER} {ROLE soradoc_leader}
    {GENERIC_UNIT 6 Bowman     72 38} {FACING nw}
    {GENERIC_UNIT 6 Spearman   72 37} {FACING ne}
    {GENERIC_UNIT 6 Spearman   74 35} {FACING se}
    {GENERIC_UNIT 6 Horseman   75 39} {FACING ne}

    #############################
    # SORADOC ENCOUNTER
    #############################
    {IF} {VARIABLE_CONDITIONAL bm_encountered_soradoc not_equals yes}
         {VARIABLE_CONDITIONAL bm_turns not_equals $bm_milestone_finale} # if we're at the finale, Konrad/Li'sar have already been "invited" to Weldyn. Don't try to bar them passage.
    {THEN(
        {PLACE_IMAGE bigmap/poi-battle.png 74 36}
        [event]
            name=enter hex
            {FILTER( id=Konrad {FILTER_LOCATION( x,y,radius=73,37,4 )})}
            #------------------------
            # INTRODUCTION
            #------------------------
            [cancel_action]
            [/cancel_action]
            {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar $stored_konrad.x "$($stored_konrad.y+1)"} )}
            {MODIFY_UNIT id=Lisar facing sw}
            [message]
                role=soradoc_leader
                message=_"Halt! Your Highness Li’sar, by order of Queen Asheviere you are branded a traitor and an enemy of the state. Prepare to be apprehended."
            [/message]
            #------------------------
            # LISAR HAS SCEPTRE
            #------------------------
            {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
                {MOVE_UNIT id=Lisar 75 37}
                {ANIMATE_ATTACK id=Lisar name="sceptre of fire" no x,y=34,37} {DELAY 250}
                {ANIMATE_ATTACK id=Lisar name="sceptre of fire" no x,y=34,37} {DELAY 250}
                {ANIMATE_ATTACK id=Lisar name="sceptre of fire" no x,y=34,37}
                [message]
                    speaker=Lisar # no variation; use her default portrait (which now includes the Sceptre)
                    message=_"A traitor? This is the Sceptre of Fire, symbol of the kings of Wesnoth, and I return after claiming it at great cost from the caverns of the north."
                [/message]
                [message]
                    speaker=Lisar
                    message=_"You know that Asheviere has proven a poor ruler. You know that I have been a just general. And now I hold the Sceptre, not my mother. Stand aside or die, soldier."
                [/message]
            )} 
            #------------------------
            # KONRAD HAS SCEPTRE
            #------------------------
            {ELSE(
                {MOVE_UNIT id=Konrad 75 37}
                [message]
                    speaker=Konrad
                    message=_"Leave my cousin out of this. You know who I am. And now you see I hold the Sceptre."
                [/message]
                [message]
                    speaker=Konrad
                    message=_"You have heard lies about my war from Asheviere — now hear the truth. This land is suffering. I know it, you know it, even Li’sar knows it; Asheviere’s own daughter driven to revolt."
                [/message]
                # need to give Konrad the sceptre manually, because all his attacks are disabled on the overworld
                {GIVE_OBJECT_TO id=Konrad (id=konrad_sceptre {SCEPTRE_OF_FIRE_EFFECT})}
                {ANIMATE_ATTACK id=Konrad name="sceptre of fire" no x,y=34,37} {DELAY 250}
                {ANIMATE_ATTACK id=Konrad name="sceptre of fire" no x,y=34,37} {DELAY 250}
                {ANIMATE_ATTACK id=Konrad name="sceptre of fire" no x,y=34,37}
                {REMOVE_OBJECT konrad_sceptre id=Konrad}
                [message]
                    speaker=Konrad
                    message=_"Together the princess and I have claimed the Sceptre of Fire, the staff of kings. In Haldric’s hands, it was our salvation from the Lich Lords. In mine, it shall save you and I both from the terror that is Asheviere. You will let us pass."
                [/message]
            )} {/IF}
            #------------------------
            # ALLOWED TO PASS
            #------------------------
            {DELAY 750}
            [message]
                role=soradoc_leader
                message="<i><span size='xx-small'>" + _"(whispering back and forth)" + "</span></i>"
            [/message]
            {DELAY 750}
            {REMOVE_IMAGE 74 36}
            [message]
                role=soradoc_leader
                message=_"Go. You were never here."
            [/message]
            [message]
                role=soradoc_leader
                message=_"... and if you do win against Asheviere, please remember our actions today."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar} )}
            {VARIABLE bm_encountered_soradoc yes}
        [/event]
    )} {/IF}
[/event]

#######################################################################################################################################################
#                                                                       MERLE
#######################################################################################################################################################
# this is handled in 00b_central_wesnoth.cfg, since that's where Merle first appears

#######################################################################################################################################################
#                                                               S47 - TEST OF THE CLANS
#######################################################################################################################################################
[event]
    name=prestart
    {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals completed} )}
    {SET_LABEL 63 36 _"The Horse Plains"}
    # names/colors are used in S47 too
    {IF} {VARIABLE_CONDITIONAL s47_recruited_alric not_equals yes} {THEN(
        {NAMED_UNIT 6 "Grand Knight" 64 34 Alric _"Sir Alric"  ()} {FACING se} {LEADER} {ROLE horselord}
        {TEAM_COLOR_OVERRIDE id=Alric darkred}
    )} {/IF}
    {IF} {VARIABLE_CONDITIONAL s47_recruited_daryn not_equals yes} {THEN(
        {NAMED_UNIT 6 "Grand Knight" 62 35 Daryn _"Sir Daryn"  ()} {FACING se} {LEADER} {ROLE horselord}
        {TEAM_COLOR_OVERRIDE id=Daryn white}
    )} {/IF}
    {IF} {VARIABLE_CONDITIONAL s47_recruited_bayar not_equals yes} {THEN(
        {NAMED_UNIT 6 "Grand Knight" 61 37 Bayar _"Lord Bayar" ()} {FACING sw} {LEADER} {ROLE horselord}
        {TEAM_COLOR_OVERRIDE id=Bayar gold}
    )} {/IF}
    {IF} {VARIABLE_CONDITIONAL s47_recruited_ruga  not_equals yes} {THEN(
        {NAMED_UNIT 6 "Grand Knight" 63 38 Ruga  _"Sir Ruga"  ()} {FACING ne} {LEADER} {ROLE horselord}
        {TEAM_COLOR_OVERRIDE id=Ruga orange}
    )} {/IF}

    {GENERIC_UNIT 6 "Bay Horse"   67 39} {FACING sw}

    {GENERIC_UNIT 6 "Black Horse" 59 34} {FACING sw}
    {GENERIC_UNIT 6 "Dark Horse"  58 34} {FACING se}

    {GENERIC_UNIT 6 "Horseman"    67 32} {FACING ne}
    {GENERIC_UNIT 6 "Bay Horse"   68 32} {FACING se}
    {GENERIC_UNIT 6 "White Horse" 70 32} {FACING sw}

    {GENERIC_UNIT 6 "Knight"      62 40} {FACING ne}
    {GENERIC_UNIT 6 "Lancer"      60 39} {FACING se}
[/event]
{PLACE_POI 63 36 s47
    STATUS_S31=completed
    SCENARIO_FILE=47_Test_of_the_Clans
    (PREVIEW_WML=
        title=_"Test of the Clans"
        difficulty=4
        gold=2
        recruitlabel=_"Defeated Faction:"
        recruitcolor=wesred
        recruit1="units/human-loyalists/horseman/horseman.png"
        recruit2="units/human-loyalists/lancer/lancer.png"
        recruit3="units/human-loyalists/knight/knight.png~CROP(5,5,72,72)"
        recruit4="units/human-loyalists/dragoon/dragoon.png"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=)
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Alric
            message=_"So! The young prince has found his way to the lands of the Horse Lords."
        [/message]
        {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
            [message]
                speaker=Daryn
                image_pos=right
                mirror=yes
                #po: "old stick" refers to the sceptre of fire
                message=_"Do not expect us, too, to bend the knee just because the princess holds an old stick."
            [/message]
        )} {ELSE(
            [message]
                speaker=Daryn
                image_pos=right
                mirror=yes
                #po: "old stick" refers to the sceptre of fire
                message=_"Do not expect us, too, to bend the knee just because you hold an old stick."
            [/message]
        )} {/IF}
        [message]
            speaker=Ruga
            message=_"You are two children and an old man. What right have you to challenge the throne?"
        [/message]
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message=_"The Horse Clans are powerful and proud. If we cannot prove ourselves to them now, we shall surely have to battle them later, when we attack Weldyn."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        [multihex_image]
            image="units/human-loyalists/horseman/horseman-se-die5.png~RC(magenta>wesred)"
            x,y=65,36
        [/multihex_image]
        [multihex_image]
            image="units/human-loyalists/horseman/horseman-se-die5.png~RC(magenta>wesred)~FL()"
            x,y=63,37
        [/multihex_image]
    )
    (JUSTCOMPLETED_START=
        {MODIFY_UNIT role=horselord side 14} # show them as allied. Don't change their side if they're on Konrad's recall list
        {FIRE_EVENT_UNIT moveto id=Konrad}
        [message]
            speaker=Konrad
            message= _ "Do not forget your pledge, lords of the clans. When Asheviere calls you for aid, let her pleas fall upon deaf ears."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            id=Alric,Daryn,Bayar,Ruga
            message= _ "You have proven yourselves worthy, Your Royal Highnesses, worthy even to claim the throne. I bow my head."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                  S48 - DAN'TONK
#######################################################################################################################################################
{PLACE_POI 51 41 s48
    APPROACH_RADIUS=0

    STATUS_S31=completed
    SCENARIO_FILE=48_Dan_Tonk
    (PREVIEW_WML=
        title=_"Dan’Tonk"
        difficulty=3
        gold=1
        recruitlabel=_"Defeated Faction:"
        recruitcolor=wesred
        recruit1="units/human-loyalists/spearman.png"
        recruit2="units/human-loyalists/javelineer.png"
        recruit3="units/human-loyalists/bowman.png"
        recruit4="units/human-loyalists/fencer.png"
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        {MODIFY_TERRAIN Ce 52 39}
        {MODIFY_TERRAIN Ce 50 41}

        {UNSTORE_NPC Isolde x,y=49,39 side,facing=6,se}
        {GENERIC_UNIT 6 "Spearman"   46 40} {FACING sw}
        {GENERIC_UNIT 6 "Bowman"     46 38} {FACING sw}
        {GENERIC_UNIT 6 "Pikeman"    47 39} {FACING sw}
        {GENERIC_UNIT 6 "Spearman"   47 38} {FACING ne}
        {GENERIC_UNIT 6 "Fencer"     50 39} {FACING se}
        {GENERIC_UNIT 6 "Longbowman" 50 38} {FACING sw}
        {GENERIC_UNIT 6 "Spearman"   51 37} {FACING sw}

        {GENERIC_UNIT 6 "Spearman"   49 42} {FACING sw} # these guys are important; they stop Konrad from moving to the west
        {GENERIC_UNIT 6 "Spearman"   50 41} {FACING se}

        {GENERIC_UNIT 6 "Spearman"   52 35} {FACING se}
        {GENERIC_UNIT 6 "Swordsman"  51 34} {FACING sw}

        {GENERIC_UNIT 6 "Lieutenant" 52 38} {FACING se}
        {GENERIC_UNIT 6 "Spearman"   52 39} {FACING se}
        {GENERIC_UNIT 6 "Bowman"     53 39} {FACING se}
        {GENERIC_UNIT 6 "Spearman"   54 40} {FACING ne}

        [capture_village]
            side=6
            x,y=50,37
            radius=5
        [/capture_village]

        {IF} {VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes} {THEN(
            {GENERIC_UNIT 13 Gryphon  54 41} {FACING ne} {HITPOINTS 10}
            {GENERIC_UNIT 13 Gryphlet 48 41} {FACING ne} {HITPOINTS 31}
        )} {/IF}
    )
    (INCOMPLETE_APPROACHED=
        {MOVE_UNDER_KONRAD( {RECALL_XY    Delfador $stored_konrad.x $stored_konrad.y                  } {MOVE_UNIT id=Delfador $stored_konrad.x  "$($stored_konrad.y+1)"} {MODIFY_UNIT id=Delfador facing sw} )}
        {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar "$($stored_konrad.x-1)" $stored_konrad.y    } {MODIFY_UNIT id=Lisar    facing sw} )}
        [message]
            speaker=Lisar
            message= _ "Hold! We approach the walled city of Dan’Tonk. This was the crowning conquest of my mother’s early days. Its conscripts have made up the bulk of her footmen ever since."
        [/message]
        {IF} {VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes} {THEN(
            [message]
                speaker=Konrad
                message= _ "Are those... gryphons swooping over the city walls? Asheviere must have tried again to seize their eggs, but thanks to our help the gryphons have become strong enough to fight back!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Delfador
                message= _ "That was a dark day... I remember it well. I urged the baron to flee, but in the end we chose to stand and fight — and it cost him his life. So many regrets..."
            [/message]
        )} {/IF}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Delfador $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Delfador} )}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar} )}
    )
    (INCOMPLETE_MOVETO=
        [message]
            speaker=Konrad
            message= _ "When we someday lay siege to Weldyn, Asheviere will surely call upon Dan’Tonk’s footmen to flank us. If we strike now, we can do enough damage to prevent them from marching against us later."
        [/message]
    )

    #############################
    # COMPLETED
    #############################
    (COMPLETED_PRESTART=
        {MODIFY_TERRAIN Ce^Dr 52 39}
        {MODIFY_TERRAIN Gg^Dr 50 41}
        {MODIFY_TERRAIN Gg^Dr 53 39} # prevent Kornad from moving around Isolde's now-much-smaller army

        {PLACE_FIRE 50 40}
        {PLACE_IMAGE "scenery/trash.png" 53 38}
        {PLACE_FIRE 53 38}

        {UNSTORE_NPC Isolde x,y=49,39 side,facing=6,se}
        {GENERIC_UNIT 6 "Spearman"   51 39} {FACING se}
        {GENERIC_UNIT 6 "Spearman"   50 39} {FACING se}
        {GENERIC_UNIT 6 "Spearman"   49 40} {FACING se}
        {GENERIC_UNIT 6 "Bowman"     48 40} {FACING se}
        {GENERIC_UNIT 6 "Spearman"   46 40} {FACING nw}
        {GENERIC_UNIT 6 "Spearman"   47 38} {FACING ne}

        {GENERIC_UNIT 14 "Heavy Infantryman" 52 40} {FACING nw} {ROLE dantonk_contain_guard}
        {GENERIC_UNIT 14 "Shock Trooper"     50 41} {FACING nw}
        {GENERIC_UNIT 14 "Heavy Infantryman" 51 42} {FACING nw}

        [capture_village]
            side=6
            x,y=50,37
            radius=5
        [/capture_village]

        {IF} {VARIABLE_CONDITIONAL bm_s14_gryphons_survived equals yes} {THEN(
            {GENERIC_UNIT 13 Gryphon  47 37} {FACING se} {HITPOINTS 10}
            {GENERIC_UNIT 13 Gryphlet 51 37} {FACING sw} {HITPOINTS 31}
        )} {/IF}
    )
    (JUSTCOMPLETED_START=
        [message]
            role=dantonk_contain_guard
            message= _ "We’re all set up, my lady, and we’ve blocked the roads with rubble. They won’t get through easily."
        [/message]
        [message]
            speaker=Konrad
            message= _ "Well done, everyone — our flank is secure. Asheviere’s position in Weldyn grows weaker each day."
        [/message]
    )
    (COMPLETED_MOVETO=
        [message]
            speaker=Konrad
            message= _ "Although Dan’Tonk remains in the hands of the enemy, it is much diminished. We have neither the time nor the supplies for a protracted siege, so we’ve blocked the road and have left behind enough guards to make any sortie difficult."
        [/message]
    )
}

#######################################################################################################################################################
#                                                                    PILLAGE FARMS
#######################################################################################################################################################
#define PLACE_PILLAGE_FIRE X Y
    {PLACE_FIRE {X} {Y}}
    [terrain]
        {AND x,y,radius={X},{Y},1}
        {AND terrain=*^Gvs}
        layer=overlay
        terrain=^Edt
    [/terrain]
    [terrain]
        {AND x,y,radius={X},{Y},1}
        {AND terrain=Aa^*}
        layer=base
        terrain=Rb
    [/terrain]
#enddef
#define PLACE_PILLAGE_FIRES
    {PLACE_PILLAGE_FIRE 54 49} {PLACE_IMAGE "scenery/trash.png" 54 49}
    {PLACE_PILLAGE_FIRE 52 49}
    {PLACE_PILLAGE_FIRE 52 47} {PLACE_IMAGE "scenery/trash.png" 52 49}
    {PLACE_PILLAGE_FIRE 51 49} {PLACE_IMAGE "scenery/trash.png" 51 49}
    {PLACE_PILLAGE_FIRE 48 46} {PLACE_IMAGE "scenery/trash.png" 48 46}
    {PLACE_PILLAGE_FIRE 57 42}
    {PLACE_PILLAGE_FIRE 51 44} {PLACE_IMAGE "scenery/trash.png" 51 44}
    {PLACE_PILLAGE_FIRE 46 46}
    {PLACE_PILLAGE_FIRE 45 46}
#enddef
# this event is an in-universe way to lower the difficulty for the next scenario
[event]
    name=prestart
    {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals yes} {THEN(
        {PLACE_PILLAGE_FIRES}
    )} {ELSE(
        # put these in a location where Konrad can still access them even after Weldyn's Halberdiers wall him in
        {SET_LABEL 53 49 _"Stockpiles"}
        {PLACE_IMAGE "items/gold-coins-large.png"      52 49}
        {PLACE_IMAGE "items/gold-coins-medium.png"     53 49}
        {PLACE_IMAGE "items/gold-coins-small.png~FL()" 52 48}
        {PLACE_IMAGE "items/gold-coins-small.png"      54 49}
        {PLACE_IMAGE "items/gold-coins-small.png"      54 47}
    )} {/IF}

    [event]
        name=moveto
        first_time_only=no
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=53,49,1} )}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes})}

        #############################
        # EXPLAIN PILLAGE
        #############################
        {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals $null} {THEN(
            {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar "$($stored_konrad.x+1)" $stored_konrad.y} )}
            {MODIFY_UNIT id=Lisar facing sw}
            [message]
                speaker=Lisar
                message=_"Konrad, we’re now deep within the heartland of Wesnoth. While the western farms suffer under Mother’s exorbitant taxes, those surrounding Weldyn — the core of her power base — have grown rich and fat."
            [/message]
            [message]
                speaker=Lisar
                message=_"It’s an unsavory idea, but if we’re desperate, we may need to consider burning the locals’ farms to deprive my mother of their resources.

I’m not suggesting we conscript or kill anyone — these are innocents. But a wealthy farmer can survive losing a few herds or a single year’s harvest. We won’t, if Asheviere defeats us in the end."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar} )}
            {VARIABLE bm_weldyn_pillage explained}
        )} {/IF}

        #############################
        # PILLAGE CHOICE
        #############################
        [message]
            speaker=Konrad
            message=_"An unsavory idea indeed. Razing the region’s farms might be sound military strategy, but I’d still only consider it if we cannot defeat Asheviere otherwise. Weldyn will surely pose a frightenly difficult challenge either way..."
        [/message]
        [message]
            speaker=narrator
            image=none
            message=_"Burning farms will reduce Asheviere’s income and her allies’ reinforcement strength in the final scenario by one-third (accounting for village income too). The final scenario will also have slightly fewer villages."
            [option]
                message=_"Burn it all."
                [command]
                    {SOUND torch.ogg}
                    {SCREEN_FADER 255,165,0 255 500}

                    {REMOVE_LABEL 53 49}
                    {REMOVE_IMAGE 52 49}
                    {REMOVE_IMAGE 53 49}
                    {REMOVE_IMAGE 52 48}
                    {REMOVE_IMAGE 54 49}
                    {REMOVE_IMAGE 54 47}
                    {PLACE_PILLAGE_FIRES}

                    {SCREEN_FADER 0,0,0 0 500}
                    {VARIABLE bm_weldyn_pillage yes}
                [/command]
            [/option]
            [option]
                message=_"Don’t."
                [command]
                [/command]
            [/option]
        [/message]
    [/event]
[/event]

#######################################################################################################################################################
#                                                              S50 - THE BATTLE FOR WESNOTH
#######################################################################################################################################################
[event]
    name=prestart
    {SET_LABEL 59 46 _"★Weldyn"}
[/event]
{PLACE_POI 57 45 s50
    APPROACH_RADIUS=2

    STATUS_S31=completed
    SCENARIO_FILE=50x_Overlook
    (PREVIEW_WML=
        title=_"The Battle for Wesnoth"
        difficulty=5
        gold=0
    )
    #############################
    # INCOMPLETE
    #############################
    (INCOMPLETE_PRESTART=
        #------------------------
        # SCENERY
        #------------------------
        {BRAZIER_DYNAMIC_OVERWORLD 57 48}
        {BRAZIER_DYNAMIC_OVERWORLD 58 44}
        {BRAZIER_DYNAMIC_OVERWORLD 60 46}
        {BRAZIER_DYNAMIC_OVERWORLD 61 44}

        #------------------------
        # OUTER GUARDS
        #------------------------
        {GENERIC_UNIT 17 Halberdier 53 44} {FACING ne} {ROLE weldyn1}
        {GENERIC_UNIT 17 Halberdier 57 43} {FACING sw} {ROLE weldyn2}
        {GENERIC_UNIT 17 Halberdier 55 46} {FACING ne} {ROLE weldyn3}

        # during the final turn (when Konrad has no option but to fight Asheviere)
        # have halberdiers move to block him from leaving, for "a sense of foreboding"
        #
        # There shouldn't be anything worth going back for on the final turn, so this shouldn't be a negative surprise
        [event]
            name=enter hex
            {FILTER( id=Konrad {FILTER_LOCATION x,y,radius=57,45,1} )}
            {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_turns equals $bm_milestone_finale})}
            [cancel_action]
            [/cancel_action]
            {MOVE_UNIT role=weldyn2 56 43}
            {MODIFY_UNIT role=weldyn2 facing se}
            {MOVE_UNIT role=weldyn1 55 44}
            {MOVE_UNIT role=weldyn3 55 45}
            {DELAY 500}
            [message]
                role=weldyn3
                message=_"..."
            [/message]
            [message]
                speaker=Konrad
                message=_"No turning back now."
            [/message]
        [/event]

        #------------------------
        # CITY GUARDS
        #------------------------
        {GENERIC_UNIT 17 "Dark Queen"  59 46} {FACING nw} {LEADER}
        {GENERIC_UNIT 17 "Royal Guard" 58 45} {FACING nw}
        {GENERIC_UNIT 17 "Royal Guard" 60 45} {FACING ne}
        {GENERIC_UNIT 17 "Royal Guard" 59 47} {FACING sw}

        {GENERIC_UNIT 17 Swordsman     63 44} {FACING ne}
        {GENERIC_UNIT 17 Swordsman     61 43} {FACING nw}
        {GENERIC_UNIT 17 Swordsman     60 43} {FACING se}
        {GENERIC_UNIT 17 Lieutenant    62 44} {FACING nw} {LEADER}

        {GENERIC_UNIT 17 Swordsman     57 48} {FACING nw}
        {GENERIC_UNIT 17 Swordsman     56 47} {FACING ne}
        {GENERIC_UNIT 17 Swordsman     55 48} {FACING ne}

        {GENERIC_UNIT 17 Lieutenant    60 48} {FACING se} {LEADER}
        {GENERIC_UNIT 17 Swordsman     60 49} {FACING se}
        {GENERIC_UNIT 17 Swordsman     61 49} {FACING se}
    )
    (INCOMPLETE_APPROACHED=
        [message]
            speaker=Konrad
            message=_"The capital of Wesnoth stands before us. We can challenge Asheviere now, if we choose, but it may be wiser to first fight elsewhere and cut off her allies."
        [/message]
        [message]
            speaker=Konrad
            message=_"I suspect that no matter what we do, we will be forced into a final confrontation eventually."
        [/message]
    )
    (INCOMPLETE_MOVETO=)
}

#undef PLACE_PILLAGE_FIRE
#undef PLACE_PILLAGE_FIRES
#wmlindent: stop ignoring
