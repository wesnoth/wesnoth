#textdomain wesnoth-h2tt

#define HTTT_BIGMAP
    [background_layer]
        image=maps/background.webp
        scale_vertically=yes
        scale_horizontally=no
        keep_aspect_ratio=yes
    [/background_layer]
    [background_layer]
        image=maps/httt.webp
        scale_vertically=yes
        scale_horizontally=no
        keep_aspect_ratio=yes
        base_layer=yes
    [/background_layer]
#enddef

#define SCHEDULE_NOTES
    # don't show these on turn 1, so we can gradually ease the player into things
    [note]
        description= _ "It is spring; the next scenario will have normal days and nights."
        [show_if]
            {VARIABLE_CONDITIONAL bm_tod.id equals spring} {LUA(<< return wesnoth.current.turn>1 >>)}
        [/show_if]
    [/note]
    [note]
        description= _ "It is summer; the next scenario will have unusually long days."
        [show_if]
            {VARIABLE_CONDITIONAL bm_tod.id equals summer} {LUA(<< return wesnoth.current.turn>1 >>)}
        [/show_if]
    [/note]
    [note]
        description= _ "It is autumn; the next scenario will have normal days and nights."
        [show_if]
            {VARIABLE_CONDITIONAL bm_tod.id equals autumn} {LUA(<< return wesnoth.current.turn>1 >>)}
        [/show_if]
    [/note]
    [note]
        description= _ "It is winter; the next scenario will have unusually short days."
        [show_if]
            {VARIABLE_CONDITIONAL bm_tod.id equals winter} {LUA(<< return wesnoth.current.turn>1 >>)}
        [/show_if]
    [/note]
#enddef

# meant to be used like "name={SIGHTED_BIGMAP id=Konrad}"
# can't use "name=sighted", because it doesn't trigger on [lift_fog]
#define SIGHTED_BIGMAP UNIT_FILTER
    enter hex
    {FILTER( side=1 {FILTER_LOCATION( radius={KONRAD_VISION} {FILTER {UNIT_FILTER}} )} )}
#enddef

#define PLACE_PORT X Y
    {PLACE_IMAGE bigmap/poi-port.png {X} {Y}}
    [event]
        name=moveto
        {FILTER id,race,x,y=Konrad,human,{X},{Y}}
        first_time_only=no

        #############################
        # TRANDFORM KONRAD INTO A BOAT
        #############################
        {IF} {VARIABLE_CONDITIONAL bm_explained_port equals $null} {THEN(
            [message]
                speaker=Konrad
                message= _ "This port has many small boats for us to use! I wonâ€™t be able to travel through deep water, but I can certainly reach the coastal islands and reef."
            [/message]
            {SOUND water.wav}
            {VARIABLE bm_explained_port yes}
        )} {/IF}
        [store_unit]
            {FILTER id=Konrad}
            variable=stored_embark_konrad
            kill=yes
        [/store_unit]
        {NAMED_UNIT 1 Skiff $stored_embark_konrad.x $stored_embark_konrad.y Konrad _"Konrad" facing=$stored_embark_konrad.facing}
        [modify_unit]
            {FILTER id=Konrad}
            profile=$stored_embark_konrad.profile
            [object]
                # remove all attacks
                {EFFECT remove_attacks ()}

                # don't get blocked by units
                {EFFECT new_ability (
                    [abilities]
                        [skirmisher]
                            id=bigmap_skirmisher
                            affect_self=yes
                        [/skirmisher]
                    [/abilities]
                )}

                # only allow moving on flat/sand/cave
                {EFFECT movement set={KONRAD_MOVES}}
                {EFFECT movement_costs (
                    replace=yes
                    [movement_costs]
                        shallow_water=1
                        reef=1
                        swamp_water=1
                        flat=5
                        sand=5
                        frozen=5 # so we prefer to stay in water
                        village=5
                        castle=5
                        fungus=20 # this is our POI overlay - we want Konrad to only move onto these if explicitly commanded to
                        deep_water=999
                        forest=999
                        hills=999
                        mountains=999
                    [/movement_costs]
                )}
                {EFFECT defense (
                    replace=yes
                    [defense]
                        dummy_obstacle=60
                    [/defense]
                )}

                # no vision (we handle this manually)
                {EFFECT vision set=0}
            [/object]
            moves={KONRAD_MOVES}
        [/modify_unit]

        #############################
        # TRANSFORM BOAT BACK INTO KONRAD
        #############################
        [event]
            name=enter hex
            {FILTER( id=Konrad {NOT({FILTER_LOCATION terrain=W*^*})} )}
            {FIRE_EVENT disembark_konrad}
        [/event]
        [event]
            name=victory
            {FIRE_EVENT disembark_konrad}
        [/event]
        [event]
            name=disembark_konrad
            [store_unit]
                {FILTER id,type=Konrad,Skiff}
                variable=stored_skiff
                kill=yes
            [/store_unit]
            [unstore_unit]
                variable=stored_embark_konrad
                x,y=$stored_skiff.x,$stored_skiff.y
            [/unstore_unit]
            {CLEAR_VARIABLE stored_skiff}
        [/event]
    [/event]
#enddef

# TEMPLATE - EXAMPLE USAGE

#     {PLACE_POI 16 42 s05
#         SCENARIO_FILE=99_Dummy_Scenario
#         (PREVIEW_WML=
#             title=_"The Bay of Pearls"
#             difficulty,gold=1,1
#             recruit1=units/merfolk/brawler.png
#             recruit2=units/merfolk/fighter.png
#             recruit3=units/merfolk/hunter.png
#             recruit4=units/merfolk/initiate.png
#         )
#         #############################
#         # INCOMPLETE
#         #############################
#         (INCOMPLETE_PRESTART=
#
#         )
#         (INCOMPLETE_SIGHTED=
#
#         )
#
#         #############################
#         # FAILED
#         #############################
#         (FAILED_PRESTART=
#
#         )
#         (FAILED_MOVETO=
#
#         )
#
#         #############################
#         # COMPLETED
#         #############################
#         (COMPLETED_PRESTART=
#
#         )
#         (JUSTCOMPLETED_START=
#
#         )
#         (COMPLETED_MOVETO=
#
#         )
#     }

#######################################################################################################################################################
#                                                                     POI HELPER MACRO
#######################################################################################################################################################
#define PLACE_POI X Y SNUM
#arg SCENARIO_FILE
#endarg
#arg PREVIEW_WML
#endarg
#arg CONDITION
    [true]
[/true]#endarg
#arg STATUS_S31 # for performance, we only load POIs when they're actually accessible to the player
$null#endarg    # $status_s31 is also used in unified_characters.cfg to determine Konrad's gold

#arg INCOMPLETE_PRESTART
#endarg
#arg APPROACH_RADIUS
4#endarg
#arg INCOMPLETE_APPROACHED
#endarg
#arg INCOMPLETE_MOVETO
#endarg
#arg INCOMPLETE_BEFORE_SCENARIO
#endarg
#arg INCOMPLETE_MOVETO_CANCEL
#endarg

#arg FAILED_PRESTART
#endarg
#arg FAILED_MOVETO
#endarg

#arg COMPLETED_PRESTART
#endarg
#arg COMPLETED_MOVETO
#endarg
#arg JUSTCOMPLETED_PRESTART
#endarg
#arg JUSTCOMPLETED_START
#endarg
    #############################
    # INCOMPLETE
    #############################
    [event]
        name=prestart
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals $null} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {PLACE_IMAGE bigmap/poi-battle.png {X} {Y}}
        {INCOMPLETE_PRESTART}
    [/event]
    # approach event. This triggers before moveto, even if APPROACH_RADIUS=0
    [event]
        name=enter hex
        first_time_only=no
        {FILTER( side=1 {FILTER_LOCATION( x,y,radius={X},{Y},{APPROACH_RADIUS} )} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals $null} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL approached_{SNUM} equals $null} )}
        [cancel_action]
        [/cancel_action]
        [lift_fog]
            {FILTER_SIDE side=1}
            x,y={X},{Y}
            radius=3
        [/lift_fog]
        [remove_shroud]
            {FILTER_SIDE side=1}
            x,y={X},{Y}
            radius=3
        [/remove_shroud]
        {VARIABLE approached_{SNUM} yes} # do this before {INCOMPLETE_APPROACHED}, so that we can choose to clear it if we want
        {VARIABLE previous_x $x2}{VARIABLE previous_y $y2} # normally these would be event variables, but we need to set them manually so that 'preview_poi_{SNUM}' gets them
        {INCOMPLETE_APPROACHED}
    [/event]

    # moveto event (preview the battle)
    [event]
        name=enter hex
        first_time_only=no
        {FILTER id,x,y=Konrad,{X},{Y}}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals $null} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {VARIABLE previous_x $x2}{VARIABLE previous_y $y2} # normally these would be event variables, but we need to set them manually so that 'preview_poi_{SNUM}' gets them
        {FIRE_EVENT_UNIT preview_poi_{SNUM} id=$unit.id}
    [/event]
    [event]
        name=preview_poi_{SNUM}
        first_time_only=no # event name is used in other places
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals $null} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}

        {IF} {VARIABLE_CONDITIONAL skip_next_poi_moveto equals yes} {THEN(
            {CLEAR_VARIABLE skip_next_poi_moveto}
        )} {ELSE(
            [cancel_action]
            [/cancel_action]

            # execute arg moveto WML
            {INCOMPLETE_MOVETO}

            {IF} {VARIABLE_CONDITIONAL skip_next_poi_moveto equals yes} {THEN(
                {CLEAR_VARIABLE skip_next_poi_moveto}
            )} {ELSE(
                # preview scenario
                [display_scenario_preview]
                    {PREVIEW_WML}
                    scenario={SNUM}
                [/display_scenario_preview]
                {IF} {VARIABLE_CONDITIONAL status_{SNUM} equals in_progress} {THEN(
                    {INCOMPLETE_BEFORE_SCENARIO}
                    [endlevel]
                        result=victory
                        next_scenario={SCENARIO_FILE}
                        bonus=no
                        carryover_report=no
                        replay_save=no
                        linger_mode=no
                        reveal_map=no
                        {NEW_GOLD_CARRYOVER 100}
                    [/endlevel]
                )} {ELSE(
                    {MOVE_UNIT id=$unit.id $previous_x $previous_y}
                    {INCOMPLETE_MOVETO_CANCEL}
                )} {/IF}
            )} {/IF}
            {CLEAR_VARIABLE previous_x,previous_y}
        )} {/IF}
    [/event]
    #############################
    # FAILED
    #############################
    [event]
        name=prestart
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals failed} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {PLACE_IMAGE bigmap/poi-failed.png {X} {Y}}
        {FAILED_PRESTART}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        {FILTER id,x,y=Konrad,{X},{Y}}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals failed} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {FAILED_MOVETO}
    [/event]
    #############################
    # COMPLETED
    #############################
    # just barely completed
    [event]
        name=prestart # this happens 1st
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals in_progress} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        [remove_shroud]
            {FILTER_SIDE side=1}
            x,y={X},{Y}
            radius={KONRAD_VISION}
        [/remove_shroud]
        [lift_fog]
            {FILTER_SIDE side=1}
            x,y={X},{Y}
            radius={KONRAD_VISION}
            multiturn=yes
        [/lift_fog]
        {SCROLL_TO {X} {Y}}
        {JUSTCOMPLETED_PRESTART}
        [event]
            name=start # this happens 3rd
            {FILTER_CONDITION( {CONDITION} )}
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
            {DELAY 500}{RECALL_XY Konrad {X} {Y}}
            {JUSTCOMPLETED_START}
        [/event]
        {VARIABLE status_{SNUM} completed}
    [/event]
    # completed, either now or earlier
    [event]
        name=prestart # this happens 2nd
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals completed} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {PLACE_IMAGE bigmap/poi-completed.png {X} {Y}}
        {COMPLETED_PRESTART}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        {FILTER id,x,y=Konrad,{X},{Y}}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_{SNUM} equals completed} )}
        {FILTER_CONDITION( {CONDITION} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s31 equals {STATUS_S31}} )}
        {COMPLETED_MOVETO}
    [/event]
#enddef
