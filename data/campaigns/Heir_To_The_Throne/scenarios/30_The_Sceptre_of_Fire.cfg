#textdomain wesnoth-h2tt

#
# SCENARIO_TURN_LIMIT plus SCEPTRE_SURVIVAL_TURNS is used for an achievement
#

#define SCENARIO_TURN_LIMIT
25#enddef

#define SCEPTRE_SURVIVAL_TURNS
15#enddef

#define SCEPTRE_REMINDER_1
10#enddef

#define SCEPTRE_REMINDER_2
13#enddef

[scenario]
    id=30_The_Sceptre_of_Fire
    map_file=30a_The_Sceptre_of_Fire.map
    name=_"The Sceptre of Fire"
    next_scenario=00_The_Great_Continent
    victory_when_enemies_defeated=no
    {UNDERGROUND}
    turns={SCENARIO_TURN_LIMIT}
    {SCENARIO_MUSIC the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}
    {EXTRA_SCENARIO_MUSIC suspense.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE SHROUD=yes FOG=yes}

    #############################
    # MONSTERS
    #############################
    [side]
        side=2
        controller=ai
        color=orange
        type="Fire Ant Queen"
        id=ant_leader
        facing=nw
        gold=0
        income={ON_DIFFICULTY4 0 2 4 6}
        recruit={ON_DIFFICULTY4 "Fire Ant" "Fire Ant" "Firebane Ant,Firebomb Ant" "Firebane Ant,Firebomb Ant"}
        village_gold=0 # lots of villages, so reduce village income to 0 so that we don't need massive negative income to balance it out
        team_name=monsters
        user_team_name=_"Monsters"
    [/side]
    {STARTING_VILLAGES 2 10}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3 no 0.9 0.1}
        {AUTOENRAGE 2 0}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 0.5 x,y,radius=28,1,10})} # hang around near the sceptre; don't wander off
    [/event]
    [side]
        side=3
        controller=ai
        color=brown
        no_leader=yes
        hidden=yes
        team_name=monsters
        user_team_name=_"Monsters"
    [/side]

    #############################
    # WESNOTH
    #############################
#define WESNOTH_SIDE SIDE HIDDEN RECRUIT_LIST INCOME
    [side]
        side={SIDE}
        controller=ai
        color=wesred
        no_leader=yes
        hidden={HIDDEN} # leave Li'sar's sides unhidden, so the player can see their gold going up each turn
        gold,income=0,{INCOME} # high income, but no gold. The longer you take to reach the Sceptre, the more gold they'll have
        recruit={RECRUIT_LIST}
        village_gold=0 # lots of villages, so reduce village income to 0 so that we don't need massive negative income to balance it out (which is especially challenging to do across difficulties...)
        team_name=wesnoth
        user_team_name=_"Li’sar"
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 2}
#enddef
    {WESNOTH_SIDE 4 no  "Shock Trooper,Duelist" {ON_DIFFICULTY4 1 4 7 10}}
    {WESNOTH_SIDE 5 yes "Spearman,Swordsman"    {ON_DIFFICULTY4 1 4 7 10}}
    {WESNOTH_SIDE 6 yes "Mage,Red Mage"         {ON_DIFFICULTY4 1 4 7 10}}
    {WESNOTH_SIDE 7 yes "Bowman,Longbowman"     {ON_DIFFICULTY4 1 4 7 10}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Heavy Infantryman" {ON_DIFFICULTY4 1 1 0 0}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Fencer"            {ON_DIFFICULTY4 1 1 0 0}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Bowman"            {ON_DIFFICULTY4 1 1 0 0}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Spearman"          {ON_DIFFICULTY4 2 2 0 0}} # including 1 guard on all difficulties
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Spearman"          {ON_DIFFICULTY4 1 1 0 0}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Iron Mauler"       {ON_DIFFICULTY4 0 0 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Master at Arms"    {ON_DIFFICULTY4 0 0 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Halberdier"        {ON_DIFFICULTY4 0 0 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Arch Mage"         {ON_DIFFICULTY4 0 0 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Master Bowman"     {ON_DIFFICULTY4 0 0 1 2}}

    [event]
        name=side 4 turn
        first_time_only=no
        {RESET_SIDE_AI 4,5,6,7 no 1 0.1}
        # if Konrad has units near Lisar (reachable, not hanging around in the chasm), pull our attacking units back to help
        [store_reachable_locations]
            {FILTER id=Lisar}
            range=vision # ignore ZoC and ignore current moves
            variable=near_lisar
        [/store_reachable_locations]
        {IF} {HAVE_UNIT( side=1 {FILTER_LOCATION find_in=near_lisar} )} {THEN(
            {MODIFY_SIDE_AI 4 ({GOAL_LOCATION 9 x,y,radius=6,25,4})}
        )} {/IF}
    [/event]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE "items/boxes.png~FL()" 5 26}
        {PLACE_IMAGE "items/box.png~FL()"   4 25}
        {PLACE_IMAGE "items/box.png~FL()"   1 26}

        #############################
        # RUSHERS
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpling" "Giant Scorpion"  "Giant Scorpion"  "Giant Scorpion" }) 12 13 ()}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"            "none"            "Giant Scorpling" "Giant Scorpling"}) 12 13 ()}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpling" "Giant Scorpion"  "Giant Scorpling" "Giant Scorpion" }) 15  7 ()}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpling" "Giant Scorpling" "Giant Scorpling" "Giant Scorpling"}) 15  7 ()}

        #############################
        # NORTH PATH
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Spider"    "Giant Spider"    "Giant Spider"    "Giant Spider"   })  2 12 ({FACING se}{ROLE spiders3}{ZONE_GUARDIAN  2 12 (radius=4 {FILTER role=spiders3})}) }
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"            "Giant Spider"    "Giant Spider"    "Giant Spider"   })  6 11 ({FACING sw}{ROLE spiders3}{ZONE_GUARDIAN  6 11 (radius=4 {FILTER role=spiders3})}) }
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"            "none"            "Giant Spider"    "Giant Spider"   })  8  7 ({FACING sw}{ROLE spiders4}{ZONE_GUARDIAN  8  7 (radius=3 {FILTER role=spiders4})}) }
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"            "none"            "none"            "Giant Spider"   }) 15  8 ({FACING sw}{ROLE spiders4}{ZONE_GUARDIAN 15  8 (radius=3 {FILTER role=spiders4})}) }

        #############################
        # SOUTH PATH
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpion"  "Giant Scorpion" "Giant Spider" "Giant Spider"}) 18 20 ({FACING sw}{ROLE spiders1}{ZONE_GUARDIAN 18 20 (radius=5 {FILTER role=spiders1})}) }
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpion"  "Giant Scorpion" "Giant Spider" "Giant Spider"}) 14 18 ({FACING se}{ROLE spiders1}{ZONE_GUARDIAN 14 18 (radius=5 {FILTER role=spiders1})}) }

        # 24,13 is in the perfect spot to 1) stop Delfador from soloing the ants, and 2) not immediately get in the way for part 2, if they survive that long
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpion"  "Giant Spider" "Giant Spider" "Giant Spider"}) 24 13 ({FACING se}{ROLE spiders2}{ZONE_GUARDIAN 24 13 (radius=5 {FILTER role=spiders2})}) }
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpion"  "none"         "Giant Spider" "Giant Spider"}) 27 18 ({FACING sw}{ROLE spiders2}{ZONE_GUARDIAN 27 18 (radius=5 {FILTER role=spiders2})}) }
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Giant Scorpling" "none"         "none"         "Giant Spider"}) 28 14 ({FACING se}{ROLE spiders2}{ZONE_GUARDIAN 28 14 (radius=5 {FILTER role=spiders2})}) }

        #############################
        # ANT EGGS
        #############################
        {REPEAT ({ON_DIFFICULTY4 1 2 3 4}) ({GENERIC_UNIT 2 (Fire Ant Egg) 19  4})}
        {REPEAT ({ON_DIFFICULTY4 1 2 3 4}) ({GENERIC_UNIT 2 (Fire Ant Egg) 23  5})}
        {REPEAT ({ON_DIFFICULTY4 1 2 3 4}) ({GENERIC_UNIT 2 (Fire Ant Egg) 27  7})}
        [modify_unit]
            {FILTER x,y=27,6}
            x,y=28,6 # Can't use TELEPORT_UNIT or `passable=yes` because eggs have 0% defense on all terrain
        [/modify_unit]

        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SWITCH_KONRAD_PORTRAIT "adult" ""}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        #############################
        # INITIAL DIALOGUE
        #############################
        [message]
            side=2
            caption=""
            image=none  # can't use narrator, since Konrad doesn't exist yet
            message="<i>" + _ "The last dwarvish ruin far behind them, the party descended into the deepest parts of the hewn caverns. Except for disturbances caused by the occasional rodent, the air in the lower passages was still and tomblike." + "</i>"
        [/message]
        [message]
            side=2
            caption=""
            image=none  # can't use narrator, since Konrad doesn't exist yet
            message="<i>" + _ "Stepping through a low corridor, Konrad and Delfador emerged from the maze-like catacombs into icy blackness. Darkness seemed to crush them. Lights flickered and went out. Even the staff of the elder mage struggled to produce enough light to see by." + "</i>"
        [/message]
        [message]
            side=2
            caption=""
            image=none  # can't use narrator, since Konrad doesn't exist yet
            message="<i>" + _ "A cavernous void stretched out ahead, across which no ceiling or walls were visible. Wind howled and whipped over narrow ledges bridging the depths, almost as if animated by powerful nearby magic... and approaching evil." + "</i>"
        [/message]

        #############################
        # KONRAD ARRIVES
        #############################
        [change_theme]
        [/change_theme]
        {REVEAL x,y,radius=3,24,4}
        {UNSTORE_NPC Delfador x,y=5,23 side,facing=1,sw}
        {REMOVE_OBJECT dont_levitate id=Delfador}
        # set Delfador's recruits again now, because they might have been affected by Elensefar
        [set_extra_recruit]
            id=Delfador
            extra_recruit=Mudcrawler,Giant Mudcrawler,Fire Guardian,Fire Wraith
        [/set_extra_recruit]
        [capture_village]
            side=1
            x,y=2,24
            radius=8
        [/capture_village]
        {RECALL_KONRAD_AND_COMPANIONS 2 23}
        [message]
            speaker=Konrad
            message=_"We’ve been traveling for days upon days. Surely the Sceptre is getting close!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Yes, I feel it is near here. It calls out to be freed... it is near; very near! The Sceptre was forged here, not far where we now stand. The sheer power of it!"
        [/message]
        [companion_message]
            message_Kalenz=_"It is the fault of my people — Landar’s rebels — that the Sceptre was lost. It is only fair that I help get it back. Which way should we go, Delfador?"
            message_Chantal=_"It is the fault of my people — Landar’s rebels — that the Sceptre was lost. It is only fair that I help get it back. Which way should we go, Delfador?"
            message_Harper=_"Growin’ up they used to tell me fairytales about the Sceptre... Never thought I might actually be seein’ it in person. Which way do we go, Delfador?"
            message_Moremirmu=_"Yea, the hallowed fire shall bring Light to the places of darkness! So proclaim the texts, and so shall it be. Where can the Sceptre be found, scholar?"
            message_Ulfdain=_"’twere my people who made it fer ye humans, and ’twere my people who lost it, long ago. Now ’tis only right that I help ye get it back. Where be the Sceptre, scholar?"
            message_Jeniver=_"I’ve read so much about the lost Sceptre of Fire! I never though I would, well, actually help <i>find</i> it. Where do we go, Delfador?"
            message_Seimus=_"It’s overwhelming! I never— well, Delfador, thank you for trusting me to be here with you. Where shall we start the search?"
            message_Dosh=_"Dis cave good place for troll, but no good place for softskins. Better find your scep-tar an’ get back to sun-lit places. Which way should we start?"
            fallback_Konrad=_"Very well — then where? How do we find it?"
        [/companion_message]
        [message]
            speaker=Delfador
            message=_"North and east. More than that, I cannot tell. Whatever beasts, monsters, and other denizens of the dark lurk ahead, I know that we shall prevail."
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat the enemy leader"
                condition=win
            [/objective]
            [objective]
                #po: this is deliberately vague, and foreshadows Li'sar's appearance in part two of this scenario
                description= _ "Then, fight to claim the Sceptre"
                condition=win
            [/objective]
            {TURNS_RUN_OUT}
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage=40
                bonus=no
            [/gold_carryover]
            [note]
                description= _ "The longer you take to defeat the enemy leader, the more time your other enemies will have to accrue gold."
            [/note]
        [/objectives]
    [/event]

    #############################
    # KONRAD IS WORRIED
    #############################
    [event]
        name=turn 2
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"Delfador, you’ve told me the importance of the Sceptre of Fire. And I believe you! A powerful magical artifact, and the fabled symbol of the kings of Wesnoth. With the Sceptre in my hand even Asheviere would struggle to deny my claim to the throne."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"Yet it pains me to know that while we delve deep under these mountains, countless people back home are suffering. Elves, men, dwarves; people we’ve missed out helping because we had to come here instead. I hope it’ll be worth it in the end."
        [/message]
    [/event]

    #############################
    # FORESHADOW HEIR
    #############################
    [event]
        name=turn 8
        [message]
            speaker=Konrad
            message=_"Delfador... other than the prophecy about the Sceptre, you haven’t been keeping any other secrets from me “for my own good”, have you?"
        [/message]
        [message]
            speaker=Delfador
            message=_"One. But I ask you to restrain your curiosity, for I hope it will never have to come to light. Here and now, we must focus on finding the Sceptre if you are ever to become king."
        [/message]
    [/event]

    #############################
    # TRACK SHROUD
    #############################
    # need to track shroud, so that we can offset and restore it in part_two (multiple times!)
    [event]
        name=moveto,unit placed
        first_time_only=no
        {FILTER side=1}
        {FILTER_CONDITION({NOT({HAVE_UNIT id=Lisar})})} # this also fixes an issue where unstoring Warven might trigger this
        [store_reachable_locations]
            {FILTER id=$unit.id}
            variable=stored_s30_unshroud_tmp
            range=vision
        [/store_reachable_locations]
        [set_variables]
            name=stored_s30_unshroud
            mode=append
            to_variable=stored_s30_unshroud_tmp
        [/set_variables]
        {CLEAR_VARIABLE stored_s30_unshroud_tmp}
        [allow_undo]
        [/allow_undo]
    [/event]

    #############################
    # REACH SCEPTRE
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=24,7,1} )}
        {FILTER_CONDITION({NOT({HAVE_UNIT id=Lisar})})}
        [message]
            speaker=Konrad
            message=_"What a strange rock formation. Could this be the resting place of the Sceptre?"
        [/message]
        [message]
            speaker=Delfador
            message=_"There is some power about it, to be sure. But we must clear out the leader of the local fauna before we can investigate further."
        [/message]
        [allow_undo]
        [/allow_undo]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        id=part_one_time_over
        {FILTER_CONDITION({NOT({HAVE_UNIT id=Lisar})})}
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"We’ve been wandering for so long, and we still haven’t cleared our way to the Sceptre."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"Even if it really is somewhere here, I fear it is beyond our power to obtain..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #############################
    # ANT QUEEN KILLED
    #############################
    [event]
        name=die
        {FILTER id=ant_leader}
        {KILL_COUNT 5 (side=2 {NOT id=ant_leader}) ANIMATE=yes}
        {KILL side=2}

        # manually award XP to whoever killed the ant queen, since we need to kill/store/unstore as part of the cutscene, which breaks the normal death
        [modify_unit]
            {FILTER id=$second_unit.id}
            experience="$( $this_unit.experience + 24 )"
        [/modify_unit]

        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message=_"That wasn’t so bad! The vermin are defeated, and the way is clear to explore further."
        [/message]
        [message]
            speaker=Delfador
            message=_"I sense great power emanating from the chasm nearby. Everyone, gather round."
        [/message]
        {FIRE_EVENT part_two}
    [/event]

    #######################################################################################################################################################
    #                                                                       PART TWO INTRO
    #######################################################################################################################################################
    [event]
        name=part_two
        #############################
        # REPLACE MAP
        #############################
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {SCREEN_FADER 0,0,0 255 500}
        {REMOVE_IMAGE 0-99 0-99}
        {FADE_MUSIC_OUT 500}

        {VARIABLE sceptre_first_turn $turn_number}
        [modify_turns]
            value="$($turn_number + {SCEPTRE_SURVIVAL_TURNS})"
        [/modify_turns]

        # store info and replace map
        [store_unit]
            {FILTER({NOT x,y=recall,recall})}
            variable=stored_s30_units
            kill=yes
        [/store_unit]
        [store_locations]
            owner_side=1
            variable=stored_s30_villages
        [/store_locations]
        [replace_map]
            map_file=30b_The_Sceptre_of_Fire.map
            expand=yes
            shrink=yes
        [/replace_map]

        # end player turn, so that we get a new autosave
        [remove_event]
            id=part_one_time_over
        [/remove_event]
        [end_turn]
        [/end_turn]
        [event]
            name=new turn
            {FIRE_EVENT part_two_newturn}
        [/event]
    [/event]
    [event]
        name=part_two_newturn
        # adjust and update units
        [foreach]
            array=stored_s30_units
            [do]
                [unstore_unit]
                    variable=this_item
                    find_vacant=yes
                    check_passability=yes
                    x="$( max([ 1, $this_item.x - 4]) )"
                    y="$( min([30, $this_item.y + 9]) )"
                [/unstore_unit]
                {IF} {VARIABLE_CONDITIONAL this_item.side equals 1} {THEN(
                    {TELEPORT_UNIT id=$this_item.id 19 13}
                )} {/IF}
            [/do]
        [/foreach]

        # adjust and update villages
        [foreach]
            array=stored_s30_villages
            [do]
                {VARIABLE this_item.x "$( max([ 1, $this_item.x - 4]) )"}
                {VARIABLE this_item.y "$( min([30, $this_item.y + 9]) )"}
            [/do]
        [/foreach]
        [capture_village]
            side=1
            find_in=stored_s30_villages
        [/capture_village]
        {CLEAR_VARIABLE stored_s30_units,stored_s30_villages}

        # adjust and update shroud
        [foreach]
            array=stored_s30_unshroud
            [do]
                {VARIABLE this_item.x "$( max([ 1, $this_item.x - 4]) )"}
                {VARIABLE this_item.y "$( min([30, $this_item.y + 9]) )"}
            [/do]
        [/foreach]
        [remove_shroud]
            side=1
            find_in=stored_s30_unshroud
        [/remove_shroud]
        [reset_fog]
            {FILTER_SIDE side=1}
            reset_view=yes
        [/reset_fog]

        {GOLD_PICKUP 40 13 items/gold-coins-medium.png 55 _"55 gold" _"Li’sar’s soldiers have stockpiled some gold here! We’ll put it to better use."}

        #############################
        # MOVE UNITS
        #############################
        # move Konrad, Delfador, and all your other units
        {SCROLL_TO 21 14}
        {TELEPORT_UNIT id=Konrad   21 14} {MODIFY_UNIT id=Konrad facing sw}
        {TELEPORT_UNIT id=Delfador 17 16} {MODIFY_UNIT id=Delfador facing ne}

        # move a few of our other units to various different hexes, so they're less obviously clumped up
        {TELEPORT_UNIT x,y=18,11 23 17}
        {TELEPORT_UNIT x,y=17,12 24 16}
        {TELEPORT_UNIT x,y=19,11 23 16}
        {TELEPORT_UNIT x,y=17,13 22 17}
        {TELEPORT_UNIT x,y=18,12 23 17}
        {TELEPORT_UNIT x,y=19,12 23 16}

        # refresh moves and attacks, but not HP
        [heal_unit]
            {FILTER side=1}
            amount=0
            restore_statuses=no
            restore_attacks=yes
            moves=full
        [/heal_unit]

        # refresh shroud
        [place_shroud]
            side=1
            x,y=0-99,0-99
        [/place_shroud]
        {REDRAW}

        #############################
        # NARRATION
        #############################
        [message]
            speaker=narrator
            message="<i>" + _ "Near the chasm, the air almost crackled with magical energy. It also became steadily warmer. The floor was smooth and glassy in places, and a faint glow provided a small reprieve from the thick blackness. Volcanic fumes drifted up from cracks in the floor." + "</i>"
        [/message]
        [message]
            speaker=narrator
            message="<i>" + _ "Distant rumbles and earthquakes made it difficult to keep steady footing. The very earth had come alive, heaving, struggling to be relieved of its centuries-old burden..." + "</i>"
        [/message]
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 0}
        {SCREEN_FADER 0,0,0 000 500}
        [change_theme]
        [/change_theme]

        #############################
        # INTRODUCE SCEPTRE
        #############################
        [message]
            speaker=Delfador
            message=_"We are here. The Sceptre... the earth... the fire... the air around us... everything! It calls out to be freed — I can barely hold it back in my mind."
        [/message]
        [companion_message]
            message_Kalenz=_"I sense it too... there is a strangeness in the air. A fire in the soul of this place. But where? The cave is empty!"
            message_Chantal=_"I sense it too... there is a strangeness in the air. A fire in the soul of this place. But where? The cave is empty!"
            message_Ulfdain=_"Aye, tha’s nice... except there’s nothin’ here, ye cloud-headed flapdragon! It’s an empty cave!"
            message_Harper=_"Err... is this one o’ those confusing wizard things? Where’s the Sceptre? Th’ cave looks pretty empty to me."
            message_Moremirmu=_"Yea, truly there is a strangeness in the air here... not of the Light, but of something else entirely. But where is the source? The cave stands empty."
            message_Jeniver=_"Err... it— it does? I don’t see anything... Oh! Is this a metaphor? The real treasure is the friends we made along the way?"
            message_Dosh=_"Dey say trolls are slow, but even Dosh can see dere’s nothing here. Flat and empty. Nothing for us to take, is dere?"
            fallback_Konrad=_"But where is it? I don’t see a thing!"
        [/companion_message]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"On the contrary! My research leads me to believe that we stand in the center of a dormant volcano, which erupted centuries ago and buried the Sceptre in rock. It is indeed here, under the cave floor."
        [/message]
        {MOVE_UNIT id=Delfador 20 16}
        {REDRAW}

        {MODIFY_UNIT id=Delfador moves 0}
        {DELAY 250}
        {ANIMATE_ATTACK id=Delfador range=ranged yes x,y=21,16}
        [event]
            name=side 1 turn refresh,delfador_digs_for_sceptre
            first_time_only=no
            {MODIFY_UNIT id=Delfador moves 0}
            {MODIFY_UNIT id=Delfador facing ne}
            {REPEAT 2 (
                {RANDOM "a,b,c,d,e"}
                {IF} {VARIABLE_CONDITIONAL random equals a} {THEN({ANIMATE_ATTACK id=Delfador range=ranged yes x,y=19,16})} {/IF}
                {IF} {VARIABLE_CONDITIONAL random equals b} {THEN({ANIMATE_ATTACK id=Delfador range=ranged yes x,y=20,15})} {/IF}
                {IF} {VARIABLE_CONDITIONAL random equals c} {THEN({ANIMATE_ATTACK id=Delfador range=ranged yes x,y=21,16})} {/IF}
                {IF} {VARIABLE_CONDITIONAL random equals d} {THEN({ANIMATE_ATTACK id=Delfador range=ranged yes x,y=21,17})} {/IF}
                {IF} {VARIABLE_CONDITIONAL random equals e} {THEN({ANIMATE_ATTACK id=Delfador range=ranged yes x,y=20,17})} {/IF}
                {CLEAR_VARIABLE random}
                {DELAY 500}
            )}
        [/event]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mad}
            message=_"It shall take time, but my magic can dig the Sceptre out."
        [/message]
        {FIRE_EVENT delfador_digs_for_sceptre}
        {QUAKE cave-in.ogg}
        {DELAY 1000}

        {FIRE_EVENT delfador_digs_for_sceptre}
        {QUAKE cave-in.ogg}
        {DELAY 1000}

        #############################
        # INTRODUCE LISAR
        #############################
        {KILL side,x,y=3,1-15,19-99}
        # kill off any spiders that are REALLY close to Li'sar. Slightly further away ones can live, and will serve to slow down her advance
        # (the surviving spiders' zone guardians will also go haywire, but that's ok)

        {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC primal-carnage.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}

        {UNSTORE_NPC Lisar x,y=1,28 side,facing=4,ne}
        [capture_village]
            side=4
            x,y=8,25
            radius=6
        [/capture_village]
        [capture_village]
            side=4
            x,y=40,14
            radius=7
        [/capture_village]
        {REVEAL x,y,radius=2,27,2}
        {SCROLL_TO 2 27}
        {DELAY 500}
        [message]
            speaker=Lisar
            message=_"A sound like that can mean only one thing: Konrad and his handler have reached the Sceptre of Fire."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Princess Li’sar! Villain! Asheviere’s greed must extend far if she would risk her last child this far from Wesnoth, deep under the northern mountains."
        [/message]
        {REVEAL x,y,radius=5,26,5}
        {MOVE_UNIT id=Lisar 6 25}
        {MODIFY_TERRAIN Ke 6 25} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 7 26} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 7 25} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 6 24} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 5 25} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 5 26} {REDRAW} {DELAY 150}
        {GENERIC_UNIT 4 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"}) 7 26} {ANIMATE}
        {GENERIC_UNIT 4 ({ON_DIFFICULTY4 "Fencer"            "Fencer"            "Duelist"           "Duelist"      }) 7 25} {ANIMATE} {GUARDIAN}
        {GENERIC_UNIT 4 ({ON_DIFFICULTY4 "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"     "Shock Trooper"}) 6 24} {ANIMATE} {GUARDIAN}
        {UNSTORE_NPC Mirya x,y=5,25 side=4}
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"Loyalists, this is it. Within these caves lurks my usurping cousin; the false prince; the puppet of Delfador."
        [/message]

        #############################
        # LISAR SPEECH
        #############################
        # build a speech for Li'sar that references events specific to this playthrough
        {VARIABLE phrase_count 0}
#define BUILD_SPEECH SNUM MESSAGE
    {IF}
    {VARIABLE_CONDITIONAL status_{SNUM} equals completed}
    {VARIABLE_CONDITIONAL phrase_count less_than 4} # max 4 phrases
    {THEN(
        {IF}{VARIABLE_CONDITIONAL phrase_count equals 0}
        {THEN( {VARIABLE lisar_speech {MESSAGE}}                           )}
        {ELSE( {VARIABLE lisar_speech ($lisar_speech| + ", " + {MESSAGE})} )}
        {/IF}
        {VARIABLE_OP phrase_count add 1}
    )} {/IF}
#enddef
        {BUILD_SPEECH s10  (_"your comrades dead at Elensefar")}
        {BUILD_SPEECH s11  (_"Elensefar ruled by thieves")}
        {BUILD_SPEECH s13  (_"supplies pillaged at Fort Tahn")}
        {BUILD_SPEECH s13  (_"convoys burning outside Dan’Tonk")}
        {BUILD_SPEECH s07  (_"zombified townsfolk at the peninsula")}
        {BUILD_SPEECH s26  (_"dead slaves at the Dwarven Doors")}
        {BUILD_SPEECH s06  (_"libraries burning at Alduin")}
        {BUILD_SPEECH s03  (_"rebels at Blackwater Port")}
        {BUILD_SPEECH s04  (_"riots at the Bay of Pearls")}
        {BUILD_SPEECH s15b (_"undead amok in the hills")}
        {BUILD_SPEECH s02  (_"elvish criminals escaping into the south")}
        {BUILD_SPEECH s22  (_"trouble with the orcs at Glamdrol")}
        {BUILD_SPEECH s20  (_"corpses clogging up the Ford")}
        {BUILD_SPEECH s14  (_"blood-stained slopes on Gryphon Mountain")}
        {IF} {VARIABLE_CONDITIONAL phrase_count greater_than_equal_to 2}
        {THEN( {VARIABLE lisar_speech (_": $lisar_speech.")} )}
        {ELSE( {VARIABLE lisar_speech (_". You have heard the lies he tells, misleading those who would otherwise oppose him")} )}
        {/IF}
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            #po: several of the strings above are joined to create $lisar_speech.
            #po: For example, this message might read something like "in his wake: dead slaves at the Dwarven Doors, zombified townsfolk at the peninsula... Today, we put a stop to it."
            #po: If translating a dynamic string like this is difficult or impossible in your language, you can replace $lisar_speech with ". You have heard the lies he tells, misleading those who would otherwise oppose him."
            message=_"You know the blood and chaos that follow in his wake$lisar_speech|... Today, we put a stop to it. Is everyone in position?"
        [/message]
        {CLEAR_VARIABLE phrase_count,lisar_speech}

        #############################
        # INTRODUCE ENEMY LEADERS
        #############################
        # northwest
        {UNSTORE_NPC Warven x,y=6,3 side,facing=5,se}
        {GENERIC_UNIT 5 "Swordsman" 11 5} {FACING sw} {GUARDIAN}
        {GENERIC_UNIT 5 "Spearman"  5  8} {FACING ne} {GUARDIAN}
        {GENERIC_UNIT 5 "Spearman"  8  3} {FACING se} {GUARDIAN}
        [capture_village]
            side=5
            x,y=7,4
            radius=8
        [/capture_village]
        {REVEAL x,y,radius=7,5,4}
        [message]
            speaker=Warven
            message=_"Northern company ready and reporting, ma’am."
        [/message]

        # southeast
        {NAMED_UNIT 6 "Red Mage"   42 24 leader6 _"Yrridyn" ()} {LEADER} {FACING sw}
        {GENERIC_UNIT 6 "Mage"     38 26} {FACING sw} {GUARDIAN}
        {GENERIC_UNIT 6 "Spearman" 39 30} {FACING ne} {GUARDIAN}
        {GENERIC_UNIT 6 "Mage"     42 26} {FACING se} {GUARDIAN}
        [capture_village]
            side=6
            x,y=37,27
            radius=7
        [/capture_village]
        {REVEAL x,y,radius=40,26,4}
        [message]
            speaker=leader6
            message=_"We’ve burned the trolls out of the eastern tunnels. Our way forward is clear."
        [/message]

        # northeast
        {NAMED_UNIT 7 "Master Bowman" 39  5 leader7  _"Arynnoc"   ()} {LEADER} {FACING sw}
        {NAMED_UNIT 7 "Longbowman"    41 12 leader7b _"Gwytharyn" ()} {LEADER} {FACING sw}
        {GENERIC_UNIT 7 "Bowman"   32  3} {FACING se} {GUARDIAN}
        {GENERIC_UNIT 7 "Bowman"   37  7} {FACING ne} {GUARDIAN}
        {GENERIC_UNIT 7 "Bowman"   39 15} {FACING sw} {GUARDIAN}
        [capture_village]
            side=6
            x,y=36,4
            radius=7
        [/capture_village]
        {REVEAL x,y,radius=36,4,4}
        [message]
            speaker=leader7
            message=_"My bowmen and I are ready and waiting at the far passage. They won’t get through us, Your Highness."
        [/message]

        #############################
        # MIRYA TELEPORTS AWAY
        #############################
        [message]
            speaker=Lisar
            message=_"Good. And Mirya — scout around for any other exits we’ve missed. We must not allow Konrad to escape with the Sceptre of Fire."
        [/message]
        {MOVE_UNIT id=Mirya 2 24}
        {ANIMATE_UNIT id=Mirya pre_teleport}
        {STORE_NPC Mirya}

        # show sides
        [modify_side]
            side=2,3
            hidden=yes
        [/modify_side]
        [modify_side]
            side=4,5,6,7
            hidden=no
        [/modify_side]

        #############################
        # REFRESH SHROUD
        #############################
        # re-create our shroud from part 1, but adjusted to work with the new map for part 2
        [place_shroud]
            side=1
            x,y=0-99,0-99
        [/place_shroud]
        [remove_shroud]
            side=1
            find_in=stored_s30_unshroud
        [/remove_shroud]
        {REDRAW}

        #############################
        # KONRAD AND DELFADOR DISCUSS
        #############################
        {SCROLL_TO 21 14}
        [message]
            speaker=Konrad
            message=_"Li’sar expects us to try to escape? No, I will not yield so easily. Hold strong, friends. We must guard Delfador while he unearths the Sceptre, or perhaps even attack and defeat Li’sar herself!"
        [/message]
        [message]
            speaker=Delfador
            message=_"The Sceptre is valuable, but your life is even more so, Konrad. If our forces are not yet strong enough to confront the army of Wesnoth, do not be afraid to swallow your pride and flee. I feel fresh air coming from the north."
        [/message]
        [message]
            speaker=Delfador
            message=_"Of course, fleeing would surely mean leaving the Sceptre behind..."
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                caption= _ "Cowardly Victory:"
                description= _ "Move Konrad to any edge of the map"
                condition=win
            [/objective]
            [objective]
                caption= _ "Normal Victory:"
                description= _ "Protect Delfador until he unearths the sceptre"+{OBJECTIVE_FOOTNOTE _"(gain the Sceptre of Fire)"}
                condition=win
                show_turn_counter=yes
            [/objective]
            [objective]
                caption= _ "Heroic Victory:"
                description= _ "Defeat Li’sar"+{EARLY_FINISH_BONUS_FOOTNOTE}+{OBJECTIVE_FOOTNOTE _"(gain the Sceptre of Fire, and special armor for Konrad)"}
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage=40
                bonus=no
            [/gold_carryover]
        [/objectives]

        #######################################################################################################################################################
        #                                                                       PART TWO EVENTS
        #######################################################################################################################################################
        #############################
        # LISAR GUARDIANS
        #############################
        # spawn a few guards to help protect Li'sar. Leave them on {GUARDIAN} AI to make them especially useful against Fire Guardian/Wraith chasm rush strategies,
        # but easy to pick off 1-by-1 via ground attack strategies
        [event]
            name=side 4 turn
            {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Heavy Infantryman" "Shock Trooper" "Shock Trooper" "Iron Mauler"  })  3 27 ({ANIMATE} {GUARDIAN})}
            {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"              "Bowman"        "Bowman"        "Longbowman"   })  4 23 ({ANIMATE} {GUARDIAN})}
            {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Bowman"            "Bowman"        "Longbowman"    "Longbowman"   })  9 25 ({ANIMATE} {GUARDIAN})}
            {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Fencer"            "Fencer"        "Duelist"       "Duelist"      }) 10 27 ({ANIMATE} {GUARDIAN})}
        [/event]

        #############################
        # KONRAD AND LISAR DISCUSS
        #############################
        [event]
            name=new turn
            [event]
                name=new turn
                [event]
                    name=new turn
                    [message]
                        speaker=Konrad
                        message=_"You know I am here to claim the Sceptre as my birthright, Li’sar. Is your hatred so great that you would rather chase after us than even <b><i>try</i></b> to save Wesnoth from the ruin it has fallen to at the hands of your mother?"
                    [/message]
                    {REVEAL( radius=2 {FILTER id=Lisar} )}
                    [message]
                        speaker=Lisar {LISAR_VARIATION mad}
                        message=_"I <i>am</i> trying to save it — from you. Do you have any idea how much chaos you and your little gang of ruffians have caused?"
                    [/message]
                    [message]
                        speaker=Konrad
                        message=_"Asheviere took control of Wesnoth with violence, and violence has filled every part of her reign. All she knows is blood! And all she cares about is power."
                    [/message]
                    [message]
                        speaker=Lisar
                        message=_"You really are just a child. Maybe the Aethenwood runs on friendship and flowers, but here in the real world sometimes people get hurt. And yes, sometimes that means unsavory decisions, like the kind the queen has to make every day."
                    [/message]
                    [message]
                        speaker=Konrad {KONRAD_VARIATION mad}
                        message=_"Perhaps you truly think you’re acting for the best. But know this: with me today stand free peoples from all corners of Wesnoth, united as one against the tyranny of Asheviere. Whether we defeat you now or never, Wesnoth will never stop fighting for what is right!"
                    [/message]
                    {DELAY 500}
                    [message]
                        speaker=Lisar
                        message=_"... not bad, as hero speeches go. We’ll see how the palace dungeons change your tune."
                    [/message]
                    [remove_shroud]
                        side=1
                        find_in=stored_s30_unshroud
                    [/remove_shroud]
                    {REDRAW}
                [/event]
            [/event]
        [/event]

        #############################
        # SCEPTRE REMINDERS
        #############################
        [event]
            name=turn $($sceptre_first_turn + {SCEPTRE_REMINDER_1})
            [message]
                speaker=Delfador
                message=_"I am making progress, Konrad! We are perhaps half of the way to the Sceptre."
            [/message]
        [/event]
        [event]
            name=turn $($sceptre_first_turn + {SCEPTRE_REMINDER_2})
            [message]
                speaker=Delfador
                message=_"Almost done, Konrad. We shall soon hold the Sceptre in our hands!"
            [/message]
        [/event]
        [event]
            name=turn $($sceptre_first_turn + {SCEPTRE_SURVIVAL_TURNS} - 1)
            [message]
                speaker=Delfador
                message=_"I see red and gold poking though the earth! We shall have the Sceptre in but another moment!"
            [/message]
        [/event]

        #############################
        # KILLING LISAR'S ALLIES
        #############################
        [event]
            name=last breath
            {FILTER id=Warven}
            [message]
                speaker=Warven
                message=_"Argh! He’s more powerful than we thought. I have to get away!"
            [/message]
            {MOVE_UNIT id=Warven 1 6}
            {KILL id=Warven}
        [/event]
        [event]
            name=last breath
            {FILTER id=leader6}
            [message]
                speaker=leader6
                message=_"Decades of study and practice, only to die in a cave..."
            [/message]
        [/event]
        [event]
            name=last breath
            {FILTER id=leader7}
            [message]
                speaker=leader7
                message=_"Fight on without me, Your Highness!"
            [/message]
        [/event]
        [event]
            name=last breath
            {FILTER id=leader7b}
            [message]
                speaker=leader7b
                message=_"Ack! I’m sorry, Your Highness, I couldn’t stop them..."
            [/message]
        [/event]

        #############################
        # KONRAD FIGHTS LISAR
        #############################
        [event]
            name=attack
            {FILTER id=Konrad,Lisar}
            {FILTER_SECOND id=Konrad,Lisar}
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"For the Aethenwood! For Wesnoth! For all the world!"
            [/message]
        [/event]
        # Delfador can't attack Li'sar in this scenario, as he doesn't move
        [event]
            name=attack
            {FILTER id=Kalenz,Lisar}
            {FILTER_SECOND id=Kalenz,Lisar}
            [message]
                speaker=Kalenz
                message=_"The wrath of the elves falls upon you, girl!"
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Chantal,Lisar}
            {FILTER_SECOND id=Chantal,Lisar}
            [message]
                speaker=Chantal
                message=_"Your mother has much to answer for. We shall start with you."
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Ulfdain,Lisar}
            {FILTER_SECOND id=Ulfdain,Lisar}
            [message]
                speaker=Ulfdain
                message=_"Ah’ll teach you and yer men to cage me up, ye obscene trunk of tallow-keech!"
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Moremirmu,Lisar}
            {FILTER_SECOND id=Moremirmu,Lisar}
            [message]
                speaker=Moremirmu
                message=_"By the Light we were made! Lo, and by the Light shall you be un-made!"
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Harper,Lisar}
            {FILTER_SECOND id=Harper,Lisar}
            [message]
                speaker=Harper
                message=_"This is for Baldras!"
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Jeniver,Lisar}
            {FILTER_SECOND id=Jeniver,Lisar}
            [message]
                speaker=Jeniver
                message=_"Sorry about this, but it has to be done!"
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Seimus,Lisar}
            {FILTER_SECOND id=Seimus,Lisar}
            [message]
                speaker=Seimus
                message=_"Behold the flames of Alduin!"
            [/message]
        [/event]
        [event]
            name=attack
            {FILTER id=Dosh,Lisar}
            {FILTER_SECOND id=Dosh,Lisar}
            [message]
                speaker=Dosh
                message=_"You done made wrong enemy, softskin!"
            [/message]
        [/event]

        #######################################################################################################################################################
        #                                                                    VICTORY / DEFEAT
        #######################################################################################################################################################
#define LAVA_CUTSCENE MESSAGES_WML1 MESSAGES_WML2
    #------------------------
    # EARTHQUAKE!
    #------------------------
    {DELAY 500}
    {QUAKE cave-in.ogg} {DELAY 500}
    {SOUND magic-missile-1.ogg} {DELAY 750}
    {SOUND magic-missile-2.ogg} {DELAY 750}
    {QUAKE cave-in.ogg}{QUAKE()} {DELAY 500}
    {MESSAGES_WML1}

    #------------------------
    # INTRODUCE MIRYA
    #------------------------
    {UNSTORE_NPC Mirya x,y=23,2 side=4}
    {REVEAL( radius=2 {FILTER id=Mirya} )}
    {SCROLL_TO 23 4} {DELAY 500}
    {ANIMATE_ATTACK id=Mirya range=ranged yes x,y=23,3} {DELAY 250}
    {ANIMATE_ATTACK id=Mirya range=ranged yes x,y=24,1} {DELAY 250}
    {ANIMATE_ATTACK id=Mirya range=ranged yes x,y=22,1} {DELAY 250}
    [terrain]
        {AND terrain=Q*^*}
        terrain=Ql
        layer=base
    [/terrain]
    {QUAKE cave-in.ogg}{QUAKE()}
    {REDRAW}
    {DELAY 1000}

    {MESSAGES_WML2}

    {ANIMATE_ATTACK id=Mirya range=ranged yes x,y=22,1} {DELAY 250}
    {ANIMATE_ATTACK id=Mirya range=ranged yes x,y=24,1} {DELAY 500}
    {MOVE_UNIT id=Mirya 23 1} {DELAY 250}
    {ANIMATE_UNIT id=Mirya pre_teleport}
    {STORE_NPC Mirya}

    #------------------------
    # LAVA RISES FURTHER
    #------------------------
    [terrain]
        {AND terrain=Q*^*}
        terrain=Qlf
        layer=base
    [/terrain]
    {QUAKE cave-in.ogg}{QUAKE()}
    {REDRAW}
    {DELAY 1500}
    [terrain]
        {AND terrain=*^Qhu*}
        terrain=Qlf
        layer=base
    [/terrain]
    {QUAKE cave-in.ogg}{QUAKE()}
    [harm_unit]
        {FILTER( {NOT id=Delfador} {NOT type_adv_tree="Gryphon Rider,Fire Guardian"} {FILTER_LOCATION terrain=Qlf*^*} )}
        amount=20
        kill=no
    [/harm_unit]
    {REDRAW}
    {DELAY 1000}
#enddef

        #############################
        # COWARDLY VICTORY
        #############################
        [event]
            name=moveto
            [filter]
                id=Konrad
                [filter_location]
                    x,y=1,1-99
                    {OR( x,y=42, 1-18 )}
                    {OR( x,y=42,25-99 )}
                    {OR( x,y= 1-99, 1 )}
                    {OR( x,y= 1-99,30 )}
                [/filter_location]
            [/filter]

            #------------------------
            # UNITS FLEE THE CAVE
            #------------------------
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"I have found an exit from the cavern! Quick, everyone, follow me and we may yet evade Li’sar within the twisting tunnels!"
            [/message]
            [store_unit]
                {FILTER( side=1 {NOT id=Konrad,Delfador} )}
                variable=fleeing_units
            [/store_unit]
            [foreach]
                array=fleeing_units
                [do]
                    {IF} {VARIABLE_CONDITIONAL i less_than 3} {THEN(
                        {MOVE_UNDER_KONRAD({MOVE_UNIT id=$this_item.id $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=$this_item.id})}
                    )} {ELSE(
                        {PUT_TO_RECALL_LIST id=$this_item.id}
                    )} {/IF}
                [/do]
            [/foreach]
            {CLEAR_VARIABLE fleeing_units}
            {MOVE_UNIT id=Delfador $unit.x $unit.y}

            #------------------------
            # LAVA CUTSCENE
            #------------------------
            {LAVA_CUTSCENE (
                {REVEAL( radius=2 {FILTER id=Lisar} )}
                [message]
                    speaker=Lisar
                    message=_"Did you hear that? An earthquake! What sorcery of yours is this, Delfador? Are you collapsing this whole cavern?"
                [/message]
            )(
                [message]
                    speaker=Delfador
                    message=_"I am not the cause of these tremors — what does that fool mage of yours think she is doing? The volcano is awakening! Is she trying to kill us and you both!?"
                [/message]
                [message]
                    speaker=Mirya
                    message=_"Sorry, Your Highness, queen’s orders. Better that nobody leaves than Konrad does."
                [/message]
                [message]
                    speaker=Lisar {LISAR_VARIATION mad}
                    message=_"What?! Mirya, there’s no need for this! They’ve left without the Sceptre, and it is a long way to the surface. We’ll have plenty of time to chase them down!"
                [/message]
            )}
            #------------------------
            # TIME TO RUN
            #------------------------
            [message]
                speaker=Delfador {DELFADOR_VARIATION mad}
                message=_"We are all in terrible danger! Konrad, stay close. You and I must flee with great haste — my spells shall speed our steps!"
            [/message]

            {VARIABLE bm_s30_victory coward}
            {OBJECT_SCEPTRE ({FILTER id=Lisar} silent=yes)}
            {GIVE_OBJECT_TO id=Lisar ({EFFECT profile portrait=portraits/lisar-sceptre.webp})}
            {VARIABLE early_finish_bonus no}
            {FIRE_EVENT endlevel}
        [/event]

        #############################
        # NORMAL VICTORY
        #############################
        [event]
            name=time over
            #------------------------
            # UNEARTHING THE SCEPTRE
            #------------------------
            {FIRE_EVENT delfador_digs_for_sceptre}
            {FIRE_EVENT delfador_digs_for_sceptre}
            {SOUND melee-fire.ogg}
            {MOVE_UNIT id=Delfador 19 17}
            {MODIFY_UNIT id=Delfador facing ne}
            {PLACE_IMAGE items/sceptre-of-fire.png 20 16}
            [message]
                speaker=Delfador
                message=_"It is here! We have found it! The Sceptre of Fire; the Ruby of the Wesfolk; the staff of kings. Konrad, you must come at once!"
            [/message]
            {MOVE_UNIT id=Konrad 20 16}
            [message]
                speaker=narrator
                message="<i>" + _ "The Sceptre, initially dulled from centuries of dust and debris, began to glow from its ruby’s inner fire. Dwarvish runes on the golden handle lit up in pulsating blue as Konrad’s fingers wrapped around the staff." + "</i>"
            [/message]
            {REMOVE_IMAGE 20 16}
            {OBJECT_SCEPTRE ({FILTER id=Konrad})}
            {SWITCH_KONRAD_PORTRAIT "adult" "-sceptre"}
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"The Sceptre is ours! It is not just a great weapon, but also a symbol; a way to convince the people that I would truly belong as king. Now we finally have the upper hand against Asheviere."
            [/message]

            #------------------------
            # LAVA CUTSCENE
            #------------------------
            {LAVA_CUTSCENE (
                {REVEAL( radius=2 {FILTER id=Lisar} )}
                [message]
                    speaker=Konrad {KONRAD_VARIATION concerned}
                    message=_"An earthquake!? Delfador, is this your doing? Has removing the Sceptre somehow damaged the cavern?"
                [/message]
            )(
                [message]
                    speaker=Delfador
                    message=_"I am not the cause of these tremors — what does that fool mage of Li’sar’s think she is doing? The volcano is awakening! Is she trying to kill us and the princess both!?"
                [/message]
                [message]
                    speaker=Lisar
                    message=_"What?! Mirya, you’re supposed to be scouting the tunnels, not destroying them."
                [/message]
                [message]
                    speaker=Mirya
                    message=_"Sorry, Your Highness, queen’s orders. Better that nobody leaves than Konrad does."
                [/message]
                [message]
                    speaker=Lisar
                    message=_"What?! Mirya, there’s no need for this! Konrad may have the Sceptre, but we have them surrounded. Even if they escape to the surface we’ll have plenty of time to chase them down!"
                [/message]
            )}
            #------------------------
            # TIME TO RUN
            #------------------------
            [message]
                speaker=Delfador {DELFADOR_VARIATION mad}
                message=_"We are all in terrible danger! Konrad, stay close. You and I must flee with great haste — my spells shall speed our steps!"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"But we have only just taken hold of the Sceptre! What about—"
            [/message]
            [message]
                speaker=Delfador {DELFADOR_VARIATION mad}
                message=_"There is no time! Run, Konrad, run!"
            [/message]

            {VARIABLE bm_s30_victory sceptre}
            {VARIABLE early_finish_bonus no}
            {FIRE_EVENT endlevel}
        [/event]

        #############################
        # HEROIC VICTORY
        #############################
        [event]
            name=last breath
            {FILTER id=Lisar}

            #------------------------
            # LISAR FALLS
            #------------------------
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"You are beaten, villain! With your defeat, we have severed the right hand of Asheviere!"
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"I can’t believe it. Bested so far from home, and during my own ambush. Embarrassing... Make it quick, then."
            [/message]
            {TRANSFORM_UNIT id=Lisar "Bound Princess"}
            [message]
                speaker=Konrad
                message=_"No. You are to be my prisoner, and we shall ransom you to your mother in exchange for her abdication; a better and more merciful use of your head than petty vengeance. Delfador, do you have the Sceptre yet?"
            [/message]

            #------------------------
            # UNEARTHING THE SCEPTRE
            #------------------------
            {FIRE_EVENT delfador_digs_for_sceptre}
            {FIRE_EVENT delfador_digs_for_sceptre}
            {SOUND melee-fire.ogg}
            [message]
                speaker=Delfador
                message=_"I do! It is here — the Sceptre of Fire; the Ruby of the Wesfolk; the staff of kings. Konrad, I shall bring it to you at once."
            [/message]
            {SOUND magicmissile.wav}
            {DELAY 500}
            {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=Delfador $coordX $coordY})}
            [message]
                speaker=narrator
                message=_"<i>The Sceptre, initially dulled from centuries of dust and debris, began to glow from its ruby’s inner fire. Dwarvish runes on the golden handle lit up in pulsating blue as Konrad’s fingers wrapped around the staff.</i>"
            [/message]
            {OBJECT_SCEPTRE ({FILTER id=Konrad})}
            {SWITCH_KONRAD_PORTRAIT "adult" "-sceptre"}
            [message]
                speaker=Delfador
                message=_"The Sceptre is ours. It is not just a great weapon, Konrad, but also a symbol; more proof of your kingship. And with Li’sar defeated, I wonder if we might add yet another symbol to your claim..."
            [/message]

            #------------------------
            # ARMOR FOR KONRAD
            #------------------------
            {DO_AT_COORDS id=Lisar ({MOVE_UNIT id=Delfador $coordX $coordY})}
            {DELAY 500}
            {SOUND skill-illusion-quiet.wav}
            {ANIMATE_UNIT id=Delfador levelout}
            {ANIMATE_UNIT id=Delfador levelin}
            {DELAY 500}
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"What have you done, old man? You hold something that looks exactly like my armor, finely crafted and inscribed with symbols of royalty, yet what I still wear is intact. How is this possible?"
            [/message]
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"A magical copy, with some improvements and details adjusted for Konrad! It will exist only for a year and a day, but that will be more than enough time to overthrow Asheviere."
            [/message]
            {OBJECT_CHAINMAIL ({FILTER id=Konrad})}
            {SWITCH_KONRAD_PORTRAIT "chainmail" "-sceptre"}
            [message]
                speaker=Konrad # no variation, so we can see him with both the sceptre and the chainmail
                message=_"Thank you, Delfador. This is truly a great boon! Now, to bind our prisoner and once more ascend to the surface."
            [/message]

            #------------------------
            # LAVA CUTSCENE
            #------------------------
            {LAVA_CUTSCENE (
                {REVEAL( radius=2 {FILTER id=Lisar} )}
                [message]
                    speaker=Konrad {KONRAD_VARIATION concerned}
                    message=_"An earthquake!? Delfador, is this also your doing? Has removing the Sceptre somehow damaged the cavern?"
                [/message]
            )(
                [message]
                    speaker=Delfador
                    message=_"I am not the cause of these tremors — what does that fool mage of Li’sar’s think she is doing? The volcano is awakening! Is she trying to kill us and her princess both!?"
                [/message]
                [message]
                    speaker=Mirya
                    message=_"Sorry, Li’sar, queen’s orders. You had your chance and you failed. Now it’s time for the backup plan."
                [/message]
            )}
            #------------------------
            # TIME TO RUN
            #------------------------
            [message]
                speaker=Delfador {DELFADOR_VARIATION mad}
                message=_"We are all in terrible danger! Konrad, stay close. You and I must flee with great haste — my spells shall speed our steps!"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"I have the princess tied up! But what about—"
            [/message]
            [message]
                speaker=Delfador {DELFADOR_VARIATION mad}
                message=_"There is no time! Run, Konrad, run!"
            [/message]

            {STORE_NPC Lisar}
            {VARIABLE bm_s30_victory lisar}
            {VARIABLE early_finish_bonus yes}
            {FIRE_EVENT endlevel}
        [/event]

        #############################
        # VICTORY CLEANUP
        #############################
        [event]
            name=endlevel
            {IF} {VARIABLE_CONDITIONAL turn_number greater_than_equal_to "$({SCENARIO_TURN_LIMIT} + {SCEPTRE_SURVIVAL_TURNS} - 1)"} {THEN(
                {ACHIEVE s30}
            )} {/IF}
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 40}
                linger_mode=no
                carryover_report=no
                bonus=$early_finish_bonus
                music=silence.ogg
            [/endlevel]
            {CLEAR_VARIABLE early_finish_bonus,stored_s30_unshroud,sceptre_first_turn}
        [/event]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef SCEPTRE_SURVIVAL_TURNS
#undef SCEPTRE_REMINDER_1
#undef SCEPTRE_REMINDER_2
#undef WESNOTH_SIDE
#undef BUILD_SPEECH
#undef LAVA_CUTSCENE
