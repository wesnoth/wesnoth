#textdomain wesnoth-h2tt
# scenario by Dalas

#define SCENARIO_TURN_LIMIT
35#enddef

#define TOD_OFFSET
-1#enddef

[scenario]
    name=_"The Siege of Elensefar"
    {MAP_DYNAMIC 10_Elensefar_Before}
    next_scenario=00_The_Great_Continent
    victory_when_enemies_defeated=no
    {SCHEDULE_DYNAMIC_DAY OFFSET={TOD_OFFSET}}
    turns={SCENARIO_TURN_LIMIT}
    {SCENARIO_MUSIC loyalists.ogg} # wesnoth's song
    {EXTRA_SCENARIO_MUSIC three-sheets.ogg} # elensefar's song
    {EXTRA_SCENARIO_MUSIC primal-carnage.ogg} # lisar's song

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE}

    #############################
    # ARMY OF WESNOTH
    #############################
#define WESNOTH_SIDE SIDE TYPE ID TRAITS RECRUIT_LIST GOLD INCOME
    [side]
        side={SIDE}
        controller=ai
        color=wesred
        type={TYPE}
        id={ID}
        facing=nw {MODIFICATIONS( {TRAITS} )}
        gold={GOLD}
        income={INCOME}
        recruit={RECRUIT_LIST}
        team_name=bad
        user_team_name=_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    {WESNOTH_SIDE 2 Halberdier wesnoth2 ({TRAIT_RESILIENT}{TRAIT_INTELLIGENT})  "Spearman" {ON_DIFFICULTY4 50 75 100 125} {ON_DIFFICULTY4 7 13 19 25}}
    {WESNOTH_SIDE 3 Longbowman wesnoth3 ({TRAIT_RESILIENT}{TRAIT_STRONG}     )  "Bowman"   {ON_DIFFICULTY4 40 60  80 100} {ON_DIFFICULTY4 5 10 15 20}}
    {WESNOTH_SIDE 4 Lieutenant wesnoth4 ({TRAIT_STRONG}   {TRAIT_RESILIENT}  )  "Fencer"   {ON_DIFFICULTY4 40 60  80 100} {ON_DIFFICULTY4 5 10 15 20}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Pikeman"   {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Swordsman" {ON_DIFFICULTY4 0 0 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Spearman"  {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Duelist"   {ON_DIFFICULTY4 0 1 1 1}}
    {STARTING_VILLAGES_AREA 2  32 29  6}
    {STARTING_VILLAGES_AREA 3  14 32  9}
    {STARTING_VILLAGES_AREA 4  53 31 10}

    #############################
    # CLAN FOXTAIL
    #############################
#define FOXTAIL_SIDE SIDE TYPE ID NAME TRAITS RECRUIT_LIST GOLD INCOME
    [side]
        side={SIDE}
        controller=ai
        color=orange
        type={TYPE}
        id={ID}
        name={NAME}
        facing=se {MODIFICATIONS( {TRAITS} )}
        gold={GOLD}
        income={INCOME}
        recruit={RECRUIT_LIST}
        team_name=bad
        user_team_name=_"Clan Foxtail" {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    {FOXTAIL_SIDE 5 "Orcish Slurbow"  foxtail5 _"Agadla"   ({TRAIT_RESILIENT}{TRAIT_INTELLIGENT})  "Orcish Archer"   {ON_DIFFICULTY4 40 60  80 100} {ON_DIFFICULTY4 5 10 15 20}}
    {FOXTAIL_SIDE 6 "Goblin Pillager" foxtail6 _"Drodrish" ({TRAIT_RESILIENT}{TRAIT_STRONG}     )  "Goblin Pillager" {ON_DIFFICULTY4 40 60  80 100} {ON_DIFFICULTY4 5 10 15 20}}
    # same names/traits as S10 Elensefar Before
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Orcish Crossbowman" {ON_DIFFICULTY4 0 1 3 3}} # 1 guard on Hard/Nightmare
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Orcish Grunt"       {ON_DIFFICULTY4 1 2 3 3}} # 1 guard on Normal/Hard/Nightmare
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Orcish Archer"      {ON_DIFFICULTY4 1 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Orcish Grunt"       {ON_DIFFICULTY4 0 1 1 1}} # 1 guard on Hard/Nightmare
    {STARTING_VILLAGES_AREA 5  31-99 0-9 0}
    {STARTING_VILLAGES_AREA 6   0-30 0-9 0}

    [event]
        name=side 2 turn refresh
        first_time_only=no
        {RESET_SIDE_AI 2,3,4,5,6 offensive 0.9 0.1}
        {AUTOENRAGE 2 0}
        {AUTOENRAGE 3 0}
        {AUTOENRAGE 4 0}
        {AUTOENRAGE 5 0}
        {AUTOENRAGE 6 0}
        {MODIFY_SIDE_AI 2,3,4,5,6 ({GOAL_SEEK_SIDE 1 1 0})} # prefer attacking Konrad, if we can reach him
    [/event]

    #############################
    # LI'SAR
    #############################
    [side]
        side=7
        controller=ai
        color=lisarcolor
        no_leader=yes
        hidden=yes
        gold={ON_DIFFICULTY4 60 90 105 120}
        income=-2
        recruit=Heavy Infantryman
        team_name=bad
        user_team_name=_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Bowman" {ON_DIFFICULTY4 0 1 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Fencer" {ON_DIFFICULTY4 2 3 4 4}}
    {SILENTLY_LIMIT_LEADER_MOVES 7 1}
    [event]
        name=side 7 turn refresh
        first_time_only=no
        {RESET_SIDE_AI 7 offensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 7 1,2,3}
    [/event]
    [event] # don't have any of lisar's units cost upkeep, or else the whole boats-bringing-gold gimmick is pointless
        name=unit placed
        first_time_only=no
        {FILTER side=7}
        {GIVE_OBJECT_TO id=$unit.id ({EFFECT loyal ()})}
    [/event]

    #############################
    # ELENSEFAR
    #############################
    [event]
        name=prestart
        {UNSTORE_NPC Maddock x,y=19,18 side,facing=8,se}
    [/event]
    [side]
        side=8
        controller=ai
        color=teal
        recruit=Swordsman,Pikeman
        gold={ON_DIFFICULTY4 80 100 120 140}
        income={ON_DIFFICULTY4 10 14 18 22} # assume villages used for upkeep
        no_leader=yes
        team_name=konrad
        user_team_name=_"Elensefar"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 8 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Thief" {ON_DIFFICULTY4 2 2 3 3}}
    {STARTING_VILLAGES_AREA 8 22 21 4}
    {STARTING_VILLAGES_AREA 8 28 18 3}

    [event]
        name=prestart
        {UNSTORE_NPC Delfador x,y=17,19 side,facing=9,se}
    [/event]
    [side]
        side=9
        controller=ai
        color=teal
        recruit=Fire Wraith
        gold={ON_DIFFICULTY4 40 60 80 100}
        income={ON_DIFFICULTY4 6 10 14 18} # assume villages used for upkeep
        no_leader=yes
        team_name=konrad
        user_team_name=_"Elensefar"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 9 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Giant Mudcrawler" {ON_DIFFICULTY4 2 2 3 3}}
    {STARTING_VILLAGES_AREA 9 17 15 5}
    {STARTING_VILLAGES_AREA 9 27 14 2}

    #############################
    # ELENSEFAR AI
    #############################
#define ELENSEFAR_BEFORE_AVOID_AREA
    x= 0-17,  18,  18,   18,   19,  19,   19,   20,  20,   20,   21,  21,21,21,   22,  22,   23,  23,23,   24,  24,24,   25,  25,   26,  26,26,   27,  27,   28,  28,28,   29,  29,29,   30,  30,    31-99,31-99
    y=22-99,  0-10,15-16,22-99,0-11,14-16,21-99,0-11,14-15,20-99,0-13,15,21,23-99,0-13,23-99,0-12,20,23-99,0-12,20,23-99,0-13,24-99,0-12,19,22-99,0-12,23-99,0-11,19,21-99,0-12,20,22-99,0-12,20-99,  0-13,20-99
#enddef                                       # 20,11 is avoided so that mudcrawlers don't block the granite golem
    [event]
        name=side 8 turn
        first_time_only=no
        {RESET_SIDE_AI 8,9 offensive 0.1 0.8}
        #         {VARY_AI_BY_SCHEDULE 2,3} # likely to cause lag, and not relevant since we're already fighting within strict [avoid]s

        {MODIFY_SIDE_AI 8 ({GOAL_SEEK_SIDE 3 2,3,4,7 0})}
        {MODIFY_SIDE_AI 9 ({GOAL_SEEK_SIDE 3   5,6,7 0})}

        {MODIFY_SIDE_AI 8 (
            {GOAL_LOCATION 4 x,y=29,21}
            {GOAL_LOCATION 4 x,y=27,22}
            {GOAL_LOCATION 4 x,y=25,23}
            {GOAL_LOCATION 3 x,y=26,21}
            {GOAL_LOCATION 3 x,y=24,22}
        )}

        {MODIFY_SIDE_AI 9 (
            {GOAL_LOCATION 4 x,y=27,13}
            {GOAL_LOCATION 4 x,y=19,12}
            {GOAL_LOCATION 4 x,y=20,11}
            {GOAL_LOCATION 3 x,y=30,13}
            {GOAL_LOCATION 3 x,y=26,15}
        )}

        {MODIFY_SIDE_AI 8,9 (
            {GOAL_LOCATION 2 x,y=22,19}
            {GOAL_LOCATION 2 x,y=23,18}
            {GOAL_LOCATION 2 x,y=19,20}
            {GOAL_LOCATION 1 x,y=28,18}
            {GOAL_LOCATION 1 x,y=27,19}
            {GOAL_LOCATION 1 x,y=20,17}
        )}

        {MODIFY_SIDE_AI 8,9 (
            [avoid]
                {ELENSEFAR_BEFORE_AVOID_AREA}
            [/avoid]
        )}
    [/event]

    #############################
    # CARRACK AI
    #############################
    # carracks repair when they're at the docks
    [event]
        name=side 8 turn
        first_time_only=no
        [heal_unit]
            [filter]
                type=Merchant Carrack,Pirate Carrack
                x=14,16
                y=18,17
            [/filter]
            amount=8
            animate=yes
        [/heal_unit]
    [/event]

#define CARRACK_MAI ID HEALX HEALY FIGHTX FIGHTY RADIUS
    [event]
        name=side 8 turn refresh
        first_time_only=no
        {FILTER_CONDITION({HAVE_UNIT id={ID}})}
        [micro_ai]
            side=8
            action=delete
            ai_type=goto
            ca_id=mai_{ID}
        [/micro_ai]
        [micro_ai]
            side=8
            action=delete
            ai_type=zone_guardian
            ca_id=mai_{ID}
        [/micro_ai]

        # if at the healing location, stay there until full hp (unless enemies get close)
        {IF} {HAVE_UNIT id,x,y,formula={ID},{HEALX},{HEALY},"(self.hitpoints < self.max_hitpoints)"} {THEN(
            [micro_ai]
                side=8
                action=add
                ai_type=zone_guardian
                ca_id=mai_{ID} {FILTER id={ID}}
                station_x={HEALX}
                station_y={HEALY}
                {FILTER_LOCATION x,y=14-20,16-19}
            [/micro_ai]
        )}

        # if injured, go to the healing location
        {ELSEIF} {HAVE_UNIT id,formula={ID},"(self.hitpoints < self.max_hitpoints/2)"} {THEN(
            [micro_ai]
                side=8
                action=add
                ai_type=goto
                ca_id=mai_{ID} {FILTER id={ID}}
                {FILTER_LOCATION x,y={HEALX},{HEALY}}
                [avoid]
                    x,y=1,1 # overwrite our side's normal avoid
                [/avoid]
            [/micro_ai]
        )} {/ELSEIF}

        # otherwise, guard our zone normally
        {ELSE(
            [micro_ai]
                side=8
                action=add
                ai_type=zone_guardian
                ca_id=mai_{ID} {FILTER id={ID}}
                station_x={FIGHTX}
                station_y={FIGHTY}
                {FILTER_LOCATION x,y,radius={FIGHTX},{FIGHTY},{RADIUS}}
            [/micro_ai]
        )} {/IF}
    [/event]
#enddef
    {CARRACK_MAI carrackSouth 14 18  23 22 5}
    {CARRACK_MAI carrackNorth 16 17  22 12 3}
    {CARRACK_MAI carrackEast  38 13  39 12 3}

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # DELFADOR
        #############################
        # golems
        {GENERIC_UNIT 9 "Granite Golem" 23 18} {FACING ne} {ZONE_GUARDIAN 23 18 x,y,radius=22,18,2}
        {GENERIC_UNIT 9 "Granite Golem" 30 13} {FACING nw}
        {ZONE_GUARDIAN 30 13 (
            x=26,   27,   28,   29,   30,   31
            y=12-13,12-15,11-15,12-16,12-14,14
        )}
        # deliberately starts on a different position than its guardian target - it starts fighting some orcs
        {GENERIC_UNIT 9 "Granite Golem" 21 10} {FACING ne} {ZONE_GUARDIAN 20 11 x,y,radius=18,12,3} {HITPOINTS 87} {ROLE golem1}
        # golem1 spawns injured and isn't stationed on a village, so go back to heal if there's no enemies nearby
        [event]
            name=side 9 turn refresh
            first_time_only=no
            {FILTER_CONDITION({HAVE_UNIT( role,formula=golem1,"(self.hitpoints < self.max_hitpoints)" )})}
            {FILTER_CONDITION({HAVE_UNIT( role=golem1 {FILTER_LOCATION x,y,radius=19,12,1} )})}
            {FILTER_CONDITION({NOT({HAVE_UNIT x,y=19,12})})}

            {FILTER_CONDITION({NOT({HAVE_UNIT( side=5,6               {FILTER_LOCATION x,y,radius=20,11,2} )})})}
            {FILTER_CONDITION({NOT({HAVE_UNIT( type="Goblin Pillager" {FILTER_LOCATION x,y,radius=21,10,3} )})})}

            {MOVE_UNIT role=golem1 19 12} {MODIFY_UNIT role=golem1 moves 0}
        [/event]

        # some attackers (they'll get killed ina couple of turns)
        {GENERIC_UNIT 9 "Fire Wraith"      31 10} {FACING ne} {ZONE_GUARDIAN 31 10 x,y,radius=31,10,5} {HITPOINTS 19}
        {GENERIC_UNIT 9 "Fire Guardian"    30  8} {FACING ne} {ZONE_GUARDIAN 31 10 x,y,radius=31,10,5} {HITPOINTS 23}
        {GENERIC_UNIT 9 "Giant Mudcrawler" 31 12} {FACING ne} {ZONE_GUARDIAN 31 10 x,y,radius=31,10,5}

        # small island mudcrawlers
        {GENERIC_UNIT 9 "Mudcrawler"       20 11} {FACING se}
        {GENERIC_UNIT 9 "Mudcrawler"       17 13} {FACING se}
        {GENERIC_UNIT 9 "Mudcrawler"       16 12} {FACING se}

        #############################
        # MADDOCK
        #############################
        {BRAZIER_DYNAMIC_DAY 25 21 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 21 19 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 26 13 OFFSET={TOD_OFFSET}}
        [item]
            x,y=30,17
            halo=items/fountain-[01~13].png:100
        [/item]

        {GENERIC_UNIT 8 "Swordsman" 27 13} {FACING ne} {ZONE_GUARDIAN 27 13 x,y,radius=27,14,2}
        {GENERIC_UNIT 8 "Swordsman" 19 17} {FACING se} {ZONE_GUARDIAN 19 17 x,y,radius=21,18,3}
        {GENERIC_UNIT 8 "Pikeman"   22 19} {FACING se} {ZONE_GUARDIAN 22 19 x,y,radius=21,19,2}
        {GENERIC_UNIT 8 "Thief"     28 18} {FACING ne} {ZONE_GUARDIAN 28 18 x,y,radius=28,18,1}
        {GENERIC_UNIT 8 "Swordsman" 25 23}
        {GENERIC_UNIT 8 "Thief"     24 22} {HITPOINTS 11}
        {GENERIC_UNIT 8 "Pikeman"   29 21}
        {GENERIC_UNIT 8 "Pikeman"   28 21} {HITPOINTS 9}
        {GENERIC_UNIT 8 "Thief"     28 22} {HITPOINTS 19}
        {GENERIC_UNIT 8 "Thief"     27 22}

        {NAMED_UNIT 8 "Merchant Carrack" 14 18 carrackSouth _"The Daneth"   facing=sw} {HITPOINTS 115} # heal for a couple turns until we reach full, then go help fight
        {NAMED_UNIT 8 "Pirate Carrack"   19  9 carrackNorth _"Elyn's Folly" facing=se}
        {NAMED_UNIT 8 "Merchant Carrack" 34 12 carrackEast  _"Charlock"     facing=sw}

        #############################
        # ARMY OF WESNOTH
        #############################
        {PLACE_IMAGE items/dwarven-keep-tile.png 25 28}
        {PLACE_IMAGE items/dwarven-keep-tile.png 38 28}

        # initial attackers
        {GENERIC_UNIT 4 "Spearman" 30 21} {FACING nw} {HITPOINTS 31}
        {GENERIC_UNIT 4 "Spearman" 29 22} {FACING ne} {HITPOINTS 16}
        {GENERIC_UNIT 4 "Spearman" 29 23} {FACING nw} {HITPOINTS 18}

        {GENERIC_UNIT 4 "Bowman"   22 24} {FACING ne}
        {GENERIC_UNIT 4 "Bowman"   23 25} {FACING ne}

        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"   "Spearman"  }) 33 32 ({FACING sw}{ZONE_GUARDIAN 33 32 x,y,radius=34,30,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman" "Longbowman"}) 39 29 ({FACING se}{ZONE_GUARDIAN 39 29 x,y,radius=37,29,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"     "Bowman"    }) 38 28 ({FACING se}{ZONE_GUARDIAN 38 28 x,y,radius=34,30,3})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Longbowman" "Longbowman"}) 34 26 ({FACING nw}{GUARDIAN})}

        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Spearman"   "Spearman"  }) 26 28 ({FACING sw}{GUARDIAN})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"     "Bowman"    }) 18 30 ({FACING sw}{ZONE_GUARDIAN 18 30 x,y,radius=28,28,4})}

        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"       "Fencer"     "Fencer"    }) 40 23 ({FACING sw}{ZONE_GUARDIAN 40 23 x,y,radius=28,28,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Duelist"    "Duelist"   }) 43 24 ({FACING sw}{ZONE_GUARDIAN 43 24 x,y,radius=39,22,5})}

        #############################
        # CLAN FOXTAIL
        #############################
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"          "none"          "Orcish Archer"      "Orcish Archer"     }) 35  6 ({FACING sw}{ZONE_GUARDIAN 35  6 x,y,radius=33,8,4})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Orcish Archer" "Orcish Archer" "Orcish Crossbowman" "Orcish Crossbowman"}) 35  8 ({FACING sw}{ZONE_GUARDIAN 31 10 x,y,radius=33,8,4}{HITPOINTS 21})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"          "Orcish Grunt"  "Orcish Grunt"       "Orcish Grunt"      }) 34  9 ({FACING sw}{ZONE_GUARDIAN 34  9 x,y,radius=33,8,4})}
        {GENERIC_UNIT  5 "Orcish Crossbowman" 32  9} {FACING sw} {HITPOINTS 4}
        {GENERIC_UNIT  5 "Orcish Grunt"       31  9} {FACING sw}
        {GENERIC_UNIT  5 "Orcish Archer"      38 10} {FACING sw} {HITPOINTS 16} # this guy is here to give Charlock something to shoot at on turn 1

        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"          "Orcish Archer" "Orcish Crossbowman" "Orcish Crossbowman"}) 26 6 ({FACING sw}{GUARDIAN})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"          "none"          "Orcish Grunt"       "Orcish Grunt"      }) 25 4 ({FACING se}{GUARDIAN})}
        {GENERIC_UNIT  6 "Orcish Archer" 21  9} {FACING se}
        {GENERIC_UNIT  6 "Orcish Archer" 22 10} {FACING nw}
        {GENERIC_UNIT  6 "Orcish Grunt"  20  9} {FACING se} {HITPOINTS 7}

        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 31 24}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # BLAGGARDS
        #############################
        {DELAY 500}
        [message]
            speaker=wesnoth4
            message=_"Push, you blaggards! We take the isle or it’s back to the gallows for us all!"
        [/message]
        {DELAY 250}
        {ANIMATE_HARM x,y=29,23 13 range=melee x,y=28,22}
        {ANIMATE_HARM x,y=29,23 99 range=melee x,y=28,22}
        {DELAY 250}
        {ANIMATE_HARM x,y=29,22 99 range=melee x,y=28,21}
        {DELAY 250}
        {ANIMATE_HARM x,y=30,21 10 range=melee x,y=29,21}
        {ANIMATE_HARM x,y=30,21 10 range=melee x,y=29,21}
        {ANIMATE_HARM x,y=29,21 99 range=melee x,y=30,21}
        {DELAY 500}
        # retaliation
        {MOVE_UNIT x,y=27,22 28 23}
        {ANIMATE_HARM x,y=28,23 99 range=melee x,y=29,23}
        {DELAY 250}
        {ANIMATE_HARM x,y=29,21 99 range=melee x,y=29,22}
        {DELAY 250}
        {MOVE_UNIT id=wesnoth4 34 24}
        [message]
            speaker=wesnoth4
            message=_"Damnations, still no progress! The defenders can’t keep this up forever — prepare another assault."
        [/message]
        {DELAY 250}
        [event]
            name=side 4 turn refresh
            {MOVE_UNIT   id=wesnoth4 39 24} # otherwise he makes for the slighty-closer southern keep, which is already occupied
            {MODIFY_UNIT id=wesnoth4 moves 0}
        [/event]

        #############################
        # KONRAD ARRIVES
        #############################
        {IF} {VARIABLE_CONDITIONAL s10_from_north equals yes} {THEN(
            {RECALL_KONRAD_AND_COMPANIONS 45 1} {DELAY 250}
            {MODIFY_UNIT id=Konrad facing sw}
            {MODIFY_TERRAIN Ke 45 1} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 44 0} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 44 1} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 45 2} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 46 1} {REDRAW} {DELAY 150}
        )}
        [elseif]
            {VARIABLE_CONDITIONAL s10_from_west equals yes}
            [then]
                {GENERIC_UNIT 1 Boat 1 36} {ROLE arrival_boat} {DELAY 250}
                {MOVE_UNIT role=arrival_boat 5 36} {KILL role=arrival_boat}
                {RECALL_XY Konrad 5 36} {MODIFY_UNIT id=Konrad facing se}
                {MOVE_UNIT id=Konrad 7 36}
                {MODIFY_TERRAIN Ke 7 36} {REDRAW} {DELAY 150}
                {MODIFY_TERRAIN Ce 8 35} {REDRAW} {DELAY 150}
                {MODIFY_TERRAIN Ce 8 36} {REDRAW} {DELAY 150}
                {MODIFY_TERRAIN Ce 7 37} {REDRAW} {DELAY 150}
                {RECALL_KONRAD_AND_COMPANIONS 7 36}
                [capture_village]
                    side=1
                    x,y=6,36
                [/capture_village]
            [/then]
        [/elseif]
        # default spawn location - southeast
        {ELSE(
            {RECALL_XY Konrad 58 34} {MODIFY_UNIT id=Konrad facing sw} {DELAY 250}
            {MOVE_UNIT id=Konrad 56 33}
            {MODIFY_TERRAIN Ke 56 33} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 55 34} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 55 33} {REDRAW} {DELAY 150}
            {MODIFY_TERRAIN Ce 56 32} {REDRAW} {DELAY 150}
            {RECALL_KONRAD_AND_COMPANIONS 56 33}
            [capture_village]
                side=1
                x,y=56,31
            [/capture_village]
        )} {/IF}

        #############################
        # KONRAD DIALOGUE
        #############################
        {DELAY 250}
        [message]
            speaker=Maddock
            message=_"Welcome to Elensefar, young master. Delfador has told me a great deal about you over the years! If you truly possess the potential that he claims, now is the time to start living up to it."
        [/message]
        {SCROLL_TO 28 10}
        [message]
            speaker=Maddock
            scroll=no
            message=_"As you can see we’re hard-pressed, for Asheviere’s loyalists besiege the south bridge while orcs push in from the north. Every attack has been repelled, but that lieutenant of theirs is right about one thing — we can’t keep it up forever."
        [/message]
        [companion_message]
            priority=Harper
            message_Harper=_"Got yourself into trouble again, Madock? Ain’t no cursed soldiers this time, but we’re still here to help."
            message_Ulfdain=_"Ah’m not afraid! Jus’ give the word an’ I’ll see them chicken-hearted pox wrinklers clear back to Weldyn!"
            message_Moremirmu=_"The dark queen’s shadow spreads, but the Light shall burn her back! We shall stand together against the darkness!"
            fallback_Konrad=_"We’re here to help, Lord Maddock. Elensefar has long been a bastion of freedom against Asheviere’s tyrrany. We can’t let it fall!"
        [/companion_message]
        [message]
            speaker=Delfador
            message=_"Exposing yourself here is a great risk, master Konrad. But your position behind enemy lines does afford us opportunity for a counterattack."
        [/message]
        [message]
            speaker=Delfador
            message=_"If you can defeat enough of their leaders to break the siege, the remainder will most certainly be forced to withdraw."
        [/message]
        [message]
            speaker=Konrad
            message=_"I won’t let you down, Delfador. Prepare for battle!"
        [/message]

        #############################
        # OBJECTIVES
        #############################
        {VARIABLE leaders_to_kill 3}
        {VARIABLE leaders_killed 0}
        [objectives]
            delayed_variable_substitution=yes
            [objective]
                description= _ "Defeat any $leaders_to_kill enemy leaders"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL leaders_killed equals 0}
                [/show_if]
            [/objective]
            [objective]
                #po: $leaders_to_kill is always 3. $leaders_killed will be either 1 or 2.
                description= _ "Defeat any $leaders_to_kill enemy leaders ($leaders_killed defeated)"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL leaders_killed greater_than 0}
                [/show_if]
            [/objective]
            [objective]
                {ALTERNATIVE_OBJECTIVE_CAPTION}
                description=_ "Survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Lord Maddock"
                condition=lose
            [/objective]
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage=40
                bonus=yes
            [/gold_carryover]
        [/objectives]
    [/event]

    #############################
    # APPROACH DELFADOR
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=18,18,3} )}
        [message]
            speaker=Konrad
            message=_"It’s good to see you again, Delfador. I’m glad you’re still okay!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Alive and kicking indeed, young master. But there is no time for idle chatter."
        [/message]
    [/event]

    #############################
    # SMALLTALK
    #############################
    [event]
        name=turn 13
        {IF} {HAVE_UNIT id=Harper} {THEN(
            [message]
                speaker=Harper
                message=_"Tried t’ tell you this would happen, Maddock. You shoulda fought with us back when the going was better."
            [/message]
            [message]
                speaker=Maddock
                message=_"You’ll recall that I did, through my son. It is not by mere chance that Elensefar has been kept free thus far, and nor is it by chance that it will stay that way today."
            [/message]
        )} {ELSE(
            {FIRE_EVENT say_smalltalk}
        )} {/IF}
    [/event]

    #######################################################################################################################################################
    #                                                                          LISAR
    #######################################################################################################################################################
    #############################
    # IMPROVE RAFT MOVEMENT
    #############################
    # Rafts usually have terrible movement in deep water.
    # For this scenario, let them move fast enough to be useful
    [event]
        name=unit placed
        first_time_only=no
        {FILTER type=Raft}
        {GIVE_OBJECT_TO id=$unit.id ({EFFECT movement_costs (
            replace=yes
            [movement_costs]
                deep_water=1
            [/movement_costs]
        )})}
    [/event]

    #############################
    # BOATS APPEAR
    #############################
    [event]
        name=side 7 turn 1
        [message]
            speaker=Delfador
            message=_"What’s this? Lord Maddock, master Konrad, I scry many small ships coming down the river! An ill tiding indeed, for they carry fresh fighters from Weldyn."
        [/message]
        [message]
            speaker=Maddock
            message=_"Impossible! What remains of the royal fleet already withdrew to the blockade; they don’t have the numbers for another amphibious attack."
        [/message]

        {GENERIC_UNIT 7 Skiff 58 17} {ANIMATE} {FACING sw} {ROLE boat1}
        {GENERIC_UNIT 7 Skiff 57 19} {ANIMATE} {FACING sw} {ROLE lisar_skiff} # place this skiff furthest south, so that hopefully Charlock doesn't attack and possibly sink it
        {GENERIC_UNIT 7 Raft  58 12} {ANIMATE} {FACING sw}
        {GENERIC_UNIT 7 Raft  58 14} {ANIMATE} {FACING sw}
        {GENERIC_UNIT 7 Skiff 58 15} {ANIMATE} {FACING sw} {ROLE boat2}
        [micro_ai]
            side=7
            action=add
            ai_type=goto
            {FILTER role=lisar_skiff}
            {FILTER_LOCATION x,y=35,17}
        [/micro_ai]
        [micro_ai]
            side=7
            action=add
            ai_type=goto
            {FILTER role=boat1}
            {FILTER_LOCATION x,y=35,18}
        [/micro_ai]
        [micro_ai]
            side=7
            action=add
            ai_type=goto
            {FILTER role=boat2}
            {FILTER_LOCATION x,y=37,16}
        [/micro_ai]
        [micro_ai]
            side=7
            action=add
            ai_type=goto
            {FILTER( side,trait=7,mechanical {NOT role=lisar_skiff}{NOT role=boat1}{NOT role=boat2} )}
            {FILTER_LOCATION x,y=36,16-17}
        [/micro_ai]

        [event]
            name=side 7 turn end
            [message]
                speaker=Maddock
                message=_"Damn... converted smallcraft. I shouldn’t have committed so many warships to the bridge defense.

Charlock, move to intercept! Those transports must not be allowed to land on the isle!"
            [/message]

            {MODIFY_UNIT id=carrackEast id Charlock} # change id to disable the existing MAI logic
            [micro_ai]
                side=8
                action=add
                ai_type=zone_guardian
                {FILTER id=Charlock}
                station_x=45
                station_y=13
                {FILTER_LOCATION x,y=40-99,10-19}
            [/micro_ai]
        [/event]
    [/event]

    #############################
    # LISAR LANDS
    #############################
    [event]
        name=moveto
        {FILTER role,x,y=lisar_skiff,35,17}

        {SCROLL_TO $unit.x $unit.y}
        {UNSTORE_NPC Lisar x,y=34,16 side,facing=7,nw}
        [modify_side]
            side=7
            hidden=no
        [/modify_side]
        {MODIFY_TERRAIN Ke 34 16} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 33 16} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 33 17} {REDRAW} {DELAY 150}
        {MODIFY_TERRAIN Ce 34 17} {REDRAW} {DELAY 150}
        {DELAY 250}

        [message]
            speaker=Lisar
            message=_"Elensefar Isle. Good work everyone — they weren’t ready for us to press the Carcyn fishers into service. But our fight’s not done yet."
        [/message]
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"              "Bowman"            "Longbowman"        "Longbowman"       }) 33 16 ( {ANIMATE}{FACING sw}{ZONE_GUARDIAN 33 15 x,y,radius=34,16,3} )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    }) 33 17 ( {ANIMATE}{FACING sw}{ZONE_GUARDIAN 31 17 x,y,radius=31,17,1} )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 34 17 ( {ANIMATE}{FACING sw}{ZONE_GUARDIAN 32 18 x,y,radius=34,16,3} )}
        {MODIFY_UNIT (side=7 {NOT trait=mechanical}) moves 0} # including Li'sar
        [message]
            speaker=Lisar
            message=_"Secure a beachhead and prepare to receive the rest of the boats. We must act swiftly, before they can pivot their defenses."
        [/message]
        {DELAY 500}

        #------------------------
        # KONRAD SPEAKS TO LI'SAR
        #------------------------
        {IF} {VARIABLE_CONDITIONAL bm_met_lisar_early equals yes} {THEN(
            [message]
                speaker=Konrad
                message=_"We meet again, princess! I’ve beaten you before, and I’ll do so again. Elensefar deserves a better ruler than you."
            [/message]
            [message]
                speaker=Lisar
                message=_"Konrad. I underestimated you once before — never again. You should have picked a different battle, princeling."
            [/message]
        )} {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"Your Highness, we meet at last! I’ve heard stories about the battles you’ve won in your mother’s name. I won’t let Elensefar be one of them!"
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION mad}
                message=_"Hello, “Konrad.” I think you’re a little out of your depth, pretender — the battlefield is no place for a con man."
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION mad}
                message=_"Your lies have sown enough discord and chaos among my people. How convenient that you’re here; I can capture both you and Maddock at the same time."
            [/message]
        )} {/IF}

        #------------------------
        # MADDOCK SPEAKS TO LI'SAR
        #------------------------
        [event]
            name=turn 9
            {FILTER_CONDITION({HAVE_UNIT id=Lisar})}
            [message]
                speaker=Lisar
                message=_"You’ve been a capable lord, Maddock, and from what I can tell you truly care about your city. If it’s any consolation, when all’s said and done I intend to make sure you stand a fair trial."
            [/message]
            [message]
                speaker=Lisar
                message=_"As for you, Delfador... you’re going to regret what you did to my brother."
            [/message]
            [message]
                speaker=Maddock
                message=_"Elensefar has weathered countless storms, Your Highness. Your queen will be neither the first nor the last that breaks upon our shores."
            [/message]
        [/event]
    [/event]

    #############################
    # ANY BOAT UNLOADS ITS CARGO
    #############################
    [event]
        name=moveto
        first_time_only=no
        {FILTER( side,trait,x,y=7,mechanical,36,16-17 {NOT role=lisar_skiff}{NOT role=boat1}{NOT role=boat2} )} # for some reason, role doesn't accept multiple values

        # Skiffs are bigger and higher-level; they give more gold
        {IF} {VARIABLE_CONDITIONAL unit.level greater_than_equal_to 2} {THEN(
            [gold]
                side=7
                amount={ON_DIFFICULTY4 15 25 30 40}
            [/gold]
            [floating_text]
                x,y=$unit.x,$unit.y
                text="<span color='#FFD700' size='x-small'>" + _"{ON_DIFFICULTY4 15 25 30 40} gold" + "</span>"
            [/floating_text]
        )}
        # Rafts are smaller and lower-level; they give less gold
        {ELSE(
            [gold]
                side=7
                amount={ON_DIFFICULTY4 10 15 20 25}
            [/gold]
            [floating_text]
                x,y=$unit.x,$unit.y
                text="<span color='#FFD700' size='x-small'>" + _"{ON_DIFFICULTY4 10 15 20 25} gold" + "</span>"
            [/floating_text]
        )} {/IF}
        {SOUND gold.ogg}
        {KILL id=$unit.id}
    [/event]

    #############################
    # SPAWN BOATS
    #############################
    [event]
        name=side 7 turn
        first_time_only=no
        {FILTER_CONDITION({HAVE_UNIT id=Lisar})}
        {FILTER_CONDITION({LUA(<< return (wesnoth.current.turn%3==0) >>)})} # spawn on turn 3, 6, 9, 12, etc

        # spawn fewer boats if Lisar is already strong
        {IF} {HAVE_UNIT( side,count=7,0-99 {NOT role=lisar_skiff}{NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 2} )} {/IF}
        {IF} {HAVE_UNIT( side,count=7,0-10 {NOT role=lisar_skiff}{NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 3} )} {/IF}
        {IF} {HAVE_UNIT( side,count=7,0-8  {NOT role=lisar_skiff}{NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 4} )} {/IF}
        {IF} {HAVE_UNIT( side,count=7,0-6  {NOT role=lisar_skiff}{NOT role=boat1}{NOT role=boat2} )} {THEN( {VARIABLE_OP repeat rand 5} )} {/IF}

        {REPEAT $repeat (
            {VARIABLE_OP type  rand "Raft,Raft,Skiff"}
            {VARIABLE_OP x     rand 57,58}
            {VARIABLE_OP y     rand 11,12,13,14,15,16,17,18,19,20}
            {GENERIC_UNIT 7 $type $x $y}
        )}
        {CLEAR_VARIABLE x,y,type,rand}
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # LISAR ATTACK BOAT SUNK
    #############################
    [event]
        name=last breath
        {FILTER role=lisar_skiff}
        {FILTER_CONDITION({NOT({HAVE_UNIT id=Lisar})})}

        [message]
            role=lisar_skiff
            caption=_"Li’sar"
            image=portraits/lisar.webp
            message=_"—how did you know?! It seems I’m not half so clever as I thought."
        [/message]
        [message]
            role=lisar_skiff
            caption=_"Li’sar"
            image=portraits/lisar.webp
            message=_"You win this round, Konrad. I need to get out of here before this boat takes any more damage."
        [/message]
        {MOVE_UNIT role=lisar_skiff 58 17}
        {KILL side,trait=7,mechanical}

        {VARIABLE_OP leaders_killed add 1}
        {FIRE_EVENT check_for_victory}
        [show_objectives]
        [/show_objectives]
    [/event]
    #############################
    # LISAR ESCAPE BOATS SUNK
    #############################
    [event]
        name=last breath
        {FILTER side,trait=7,mechanical}
        {FILTER_CONDITION({NOT({HAVE_UNIT( role=lisar_skiff {OR role=boat1} {OR role=boat2} )})})}
        [message]
            speaker=Lisar
            message=_"My last landed boat is badly damaged! I hate to retreat, but I can’t risk being trapped here and captured."
        [/message]
        {FIRE_EVENT lisar_flee_on_boat}
    [/event]
    #############################
    # LISAR LAST BREATH
    #############################
    [event]
        name=last breath
        {FILTER id=Lisar}
        {FIRE_EVENT lisar_flee_on_boat}
    [/event]
    [event]
        name=lisar_flee_on_boat
        {IF} {VARIABLE_CONDITIONAL bm_met_lisar_early equals yes} {THEN(
            [message]
                speaker=Lisar
                message=_"You prove your skills once again, cousin. A worthy foe indeed... Elensefar survives another day."
            [/message]
        )} {ELSE(
            [message]
                speaker=Lisar
                message=_"I underestimated you, “cousin” — it seems you’re more than just a good actor and a pretty face. I may be forced to flee the field today, but this isn’t over."
            [/message]
        )} {/IF}

        [store_unit]
            {FILTER( role=lisar_skiff {OR role=boat1} {OR role=boat2} )}
            variable=stored_boats
        [/store_unit]
        {STORE_NPC Lisar}
        {FAKE_UNIT_MOVE $stored_Lisar.x $stored_boats[0].x $stored_Lisar.y $stored_boats[0].y 9 "Princess" ()}

        {KILL( side=7 {NOT find_in=stored_boats} )}
        [foreach]
            array=stored_boats
            variable=boat
            [do]
                {MOVE_UNIT id=$boat.id 58 17}
                {KILL id=$boat.id}
            [/do]
        [/foreach]
        {KILL side=7}

        {VARIABLE_OP leaders_killed add 1}
        {FIRE_EVENT check_for_victory}
        [show_objectives]
        [/show_objectives]
    [/event]

    #############################
    # ONE LEADER KILLED
    #############################
    [event]
        name=die
        {FILTER( side=2,3,4,5,6 {AND canrecruit=yes} )}
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"That’s the first of the besieging leaders defeated! Keep pressing the attack!"
        [/message]
    [/event]

    #############################
    # THREE LEADERS KILLED
    #############################
    [event]
        name=die
        first_time_only=no
        {FILTER( side=2,3,4,5,6 {AND canrecruit=yes} )}
        {VARIABLE_OP leaders_killed add 1}
        {FIRE_EVENT check_for_victory}
        [show_objectives]
        [/show_objectives]
    [/event]
    [event]
        name=check_for_victory
        {FILTER_CONDITION({VARIABLE_CONDITIONAL leaders_killed greater_than_equal_to $leaders_to_kill})}
        {DELAY 250}
        {IF} {HAVE_UNIT( count=5-99 {AND side=2,3,4,5,6,7} {FILTER_LOCATION x,y,radius=19,18,4} )} {THEN(
            {VARIABLE lisar_almost_won yes}
        )} {/IF}

        #------------------------
        # HUMANS DEAD: ORCS FLEE
        #------------------------
        {IF} {HAVE_UNIT race,canrecruit=orc,yes} {THEN(
            [message]
                race=orc
                canrecruit=yes
                message=_"Forget this! I was promised an easy fight full of plunder, not a flank and a rout! Deal with your problems yourselves, pink-skins."
            [/message]
            {KILL side=5,6}
            {IF} {VARIABLE_CONDITIONAL lisar_almost_won equals yes} {THEN(
                [message]
                    id=Lisar {OR( side=2,3,4,5,6 {AND race,canrecruit,formula=human,yes,"(self.hitpoints>0)"} )}
                    message=_"They’ve gone. I hate to retreat, but without support I can’t risk being trapped here and captured. We came so, so close to taking the city!"
                [/message]
            )} {ELSE(
                [message]
                    id=Lisar {OR( side=2,3,4,5,6 {AND race,canrecruit,formula=human,yes,"(self.hitpoints>0)"} )}
                    message=_"They’ve gone. I hate to retreat, but without support I can’t risk being trapped here and captured. We already pushed dangerously hard just to get this far."
                [/message]
            )} {/IF}
        )}
        #------------------------
        # ORCS DEAD: HUMANS FLEE
        #------------------------
        {ELSE(
            [message]
                side=2,3,4
                canrecruit=yes
                {NOT id=Lisar}
                message=_"Useless orcs! You were hired for a siege, not a rout!"
            [/message]
            {IF} {VARIABLE_CONDITIONAL lisar_almost_won equals yes} {THEN(
                [message]
                    id=Lisar {OR( side=2,3,4 {AND canrecruit=yes} )}
                    message=_"I hate to retreat, but we’re already overextended pushing this far into the city. With the north shore fallen, I can’t risk the whole army any further. We came so, so close to taking the city!"
                [/message]
            )} {ELSE(
                [message]
                    id=Lisar {OR( side=2,3,4 {AND canrecruit=yes} )}
                    message=_"I hate to retreat, but with the north shore fallen we have little hope of taking the city. We already pushed dangerously hard just to get this far — I can’t risk things any further."
                [/message]
            )} {/IF}
        )} {/IF}

        {FIRE_EVENT victory_cutscene}
    [/event]
    [event]
        name=victory_cutscene
        {IF} {HAVE_UNIT id=Lisar} {THEN(
            {FIRE_EVENT lisar_flee_on_boat}
        )} {/IF}
        {KILL side=2,3,4,5,6,7}
        #------------------------
        # CELEBRATION
        #------------------------
        {DELAY 750}
        [message]
            speaker=Konrad
            message=_"We’ve driven them back! The siege of Elensefar is over!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Well done, Konrad. I was worried when you decided to join the fight, but Maddock and I could not have carried the day without your help. Together we have won a great victory over tyrrany."
        [/message]
        [message]
            speaker=Maddock
            message=_"Pigs will fly before the silver city bows to any queen. After the thrashing we gave them, they won’t return anytime soon."
        [/message]
        [message]
            speaker=Maddock
            message=_"Konrad, Elensefar is in your debt today. What soldiers I can spare are now yours to command — as well as many of the Elensefar thieves’ guild’s more enterprising young robbers."
        [/message]
        {NEW_RECRUIT3 (Swordsman,Pikeman,Thief) _"Konrad can now recruit Swordsmen, Pikemen, and Thieves!" human-loyalists/swordsman.png human-loyalists/pikeman.png human-outlaws/thief+female.png}
        [message]
            speaker=Maddock
            message=_"May they serve you well. Keep up the good fight, my lord."
        [/message]

#ifdef NIGHTMARE
        {ACHIEVE s10}
#endif

        {CLEAR_VARIABLE s10_from_north,s10_from_west}
        {CLEAR_VARIABLE leaders_to_kill,leaders_killed,lisar_almost_won}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # TIME LOW
    #############################
    [event]
        name=turn $({SCENARIO_TURN_LIMIT}-4)
        [message]
            side=2,3,4,7 {AND canrecruit=no}
            message=_"Sirs, we’re running low on supplies. We have only a few more chances to take Elensefar castle’s storerooms before we’ll be forced to retreat!"
        [/message]
        [message]
            side=5,6 {AND canrecruit=yes}
            message=_"Bah, this is starting to get ridiculous. I’m not sticking around forever, no matter what your queen promises me!"
        [/message]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=time over
        [message]
            side=5,6 {AND canrecruit=yes}
            message=_"Forget this! I was promised an easy fight full of plunder, not this siege that never ends! Deal with your problems yourselves, pink-skins."
        [/message]
        [message]
            speaker=Lisar
            message=_"I hate to retreat, but we’re already overextended pushing just this far. We already exerted ourselves dangerously hard — I can’t risk things any further."
        [/message]

        {FIRE_EVENT victory_cutscene}
    [/event]

    #############################
    # MADDOCK DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Maddock}
        [message]
            speaker=Maddock
            message=_"I surrender! I am beaten!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Alas, Maddock has capitulated. Elensefar is lost!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]

#undef ELENSEFAR_BEFORE_AVOID_AREA
#undef CARRACK_MAI
#undef WESNOTH_SIDE
#undef FOXTAIL_SIDE
#undef TOD_OFFSET
#undef SCENARIO_TURN_LIMIT
