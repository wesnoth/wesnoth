#textdomain wesnoth-h2tt
# scenario by Dalas

[scenario]
    id=01_The_Elves_Besieged
    map_file=01_The_Elves_Besieged.map
    name=_"The Elves Besieged"
    next_scenario=00_The_Great_Continent
    victory_when_enemies_defeated=no
    {DEFAULT_SCHEDULE} # dawn, thus why konrad is sleeping
    # if I change the initial `current_time`, remember to change IMPLEMENT_FIRES too
    # and remember to change the [replace_schedule] that we use after [end_turn]
    turns=-1
    {SCENARIO_MUSIC wanderer.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}

    # prepare NPCs. The NPCs created here are stored and reused for every scenario in this campaign
    [event]
        name=prestart
        {FIRE_EVENT spawn_npcs}
    [/event]

    #######################################################################################################################################################
    #                                                                    HTTT INTRO
    #######################################################################################################################################################
    [story]
        [part]
            music=revelation.ogg
            story= _ "In the twenty-eighth year of the reign of Garard II, King of Wesnoth, the kingdom was plunged into a bitter war with the Orcs of the North."
            {HTTT_BIGMAP}
        [/part]
        [part]
            # wmllint: local spelling Galcadar
            story= _ "The Northern host encamped at Galcadar, by the Ford of Abez, and the King led his forces to meet them. Years of war brought Wesnoth to the brink of ruin, but at long last victory was won through the actions of Garard’s arch-mage, Delfador."
            {HTTT_BIGMAP}
        [/part]
        [part]
            story= _ "Garard’s son, the Crown Prince Eldred, joined in the revelry as the King celebrated his victory. Eldred was bright and driven, and might one day have grown into a wise ruler. Unfortunately for Garard, his son was also ambitious... and treacherous."
            background=story/httt_story1.webp
        [/part]
        [part]
            story= _ "At the height of Garard’s triumph, Eldred struck the old King down in cold blood. Proclaiming himself heir, the young prince led his father’s army south towards Weldyn."
            background=story/httt_story2.webp
        [/part]
        [part]
            story= _ "Garard’s queen, Asheviere, looked on with glee, having orchestrated much of her son’s treachery. The rule of Eldred would surely satisfy her lust for power far better than her husband’s had."
            background=story/httt_story3.webp
        [/part]
        [part]
            story= _ "But Delfador the arch-mage had not fallen alongside his king. Returning from a distant battle, he mustered a force of loyalists to fight the young prince and avenge the King’s death. The loyalist army marched south to meet Eldred."
            background=story/httt_story4.webp
        [/part]
        [part]
            story= _ "Eldred made war upon the loyalists with his mother’s advice ringing in his ears: <i>“Fight no one great or small except the old mage, whose head should be severed from his shoulders.”</i>"
            {HTTT_BIGMAP}
        [/part]
        [part]
            story= _ "And Eldred did indeed meet Delfador face-to-face in battle, along the high road to Weldyn. Sword clashed against staff, as the wise old mage fought the brash young warrior."
            background=story/httt_story5.webp
        [/part]
        [part]
            story= _ "In the end Delfador’s men were defeated and routed, but Asheviere found her son’s lifeless body, fixed to the ground by the great mage’s staff."
            background=story/httt_story6.webp
        [/part]
        [part]
            story= _ "Asheviere herself then took command of the army and led it back to Weldyn. Knowing that the King’s young nephews were next in line to the throne, she ordered them all killed and declared herself Queen of Wesnoth, striking down any lord bold enough to oppose her."
            {HTTT_BIGMAP}
        [/part]
        [part]
            story= _ "Soon after news of Asheviere’s orders reached Delfador, he secretly entered the palace and stole away Konrad, the youngest of Garard’s nephews, thereby saving him from death."
            background=story/httt_story7.webp
        [/part]
        [part]
            story= _ "Fleeing to the Aethenwood beyond the south-western border of Wesnoth, Delfador raised the child Konrad under the protection of the elves, watching sadly as Asheviere’s reign of terror over the land began..."
            background=story/httt_story8.webp
        [/part]
    [/story]

    #######################################################################################################################################################
    #                                                                   KONRAD AT HOME
    #######################################################################################################################################################
    # need to do this last, because it temporariy stores all the previously-created units
    [event]
        name=prestart
        priority=-50
        [store_unit]
            {FILTER( id=Konrad )}
            kill=yes
            variable=stored_s01_konrad
        [/store_unit]
        [store_unit]
            {FILTER( {NOT id=Konrad} )}
            kill=yes
            variable=stored_s01_units
        [/store_unit]

        #############################
        # SET UP NEW MAP
        #############################
        [replace_map]
            map_file=01a_Home.map
            expand=yes
            shrink=yes
        [/replace_map]
        [zoom]
            factor=0.8
            relative=no
        [/zoom]
        {PLACE_IMAGE items/gohere.png            17 11}
        {PLACE_IMAGE items/gohere.png            18 10}
        {PLACE_IMAGE items/bed.png               13  5}
        {PLACE_IMAGE items/flower-blue.png       12  4}
        {PLACE_IMAGE items/flower-orange.png     13  4}
        {PLACE_IMAGE "items/flower-red.png~FL()" 14  5}
        {PLACE_IMAGE items/flower3.png           15 11}
        {PLACE_IMAGE items/boxes.png             10  6}
        {PLACE_IMAGE items/desk.png              11  6}
        {PLACE_IMAGE items/chair.png             12  6}
        {PLACE_IMAGE items/konrad-weapons.png    12  7}
        {PLACE_HALO  items/counter.png           18  6}
        {PLACE_HALO  items/bookshelves.png       15  7}
        {GENERIC_UNIT 4 Quintain 9 11} {FACING ne}
        {GENERIC_UNIT 4 Quintain 9 12} {FACING ne}
        [zoom]
            factor=1
            relative=no
        [/zoom]
        [place_shroud]
            side=1 # fill entire map with shroud
        [/place_shroud]
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {SCROLL_TO 13 1}

        # this gold pickup serves as a lure, to make players trigger the bookshelf event
        # (and the bookshelf event teaches the player that there are more events in the house)
        {GOLD_PICKUP 17 6 items/gold-coins-small.png 10 _"10 gold" _"A little gold for use in magical experiments. I’m sure it won’t be missed."}
        [modify_side]
            side=1
            income=-2
        [/modify_side]
    [/event]

    #############################
    # EMULATE BIGMAP
    #############################
    [event]
        name=start
        [disallow_end_turn]
        [/disallow_end_turn]
    [/event]
    [event]
        name=moveto,unit placed,attack end
        first_time_only=no
        {FILTER id=Konrad}
        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
        [heal_unit]
            {FILTER id=Konrad}
            amount=0 # don't heal Konrad, since he can take 1 damage from his splinter
            moves=full
        [/heal_unit]
        {FULL_HEAL type=Quintain}
    [/event]
    [event]
        name=enter hex,unit placed
        first_time_only=no
        {FILTER id=Konrad}
        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
        [remove_shroud]
            {FILTER_SIDE side=1}
            x,y=$unit.x,$unit.y
            radius=7
        [/remove_shroud]
    [/event]

    #############################
    # KONRAD WAKES UP
    #############################
    [event]
        name=start
        {DELAY 1500}
        [message]
            speaker=narrator
            #po: this is Delfador trying to wake up a sleeping Kornad, as heard from Konrad's perspective
            message="<span size='xx-small'>" + _"Konrad!" + "</span>"
        [/message]
        [message]
            speaker=narrator
            #po: this is Delfador trying to wake up a sleeping Kornad, as heard from Konrad's perspective
            message="<span size='small'>" + _"Konrad, wake up!" + "</span>"
        [/message]
        {DELAY 1000}
        {SCREEN_FADER 0,0,0 255 0} # fade out now and back in later, so that shroud removal looks gradual
        [unit]
            {SINGLEUNITWML_KONRAD}
            side=1
            x,y=13,5
            facing=ne
            type=Sleeping_Fighter
        [/unit]
        {SWITCH_KONRAD_PORTRAIT young ""}
        {MODIFY_UNIT id=Konrad ellipse none}
        {SCREEN_FADER 0,0,0 000 500}
        [message]
            speaker=Konrad
            #po: the "dream" Konrad refers to is the intro storytext. This is a justification for the artwork (especially Delfador's age) not matching the characters' appearances.
            message=_"<i>(yawn)</i> What a vivid dream. Asheviere and Eldred, Delfador and Garard, just like in the histories..."
        [/message]
        {DELAY 500}
        [message]
            # if we're assuming the player is coming from TDG/AA/L, they don't yet know that Delfador is old (though the intro images are a pretty good clue)
            speaker=narrator
            caption=_"Delfador"
            image=portraits/delfador-elvish-unknown.png
            message=_"Wake up, wake up, wake up! Curse you Konrad, get up and get out here! We’re under attack!"
        [/message]
        {DELAY 250}
        [unit]
            {SINGLEUNITWML_KONRAD}
            side=1
            x,y=13,5
            facing=sw
            type=Unarmed_Fighter
            overwrite=yes
        [/unit]
        {SWITCH_KONRAD_PORTRAIT young ""}
        {DELAY 250}
        [message]
            speaker=Konrad
            #po: Konrad has heard Delfador calling him but is not concerned. In the past, Delfador has often surprised Konrad with training. In reality, there's a real battle beginning
            message=_"I’m up, I’m up. What’s the “attack” today, Delfador? Orcs in the walls? Magi under my bedsheets?"
        [/message]
        [message]
            speaker=narrator
            caption=_"Delfador"
            image=portraits/delfador-elvish-unknown.png
            message=_"No, you daft child, nothing like that! Grab your sword and come outside!"
        [/message]

        #############################
        # KONRAD GRABS HIS SWORD
        #############################
        {DELAY 500}
        {MOVE_UNIT id=Konrad 12 7}
        {FIRE_EVENT_UNIT enter_hex id=Konrad}
        {MODIFY_UNIT id=Konrad facing se}
        {DELAY 500}
        {REMOVE_IMAGE 12 7}
        [unstore_unit]
            x,y=12,7
            variable=stored_s01_konrad
        [/unstore_unit]
        {CLEAR_VARIABLE stored_s01_konrad}
        {SWITCH_KONRAD_PORTRAIT young ""}
        {GIVE_OBJECT_TO id=Konrad (
            id=konrad_emulate_bigmap
            {EFFECT movement set=50}
            {EFFECT movement_costs (
                replace=yes
                [movement_costs]
                    flat=1
                    sand=1
                    frozen=1
                    village=1
                    castle=1
                    fungus=20
                    deep_water=999
                    shallow_water=999
                    reef=999
                    swamp_water=999
                    forest=999
                    hills=999
                    mountains=999
                [/movement_costs]
            )}
            {EFFECT vision set=0}
        )}
        {MODIFY_UNIT id=Konrad moves 50}
        [message]
            speaker=Konrad
            #po: the intent of this is to show that 1) Konrad trains regularly with Delfador and 2) Konrad is living with and on friendly terms with elves, particulary Ethiliel
            message="<span size='small'>" + _"Well, I’d better do as he says. Last time I missed battle training, Ethiliel made me spend all week transcribing her poetry. <i>(shudder)</i>" + "</span>"
        [/message]
        [objectives]
            [objective]
                description= _ "Explore your home"
                condition=win
            [/objective]
            [objective]
                description= _ "Meet Delfador"
                condition=win
            [/objective]
        [/objectives]

        #############################
        # FLOWER EVENT
        #############################
        #         [event]
        #             name=enter hex
        #             {FILTER x,y=15,11}
        #             {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
        #             [message]
        #                 speaker=Konrad
        #                 #po: Konrad has just sniffed a flower
        #                 message=_"*sniff* Delicate and sweet. Delfador and Kaylan know much about warfare and politics, but Ethiliel is the one who understands beauty."
        #             [/message]
        #             [cancel_action]
        #             [/cancel_action]
        #         [/event]

        #############################
        # BED EVENT
        #############################
        [event]
            name=enter hex
            {FILTER x,y=13,5}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            [message]
                speaker=Konrad
                #po: the player has moved Konrad to his bed
                message=_"No time to rest! Got to train hard if I ever want to be a good king."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]

        #############################
        # DESK EVENT
        #############################
        [event]
            name=enter hex
            {FILTER( {FILTER_LOCATION x,y,radius=11,6,1} )}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            [message]
                speaker=Konrad
                #po: the player has moved Konrad near a writing desk. This foreshadows Asheveire's large-scale invasion
                message=_"Looks like Delfador’s written part of a letter. “<i>Sir Kaylan, I hope this missive finds you well. Lord Maddock’s latest report is worrying: the recent mobilization suggests...</i>”"
            [/message]
            [message]
                speaker=Konrad
                message=_"The letter trails off there."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]

        #############################
        # BOOKSHELF EVENT
        #############################
        [event]
            name=enter hex
            {FILTER x,y=16-17,7}
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            {MODIFY_UNIT id=Konrad facing nw}
            [message]
                speaker=Konrad
                #po: Konrad has moved near a bookshelf. These are the names of some of the books
                message=_"“<i>The Young Statesman’s Political Primer</i>”
“<i>Basics of Swordsmanship, feat. Sergeant Mari</i>”
“<i>An Abridged History of Wesnoth, by Delfador</i>”"
            [/message]
            [message]
                speaker=Konrad
                message=_"My textbooks, courtesy of the Aethenwood. The shelves get fuller every day."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]

        #############################
        # RIVER EVENT
        #############################
        #         [event]
        #             name=enter hex
        #             {FILTER( {FILTER_LOCATION terrain=W*^*} )}
        #             {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
        #             {SOUND water.wav}
        #             [message]
        #                 speaker=Konrad {KONRAD_VARIATION glad}
        #                 #po: Konrad is drinking or bathing in a stream
        #                 message=_"Ahhh, cool and refreshing. Delfador would probably worry it’s been poisoned."
        #             [/message]
        #             [cancel_action]
        #             [/cancel_action]
        #         [/event]

        #############################
        # QUINTAIN EVENT
        #############################
        # let Konrad attack the Quintain indefinitely to get XP, but make him pay hitpoints each time
        [event]
            name=attack end
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                #po: Konrad is attacking a quintain
                message=_"Hi-ya! Take that Eldred! Take that Asheviere!"
            [/message]
            [event]
                name=attack end
                {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                [event]
                    name=attack end
                    {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                    [event]
                        name=attack end
                        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                        [message]
                            speaker=Konrad
                            message=_"This is good practice! I’m starting to tire myself out."
                        [/message]
                        [event]
                            name=attack end
                            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                            [event]
                                name=attack end
                                {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                                [event]
                                    name=attack end
                                    {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                                    [event]
                                        name=attack end
                                        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                                        [event]
                                            name=attack end
                                            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                                            [message]
                                                speaker=Konrad {KONRAD_VARIATION concerned}
                                                message=_"Whew... I’m bruised and exhausted. It’s been good training so far, but if I keep throwing myself at this dummy I’m worried I might faint!"
                                            [/message]
                                        [/event]
                                    [/event]
                                [/event]
                            [/event]
                        [/event]
                    [/event]
                    {VARIABLE konrad_self_damage 1}
                    [event]
                        name=attack end
                        priority=-99 # always play this AFTER Konrad's messages
                        first_time_only=no
                        {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
                        [harm_unit]
                            {FILTER id=Konrad}
                            amount=$konrad_self_damage
                            animate=yes
                            kill=yes
                            fire_event=yes
                        [/harm_unit]
                        {VARIABLE_OP konrad_self_damage add 1} # ensure this damage scales fast enough that Konrad can't level up (and full heal)
                    [/event]
                [/event]
            [/event]
        [/event]
        [event]
            name=attack end
            first_time_only=no
            {FILTER_CONDITION( {HAVE_UNIT type=Quintain} )}
            {MODIFY_UNIT id=Konrad attacks_left 1}
        [/event]
    [/event]
    #######################################################################################################################################################
    #                                                                 KONRAD LEAVES HOME
    #######################################################################################################################################################
    [event]
        name=enter hex
        {FILTER( x,y=17,11 {OR x,y=18,10} )}
        [cancel_action]
        [/cancel_action]
        [message]
            speaker=Konrad
            #po: Konrad is leaving home, kicking off the main scenario
            message=_"Well, time to see what Delfador’s so excited about."
        [/message]
        {MOVE_UNIT id=Konrad 28 17}

        #############################
        # CLEAN UP
        #############################
        {SCREEN_FADER 0,0,0 255 500}
        {REMOVE_IMAGE 0-99 0-99}
        {REMOVE_LABEL 0-99 0-99}
        {KILL type=Quintain}
        {CLEAR_VARIABLE konrad_self_damage}

        [end_turn]  # so that we create a new save file
        [/end_turn] # do this before we unstore any of the S01 units
        [event]
            name=new turn
            #############################
            # RESTORE BATTLE MAP
            #############################
            [replace_map]
                map_file=01_The_Elves_Besieged.map
                expand=yes
                shrink=yes
            [/replace_map]
            [foreach]
                array=stored_s01_units
                [do]
                    [unstore_unit]
                        variable=this_item
                    [/unstore_unit]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE stored_s01_units}
            [remove_object]
                object_id=konrad_emulate_bigmap
            [/remove_object]
            [allow_end_turn]
            [/allow_end_turn]

            #############################
            # INITIALIZE GAME STATE
            #############################
            [modify_side]
                side=1
                shroud=no
                income=0
            [/modify_side]
            [replace_schedule]
                {DEFAULT_SCHEDULE}
            [/replace_schedule]
            {FIRE_EVENT play_battle}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE GOLD=86 SHROUD=yes}
    # +10 gold on all difficulties from a pickup in Konrad's house
    # +4 gold from income
    # gold is invisible at the start, so the unusual "86" number doesn't look unusual to the player
    # shroud only used for Konrad's house

    #############################
    # MEN
    #############################
    [side]
        side=2
        controller=ai
        color=wesred
        type=Red Mage
        id=redmage
        facing=sw
        gender=female
        {MODIFICATIONS( {TRAIT_INTELLIGENT} {TRAIT_QUICK} )}
        gold=90
        income=8 # plus 4 villages
        hidden=yes
        recruit=Mage
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]

    [event]
        name=prestart
        {UNSTORE_NPC Isolde x,y=55,5 side,facing=3,sw}
    [/event]
    [side]
        side=3
        controller=ai
        color=wesred
        gold=200
        income=13 # plus 5 villages
        hidden=yes
        recruit=Swordsman,Javelineer
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Spearman" 3}
    [event]
        name=play_battle
        [modify_side]
            side=2
            hidden=no
        [/modify_side]
        [modify_side]
            side=3
            hidden=no
        [/modify_side]
        [capture_village]
            side=2
            x,y=40,1
        [/capture_village]
        [capture_village]
            side=2
            x,y=49,6
            radius=2
        [/capture_village]
        [capture_village]
            side=3
            x,y=54,12
            radius=4
        [/capture_village]
    [/event]

    # side 4 is our "timer". He goes straight for Konrad and is fairly powerful
    [side]
        side=4
        controller=ai
        color=wesred
        type="Master at Arms"
        id=leader4
        facing=nw
        {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_QUICK} )}
        gold,income={ON_DIFFICULTY4 10 20 30 40},{ON_DIFFICULTY4 3 6 9 13} # minimal starting gold. But as income increases, recruited Duelists are fast and can get to Konrad quickly
        hidden=yes
        recruit=Duelist
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Fencer" {ON_DIFFICULTY4 0 1 1 2}}

    # sides 5 and 6 are less powerful, but are directly in Konrad's way (depending on the path he takes)
    [side]
        side=5
        controller=ai
        color=wesred
        type=Longbowman
        id=leader5
        facing=nw
        {MODIFICATIONS( {TRAIT_INTELLIGENT} {TRAIT_RESILIENT} )}
        gold={ON_DIFFICULTY4 20 40 60 80}
        income={ON_DIFFICULTY4 1 4 7 10}
        hidden=yes
        recruit=Bowman
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    [side]
        side=6
        controller=ai
        color=wesred
        type=Swordsman
        id=leader6
        facing=se
        {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_RESILIENT} )}
        gold={ON_DIFFICULTY4 30 60 90 120}
        income={ON_DIFFICULTY4 3 6 9 13}
        hidden=yes
        recruit=Spearman
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 5 1}
    {SILENTLY_LIMIT_LEADER_MOVES 6 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Spearman" {ON_DIFFICULTY4 0 1 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Bowman"   {ON_DIFFICULTY4 0 1 1 2}}
    [event]
        name=play_battle
        [modify_side]
            side=4
            hidden=no
        [/modify_side]
        [modify_side]
            side=5
            hidden=no
        [/modify_side]
        [modify_side]
            side=6
            hidden=no
        [/modify_side]
        [capture_village]
            side=4
            x,y=41,24
            radius=4
        [/capture_village]
        [capture_village]
            side=5
            x,y=24,21
            radius=6
        [/capture_village]
        [capture_village]
            side=6
            x,y=12,3
            radius=5
        [/capture_village]
    [/event]
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3   offensive 0.4 0.25}
        {RESET_SIDE_AI 4,5,6 offensive 0.4 0.25}

        # we assign our initial chasers to side 2, so it's important they always go after Konrad/Delfador
        {MODIFY_SIDE_AI 2 ({GOAL_UNIT 9 id=Konrad,Delfador})}
        {MODIFY_SIDE_AI 3 ({GOAL_UNIT 9 id=Galdrad})}

        # side 4 has no initial gold, but their units are fast. When they recruit, focus overwhelmingly on Konrad/Delfador
        # priority=99 helps them ignore Galdrad too, and their skirmisher lets them get around easily
        {MODIFY_SIDE_AI 4 ({GOAL_UNIT 99 id=Konrad,Delfador})}

        # side 5 starts going after Ethiliel (so their units move in a reasonable direction)
        # but will soon switch targets to Konrad, who's now probably already fighting side 5
        # remember that we start on turn 2; turn 1 is Konrad inside his home
        {IF} {LUA(<<return wesnoth.current.turn<=4>>)}
        {THEN( {MODIFY_SIDE_AI 5 ({GOAL_SEEK_SIDE 9 7 0})} )}
        {ELSE( {MODIFY_SIDE_AI 5 ({GOAL_UNIT      9 id=Konrad,Delfador})} )}
        {/IF}

        # let side 6 act freely, splitting its attention between Ethiliel and Konrad

        # avoid fires
        [store_items]
            item_name=fire
            variable=fires
        [/store_items]
        {MODIFY_SIDE_AI 2,3,4,5,6 (
            [avoid]
                find_in=fires # this doesn't affect their zone_guardians
            [/avoid]
        )}
    [/event]

    #############################
    # ELVES
    #############################
    [event]
        name=prestart
        {UNSTORE_NPC Ethiliel x,y=13,13 side,facing=7,nw}
    [/event]
    [side]
        side=7
        controller=ai
        color=brightgreen
        hidden=yes
        recruit=Elvish Ranger
        gold={ON_DIFFICULTY4 40 60 80 100}
        income={ON_DIFFICULTY4 4 7 10 12} # plus 2-4 villages, and >>4 upkeep. Don't let them die too easily, or Flight doesn't make sense
        team_name=konrad
        user_team_name=_"Aethenwood Elves"
        {FLAG_VARIANT wood-elvish}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 7 0}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Elvish Marksman" {ON_DIFFICULTY4 0 1 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Elvish Hero" 1}

    [event]
        name=prestart
        {UNSTORE_NPC Galdrad x,y=35,16 side,facing=8,se}
    [/event]
    [side]
        side=8
        controller=ai
        color=brightgreen
        hidden=yes
        gold=200 # fixed gold/income for Galdrad and Isolde/mage, since their fights don't affect Konrad
        income=8
        recruit=Elvish Hero
        team_name=konrad
        user_team_name=_"Aethenwood Elves"
        {FLAG_VARIANT wood-elvish}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 8 0}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Elvish Captain" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Elvish Ranger"  1}

    [event]
        name=play_battle
        [modify_side]
            side=7
            hidden=no
        [/modify_side]
        [modify_side]
            side=8
            hidden=no
        [/modify_side]
        [capture_village]
            side=7
            x,y=10,18
            radius=9
        [/capture_village]
        [capture_village]
            side=8
            x,y=34,13
            radius=5
        [/capture_village]
    [/event]
    [event]
        name=side 7 turn
        first_time_only=no
        {RESET_SIDE_AI 7,8 no 0.1 0.9}

        # Ethiliel's AI. Stay near leader and avoid fires
        # make her avoid large enough to let her fight side 5 a little,
        # but not so large that she intercepts the "surround the enclaves" guys
        {MODIFY_SIDE_AI 7 ({GOAL_LOCATION 3 x,y=10,13})}
        {MODIFY_SIDE_AI 7 ({GOAL_LOCATION 3 x,y=14,16})}
        {MODIFY_SIDE_AI 7 ({GOAL_LOCATION 2 x,y=12,15})}
        {MODIFY_SIDE_AI 7 ({GOAL_LOCATION 2 x,y=14,13})}
        {MODIFY_SIDE_AI 7 ({GOAL_LOCATION 2 x,y=13,12})}
        {MODIFY_SIDE_AI 7 (
            [avoid]
                {NOT x,y,radius=13,15,4}
                {OR find_in=fires}
            [/avoid]
        )}

        # Galdrad's AI. Focus on Isolde, avoid the duelists, stay on forest, and retreat when weak
        {IF} {HAVE_UNIT side,count=8,5-99} {THEN(
            {MODIFY_SIDE_AI 8 ({GOAL_SEEK_SIDE 9 3 0})}
        )} {ELSE(
            {MODIFY_SIDE_AI 8 ({GOAL_LOCATION 3 x,y=35,12})}
            {MODIFY_SIDE_AI 8 ({GOAL_LOCATION 3 x,y=38,15})}
            {MODIFY_SIDE_AI 8 ({GOAL_LOCATION 2 x,y=36,14})}
            {MODIFY_SIDE_AI 8 ({GOAL_LOCATION 2 x,y=38,17})}
            {MODIFY_SIDE_AI 8 ({GOAL_LOCATION 1 x,y=33,14})}
            {MODIFY_SIDE_AI 8 ({GOAL_LOCATION 1 x,y=34,17})}
        )} {/IF}
        {MODIFY_SIDE_AI 8 (
            [avoid]
                {NOT terrain=*^F*,C*^*,K*^*,*^V*}
                {OR({NOT x,y,radius=38,14,7})}
                {OR find_in=fires}
            [/avoid]
        )}
    [/event]
    [event]
        name=side 8 turn 8
        # this is about when Galdrad's initial recruits all die and Wesnoth starts getting close to him
        # give him more gold to help fight back
        [gold]
            side=8
            amount=125
        [/gold]
        # give Isolde and her mage a boost too
        [event]
            name=side 2 turn
            [gold]
                side=2,3
                amount=60
            [/gold]
        [/event]
    [/event]

    [side] # Delfador dummy side
        side=9
        controller=null
        color=blue
        hidden=yes
        no_leader=yes
        team_name=konrad
    [/side]

    #######################################################################################################################################################
    #                                                                  PLAY MAIN SCENARIO
    #######################################################################################################################################################
    [event]
        name=play_battle

        #############################
        # NORTHWEST FIRES
        #############################
        {PLACE_FIRE  3  9}
        {PLACE_FIRE  7 10}

        {PLACE_FIRE 11  8}
        {PLACE_FIRE 13  9}
        {PLACE_FIRE 14  8}
        {PLACE_FIRE 15  8}
        {PLACE_FIRE 15  7}

        #############################
        # NORTHEAST FIRES
        #############################
        # start these further away from Konrad, so it's not so weird he didn't notice thet attack
        {PLACE_FIRE 19  2}
        {PLACE_FIRE 21  1}

        {PLACE_FIRE 27  1}
        {PLACE_FIRE 28  1}

        {PLACE_FIRE 36  4}
        {PLACE_FIRE 37  6}
        {PLACE_FIRE 37  7}

        #############################
        # EASTERN FIRES
        #############################
        {PLACE_FIRE 39 10}
        {PLACE_FIRE 40 10}

        {PLACE_FIRE 44 12}
        {PLACE_FIRE 45 12}
        {PLACE_FIRE 47 13}
        {PLACE_FIRE 46 12}
        {PLACE_FIRE 48 14}
        {PLACE_FIRE 47 16}
        {PLACE_FIRE 46 17}

        #############################
        # SOUTHERN FIRES
        #############################
        {PLACE_FIRE 17 26}
        {PLACE_FIRE 18 25}
        {PLACE_FIRE 19 26}
        {PLACE_FIRE 23 24}
        {PLACE_FIRE 25 21}
        # nothing near 31,20 or 36,22 - Galdrad already has a lot of fire around him

        # do this before fires tick (which takes a while), so that music starts while we fade in
        {FADE_MUSIC_OUT 250}
        {REPLACE_SCENARIO_MUSIC siege_of_laurelmor.ogg}
        {APPEND_MUSIC the_dangerous_symphony.ogg}

        # fires start out having already burned a little
        {IMPLEMENT_FIRES 5}
        {FIRE_EVENT tick_fires}

        #############################
        # ELVISH GUARDS
        #############################
        {GENERIC_UNIT 7 (Elvish Ranger)  14 16} {FACING nw} {GENDER female} {ZONE_GUARDIAN 14 16 x,y,radius=11,14,2}
        {GENERIC_UNIT 7 (Elvish Archer)  10 13} {FACING ne} {GENDER male  } {ZONE_GUARDIAN 10 13 x,y,radius=13,16,2}
        {GENERIC_UNIT 7 (Elvish Archer)  18 13} {FACING nw} {GENDER female} {ZONE_GUARDIAN 18 13 x,y,radius=17,13,2}
        {GENERIC_UNIT 8 (Elvish Fighter) 35 13} {FACING ne} {ZONE_GUARDIAN 35 13 x,y,radius=33,13,1}
        {GENERIC_UNIT 8 (Elvish Hero)    38 15} {FACING nw} {ZONE_GUARDIAN 38 15 x,y,radius=38,15,1}
        {GENERIC_UNIT 8 (Elvish Archer)  34 15} {FACING ne} {GENDER female}

        #############################
        # HUMAN GUARDS
        #############################
        {GENERIC_UNIT 4 (Spearman)  44 22} {FACING se} {ZONE_GUARDIAN 44 22 ( x,y,radius=43,24,3 )}
        {GENERIC_UNIT 5 (Spearman)  30 24} {FACING nw} {ZONE_GUARDIAN 30 24 ( x,y,radius=28,26,4 )}
        {GENERIC_UNIT 6 (Spearman)   7  5} {FACING se} {ZONE_GUARDIAN  7  5 ( x,y,radius=6,3,3 )}
        {GENERIC_UNIT 6 (Bowman)     3  4} {FACING se} {ZONE_GUARDIAN  3  4 ( x,y,radius=6,3,3 )}

        #############################
        # HUMAN ATTACKERS
        #############################
        # no side 4 guards; Galdrad doesn't need any more initial pressure than he already has

        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "Bowman"   "Bowman"   "Bowman"   "Bowman"   } 27 25 ({ROLE quick}{ZONE_GUARDIAN 11 21 ( {FILTER side=1} {AND x,y,radius=4,26,14} )})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "none"     "Fencer"   "Fencer"   } 24 26 ({ROLE quick}{ZONE_GUARDIAN 15 23 ( {FILTER side=1} {AND x,y,radius=4,26,14} )})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "none"     "none"     "Bowman"   } 31 25 ({ROLE quick}{ZONE_GUARDIAN  8 24 ( {FILTER side=1} {AND x,y,radius=4,26,14} )})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"   } 27 26 ({ROLE quick}{ZONE_GUARDIAN  2 19 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 28 24 ({ROLE quick}{ZONE_GUARDIAN 18 19 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"   } 22 26 ({ROLE quick}{ZONE_GUARDIAN  4 20 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"   } 27 26 ({ROLE quick}{ZONE_GUARDIAN  5 25 ( {FILTER side=1} {AND x,y,radius=1,23,10} )})}

        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 25 22 ()}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "none"     "none"     "Bowman"   } 27 23 ()}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"     "none"     "Spearman" "Spearman" } 31 22 ()}

        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" }  6  3 ({ROLE quick}{ZONE_GUARDIAN  2 15 ( {FILTER side=1} {AND x,y,radius=1,15-22,8 } )})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"   }  8  3 ({ROLE quick}{ZONE_GUARDIAN  1 14 ( {FILTER side=1} {AND x,y,radius=1,15-22,8 } )})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "none"     "Fencer"   "Fencer"   }  9  3 ({ROLE quick}{ZONE_GUARDIAN  5 16 ( {FILTER side=1} {AND x,y,radius=1,15-22,8 } )})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman" } 11  4 ()}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "none"     "none"     "Bowman"   } 12  3 ()}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 17  3 ()}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none"     "none"     "none"     "Spearman" } 16  3 ()}

        {GENERIC_UNIT 4 "Merchant Carrack" 51 25} {FACING sw} {GUARDIAN}
        {GENERIC_UNIT 4 "Merchant Carrack" 54 22} {FACING sw} {GUARDIAN}
        {MODIFY_UNIT type="Merchant Carrack" upkeep loyal}
        # no upkeep so we don't affect income. Don't use the loyal trait because the overlay bar looks a little silly for these, since these ships are basically just cosmetic

        #############################
        # KONRAD
        #############################
        {MODIFY_UNIT id=Konrad attacks_left 1}
        {PUT_TO_RECALL_LIST id=Konrad}
        {GIVE_OBJECT_TO id=Konrad (
            id=konrad_silver_crown_object
            {EFFECT overlay remove=misc/leader-crown.png}
            {EFFECT overlay add=misc/leader-expendable.png}
        )}

        #############################
        # DELFADOR
        #############################
        {UNSTORE_NPC Delfador x,y=25,9 (
            side=9
            facing=sw
            hitpoints=27
            experience=5
        )}
        [set_extra_recruit]
            id=Delfador
            extra_recruit=Mudcrawler,Giant Mudcrawler,Fire Guardian,Fire Wraith
        [/set_extra_recruit]
        {PUT_TO_RECALL_LIST id=Delfador} # need to do this to make the AMLAs object apply properly
        {RECALL_XY Delfador 24 9}
        [capture_village]
            side=1
            x,y=25,10
            radius=5
        [/capture_village]

        #############################
        # FADE IN
        #############################
        {FADE_MUSIC_IN 0}
        {SCROLL_TO 50 1}
        [hide_unit]
            id=redmage,Isolde
        [/hide_unit]
        {SCREEN_FADER 0,0,0 000 500}

        #############################
        # ENEMIES ARRIVE
        #############################
        [unhide_unit]
            id=redmage
        [/unhide_unit]
        {DELAY 250}
        {MOVE_UNIT id=redmage 50 6}
        {DELAY 250}
        [unhide_unit]
            id=Isolde
        [/unhide_unit]
        {MOVE_UNIT id=Isolde 54 9}
        {DELAY 250}

        {GENERIC_UNIT 2 (Bowman)    48  7} {ANIMATE} {FACING sw} {ZONE_GUARDIAN 48  7 ( {AND x,y,radius=50,7,3} {OR x,y,radius=55,10,4} )}
        {GENERIC_UNIT 2 (Swordsman) 52  8} {ANIMATE} {FACING sw} {ZONE_GUARDIAN 52  8 ( {AND x,y,radius=50,7,3} {OR x,y,radius=55,10,4} )}
        {GENERIC_UNIT 3 (Spearman)  52 10} {ANIMATE} {FACING sw} {ZONE_GUARDIAN 52 11 ( {AND x,y,radius=50,7,3} {OR x,y,radius=55,10,4} )}
        {GENERIC_UNIT 3 (Spearman)  55 13} {ANIMATE} {FACING sw} {ZONE_GUARDIAN 55 13 ( {AND x,y,radius=50,7,3} {OR x,y,radius=55,10,4} )}

        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "none"     "none"     "Mage"     } 49  6 ({ANIMATE})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "Mage"     "Mage"     "Mage"     } 50  7 ({ANIMATE})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "none"     "Mage"     "Mage"     } 51  7 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Swordsman"} 53 10 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman" } 54 11 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"     "none"     "none"     "Spearman" } 55 10 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 54  8 ({ANIMATE})}

        {DELAY 250}

        # these guys spawn near Konrad and (mostly) chase after him
        # side=2 is relevant for both AI and the "Delfador the Great" fleeing event
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 40  1 ({ANIMATE}{FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"   } 58  1 ({ANIMATE}{FACING sw}{GUARDIAN})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "none"     "none"     "Fencer"   } 57  1 ({ANIMATE}{FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman" } 35  1 ({ANIMATE}{FACING se})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 38  2 ({ANIMATE}{FACING sw})}

        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman" } 34  4 ({ANIMATE}{ROLE quick}{FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none"     "none"     "Bowman"   "Bowman"   } 34  3 ({ANIMATE}{ROLE quick}{FACING sw})}

        #############################
        # SET QUICK TRAIT
        #############################
#define SET_TRAITS TRAITS
    [remove_trait]
        id=$unit.id
    [/remove_trait]
    [modify_unit]
        {FILTER id=$unit.id}
        {TRAITS}
    [/modify_unit]
    [modify_unit]
        {FILTER id=$unit.id}
        hitpoints=$( $this_unit.max_hitpoints )
    [/modify_unit]
#enddef
        [store_unit]
            {FILTER role=quick}
            variable=stored_quick_units
        [/store_unit]
        [foreach]
            array=stored_quick_units
            variable=unit
            [do]
                {VARIABLE_OP rand rand (1,2,3,4)}
                {IF} {VARIABLE_CONDITIONAL rand equals 1} {THEN(  {SET_TRAITS ({TRAIT_QUICK    }{TRAIT_STRONG   })}  )} {/IF}
                {IF} {VARIABLE_CONDITIONAL rand equals 2} {THEN(  {SET_TRAITS ({TRAIT_QUICK    }{TRAIT_RESILIENT})}  )} {/IF}
                {IF} {VARIABLE_CONDITIONAL rand equals 3} {THEN(  {SET_TRAITS ({TRAIT_STRONG   }{TRAIT_QUICK    })}  )} {/IF}
                {IF} {VARIABLE_CONDITIONAL rand equals 4} {THEN(  {SET_TRAITS ({TRAIT_RESILIENT}{TRAIT_QUICK    })}  )} {/IF}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_quick_units}

        #############################
        # KONRAD ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Konrad 29 7}
        {MODIFY_UNIT id=Konrad facing sw}
        {MODIFY_UNIT id=Delfador facing ne}
        {DELAY 500}
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"I’m here, Delfador! I thought you were calling me for more training, but there’s smoke rising from the forest. What’s going on?"
        [/message]
        [message]
            speaker=Ethiliel
            image=portraits/ethiliel-mad.webp
            #po: human armies have surrounded the Aethenwood and are burning it
            message=_"Trouble from your Queen Asheviere, child! She knows that we sheltered you throughout your youth. Now she comes bearing fiery retribution, and the dawn of a dark age for the Aethenwood."
        [/message]
        [message]
            speaker=Delfador
            message=_"I have already been injured. I fear she is after you personally, master Konrad!"
        [/message]
        [message]
            speaker=Delfador
            message=_"They have us nearly surrounded, but we can still flee to the west. I will protect you!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"But what about the elves? They are our friends! We have to help fight!"
        [/message]
        [message]
            speaker=Galdrad
            message=_"Asheviere is all of our enemy. We will fight the invaders, but you must escape, Konrad. Lord Kalenz has commanded your safety. It is imperative that you escape!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Galdrad is right. Do not throw your life away so easily, Your Highness."
        [/message]
        [message]
            speaker=Delfador
            message=_"There can be no looking back. We must go quickly!"
        [/message]

        [change_theme]
        [/change_theme]
        {MODIFY_UNIT side=9 side 1}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Move Konrad and Delfador to the west edge of the map"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage=40
            [/gold_carryover]
            # this is a meaningful but not crucial mechanic, and I think it's more fun for the player to discover this on their own
            #             [note]
            #                 description= _ "Units take 1 fire damage whenever they enter flaming terrain, and 10 fire damage if they end their turn in it. Fire elementals are immune."
            #             [/note]
        [/objectives]

        # Konrad starts his turn on a village. Don't let him heal on the battle's first turn
        {MODIFY_UNIT id=Konrad status.unhealable yes}
        [event]
            name=side 1 turn refresh
            {MODIFY_UNIT id=Konrad status.unhealable no}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                     GOLD BOOSTS
    #######################################################################################################################################################
    # give gold per leader. Easier way to implement this than changing each side's income individually and per-difficulty
#define BONUS_INCOME_PER_LEADER SIDES INCOME
    # newline for inline usage
    [event]
        name=new turn
        first_time_only=no
        [store_unit]
            {FILTER( canrecruit=yes {NOT({IS_ALLY})} {AND side={SIDES}} )}
            variable=stored_enemy_leaders
        [/store_unit]
        [foreach]
            array=stored_enemy_leaders
            [do]
                [gold]
                    side=$this_item.side
                    amount={INCOME}
                [/gold]
            [/do]
        [/foreach]
    [/event]
#enddef
    # BONUS_INCOME_PER_LEADER serves as our "timer". Got to leave before these recruits overwhelm you
    [event]
        name=turn 8
        {BONUS_INCOME_PER_LEADER 4   {ON_DIFFICULTY4 10 15 20 25}}
        {BONUS_INCOME_PER_LEADER 5,6 {ON_DIFFICULTY4  6  8 10 12}}
    [/event]
    # if Konrad sticks around a long time, start scaling things up even further
    [event]
        name=turn 14
        {BONUS_INCOME_PER_LEADER 2,3,4,5,6 {ON_DIFFICULTY4 6 8 10 12}}
        [modify_unit]
            {FILTER side=2}
            extra_recruit=Red Mage
        [/modify_unit]
        [modify_unit]
            {FILTER side=3,4,5,6}
            extra_recruit=Swordsman,Javelineer
        [/modify_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        {FILTER canrecruit=yes}
        {BONUS_INCOME_PER_LEADER 2,3,4,5,6 {ON_DIFFICULTY4 6 8 10 12}}
    [/event]

    #######################################################################################################################################################
    #                                                                       FLAVOR
    #######################################################################################################################################################
    #############################
    # FIRE EXPLANATION
    #############################
    [event]
        name=took_damage_from_fire
        {FILTER side=1}
        {SOUND torch.ogg}
        [message]
            speaker=Konrad
            message=_"Watch out for the fire!"
        [/message]
        [cancel_action]
        [/cancel_action]
    [/event]

    #############################
    # KONRAD’S NEVER SEEN THIS MANY HUMANS
    #############################
    [event]
        name=turn 4 # remember that we start on turn 2; turn 1 is Konrad inside his home
        [message]
            speaker=Delfador
            message=_"Konrad, it took you some time to rise this morning. I’m not angry, but I am worried. I won’t always be here to keep you safe!"
        [/message]
        [message]
            speaker=Konrad
            #po: Asheviere and her army are burning the Aethenwood and killing Konrad's elven friends.
            message=_"I know, Delfador, and I’m sorry. This is horrible! How did the fires get so close without me noticing!?"
        [/message]
        [message]
            speaker=Konrad
            #po: Asheviere and her army are burning the Aethenwood and killing Konrad's elven friends.
            message=_"I’ve never seen so many humans all in one place before. I can’t believe you and I are really the same as them..."
        [/message]
        [message]
            speaker=Delfador
            message=_"<i><b>I’m</b></i> sorry you couldn’t have grown up among your own people. Our kind can be a little crude, but we aren’t usually so bad — it’s Asheviere who’s stirred up all this mischief."
        [/message]
        [message]
            speaker=Delfador
            message=_"And if my suspicions are true, this is merely a small part of the greater whole of her armies! We must get out of this forest so we can see what else is going on."
        [/message]
    [/event]
    #############################
    # SURROUND THE ELVES - NO ESCAPE
    #############################
    [event]
        name=turn 4 end
        [message]
            role=quick
            x=0-15
            message=_"Surround the enclaves! Don’t let anyone escape!"
        [/message]
    [/event]

    #############################
    # "I AM GALDRAD"
    #############################
    [event]
        name=attack {FILTER        id=Galdrad}
        {FIRE_EVENT galdrad_speaks}
    [/event]
    [event]
        name=attack {FILTER_SECOND id=Galdrad}
        {FIRE_EVENT galdrad_speaks}
    [/event]
    [event]
        name=galdrad_speaks
        [message]
            speaker=Galdrad
            message=_"I am Galdrad. You will have to fight me to get any further!"
        [/message]
    [/event]
    #############################
    # KONRAD ATTACKS
    #############################
    [event]
        name=attack {FILTER        id=Konrad}
        {FILTER_CONDITION( {NOT({HAVE_UNIT type=Quintain})} )}
        {FIRE_EVENT konrad_speaks}
    [/event]
    [event]
        name=attack {FILTER_SECOND id=Konrad}
        {FILTER_CONDITION( {NOT({HAVE_UNIT type=Quintain})} )}
        {FIRE_EVENT konrad_speaks}
    [/event]
    [event]
        name=konrad_speaks
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            #po: said when Konrad attacks / is attacked
            message=_"Leave my home alone, you villian!"
        [/message]
        [message]
            side=2,3,4,5,6 {FILTER_ADJACENT id=Konrad}
            #po: Asheveire's official stance is that Konrad is a fraud. At this point, the player believes Konrad is the true prince
            message=_"You’re just an imposter! Everyone knows the real prince Konrad died long ago."
        [/message]
    [/event]
    #############################
    # ENEMIES FLEE FROM DELFADOR
    #############################
    [event]
        name=attack
        {FILTER id=Delfador}
        {FILTER_SECOND canrecruit=no}
        [message]
            speaker=second_unit
            #po: said when Delfador attacks. The unit flees off the map before Delfador can deal damage
            message=_"Oh no, it’s HIM, it’s Delfador THE GREAT! Get me out of here!"
        [/message]
        {KILL id=$second_unit.id}
        {IF} {VARIABLE_CONDITIONAL second_unit.side equals 2} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 37 $second_unit.y 1 $second_unit.side $second_unit.type ()}
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL second_unit.side equals 3} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 56 $second_unit.y 7 $second_unit.side $second_unit.type ()}
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL second_unit.side equals 4} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 56 $second_unit.y 15 $second_unit.side $second_unit.type ()}
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL second_unit.side equals 5} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x 24 $second_unit.y 20 $second_unit.side $second_unit.type ()}
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL second_unit.side equals 6} {THEN(
            {FAKE_UNIT_MOVE $second_unit.x  1 $second_unit.y  1 $second_unit.side $second_unit.type ()}
        )} {/IF}
        {MODIFY_UNIT id=Delfador attacks_left 1}
        {DELAY 500}
        [message]
            speaker=Delfador
            #po: an enemy has just fled, even before Delfador got a chance to attack
            message=_"My reputation precedes me."
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=prestart
        {VARIABLE delfador_kills 1} # 1 instead of 0, since his first kill is a "run away", it doesn't trigger the normal counter
    [/event]
    [event]
        name=die
        first_time_only=no {FILTER_SECOND id=Delfador}
        {VARIABLE_OP delfador_kills add 1}
        {IF} {VARIABLE_CONDITIONAL delfador_kills equals 10} {THEN(
            {ACHIEVE s01}
            [message]
                speaker=Delfador
                #po: Delfador has killed 10 enemies, and the player has earned an achievement
                message=_"Only fools dare oppose me."
            [/message]
        )} {/IF}
    [/event]

    #############################
    # ENEMY LEADERS DIE
    #############################
    [event]
        name=die
        {FILTER_CONDITION( {NOT({HAVE_UNIT side=2,3,4,5,6})} )}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Wow, you’ve defeated all the invaders and saved the Aethenwood! I didn’t expect this to be possible, so if you’re reading this message in-game you’ve exceeded all expectations! (or you’re cheating to see what happens / using overpowered add-ons)"
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Unfortunately this breaks the story, so for the rest of the campaign we’re going to have to pretend that this never happened, okay?"
        [/message]
        {DELAY 500}
        {FIRE_EVENT victory_cutscene}
    [/event]
    #############################
    # ISOLDE DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Isolde}
        [message]
            speaker=Isolde
            message=_"Impossible! I must report back to the queen."
        [/message]
        {MOVE_UNIT id=Isolde 45 1}
        {STORE_NPC Isolde}
        {VARIABLE bm_s01_isolde_defeated yes}
    [/event]
    [event]
        name=die
        {FILTER id=redmage}
        {VARIABLE bm_s01_redmage_defeated yes}
    [/event]

    #############################
    # ONE HERO ESCAPES
    #############################
    [event]
        name=moveto
        {FILTER id,x=Konrad,1}
        [event]
            name=new turn
            {FILTER_CONDITION({NOT({HAVE_UNIT id,x=Delfador,1})})}
            [message]
                speaker=Konrad
                message=_"Hurry, Delfador! I’m not leaving without you."
            [/message]
        [/event]
        [allow_undo]
        [/allow_undo]
    [/event]
    [event]
        name=moveto
        {FILTER id,x=Delfador,1}
        [event]
            name=new turn
            {FILTER_CONDITION({NOT({HAVE_UNIT id,x=Konrad,1})})}
            [message]
                speaker=Delfador
                message=_"Hurry along, Konrad! We leave together, or not at all."
            [/message]
        [/event]
        [allow_undo]
        [/allow_undo]
    [/event]

    #############################
    # KONRAD ESCAPES
    #############################
    [event]
        name=moveto
        {FILTER id,x=Konrad,1}
        {FILTER_CONDITION({HAVE_UNIT id,x=Delfador,1})}
        {FIRE_EVENT victory_cutscene}
    [/event]
    [event]
        name=moveto
        {FILTER id,x=Delfador,1}
        {FILTER_CONDITION({HAVE_UNIT id,x=Konrad,1})}
        {FIRE_EVENT victory_cutscene}
    [/event]
    [event]
        name=victory_cutscene
        [message]
            speaker=Delfador
            message=_"Time to go, Konrad! Come on!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"Of course you are right, Delfador. But what will become of our friends here?"
        [/message]
        [message]
            speaker=Delfador
            message=_"The elves will fight. They may even prevail. But I fear things do not bode well for them. Let us not speak of it now. Onward!"
        [/message]
        {CLEAR_VARIABLE fires,groups_remaining}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]

#undef SET_TRAITS
#undef BONUS_INCOME_PER_LEADER
