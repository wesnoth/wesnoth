#textdomain wesnoth-h2tt
# scenario by Dalas

#define SCENARIO_TURN_LIMIT
25#enddef
#define TOD_OFFSET
-1#enddef

[scenario]
    name=_"scenario name^The Highwaymen"
    {MAP_DYNAMIC 18_The_Highwaymen}
    next_scenario=00_The_Great_Continent
    victory_when_enemies_defeated=no
    {SCHEDULE_DYNAMIC_DAY OFFSET={TOD_OFFSET}}
    {ADD_WEATHER_RAIN}
    turns={SCENARIO_TURN_LIMIT}
    {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC knolls.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE FOG=yes}

    #############################
    # CARAVANS
    #############################
    [side]
        side=2
        controller=ai
        color=wesred
        no_leader=yes
        hidden=yes
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]

    #############################
    # DANTONK
    #############################
    [side]
        side=3
        controller=ai
        color=wesred
        no_leader=yes
        hidden=yes
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]
    [event]
        name=prestart
        {UNSTORE_NPC Warven x,y=43,24 side,facing=3,sw}
    [/event]
    {STARTING_VILLAGES_AREA 3 32-99 10-99 0}

    # separate side for Li'sar, so her "exacting" ability doesn't trigger
    [side]
        side=4
        controller=ai
        color=wesred
        no_leader=yes
        hidden=yes
        team_name=wesnoth
        user_team_name=_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        #############################
        # BRAZIERS
        #############################
        {BRAZIER_DYNAMIC_DAY 16  1 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 17  6 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 43 15 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 46 17 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 41 23 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_DAY 45 26 OFFSET={TOD_OFFSET}}

        #############################
        # DAN'TONK LEADER
        #############################
        # it's very likely that Li'sar will be here, but it's possible that she'll still be at the crossroads right now
        {IF} {VARIABLE_CONDITIONAL bm_lisar_at_dantonk equals yes} {THEN(
            {UNSTORE_NPC Lisar x,y=44,16 side,facing=4,nw}
            {VARIABLE bm_met_lisar_early yes}
        )} {ELSEIF} {VARIABLE_CONDITIONAL status_s02 equals $null} {THEN(
            {GENERIC_UNIT 4 General 44 16} {FACING sw} {LEADER}
        )} {/ELSEIF} {ELSE(
            {UNSTORE_NPC Isolde x,y=44,16 side,facing=4,nw}
        )} {/IF}
        {MODIFY_UNIT x,y=44,16 role leader4}

        #############################
        # DAN'TONK GUARDS
        #############################
        # no difficulty variation; you never actually fight any of these guys
        # don't place any units on hexes that would block the caravans' [micro_ai]s!
        {GENERIC_UNIT 3 "Iron Mauler"       42 15} {FACING nw}
        {GENERIC_UNIT 3 "Shock Trooper"     43 17} {FACING nw}
        {GENERIC_UNIT 3 "Longbowman"        44 15} {FACING nw}
        {GENERIC_UNIT 3 "Master Bowman"     45 15} {FACING se}
        {GENERIC_UNIT 3 "Shock Trooper"     45 16} {FACING se}
        {GENERIC_UNIT 3 "Master at Arms"    46 13} {FACING ne}
        {GENERIC_UNIT 3 "Duelist"           46 15} {FACING ne}

        {GENERIC_UNIT 3 "Iron Mauler"       45 18} {FACING nw}
        {GENERIC_UNIT 3 "Duelist"           42 18} {FACING ne}
        {GENERIC_UNIT 3 "Iron Mauler"       44 19} {FACING se}
        {GENERIC_UNIT 3 "Shock Trooper"     46 18} {FACING se}

        {GENERIC_UNIT 3 "Swordsman"         40 24} {FACING se}
        {GENERIC_UNIT 3 "Bowman"            41 22} {FACING ne}
        {GENERIC_UNIT 3 "Bowman"            46 27} {FACING ne}

        #############################
        # OUTPOST GUARDS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Longbowman" "Master Bowman" "Master Bowman"}) 16 20 ({ROLE outpost}{ZONE_GUARDIAN 16 20 (radius=6 {FILTER role=outpost})}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 17 21 ({ROLE outpost}{ZONE_GUARDIAN 17 21 (radius=6 {FILTER role=outpost})}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Swordsman"     "Swordsman"    }) 18 20 ({ROLE outpost}{ZONE_GUARDIAN 18 20 (radius=6 {FILTER role=outpost})}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 19 22 ({ROLE outpost}{ZONE_GUARDIAN 19 22 (radius=6 {FILTER role=outpost})}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Swordsman"     "Swordsman"    }) 15 19 ({ROLE outpost}{ZONE_GUARDIAN 15 19 (radius=6 {FILTER role=outpost})}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Swordsman"     "Swordsman"    }) 15 21 ({ROLE outpost}{ZONE_GUARDIAN 15 21 (radius=6 {FILTER role=outpost})}) }

        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 36 10 ({GUARDIAN}{ROLE minor_guard})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 26 26 ({GUARDIAN}{ROLE minor_guard})}

        #############################
        # INITIAL CARAVAN
        #############################
        # this is handled under the "caravans" section

        #############################
        # GUARDS KILLED BY KONRAD
        #############################
        {GENERIC_UNIT 2 "Bowman"     13 4} {FACING ne} {ROLE fodder1}
        {GENERIC_UNIT 2 "Longbowman" 16 3} {FACING ne} {ROLE fodder2}

        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 15 4}
        {REVEAL x,y,radius=14,2,6}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # KONRAD ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Konrad    11 1} {REDRAW}
        {MOVE_UNIT id=Konrad 12 3} {REDRAW}
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"En garde!"
        [/message]
        {ANIMATE_HARM id=Konrad    15 range=melee role=fodder1 EXPERIENCE=no}
        {ANIMATE_HARM role=fodder1  6 range=melee id=Konrad    EXPERIENCE=no}
        {ANIMATE_HARM id=Konrad    99 range=melee role=fodder1 EXPERIENCE=no}
        {DELAY 250}
        {MOVE_UNIT id=Konrad 15 4} {REDRAW}
        {ANIMATE_HARM id=Konrad    15 range=melee role=fodder2 EXPERIENCE=no}
        {ANIMATE_HARM role=fodder2  9 range=melee id=Konrad    EXPERIENCE=no}
        {ANIMATE_HARM id=Konrad    15 range=melee role=fodder2 EXPERIENCE=no}
        {ANIMATE_HARM role=fodder2  9 range=melee id=Konrad    EXPERIENCE=no}
        {ANIMATE_HARM id=Konrad    99 range=melee role=fodder2 EXPERIENCE=no}
        {DELAY 250}
        {RECALL_KONRAD_AND_COMPANIONS 15 4}

        #############################
        # INTRODUCTORY DIALOGUE
        #############################
        {REVEAL x,y,radius=1-4,7,1}
        [message]
            speaker=Konrad
            message=_"Our timing is perfect: the first of our several targets is approaching the city. Our scouts spotted several convoys nearby, but the others must not have arrived yet."
        [/message]
        {HIGHLIGHT_IMAGE 1 6-9 items/arrowE.png ()}
        [message]
            speaker=Konrad
            message=_"Each caravan will be brimming with supplies and weapons, so the more we plunder, the more new types of soldiers we’ll be able to equip!"
        [/message]
        [companion_message]
            message_Ulfdain=_"Aye, an’ good fer us that rain an’ fog ’ave come in. Those mole-eyed chicken-city buffoons will have no idea we’re here, as long as we keep our distance from th’ walls."
            message_Harper=_"Back in the day I remember doin’ something like this with Baldras an’ Helicrom. Lucky for us that the fog’s out. As long as we’re careful an’ keep our distance, th’ city won’t know we’re here."
            message_Moremirmu=_"Hark and behold! The Light provides, for rain and fog have come to shroud us from our foes. As long as we keep our distance from the city, Dan’Tonk shall surely remain ignorant of our presence."
            message_Jeniver=_"And look at all this fog! Well, that’s probably a good thing for us. If we keep our distance from the city itself, I’m sure it’ll be some time until the garrison is alerted."
            message_Kalenz=_"It is lucky for us that this rain has come with a thick fog. As long as we keep our distance from the city proper, it may be some time until the garrison is alerted to our presence."
            fallback_Konrad=_"It is lucky for us that this rain has come with a thick fog. As long as we keep our distance from the city proper, it may be some time until the garrison is alerted to our presence."
        [/companion_message]
        {REMOVE_IMAGE 1 6-9}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            delayed_variable_substitution=yes
            [objective]
                #po: $dead_wagons is a number; probably between 0 and 15
                condition=win
                description=_"Intercept enemy wagons before they reach Dan’Tonk ($dead_wagons destroyed so far)"
            [/objective]

            [objective]
                condition=win
                description=_"5+ destroyed: recruit Fencers"
                [show_if]
                    {VARIABLE_CONDITIONAL dead_wagons less_than_equal_to  4}
                [/show_if]
            [/objective]
            [objective]
                condition=win
                description="<span strikethrough='true'>" + _"5+ destroyed: recruit Fencers" + "</span>"
                [show_if]
                    {VARIABLE_CONDITIONAL dead_wagons greater_than        4}
                [/show_if]
            [/objective]

            [objective]
                condition=win
                description=_"8+ destroyed: recruit Spearmen"
                [show_if]
                    {VARIABLE_CONDITIONAL dead_wagons less_than_equal_to  7}
                [/show_if]
            [/objective]
            [objective]
                condition=win
                description="<span strikethrough='true'>" + _"8+ destroyed: recruit Spearmen" + "</span>"
                [show_if]
                    {VARIABLE_CONDITIONAL dead_wagons greater_than        7}
                [/show_if]
            [/objective]

            [objective]
                condition=win
                description=_"all 11 destroyed: recruit Bowmen"+{EARLY_FINISH_BONUS_FOOTNOTE}
            [/objective]

            {OBJECTIVES_HERODEATHS}
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage=40
                bonus=no
            [/gold_carryover]
            [note]
                description=_"The scenario will end once any caravan reaches Dan’Tonk and alerts the garrison, or if any of Konrad’s units move within 4 hexes of the the Dan’Tonk city walls (the unwalkable castle hexes)."
            [/note]
        [/objectives]
    [/event]

    #############################
    # MINOR GUARDS
    #############################
    [event]
        name=attack
        {FILTER side=1}
        {FILTER_SECOND role=minor_guard}
        {FIRE_EVENT_UNIT minor_guard_speak id=$second_unit.id}
    [/event]
    [event]
        name=attack
        {FILTER role=minor_guard}
        {FILTER_SECOND side=1}
        {FIRE_EVENT_UNIT minor_guard_speak id=$unit.id}
    [/event]
    [event]
        name=exit hex
        {FILTER role=minor_guard}
        {FIRE_EVENT_UNIT minor_guard_speak id=$unit.id}
    [/event]
    [event]
        name=minor_guard_speak
        [message]
            speaker=unit
            message=_"Outlaws, here?! I warn you, I’m armed!"
        [/message]
    [/event]

    #############################
    # OUTPOST GUARDS
    #############################
    [event]
        name=sighted
        {FILTER x,y,role=16,20,outpost}
        {FILTER_SECOND side=1}
        [message]
            speaker=unit
            message=_"I hate being stuck all the way out here on observation duty. What’s the point?"
        [/message]
        [message]
            speaker=unit
            #po: this helps tell the player that they can safely fight these guards without alerting Dan'Tonk
            message=_"Even if some bandits were to foolishly come this near to Dan’Tonk, what does the lieutenant expect me to do? It’s not as if I have any way to warn the city..."
        [/message]
    [/event]
    [event]
        name=attack
        {FILTER side=1}
        {FILTER_SECOND role=outpost}
        {FIRE_EVENT_UNIT outpost_speak id=$second_unit.id}
    [/event]
    [event]
        name=attack
        {FILTER role=outpost}
        {FILTER_SECOND side=1}
        {FIRE_EVENT_UNIT outpost_speak id=$unit.id}
    [/event]
    [event]
        name=exit hex
        {FILTER role=outpost}
        {FIRE_EVENT_UNIT outpost_speak id=$unit.id}
    [/event]
    [event]
        name=outpost_speak
        [message]
            speaker=unit
            message=_"Bandits in the fog! We’re under attack! It’s too far to warn the city — grab your weapons!"
        [/message]
    [/event]

    #############################
    # WARN PLAYER ABOUT DAN'TONK
    #############################
    [event]
        name=enter hex
        {FILTER(  side=1 {FILTER_LOCATION( radius=6 {AND terrain=*^Qhux} )}  )}
        [cancel_action]
        [/cancel_action]
        [message]
            speaker=Konrad
            message=_"We are approaching the walls of Dan’Tonk! Careful — if we come much closer, the guards will spot us and we’ll be forced to abandon our mission."
        [/message]
    [/event]

    #############################
    # DAN'TONK LAMPSHADING
    #############################
    [event]
        name=side 3 turn
        {FILTER_CONDITION(  {HAVE_UNIT( side=1 {FILTER_LOCATION(radius=6 {FILTER side=3})} )}  )}
        [message]
            side=3
            canrecruit=no
            {FILTER_LOCATION( radius=6 {FILTER side=1} )}
            message=_"I’m sure I see shapes moving in the rain nearby, but with so much fog it’s hard to tell exactly who it is. Hopefully one of our convoys."
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                       CARAVANS
    #######################################################################################################################################################
    #############################
    # TRACK KILLS
    #############################
    [event]
        name=prestart
        {VARIABLE dead_wagons 0}
    [/event]
    [event]
        name=last breath
        first_time_only=no
        {FILTER type=Caravan}
        {VARIABLE_OP dead_wagons add 1}
    [/event]

    #############################
    # CREATE MAIS
    #############################
    [event]
        name=prestart
        [micro_ai]
            side=2
            action=add
            ai_type=messenger_escort
            {FILTER(        role=wagons_top {AND type=Caravan} )}
            {FILTER_SECOND( role=wagons_top {NOT type=Caravan} )}
            waypoint_x=31,25,46
            waypoint_y= 1, 9,16
            enemy_death_chance=0
            messenger_death_chance=1 # make the caravans attack even when it's a bad idea - this makes it difficult to farm the level for gold
        [/micro_ai]
        [micro_ai]
            side=2
            action=add
            ai_type=messenger_escort
            {FILTER(        role=wagons_mid {AND type=Caravan} )}
            {FILTER_SECOND( role=wagons_mid {NOT type=Caravan} )}
            waypoint_x=9,20,21,35,46
            waypoint_y=9,17,23,29,26
            enemy_death_chance=0
            messenger_death_chance=1 # make the caravans attack even when it's a bad idea - this makes it difficult to farm the level for gold
        [/micro_ai]
        [micro_ai]
            side=2
            action=add
            ai_type=messenger_escort
            {FILTER(        role=wagons_bot {AND type=Caravan} )}
            {FILTER_SECOND( role=wagons_bot {NOT type=Caravan} )}
            waypoint_x= 9,20,36,46
            waypoint_y=25,23,29,26
            enemy_death_chance=0
            messenger_death_chance=1 # make the caravans attack even when it's a bad idea - this makes it difficult to farm the level for gold
        [/micro_ai]
    [/event]

    #############################
    # FIRST WAVE
    #############################
    [event]
        name=prestart
        {GENERIC_UNIT 2 Caravan 2 7} {FACING se} {ROLE wagons_mid}
        {GENERIC_UNIT 2 Caravan 3 7} {FACING se} {ROLE wagons_mid}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Bowman"        "Bowman"       }) 5 7 ({ROLE wagons_mid}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Bowman"        "Bowman"       }) 4 6 ({ROLE wagons_mid}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"      "Swordsman"    }) 4 7 ({ROLE wagons_mid}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"        "Bowman"       }) 1 7 ({ROLE wagons_mid}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Fencer"       }) 1 6 ({ROLE wagons_mid}) }
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_ADJACENT role=wagons_mid} )}
        [message]
            role=wagons_mid
            message=_"It’s an ambush! How did Maddock’s mercenaries get this far inland?!"
        [/message]
    [/event]
    [event]
        name=die
        {FILTER role=wagons_mid}
        {FILTER_CONDITION({NOT({HAVE_UNIT role=wagons_mid})})}
        {IF} {HAVE_UNIT type=Caravan} {THEN(
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"That’s the first caravan destroyed! Well done, everyone — now we must stop the second, too!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"That’s the first caravan destroyed! Well done, everyone. We should continue expanding our control over this area — there will be more caravans soon."
            [/message]
        )} {/IF}
    [/event]

    #############################
    # SECOND WAVE
    #############################
    [event]
        name=turn 6
        {REVEAL(radius=1 {FILTER role=leader4})}
        [message]
            role=leader4
            message=_"Lieutenant, weren’t we expecting a weapons convoy some hours ago? I hope they haven’t gotten into any trouble."
        [/message]
        {REVEAL( radius=1 {FILTER id=Warven} )}
        [message]
            speaker=Warven
            message=_"The fog’s been causing delays for schedules all around the city, ma’am. The shipment’s probably just stuck in some mud."
        [/message]
        [reset_fog]
            {FILTER_SIDE side=1}
            reset_view=yes
        [/reset_fog]
    [/event]
    [event]
        name=turn 6
        {HIGHLIGHT_IMAGE 29-33 1 items/arrowS.png ()}

        [event]
            name=side 2 turn refresh
            # let spawns move (some) and attack immediately, to discourage spawncamping
            {REMOVE_IMAGE 29-33 1}
            {REVEAL x,y,radius=30,1,3}
            {GENERIC_UNIT 2 Caravan 31 1} {FACING sw} {ROLE wagons_top}
            {GENERIC_UNIT 2 Caravan 30 1} {FACING sw} {ROLE wagons_top}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Bowman"        "Bowman"       }) 31 1 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Longbowman"    "Longbowman"   }) 31 1 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Fencer"     "Fencer"        "Fencer"       }) 31 1 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"      "Swordsman"    }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"        "Bowman"       }) 30 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Fencer"        "Fencer"       }) 29 3 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 29 3 ({ANIMATE}{ROLE wagons_top}) }
            {MODIFY_UNIT role=wagons_top moves 1}
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"Another caravan is approaching the city, this time from the northern path!"
            [/message]

            #------------------------
            # REVENGE FOR THE AETHENWOOD
            #------------------------
            [event]
                name=moveto
                {FILTER_CONDITION({HAVE_UNIT( side=1 {FILTER_ADJACENT role=wagons_top} )})}
                [message]
                    role=wagons_top {FILTER_ADJACENT side=1}
                    message=_"Outlaws on the road! Fighting elves in that awful forest was bad enough, and now this?"
                [/message]
                {IF} {HAVE_UNIT id=Kalenz} {THEN(
                    [message]
                        speaker=Kalenz
                        message=_"You speak in the presence of High Lord Kalenz of the elves, human! The wrath of elf-kind falls upon you today!"
                    [/message]
                )} {ELSE(
                    [message]
                        speaker=Konrad {KONRAD_VARIATION mad}
                        message=_"Vengeance for the Aethenwood! You should never have left your city to come burn my home!"
                    [/message]
                )} {/IF}
            [/event]
        [/event]
    [/event]

    #############################
    # THIRD WAVE
    #############################
    [event]
        name=turn 12
        {REVEAL(radius=1 {FILTER role=leader4})}
        [message]
            role=leader4
            message=_"Still no word from the wagon trains? Something’s wrong. Lieutenant, dispatch a squad to patrol the area — we may be dealing with roadside bandits."
        [/message]

        {NAMED_UNITC   2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Shock Trooper"     "Shock Trooper" "Shock Trooper"}) 43 23 squad_leader _"Teory" ({ROLE squad}{ZONE_GUARDIAN 1 1 x,y=0-99,0-99}) }
        [event]
            name=side 2 turn refresh
            first_time_only=no
            {MODIFY_UNIT id=squad_leader moves 3} # keep him slow, so he doesn't outpace his escort
        [/event]
        {MOVE_UNIT id=squad_leader 42 28} # move him out of Dan'Tonk, or else he likes to lead his squad through the north exit

        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"            "Bowman"            "Bowman"        "Longbowman"   }) 44 25 ({ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper" "Shock Trooper"}) 43 25 ({ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {REVEAL x,y,radius=44,24,2}
        {MOVE_UNIT x,y=43,23 45 26}
        {MOVE_UNIT x,y=44,23 45 25}
        {MOVE_UNIT x,y=43,25 46 25}

        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"            "Fencer"            "Fencer"        "Duelist"      }) 43 23 ({ANIMATE}{ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Shock Trooper" "Shock Trooper"}) 44 23 ({ANIMATE}{ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Shock Trooper" "Shock Trooper"}) 43 25 ({ANIMATE}{ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {MOVE_UNIT x,y=43,25 44 27}
        {MOVE_UNIT x,y=43,23 44 26}
        {MOVE_UNIT x,y=44,23 43 27}

        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "none"              "Heavy Infantryman" "Shock Trooper"}) 43 23 ({ANIMATE}{ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"}) 44 23 ({ANIMATE}{ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "none"              "Fencer"            "Fencer"       }) 43 25 ({ANIMATE}{ROLE squad}{VIP_GUARDIAN id=squad_leader 2 8}) }
        [reset_fog]
            {FILTER_SIDE side=1}
            reset_view=yes
        [/reset_fog]

        #------------------------
        # SQUAD ATTACKS KONRAD
        #------------------------
        [event]
            name=moveto
            {FILTER_CONDITION({HAVE_UNIT( side=1 {FILTER_LOCATION( radius=2 {FILTER role=squad} )} )})}
            [message]
                speaker=squad_leader
                message=_"Ah ha, found you! We aren’t dealing with just any petty bandits — these are Konrad’s rebels! I’ll see you hang for your crimes!"
            [/message]
        [/event]
    [/event]
    [event]
        name=turn 12
        {HIGHLIGHT_IMAGE 1 25-28 items/arrowE.png ()}

        [event]
            name=side 2 turn refresh
            # let spawns move (some) and attack immediately, to discourage spawncamping
            {REMOVE_IMAGE 1 25-28}
            {REVEAL x,y,radius=2,25,3}
            {GENERIC_UNIT 2 Caravan 1 26} {FACING se} {ROLE wagons_bot}
            {GENERIC_UNIT 2 Caravan 3 26} {FACING se} {ROLE wagons_bot}
            {GENERIC_UNIT 2 Caravan 4 25} {FACING se} {ROLE wagons_bot}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Longbowman" "Longbowman"    "Longbowman"   }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"   "Duelist"    "Duelist"       "Duelist"      }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Bowman"        "Bowman"       }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"        "Fencer"       }) 4 25 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Spearman"   "Swordsman"     "Swordsman"    }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Fencer"        "Fencer"       }) 4 25 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"        "Bowman"       }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"      "Swordsman"    }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Fencer"       }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 4 25 ({ANIMATE}{ROLE wagons_bot}) }
            {MODIFY_UNIT role=wagons_bot moves 1}
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"A third convoy, along the southern path this time! This one is larger than the previous two. Better-defended. but also a more valuable prize!"
            [/message]

            #------------------------
            # KONRAD ATTACKS THIRD CARAVAN
            #------------------------
            [event]
                name=moveto
                {FILTER_CONDITION({HAVE_UNIT( side=1 {FILTER_ADJACENT role=wagons_bot} )})}
                [message]
                    role=wagons_bot {FILTER_ADJACENT side=1}
                    message=_"Look out! Bandits on the road!"
                [/message]
            [/event]
        [/event]
    [/event]

    #############################
    # FOURTH WAVE
    #############################
    [event]
        name=turn 18
        {HIGHLIGHT_IMAGE 1 23-29 items/arrowE.png ()}
        {HIGHLIGHT_IMAGE 27-33 1 items/arrowS.png ()}

        [event]
            name=side 2 turn 18 refresh
            {REMOVE_IMAGE 1 23-29}
            {REMOVE_IMAGE 27-33 1}
            {REVEAL x,y,radius=2,25,3}
            {GENERIC_UNIT 2 Caravan 1 26} {FACING se} {ROLE wagons_bot}
            {GENERIC_UNIT 2 Caravan 3 26} {FACING se} {ROLE wagons_bot}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Longbowman" "Longbowman"    "Longbowman"   }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Longbowman"    "Longbowman"   }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"   "Duelist"    "Duelist"       "Duelist"      }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Bowman"        "Bowman"       }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"        "Fencer"       }) 4 25 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Spearman"   "Swordsman"     "Swordsman"    }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Fencer"     "Fencer"        "Fencer"       }) 4 25 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"        "Bowman"       }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"      "Swordsman"    }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 1 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Fencer"       }) 3 26 ({ANIMATE}{ROLE wagons_bot}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 4 25 ({ANIMATE}{ROLE wagons_bot}) }
            {MODIFY_UNIT role=wagons_bot moves 0} # might affect some units from the 3rd wave, but not a big deal

            {REVEAL x,y,radius=30,1,3}
            {GENERIC_UNIT 2 Caravan 31 1} {FACING sw} {ROLE wagons_top}
            {GENERIC_UNIT 2 Caravan 30 2} {FACING sw} {ROLE wagons_top}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Longbowman" "Longbowman"    "Longbowman"   }) 31 1 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Longbowman"    "Longbowman"   }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"   "Duelist"    "Duelist"       "Duelist"      }) 31 1 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Bowman"        "Bowman"       }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"        "Fencer"       }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Spearman"   "Swordsman"     "Swordsman"    }) 28 3 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Bowman"     "Longbowman"    "Longbowman"   }) 28 3 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "Fencer"     "Fencer"        "Fencer"       }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"        "Bowman"       }) 31 1 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"      "Swordsman"    }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 28 3 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Fencer"       }) 28 3 ({ANIMATE}{ROLE wagons_top}) }
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"     "none"       "none"          "Bowman"       }) 29 2 ({ANIMATE}{ROLE wagons_top}) }
            {MODIFY_UNIT role=wagons_top moves 0}

            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"The final convoy we’re waiting for has arrived — and this one approaches from two directions at once!"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"We shall have to split our forces if we want to stop both. Or, if we lack the strength, even defeating only one will still provide us with many valuable weapons!"
            [/message]
            {VARIABLE final_caravan_spawned yes}

            #------------------------
            # KONRAD ATTACKS FOURTH CARAVAN
            #------------------------
            [event]
                name=moveto
                {FILTER_CONDITION({HAVE_UNIT( side=1 {FILTER_ADJACENT( role=wagons_top {OR role=wagons_bot} )} )})}
                [message]
                    role=wagons_top {OR role=wagons_bot} {FILTER_ADJACENT side=1}
                    message=_"I knew I heard the sound of fighting in the fog! You’ll find we’re battle-hardened veterans from Elensefar, and no easy prey for petty outlaws."
                [/message]
            [/event]
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        {REVEAL(radius=1 {FILTER role=leader4})}
        [message]
            role=leader4
            message=_"Enough! Whether we see them or not, there’s clearly some capable enemy lurking out in the fog. To arms, soldiers! This city is our place of strength, and our armies far outnumber any petty bandits or rebels. Whatever’s going on out there, it ends now."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"As we knew would happen eventually, Dan’Tonk has become aware of our presence, and Wesnoth’s armies are mobilizing to surround us. Quick, everyone, let us make our escape and tally our plunder!"
        [/message]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # FINAL CARAVAN DIES
    #############################
    [event]
        name=die
        {FILTER type=Caravan}
        {FILTER_CONDITION({NOT({HAVE_UNIT type=Caravan})})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL final_caravan_spawned equals yes})}

        {IF} {VARIABLE_CONDITIONAL turn_number less_than_equal_to 20} {THEN(
            {ACHIEVE s18}
        )} {/IF}

        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message=_"That’s the last of these wagons! We’ve done well to capture so many supplies and weapons. If we continue waiting here even more may yet arrive, but I suspect we’ve pushed our luck staying as long as we have already."
        [/message]
        {DELAY 250}
        {REVEAL(radius=1 {FILTER role=leader4})}
        [message]
            role=leader4
            message=_"Enough! Whether we see them or not, there’s clearly some capable enemy lurking out in the fog. To arms, soldiers! This city is our place of strength, and our armies far outnumber any petty bandits or rebels. Whatever’s going on out there, it ends now."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            #po: "speak of a lich" is a made-up saying, with the same meaning as "speak of the devil"
            message=_"Speak of a lich... As we knew would happen eventually, Dan’Tonk has become aware of our presence, and Wesnoth’s armies are mobilizing to surround us. Quick, everyone, let us make our escape and tally our plunder!"
        [/message]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # CARAVAN REACHES DAN'TONK
    #############################
    [event]
        name=enter hex
        {FILTER( side=2 {NOT role=squad} {FILTER_LOCATION({FILTER_ADJACENT_LOCATION terrain=*^Qhux})} )}
        {REVEAL(radius=1 {FILTER id=$unit.id})}
        [message]
            speaker=unit
            message=_"I’ve reached the city walls! Alarm! Alarm! We spotted Konrad and his rebels are lying in wait on the road!"
        [/message]
        {REVEAL(radius=1 {FILTER role=leader4})}
        [message]
            role=leader4
            message=_"The rebel army, here?! Those fools! To arms, soldiers! This city is our place of strength, and I know us to far outnumber Konrad’s forces. We must bring the false prince to justice!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"A caravan has reached Dan’Tonk, and Wesnoth’s armies are mobilizing to surround us! Quick, everyone, let us make our escape and tally our plunder!"
        [/message]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
            bonus=no
        [/endlevel]
    [/event]

    #############################
    # SIGHTED BY DAN'TONK
    #############################
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION( radius=4 {AND terrain=*^Qhux,X*^*,*^Pr*} )} )}
        {REVEAL(radius=1 {FILTER role=leader4})}
        [message]
            role=leader4
            message=_"Look — there! That figure can only be one of Konrad’s rebels, foolishly come to fight Dan’Tonk itself."
        [/message]
        [message]
            role=leader4
            message=_"To arms, soldiers! This city is our place of strength, and I know us to far outnumber Konrad’s forces. We must capture the false prince and bring him to justice!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"We’ve come too close to the city walls, and have been spotted! Quick, everyone, let us make our escape and tally our plunder!"
        [/message]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
            bonus=no
        [/endlevel]
    [/event]

    #############################
    # LISAR DIES
    #############################
    # this shouldn't be possible in normal gameplay, but might happen with mods or debug mode
    [event]
        name=last breath
        {FILTER role=leader4}
        [message]
            role=leader4
            message=_"What?! What sort of unseen enemy has attacked me without ever approaching the city walls? I must flee!"
        [/message]
        {MOVE_UNIT role=leader4 46 18}
        {STORE_NPC Lisar}
        {STORE_NPC Isolde}
        [message]
            speaker=Konrad
            message=_"Quick, everyone, let us make our escape and tally our plunder!"
        [/message]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
            bonus=no
        [/endlevel]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef TOD_OFFSET
