#textdomain wesnoth-h2tt
# scenario by Dalas

#define TOD_OFFSET
-4#enddef

[scenario]
    name=_"scenario name^The Battle for Wesnoth"
    {MAP_DYNAMIC 50_The_Battle_for_Wesnoth}
    # The winter map for S50 deliberately doesn't include any ice around the Weldyn moat.
    # Asheviere's soldiers are Lawful, so they're already at a disadvantage in winter.
    # Don't make things even worse for them by freezing the moat too (maybe Asheveiere sent soldiers to break up any ice)
    {SCHEDULE_DYNAMIC_NIGHT OFFSET={TOD_OFFSET}}
    turns=-1
    {SCENARIO_MUSIC silence.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE}

    #############################
    # REINFORCEMENT SIDES
    #############################
#define WELDYN_MOAT_SLF
    # this macro is used for ALL our S50 AIs, not just {REINFORCEMENT_AI}
    # avoid far enough that we won't leave Weldyn's walls to fight merfolk in the river,
    # but not so far that we can't wade into the river when we were never behind walls in the first place
    terrain=W* # not W*^*, or we match bridges
    {AND x,y,radius=18,22,10}
#enddef
#define REINFORCEMENT_AI SIDE SNUM X Y VARY_AI_BY_SCHEDULE
    [event]
        name=side {SIDE} turn
        first_time_only=no
        {RESET_SIDE_AI {SIDE} offensive 0.9 0.1} # high aggression speeds up the AI
        {MODIFY_SIDE_AI {SIDE} (
            [avoid]
                {WELDYN_MOAT_SLF}
            [/avoid]
        )}
        # if this side just spawned new units recently, AND if enemies are near our spawn point
        # then be aggressive even if it's an unfavorable time of day
        # note that this affects all units from this side, even if they're elsewhere on the map
        {IF}
        {VARIABLE_CONDITIONAL turn_number less_than_equal_to "$( $latest_{SNUM} + 2 )"}
        {HAVE_UNIT( side=1,$lisar_side {FILTER_LOCATION x,y,radius={X},{Y},6} )}
        {THEN(
            # do nothing. Be normally aggressive
        )} {ELSE(
            {VARY_AI_BY_SCHEDULE}
        )} {/IF}
    [/event]
#enddef
    #------------------------
    # FELL-HANDS
    #------------------------
    [side]
        side=2
        controller=ai
        color=brown
        no_leader=yes
        hidden=yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 2 s41 19  1 ({VARY_AI_BY_SCHEDULE_ENEMY           2 1,$lisar_side})}

    #------------------------
    # DAN'TONK
    #------------------------
    [side]
        side=3
        controller=ai
        color=wesred
        no_leader=yes
        hidden=yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 3 s48  1 11 ({VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 3 1,$lisar_side})}

    #------------------------
    # WHITEFANGS
    #------------------------
    [side]
        side=4
        controller=ai
        color=white
        no_leader=yes
        hidden=yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 4 s42 53 41 ({VARY_AI_BY_SCHEDULE_ENEMY           4 1,$lisar_side})}

    #------------------------
    # HORSE CLANS
    #------------------------
    [side]
        side=5
        controller=ai
        color=wesred
        no_leader=yes
        hidden=yes
        team_name=wesnoth
    [/side]
    {REINFORCEMENT_AI 5 s47 22 40 ({VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 5 1,$lisar_side})}

    #############################
    # ORCISH AUXILIARIES
    #############################
    [side]
        side=6
        controller=ai
        color=yellow
        no_leader=yes
        gold=  {ON_DIFFICULTY4 25 50 75 100}
        income={ON_DIFFICULTY4  3  8 13  18} # not a serious threat, but enough income to be very annoying
        recruit=Goblin Spearman,Troll Whelp,Orcish Archer
        team_name=wesnoth
        user_team_name=_"Orcish Auxiliaries" {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=prestart
        {NAMED_UNIT 6 "Orcish Warrior" 33  3 leader6top _"Shnog"  ()} {LEADER} {FACING se} {ADD_MODIFICATION({TRAIT_RESILIENT}  {TRAIT_STRONG}   )}
        {NAMED_UNIT 6 "Orcish Warrior" 38 23 leader6mid _"Agnarz" ()} {LEADER} {FACING ne} {ADD_MODIFICATION({TRAIT_STRONG}     {TRAIT_RESILIENT})}
        {NAMED_UNIT 6 "Orcish Warrior" 60 32 leader6bot _"Arob"   ()} {LEADER} {FACING nw} {ADD_MODIFICATION({TRAIT_INTELLIGENT}{TRAIT_STRONG}   )}
    [/event]
    # starting villages are together with Asheviere
    {SILENTLY_LIMIT_LEADER_MOVES 6 3}

    #
    # retreat to hexes near our keep, preferring village/castle hexes
    # but don't retreat to any hexes within 1 radius - otherwise we might block recruiting
    #
#define SIDE6_SIMPLE_RETREAT LEADERID X Y
    {IF} {HAVE_UNIT id={LEADERID}} {THEN(
        {RETREAT_WHEN_WEAK 6 {ON_DIFFICULTY4 0-7 0-9 0-11 0-13}
        (
            {GOAL_LOCATION 2 (
                [and]
                    x,y={X},{Y}
                    radius=3
                    terrain=C*^*,*^V*
                [/and]
                {NOT x,y,radius={X},{Y},1}
            )}
            {GOAL_LOCATION 1 (
                [and]
                    x,y={X},{Y}
                    radius=3
                [/and]
                {NOT x,y,radius={X},{Y},1}
            )}
        )
        (SUF={NOT role=scattered_guard})
        }
    )} {/IF}
#enddef
    [event]
        name=side 6 turn
        first_time_only=no
        {RESET_SIDE_AI 6 offensive 0.9 0.1} # high aggression also speeds up the AI
        {VARY_AI_BY_SCHEDULE_ENEMY 6 1,$lisar_side}
        {MODIFY_SIDE_AI 6 (
            [avoid]
                {WELDYN_MOAT_SLF}
            [/avoid]
        )}
        {SIDE6_SIMPLE_RETREAT leader6top 33  2} # deliberately off-center
        {SIDE6_SIMPLE_RETREAT leader6mid 39 23} # deliberately off-center
        {SIDE6_SIMPLE_RETREAT leader6bot 60 31} # deliberately off-center
    [/event]

    #############################
    # ASHEVIERE
    #############################
    [side]
        side=7
        controller=ai
        color=purple
        no_leader=yes
        gold=        0
        income=      0 # set this later, using the $asheviere_income variable, so we can add/subtract more easily
        village_gold={ON_DIFFICULTY4  0   1   1   1}
        recruit= # use only extra_recruit
        team_name=wesnoth
        user_team_name=_"Royal Guard" {FLAG_VARIANT loyalist}
    [/side]
    [event]
        name=prestart
        {NAMED_UNIT 7 "Dark Queen" 18 22 Asheviere   _"Asheviere"   extra_recruit="Royal Guard,Halberdier,Master at Arms"} {LEADER} {FACING ne} {ADD_MODIFICATION({TRAIT_AGED}       {TRAIT_INTELLIGENT})}
        {NAMED_UNIT 7 Lieutenant   21 27 leader7bot  _"Sir Aeollet" extra_recruit=Swordsman,Longbowman                   } {LEADER} {FACING ne} {ADD_MODIFICATION({TRAIT_STRONG}     {TRAIT_RESILIENT}  )}
        {NAMED_UNIT 7 Lieutenant   21 18 leader7top  _"Sir Gunter"  extra_recruit=Swordsman,Longbowman                   } {LEADER} {FACING ne} {ADD_MODIFICATION({TRAIT_INTELLIGENT}{TRAIT_RESILIENT}  )}
        {NAMED_UNIT 7 Lieutenant   12 19 leader7left _"Sir Aebaud"  extra_recruit=Swordsman,Longbowman                   } {LEADER} {FACING nw} {ADD_MODIFICATION({TRAIT_RESILIENT}  {TRAIT_STRONG}     )}
        # assuming we'll control have around 50 villages on average. Asheviere starts with 75, and Weldyn itself has 33
        # if I change these numbers, make sure that my "halve Asheviere's income" section still works properly
        {VARIABLE asheviere_income {ON_DIFFICULTY4 23 0 23 48}}

        # if the player didn't complete S14 Gryphon Mountain (which they probably didn't), give Asheviere some Gryphons
        # if the player did    complete S14 Gryphon Mountain, Asheviere loses some income
        {IF} {VARIABLE_CONDITIONAL bm_s14_fought_burlin not_equals yes} {THEN(
            {KILL id=leader7left}
            # he was a Pathfinder in Gryphon Mountain, but now he's an Explorer. That way we don't have to track his Gryphon Mountain XP.
            {NAMED_UNIT 7 "Dwarvish Explorer" 12 19 Burlin _"Beastmaster Burlin" extra_recruit="Gryphon Rider"} {LEADER} {FACING nw} {ADD_MODIFICATION({TRAIT_STRONG}{TRAIT_RESILIENT})}
        )} {ELSE(
            {VARIABLE_OP asheviere_income sub $s50_burlin_income_penalty}
        )} {/IF}

        # if the player used the whirlpool to gain extra turns, Asheveire gets extra income
        # need an extra "-1" because just entering the whirlpool adds 1 turn to the counter (but shouldn't count for Asheviere's income)
        {IF}
        {VARIABLE_CONDITIONAL bm_milestone_finale_original not_equals $null}
        {VARIABLE_CONDITIONAL bm_turns greater_than $bm_milestone_finale_original}
        {THEN(
            {VARIABLE_OP asheviere_income add "$( ($bm_turns - 1 - $bm_milestone_finale_original) * $s50_extra_income_per_scenario )"}
        )} {/IF}

        # if we went scorched-earth, halve Asheviere's income
        # when making this calculation, assume that she'll have 50 villages on average
        # (if we're scorched-earth we raze some villages in prestart, so she'll have fewer than otherwise)
        {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals yes} {THEN(
            # keep in mind that this affects whirlpool income too, so this can make an ENORMOUS difference if you've played a lot of whirlpool scenarios
            {VARIABLE asheviere_income "$( ( $asheviere_income+{ON_DIFFICULTY4 0 50 50 50} )*0.67 - {ON_DIFFICULTY4 0 50 50 50} )"}
        )} {/IF}

        [modify_side]
            side=7
            income="$( round($asheviere_income) )"
        [/modify_side]
        {CLEAR_VARIABLE base_income}
    [/event]
    {STARTING_VILLAGES_ALL 7}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Red Mage" {ON_DIFFICULTY4 0 1 2 3}}
    {STARTING_VILLAGES_AREA 1 59 12 4}
    {STARTING_VILLAGES_AREA 6 33  3 9} # side 6, not 7. Need to put these after "starting_villages_all"
    {STARTING_VILLAGES_AREA 6 39 23 5}
    {STARTING_VILLAGES_AREA 6 60 32 9}
    {SILENTLY_LIMIT_LEADER_MOVES 7 1}

    # Asheviere's AI gets a whole section further down. It's too long to fit cleanly here.

    #############################
    # LISAR
    #############################
    #wmlindent: start ignoring
    {LISAR_SIDE 8
        (RECRUIT=Elite Shock Trooper,Elite Longbowman,Elite Duelist)
        (INCOME={ON_DIFFICULTY4 12 18 26 36}) # extra base income for the finale (which might still be doubled if we did Cliffs of Thoria)
    }                                         # a player who's manually controlling Li'sar won't benefit, but I expect them to have built up veterans by now instead
    {LISAR_CHOOSE_CONTROLLER
        (IF_AI_CONTROL=
            {VARIABLE lisar_under_ai_control yes}
            {SILENTLY_LIMIT_LEADER_MOVES $lisar_side 3}
        )
    }
    #wmlindent: stop ignoring
    [event]
        name=side $lisar_side turn
        first_time_only=no
        {RESET_SIDE_AI $lisar_side offensive 0.9 0.1} # high aggression speeds up the AI
        #         {MODIFY_AI_DELETE_CANDIDATE_ACTION $lisar_side main_loop grab_villages}

        {IF} {VARIABLE_CONDITIONAL lisar_at_forward_keep equals yes} {THEN(
            {RETREAT_WHEN_WEAK $lisar_side {ON_DIFFICULTY4 0-5 0-6 0-7 0-8} (
                {GOAL_LOCATION 3 x,y=39,20}
                {GOAL_LOCATION 3 x,y=35,22}
                {GOAL_LOCATION 2 x,y=34,23}
                {GOAL_LOCATION 1 x,y=35,24}
                {GOAL_LOCATION 1 x,y=36,23}
                {GOAL_LOCATION 1 x,y=41,21}
                {GOAL_LOCATION 1 x,y=42,21}
                {GOAL_LOCATION 1 x,y=38,21}
            )}
        )}
        {ELSEIF} {VARIABLE_CONDITIONAL lisar_at_forward_keep equals in_progress} {THEN(
            # don't retreat
        )} {/ELSEIF}
        {ELSE(
            # be less likely to retreat when we're still in our initial keep, since we may still be using our initial gold bank
            {RETREAT_WHEN_WEAK $lisar_side {ON_DIFFICULTY4 0-2 0-3 0-4 0-5} (
                {GOAL_LOCATION 2 x,y=53,7}
                {GOAL_LOCATION 2 x,y=53,8}
                {GOAL_LOCATION 2 x,y=54,6}
                {GOAL_LOCATION 1 x,y,radius=55,10,1}
            )}
        )} {/IF}
    [/event]
    #------------------------
    # ADVANCE TO ENEMY'S KEEP
    #------------------------
    # first, this is a nice little dynamic event
    # second, putting Li'sar closer to Weldyn makes her more useful and predictableas an ally
    [event]
        name=last breath
        {FILTER id=leader6mid}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL lisar_under_ai_control equals yes})}
        [message]
            speaker=unit
            message= _ "Raag!"
        [/message]
        [event]
            name=die
            {FILTER id=leader6mid}
            [message]
                speaker=Lisar
                message= _ "That orc’s keep will make a perfect staging ground for our attack on the city, Konrad. I’ll move forward and recruit from there once it’s clear. You’re welcome to share, of course."
            [/message]
            #------------------------
            # TRIGGER THE ADVANCE
            #------------------------
            [event]
                name=side $lisar_side turn
                {FILTER_CONDITION({NOT({HAVE_UNIT( side=2,3,4,5,6,7 {FILTER_LOCATION x,y,radius=39,22,4} )})})}
                {VARIABLE lisar_at_forward_keep in_progress}
                [gold]
                    side=$lisar_side
                    amount={ON_DIFFICULTY4 20 30 40 50}
                [/gold]
                [micro_ai]
                    ai_type=messenger_escort
                    action=add
                    side=$lisar_side
                    ca_id=lisar_go_to_forward_keep
                    {FILTER id=Lisar}
                    {FILTER_SECOND( canrecruit=no {FILTER_LOCATION( radius=2 {FILTER id=Lisar} )} )}
                    waypoint_x=39
                    waypoint_y=23
                [/micro_ai]
                [micro_ai]
                    ai_type=zone_guardian
                    action=delete
                    side=$lisar_side
                    ca_id=warven_zone_guardian
                [/micro_ai]
            [/event]
            #------------------------
            # FINISH ADVANCING
            #------------------------
            [event]
                name=moveto
                {FILTER id,x,y=Lisar,39,23}
                {VARIABLE lisar_at_forward_keep yes}
                [micro_ai]
                    ai_type=messenger_escort
                    action=delete
                    side=$lisar_side
                    ca_id=lisar_go_to_forward_keep
                [/micro_ai]
                [micro_ai]
                    side=$lisar_side
                    action=add
                    ai_type=zone_guardian
                    station_x=41
                    station_y=21
                    ca_id=warven_zone_guardian
                    {FILTER role=warven}
                    {FILTER_LOCATION x,y,radius=39,22,2}
                [/micro_ai]
            [/event]
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                    ASHEVIERE AI
    #######################################################################################################################################################
#define WELDYN_SECTOR_AVOID VAR_X VAR_Y WML_IF_AVOID
    # Weldyn is surrounded by both walls and a moat. If walls are overwhelmed, fall back to the moat
    # To achieve this, check multiple overlapping wall quadrants. If we're weak and the enemy is strong, avoid that section
    {GET_ARMY_LEVELS 2,3,4,5,6,7   (VARNAME=good_levels) (INCLUDE_GOLD=no) (ARMY_FILTER={FILTER_LOCATION x,y=${VAR_X},${VAR_Y}} {NOT id=bridgeGuardSE,bridgeGuardNE,bridgeGuardN,bridgeGuardNW,bridgeGuardSW,bridgeGuardS})}
    {GET_ARMY_LEVELS 1,$lisar_side (VARNAME=bad_levels ) (INCLUDE_GOLD=no) (ARMY_FILTER={FILTER_LOCATION x,y=${VAR_X},${VAR_Y}}                                                                                           )}
    {IF}
    {VARIABLE_CONDITIONAL good_levels    less_than_equal_to {ON_DIFFICULTY4 4 6  8 10}}
    {VARIABLE_CONDITIONAL bad_levels  greater_than_equal_to {ON_DIFFICULTY4 6 8 10 12}}
    {THEN(
        # if we do want to avoid this section, run some arbitrary WML (probably new defensive goals)
        {WML_IF_AVOID}
        # the first time we trigger a sector avoid, give Asheviere some extra gold
        {FIRE_EVENT sector_avoid_reserve_gold}
    )} {ELSE(
        # if we don't want to avoid this section, change the avoid variables to some off-map coordinate
        {VARIABLE {VAR_X} 0}
        {VARIABLE {VAR_Y} 0}
    )} {/IF}
#enddef
    [event]
        name=sector_avoid_reserve_gold
        [gold]
            side=7
            amount={ON_DIFFICULTY4 50 100 150 200}
        [/gold]
    [/event]
#define WELDYN_VARYING_GOAL VALUE X Y
    # {VALUE} * (0.5 + (radius-6 units + radius-10 units) / weldyn-center-15 units )
    #           only include VISIBLE enemies
    # i.e. if 100% of Konrad's nearby army is 0-6  hexes away, x2.5 our base {VALUE}
    # i.e. if 100% of Konrad's nearby army is 7-10 hexes away, x1.5 our base {VALUE}
    # i.e. if  50% of Konrad's nearby army is 0-6  hexes away, x1.5 our base {VALUE}
    # i.e. if  50% of Konrad's nearby army is 7-10 hexes away, x1.0 our base {VALUE}
    # i.e. if   0% of Konrad's nearby army is 0-10 hexes away, x0.5 our base {VALUE}
    [store_unit]
        {FILTER( side=1,$lisar_side {FILTER_LOCATION x,y,radius={X},{Y},6} )}
        variable=inner_radius
    [/store_unit]
    [store_unit]
        {FILTER( side=1,$lisar_side {FILTER_LOCATION x,y,radius={X},{Y},10} )}
        variable=outer_radius
    [/store_unit]
    [store_unit]
        {FILTER( side=1,$lisar_side {FILTER_LOCATION x,y,radius=18,22,15} )}
        variable=weldyn_total
    [/store_unit]
    # +0.01 avoids divide-by-zero issues
    {MODIFY_SIDE_AI 7 ({GOAL_LOCATION "$( {VALUE} * (0.5 + ($inner_radius.length + $outer_radius.length) / ($weldyn_total.length + 0.01) ) )" x,y={X},{Y}})}
    {CLEAR_VARIABLE inner_radius,outer_radius,weldyn_radius,dummy}
#enddef
    [event]
        name=prestart
        {VARIABLE asheviere_posture attack}
    [/event]
    [event]
        name=side 7 turn
        first_time_only=no

        #############################
        # DETERMINE POSTURE
        #############################
        # if we're weak, and if we PLUS our allies are weak around Weldyn, then defend. Otherwise, attack
        #
        # gold costs are more precise than levels, but costs are more likely to be rebalanced, and levels are easier to guesstimate
        # ignore role=weldyn_guard units, so that I can place/change those without worrying about messing up the AI
        {GET_ARMY_LEVELS 7           (VARNAME=asheviere_levels ) (ARMY_FILTER={NOT role=weldyn_guard}                                      )}
        {GET_ARMY_LEVELS 2,3,4,5,6,7 (VARNAME=all_nearby_levels) (ARMY_FILTER={NOT role=weldyn_guard} {FILTER_LOCATION x,y,radius=18,22,12})}
        {IF}
        {VARIABLE_CONDITIONAL asheviere_posture equals    attack}
        {VARIABLE_CONDITIONAL asheviere_levels  less_than {ON_DIFFICULTY4  5  8 11 14}}
        {VARIABLE_CONDITIONAL all_nearby_levels less_than {ON_DIFFICULTY4 10 13 16 19}}
        {THEN(
            {VARIABLE asheviere_posture defend}
        )} {/IF}

        # if we're already defending, require a much higher threshold to switch to attacking again
        # this also determines the size of our initial attack, since we start off with very little gold
        {IF}
        {VARIABLE_CONDITIONAL asheviere_posture equals    defend}
        {VARIABLE_CONDITIONAL asheviere_levels  greater_than {ON_DIFFICULTY4 15 18 21 24}}
        {VARIABLE_CONDITIONAL all_nearby_levels greater_than {ON_DIFFICULTY4 20 23 26 29}}
        {THEN(
            {VARIABLE asheviere_posture attack}
        )} {/IF}
        {CLEAR_VARIABLE asheviere_levels,all_nearby_levels}

        #############################
        # IF ATTACKING...
        #############################
        # if we're attacking, use our regular VARY_AI_BY_SCHEDULE logic
        {IF} {VARIABLE_CONDITIONAL asheviere_posture equals attack} {THEN(
            {RESET_SIDE_AI 7 offensive 0.4 0.25}
            {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 7 1,$lisar_side}
            {MODIFY_SIDE_AI 7 (
                [avoid]
                    {WELDYN_MOAT_SLF}
                [/avoid]
            )}
        )}

        #############################
        # IF DEFENDING...
        #############################
        {ELSE(
            {RESET_SIDE_AI 7 no 0.2 0.8}

            #------------------------
            # DEFENSIVE GOALS
            #------------------------
            # outer wall goals: east
            {WELDYN_VARYING_GOAL 4  24 20}
            {WELDYN_VARYING_GOAL 4  25 21}
            {WELDYN_VARYING_GOAL 1  24 21}
            {WELDYN_VARYING_GOAL 2  25 22}
            {WELDYN_VARYING_GOAL 4  25 23}
            {WELDYN_VARYING_GOAL 3  24 23}
            {WELDYN_VARYING_GOAL 1  24 24}
            {WELDYN_VARYING_GOAL 3  25 26}
            {WELDYN_VARYING_GOAL 2  23 26}

            # outer wall goals: northeast
            {WELDYN_VARYING_GOAL 4  23 18}
            {WELDYN_VARYING_GOAL 3  21 17}
            {WELDYN_VARYING_GOAL 4  20 17}
            {WELDYN_VARYING_GOAL 2  22 17}
            {WELDYN_VARYING_GOAL 1  21 18}
            {WELDYN_VARYING_GOAL 1  22 18}
            {WELDYN_VARYING_GOAL 1  22 19}

            # outer wall goals: northwest
            {WELDYN_VARYING_GOAL 4  17 17}
            {WELDYN_VARYING_GOAL 4  16 16}
            {WELDYN_VARYING_GOAL 4  14 17}
            {WELDYN_VARYING_GOAL 2  14 18}
            {WELDYN_VARYING_GOAL 1  15 18}
            {WELDYN_VARYING_GOAL 1  16 17}

            # outer wall goals: west
            {WELDYN_VARYING_GOAL 4  12 18}
            {WELDYN_VARYING_GOAL 4  11 19}
            {WELDYN_VARYING_GOAL 3  11 20}
            {WELDYN_VARYING_GOAL 1  12 19}

            # outer wall goals: west
            {WELDYN_VARYING_GOAL 4  11 22}
            {WELDYN_VARYING_GOAL 2  11 23}
            {WELDYN_VARYING_GOAL 4  11 24}
            {WELDYN_VARYING_GOAL 3  12 21}
            {WELDYN_VARYING_GOAL 2  12 22}
            {WELDYN_VARYING_GOAL 1  12 23}
            {WELDYN_VARYING_GOAL 2  12 24}

            # outer wall goals: southwest
            {WELDYN_VARYING_GOAL 4  13 26}
            {WELDYN_VARYING_GOAL 2  15 26}
            {WELDYN_VARYING_GOAL 4  16 28}
            {WELDYN_VARYING_GOAL 3  15 28}
            {WELDYN_VARYING_GOAL 2  16 27}
            {WELDYN_VARYING_GOAL 2  27 28}

            # outer wall goals: south
            {WELDYN_VARYING_GOAL 4  19 29}
            {WELDYN_VARYING_GOAL 4  22 27}
            {WELDYN_VARYING_GOAL 3  21 28}
            {WELDYN_VARYING_GOAL 1  20 26}
            {WELDYN_VARYING_GOAL 1  20 27}
            {WELDYN_VARYING_GOAL 1  21 27}

            #------------------------
            # AVOID QUADRANTS
            #------------------------
            # determine which (if any) quadrants to avoid. {WELDYN_SECTOR_AVOID} will clear these variables if the area is safe to enter.
            # we do this to try and defend the moat, instead of continually trying to attack across it into an already-conquered position
            #
            # these areas are large - we only retreat if the enemy is strong AND we are weak
            # some of the goals here will overlap - that's ok. If we've lost multiple overlapping sectors then it's extra-important we defend that area
            {VARIABLE avoidEastX "22,   23,   24,   25,   26,   27,   28   "}
            {VARIABLE avoidEastY "14-26,15-30,15-29,16-29,17-28,18-28,17-27"}
            {WELDYN_SECTOR_AVOID avoidEastX avoidEastY (
                {WELDYN_VARYING_GOAL 3  19 20}
                {WELDYN_VARYING_GOAL 4  20 20}
                {WELDYN_VARYING_GOAL 1  21 21}
                {WELDYN_VARYING_GOAL 5  21 22}
                {WELDYN_VARYING_GOAL 5  21 23}
                {WELDYN_VARYING_GOAL 1  21 24}
                {WELDYN_VARYING_GOAL 4  20 24}
                {WELDYN_VARYING_GOAL 3  19 25}
            )}

            {VARIABLE avoidNorthEastX "13,   14,   15,   16,   17,   18,   19,   20,   21,   22,   23,   24,   25,   26,   27,   28   "}
            {VARIABLE avoidNorthEastY "14-16,13-16,13-17,12-17,13-18,12-18,13-19,13-19,14-20,14-20,15-21,15-21,16-22,16-21,17-21,17-20"}
            {WELDYN_SECTOR_AVOID avoidNorthEastX avoidNorthEastY (
                {WELDYN_VARYING_GOAL 3  16 20}
                {WELDYN_VARYING_GOAL 4  17 20}
                {WELDYN_VARYING_GOAL 1  18 19}
                {WELDYN_VARYING_GOAL 5  19 20}
                {WELDYN_VARYING_GOAL 5  20 20}
                {WELDYN_VARYING_GOAL 1  21 21}
                {WELDYN_VARYING_GOAL 4  21 22}
                {WELDYN_VARYING_GOAL 3  21 23}
            )}

            {VARIABLE avoidSouthEastX "15,   16,   17,   18,   19,   20,   21,   22,   23,   24,   25,   26,   27,   28   "}
            {VARIABLE avoidSouthEastY "28-30,27-30,27-31,26-31,26-31,25-30,25-31,24-30,24-30,23-29,23-29,23-28,24-28,17-20"}
            {WELDYN_SECTOR_AVOID avoidSouthEastX avoidSouthEastY (
                {WELDYN_VARYING_GOAL 3  21 22}
                {WELDYN_VARYING_GOAL 4  21 23}
                {WELDYN_VARYING_GOAL 1  21 24}
                {WELDYN_VARYING_GOAL 5  20 24}
                {WELDYN_VARYING_GOAL 5  19 25}
                {WELDYN_VARYING_GOAL 1  18 25}
                {WELDYN_VARYING_GOAL 4  17 25}
                {WELDYN_VARYING_GOAL 3  16 24}
            )}

            # covers northwest, west, and southwest
            # it's not likely that players attack from this direction
            {VARIABLE avoidWestNorthWestX "8,    9,    10,   11,   12,   13,   14,   15,   15,   16,   16,   17,   17,   18,   18   "}
            {VARIABLE avoidWestNorthWestY "17-25,17-26,16-26,16-27,15-27,15-28,14-28,14-20,25-29,13-19,25-29,14-19,26-30,14-18,26-29"}
            {WELDYN_SECTOR_AVOID avoidWestNorthWestX avoidWestNorthWestY (
                {WELDYN_VARYING_GOAL 3  17 20}
                {WELDYN_VARYING_GOAL 4  16 20}
                {WELDYN_VARYING_GOAL 1  15 21}
                {WELDYN_VARYING_GOAL 5  15 22}
                {WELDYN_VARYING_GOAL 5  15 23}
                {WELDYN_VARYING_GOAL 1  15 24}
                {WELDYN_VARYING_GOAL 4  16 24}
                {WELDYN_VARYING_GOAL 3  17 25}
            )}

            #------------------------
            # SET AVOIDS
            #------------------------
#define ASHEVEIRE_AVOID_SUF
    # always avoid the moat
    {WELDYN_MOAT_SLF}

    # avoid a ring around Weldyn. Prevent a 7mp quick Royal Guard from leaving,
    # but allow 8+ mp scouts to escape and cap villages, even now that we're defensive
    [or]
        {AND x,y,radius=18,22,14}
        {NOT x,y,radius=18,22,7}
    [/or]

    # avoid any areas that've been flagged by {WELDYN_SECTOR_AVOID}
    [or]
        x,y=$avoidEastX,$avoidEastY
    [/or]
    [or]
        x,y=$avoidNorthEastX,$avoidNorthEastY
    [/or]
    [or]
        x,y=$avoidSouthEastX,$avoidSouthEastY
    [/or]
    [or]
        x,y=$avoidWestNorthWestX,$avoidWestNorthWestY
    [/or]
#enddef
            {MODIFY_SIDE_AI 7 (
                [avoid]
                    {ASHEVEIRE_AVOID_SUF}
                [/avoid]
            )}

            #------------------------
            # RETREAT FROM AVOIDS
            #------------------------
            [micro_ai]
                side=7
                action=add
                ai_type=coward
                ca_id=asheveire_retreat_mai
                {FILTER( {FILTER_LOCATION({ASHEVEIRE_AVOID_SUF})} )}
                distance=8 # arbitrarily picked; hopefully this is a good number
                seek_x=18
                seek_y=22
                attack_if_trapped=yes
            [/micro_ai]
            [event]
                name=side turn end
                [micro_ai]
                    side=7
                    action=delete
                    ai_type=coward
                    ca_id=asheveire_retreat_mai
                [/micro_ai]
            [/event]
        )} {/IF}
    [/event]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {PLACE_IMAGE items/dwarven-keep-tile.png 21 27}

        #############################
        # WELDYN WALL
        #############################
        [store_locations]
            {AND x,y,radius=18,22,4}
            {NOT x,y,radius=18,22,2}
        [/store_locations]
        [foreach]
            array=location
            variable=loc
            [do]
                {VARIABLE center "$(648/2-36)"}
                {VARIABLE x "$( $center + ($loc.x-18)*54 )"}
                {VARIABLE y "$( $center + ($loc.y-22)*72 - 36*($loc.x%2) )"}
                # Awful hack. On some hexes, this terrain should appear underneath units. On others, it should appear over them.
                # To achieve that, use "halo" on some hexes and "image" on others. Halo images need manual ToD color adjustments
                {IF} {HAVE_LOCATION(
                    x,y=$loc.x,$loc.y
                    [and]
                        x=15,16,17,19,20,21, 15,16,17,19,20,21
                        y=20,19,19,19,19,20, 24,24,25,25,24,24
                    [/and]
                )}
                {THEN(
                    # halo wall segments need to be refreshed every turn
                    [event]
                        name=new turn,refresh_wall_halos
                        first_time_only=no
                        delayed_variable_substitution=no
                        [store_time_of_day]
                            x,y=$loc.x,$loc.y
                            variable=tod
                        [/store_time_of_day]
                        {REMOVE_IMAGE $loc.x $loc.y}
                        [item]
                            x,y=$loc.x,$loc.y
                            halo="terrain/weldyn_walls.png~CROP( $x, $y, 72, 72 )~CS($|tod.red,$|tod.green,$|tod.blue)"
                            redraw=no
                        [/item]
                    [/event]
                )}
                {ELSE(
                    # image wall segments only need to be placed once
                    [item]
                        x,y=$loc.x,$loc.y
                        image="terrain/weldyn_walls.png~CROP( $x, $y, 72, 72 )"
                        redraw=no
                    [/item]
                )} {/IF}
                {CLEAR_VARIABLE center,x,y}
            [/do]
        [/foreach]
        {FIRE_EVENT refresh_wall_halos}

        #############################
        # RAZE VILLAGES
        #############################
        {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals yes} {THEN(
            {MODIFY_TERRAIN Gg^Dr 29  5}
            {MODIFY_TERRAIN Gg^Dr 36  1}
            {MODIFY_TERRAIN Gg^Dr 37 13}
            {MODIFY_TERRAIN Gg^Dr 16  1}
            {MODIFY_TERRAIN Gg^Dr 10 10}
            {MODIFY_TERRAIN Gg^Dr 26 13}
            {MODIFY_TERRAIN Gg^Dr  1 37}
            {MODIFY_TERRAIN Gg^Dr 10 39}
            {MODIFY_TERRAIN Gg^Dr 24 40}
            {MODIFY_TERRAIN Gg^Dr 43 32}
            {MODIFY_TERRAIN Gg^Dr 58 38}
        )} {/IF}

        #############################
        # BRAZIERS
        #############################
        {BRAZIER_DYNAMIC_NIGHT 16 21 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 16 23 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 20 21 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 20 23 OFFSET={TOD_OFFSET}}

        {BRAZIER_DYNAMIC_NIGHT 15 18 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 12 24 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 19 28 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 23 19 OFFSET={TOD_OFFSET}}
        {BRAZIER_DYNAMIC_NIGHT 24 24 OFFSET={TOD_OFFSET}}

        #############################
        # INNER GUARDS
        #############################
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 19 22 ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 19 22 x,y,radius=18,22,3})}
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 19 23 ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 19 23 x,y,radius=18,22,3})}
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 17 22 ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING nw}{ROLE weldyn_guard}{ZONE_GUARDIAN 17 22 x,y,radius=18,22,3})}
        {LOYAL_UNITC   7 ({ON_DIFFICULTY4 "Swordsman" "Royal Guard" "Royal Guard" "Royal Guard"  }) 17 23 ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING sw}{ROLE weldyn_guard}{ZONE_GUARDIAN 17 23 x,y,radius=18,22,3})}
        {MODIFY_UNIT role=weldyn_guard experience 145}

        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "Longbowman"  "Longbowman"  "Master Bowman"}) 20 20 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 20 20 x,y,radius=19,22,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "Pikeman"     "Pikeman"     "Pikeman"      }) 21 23 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 21 23 x,y,radius=19,22,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "Longbowman"  "Longbowman"  "Master Bowman"}) 20 24 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 20 24 x,y,radius=19,23,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "none"        "Swordsman"   "Swordsman"    }) 16 20 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 16 20 x,y,radius=18,21,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"      "none"        "Longbowman"  "Longbowman"   }) 17 25 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 17 25 x,y,radius=18,23,3})}

        #############################
        # BRIDGE GUARDS
        #############################
        # These are our special bridge sappers. We give them the "sapper" ability further down.
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Cavalier" "Cavalier"}) 22 24 bridgeGuardSE _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING se}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Cavalier" "Cavalier"}) 22 20 bridgeGuardNE _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING ne}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Cavalier" "Cavalier"}) 18 18 bridgeGuardN  _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING ne}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Dragoon"  "Cavalier"}) 14 20 bridgeGuardNW _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_RESILIENT}}{FACING nw}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Dragoon"  "Cavalier"}) 14 24 bridgeGuardSW _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING sw}{ROLE weldyn_guard})}
        {NAMED_LOYAL_UNITC 7 ({ON_DIFFICULTY4 "none" "Dragoon" "Dragoon"  "Cavalier"}) 18 26 bridgeGuardS  _"Bridge Guard" ({ADD_MODIFICATION {TRAIT_STRONG}   }{FACING se}{ROLE weldyn_guard})}

        #############################
        # OUTER GUARDS
        #############################
        # don't make too many of these into ZONE_GUARDIANs, because the guardian AI might prevent them from coming to help Asheviere if she's attacked from a different direction
        # also because they can't participate in sector retreats
        # East:
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Swordsman"  "Swordsman"   "Swordsman"   "Royal Guard"}) 24 23 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Longbowman"  "Longbowman"  "Longbowman" }) 25 23 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 25 23 x,y,radius=21,23,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Pikeman"    }) 25 21 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Swordsman"   "Swordsman"   "Swordsman"  }) 24 20 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 24 20 x,y,radius=21,23,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Longbowman"  "Longbowman" }) 24 22 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Halberdier" }) 23 18 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 23 18 x,y,radius=19,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Longbowman" "Longbowman"  "Longbowman"  "Longbowman" }) 20 17 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 20 17 x,y,radius=19,20,5})}
        # West:
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Pikeman"    "Pikeman"     "Pikeman"     "Halberdier" }) 17 17 ({FACING ne}                                                           )}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Longbowman"  "Longbowman"  "Longbowman" }) 16 16 ({FACING nw}{ROLE weldyn_guard}{ZONE_GUARDIAN 16 16 x,y,radius=17,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Pikeman"    }) 12 18 ({FACING nw}{ROLE weldyn_guard}{ZONE_GUARDIAN 12 18 x,y,radius=16,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Longbowman" "Longbowman"  "Longbowman"  "Longbowman" }) 11 22 ({FACING sw}{ROLE weldyn_guard}{ZONE_GUARDIAN 11 22 x,y,radius=16,20,5})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Swordsman"   "Swordsman"   "Swordsman"  }) 13 26 ({FACING ne}{ROLE weldyn_guard}{ZONE_GUARDIAN 13 26 x,y,radius=17,24,5})}
        # South:
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "Longbowman" "Longbowman"  "Longbowman"  "Longbowman" }) 22 27 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 22 27 x,y,radius=18,25,4})} # can be attacked without countering
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "Swordsman"   "Swordsman"   "Royal Guard"}) 19 29 ({FACING se}{ROLE weldyn_guard}{ZONE_GUARDIAN 19 29 x,y,radius=18,26,4})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY4 "none"       "none"        "Pikeman"     "Pikeman"    }) 20 27 ({FACING sw}                                                           )}

        #############################
        # ORCISH GUARDS
        #############################
        # North:
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Troll"              "Troll"             })  36  2  ({FACING se}{ZONE_GUARDIAN 36  2 x,y,radius=33,1,4})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Archer"      "Orcish Archer"     })  32  3  ({FACING se}{ZONE_GUARDIAN 32  3 x,y,radius=33,2,3})}
        # Mid:
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Troll Whelp"     "Troll"              "Troll"             })  41 21  ({FACING nw}{ZONE_GUARDIAN 41 21 x,y,radius=41,22,2})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Troll Whelp"        "Troll"             })  40 23  ({FACING ne}{ZONE_GUARDIAN 40 23 x,y,radius=39,22,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Orcish Archer"   "Orcish Archer"   "Orcish Crossbowman" "Orcish Crossbowman"})  35 22  ({FACING nw}{ZONE_GUARDIAN 35 22 x,y,radius=37,22,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Archer"      "Orcish Archer"     })  34 23  ({FACING se}{ZONE_GUARDIAN 34 23 x,y,radius=37,22,3})}
        # South:
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"    "Orcish Warrior"     "Orcish Warrior"    })  60 28  ({FACING nw}{ZONE_GUARDIAN 60 28 x,y,radius=61,30,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Troll Whelp"        "Troll"             })  58 30  ({FACING ne}{ZONE_GUARDIAN 58 30 x,y,radius=60,31,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"            "Orcish Archer"   "Orcish Crossbowman" "Orcish Crossbowman"})  57 32  ({FACING nw}{ZONE_GUARDIAN 57 32 x,y,radius=59,32,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Archer"   "Orcish Archer"      "Orcish Archer"     })  61 32  ({FACING se}{ZONE_GUARDIAN 61 32 x,y,radius=60,31,3})}

        #############################
        # SCATTERED GUARDS
        #############################
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Orcish Archer"   "Orcish Archer"   "Orcish Crossbowman" "Orcish Crossbowman"})  18  9  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 18  9 x,y,radius=18,9,3})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"            "Troll Whelp"     "Troll Whelp"        "Troll"             })  20  9  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 20  9 x,y,radius=18,9,3})}

        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Troll Whelp"     "Troll"              "Troll"             })  31 16  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 31 16 x,y,radius=33,21,7})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"       "Orcish Warrior"    })  32 17  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 32 17 x,y,radius=33,21,7})}

        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Orcish Grunt"    "Troll Whelp"     "Troll Whelp"        "Troll"             })  34 28  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 34 28 x,y,radius=35,32,5})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"            "Orcish Archer"   "Orcish Crossbowman" "Orcish Crossbowman"})  35 33  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 35 33 x,y,radius=35,32,5})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Grunt"    "Orcish Grunt"       "Orcish Grunt"      })  39 32  ({FACING se}{ROLE scattered_guard}{ZONE_GUARDIAN 39 32 x,y,radius=35,32,5})}
        # capture any villages that are near any of our gaurds
        [capture_village]
            side=6
            radius=3 {FILTER side=6}
        [/capture_village]

        #############################
        # ADD SAPPER ABILITY
        #############################
        #
        # 25 hitpoints is an important threshold: A strong Iron Mauler led by Li'sar at day deals 23 damage vs a Dragoon.
        # The fire damage exception is also important. Not only is it realistic, but Delfador can easily bypass 25 damage with a leadership/AMLAed Fire Wraith.
        # Don't let any of those guranteed units beat sappers; require the player to have invested in non-default units instead.
        #
        # This 25 damage threshold can be crossed by Horsemen-line units (either from Blackwater or from Test of the Clans),
        # Cavaliers, Masters-at-Arms, Halberdiers, Tritons/Hoplites, Thunderer-line units, and Granite Golems.
        # Or, by investing multiple AMLAs into a single unit.
        #
        {GIVE_OBJECT_TO id=bridgeGuardSE,bridgeGuardNE,bridgeGuardN,bridgeGuardNW,bridgeGuardSW,bridgeGuardS (
            id=sapper_ability_object
            {EFFECT overlay add=halo/bomb-overlay.png}
            {EFFECT new_ability (
                [abilities]
                    [dummy]
                        id=sapper
                        name=_"sapper"
                        description= _ "This unit is carrying explosives. When defeated, it will destroy whatever terrain it is standing on.

This unit will not detonate if overkilled by 25 hitpoints or more, as long as the vanquishing damage type is not fire."
                    [/dummy]
                [/abilities]
            )}
        )}
        [event]
            name=side 7 turn refresh
            first_time_only=no
            # prevent the bridge guards from moving. They start on the bridge and they should stay there.
            {MODIFY_UNIT id=bridgeGuardSE,bridgeGuardNE,bridgeGuardN,bridgeGuardNW,bridgeGuardSW,bridgeGuardS moves 0}
        [/event]
        [event]
            name=side 7 turn
            # if battle has reached the center of Weldyn, release any remaining bridge guards from their vigil - they're needed to help fight
            {FILTER_CONDITION({HAVE_UNIT( side,count=1,5-99 {FILTER_LOCATION x,y,radius=18,22,3} )})}
            {REMOVE_OBJECT sapper_ability_object ()}
            {MODIFY_UNIT id=bridgeGuardSE id genericGuard1}
            {MODIFY_UNIT id=bridgeGuardNE id genericGuard2}
            {MODIFY_UNIT id=bridgeGuardN  id genericGuard3}
            {MODIFY_UNIT id=bridgeGuardNW id genericGuard4}
            {MODIFY_UNIT id=bridgeGuardSW id genericGuard5}
            {MODIFY_UNIT id=bridgeGuardS  id genericGuard6}
        [/event]

        #############################
        # IMPLEMENT SAPPER DETONATION
        #############################
        [event]
            name=last breath
            first_time_only=no
            {FILTER ability=sapper}

            # manually award XP to whoever got the kill, since we needed to manually kill the sapper as part of this event
            [modify_unit]
                {FILTER id=$second_unit}
                experience="$( $this_unit.experience + 8*$unit.level )"
            [/modify_unit]

            #------------------------
            # FAILED DETONATION
            #------------------------
            {IF}
            {VARIABLE_CONDITIONAL unit.hitpoints less_than_equal_to -25}
            {VARIABLE_CONDITIONAL second_attack.type not_equals fire}
            {THEN(
                # if this is our first time blocking a unit, explain it to the player
                {IF} {VARIABLE_CONDITIONAL explained_blocked not_equals yes} {THEN(
                    [message]
                        speaker=unit
                        message= _ "Ack!"
                    [/message]
                    {KILL id=$unit.id ANIMATE=yes}
                    {IF} {VARIABLE_CONDITIONAL explained_detonated not_equals yes} {THEN(
                        [message]
                            speaker=Konrad
                            message= _ "That guard was carrying some kind of strange device! Whatever it was, we slew him with such a mighty blow that he had not the chance to use it."
                        [/message]
                    )} {ELSE(
                        [message]
                            speaker=Konrad
                            message= _ "Well done! We slew this guard with such a mighty blow that he had not a chance to destroy his bridge."
                        [/message]
                    )} {/IF}
                )}
                # if we've already explained blocking, don't do anything special
                {ELSE(
                    {KILL id=$unit.id ANIMATE=yes}
                )} {/IF}
                {VARIABLE explained_blocked yes}
            )}
            #------------------------
            # SUCCESSFUL DETONATION
            #------------------------
            {ELSE(
                # if this is our first time detonating, explain it to the player
                {IF} {VARIABLE_CONDITIONAL explained_detonated not_equals yes} {THEN(
                    {IF} {VARIABLE_CONDITIONAL second_attack.type equals fire} {THEN(
                        [message]
                            speaker=unit
                            message= _ "The fire is getting to the explosive powder! Your Majesty—"
                        [/message]
                    )}
                    {ELSE(
                        # if the killer is flying/swimming, call that out in the message
                        {IF} {HAVE_UNIT( id=$second_unit.id {AND( race=merman,gryphon {OR type_adv_tree="Fire Guardian"} )} )}
                        {THEN(
                            [message]
                                speaker=unit
                                message= _ "Argh! Your Majesty... it doesn’t even need to walk..."
                            [/message]
                        )} {ELSE(
                            [message]
                                speaker=unit
                                message= _ "Argh! Your Majesty... the plan..."
                            [/message]
                        )} {/IF}
                        [message]
                            speaker=Asheviere
                            message= _ "Carry out your orders. Do not disappoint me."
                        [/message]
                    )} {/IF}
                )} {/IF}
                {VARIABLE explained_detonated yes}

                {SOUND fuse.ogg}
                {DELAY 2000}

                # remove loyal/sapper so that they don't appear on top of teh explosion animation
                {REMOVE_OBJECT sapper_ability_object id=$unit.id}
                [remove_trait]
                    id=$unit.id
                [/remove_trait]

                # use a standing anim so that this isn't affected by acceleration
                {GIVE_OBJECT_TO id=$unit.id ({EFFECT new_animation (
                    [standing_anim]
                        base_score=999
                        start_time=0
                        {FRAME alpha=1~0,0}
                        {OVERLAY_FRAME image="halo/flame-burst-[1~8].png~SCALE(200,300):75"}
                        {OVERLAY_FRAME image="misc/blank-hex.png:500"}
                    [/standing_anim]
                )})}
                {SOUND dragonstick.ogg}
                {DELAY 400}

                # remove bridge. Not rubble terrain, or else we give Konrad a good defensive spot, defeating the purpose of blowing up the bridge
                [terrain]
                    x,y=$unit.x,$unit.y
                    layer=overlay
                    terrain="^"
                [/terrain]
                {RANDOM "castle-ruins.png,castle-ruins2.png,castle-ruins3.png"}
                {PLACE_IMAGE scenery/$random $unit.x $unit.y}
                {CLEAR_VARIABLE random}
                {DELAY 400}

                {KILL id=$unit.id}
            )} {/IF}
        [/event]

        #############################
        # KONRAD
        #############################
        {RECALL_KONRAD_AND_COMPANIONS 58 12}
        {TELEPORT_UNIT x,y=57,12 59 13}

        {UNSTORE_NPC Lisar x,y=55,8 side=$lisar_side}
        {MODIFY_UNIT side=1,$lisar_side facing sw}
        {WARVEN_OR_GUARD "Elite Heavy Infantryman" 56 9 sw x,y,radius=56,8,3}

        # start with the camera on Asheviere
        {SCROLL_TO 18 22}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # REHASH KONRAD'S PARENTAGE
        #############################
        {REPLACE_SCENARIO_MUSIC juggernaut-louder.ogg}
        {APPEND_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC primal-carnage.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        {DELAY 1950} # this is about how long it takes for the first note of juggernaut.ogg to play

        #############################
        # INTRODUCE ASHEVIERE
        #############################
        {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals yes} {THEN(
            [message]
                speaker=Asheviere
                message= _ "So. After burning half my fields, these rebels come at last to face me."
            [/message]
        )} {ELSE(
            [message]
                speaker=Asheviere
                message= _ "So, these rebels come at last to face me."
            [/message]
        )} {/IF}
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message= _ "Surrender, mother. The land’s blood is spent. I have come to take my rightful place."
        [/message]
        [message]
            speaker=Asheviere
            message= _ "Ahh. My own daughter, a turncoat. Such treason my reign must endure! But endure it will."
        [/message]
        [message]
            speaker=Asheviere
            message= _ "For the walls of Weldyn are strong. And her allies are many! They will arrive in days — and then you will die."
        [/message]

        #############################
        # LIST ASHEVEIRE'S ALLIES
        #############################
#define LIST_ASHEVEIRE_ALLIES S41 S42 S47 S48 MESSAGE
    {IF}
    {VARIABLE_CONDITIONAL status_s41 {S41} completed}
    {VARIABLE_CONDITIONAL status_s42 {S42} completed}
    {VARIABLE_CONDITIONAL status_s47 {S47} completed}
    {VARIABLE_CONDITIONAL status_s48 {S48} completed}
    [then]
        [message]
            speaker=Konrad
            message={MESSAGE}
        [/message]
    [/then]
    {/IF}
#enddef
        {LIST_ASHEVEIRE_ALLIES not_equals not_equals not_equals not_equals _"Knights from the Horse Clans, footmen from Dan’Tonk, and orcish hordes from the north now swollen even further with your mage Mirya’s new recruits. We know, and we are prepared."}

        {LIST_ASHEVEIRE_ALLIES     equals not_equals not_equals not_equals _"Knights from the Horse Clans, footmen from Dan’Tonk, and orcish hordes from the north. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES not_equals     equals not_equals not_equals _"Knights from the Horse Clans, footmen from Dan’Tonk, and your mage Mirya with her newly-recruited grunts. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES not_equals not_equals     equals not_equals _"Footmen from Dan’Tonk, orcish hordes from the north, and your mage Mirya with her newly-recruited grunts. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES not_equals not_equals not_equals     equals _"Knights from the Horse Clans and orcish hordes from the north, now swollen even further with your mage Mirya’s new recruits. We know, and we are prepared."}

        {LIST_ASHEVEIRE_ALLIES     equals     equals not_equals not_equals _"Knights from the Horse Clans and footmen from Dan’Tonk. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES     equals not_equals     equals not_equals _"Footmen from Dan’Tonk and orcish hordes from the north. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES     equals not_equals not_equals     equals _"Knights from Horse Clans and orcish hordes from the north. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES not_equals     equals     equals not_equals _"Footmen from Dan’Tonk and your mage Mirya with her newly-recruited orcs. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES not_equals     equals not_equals     equals _"Knights from the Horse Clans and your mage Mirya with her newly-recruited orcs. We know, and we are prepared."}
        {LIST_ASHEVEIRE_ALLIES not_equals not_equals     equals     equals _"Orcish hordes from the north, now swollen even further with your mage Mirya’s new recruits. We know, and we are prepared."}

        {LIST_ASHEVEIRE_ALLIES not_equals     equals     equals     equals _"Fewer than there might have been. Of all your allies, only your mage Mirya and her newly-recruited orcs are still ready to aid you. We did not come here unprepared."}
        {LIST_ASHEVEIRE_ALLIES     equals not_equals     equals     equals _"Fewer than there might have been. Of all your allies, only the orcish hordes of the north still stand ready to aid you. We did not come here unprepared."}
        {LIST_ASHEVEIRE_ALLIES     equals     equals not_equals     equals _"Fewer than there might have been. Of all your allies, only the Horse Clans still stand ready to aid you. We did not come here unprepared."}
        {LIST_ASHEVEIRE_ALLIES     equals     equals     equals not_equals _"Fewer than there might have been. Of all your allies, only the footmen of Dan’Tonk still stand ready to aid you. We did not come here unprepared."}

        {LIST_ASHEVEIRE_ALLIES     equals     equals     equals     equals _"What allies, Your Grace? The Horse Clans have turned their backs; Dan’Tonk is barricaded; the orcish clans are embroiled in civil war. Even your mage Mirya is gone. You have nothing more than the forces arrayed before us here."}

        #############################
        # PREPARE FOR BATTLE
        #############################
        [message]
            speaker=Delfador
            message= _ "How long must the people endure your rule, woman? Give the throne to your daughter. She is the rightful heir. We even hold the Sceptre to prove it!"
        [/message]
        [message]
            speaker=Asheviere
            message= _ "Delfador! My old tormentor! Treason! Men! Seize them! Kill them! Kill them all!"
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Asheviere"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    #############################
    # EXPLAIN BURLIN
    #############################
    [event]
        name=side 7 turn 2 end
        {FILTER_CONDITION({VARIABLE_CONDITIONAL status_s14 equals completed})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_s14_fought_burlin not_equals yes})}
        {SCROLL_TO 12 19}
        [message]
            speaker=Konrad
            scroll=no
            message= _ "It’s you! The dwarf from Gryphon Mountain! I thought you were merely delivering eggs to Asheviere, not fighting for her."
        [/message]
        [message]
            speaker=Burlin
            message= _ "Well, you know what they say: money talks. It’s nothing personal."
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                               ASHEVIERE'S REINFORCEMENTS
    #######################################################################################################################################################
    #############################
    # TRIGGER EACH REINFORCEMENT
    #############################
    [event]
        name=prestart
        {VARIABLE reinforcement_count 0}
        {IF} {VARIABLE_CONDITIONAL status_s41 not_equals completed} {THEN({VARIABLE_OP reinforcement_count add 1})} {/IF}
        {IF} {VARIABLE_CONDITIONAL status_s42 not_equals completed} {THEN({VARIABLE_OP reinforcement_count add 1})} {/IF}
        {IF} {VARIABLE_CONDITIONAL status_s47 not_equals completed} {THEN({VARIABLE_OP reinforcement_count add 1})} {/IF}
        {IF} {VARIABLE_CONDITIONAL status_s48 not_equals completed} {THEN({VARIABLE_OP reinforcement_count add 1})} {/IF}
    [/event]
    [event]
        name=new turn
        first_time_only=no
        # The more reinforcements we have incoming, the faster they arrive.
        # Every 6 turns if we have all 4, every 8 turns if we have 3, every 10 turns if we have 2, and on turn 12 if we only have 1.
        # Make sure that the second initial spawn isn't on the same turn as the first infinite spawn, or the foreshadowing messages might be confusing
        {FILTER_CONDITION({LUA(<< return (  (wesnoth.current.turn % (14 - 2*wml.variables['reinforcement_count'])) == 0  ) >>)})}
        {IF} {VARIABLE_CONDITIONAL reinforced_this_turn not_equals yes} {THEN({FIRE_EVENT begin_reinforcement_s41})} {/IF}
        {IF} {VARIABLE_CONDITIONAL reinforced_this_turn not_equals yes} {THEN({FIRE_EVENT begin_reinforcement_s48})} {/IF}
        {IF} {VARIABLE_CONDITIONAL reinforced_this_turn not_equals yes} {THEN({FIRE_EVENT begin_reinforcement_s42})} {/IF}
        {IF} {VARIABLE_CONDITIONAL reinforced_this_turn not_equals yes} {THEN({FIRE_EVENT begin_reinforcement_s47})} {/IF}
        {CLEAR_VARIABLE reinforced_this_turn}
    [/event]
    [event]
        name=explain_first_reinforcement
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"Their initial attack will be especially powerful, but they will continue reinforcing Asheviere every day or two until she is defeated — or we are."
        [/message]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"Each wave of attackers will be ready to move and fight the instant they arrive, so we should be careful not to leave our soldiers exposed near the attackers’ entry points."
        [/message]
    [/event]
    [event]
        name=explain_infinite_reinforcements
        [message]
            speaker=Delfador
            scroll=no
            message=_"Konrad, Asheviere’s allies have prepared a follow-up attack! This wave is not especially powerful, but I suspect that each subsequent follow-up will be more deadly than the last."
        [/message]
    [/event]

    #############################
    # REINFORCEMENTS MACRO
    #############################
#define DEFINE_REINFORCEMENT SIDE SNUM
#arg FOREWARNING
#endarg
#arg PLACE_ARROWS
#endarg
#arg ARRIVAL
#endarg
#arg SPAWNS_HIGHLEVEL
#endarg
#arg SPAWNS_MIDLEVEL
#endarg
#arg SPAWNS_LOWLEVEL
#endarg
#arg SPAWNS_X
#endarg
#arg SPAWNS_Y
#endarg
    [event]
        name=begin_reinforcement_{SNUM}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL status_{SNUM} not_equals completed})}
        {VARIABLE latest_{SNUM} $turn_number}

        #------------------------
        # FOREWARNING
        #------------------------
        {FOREWARNING}
        {PLACE_ARROWS}
        {FIRE_EVENT explain_first_reinforcement}

        #------------------------
        # INITIAL SPAWN
        #------------------------
        {VARIABLE initial_turn_{SNUM} $turn_number}
        [event]
            name=side {SIDE} turn

            # remove our old arrows
            [remove_item]
                image=items/arrowN.png
            [/remove_item]
            [remove_item]
                image=items/arrowS.png
            [/remove_item]
            [remove_item]
                image=items/arrowE.png
            [/remove_item]
            [remove_item]
                image=items/arrowW.png
            [/remove_item]

            # initial units arrive and play a cutscene
            {ARRIVAL}

            #------------------------
            # INFINITE SPAWNS
            #------------------------
            # one turn before each time that we spawn units, show the player where they'll spawn
            [event]
                name=new turn
                first_time_only=no
                # spawn more units every 9 turns
                # Make sure that the second initial spawn isn't on the same turn as the first infinite spawn, or the foreshadowing messages might be confusing
                # can't use lua, because the preprocessor doesn't substitute {SNUM} inside lua tags
                {FILTER_CONDITION({VARIABLE_CONDITIONAL turn_number formula "(value%9) = (($initial_turn_{SNUM})%9)"})}
                {FIRE_EVENT explain_infinite_reinforcements}
                {PLACE_ARROWS}
                [event]
                    name=side {SIDE} turn

                    # remove our old arrows
                    [remove_item]
                        image=items/arrowN.png
                    [/remove_item]
                    [remove_item]
                        image=items/arrowS.png
                    [/remove_item]
                    [remove_item]
                        image=items/arrowE.png
                    [/remove_item]
                    [remove_item]
                        image=items/arrowW.png
                    [/remove_item]

                    # Decide how many levels to spawn. Spawn fewer if we already have many units.
                    # Spawn more over time, but half as much per-side when we have 4 reinforcments as compared to 1. That way the total time-scaling stays kinda consistent.
                    # With only 1 reinforcement:  first 6/12/18/24, then 9/18/27/36, then 12/24/36/48, etc
                    # With all  4 reinforcements: first 3/ 6/ 9/12, then 4/ 9/13/18, then  6/12/18/24, etc (for each reinforcement side)
                    {GET_ARMY_LEVELS {SIDE} (VARNAME=existing_levels)}
                    # IMPORTANT - "/" ROUNDS DOWN when used with integers. To work around this, use "#.0" in my divisions.
                    {VARIABLE levels_to_spawn "$( (9+$turn_number-$initial_turn_{SNUM}) * {ON_DIFFICULTY4 0.33 0.67 1.00 1.33} * (3.0/(2+$reinforcement_count)) - $existing_levels/2.0 )"}
                    {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals yes} {THEN({VARIABLE_OP levels_to_spawn multiply 0.67})} {/IF}
                    [while]
                        {VARIABLE_CONDITIONAL levels_to_spawn greater_than 0}
                        [do]
                            # Decide which unit to create
                            # Remember that $levels_to_spawn decreases each time we spawn a unit, so {SPAWNS_LOWLEVEL} will always get triggered even if we start with huge $levels_to_spawn
                            {IF} {VARIABLE_CONDITIONAL levels_to_spawn greater_than_equal_to 25} {THEN(
                                {VARIABLE_OP unit_type rand {SPAWNS_HIGHLEVEL}}
                            )} {ELSEIF} {VARIABLE_CONDITIONAL levels_to_spawn greater_than_equal_to 10} {THEN(
                                {VARIABLE_OP unit_type rand {SPAWNS_MIDLEVEL}}
                            )} {/ELSEIF} {ELSE(
                                {VARIABLE_OP unit_type rand {SPAWNS_LOWLEVEL}}
                            )} {/IF}
                            {VARIABLE_OP x rand {SPAWNS_X}}
                            {VARIABLE_OP y rand {SPAWNS_Y}}

                            # create the unit, and decrease $levels_to_spawn
                            {GENERIC_UNIT {SIDE} $unit_type $x $y}
                            [store_unit_type]
                                type=$unit_type
                                variable=type_details
                            [/store_unit_type]
                            {VARIABLE_OP levels_to_spawn sub "$( max([ 0.5, $type_details.level ]) )"} # level-0 units count as 0.5
                            {CLEAR_VARIABLE unit_type,x,y,type_details}
                        [/do]
                    [/while]
                    {CLEAR_VARIABLE existing_levels,levels_to_spawn}
                    {VARIABLE latest_{SNUM} $turn_number}
                [/event]
            [/event]
        [/event]

        # don't trigger multiple reinforcements at the same time
        {VARIABLE reinforced_this_turn yes}
    [/event]
#enddef
    #############################
    # FELL-HANDS
    #############################
    #wmlindent: start ignoring
    {DEFINE_REINFORCEMENT 2 s41
        (FOREWARNING=
            {SCROLL_TO 19 1}
            [message]
                speaker=Delfador
                scroll=no
                message=_"Konrad, I sense a current of magic approaching along the north road. I suspect we will soon encounter that teleporting mage of Asheviere’s, along with her orcish allies and mage followers."
            [/message]
        )
        (PLACE_ARROWS=
            # have to do this weird variables thing because of the way {HIGHLIGHT_IMAGE} is implemented
            {VARIABLE highlightX 15,17,19,21,23}
            {VARIABLE highlightY 1,1,1,1,1}
            {HIGHLIGHT_IMAGE $highlightX $highlightY items/arrowS.png ()}
            {CLEAR_VARIABLE highlightX,highlightY}
        )
        (ARRIVAL=
            {FADE_MUSIC_OUT 1000}

            {UNSTORE_NPC Mirya x,y=19,1 side=2}
            {MODIFY_UNIT id=Mirya canrecruit no}
            [message]
                speaker=Mirya
                message=_"Ah, we’ve arrived at the perfect time."
            [/message]

            # aim for around 40 levels on everyone's initial reinforcements
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "none"           "Troll Whelp"    "Troll Whelp"   }) 17 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "Orcish Grunt" "Orcish Grunt"   "Orcish Warrior" "Orcish Warrior"}) 17 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "Orcish Grunt"   "Orcish Grunt"   "Orcish Grunt"  }) 17 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "none"           "Troll Whelp"    "Troll Whelp"   }) 17 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "Orcish Grunt" "Orcish Grunt"   "Orcish Warrior" "Orcish Warrior"}) 17 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "Orcish Grunt"   "Orcish Grunt"   "Orcish Grunt"  }) 17 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "Orcish Grunt" "Orcish Warrior" "Orcish Warrior" "Orcish Warrior"}) 17 1 ({FACING ne}{ANIMATE})}
            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"         "none"           "none"           "Troll Whelp"   }) 15 1 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"         "none"           "Orcish Grunt"   "Orcish Warrior"}) 15 1 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Troll Whelp"  "Troll Whelp"    "Troll Whelp"    "Troll"         }) 15 1 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Troll Whelp"  "Troll Whelp"    "Troll Whelp"    "Troll"         }) 15 1 ({FACING se}{ANIMATE})}
            )} {/IF}

            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "Silver Mage"    "Silver Mage"    "Silver Mage"   }) 21 1 ({FACING se}{ANIMATE}{GENDER male})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "none"           "Silver Mage"    "Silver Mage"   }) 21 1 ({FACING se}{ANIMATE}{GENDER male})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "Troll Whelp"  "Troll Whelp"    "Troll Whelp"    "Troll"         }) 21 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "none"           "Troll Whelp"    "Troll Whelp"   }) 21 1 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "Troll Whelp"    "Troll Whelp"    "Troll"         }) 21 1 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "Troll Whelp"    "Troll Whelp"    "Troll"         }) 21 1 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     2 ({ON_DIFFICULTY4 "none"         "none"           "Orcish Grunt"   "Orcish Warrior"}) 21 1 ({FACING se}{ANIMATE})}
            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"         "none"           "Troll Whelp"    "Troll Whelp"   }) 23 1 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Troll Whelp"  "Troll"          "Troll"          "Troll"         }) 23 1 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Troll Whelp"  "Troll"          "Troll"          "Troll"         }) 23 1 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"         "none"           "Orcish Grunt"   "Orcish Warrior"}) 23 1 ({FACING se}{ANIMATE})}
            )} {/IF}

            {INCIDENTAL_MUSIC frantic.ogg}
            {FADE_MUSIC_IN 10}

            [message]
                speaker=Mirya
                message=_"Congratulations on your entry into the queen’s service, orcs. To earn your first payment, bring me the heads of the rebel leaders."
            [/message]

            # Mirya events
            [event]
                name=attack
                {FILTER_SECOND id=Mirya}
                [message]
                    speaker=Lisar
                    message=_"You’re a good mage, Mirya. It’s a shame you’re a bad person."
                [/message]
            [/event]
            [event]
                name=unit hits
                {FILTER_SECOND id,formula=Mirya,"(self.hitpoints < self.max_hitpoints/2)"}
                [message]
                    speaker=Mirya
                    message=_"Ow! I think it’s time to take my leave. No point dying for the cause when I could live for it instead."
                [/message]
                {ANIMATE_UNIT id=Mirya pre_teleport}
                [message]
                    speaker=Delfador {DELFADOR_VARIATION mad}
                    #po: "Morium libre vintis" doesn't mean anything. It's just some gibberish that sounds like a magic spell.
                    message=_"You will not leave. Morium libre vintis!"
                [/message]
                {SCREEN_FADER 200,200,255 100 0}
                {SOUND lightning.ogg}
                {DELAY 150}
                {SCREEN_FADER 200,200,255   0 0}
                [message]
                    speaker=Mirya
                    message=_"My spell is broken!"
                [/message]
            [/event]
            [event]
                name=last breath
                {FILTER id=Mirya}
                [message]
                    speaker=Mirya
                    message=_"Urgh..."
                [/message]
            [/event]
        )
        (SPAWNS_HIGHLEVEL="Troll,Troll Warrior,Orcish Warrior,Orcish Warlord,Silver Mage")
        (SPAWNS_MIDLEVEL= "Troll,Troll,Orcish Warrior,Orcish Warrior,Silver Mage")
        (SPAWNS_LOWLEVEL= "Troll Whelp,Troll Whelp,Orcish Grunt,Orcish Grunt")
        (SPAWNS_X=16..22,18..24)
        (SPAWNS_Y=1)
    }
    #############################
    # DAN'TONK
    #############################
    {DEFINE_REINFORCEMENT 3 s48
        (FOREWARNING=
            {SCROLL_TO 2 10}
            [message]
                speaker=Lisar
                scroll=no
                message=_"Look, to the west! There is a great plume of dust visible just over the horizon."
            [/message]
            [message]
                speaker=Lisar
                scroll=no
                message=_"That road leads to Dan’Tonk — there must be a column of soldiers marching to my mother’s aid. They’ll be here any moment."
            [/message]
        )
        (PLACE_ARROWS=
            {HIGHLIGHT_IMAGE 1 8-14 items/arrowE.png ()}
        )
        (ARRIVAL=
            {FADE_MUSIC_OUT 1000}

            {UNSTORE_NPC Isolde x,y=1,10 side=3}
            {MODIFY_UNIT id=Isolde canrecruit no}
            {GIVE_OBJECT_TO id=Isolde ({EFFECT overlay add=misc/loyal-icon.png})}
            [message]
                speaker=Isolde
                message=_"Your Majesty! So Konrad has come, just as you said he would. My army will make short work of him."
            [/message]

            # aim for around 40 levels on everyone's initial reinforcements
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Spearman"   "Spearman"  }) 1 9 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"   "Spearman"  }) 1 9 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Javelineer" "Javelineer"}) 1 9 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "Fencer"     "Fencer"     "Fencer"    }) 1 9 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Javelineer" "Javelineer"}) 1 9 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "Fencer"     "Fencer"     "Fencer"    }) 1 9 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"     "Fencer"    }) 1 9 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "Bowman"     "Bowman"     "Bowman"    }) 1 9 ({FACING ne}{ANIMATE})}
            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Bowman"     "Bowman"    }) 1 9 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Bowman"   "Bowman"     "Bowman"     "Bowman"    }) 1 7 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Bowman"     "Bowman"     "Bowman"    }) 1 7 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"   "Spearman"  }) 1 6 ({FACING ne}{ANIMATE})}
            )} {/IF}

            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"     "Fencer"    }) 1 11 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "Javelineer" "Javelineer" "Javelineer"}) 1 11 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Spearman" "Spearman"   "Spearman"   "Spearman"  }) 1 11 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"     "Fencer"    }) 1 11 ({FACING ne}{ANIMATE})}
            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Fencer"   "Fencer"     "Fencer"     "Fencer"    }) 1 11 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Spearman"   "Spearman"   "Spearman"  }) 1 11 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Bowman"     "Bowman"     "Bowman"    }) 1 11 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"       "Bowman"     "Bowman"    }) 1 11 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"       "none"       "Spearman"  }) 1 11 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"   "Javelineer"}) 1 11 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"   "Javelineer"}) 1 11 ({FACING se}{ANIMATE})}
            )} {/IF}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "none"       "Spearman"}) 1 11 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"   "Spearman"  }) 1 11 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "none"       "Spearman"  }) 1 11 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "none"       "Spearman"  }) 1 13 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"   "Spearman"  }) 1 13 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"   "Javelineer"}) 1 13 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "none"       "Javelineer"}) 1 14 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "Spearman"   "Spearman"  }) 1 14 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     3 ({ON_DIFFICULTY4 "none"     "none"       "none"       "Spearman"  }) 1 15 ({FACING se}{ANIMATE})}

            {INCIDENTAL_MUSIC loyalists.ogg}
            {FADE_MUSIC_IN 10}

            # Isolde events
            [event]
                name=attack
                {FILTER_SECOND id=Isolde}
                [message]
                    speaker=Lisar
                    message=_"I’m sorry it had to come to this, Isolde. I respected you."
                [/message]
                [message]
                    speaker=Isolde
                    message=_"You picked the wrong side, princess. I’ll try to capture you alive."
                [/message]
            [/event]
            [event]
                name=last breath
                {FILTER id=Isolde}
                [message]
                    speaker=Isolde
                    message=_"Don’t surrender, my queen! Do not let my death be in vain!"
                [/message]
            [/event]
        )
        (SPAWNS_HIGHLEVEL="Pikeman,Duelist,Longbowman,Javelineer")
        (SPAWNS_MIDLEVEL= "Spearman,Bowman,Fencer,Javelineer,Javelineer,Javelineer")
        (SPAWNS_LOWLEVEL= "Spearman,Bowman,Fencer")
        (SPAWNS_X=1)
        (SPAWNS_Y=7..12,10..15)
    }
    #############################
    # WHITEFANGS
    #############################
    {DEFINE_REINFORCEMENT 4 s42
        (FOREWARNING=
            {SCROLL_TO 61 4}
            [message]
                speaker=Konrad
                scroll=no
                message=_"I hear the rhythmic beat of war-drums. There is a vast orcish host approaching from the northeast, behind us! They must have come a long way to make war."
            [/message]
        )
        (PLACE_ARROWS=
            {HIGHLIGHT_IMAGE 61 2-8 items/arrowW.png ()}
        )
        (ARRIVAL=
            {FADE_MUSIC_OUT 500}
            {INCIDENTAL_MUSIC northerners.ogg}
            {FADE_MUSIC_IN 10}

            {NAMED_UNIT 4 "Orcish Warlord" 60 2 Faghmok _"Fagh-mok the Flattered" profile=portraits/orcs/grunt-2.webp} {FACING sw} {ANIMATE}
            {MODIFY_UNIT id=Faghmok canrecruit no}
            {GIVE_OBJECT_TO id=Faghmok ({EFFECT overlay add=misc/loyal-icon.png})}
            [message]
                speaker=Faghmok
                message=_"Should’ve taken me up on my offer when you had the chance, Konrad. If I can’t kill the chief, maybe I can still win his favor by killing you!"
            [/message]

            # aim for around 40 levels on everyone's initial reinforcements (goblin spearmen count as 0.5)
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"    "Orcish Grunt"   }) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Impaler"  "Goblin Impaler" }) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"   }) 61 2 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Spearman" "Goblin Spearman"}) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin" "Orcish Slayer"   "Orcish Slayer"  }) 61 2 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin" "Orcish Assassin" "Orcish Slayer"  }) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Orcish Archer"   "Orcish Archer"   "Orcish Archer"  }) 61 2 ({FACING nw}{ANIMATE})}
            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Goblin Spearman" "Goblin Impaler" }) 61 2 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Goblin Impaler"  "Goblin Impaler" }) 61 2 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Spearman" "Goblin Spearman"}) 61 2 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Spearman" "Goblin Spearman"}) 61 2 ({FACING ne}{ANIMATE})}
            )} {/IF}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Orcish Assassin" "Orcish Assassin" "Orcish Slayer"  }) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "none"            "Goblin Spearman" "Goblin Spearman"}) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "none"            "Goblin Spearman" "Goblin Spearman"}) 61 2 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Orcish Assassin" "Orcish Assassin" "Orcish Slayer"  }) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "none"            "Orcish Archer"   "Orcish Archer"  }) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "none"            "none"            "Goblin Spearman"}) 61 2 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "none"            "Goblin Spearman" "Goblin Impaler" }) 61 2 ({FACING ne}{ANIMATE})}

            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Orcish Assassin" "Orcish Assassin" "Orcish Assassin"}) 61 6 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Goblin Spearman" "Goblin Impaler" }) 61 6 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"    "Orcish Grunt"   }) 61 6 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Goblin Impaler"  "Goblin Impaler"  "Goblin Impaler" }) 61 6 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Orcish Assassin" "Orcish Assassin" "Orcish Assassin"}) 61 6 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Goblin Spearman" "Goblin Impaler" }) 61 6 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"    "Orcish Grunt"   }) 61 6 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Impaler"  "Goblin Impaler" }) 61 6 ({FACING nw}{ANIMATE})}
            {GENERIC_UNITC     4 ({ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin" "Orcish Slayer"   "Orcish Slayer"  }) 61 6 ({FACING nw}{ANIMATE})}
            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"    "Orcish Grunt"   }) 61 6 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman" "Orcish Grunt"    "Orcish Grunt"   }) 61 6 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Spearman" "Goblin Impaler" }) 61 6 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Orcish Archer"   "Orcish Archer"   "Orcish Archer"   "Orcish Archer"  }) 61 6 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "Orcish Assassin" "Orcish Assassin" "Orcish Assassin"}) 61 8 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "Goblin Spearman" "Goblin Spearman" "Goblin Spearman"}) 61 8 ({FACING ne}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "none"            "Goblin Spearman" "Goblin Spearman"}) 61 8 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "none"            "Goblin Spearman" "Goblin Impaler" }) 61 8 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "none"            "Orcish Archer"   "Orcish Archer"  }) 61 8 ({FACING nw}{ANIMATE})}
                {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"            "none"            "none"            "Goblin Impaler" }) 61 8 ({FACING ne}{ANIMATE})}
            )} {/IF}

            # Fagh-mok events
            [event]
                name=attack
                {FILTER_SECOND id=Faghmok}
                [message]
                    speaker=Konrad
                    message=_"Coming here was a poor decision, orc. The dark queen’s reign is at an end. You tie yourself to a sinking ship."
                [/message]
                [message]
                    speaker=Faghmok
                    message=_"Yeah yeah. Let’s get on with the fighting!"
                [/message]
            [/event]
            [event]
                name=last breath
                {FILTER id=Faghmok}
                [message]
                    speaker=Faghmok
                    message=_"Arrrgh! What a waste..."
                [/message]
            [/event]
        )
        (SPAWNS_HIGHLEVEL="Orcish Warrior,Orcish Crossbowman,Orcish Nightblade")
        (SPAWNS_MIDLEVEL= "Goblin Spearman,Orcish Grunt,Orcish Archer,Orcish Assassin,Orcish Slayer")
        (SPAWNS_LOWLEVEL= "Goblin Spearman,Goblin Spearman,Goblin Spearman,Goblin Spearman,Orcish Archer,Orcish Assassin")
        (SPAWNS_X=61)
        (SPAWNS_Y=1..8)
    }
    #############################
    # HORSE CLANS
    #############################
    {DEFINE_REINFORCEMENT 5 s47
        (FOREWARNING=
            {SCROLL_TO 48 40}
            [message]
                speaker=Konrad
                scroll=no
                message=_"There is a thunder of approaching hooves in the south! The Horse Clans have come."
            [/message]
        )
        (PLACE_ARROWS=
            # have to do this weird variables thing because of the way {HIGHLIGHT_IMAGE} is implemented
            {VARIABLE highlightX 46,48,50,52,54,56}
            {VARIABLE highlightY 41,41,41,41,41,41}
            {HIGHLIGHT_IMAGE $highlightX $highlightY items/arrowN.png ()}
            {CLEAR_VARIABLE highlightX,highlightY}
        )
        (ARRIVAL=
            {FADE_MUSIC_OUT 1000}

            {NAMED_NOTRAIT_UNIT 5 "Grand Knight" 50 40 Bayar _"Lord Bayar"} {ANIMATE} {FACING nw}
            {ADD_MODIFICATION({TRAIT_QUICK}{TRAIT_RESILIENT})}
            {GIVE_OBJECT_TO id=Bayar ({EFFECT overlay add=misc/loyal-icon.png})}
            [message]
                speaker=Bayar
                message=_"Hail, good Asheviere! We have taken the long road and come around by the south to surprise the rebels!"
            [/message]
            [message]
                speaker=Asheviere
                message=_"More like you took the long road hoping to miss the worst of the fighting. I expected better, Bayar. We will discuss this after the battle."
            [/message]

            # aim for around 40 levels on everyone's initial reinforcements
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Horseman"   "Knight"     "Knight"     "Knight"    }) 47 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Cavalryman" "Cavalryman" "Cavalryman" "Dragoon"   }) 47 41 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Horseman"   "Horseman"   "Lancer"     "Lancer"    }) 47 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Horseman"   "Horseman"   "Lancer"     "Lancer"    }) 47 41 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "Horseman"   "Lancer"     "Lancer"    }) 47 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Cavalryman" "Cavalryman" "Cavalryman" "Dragoon"   }) 47 41 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Horseman"   "Horseman"   "Lancer"     "Lancer"    }) 47 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "Horseman"   "Horseman"   "Horseman"   "Horseman"  }) 47 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "Cavalryman" "Cavalryman" "Cavalryman"}) 48 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "Horseman"   "Horseman"   "Lancer"    }) 48 41 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "none"       "Cavalryman" "Cavalryman"}) 48 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "none"       "Horseman"   "Lancer"    }) 48 41 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "none"       "Knight"     "Knight"    }) 48 41 ({FACING ne}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "none"       "none"       "Lancer"    }) 48 41 ({FACING se}{ANIMATE})}
            {GENERIC_UNITC     5 ({ON_DIFFICULTY4 "none"       "none"       "none"       "Horseman"  }) 49 41 ({FACING se}{ANIMATE})}

            {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes} {THEN(
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Horseman"   "Knight"     "Knight"     "Knight"    }) 51 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Cavalryman" "Cavalryman" "Dragoon"    "Dragoon"   }) 51 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Cavalryman" "Cavalryman" "Dragoon"    "Dragoon"   }) 51 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"       "Cavalryman" "Cavalryman" "Cavalryman"}) 51 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"       "Cavalryman" "Cavalryman" "Cavalryman"}) 51 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"       "Horseman"   "Horseman"   "Horseman"  }) 51 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"       "none"       "none"       "Lancer"    }) 52 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"       "Horseman"   "Horseman"   "Horseman"  }) 52 41 ({FACING se}{ANIMATE})}
                {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"       "none"       "none"       "Lancer"    }) 52 41 ({FACING se}{ANIMATE})}
            )} {/IF}

            {INCIDENTAL_MUSIC vengeful.ogg}
            {FADE_MUSIC_IN 10}

            # Bayar events
            [event]
                name=attack
                {FILTER_SECOND id=Bayar}
                [message]
                    speaker=Konrad {KONRAD_VARIATION mad}
                    message= _ "Lord Bayar, halt this folly! I challenge you to a personal combat."
                [/message]
                [message]
                    speaker=Asheveire
                    message=_"Ignore him. Run them down like dogs."
                [/message]
            [/event]
            [event]
                name=last breath
                {FILTER id=Bayar}
                [message]
                    speaker=Bayar
                    message=_"No! I am beaten! Perhaps the dark queen truly can be bested..."
                [/message]
            [/event]
        )
        (SPAWNS_HIGHLEVEL="Cavalier,Lancer,Knight,Grand Knight")
        (SPAWNS_MIDLEVEL= "Dragoon,Lancer,Knight")
        (SPAWNS_LOWLEVEL= "Cavalryman,Horseman,Horseman")
        (SPAWNS_X=48..54)
        (SPAWNS_Y=41)
    }
    #wmlindent: stop ignoring

    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    [event]
        name=last breath
        {FILTER id=Asheviere}
        {DELAY 250}
        {GIVE_OBJECT_TO id=Asheviere ({EFFECT variation name=defeated})}
        {DELAY 1}
        {GIVE_OBJECT_TO id=Asheviere (id=asheviere_dropping)}
        {FADE_MUSIC_OUT 1000}
        {REMOVE_OBJECT asheviere_dropping ()}
    [/event]

    #############################
    # ASHEVIERE LAST BREATHS
    #############################
    #------------------------
    # LISAR IS KILLER
    #------------------------
    [event]
        name=last breath
        {FILTER        id=Asheviere}
        {FILTER_SECOND id=Lisar}
        #textdomain wesnoth-h2tt
        [message]
            speaker=Lisar
            message=_"Mother, I swore to end your reign of evil, and now I shall."
        [/message]
        [message]
            speaker=Asheviere {ASHEVIERE_VARIATION defeated}
            message=_"Daughter, I built this kingdom for you. It has all been for you!"
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"Even now, can you not tell the truth? Your greed has corrupted your soul. You are a monster! A murderess! It pains me to kill you, Mother, but you have chosen your own fate. For Wesnoth!"
        [/message]
        #textdomain wesnoth-h2tt
        {ANIMATE_HARM id=Lisar 999 range=melee id=Asheviere EXPERIENCE=no}
        {SCREEN_FADER 100,0,0 255 0}
        {FIRE_EVENT epilogue}
    [/event]

    #------------------------
    # KONRAD IS KILLER
    #------------------------
    [event]
        name=last breath
        {FILTER        id=Asheviere}
        {FILTER_SECOND id=Konrad}
        #textdomain wesnoth-h2tt
        [message]
            speaker=Konrad
            message=_"You have hunted me across the countryside, indeed across the years. Here I am, Dark Queen."
        [/message]
        [message]
            speaker=Asheviere {ASHEVIERE_VARIATION defeated}
            message=_"I was sure I had killed you, yet you haunt me still. Be gone, demon! I banish you, ghost!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Oh, wretched lady, I am very real. The land has suffered from your greed and ambition. You will now be held to account for your misdeeds. For the young prince Konrad! For WESNOTH!"
        [/message]
        #textdomain wesnoth-h2tt
        {ANIMATE_HARM id=Konrad 999 range=melee id=Asheviere EXPERIENCE=no}
        {SCREEN_FADER 100,0,0 255 0}
        {FIRE_EVENT epilogue}
    [/event]

    #------------------------
    # DELFADORE IS KILLER
    #------------------------
    [event]
        name=last breath
        {FILTER        id=Asheviere}
        {FILTER_SECOND id=Delfador}
        #textdomain wesnoth-h2tt
        [message]
            speaker=Delfador
            message=_"As I destroyed your son, I now destroy you."
        [/message]
        [message]
            speaker=Asheviere {ASHEVIERE_VARIATION defeated}
            message=_"You were always defiant, wizard, and no one has thwarted my plans as determinedly as you."
        [/message]
        [message]
            speaker=Delfador
            message=_"I have always been a humble servant of the Crown, and remain such even now."
        [/message]
        [message]
            speaker=Asheviere {ASHEVIERE_VARIATION defeated}
            message=_"Delfador! You utterly disgust me, you sniveling worm. How dare you confront me, your queen?"
        [/message]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mad}
            message=_"How dare I? I, High Provost of the Council of Archmagi...

... bearer of the staff of An-Usrukhar, guardian of the book of Crelanu ...

... Mage Protector of The Kingdom Of The Peoples Of The West-North, Chief Advisor to the Crown…

... and personal counselor to my King and my friend, Garard the Second, whom you most foully betrayed...

I am Delfador the Great and TODAY YOU MEET YOUR ATONEMENT!"
        [/message]
        #textdomain wesnoth-h2tt
        {DELAY 250}
        {SOUND lightning.ogg}
        [item]
            halo=halo/lightning-bolt-2-[1~4].png
            x,y=$unit.x,$($unit.y-2)
        [/item]
        {SCREEN_FADER 255,255,255 255 250}
        {FIRE_EVENT epilogue}
    [/event]

    #------------------------
    # GENERIC KILLER
    #------------------------
#define ELSEIF_KILLER ID MESSAGE
    {ELSEIF} {VARIABLE_CONDITIONAL second_unit.id equals {ID}} {THEN(
        [message]
            speaker={ID}
            message={MESSAGE}
        [/message]
    )} {/ELSEIF}
#enddef
    [event]
        name=last breath
        {FILTER id=Asheviere}
        {FILTER_SECOND({NOT id=Lisar,Konrad,Delfador})}

        [message]
            speaker=Asheviere {ASHEVIERE_VARIATION defeated}
            message=_"Treason! The evil ones have slain me!"
        [/message]
        {IF}
        [false][/false]
        {THEN()}
        {ELSEIF_KILLER Kalenz    _"For too long has your darkness troubled the world, Asheviere. Your time has come!"}
        {ELSEIF_KILLER Chantal   _"Vengeance for the fallen! Vengeance for Deoran!"}
        {ELSEIF_KILLER Moremirmu _"Dark queen, your evil ends this day. In the name of the Light, I purge you from this world!"}
        {ELSEIF_KILLER Harper    _"Here’s for Baldras! Here’s for Delwyn and Dallben!"}
        {ELSEIF_KILLER Ulfdain   _"Dinnae recognize me, do ye? You sent me to the gibbet, ye milksop, ye coward! Ah’ll cut that lubberworting head right off yer steamin’ corpse!"}
        {ELSEIF_KILLER Jeniver   _"Sorry about this! Oh, how did I get caught up in all this?"}
        {ELSEIF_KILLER Seimus    _"For Alduin! For my friends, my apprentices, and my home! Now burn!"}
        {ELSEIF_KILLER Dosh      _"Dis not personal, queen. But Dosh gonna squash you like frog."}
        {ELSE(
            [message]
                speaker=Asheviere {ASHEVIERE_VARIATION defeated}
                #po: "struck by some lowborn grunt" hints to the player that there's messages if Konrad/Lisar/Delfador get the kill
                message=_"Oh, such indignity to have the final blow struck by some lowborn grunt..."
            [/message]
        )} {/IF}
        {ANIMATE_HARM id=second_unit.id 999 range=melee id=Asheviere EXPERIENCE=no}
        {DELAY 500}

        [message]
            speaker=Delfador
            message=_"And so passes Asheviere, queen of Wesnoth."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message=_"We have won at last! Li’sar! You will be queen!"
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION glad}
            message=_"Yes, but I won’t ever forget what you have done for me, Konrad. And you, Delfador."
        [/message]
        {IF} {HAVE_UNIT id=Kalenz} {THEN(
            [message]
                speaker=Kalenz
                message=_"So much blood. So much death. For what? A title?"
            [/message]
            [message]
                speaker=Lisar
                message=_"For justice, Elf Lord. We fight because if we do not, evil would prevail. But, I implore you to let the dead have their rest. We have taken victory. Tomorrow is a new day, friends... let us build this kingdom anew."
            [/message]
        )} {ELSE(
            [message]
                speaker=Lisar
                message=_"We have taken victory. Tomorrow is a new day, friends... let us build this kingdom anew."
            [/message]
        )} {/IF}
        {FIRE_EVENT epilogue}
    [/event]

    #############################
    # EPILOGUE
    #############################
#define EPILOGUE_MESSAGE ID CONDITION MESSAGE
    {IF} {HAVE_UNIT id,search_recall_list={ID},yes} {CONDITION} {THEN(
        {STORE_UNIT_VAR id={ID} profile profile}
        [message]
            speaker=narrator
            image=none
            second_image=$profile
            second_mirror=yes
            message={MESSAGE}
        [/message]
        {CLEAR_VARIABLE portrait}
    )} {/IF}
#enddef
    [event]
        name=epilogue
        #------------------------
        # CHECK FOR ACHIEVEMENTS
        #------------------------
        [if]
            {HAVE_UNIT id,search_recall_list=Jotha,yes}
            [and]
                {VARIABLE_CONDITIONAL status_s10 equals completed}
                {OR({VARIABLE_CONDITIONAL status_s11 equals completed})}
            [/and]
            {VARIABLE_CONDITIONAL status_s26 not_equals completed}
            [then]
                {ACHIEVE s50a}
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL bm_turns less_than 6}
            [then]
                {ACHIEVE s50b}
            [/then]
        [/if]

        # this achievement requires you to use the whirlpool, so we bypass {ACHIEVE}'s bm_whirlpool_disable_achievements check
        [if]
            {VARIABLE_CONDITIONAL bm_turns greater_than 29}
            [then]
                [set_achievement]
                    content_for=heir_2_the_throne
                    id=h2tt_s50c
                [/set_achievement]
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL status_s02 not_equals completed}
            {VARIABLE_CONDITIONAL status_s03 not_equals completed}
            {VARIABLE_CONDITIONAL status_s04 not_equals completed}
            [then]
                {ACHIEVE s50d}
            [/then]
        [/if]

#ifdef NIGHTMARE
        [if]
            {VARIABLE_CONDITIONAL bm_weldyn_pillage not_equals yes}
            [then]
                {ACHIEVE s50e}
            [/then]
        [/if]
#endif

        #------------------------
        # TRANSITION TO EPILOGUE
        #------------------------
        {KILL id=Asheviere}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {REPLACE_SCENARIO_MUSIC journeys_end.ogg}
        {FADE_MUSIC_IN 100}
        {SCREEN_FADER 0,0,0 255 4000}
        {DELAY 1000}

        #------------------------
        # LISAR AND DELFADOR
        #------------------------
        [message]
            speaker=narrator
            message=_"And so the Dark Queen’s reign was ended."
        [/message]
        [message]
            speaker=narrator
            message=_"Li’sar, daughter of Garard II and Heir to the Throne of Wesnoth, was crowned Queen and Bearer of the Sceptre of Fire, which she would pass on to all her successors. Her reign was long, and she undid much of the evil deeds of her mother."
        [/message]
        {EPILOGUE_MESSAGE Delfador  () _"Delfador became Li’sar’s High Counselor, advising her in the most important matters of state. He lived until a ripe old age and was granted a royal funeral, after which he was buried in the Royal Crypt in Weldyn."}

        #------------------------
        # COMPANION EPILOGUES
        #------------------------
        {EPILOGUE_MESSAGE Chantal   ({NOT({HAVE_UNIT id=Kalenz} )}) _"Chantal ventured into the palace dungeons, where she found her great-grandfather Kalenz among many other prisoners. Togther they returned to their home in the north and never again came to the lands of men."}
        {EPILOGUE_MESSAGE Kalenz    (     {HAVE_UNIT id=Chantal}  ) _"Kalenz and Chantal returned to their homes in the north, and never again came to the lands of men."}
        {EPILOGUE_MESSAGE Kalenz    ({NOT({HAVE_UNIT id=Chantal})}) _"Kalenz returned to his home in the north and never again came to the lands of men."}
        {EPILOGUE_MESSAGE Moremirmu () _"Moremirmu lived the rest of his days as a wandering warrior, bringing light and hope wherever he went. When at last he fell, he was buried with honors and laid to rest among the other heroes of his order."}
        {EPILOGUE_MESSAGE Harper    () _"Harper returned to the Three Sisters, where she led her people back to the mainland, to reclaim their ruined hometowns. Delwyn and Dallben were rebuilt, and prospered."}
        {EPILOGUE_MESSAGE Ulfdain   () _"With Konrad’s blessing, Ulfdain rallied a company of soldiers — dwarves and men both — and set out to fight for Knalga. They were never heard from again."}
        {EPILOGUE_MESSAGE Jeniver   () _"Jeniver swallowed her pride and traveled to Alduin. At Delfador’s insistence she was awarded a professorship, and would go on to contribute greatly to the advancement of alchemy and the training of young minds."}
        {EPILOGUE_MESSAGE Seimus    () _"Seimus returned to Alduin, where he was hailed as a hero by many (and reviled by a few). He presided over the academy for many years, where he was often visited by his friend Delfador."}
        {EPILOGUE_MESSAGE Dosh      () _"Dosh returned to the north, where stories of his battle-feats and exceptional intelligence (for a troll) made him a figure of some renown. In time he accrued enough followers to start his own clan, which he ruled wisely as chief."}
        {EPILOGUE_MESSAGE Merle     () _"Konrad kept his promise to Merle, channeling gold and attention towards the Dulatus hills. That place became known as a home of great craftsmen."}
        {EPILOGUE_MESSAGE Jotha     () _"Jotha eventually returned to his home in the north, this time alongside many other merfolk. The Bay of Jotha (so it came to be called) would grow into a prosperous settlement; a rare jewel of civilization in the northern wildlands."}

        #------------------------
        # KONRAD'S EPILOGUE
        #------------------------
        [if]
            {VARIABLE_CONDITIONAL bm_turns equals $bm_milestone_finale}
            [then]
                [message]
                    speaker=narrator
                    image=none
                    second_image=portraits/humans/peasant.webp
                    second_mirror=yes
                    message=_"The prisoners Asheviere had threatened were found and freed, none the worse for their ordeal. Most returned to their homes, singing the new Queen’s praises."
                [/message]
            [/then]
        [/if]
        [message]
            speaker=narrator
            message=_"The bones of the infant Prince Konrad were retrieved from the elves and buried in the Royal Crypt in Weldyn, which our Konrad visited to pay homage every week."
        [/message]
        {EPILOGUE_MESSAGE Konrad () _"And as for our Konrad himself... the foundling prince became a noble in Li’sar’s court."}
        {IF} {VARIABLE_CONDITIONAL bm_weldyn_pillage equals yes} {THEN(
            [message]
                speaker=narrator
                second_image=portraits/konrad-$konrad_portrait_base|.webp
                image=portraits/lisar-glad.webp
                second_mirror=yes
                message=_"The prince and the queen’s mutual respect grew into friendship, trust, and eventually something more. They were married, and together they had two sons and a daughter."
            [/message]
            [message]
                speaker=narrator
                message=_"They ruled wisely, but some wounds are slow to heal. The croplands surrounding Weldyn would never entirely recover from their razing. The people there grew hard and bitter; that land spawned many outlaws."
            [/message]
            [message]
                speaker=narrator
                message=_"But such was the cost of victory, wasn’t it?"
            [/message]
        )} {ELSE(
            [message]
                speaker=narrator
                second_image=portraits/konrad-$konrad_portrait_base|-glad.webp
                image=portraits/lisar-glad.webp
                second_mirror=yes
                message=_"The prince and the queen’s mutual respect grew into friendship, trust, and eventually something more. They were married, and together they had two sons and a daughter. The kingdom once more prospered under their rule."
            [/message]
            [message]
                speaker=narrator
                message=_"All was well."
            [/message]
        )} {/IF}
        [endlevel]
            carryover_report=no
            linger_mode=no
        [/endlevel]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef TOD_OFFSET
#undef SIDE6_SIMPLE_RETREAT
#undef REINFORCEMENT_AI
#undef WELDYN_MOAT_SLF
#undef WELDYN_SECTOR_AVOID
#undef DEFINE_REINFORCEMENT
#undef ELSEIF_KILLER
