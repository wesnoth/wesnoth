#textdomain wesnoth-h2tt

#define SCENARIO_TURN_LIMIT
35#enddef

[scenario]
    name=_"scenario name^The Swamp of Dread"
    id=32_The_Swamp_of_Dread
    map_file=32_The_Swamp_of_Dread.map # don't use a dynamic map here, since the player wasn't expecting to fight here and has little say in what season they'll arrive at
    next_scenario=00_The_Great_Continent
    victory_when_enemies_defeated=no
    {SCHEDULE_DYNAMIC_NIGHT OFFSET=-6}
    turns={SCENARIO_TURN_LIMIT}
    {SCENARIO_MUSIC heroes_rite.ogg}
    {ADD_WEATHER_SNOW}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE GOLD=35 FOG=yes SHROUD=yes}

    #############################
    # UNDEAD
    #############################
    [side]
        side=2
        controller=ai
        color=white
        type=Death Squire
        id=leader2
        facing=nw
        gold,income={ON_DIFFICULTY4 15 30 45 60},{ON_DIFFICULTY4 -2 0 2 4} # 2 village, ~2 upkeep
        recruit=Walking Corpse
        team_name=undead
        user_team_name=_"Undead"
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 3}
    {STARTING_VILLAGES 2 8}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Soulless" {ON_DIFFICULTY4 0 1 2 2}}
    {RECRUIT_UNIT_VARIATIONS 2 "Walking Corpse" none,none,saurian,saurian,horse}
    {RECRUIT_UNIT_VARIATIONS 2 "Soulless"       none,none,saurian,saurian,horse}

    [side]
        side=3
        controller=ai
        color=white
        type,id,name,facing=Lich,Iliah-Malal,"",nw # no name initially, or else he'll show up as that in the status panel
        gold,income={ON_DIFFICULTY4 50 100 150 200},{ON_DIFFICULTY4 2 8 14 20} # 2 village, ~2 upkeep
        recruit=Walking Corpse
        team_name=undead
        user_team_name=_"Undead"
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 2}
    {STARTING_VILLAGES 3 8}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Soulless" {ON_DIFFICULTY4 1 2 3 4}}
    {RECRUIT_UNIT_VARIATIONS 3 "Walking Corpse" none,none,saurian,saurian,horse}
    {RECRUIT_UNIT_VARIATIONS 3 "Soulless"       none,none,saurian,saurian,horse}

    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3 offensive 0.99 0.01}
        {AUTOENRAGE 2 0}
        {AUTOENRAGE 3 0}

        {RETREAT_WHEN_WEAK 3 {ON_DIFFICULTY4 0-5 0-7 0-8 0-9} (
            {GOAL_LOCATION 3 x,y=36,22}
            {GOAL_LOCATION 2 x,y=33,21}
            {GOAL_LOCATION 1 x,y=39,19}
            {GOAL_LOCATION 1 x,y=40,17}
            {GOAL_LOCATION 1 x,y=33,24}
            {GOAL_LOCATION 1 x,y=38,22}
            {GOAL_LOCATION 0.1 x,y,radius=37,22,1}
        )}
        {MODIFY_SIDE_AI 2 ({GOAL_SEEK_SIDE 2 1 0})} # southwest leader prefers attacking Konrad
        {MODIFY_SIDE_AI 2,3 (
            [avoid]
                x,y=11,18
                radius=1 # avoid this little passageway in the mountain
            [/avoid]
        )}
    [/event]

    # undead guard side, to avoid affecting upkeep, LIMIT_CONTEMPORANEOUS_RECRUITS, and RETREAT_WHEN_WEAK
    [side]
        side=4
        controller=ai
        color=white
        no_leader=yes
        hidden=yes
        team_name=undead
    [/side]

    # beasts
    [side]
        side=5
        controller=ai
        color=brown
        no_leader=yes
        hidden=yes
        team_name=beasts
    [/side]

    # prisoner lisar
    [side]
        side=6
        controller=ai
        color=wesred
        no_leader=yes
        hidden=yes
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        team_name=wesnoth
    [/side]

    #############################
    # LISAR
    #############################
#wmlindent: start ignoring
    {LISAR_SIDE 7
        TEAM=wesnoth
        COLOR=lisarcolor
        GOLD={ON_DIFFICULTY4 50 75 100 125}
        INCOME={ON_DIFFICULTY4 13 15 17 18} # 2 villages, and probably >>4 upkeep
        FOG=yes SHROUD=yes
        (RECRUIT=Elite Fencer)
    }
#wmlindent: stop ignoring
    {SILENTLY_LIMIT_LEADER_MOVES $lisar_side 1}
    {STARTING_VILLAGES $lisar_side 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS $lisar_side "Elite Shock Trooper" {ON_DIFFICULTY4 1 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS $lisar_side "Elite Longbowman"    {ON_DIFFICULTY4 1 1 2 2}}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI $lisar_side defensive 0.2 0.6}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 2 3,4}
        {RETREAT_WHEN_WEAK $lisar_side {ON_DIFFICULTY4 0-4 0-5 0-6 0-6} (
            {GOAL_LOCATION 3 x,y=18,12}
            {GOAL_LOCATION 2 x,y=20,10}
            {GOAL_LOCATION 2 x,y=17,14}
            {GOAL_LOCATION 1 x,y=15,13}
        )}
        # stay away from the southwest undead leader; that one's there for Konrad to fight
        # also stay away from the northeast villages. Those are "secrets" for Konrad to find, not Li'sar
        {MODIFY_SIDE_AI $lisar_side (
            [avoid]
                x=0-99,  0-15
                y= 0-8, 20-99
            [/avoid]
        )}
    [/event]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {VARIABLE status_s32 in_progress}
        {PLACE_IMAGE items/dwarven-keep-tile.png 32  7}
        {PLACE_IMAGE items/dwarven-keep-tile.png 34 23}
        {PLACE_IMAGE items/dwarven-keep-tile.png 39 19}
        {PLACE_IMAGE "scenery/mine-abandoned.png~FL()" 39 3} # these mines are where Li'sar emerged from, and their locations are used in the event explaining this
        {PLACE_IMAGE "scenery/mine-abandoned.png"      37 4}

        #############################
        # BEASTS
        #############################
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Frost Stoat" "Frost Stoat" "Frost Stoat"    "Frost Stoat"   }) 8 10 ({ROLE beasts}{ZONE_GUARDIAN 8 10 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"        "Frost Stoat" "Frost Stoat"    "Frost Stoat"   }) 6 12 ({ROLE beasts}{ZONE_GUARDIAN 6 12 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"        "Frost Stoat" "Frost Stoat"    "Frost Stoat"   }) 8 10 ({ROLE beasts}{ZONE_GUARDIAN 8 10 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"        "none"        "none"           "Frost Stoat"   }) 8 10 ({ROLE beasts}{ZONE_GUARDIAN 8 10 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Icemonax"    "Icemonax"    "Great Icemonax" "Great Icemonax"}) 13 4 ({GUARDIAN}) }

        #############################
        # LISAR
        #############################
        {UNSTORE_NPC Lisar x,y=17,12 side,facing=7,se}
        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
            {MODIFY_UNIT id=Lisar side 6}
            {MODIFY_UNIT id=Lisar hitpoints 41}
            {MODIFY_UNIT id=Lisar status.slowed yes}
            {TELEPORT_UNIT id=Lisar 3 2}
            {MODIFY_UNIT id=Lisar facing se}
            [lift_fog]
                {FILTER_SIDE side=1}
                x,y=3,2
                radius=2
                multiturn=yes
            [/lift_fog]
            [item]
                x,y=3,2
                halo=items/horse-cage.png
            [/item]
            [event]
                name=new turn,side 6 turn end
                first_time_only=no
                {MODIFY_UNIT id=Lisar status.slowed yes}
                {MODIFY_UNIT id=Lisar resting no}
            [/event]

            {GENERIC_UNIT $lisar_side "Elite Master Bowman" 17 12} {FACING se} {LEADER} {ROLE leader7}
            {GIVE_OBJECT_TO role=leader7 ({EFFECT new_ability (
                [abilities]
                    {ABILITY_EXACTING}
                [/abilities]
            )} )}
        )} {/IF}

        #############################
        # LISAR GUARDS
        #############################
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "Elite Heavy Infantryman" "Elite Heavy Infantryman" "Elite Shock Trooper"     "Elite Shock Trooper"    }) 17 14 ({FACING se}{ZONE_GUARDIAN 17 14 x,y,radius=16,13,2})}
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "Elite Heavy Infantryman" "Elite Heavy Infantryman" "Elite Heavy Infantryman" "Elite Heavy Infantryman"}) 18 11 ({FACING se}{ZONE_GUARDIAN 18 11 x,y,radius=17,12,2})}
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "Elite Fencer"            "Elite Fencer"            "Elite Fencer"            "Elite Fencer"           }) 22 12 ({HITPOINTS 11})}
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "Elite Duelist"           "Elite Duelist"           "Elite Master at Arms"    "Elite Master at Arms"   }) 21 14 ({HITPOINTS 23})}
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "Elite Longbowman"        "Elite Longbowman"        "Elite Master Bowman"     "Elite Master Bowman"    }) 21 15 ()}
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "none"                    "Elite Iron Mauler"       "Elite Iron Mauler"       "Elite Iron Mauler"      }) 20 14 ({HITPOINTS 35})}
        {GENERIC_UNITC $lisar_side ({ON_DIFFICULTY4 "none"                    "Elite Bowman"            "Elite Bowman"            "Elite Longbowman"       }) 20 12 ()}

        #############################
        # UNDEAD ATTACKERS
        #############################
        # side 4 intead of 3 so that these guys all rush straight at Li'sar instead of grouping up defensively
        # it matters that we do this after Lisar guards, because some of them spawn at the exact same positions
        {REPEAT ({ON_DIFFICULTY4 2 3 4 4}) ({GENERIC_UNIT 4 "Soulless"       22 12}                   )}
        {REPEAT ({ON_DIFFICULTY4 3 4 5 5}) ({GENERIC_UNIT 4 "Walking Corpse" 21 15}{VARIATION saurian})}
        {REPEAT ({ON_DIFFICULTY4 1 2 3 3}) ({GENERIC_UNIT 4 "Walking Corpse" 21 10}                   )}

        {REPEAT ({ON_DIFFICULTY4 1 2 3 4}) ({GENERIC_UNIT 4 "Walking Corpse" 25 12}                   )}
        {REPEAT ({ON_DIFFICULTY4 0 1 2 3}) ({GENERIC_UNIT 4 "Soulless"       22 16}{VARIATION saurian})}
        {REPEAT ({ON_DIFFICULTY4 1 2 3 4}) ({GENERIC_UNIT 4 "Walking Corpse" 17 15}{FACING ne}        )}

        # the "second wave" of undead; otherwise Li'sar spends a lot of time not fighting
        {REPEAT ({ON_DIFFICULTY4 2 4 6 8}) (
            {GENERIC_UNIT 4 "Walking Corpse" 36 17}
            {GENERIC_UNIT 4 "Walking Corpse" 36 17} {VARIATION saurian}
            {GENERIC_UNIT 4 "Soulless"       36 17}
        )}

        #############################
        # UNDEAD GUARDS
        #############################
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Soulless"})  6 25 ({FACING ne}{ZONE_GUARDIAN  6 25 x,y,radius=8,25,2}{VARIATION saurian})}

        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"}) 33 23 ({FACING nw}{ZONE_GUARDIAN 33 23 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Soulless"}) 34 22 ({FACING sw}{ZONE_GUARDIAN 34 22 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Soulless"       "Soulless"}) 34 23 ({FACING nw}{ZONE_GUARDIAN 34 23 x,y,radius=8,25,2})}

        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Walking Corpse" "Soulless"}) 39 18 ({FACING nw}{ZONE_GUARDIAN 39 18 x,y,radius=8,25,2})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Soulless"}) 28 19 ({FACING sw}{ZONE_GUARDIAN 28 19 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Soulless"       "Soulless"}) 40 18 ({FACING nw}{ZONE_GUARDIAN 40 18 x,y,radius=8,25,2})}

        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"}) 37 21 ({FACING nw}{ZONE_GUARDIAN 37 21 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Walking Corpse" "Soulless"}) 39 23 ({FACING sw}{ZONE_GUARDIAN 39 23 x,y,radius=8,25,2})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Soulless"       "Soulless"}) 40 21 ({FACING sw}{ZONE_GUARDIAN 40 21 x,y,radius=8,25,2}{VARIATION saurian})}

        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 4 1}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        {SCREEN_FADER 0,0,0 255 0}
        # recall AFTER fading out the screen
        {RECALL_XY Konrad   4 1} {MODIFY_UNIT id=Konrad   facing se}
        {RECALL_XY Delfador 5 2} {MODIFY_UNIT id=Delfador facing sw}
        {REDRAW}

        #############################
        # INITIAL NARRATION
        #############################
        [message]
            speaker=narrator
            message=_"<i>Konrad, Delfador, and their army wandered for days, lost in lonely corridors and abandoned tunnels under the trackless mountains. What few foodstuffs had been salvaged from the lava dwindled, then vanished entirely. For the first time Konrad saw signs of fatigue in the old wizard’s normally inscrutable face.</i>"
        [/message]
        [message]
            speaker=narrator
            message=_"<i>Finally, weakened and battered by their ordeal, the exhausted rebels emerged into an unknown valley...</i>"
        [/message]

        #############################
        # INITIAL DIALOGUE
        #############################
        {SCREEN_FADER 0,0,0 000 500}
        [change_theme]
        [/change_theme]
        {DELAY 500}
        [message]
            speaker=Delfador
            message=_"Oh, my old bones! Long has it been since I exerted myself so, especially on an empty stomach. We were most fortunate we have at last found our way to the surface."
        [/message]
        {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals lisar} {THEN(
            {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
                [message]
                    speaker=Delfador
                    message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. And with both Li’sar and the Sceptre in our hands!"
                [/message]
            )} {ELSE(
                [message]
                    speaker=Delfador
                    message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. And although Li’sar has escaped us, at least we still have the Sceptre in our hands."
                [/message]
            )} {/IF}
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals sceptre} {THEN(
            [message]
                speaker=Delfador
                message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. And we have the Sceptre as well! Despite our difficulties, our quest has been a success."
            [/message]
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
            [message]
                speaker=Delfador
                message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. If only we had the Sceptre with us... it is surely now buried beyond all hope of reclamation."
            [/message]
        )} {/IF}
        [message]
            speaker=Konrad
            message=_"Yes, but look! We are not the only army to have escaped the caves!"
        [/message]

        #############################
        # INTRODUCE LI'SAR
        #############################
        {REVEAL x,y,radius=19,12,4 MULTITURN=yes}
        {REVEAL x,y,radius=20,13,4 MULTITURN=yes}
        {SCROLL_TO 19 12}
        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC battle-epic.ogg}
        {APPEND_MUSIC nunc_dimittis.ogg}
        {APPEND_MUSIC casualties_of_war.ogg}
        {FADE_MUSIC_IN 100}
        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
            [message]
                speaker=Lisar
                scroll=no {LISAR_VARIATION defeat}
                message=_"My expeditionary company! Or at least a small fragment of it, with a precious few survivors. And fighting many undead?!"
            [/message]
            [message]
                speaker=Lisar
                scroll=no {LISAR_VARIATION defeat}
                message=_"That’s a grim look, but even embattled they’re more than a match for your rebels, Konrad, weakened and gold-deprived as you are from your long days underground."
            [/message]
        )} {ELSE(
            [message]
                speaker=Lisar # default portrait, so that if she has her Sceptre it's shown in her portrait
                message=_"Keep moving. Don’t get pinned. I know this looks bad, but there is no choice but to fight! Fight, fight or die!"
            [/message]
            [message]
                speaker=Lisar
                message=_"Even if others have escaped the lava elsewhere, we’ve no chance of finding them unless we can first evade these undead!"
            [/message]
        )} {/IF}
        {DELAY 250}

        #############################
        # LI'SAR IS A PRISONER
        #############################
        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
            #------------------------
            # CAN KONRAD SURVIVE ALONE?
            #------------------------
            [message]
                speaker=Konrad
                message=_"I shouldn’t be surprised that some part of your army has survived, princess; you surely trained them well.

But from what I can see, they stand both outnumbered and surrounded. If we keep our distance the soldiers may not notice us, and will surely perish at the hands of the zombies!"
            [/message]
            [message]
                speaker=Konrad
                message=_"On the other hand... you are right that we ourselves are weakened from long days of hunger and travel, and these undead will only become stronger with the addition of the bodies of the royal soldiers — I see many fresh corpses among their numbers already."
            [/message]
            [message]
                speaker=Delfador
                message=_"I have seen firsthand the dangers of the spawn of Asheviere, Konrad, and I have learned the harm that comes from lending ear to their lies. This may be our only chance to vanquish these soldiers and still keep our prisoner! I think it best that we ensure their defeat first, and only afterwards give thought to our escape."
            [/message]

            #------------------------
            # KONRAD'S REBUTTAL
            #------------------------
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Maybe... but no food, no shelter, little gold..."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"I have no love for the villains who tried to take my life, but neither am I willing to doom my comrades just to spite them. That is how Asheviere fights; more invested in the death of enemies than the life of friends — or daughters. Did you yourself not tell me <i>“be forgiving, be wise, be kind”</i>?"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Unless all the living stand together against the dead, I fear things shall end badly for us all — and from her palace safe in Weldyn, Asheviere will laugh."
            [/message]
            [message]
                speaker=Konrad
                message=_"No. Li’sar, my cousin and prisoner, I offer you a trade. We shall make ourselves known to your army, and you will command them to ally with us against the undead. In return, once this place is cleansed, they will be free to leave."
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"Perhaps. And I would be free to leave along with them?"
            [/message]
            [message]
                speaker=Konrad
                message=_"This is not a negotiation. You are my prisoner and at my mercy, and I still mean to ransom you back to your mother in exchange for her abdication."
            [/message]
            [message]
                speaker=Konrad
                message=_"Do not be a fool; neither we nor your soldiers can preavil alone. And if we fall to the undead, you will surely perish with us. Choose: will you command your allies to aid us, or are we all to fight and bleed and die until our bodies cold are buried under crimson snow?"
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"..."
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"I’m not excited to join forces with the enemy, but neither do I want to watch my friends and comrades lose a hopeless battle on two fronts. I agree to your deal. I’ll remain prisoner while my soldiers fight as your allies."
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"But once these undead are finished, there will be no leaving peacefully. Prisoner or not, this battlefield still has loyalists ready to fight for their queen — and you and I have a score to settle."
            [/message]
        )}

        #############################
        # LI'SAR LEADS THE LOYALISTS
        #############################
        {ELSE(
            #------------------------
            # CAN KONRAD SURVIVE ALONE?
            #------------------------
            {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
                [message]
                    speaker=Konrad
                    message=_"So, the princess has survived — and she has the Sceptre of Fire! I shouldn’t be surprised; villains often seem hard to finish off, don’t they?

And what’s more, she is fighting a great horde of undead! If we keep our distance she may not notice us, and will surely perish at the hands of the zombies!"
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message=_"So, the princess has survived after all. I shouldn’t be surprised; villains often seem hard to finish off, don’t they?

And what’s more, she is fighting a great horde of undead! If we keep our distance she may not notice us, and will surely perish at the hands of the zombies!"
                [/message]
            )} {/IF}
            [message]
                speaker=Konrad
                message=_"On the other hand... we ourselves are weakened from long days of hunger and travel, and these undead will only become stronger with the addition of the bodies of Li’sar’s men — I see many fresh corpses among their numbers already."
            [/message]
            {IF} {VARIABLE_CONDITIONAL bm_s30_victory equals lisar} {THEN(
                [message]
                    speaker=Delfador
                    message=_"I have seen firsthand the dangers of the spawn of Asheviere, Konrad, and I have learned the value of swift action against them. Li’sar has already escaped us once! I think it best that we ensure her defeat first, and only afterwards give thought to our escape."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Delfador
                    message=_"I have seen firsthand the dangers of the spawn of Asheviere, Konrad, and I have learned the value of swift action against them. This may be our only chance to vanquish Li’sar! I think it best that we ensure her defeat first, and only afterwards give thought to our escape."
                [/message]
            )} {/IF}

            #------------------------
            # KONRAD'S REBUTTAL
            #------------------------
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Maybe... but no food, no shelter, little gold..."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"I have no love for the villain who tried to take my life, but neither am I willing to doom my comrades just to spite her. That is how Asheviere fights; more invested in the death of enemies than the life of friends — or daughters. Did you yourself not tell me <i>“be forgiving, be wise, be kind”</i>?"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Unless all the living stand together against the dead, I fear things shall end badly for us all — and from her palace safe in Weldyn, Asheviere will laugh. No, we should approach Li’sar and offer a brief alliance, at least until these undead are defeated."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Although she is our enemy, I believe that she is trustworthy enough to honor her word if she agrees not to harm us. I ask you to trust my judgement on this, my mentor."
            [/message]
            [message]
                speaker=Delfador
                message=_"The last time a king asked me to trust him, things ended rather badly for the both of us. Nevertheless, you are my lord, Konrad, and I know you to be growing wise beyond your years. Let us reach Li’sar and make your offer."
            [/message]
        )} {/IF}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Reach Li’sar’s loyalists before they are slain"
                condition=win
                [show_if]
                    {NOT({HAVE_UNIT( side=7 {IS_ALLY} )})}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Then, defeat the primary enemy leader"
                condition=win
                [show_if]
                    {NOT({HAVE_UNIT( side=7 {IS_ALLY} )})}
                [/show_if]
            [/objective]

            [objective]
                description= _ "Defeat the primary enemy leader"
                condition=win
                [show_if]
                    {HAVE_UNIT( side=7 {IS_ALLY} )}
                    {VARIABLE_CONDITIONAL malal_sighted not_equals yes}
                [/show_if]
            [/objective]

            [objective]
                description= _ "Defeat Iliah-Malal"
                condition=win
                [show_if]
                    {HAVE_UNIT( side=7 {IS_ALLY} )}
                    {VARIABLE_CONDITIONAL malal_sighted equals yes}
                [/show_if]
            [/objective]

            {OBJECTIVES_HERODEATHS}
            [objective]
                description= _ "Death of Li’sar"
                condition=lose
                [show_if]
                    {HAVE_UNIT id,side=Lisar,6}
                    {NOT({HAVE_UNIT( side=7 {IS_ALLY} )})} # the regular "Death of Konrad, Delfador, or Li'sar" objective triggers once Li'sar is our ally
                [/show_if]
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage=40
                bonus=yes
            [/gold_carryover]
            [note]
                #po: because of the low starting gold, companions (who're usually recalled for free) would be overly powerful here
                description= _ "Konrad’s forces are exhausted, and have less starting gold than usual. Loyal companions (except Delfador) are not automatically recalled."
            [/note]
        [/objectives]
    [/event]

    #############################
    # LISAR'S CAVE EXITS
    #############################
    [event]
        name=moveto
        [filter]
            side=1
            x=37,39
            y=4,3
        [/filter]
        [message]
            speaker=Konrad
            message=_"These must be the tunnels from whence Li’sar’s soldiers emerged. Out of all the countless exits from the underground, we just so happened to come together here..."
        [/message]
        [allow_undo]
        [/allow_undo]
    [/event]

    #############################
    # LISAR IS LOSING
    #############################
    [event]
        name=side $lisar_side turn
        {FILTER_CONDITION({HAVE_UNIT( id,formula=Lisar,"(self.hitpoints < self.max_hitpoints*3/4)" )})}
        {FILTER_CONDITION({NOT({HAVE_UNIT role=leader7})})}
        [message]
            speaker=Lisar
            message=_"We’re in dire straits. Deploy the reserves."
        [/message]
        {GENERIC_UNIT $lisar_side "Elite Duelist"    17 12} {ANIMATE}
        {GENERIC_UNIT $lisar_side "Elite Duelist"    17 12} {ANIMATE}
        {GENERIC_UNIT $lisar_side "Elite Longbowman" 17 12} {ANIMATE}
    [/event]
    [event]
        name=side $lisar_side turn
        {FILTER_CONDITION({HAVE_UNIT( role,formula=leader7,"(self.hitpoints < self.max_hitpoints*3/4)" )})}
        {FILTER_CONDITION({HAVE_UNIT role=leader7})}
        [message]
            role=leader7
            message=_"We’re in dire straits. Deploy the reserves."
        [/message]
        {GENERIC_UNIT $lisar_side "Elite Duelist"    17 12} {ANIMATE}
        {GENERIC_UNIT $lisar_side "Elite Duelist"    17 12} {ANIMATE}
        {GENERIC_UNIT $lisar_side "Elite Longbowman" 17 12} {ANIMATE}
    [/event]

    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=capture
        {FILTER side=1}
        {VARIABLE s32_failed_achievement yes}
    [/event]

    #######################################################################################################################################################
    #                                                                FIGHTING ALONGSIDE LI'SAR
    #######################################################################################################################################################
    #############################
    # ALLY WITH LI'SAR
    #############################
    [event]
        name=last breath
        {FILTER id=leader2}
        [message]
            speaker=unit
            message=_"..."
        [/message]
        [event]
            name=die
            {FIRE_EVENT ally_with_lisar}
        [/event]
    [/event]
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_ADJACENT side=7} )}
        [cancel_action]
        [/cancel_action]
        {FIRE_EVENT ally_with_lisar}
    [/event]
    [event]
        name=enter hex
        {FILTER( side=7 {FILTER_ADJACENT side=1} )}
        [cancel_action]
        [/cancel_action]
        {FIRE_EVENT ally_with_lisar}
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            # ensure this doesn't include hexes on the west side of the impassable mountain range
            [filter_location]
                x,y=99,99
                {OR x,y,radius=18,12,4}
                {OR x,y,radius=25,14,9}
                {OR x,y,radius=37,20,13}
            [/filter_location]
        [/filter]
        {FIRE_EVENT ally_with_lisar}
    [/event]
    [event]
        name=sighted
        {FILTER id=Iliah-Malal}
        {FILTER_SECOND side=1}
        {FIRE_EVENT ally_with_lisar}
        {DELAY 500}
    [/event]
    [event]
        name=ally_with_lisar

        #############################
        # LI'SAR IS A PRISONER
        #############################
        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
            #------------------------
            # DISCUSSING ALLIANCE
            #------------------------
            [message]
                role=leader7
                message=_"Living soldiers at the perimeter! It’s Konrad and his rebels, intact despite the volcano! And... they’ve taken the princess prisoner?!"
            [/message]
            [message]
                role=leader7
                message=_"I’d been hoping for reinforcements, for we are already hard-pressed, but if we must fight a second foe to rescue our general I shall not shy away!"
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"No, captain, that won’t be necessary. I am a prisoner, but we’ve agreed to a temporary truce — emphasis on temporary. Until these undead are defeated, you are to work together with Konrad against the dead."
            [/message]
            [message]
                role=leader7
                message=_"You’re certain? You’re not being coerced? Well, in the dire straits we’re in I can hardly say no to an ally."
            [/message]
            {SCROLL_TO 17 12}
            [modify_side]
                side=6
                team_name=konrad
            [/modify_side]
            [modify_side]
                side=7
                team_name=konrad
            [/modify_side]

            #------------------------
            # DELFADOR IS WORRIED
            #------------------------
            [event]
                name=side 1 turn end
                [message]
                    speaker=Delfador
                    message=_"Konrad, should we not be concerned about Li’sar’s threats? Prisoner or no, she has been very clear about her intentions to turn her allies against us once these undead are defeated. And perhaps sooner, if she senses in us some weakness!"
                [/message]
                [message]
                    speaker=Konrad
                    message=_"Li’sar is not Eldred. Although she is our enemy, I have come to believe Her Highness cares about her people just as we do, and that she is trustworthy enough to honor her word if she agrees not to harm us. I ask you to trust my judgement on this, my mentor."
                [/message]
                [message]
                    speaker=Delfador
                    message=_"The last time a king asked me to trust him, things ended rather badly for the both of us. Nevertheless, you are my lord, Konrad, and I know you to be growing wise beyond your years. Let us set aside my worries and direct our efforts against the undead."
                [/message]
            [/event]
        )}

        #############################
        # LI'SAR LEADS THE LOYALISTS
        #############################
        {ELSE(
            #------------------------
            # DISCUSSING ALLIANCE
            #------------------------
            [message]
                speaker=Lisar
                message=_"Living soldiers at the perimeter! ...Konrad, you’re here! And with your army too, intact despite the volcano. I intend to have serious words with the queen if we somehow get out of this alive..."
            [/message]
            [message]
                speaker=Konrad
                message=_"I am not here to fight you, Li’sar — at least not right now. You are vulnerable, but so are we, and if we war the only winner will be the undead. I propose a truce."
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION mad}
                message=_"A truce? What ploy is this; are you so cruel that you would give my men hope before snuffing it out? If you are come to slay me, fight me to my face!"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"There is no trick! Do not be a fool; surely you can see that if we do not stand together, we shall die alone? It is in both of our interests to work together!

Do you agree to my proposal, Your Highness? Or are we to fight and bleed and die until our bodies both are buried under crimson snow?"
            [/message]
            [message]
                speaker=Lisar
                message=_"..."
            [/message]
            [message]
                speaker=Lisar
                message=_"Very well, we shall work together for now. But do not forget that once these undead are defeated, you and I have a score to settle."
            [/message]
            [modify_side]
                side=7
                team_name=konrad
            [/modify_side]
        )} {/IF}

        #############################
        # OBJECTIVES
        #############################
        [show_objectives]
        [/show_objectives]

        #############################
        # DISCUSS ASHEVIERE
        #############################
        [event]
            name=new turn
            [event]
                name=new turn
                [event]
                    name=new turn
                    [event]
                        name=new turn
                        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
                            [message]
                                speaker=Konrad {KONRAD_VARIATION concerned}
                                message=_"My men and I are desperately low on gold and supplies, Li’sar. Now we have met with your allies —  do they have anything to spare?"
                            [/message]
                        )} {ELSE(
                            [message]
                                speaker=Konrad {KONRAD_VARIATION concerned}
                                message=_"My men and I are desperately low on gold and supplies, Li’sar. Now that we are allies, do you have anything to spare?"
                            [/message]
                        )} {/IF}
                        [message]
                            speaker=Lisar
                            message=_"We are allies only of convenience, cousin, and it is not in my best interest for you or your rebels to be too well-supplied."
                        [/message]
                        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
                            [message]
                                speaker=Lisar
                                message=_"... not that it matters, because I can see that my soldiers have barely enough to outfit themselves as it is. It’s unfortunate that the queen’s orders harmed us as much as they did you, if not more."
                            [/message]
                        )} {ELSE(
                            [message]
                                speaker=Lisar
                                message=_"... not that it matters, because we have barely enough to outfit ourselves as it is. It’s unfortunate that the queen’s orders harmed us as much as they did you, if not more."
                            [/message]
                        )} {/IF}
                        [message]
                            speaker=Konrad
                            message=_"It’s not “unfortunate” — your mother was more than willing to see you killed."
                        [/message]
                        [message]
                            speaker=Lisar
                            message=_"Asheviere gave Mirya the orders she thought were necessary to prevent you from escaping. Whether they were wise orders or not is immaterial; she acted to ensure that Wesnoth survives, even if I don’t. I cannot fault her for that."
                        [/message]
                        [message]
                            speaker=Konrad
                            message=_"She acted to ensure her power remains unchallenged, you mean. The dark queen cares only for herself."
                        [/message]
                        {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
                            [message]
                                speaker=Lisar
                                message=_"“<i>The dark queen</i>,” pfft. I’ve heard enough slander; hold your tongue or I shall have my men make an end to our truce and short work of you."
                            [/message]
                        )} {ELSE(
                            [message]
                                speaker=Lisar
                                message=_"“<i>The dark queen</i>,” pfft. I’ve heard enough slander; hold your tongue or I shall make an end to our truce and short work of you."
                            [/message]
                        )} {/IF}

                        #############################
                        # EXPLAIN TIME OF DAY
                        #############################
                        #                         [event]
                        #                             name=new turn
                        #                             first_time_only=no
                        #                             [store_time_of_day]
                        #                             [/store_time_of_day]
                        #                         [/event]
                        #                         [event]
                        #                             name=new turn
                        #                             [filter_condition]
                        #                                      {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
                        #                                 {OR( {VARIABLE_CONDITIONAL time_of_day.id equals midnight   } )}
                        #                             [/filter_condition]
                        #                             [message]
                        #                                 speaker=Lisar
                        #                                 message=_"My soldiers fight poorly in the dark, Konrad. Don’t expect aggression until daytime."
                        #                             [/message]
                        #                         [/event]
                        #                         [event]
                        #                             name=victory
                        #                             {CLEAR_VARIABLE time_of_day}
                        #                         [/event]
                    [/event]
                [/event]
            [/event]
        [/event]
    [/event]

    #############################
    # FLAVOR DIALOGUE
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_ADJACENT id,side=Lisar,7} )}
        [message]
            speaker=Lisar
            message=_"Don’t wander around my keep, Konrad. We have a battle to fight."
        [/message]
    [/event]

    #############################
    # VOICLINES FOR FIGHTING ILIAH-MALAL
    #############################
    [event]
        name=attack
        {FILTER id=Delfador,Iliah-Malal}
        {FILTER_SECOND id=Delfador,Iliah-Malal}
        [message]
            speaker=Delfador {DELFADOR_VARIATION mad}
            message=_"You have no tricks this time, Malal? Your magic is as weak as was your flesh!"
        [/message]
        [message]
            speaker=Iliah-Malal
            #po: the same thing he says when fighting Delfador in The Deceiver's Gambait
            message=_"Shadows consume you!"
        [/message]
    [/event]
    [event]
        name=attack
        {FILTER id=Konrad,Iliah-Malal}
        {FILTER_SECOND id=Konrad,Iliah-Malal}
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Delfador killed you once! Now it’s my turn!"
        [/message]
    [/event]
    [event]
        name=attack
        {FILTER side=7}
        {FILTER_SECOND id=Iliah-Malal}
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"Time to put you and your lies back in the ground!"
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                     MEET ILIAH-MALAL
    #######################################################################################################################################################
    [event]
        name=sighted
        {FILTER id=Iliah-Malal}
        {FILTER_SECOND side=1,$lisar_side}

        #############################
        # INTRODUCE MALAL
        #############################
        [message]
            speaker=Iliah-Malal
            caption=""
            message="<span size='small'>" + _"Eye of elf and bone of beast..." + "</span>"
        [/message]
        [message]
            speaker=Delfador
            scroll=no
            message=_"A lich! So here is the source of the undead. Something about this magic feels familiar... very familiar..."
        [/message]
        [message]
            speaker=Iliah-Malal
            caption=""
            message=_"Hello, Delfador! Do you remember me? You’ve grown old. Perhaps you regret passing up the temptations of necromancy, so long ago?"
        [/message]
        [message]
            speaker=Delfador {DELFADOR_VARIATION mad}
            message=_"Iliah-Malal! A name most foul, and one that I have not spoken aloud since our duel so many years ago. You’ll recall that I won. You should be dead and gone."
        [/message]
        {MODIFY_UNIT id=Iliah-Malal name _"Iliah-Malal"}
        [message]
            speaker=Iliah-Malal
            message=_"Dead, yes, but not quite gone. You have the good queen to thank for my return. And I have you to thank for finding the Sceptre of Fire! Soon it will be mine."
        [/message]
        {DELAY 500}
        [message]
            speaker=Lisar
            message=_"I know my own mother, lich, and she would never be complicit in the resurrection of an abomination like yourself."
        [/message]

        #############################
        # HELPER MACRO
        #############################
#define SPEECH_MULTIPART SNUM MESSAGE1A MESSAGE1B MESSAGE2
#arg SPEAKER
Konrad#endarg
    {VARIABLE message1a {MESSAGE1A}}
    {VARIABLE message1b {MESSAGE1B}}
    {VARIABLE message2  {MESSAGE2}}
    {IF}
    {VARIABLE_CONDITIONAL status_{SNUM} equals completed}
    {HAVE_UNIT id={SPEAKER}}
    {THEN(
        {IF}
        {VARIABLE_CONDITIONAL first_part_spoken not_equals yes}
        [then]
            {IF} {VARIABLE_CONDITIONAL message1a not_equals ""} {THEN(
                [message]
                    speaker={SPEAKER}
                    message={MESSAGE1A}
                [/message]
                {VARIABLE first_part_spoken yes}
            )} {/IF}
            {IF} {VARIABLE_CONDITIONAL message1b not_equals ""} {THEN(
                [message]
                    speaker=Lisar
                    message={MESSAGE1B}
                [/message]
                {VARIABLE first_part_spoken yes}
            )} {/IF}
        [/then]
        {ELSEIF}
        {VARIABLE_CONDITIONAL second_part_spoken not_equals yes}
        {VARIABLE_CONDITIONAL message2 not_equals ""}
        {THEN(
            [message]
                speaker={SPEAKER}
                message={MESSAGE2}
            [/message]
            {VARIABLE second_part_spoken yes}
        )} {/ELSEIF}
        {/IF}
    )} {/IF}
    {CLEAR_VARIABLE message1a,message1b,message2}
#enddef

        #############################
        # CUSTOM KONRAD MESSAGE
        #############################
        # take one segment of each SPEECH_MULTIPART to generate a 3-message interaction between Konrad and Li'sar, based on which scenarios the player chose
        # for example:
        #   K: You cannot deny, cousin, that Asheviere passed control of Elensefar to the orcish hordes when she found she could not bend the popluace to her will. It is only with my aid that the entire city was not enslaved!
        #   L: —no, I was told that the city was under the control of royal forces; the orcs were only supposed to aid in the attack. You can’t be right.
        #   K: Or what of how Asheviere allowed a necromancer to run amuck on the Peninsula of Pearls, to weaken and create chaos in the west? Without my intervention the entire coast might have been overrun!

        # Delwyn and Dallben
        # it's ok to leave the follow-up blank here on s08b, because since it's the FIRST speech in the list the follow-up will never get said
        {IF} {HAVE_UNIT id=Harper} {THEN(
            {SPEECH_MULTIPART s08a
            (_"You can’t deny, Li’sar, that th’ queen o’ yours was ready to massacre us smallfolk in Delwyn an’ Dallben jus’ because we refused to swear fealty. An’ she would’ve succeeded too, if we hadn’t fought back an’ fled an’ hid!")
            (_"—no, that can’t be right. I was told that region had always been home to rebels, and that after the destruction of Halstead Mother was regrettably forced to raze the villages.")
            ()
            SPEAKER=Harper
            }
        )} {ELSE(
            {SPEECH_MULTIPART s08a
            (_"You cannot deny, cousin, that Asheviere was ready to massacre the smallfolk in Delwyn and Dallben just because they refused to swear fealty. They told me the story: had they not fought back and fled and hid, they would all be dead now.")
            (_"—no, that can’t be right. I was told that region had always been home to rebels, and that after the destruction of Halstead Mother was regrettably forced to raze the villages.")
            ()
            }
        )} {/IF}

        # Elensefar
        {SPEECH_MULTIPART s11
        (_"You cannot deny, cousin, that Asheviere passed control of Elensefar to the orcish hordes when she found she could not bend the populace to her will. I was there — it is only by my sword that the entire city was not enslaved!")
        (_"—no, that can’t be right. I was told that the city was under the control of royal forces; the orcs were only supposed to aid in the attack.")
        (_"Or what of how Asheviere gave control of Elensefar to the orcish hordes when she found she could not bend the populace to her will? Without my intervention the entire city would have been enslaved!")
        }

        # Muff Malal's Peninsula
        {SPEECH_MULTIPART s07
        (_"You cannot deny, cousin, that Asheviere allowed a necromancer to run amuck on the Peninsula of Pearls, to weaken and create chaos in the west. I was there — it is only by my sword that Muff Malal was killed!")
        (_"—no, that can’t be right. I was told that you rebels were the ones who invited the necromancer in, and that royal forces were beaten back when they came to render aid.")
        (_"Or what of how Asheviere allowed a necromancer to run amuck on the Peninsula of Pearls, to weaken and create chaos in the west? Without my intervention the entire coast might have been overrun!")
        }

        # Bay of Pearls
        {SPEECH_MULTIPART s04
        (_"You cannot deny, cousin, that Asheviere allowed her orcs to overrun the Bay of Pearls, to enslave the peaceful merfolk and force them to dive for her enrichment. I was there — it is only by my sword that they were freed!")
        (_"—no, that can’t be right. I was told the orcs were protecting the merfolk against the rebels, not holding them as slaves.")
        (_"Or what of how Asheviere allowed her orcs to overrun the Bay of Pearls, to enslave the peaceful merfolk and force them to dive for her enrichment? Without my intervention they might never have been freed!")
        }

        # Crossroads
        {IF} {HAVE_UNIT id=Ulfdain} {THEN(
            {SPEECH_MULTIPART s17
            (_"Li’sar, what about how yer gnashgabbin’ Asheviere locked me up jus’ fer a couple o’ insults — an’ high-quality ones too, proper fit fer a queen! Ye even helped keep me an’ my boys from escapin’!")
            (_"—no, that can’t be right. I was told you dwarves were sentenced for sedition and murder, not mere vulgarity.")
            (_"Ach, an’ what about how yer gnashgabbin’ Asheviere locked me up jus’ fer a couple o’ insults — an’ high-quality ones too, proper fit fer a queen! Ye even helped keep me an’ my boys from escapin’!")
            SPEAKER=Ulfdain
            }
        )} {ELSE(
            {SPEECH_MULTIPART s17
            (_"You cannot deny, cousin, that Asheviere locked up Ulfdain and his miners for no crime but daring to criticise her! You even tried to stop me from freeing them!")
            (_"—no, that can’t be right. I was told those dwarves were sentenced for sedition and murder, not mere vulgarity.")
            (_"Or what of how Asheviere locked up Ulfdain and his miners for no crime but daring to criticise her! You even tried to stop me from intervening to free them!")
            }
        )} {/IF}

        # Flight of the Elves
        {IF} {HAVE_UNIT id=Kalenz} {THEN(
            {SPEECH_MULTIPART s02
            (_"You can scarcely deny, Li’sar, that after my peoples’ defeat at the Aethenwood, Asheviere sent her armies to take our fleeing civilians as slaves. It is only thanks to Konrad they escaped!")
            (_"—no, that can’t be right. Your Aethenwood elves are dangerous, hardly civilians, but you were all to be afforded a fair trial and a just verdict, not taken as slaves.")
            (_"Or what of how after the elves’ defeat at the Aethenwood, Asheviere sent her armies to take our fleeing civilians as slaves? Without Konrad’s intervention they would be in chains in the mines!")
            SPEAKER=Kalenz
            }
        )} {ELSE(
            {SPEECH_MULTIPART s02
            (_"You cannot deny, cousin, that after the elves’ defeat at the Aethenwood, Asheviere sent her armies to take the fleeing civilians as slaves. I was there — it is only by my sword that they escaped!")
            (_"—no, that can’t be right. The Aethenwood elves are dangerous, hardly civilians, but they were to be afforded a fair trial and a just verdict, not taken as slaves.")
            (_"Or what of how after the elves’ defeat at the Aethenwood, Asheviere sent her armies to take the fleeing civilians as slaves? Without my intervention they would be in chains in the mines!")
            }
        )} {/IF}

        # Gryphon Mountain
        {IF} {VARIABLE_CONDITIONAL bm_s14_fought_burlin equals yes} {THEN(
            {SPEECH_MULTIPART s14
            (_"You cannot deny, cousin, that Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs! I was there — it is only by my sword that Gryphon Mountain was not entirely ruined!")
            (_"—no, that can’t be right. I was told we’d decided against the egg expedition, because of the intelligence of gryphons and the risks to their population.")
            (_"Or what of how Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs? Without my intervention Gryphon Mountain might have been entirely ruined!")
            }
        )} {ELSE(
            {SPEECH_MULTIPART s14
            (_"You cannot deny, cousin, that Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs! I may have benefitted from the act, but that does not change Asheviere’s decision to do it.")
            (_"—no, that can’t be right. I was told we’d decided against the egg expedition, because of the intelligence of gryphons and the risks to their population.")
            (_"Or what of how Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs? I may have benefitted from the act, but that does not change Asheviere’s decision to do it.")
            }
        )} {/IF}

        # Valley of Death
        {IF} {HAVE_UNIT id=Moremirmu} {THEN(
            {SPEECH_MULTIPART s15b
            (_"You can scarcely deny, Li’sar, that the dark queen deliberately withheld aid from my home, leaving many of our number to die at the hands of undead. It is only thanks to Konrad that our seal was restord and calamity averted!")
            (_"—no, that can’t be right. You and your order are doing important work; it should be the crown’s responsibility to keep you provisioned.")
            (_"Lo! Or what of how Asheviere deliberately withheld aid from my home, leaving many of our number to die at the hands of undead? Without Konrad’s intervention our seal would never have been restored!")
            SPEAKER=Moremirmu
            }
        )} {ELSE(
            {SPEECH_MULTIPART s15b
            (_"You cannot deny, cousin, that Asheviere deliberately withheld aid from the Gryphon Mountain monastery, leaving many of their number to die at the hands of undead. It is only by my sword that their seal was restord and calamity averted!")
            (_"—no, that can’t be right. The monastic mages are doing important work; it should be the crown’s responsibility to keep them provisioned.")
            (_"Or what of how Asheviere deliberately withheld aid from the Gryphon Mountain monastery, leaving many of their number to die at the hands of undead? Without my intervention their seal would never have been restored!")
            }
        )} {/IF}

        # Fallback: The Elves Besieged
        {IF} {HAVE_UNIT id=Kalenz} {THEN(
            {SPEECH_MULTIPART s01
            (_"You can scarcely deny, Li’sar, that Asheviere’s quarrel with the Aethenwood was more than just a quest to capture Konrad and Delfador. Asheviere has a lust for control, and anyone who resists must be destroyed.")
            ()
            (_"Or what of Asheviere’s attack on the Aethenwood? This was more than just a quest to capture Konrad and Delfador. Asheviere has a lust for control, and anyone who resists must be destroyed.")
            SPEAKER=Kalenz
            }
        )} {ELSE(
            {SPEECH_MULTIPART s01
            (_"You cannot deny, cousin, that Asheviere’s quarrel with the Aethenwood was more than just a quest to capture me and Delfador. Asheviere has a lust for control, and anyone who resists must be destroyed.")
            ()
            (_"Or what of Asheviere’s attack on the Aethenwood? This was more than just a quest to capture me and Delfador. Asheviere has a lust for control, and anyone who resists must be destroyed.")
            }
        )} {/IF}

        {CLEAR_VARIABLE first_part_spoken,second_part_spoken}
        {VARIABLE malal_sighted yes}
        [show_objectives]
        [/show_objectives]
    [/event]

    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # ILIAH MALAL DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Iliah-Malal}
        {FADE_MUSIC_OUT 250}
        {REPLACE_SCENARIO_MUSIC heroes_rite.ogg}
        {FADE_MUSIC_IN 50}
        {IF} {VARIABLE_CONDITIONAL s32_failed_achievement not_equals yes} {THEN({ACHIEVE s32})} {/IF}
        {CLEAR_VARIABLE s32_failed_achievement}

        #------------------------
        # MALAL'S LAST BREATH
        #------------------------
        [message]
            speaker=Iliah-Malal
            message=_"I feel... nothing."
        [/message]
        {IF} {HAVE_UNIT( count=3-99 {AND side=2,3,4} )} {THEN(
            #textdomain wesnoth-httt
            [message]
                speaker=narrator
                image=wesnoth-icon.png
                message= _ "A final blow destroys the lich, releasing a small shock wave of energy outwards. His minions fall like puppets with their strings cut. A cloud of dust billows out as the remnants of the lich’s once-mortal body disintegrate for the last time."
            [/message]
        )} {ELSE(
            [message]
                speaker=narrator
                image=wesnoth-icon.png
                message= _ "A final blow destroys the lich, releasing a small shock wave of energy outwards. A giant cloud of dust billows out as the remnants of the lich’s once-mortal body disintegrate for the last time."
            [/message]
            #textdomain wesnoth-h2tt
        )} {/IF}

        [event]
            name=die
            {KILL_COUNT 5 ( side=2,3,4 {NOT id=$unit.id} ) ANIMATE=yes}
            {KILL side=2,3,4}

            #------------------------
            # ENDING THE TRUCE
            #------------------------
            {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
                [message]
                    speaker=Konrad
                    message=_"The lich is defeated, Li’sar, and our agreed-upon truce comes to an end. If your soldiers and I are to battle, know that even weakened from the caves they shall still find me a formidable foe."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message=_"The lich is defeated, Li’sar, and our agreed-upon truce comes to an end. If we are to battle, know that even weakened from the caves you shall still find me a formidable foe."
                [/message]
            )} {/IF}
            [message]
                speaker=Konrad
                message=_"But you heard my truths about Asheviere — and Malal’s. The dark queen has already harmed countless lives, and will bring all that we love to ruin if we do not stop her. If you are willing, I would welcome your aid in my fight to make Wesnoth a better place."
            [/message]
            [message]
                speaker=Lisar
                message=_"My mother has her flaws, but the crimes of which you’ve accused her... I spent my entire childhood listening to my mother give orders and commanding armies around. I’d always given her the benefit of the doubt."
            [/message]
            [message]
                speaker=Lisar
                message=_"But I cannot deny there have been signs. I became my mother’s most trusted aide-de-camp. I was sent to quiet the worst of the various rebellions. Of course they fought back. I was never told who most of these people were or why they fought my mother. Now the volcano, and now this lich..."
            [/message]
            [message]
                speaker=Lisar
                message=_"..."
            [/message]

            #------------------------
            # JOINING TOGETHER
            #------------------------
            {IF} {HAVE_UNIT id,type=Lisar,"Bound Princess"} {THEN(
                [message]
                    speaker=Lisar
                    message=_"Free me from these chains and I will join you, even if it means opposing my own flesh. Perhaps together we can save our country in a way that neither of us could alone."
                [/message]
                {TRANSFORM_UNIT id=Lisar Princess}
            )} {ELSE(
                [message]
                    speaker=Lisar
                    message=_"I will join you, even if it means opposing my own flesh. Perhaps together we can save our country in a way that neither of us could alone."
                [/message]
            )} {/IF}

            {CLEAR_VARIABLE malal_sighted}
            {KILL role=leader7} # so he doesn't get recalled in future scenarios, which would cause issues since he's a leader
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
    [/event]
    [event]
        name=victory
        {KILL( side=$lisar_side {NOT id=Lisar} )} # clear out Lisar's recall list, in case the player decides to take manual control next scenario
    [/event]

    #############################
    # PREVENT ATTACKING LISAR
    #############################
    # only trigger this event once; if the player really wants to fight we'll let them
    [event]
        name=pre attack
        {FILTER side=1}
        {FILTER_SECOND id=Lisar}
        [cancel_action]
        [/cancel_action]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"We’ve come this far together. There is no reason for me to execute an unarmed woman, enemy though she may be!"
        [/message]
    [/event]

    #############################
    # LISAR DIES
    #############################
    [event]
        name=prestart
        [remove_event]
            id=herodeath_Lisar
        [/remove_event]
    [/event]
    [event]
        name=last breath
        {FILTER side,canrecruit=7,yes} # either Li'sar OR her substitute leader
        {IF} {VARIABLE_CONDITIONAL unit.id equals "Lisar"} {THEN(
            [message]
                speaker=Lisar {LISAR_VARIATION defeat}
                message=_"I can’t believe it. Bested so far from home.... and in part by the actions of my own mother. Embarrassing..."
            [/message]
        )} {ELSE(
            [message]
                speaker=unit
                message=_"We are beaten! Bested so far from home.... and in part by the actions of the queen..."
            [/message]
        )} {/IF}
        [event]
            name=die
            {REPEAT 2 ({GENERIC_UNIT 4 "Soulless" 19 10} {ANIMATE})}
            {REPEAT 2 ({GENERIC_UNIT 4 "Soulless" 22 12} {ANIMATE})}
            {REPEAT 3 ({GENERIC_UNIT 4 "Soulless" 16 12} {ANIMATE})}
            {REPEAT 2 ({GENERIC_UNIT 4 "Soulless" 21 15} {ANIMATE})}
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Li’sar’s soldiers have fallen, and their camps have become infested with undead! I would rejoice, if we were not surely about to follow them into undeath..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]

    #############################
    # LISAR (PRISONER) DIES
    #############################
    [event]
        name=last breath
        {FILTER id,side=Lisar,6}
        [message]
            speaker=Lisar {LISAR_VARIATION defeat}
            message=_"Aaaaah! I can’t believe it should end like this..."
        [/message]
        [event]
            name=die
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Our prisoner has perished! She was an enemy, but I cannot shake the feeling that Her Highness yet had a role to play in all this..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=turn $({SCENARIO_TURN_LIMIT}-5)
        [message]
            speaker=Konrad
            message=_"Ugh... I am faint with hunger and exhausted from our long days underground. We must finish these undead before we become too weak to fight!"
        [/message]
    [/event]
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        [message]
            speaker=Konrad
            message=_"My heart... my head... our long ordeal has taken a toll on us all. I can barely stand, much less fight, and the army is no better. Even if Li’sar is still able to vanquish these undead without our aid, she will surely do the same to us now that we have become so frail!"
        [/message]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef SPEECH_MULTIPART
