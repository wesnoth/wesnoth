#textdomain wesnoth-h2tt

[scenario]
    name=_"scenario name^The Great Continent"
    {MAP_DYNAMIC 00_The_Great_Continent PRIORITY=5} # after we change the schedule, but before we run POI events that replace terrain
    victory_when_enemies_defeated=no
    {SCHEDULE_SEASONS} turns=-1
    {ADD_WEATHER_RAIN (RAIN_SOUND=)}
    {SCENARIO_MUSIC wanderer.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    # if we don't give -2 income, we start with 2 more gold than expected
    {KONRAD_SIDE GOLD=0 INCOME=-2 FOG=yes SHROUD=yes}

    #############################
    # ALLIES
    #############################
    [side] #----elves
        side=2
        controller=null
        color=brightgreen # forests=brightgreen
        hidden=yes
        no_leader=yes
        team_name=konrad
        {FLAG_VARIANT wood-elvish}
    [/side]
    [side] # ----kaylan/maddock
        side=3
        controller=null
        color=teal # same as Kaylan's color in the original HttT
        hidden=yes
        no_leader=yes
        team_name=konrad
        {FLAG_VARIANT loyalist}
    [/side]
    [side] #----merfolk/bandits
        side=4
        controller=null
        color=blue # matches their color in liberty
        hidden=yes
        no_leader=yes
        team_name=konrad
    [/side]
    [side] #----dwarves
        side=5
        controller=null
        color=brown # dirt=brown
        hidden=yes
        no_leader=yes
        team_name=konrad
        {FLAG_VARIANT knalgan}
    [/side]

    #############################
    # ENEMIES
    #############################
    [side] #----asheviere
        side=6
        controller=null
        color=wesred
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT loyalist}
    [/side]
    [side] #----foxtails
        side=7
        controller=null
        color=orange
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    [side] #----stoneskins (and Valley of Death undead) (and Rogue Mages before they join Konrad)
        side=8
        controller=null
        color=black
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    [side] #----whitefangs
        side=9
        controller=null
        color=white
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    [side] #----bloody swords
        side=10
        controller=null
        color=red
        hidden=yes
        no_leader=yes
    [/side]
    [side] #----undead
        side=11
        controller=null
        color=white
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT undead}
    [/side]
    [side] #----lisar
        side=12
        controller=null
        color=lisarcolor
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT loyalist}
    [/side]

    #----more allies:
    [side] #----gryphons
        side=13
        controller=null
        color=yellow
        hidden=yes
        no_leader=yes
        team_name=konrad
    [/side]
    [side] #----lisar (allied)
        side=14
        controller=null
        color=lisarcolor
        hidden=yes
        no_leader=yes
        team_name=konrad
        {FLAG_VARIANT loyalist}
    [/side]

    #----more enemies:
    [side] #----fell-hand clan
        side=15
        controller=null
        color=brown
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    [side] #----enemy saurians
        side=16
        controller=null
        color=brightgreen
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    [side] #----royal guard
        side=17
        controller=null
        color=purple
        hidden=yes
        no_leader=yes
        {FLAG_VARIANT6 ragged}
    [/side]

    # no units on this side, escept for fake_lisar. Only included so the player can see how much carryover gold Lisar has
    # fake_lisar is used so that when the player opens up the status table, they see Lisar's image and name
    {LISAR_SIDE 18 (GOLD=0) (INCOME=-2) (S43_BONUS_GOLD=0)}
    [event]
        name=prestart
        {NAMED_UNIT 18 $stored_Lisar.type 98 58 fake_lisar _"Li’sar" canrecruit=yes} {ROLE dummy_leader}
        {IF} {VARIABLE_CONDITIONAL status_s31 not_equals completed} {THEN(
            [modify_side]
                side=18
                hidden=yes
            [/modify_side]
        )} {/IF}

        # create dummy leaders for all sides, so we can capture villages even if there's no leader on the map
        {GENERIC_UNIT  2 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  3 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  4 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  5 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  6 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  7 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  8 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT  9 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 10 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 11 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 12 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 13 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 14 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 15 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 16 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        {GENERIC_UNIT 17 Spearman 98 58} {LEADER} {ROLE dummy_leader}
        [hide_unit]
            role=dummy_leader
        [/hide_unit]

        # kill these leaders at the end of the scenario, or else Li'sar's stays on her recall list
        [event]
            name=victory
            {KILL role=dummy_leader}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                 UNIVERSAL SETTINGS
    #######################################################################################################################################################
#define KONRAD_VISION
    7#enddef
#define KONRAD_MOVES
    80#enddef
    #############################
    # ZOOM
    #############################
    [event]
        name=prestart,preload
        first_time_only=no
        [zoom]
            factor=0.8
            relative=no
        [/zoom]
    [/event]
    [event]
        name=prestart
        priority=10 # before we change the map
        #############################
        # BM_TURNS AND SEASONS
        #############################
        # "bm_" stands for bigmap; generally used for variables that affect 00_The_Great_Continent
        [if] {VARIABLE_CONDITIONAL bm_turns greater_than 0}
            {THEN( {VARIABLE_OP bm_turns add 1} )}
            {ELSE( {VARIABLE bm_turns 1} )}
        [/if]

        [modify_turns]
            value=-1
            current=$bm_turns
        [/modify_turns]
        [store_time_of_day]
            variable=bm_tod
        [/store_time_of_day]

        #############################
        # CAMERA
        #############################
        [event]
            name=victory
            priority=-99
            [change_theme]
            [/change_theme]
            [zoom]
                factor=1
                relative=no
            [/zoom]
        [/event]

        [change_theme]
            theme=Bigmap$bm_turns
        [/change_theme]
        [event]
            name=theme # debug event
            first_time_only=no
            [change_theme]
            [/change_theme]
        [/event]

        #############################
        # MOVEMENT
        #############################
        [disallow_end_turn]
        [/disallow_end_turn]
        [event]
            name=moveto,unit placed,select
            first_time_only=no
            {FILTER id=Konrad}
            [heal_unit]
                {FILTER id=$unit.id}
                moves=full
            [/heal_unit]
        [/event]

        #############################
        # VISION
        #############################
        # first, unshroud any areas we visited previously
        # make this an event so that we can call it in 00d_sceptre_scenarios.cfg
        [event]
            name=refresh_shroud_from_variable
            first_time_only=no
            [foreach]
                array=bm_visited_hexes
                [do]
                    [remove_shroud]
                        {FILTER_SIDE side=1}
                        x,y=$this_item.x,$this_item.y
                        radius={KONRAD_VISION}
                    [/remove_shroud]
                [/do]
            [/foreach]
        [/event]
        {FIRE_EVENT refresh_shroud_from_variable}
        # every movement, manually reveal shroud/fog. Do this instead of modifying vision_costs,
        # so that we can store which hexes have been visited, and de-shroud them next time
        [event]
            name=enter hex,unit placed
            first_time_only=no
            {FILTER id=Konrad}
            [lift_fog]
                {FILTER_SIDE side=1}
                x,y=$unit.x,$unit.y
                radius={KONRAD_VISION}
                multiturn=yes # otherwise the initial "start" fog lift gets reset
            [/lift_fog]
            [remove_shroud]
                {FILTER_SIDE side=1}
                x,y=$unit.x,$unit.y
                radius={KONRAD_VISION}
            [/remove_shroud]
            [store_locations]
                x,y=$unit.x,$unit.y
                variable=bm_visited_hexes
                mode=append
            [/store_locations]
        [/event]

        #############################
        # PREVENT RECRUITING
        #############################
        # leave Konrad as a leader, because players want to be able to see their recruit/recall list.
        # but set canrecruit=no anytime Konrad moves onto a keep so that he can't actually ever recruit
        [event]
            name=moveto
            first_time_only=no
            {FILTER( id=Konrad {FILTER_LOCATION terrain=K*^*,*^K*} )}

            # disable recruiting/recalling while we're on the keep
            {MODIFY_UNIT id=Konrad canrecruit no}
            {IF} {LUA(<< return wesnoth.current.turn>2 >>)} {THEN(
                {GIVE_OBJECT_TO id=Konrad (id=konrad_gold_crown_object {EFFECT overlay add=misc/leader-crown.png})}
            )} {/IF}

            # re-enable recruiting/recalling when we leave the keep (or during victory)
            [event]
                name=moveto,victory
                priority=99 # before we check if the new hex it a keep too
                {MODIFY_UNIT id=Konrad canrecruit yes}
                {REMOVE_OBJECT konrad_gold_crown_object id=Konrad}
            [/event]
        [/event]

        #############################
        # VILLAGES
        #############################
        # prevent capturing. Looks odd for konrad to be capturing villages on the bigmap, and it has no mechanical effect
        [event]
            name=capture
            first_time_only=no
            {FILTER side=1}
            [capture_village]
                x,y=$unit.x,$unit.y
                side=$owner_side
            [/capture_village]
        [/event]

        #############################
        # KONRAD
        #############################
        # many of these same properties are also set when Konrad embarks onto a skiff
        {GIVE_OBJECT_TO id=Konrad (
            duration=scenario

            # remove all attacks
            {EFFECT remove_attacks ()}

            # don't get blocked by units
            {EFFECT new_ability (
                [abilities]
                    [skirmisher]
                        id=bigmap_skirmisher
                        affect_self=yes
                    [/skirmisher]
                [/abilities]
            )}

            # only allow moving on certain terrains, so we can restrict which scenarios Konrad has access to at any given time
            {EFFECT movement set={KONRAD_MOVES}}
            {EFFECT movement_costs (
                replace=yes
                [movement_costs]
                    flat=1
                    sand=1
                    frozen=1
                    village=1
                    castle=1
                    fungus=20 # this is our POI overlay - we want Konrad to only move onto these if explicitly commanded to
                    deep_water=999
                    shallow_water=999
                    reef=999
                    swamp_water=999
                    forest=999
                    hills=999
                    mountains=999
                [/movement_costs]
            )}
            {EFFECT defense (
                replace=yes
                [defense]
                    dummy_obstacle=60
                [/defense]
            )}

            # no vision (we handle this manually)
            {EFFECT vision set=0}
        )}
        {MODIFY_UNIT id=Konrad moves {KONRAD_MOVES}}
    [/event]

    #######################################################################################################################################################
    #                                                                   POINTS OF INTEREST
    #######################################################################################################################################################
    {campaigns/Heir_To_The_Throne/overworld/00a_western_wesnoth.cfg}
    {campaigns/Heir_To_The_Throne/overworld/00b_central_wesnoth.cfg}
    {campaigns/Heir_To_The_Throne/overworld/00c_northlands.cfg}
    {campaigns/Heir_To_The_Throne/overworld/00d_sceptre_scenarios.cfg}
    {campaigns/Heir_To_The_Throne/overworld/00e_eastern_wesnoth.cfg}

    #######################################################################################################################################################
    #                                                                      GAME STATE
    #######################################################################################################################################################
    #############################
    # MILESTONES
    #############################
    [event]
        name=prestart
        priority=99
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_turns equals $null})}
        # Only define these milestones once, at the start of the campaign.
        # Even if we change difficulties mid-game, we can't change these variables or the game's flow might break

        # milestone - on which bm_turn (Elves Besieged ends with turn=1) is Elensefar captured?
        # NOTE: if I change this, make sure the the timed campaign completion achievements are still possible
        {VARIABLE bm_milestone_elensefar {ON_DIFFICULTY4  6  5  4  4}}

        # milestone - on which bm_turn (Elves Besieged ends with turn=1) must Konrad play "The Sceptre of Fire"?
        {VARIABLE bm_milestone_scepter   {ON_DIFFICULTY4  9  7  6  5}}

        # milestone - on which bm_turn (Elves Besieged ends with turn=1) must Konrad fight Asheviere?
        # NOTE: this timing works out so that if we start in Autumn (which we do), Nightmare's final battle happens in Summer - the strongest season for Asheviere's lawful soldiers.
        # NOTE: if I ever reduce the gap between the Sceptre and Finale, be sure that the "cup of bitterness" event doesn't overlap with any other events.
        # NOTE: a player might choose to play the Sceptre early, which would give them extra second-half scenarios before $bm_milestone_finale. That's ok.
        {VARIABLE bm_milestone_finale    {ON_DIFFICULTY4 14 12 10  8}}

        # both $bm_milestone_scepter and $bm_milestone_finale get set to 99 if the player chooses to disable all time limits on the S30 bigmap
    [/event]

    #############################
    # INITIAL OBJECTIVES
    #############################
    [event]
        name=prestart

        [objectives]
            #------------------------
            # ALWAYS OBJECTIVES
            #------------------------
            [objective]
                description= _ "Explore Wesnoth"
                condition=win
                [show_if]
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )~= 0 >>)}
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )~=-1 >>)}
                    {LUA(<< return ( $bm_milestone_finale  - $bm_turns )~= 0 >>)}
                [/show_if]
            [/objective]

            #------------------------
            # EARLY OBJECTIVES
            #------------------------
            # show these before the Sceptre scenarios
            [objective]
                description= _ "Build up your army ($( $bm_milestone_scepter - $bm_turns ) battles remaining)"
                condition=win
                [show_if]
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )>=2 >>)}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Build up your army (1 battle remaining)"
                condition=win
                [show_if]
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )==1 >>)}
                [/show_if]
            [/objective]

            #------------------------
            # SCEPTRE OBJECTIVES
            #------------------------
            # show these during the Sceptre scenarios
            [objective]
                description= _ "Reunite with Delfador"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL status_s30 not_equals completed}
                    {VARIABLE_CONDITIONAL bm_sceptre_explained_when equals before}
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )==0 >>)}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Find Delfador"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL status_s30 not_equals completed}
                    {VARIABLE_CONDITIONAL bm_sceptre_explained_when not_equals before} # not "equals during", because the variable is unset at this point
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )==0 >>)}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Claim the Sceptre of Fire"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL status_s30 not_equals completed}
                    {LUA(<< return ( $bm_milestone_scepter - $bm_turns )==0 >>)}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Choose a path and escape the rising lava"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL status_s30     equals completed}
                    {VARIABLE_CONDITIONAL status_s31 not_equals completed}
                [/show_if]
            [/objective]

            #------------------------
            # ASHEVIERE OBJECTIVES
            #------------------------
            # show these after the Sceptre scenarios
            [objective]
                description= _ "Prepare to fight Asheviere ($( $bm_milestone_finale - $bm_turns ) battles remaining)"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL status_s31 equals completed}
                    {LUA(<< return ( $bm_milestone_finale  - $bm_turns )>=2 >>)}
                [/show_if]
            [/objective]

            [objective]
                description= _ "Prepare to fight Asheviere (1 battle remaining)"
                condition=win
                [show_if]
                    {LUA(<< return ( $bm_milestone_finale  - $bm_turns )==1 >>)}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Defeat the Dark Queen and reclaim your throne."
                condition=win
                [show_if]
                    {LUA(<< return ( $bm_milestone_finale - $bm_turns )==0 >>)}
                [/show_if]
            [/objective]

            {SCHEDULE_NOTES}
        [/objectives]

        #------------------------
        # WHIRLPOOL OBJECTIVES
        #------------------------
        # for simplicity, replace the default objectives if we've gone through the whirlpool
        {IF} {VARIABLE_CONDITIONAL bm_show_whirlpool_objectives equals yes} {THEN(
            [objectives]
                [objective]
                    description= _ "Explore Wesnoth and build up your army"
                    condition=win
                [/objective]
                [objective]
                    description= _ "When you’re ready, find Delfador and claim the Sceptre of Fire"
                    condition=win
                    [show_if]
                        [and]
                            {LUA(<<return wesnoth.current.turn>=(wml.variables['bm_milestone_elensefar'])>>)}
                            {OR({VARIABLE_CONDITIONAL status_s10 equals completed  })}
                            {OR({VARIABLE_CONDITIONAL status_s10 equals in_progress})}
                        [/and]
                        {VARIABLE_CONDITIONAL status_s31 not_equals completed}
                    [/show_if]
                [/objective]
                [objective]
                    description= _ "When you’re ready, defeat the Dark Queen and reclaim your throne"
                    condition=win
                    [show_if]
                        {VARIABLE_CONDITIONAL status_s31 equals completed}
                    [/show_if]
                [/objective]

                {SCHEDULE_NOTES}
            [/objectives]
        )} {/IF}
    [/event]

    #######################################################################################################################################################
    #                                                                 LOCATION-AGNOSTIC EVENTS
    #######################################################################################################################################################
    #############################
    # DELFADOR GOES TO ELENSEFAR
    #############################
    # main trigger - after you've completed your first bigmap scenario
    [event]
        name=start
        priority=-50 # after any JUSTCOMPLETED events
        {FILTER_CONDITION( {LUA(<<return wesnoth.current.turn==2>>)} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL bm_delfador_left not_equals yes} )}

        {DELAY 500}
        {MODIFY_UNIT id=Konrad facing se}
        {MOVE_UNDER_KONRAD(
            {UNSTORE_NPC Delfador x,y=$stored_konrad.x,$stored_konrad.y side=1}
            {MOVE_UNIT id=Delfador "$($stored_konrad.x+1)" $stored_konrad.y}
        )}
        {MODIFY_UNIT id=Delfador facing sw}
        [message]
            speaker=Delfador {DELFADOR_VARIATION mentoring}
            message=_"Well done, Konrad! I couldn’t be prouder of your wisdom in battle; you’re truly well on your way to becoming the prince you were always meant to be."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION glad}
            message=_"I had a good teacher! And now that we’ve helped the people here, all kinds of new places are suddenly open to us. Where shall we go to next?"
        [/message]
        {FIRE_EVENT delfador_leaves}
    [/event]

    # alternative trigger - if the player moves too close to elensefar
    [event]
        name=enter hex
        {FILTER( id=Konrad {FILTER_LOCATION x,y,radius=21,23,11} )}
        # if I change FILTER_LOCATION, verify we're still larger than the APPROACH_RADIUS for POI S10 Elensefar Before
        # AND verify we still prevent Delfador from reaching Carcyn - if he gets there he should be able to do the same event as the merfolk/gryphons
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL bm_delfador_left not_equals yes} )}

        [cancel_action]
        [/cancel_action]
        {MODIFY_UNIT id=Konrad facing se}
        {MOVE_UNDER_KONRAD(
            {UNSTORE_NPC Delfador x,y=$stored_konrad.x,$stored_konrad.y side=1}
            {MOVE_UNIT id=Delfador "$($stored_konrad.x+1)" $stored_konrad.y}
        )}
        {MODIFY_UNIT id=Delfador facing sw}
        {FIRE_EVENT delfador_leaves}
    [/event]

    # explain that Delfador needs to leave
    [event]
        name=delfador_leaves
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL bm_delfador_left not_equals yes} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL bm_dantonk_result not_equals conquered} )}

        {NAMED_NOTRAIT_UNIT 4 "War Harbinger" 18 22 familiar _"Familiar"}
        {ADD_MODIFICATION( {TRAIT_LOYAL} {TRAIT_AGED} )}

        {DO_AT_COORDS id=Delfador ({MOVE_UNIT id=familiar $coordX $coordY})}
        {MODIFY_UNIT id=familiar facing se}
        [message]
            speaker=familiar
            message=_"Kraa! Kraa! Kraa!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"What’s going on, Delfador? Is something the matter?"
        [/message]
        [message]
            speaker=Delfador
            message=_"I’m afraid so, young prince. Blackwing brings ill tidings, for my suspicions have been confirmed — Asheviere lays siege to Elensefar, breaking the century-old treaty between Wesnoth and the Elense city-state."
        [/message]
        [message]
            speaker=Delfador
            message=_"Lord Maddock may not be the most reliable ally, but he and his army have been instrumental in maintaining the relative freedom of the western reaches. If Elensefar should fall, we would lose a great ally in our quest for a victory against Asheviere. I must depart at once to aid in the defense!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"Then I am to journey on alone? I fear my quest will be difficult without your guidance and magic... but what must be must be."
        [/message]

        {IF} {HAVE_UNIT( id=Konrad {FILTER_LOCATION x,y,radius=18,55,5} )} {THEN(
            # player has just finished Flight
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"Not alone, Konrad. Already you have found new allies — the gentle elves of the Aethenwood — and you will doubtless find many more among the other denizens of the Great Continent."
            [/message]
        )}
        {ELSEIF} {HAVE_UNIT( id=Konrad {FILTER_LOCATION x,y,radius=10,49,5} )} {THEN(
            # player has just finished Blackwater Port
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"Not alone, Konrad. Already you have found new allies — the royal knights of Blackwater Port — and you will doubtless find many more among the other denizens of the Great Continent."
            [/message]
        )} {/ELSEIF}
        {ELSEIF} {HAVE_UNIT( id=Konrad {FILTER_LOCATION x,y,radius=16,42,5} )} {THEN(
            # player has just finished Bay of Pearls
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"Not alone, Konrad. Already you have found new allies — the noble Bay of Pearls merfolk — and you will doubtless find many more among the other denizens of the Great Continent."
            [/message]
        )} {/ELSEIF}
        {ELSEIF} {LUA(<<return wesnoth.current.turn==1>>)} {THEN(
            # if we sight Elensefar on bm_turn=1, give the player Blackwing (permanently) in return for losing Delfador (one battle earlier than usual)
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"Not alone, Konrad. Though I am loathe to see us part ways so soon, I can at least leave with you my familiar — the venerable Blackwing. Care for him well."
            [/message]
            {MODIFY_UNIT id=familiar side 1}
            [message]
                speaker=blackwing
                message=_"Cooo..."
            [/message]
            {VARIABLE bm_gave_familiar_to_konrad yes} # so we don't spawn him in later, even if he gets killed under Konrad's command
        )} {/ELSEIF}
        [else]
            # player has finished some other scenario
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"Not alone, Konrad. Already you have gained new allies, and you will doubtless find many more among the other denizens of the Great Continent."
            [/message]
        [/else]
        {/IF}

        [message]
            speaker=Delfador
            message=_"And as for my guidance, well... I raised you as best I was able, and did my utmost to prepare you for the difficult quest that lies ahead. You have trusted me, and for that I am grateful."
        [/message]
        [message]
            speaker=Delfador
            message=_"Now the time has come for me to put my trust in you. My trust that you can succeed where I failed; my trust that you shall yet restore the throne of Wesnoth! I know that you will make me proud."
        [/message]
        [message]
            speaker=Delfador
            message=_"Farewell, my young friend. Until we meet again."
        [/message]

        [set_extra_recruit]
            id=Delfador
            extra_recruit= # remove his extra recruits, so we don't mess up his future appearances
        [/set_extra_recruit]
        {MODIFY_UNIT id=Delfador side 4}
        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        {STORE_NPC Delfador}
        {NAMED_UNIT 1 Roc $stored_Delfador.x $stored_Delfador.y roc_delfador _"Delfador" (canrecruit=yes)} {FACING $stored_Delfador.facing}
        {ANIMATE_UNIT id=roc_delfador levelin}
        {DELAY 500}
        {MOVE_UNIT id=roc_delfador 19 24}
        {ANIMATE_UNIT id=roc_delfador levelout}
        {KILL id=roc_delfador}
        {UNSTORE_NPC Delfador x,y=19,24 side,facing=3,sw}

        {IF} {VARIABLE_CONDITIONAL bm_gave_familiar_to_konrad equals yes} {THEN(
            {MODIFY_UNIT id=familiar id blackwing} # so that this ID is safe to reuse in cutscenes, if necessary
            {MOVE_UNDER_KONRAD ({MOVE_UNIT id=blackwing $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=blackwing})}
        )} {ELSE(
            {MOVE_UNIT id=familiar 19 24}
            {KILL id=familiar}
        )} {/IF}

        {DELAY 1000}
        {REMOVE_OBJECT konrad_silver_crown_object id=Konrad}
        [event]
            name=victory
            # also do this on victory, in case we approach via Skiff and the real Konrad is stored (he gets unstored on victory)
            {REMOVE_OBJECT konrad_silver_crown_object id=Konrad}
        [/event]
        [message]
            speaker=Konrad
            message=_"It’s up to me then. I won’t let Wesnoth down."
        [/message]
        {VARIABLE bm_delfador_left yes}
    [/event]

    #------------------------
    # TIP: SEASONS
    #------------------------
    [event]
        name=prestart
        {FILTER_CONDITION( {LUA(<<return wesnoth.current.turn==2>>)} )}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Tip: The season of the year changes every time you finish a battle. Winter battles will have longer nights and shorter days, often with more snow and ice. Summer battles are the opposite.

Right now it’s winter. You can see the current season in the top-right-hand corner."
        [/message]
    [/event]

    #------------------------
    # TIP: DIFFICULTY
    #------------------------
    [event]
        name=prestart
        {FILTER_CONDITION( {LUA(<<return wesnoth.current.turn==3>>)} )}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Tip: This campaign’s difficulty setting affects both the strength of your enemies and the number of scenarios you can play before the final battle.

However, if you adjust the difficulty mid-campaign, the number of scenarios won’t change (or else you might end up stuck in an unplayable area)."
        [/message]
    [/event]

    #------------------------
    # TIP: GOLD
    #------------------------
    [event]
        name=prestart
        {FILTER_CONDITION( {LUA(<<return wesnoth.current.turn==4>>)} )}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Tip: Konrad will start most battle scenarios with 75 gold, plus any carryover from your last battle."
        [/message]
    [/event]

    #------------------------
    # TIP: ACHIEVEMENTS
    #------------------------
    [event]
        name=prestart
        {FILTER_CONDITION( {LUA(<<return wesnoth.current.turn==5>>)} )}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Tip: This campaign has many secrets and special interactions. Some are hinted at in the achievements list (viewable on the Wesnoth main menu)."
        [/message]
    [/event]

    #############################
    # LI'SAR GOES TO ELENSEFAR
    #############################
    [event]
        name=victory
        priority=-50 # after most victory events, but before Lisar gets stored
        {FILTER_CONDITION(
            {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar']-1)>>)}
            {OR({VARIABLE_CONDITIONAL status_s10 equals in_progress})}
        )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s10 not_equals completed  } )} # if we ALREADY fought at Elensefar, skip this because Li'sar can't go to Elensefar because it's already been saved by Konrad
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s17 not_equals in_progress} )} # if we fight at the crossroads, have this interaction DURING the scenario instead of before it
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s18 not_equals in_progress} )} # if we fight at Dan'Tonk, have this interaction DURING the scenario instead of before it

        # clear the map
        {PUT_TO_RECALL_LIST side=1}
        [place_shroud]
            side=1
            x,y=0-999,0-999
        [/place_shroud]
        {SCREEN_FADER 0,0,0 255 0}

        # prepare cutscene
        {STORE_UNIT_VAR id=Lisar x lisar_x}
        {STORE_UNIT_VAR id=Lisar y lisar_y}
        {UNSTORE_NPC Isolde x,y=56,45 side=6}
        {SCROLL_TO $lisar_x $lisar_y}
        {REVEAL x,y,radius=$lisar_x,$lisar_y,2 }
        {REVEAL x,y,radius="$($lisar_x+1)",$lisar_y,2 }

        # cutscene
        {DELAY 1500}
        {SCREEN_FADER 0,0,0 0 1000}
        {MOVE_UNIT   id=Isolde "$($lisar_x+1)" $lisar_y}
        {MODIFY_UNIT id=Isolde facing sw}
        {MODIFY_UNIT id=Lisar facing se}
        [message]
            speaker=Lisar
            message=_"Well?"
        [/message]
        [message]
            speaker=Isolde
            message=_"Battle plan approved, Your Highness. And your mother adds — remember what happened to Eldred."
        [/message]
        [message]
            speaker=Lisar
            message=_"I know the risks, but Elensefar has dragged on for far too long already. Wizard or no, we have to finish things before we overextend."
        [/message]
        {SCREEN_FADER 0,0,0 255 1500}
    [/event]

    #############################
    # KALENZ JOINS KONRAD
    #############################
    [event]
        name=start
        priority=-50 # after any JUSTCOMPLETED events
        {FILTER_CONDITION( {LUA(<<return wesnoth.current.turn==(wml.variables['bm_milestone_elensefar'])>>)} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s10 not_equals completed} )} # if we've already gotten Kalenz, skip this event
        {FIRE_EVENT kalenz_arrives}
    [/event]
    [event]
        name=kalenz_arrives

        #------------------------
        # CELEBRATE VICTORY AT ELENSEFAR
        #------------------------
        {IF} {VARIABLE_CONDITIONAL status_s10 equals completed} {THEN(
            {MOVE_UNDER_KONRAD(
                {UNSTORE_NPC Delfador x,y=$stored_konrad.x,$stored_konrad.y side=1}
                {GIVE_OBJECT_TO id=Delfador id=dont_levitate}
                {MOVE_UNIT id=Delfador $stored_konrad.x "$($stored_konrad.y+1)"}
                {MODIFY_UNIT id=Delfador facing sw}
            )}
            [message]
                speaker=Delfador
                message=_"Well done, Konrad. We must now consider how to proceed."
            [/message]
            [message]
                speaker=Delfador
                message=_"Our victory at Elensefar has been a great blow to Asheviere, but her thumb firmly remains upon the core cities of central Wesnoth. We have not the strength to challenge her in her domain. Even if we did, such a war would kill untold numbers."
            [/message]
            [message]
                speaker=Delfador
                message=_"This is a crucial moment. We must be sure to act rightly..."
            [/message]
        )} {/IF}
        {FADE_MUSIC_OUT 250}
        {INCIDENTAL_MUSIC elvish-theme.ogg}
        {FADE_MUSIC_IN 50}

        #------------------------
        # SPAWN KALENZ
        #------------------------
        {UNSTORE_NPC Kalenz x,y=1,1 side=2}
        {IF} {HAVE_UNIT( id=Konrad {FILTER_LOCATION x,y,radius=1,42,15} )} {THEN(
            [message]
                speaker=Konrad
                message=_"Look there! A boat approaches!"
            [/message]
            {GENERIC_UNIT 2 "Elvish Cutter" 12 20} {ROLE kalenz_ship}
            {DO_AT_COORDS id=Konrad ({MOVE_UNIT role=kalenz_ship $coordX $coordY})}
            {STORE_UNIT_VAR role=kalenz_ship x kalenz_x}
            {STORE_UNIT_VAR role=kalenz_ship y kalenz_y}
            {KILL role=kalenz_ship}
            {TELEPORT_UNIT id=Kalenz $kalenz_x $kalenz_y}
            {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=Kalenz $coordX $coordY})}
        )} {ELSE(
            [message]
                speaker=Konrad
                message=_"Look there! Someone comes!"
            [/message]
            {TELEPORT_UNIT id=Kalenz 34 19 }
            {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=Kalenz $coordX $coordY})}
        )} {/IF}

        #------------------------
        # KALENZ ARRIVES (WITH DELFADOR)
        #------------------------
        {IF} {VARIABLE_CONDITIONAL status_s10 equals completed} {THEN(
            {MODIFY_UNIT id=Konrad   facing sw}
            {MODIFY_UNIT id=Delfador facing sw}
            {MODIFY_UNIT id=Kalenz   facing se}
            [message]
                speaker=Delfador {DELFADOR_VARIATION mentoring}
                message=_"Not just someone! Konrad, this is Kalenz, High Lord of all elves and a close ally and friend."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"Kalenz! Delfador has told me so much about you!"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"Thank you for offering us asylum — even the elves of the Aethenwood recognize your authority. It’s a high honor to finally meet you in person."
            [/message]
            [message]
                speaker=Kalenz
                message=_"And you as well, friend Konrad. I have not seen you since you were very young, shortly after the deaths... of your brothers. From what I hear of your actions, Delfador would be proud of the king you are becoming."
            [/message]
            [message]
                speaker=Kalenz
                message=_"But this is no idle visit of reminiscence, for I bring word from the Ka’lian. Your mentor called upon the advice of the elvish council some weeks ago, Konrad."
            [/message]
            [message]
                speaker=Kalenz
                message=_"Delfador, the strands of prophecy are moving — you know she of whom I speak. May we take a moment in private?"
            [/message]
            {DELAY 250}
            {MOVE_UNIT id=Kalenz   19 26} {MODIFY_UNIT id=Kalenz   facing sw}
            {MOVE_UNIT id=Delfador 18 26} {MODIFY_UNIT id=Delfador facing ne}
            {DELAY 250}
            [message]
                speaker=Konrad
                message=_"..."
            [/message]
            {DELAY 250}
            {MOVE_UNIT id=Delfador 18 23} {MODIFY_UNIT id=Delfador facing nw}
            {MOVE_UNIT id=Kalenz   17 23} {MODIFY_UNIT id=Kalenz   facing se}
            [message]
                speaker=Delfador
                message=_"Then it shall be done. I depart for the Heart Mountains at once."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"You’re leaving just like that? We’ve hardly had a moment of peace together since the Aethenwood!"
            [/message]
            [message]
                speaker=Delfador
                message=_"I am afraid so, Konrad. An urgent matter has come up that demands my attention. It is something you need not concern yourself with just yet."
            [/message]
            {MODIFY_UNIT id=Delfador side 4}
            {SOUND skill-polymorph.wav}
            {ANIMATE_UNIT id=Delfador levelout}
            {REMOVE_OBJECT dont_levitate id=Delfador}
            {STORE_NPC Delfador}
            {NAMED_UNIT 1 Roc $stored_Delfador.x $stored_Delfador.y roc_delfador _"Delfador" (canrecruit=yes)} {FACING $stored_Delfador.facing}
            {ANIMATE_UNIT id=roc_delfador levelin}
            {DELAY 500}
            {MOVE_UNIT id=roc_delfador 43 15}
            {KILL id=roc_delfador}
            [message]
                speaker=Konrad KONRAD_VARIATION concerned}
                message=_"Gone! And with hardly a word. What’s this quest about, Kalenz?"
            [/message]
        )}

        #------------------------
        # KALENZ ARRIVES (NO DELFADOR)
        #------------------------
        {ELSE(
            [message]
                speaker=Konrad
                message=_"Who are you, stranger? Your ears are forked, but I don’t recognize you from the Aethenwood — even your clothes look foreign. Friend or foe?"
            [/message]
            [message]
                speaker=Kalenz
                message=_"Friend, Konrad. I am Kalenz, eldest in the Lintanir and High Lord of all elves. Greetings."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"Kalenz! Delfador has told me so much about you!"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION glad}
                message=_"Thank you for offering us asylum — even the elves of the Aethenwood recognize your authority. I am sorry for the price they paid. It’s a high honor to finally meet you in person."
            [/message]
            [message]
                speaker=Kalenz
                message=_"And you as well, friend Konrad. I have not seen you since you were very young, shortly after the deaths of your brothers. From what I hear of your actions, you should be proud of the king you are becoming."
            [/message]
            [message]
                speaker=Kalenz
                message=_"But this is no idle visit of reminiscence, for I bring grim news. The city of Elensefar — that which was defended so staunchly by your mentor Delfador and the lord Maddock — has been conquered."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"No! Has Delfador been taken prisoner? Is he hurt? We must march at once to his aid!"
            [/message]
            [message]
                speaker=Kalenz
                message=_"Your mentor is alive and well, Konrad. He could not rejoin you here today, but he left you a brief message. Ahem..."
            [/message]
            [message]
                speaker=Kalenz
                caption=_"Delfador"
                image=portraits/delfador.webp
                message=_"<i>I depart for the Heart Mountains at once, Konrad. An urgent matter has come up that demands my attention. It is something you need not concern yourself with just yet.</i>"
            [/message]
            {DELAY 500}
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"That’s it? We’ve hardly had a moment of peace together since the Aethenwood, and this is all he has to say. Kalenz, what is this quest about?"
            [/message]
        )} {/IF}

        # closing remarks
        [message]
            speaker=Kalenz
            message=_"Delfador is your guardian, and I shall respect his wish for silence on the matter. But in his absence, I shall be glad to accompany you on your travels."
        [/message]
        [message]
            speaker=Kalenz
            message=_"Together we must continue the work that you and he already began — brightening hearts, kindling hope, and freeing still more of your kind from their oppressive queen."
        [/message]
        {MODIFY_UNIT id=Kalenz side 1}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kalenz $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz} )}
        {CLEAR_VARIABLE kalenz_x,kalenz_y}
    [/event]

    #############################
    # DELFADOR FINDS THE SCEPTRE
    #############################
    [event]
        name=start
        priority=-50 # after any JUSTCOMPLETED events
        [filter_condition]
            {VARIABLE_CONDITIONAL bm_turns equals $bm_milestone_scepter}
            {VARIABLE_CONDITIONAL status_s30 not_equals in_progress}
            {VARIABLE_CONDITIONAL status_s30 not_equals completed}
        [/filter_condition]
        #------------------------
        # CREATE MESSENGER
        #------------------------
        {DELAY 500}
        {IF} {VARIABLE_CONDITIONAL bm_gave_familiar_to_konrad equals yes} {THEN(
            {NAMED_NOTRAIT_UNIT 4 "Fire Wraith" 50 11 familiar _"Messenger"}
            {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=familiar $coordX $coordY})}
            [message]
                speaker=familiar
                message=_"Fsss... crackle crackle hiss!"
            [/message]
        )} {ELSE(
            {NAMED_NOTRAIT_UNIT 4 "War Harbinger" 50 11 familiar _"Familiar"}
            {ADD_MODIFICATION( {TRAIT_LOYAL} {TRAIT_AGED} )}

            {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=familiar $coordX $coordY})}
            [message]
                speaker=familiar
                message=_"Kraa! Kraa! Kraa!"
            [/message]
        )} {/IF}

        #------------------------
        # KALENZ EXPLAINS SCEPTRE
        #------------------------
        {IF} {HAVE_UNIT id,search_recall_list=Kalenz,yes} {THEN(
            {MOVE_UNDER_KONRAD(
                {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y}
                {MOVE_UNIT id=Kalenz "$($stored_konrad.x-1)" $stored_konrad.y}
                {MODIFY_UNIT id=Kalenz facing se}
            )}
            [message]
                speaker=Kalenz
                message=_"A message from Delfador. He has found the Sceptre of Fire!"
            [/message]

            {IF} {VARIABLE_CONDITIONAL bm_delfador_explained_sceptre equals yes}{THEN(
                [message]
                    speaker=Konrad {KONRAD_VARIATION glad}
                    message=_"We must go at once! Once we hold the sceptre of my fathers; the symbol of the king of Wesnoth, surely Asheviere can no longer hope to oppose us."
                [/message]
                [message]
                    speaker=Kalenz
                    message=_"Indeed. Let us make haste, before some misfortune befalls it..."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad {KONRAD_VARIATION concerned}
                    message=_"The Sceptre of Fire? I thought that was just a myth! This is the quest he’s been off doing so secretly?"
                [/message]
                [message]
                    speaker=Kalenz
                    message=_"Indeed. Delfador will explain more once we three reunite. He is deep in the Heart Mountains to the northeast — you must go to him at once, Konrad."
                [/message]
            )} {/IF}
        )}
        #------------------------
        # KONRAD EXPLAINS SCEPTRE
        #------------------------
        {ELSE(
            {IF} {VARIABLE_CONDITIONAL bm_delfador_explained_sceptre equals yes}{THEN(
                [message]
                    speaker=Konrad {KONRAD_VARIATION glad}
                    message=_"A message from Delfador! He has found the Sceptre of Fire!"
                [/message]
                [message]
                    speaker=Konrad {KONRAD_VARIATION glad}
                    message=_"We must go at once! Once we hold the sceptre of my fathers; the symbol of the king of Wesnoth, surely Asheviere can no longer hope to oppose us."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message=_"A message from Delfador! He has found... the Sceptre of Fire?! I thought the Sceptre was just a myth! This is the quest he’s been off doing so secretly?"
                [/message]
                [message]
                    speaker=Konrad
                    message=_"I suppose Delfador will explain more once we reunite. The message says he is deep in the Heart Mountains to the northeast — I must go to him at once."
                [/message]
            )} {/IF}
        )} {/IF}
        {MOVE_UNIT id=familiar 51 11} {KILL id=familiar}
        {MOVE_UNDER_KONRAD({MOVE_UNIT id=Kalenz $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz})}

        #############################
        # DISABLE ALL FIRST-HALF POIS
        #############################
        #------------------------
        # FORD OF ABEZ
        #------------------------
        {REMOVE_IMAGE 47 27} # clear the Ford of Abez image, so it's clear we can pass through
        [event]
            name=preview_poi_s20 # let Konrad move through the Ford of Abez
            priority=99 # before the regular POI moveto events
            first_time_only=no
            {IF} {VARIABLE_CONDITIONAL explained_ford_skip not_equals yes} {THEN(
                [message]
                    speaker=Dosh
                    message=_"You already been paid for by da wizzard. Go on thru, softskin."
                [/message]
                {VARIABLE explained_ford_skip yes}
                [event]
                    name=victory
                    {CLEAR_VARIABLE explained_ford_skip}
                [/event]
            )} {/IF}
            {VARIABLE skip_next_poi_moveto yes}
        [/event]

        #------------------------
        # THE LOST GENERAL
        #------------------------
        # handled via FAILED_MOVETO

        #------------------------
        # DWARVEN DOORS
        #------------------------
        [event]
            name=preview_poi_s26 # let Konrad move through Dwarven Doors
            priority=99 # before the regular POI moveto events
            first_time_only=no
            [message]
                speaker=Konrad
                message=_"Any other time I would have insisted on stopping to help these poor people! But I’ve been instructed to meet with Delfador at once."
            [/message]
            [message]
                speaker=Konrad
                message=_"Delfador is just north of here. With so many orcs nearby, the Doors are closed to us. But I can still loop around to the west, north, then east, through the Caverns of Chaincolt."
            [/message]
            {VARIABLE skip_next_poi_moveto yes}

            # for POIs that haven't had their images removed, let them continue to block movement like normal. None of these other POIs should be physically preventing Konrad from reaching Delfador.
            {MOVE_UNIT id=$unit.id $previous_x $previous_y}
        [/event]

        #------------------------
        # OTHER POIS
        #------------------------
        [event]
            name=preview_poi_s00,preview_poi_s01,preview_poi_s02,preview_poi_s03,preview_poi_s04,preview_poi_s05,preview_poi_s06,preview_poi_s07,preview_poi_s08a,preview_poi_s08b,preview_poi_s09,preview_poi_s10,preview_poi_s11,preview_poi_s12,preview_poi_s13,preview_poi_s14,preview_poi_s15a,preview_poi_s15b,preview_poi_s16,preview_poi_s17,preview_poi_s18,preview_poi_s19,preview_poi_s21,preview_poi_s22,preview_poi_s23,preview_poi_s24,preview_poi_s25,preview_poi_s27,preview_poi_s29
            id=sceptre__disable_pois
            priority=99 # before the regular POI moveto events
            first_time_only=no
            [message]
                speaker=Konrad
                message=_"There is no time to stop and fight — I must meet with Delfador and claim the Sceptre. He is deep within the Heart Mountains, somewhere to the northeast."
            [/message]
            {VARIABLE skip_next_poi_moveto yes}

            # for POIs that haven't had their images removed, let them continue to block movement like normal. None of these other POIs should be physically preventing Konrad from reaching Delfador.
            {MOVE_UNIT id=$unit.id $previous_x $previous_y}
        [/event]
    [/event]

    #############################
    # LISAR HUNTS FOR THE SCEPTRE
    #############################
    [event]
        name=victory
        priority=-50 # after most victory events, but before Lisar gets stored
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL status_s30 equals in_progress} )}

        # clear the map
        {PUT_TO_RECALL_LIST side=1}
        [place_shroud]
            side=1
            x,y=0-999,0-999
        [/place_shroud]
        {SCREEN_FADER 0,0,0 255 0}

        # prepare cutscene
        {UNSTORE_NPC Lisar x,y=46,26 side,facing=6,ne}
        {GENERIC_UNIT 6 "Shock Trooper"     47 27} {FACING nw} {ROLE soldier1}
        {GENERIC_UNIT 6 "Heavy Infantryman" 47 28} {FACING nw} {ROLE soldier2}
        {GENERIC_UNIT 6 "Fencer"            48 28} {FACING nw} {ROLE soldier3}
        {REVEAL x,y,radius=46-47,26,3}
        {SCROLL_TO 48 25}

        #------------------------
        # FIGHT DOSH
        #------------------------
        {DELAY 1500}
        {SCREEN_FADER 0,0,0 0 1000}
        {IF} {VARIABLE_CONDITIONAL status_s20 equals $null} {THEN(
            {VARIABLE ford_cost 50}
            [message]
                speaker=Dosh
                message= _ "Crossin’ through Stoneskin ford? Dat’ll be $ford_cost gold for passage, whelp." # duplicated in the POI
            [/message]
            [message]
                speaker=Lisar {LISAR_VARIATION mad}
                message= _ "Clan Stoneskin is an ally of the crown. Let me by or face the consequences."
            [/message]
            [message]
                speaker=Dosh
                message= _ "Das right, miss princess. An bein’ our allies, I’m sure you wooden mind donatin’ dem $ford_cost gold pieces."
            [/message]
            {CLEAR_VARIABLE ford_cost}
            {ANIMATE_HARM id=Lisar      99 range=melee id=Dosh             KILL=yes}
            {MOVE_UNIT    role=soldier1 47 26}
            {ANIMATE_HARM role=soldier1 99 range=melee role=ford_henchman1 KILL=yes}

            {MOVE_UNIT role=ford_henchman3 46 21} {KILL role=ford_henchman3}
            {MOVE_UNIT role=ford_henchman4 54 20} {KILL role=ford_henchman4}
            {MOVE_UNIT role=ford_henchman2 43 30} {KILL role=ford_henchman2}
            {DELAY 500}
        )} {/IF}

        #------------------------
        # CROSS THE FORD
        #------------------------
        {KILL x,y=50,20} # in case there's an orc or something blocking Mirya
        {REVEAL x,y,radius=51,23,2}
        {REVEAL x,y,radius=49,24,3}
        {MOVE_UNIT id=Lisar      48 23} {MODIFY_UNIT id=Lisar      facing ne}
        {MOVE_UNIT role=soldier1 48 24} {MODIFY_UNIT role=soldier1 facing ne}
        {MOVE_UNIT role=soldier2 47 24} {MODIFY_UNIT role=soldier2 facing ne}
        {MOVE_UNIT role=soldier3 47 25} {MODIFY_UNIT role=soldier3 facing ne}

        {UNSTORE_NPC Mirya x,y=52,21 side,facing=6,sw}
        {ANIMATE_UNIT id=Mirya post_teleport}
        {MOVE_UNIT id=Mirya 50 22}

        #------------------------
        # SPEAK WITH MIRYA
        #------------------------
        [message]
            speaker=Lisar
            message= _ "Good news or bad news, Mirya. Are we too late?"
        [/message]
        [message]
            speaker=Mirya
            message= _ "They definitely have a lead on the Sceptre — of that I’m certain, your highness. But your “cousin” has only just arrived. They can’t yet have reached it."
        [/message]
        [message]
            speaker=Lisar
            message= _ "Then there’s still a chance. Double-quick, men!"
        [/message]
        {SCREEN_FADER 0,0,0 255 1500}
    [/event]

    #############################
    # CUP OF BITTERNESS
    #############################
    [event]
        name=start
        priority=-50 # after any JUSTCOMPLETED events
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_completed_swamp_turn not_equals $null})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_turns greater_than $bm_completed_swamp_turn})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_turns less_than    $bm_milestone_finale    })}
        {FILTER_CONDITION({HAVE_UNIT id,search_recall_list=Kalenz,yes})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_lisar_cup_of_bitterness_event not_equals yes})}

        {VARIABLE bm_lisar_cup_of_bitterness_event yes}

        {DELAY 500}
        {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar       $stored_konrad.x     "$($stored_konrad.y+1)"} )}
        {MOVE_UNDER_KONRAD( {RECALL_XY Delfador $stored_konrad.x $stored_konrad.y}                      {MOVE_UNIT id=Delfador "$($stored_konrad.x+1)"    $stored_konrad.y    } )}
        {MOVE_UNDER_KONRAD( {RECALL_XY Kalenz   $stored_konrad.x $stored_konrad.y}                      {MOVE_UNIT id=Kalenz   "$($stored_konrad.x+1)" "$($stored_konrad.y+1)"} )}
        {DELAY 500}
        [message]
            speaker=Kalenz
            message= _ "It is good that you have chosen to help us, Li’sar. But as we approach Weldyn, will your decision hold? You would do well to learn the lesson on loyalty that your mother did not."
        [/message]
        [message]
            speaker=Lisar
            message= _ "I am not a fool. I fought you because I believed it was best for Wesnoth. Now I fight my mother for the same reason."
        [/message]
        [message]
            speaker=Kalenz
            message= _ "Indeed..."
        [/message]
        [message]
            speaker=Lisar
            message= _ "Listen, you whose eyes are fair but hide a vacuum, do you think I do not know what power can do to one’s soul? What evils a person is capable of when truth and righteousness are but scrolls that can be rewritten when a queen grows tired of them?"
        [/message]
        [message]
            speaker=Lisar
            message= _ "I spent my entire childhood listening to my mother give orders and command armies around. I hid in the throne room as a little girl as she met with her generals. I now know she was having people killed... entire towns of people killed!"
        [/message]
        [message]
            speaker=Lisar
            message= _ "You are all lucky. You do not know what Wesnoth has been like these past many years. There is no peace. I have never known peace."
        [/message]
        [message]
            speaker=Delfador
            message= _ "I do know the cup of bitterness poured out on Wesnoth by your mother, child. The land has been torn apart. The elves know this. The orcs know this. Undead can feel it. Large armies of men march across the plains hunting each other, and when no men remain, outsiders will claim Wesnoth as their home."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message= _ "Enough! I can listen to no more of this. Li’sar, you may want to end your mother’s rule, but I will end her life as she ended the life of my father and my brothers. Asheviere’s masterwork of treachery will end, and it will end by my blade!"
        [/message]
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Kalenz   $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz  } )}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Delfador $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Delfador} )}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar    $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar} )}
    [/event]

    #############################
    # ASHEVIERE ANNOUNCES EXECUTIONS
    #############################
    [event]
        name=start
        priority=-50 # after any JUSTCOMPLETED events
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_turns equals $bm_milestone_finale})}
        #------------------------
        # INTRODUCE MESSENGER
        #------------------------
        {DELAY 250}
        {NAMED_UNIT 6 "Dragoon" 56 45 crier _"Crier" ()}
        {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=crier $coordX $coordY})}
        [message]
            speaker=crier
            message=_"Hear ye, hear ye! I bring tidings to the Lord Konrad from Her Majesty the Queen!"
        [/message]
        {MOVE_UNDER_KONRAD( {RECALL_XY Delfador $stored_konrad.x $stored_konrad.y}                      {MOVE_UNIT id=Delfador "$($stored_konrad.x+1)"  $stored_konrad.y    } )}
        {MOVE_UNDER_KONRAD( {UNSTORE_NPC Lisar x,y=$stored_konrad.x,$stored_konrad.y side,facing=14,se} {MOVE_UNIT id=Lisar       $stored_konrad.x   "$($stored_konrad.y+1)"} )}
        [message]
            speaker=Delfador
            message=_"A message from Asheviere? I wonder what new trickery this is. Speak what you have come to say, courier."
        [/message]

        #------------------------
        # GENERATE EXECUTION MESSAGE
        #------------------------
#define PREPARE_MESSAGE CONDITION MESSAGE
    {IF} # max 3 people in the message, or else it starts to sound silly
    {VARIABLE_CONDITIONAL message_count less_than 3}
    {CONDITION}
    {THEN(
        {VARIABLE message ($message| + {MESSAGE} + " ")}
        {VARIABLE_OP message_count add 1}
    )} {/IF}
#enddef
        {VARIABLE message ""}
        {VARIABLE message_count 0}

        # If Konrad doesn't save characters in need of help, Asheviere can capture them and use them as bargaining chips
        # Capturing Delurin is always an option, even if the player has finished the Three Sisters
        # Put Kalenz first, so we always explain to the player what happened to him (if he got captured)
        {PREPARE_MESSAGE (                                                             {VARIABLE_CONDITIONAL bm_kalenz_fled       equals yes}   ) _"Kalenz, Lord of the Lintanir."}
        {PREPARE_MESSAGE ( {VARIABLE_CONDITIONAL status_s02  not_equals completed} {OR({VARIABLE_CONDITIONAL bm_ethiliel_captured equals yes})} ) _"Ethiliel, Lady of the Aethenwood."}
        {PREPARE_MESSAGE ( {VARIABLE_CONDITIONAL status_s03  not_equals completed}     {VARIABLE_CONDITIONAL bm_kaylan_dead   not_equals yes}   ) _"Kaylan, Lord of Blackwater."}
        {PREPARE_MESSAGE ( {VARIABLE_CONDITIONAL status_s10  not_equals completed}                                                              ) _"Maddock, Lord of Elensefar."}
        {PREPARE_MESSAGE ( {VARIABLE_CONDITIONAL status_s02  not_equals completed} {OR({VARIABLE_CONDITIONAL bm_galdrad_captured  equals yes})} ) _"Galdrad, Champion of the Aethenwood."}
        {PREPARE_MESSAGE (                                                                                                                      ) _"Delurin, Three Sisters outlaw."}
        {PREPARE_MESSAGE ( {VARIABLE_CONDITIONAL status_s10  not_equals completed}     {VARIABLE_CONDITIONAL status_s11  not_equals completed}  ) _"Reglok, Elensefar thieves’ guildmaster."}
        {PREPARE_MESSAGE ( {VARIABLE_CONDITIONAL status_s08b not_equals completed}                                                              ) _"Harper, Three Sisters outlaw."}

        # if we have at least 2 options, say the whole message. If we have only 1 option, use a different, summarized message
        {IF} {VARIABLE_CONDITIONAL message_count greater_than_equal_to 2} {THEN(
            [message]
                speaker=crier
                #po: $message is a list of names and titles, generated depending on Konrad's actions. For example: "Maddock, Lord of Elensefar. Ethiliel, Lady of the Aethenwood. Delurin, Three Sisters outlaw. "
                message=_"Hark! The Lord Konrad and his followers are to be made aware of the events to proceed at Weldyn in three weeks’ time, these being the just and righeous execution of the following condemned criminals and rebel sympathizers:

$message|And one thousand twenty-eight other rebel partisans from the western and northern reaches."
            [/message]
        )} {ELSE(
            [message]
                speaker=crier
                message=_"Hark! The Lord Konrad and his followers are to be made aware of the events to proceed at Weldyn in three weeks’ time, these being the just and righeous execution of one thousand twenty-eight condemned partisans and rebel sympathizers from the western and northern reaches."
            [/message]
        )} {/IF}
        {CLEAR_VARIABLE message,message_count}
        [message]
            speaker=crier
            message=_"The Queen laments such a loss of life as regrettable, but necessary in Her Judgement to ensure the continued safety and stability of Her Kingdom.

The Lord Konrad is warned to discontinue his campaign of terror and keep well away from Weldyn, lest the same tragic fate befall him as well."
        [/message]
        {MOVE_UNIT id=crier 56 45}
        {KILL id=crier}
        {DELAY 750}

        #------------------------
        # DISCUSSING WHAT TO DO
        #------------------------
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"A mass execution!? Sweet Haldric, all those people. We have to act!"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"... but what did Asheviere hope to gain by telling us? Could she mean to catch us in some trap?"
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"How naïve can you be? Of course it's a trap!"
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"My mother knows how you think. She expects you to rush straight to Weldyn, where she and all her allies will be ready to catch us and crush us. We don’t even know if these people really have been captured."
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"We should ignore her taunt. Our wisest course of action would be to do as she says and stay well away, while we continue whittling down her base of power."
        [/message]
        [message]
            speaker=Konrad
            message=_"The condemned are my friends and allies; rebels who risked everything to oppose the dark queen. Even ignoring our morals, what message would such an act send? Who would still support us after such a display?"
        [/message]
        [message]
            speaker=Konrad
            message=_"If we are to rule Wesnoth, we must prove ourselves better than Asheviere, not equal. We must defeat her before she can carry out her executions."
        [/message]
        [message]
            speaker=Delfador
            message=_"Konrad speaks wisdom. Risky though it may be, we should march at once to Weldyn. There is no time to spare."
        [/message]
        [message]
            speaker=Lisar
            message=_"Very well. This is it, then."
        [/message]
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Delfador $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Delfador} )}
        {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Lisar    $stored_konrad.x $stored_konrad.y} {STORE_NPC Lisar}                )}

        # if we haven't already, don't trigger our approach voicelines
        {VARIABLE approached_s41 yes}
        #         {VARIABLE approached_s42 yes} # DO allow this one, because Fagh-Mok references this in S50. It's very unlikely we get to this point (impossible?) without triggering him, but just in case.
        {VARIABLE approached_s43 yes}
        {VARIABLE approached_s44 yes}
        {VARIABLE approached_s47 yes}
        {VARIABLE approached_s48 yes}
        {VARIABLE approached_s50 yes}

        #------------------------
        # DISABLE SECOND-HALF POIS
        #------------------------
        [event]
            name=preview_poi_s41,preview_poi_s42,preview_poi_s43,preview_poi_s44,preview_poi_s47,preview_poi_s48
            id=sceptre__disable_pois
            priority=99 # before the regular POI moveto events
            first_time_only=no
            [message]
                speaker=Konrad
                message=_"Asheviere has left us no time to stop and fight. We must reach Weldyn before she can carry out her executions."
            [/message]
            {VARIABLE skip_next_poi_moveto yes}
        [/event]
    [/event]
[/scenario]
