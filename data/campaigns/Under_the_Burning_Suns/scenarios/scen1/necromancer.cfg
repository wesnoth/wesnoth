#textdomain wesnoth-utbs

# We're going to use this piece of WML in two different places without a change, that's why it's placed within a macro
	#define DARKSORCERER_INTRO
	# Place the bad guy, give him proper gold an income
		[unit]
			#ifdef HARD
				type=Necromancer
			#else
				type=Dark Sorcerer
			#endif
			description=Xanthos
			user_description= _ "Xanthos"
			canrecruit=yes
			x=46
			y=3
			side=3
		[/unit]
		[modify_side]
			side=3
			{GOLD 150 175 200}
			{INCOME 12 15 20}
		[/modify_side]
		[remove_shroud]
			side=1
			x=44-48
			y=1-5
		[/remove_shroud]
		[message]
			description=Xanthos
			message= _ "This place reeks of the stench of death, I could smell it from miles away. Oh how I love it, it is the smell of power, the inevitable triumph of death over life. Puny elves, I shall use the corpses of your families to create an army of undead! All shall bow down before Xanthos the Necromancer!"
		[/message]
		[message]
			description=Nym
			message= _ "His timing couldn't be worse. I know that undead cultists often prey on small targets, but they haven't had the guts to attack us for years. Why has Eloh heaped so much misfortune upon us?"
		[/message]
		[message]
			description=Zhul
			message= _ "Have some more faith girl, the goddess does not give us more than we can handle. With Eloh's grace we shall yet triumph over this pretender."
		[/message]
		[message]
			description=Garak
			message= _ "Bah, I've fought these dark cultists before. They can be killed just like anyone else, and our elvish hunters can easily decimate their skeleton armies."
		[/message]
		[message]
			description=Kaleh
			message= _ "I have heard of your kind, foul necromancer. You travel the sands, daring to bring back and enslave those who have passed on. But we will prove to you that death is not all-powerful. You shall not desecrate the bodies of my kith and kin! You shall learn to fear the wrath of Eloh and the Quenoth elves!"
		[/message]
		[place_shroud]
			side=1
			x=44-48
			y=1-5
		[/place_shroud]
		[objectives]
			summary= _ "New Objectives:"
			show=yes
			[objective]
				description= _ "Rescue Surviving Elves"
				condition=win
			[/objective]
			[objective]
				description= _ "Defeat Xanthos"
				condition=win
			[/objective]
			[objective]
				description= _ "Death of Kaleh, Nym, Garak or Zhul"
				condition=lose
			[/objective]
		[/objectives]
	#enddef

# Normal necromancer placement, happens around turn 10 depending on difficulty level
	[event]
		#ifdef EASY
			name=turn 11
		#endif
		#ifdef NORMAL
			name=turn 10
		#endif
		#ifdef HARD
			name=turn 9
		#endif
	# If Xanthos does not exist and undead gold is unmodified it means he never showed up. We need this check
	# in case player triggered him earlier and managed to kill already, otherwise he might get spawned once more
        [store_side]
            side=3
            variable=temp
        [/store_side]
		[if]
			[not]
				[have_unit]
					description=Xanthos
				[/have_unit]
			[/not]
			[variable]
				name=temp.gold
				numerical_equals=100
			[/variable]
			[then]
				{DARKSORCERER_INTRO}
			[/then]
		[/if]
		{CLEAR_VARIABLE temp}
	[/event]

# When dark sorcerer dies, checks to make sure elves have been rescued before ending the scenario. If no set an event
# that checks if that changed on each move. It's ugly but there is no better way of doing that at the moment

	[event]
		name=die
		[filter]
			description=Xanthos
		[/filter]
		[sound]
			name=wail-long.wav
		[/sound]
		[kill]
			side=3
			animate=yes
		[/kill]
		[message]
			description=Kaleh
			message= _ "The necromancer is finally vanquished."
		[/message]
		[message]
			description=Zhul
			message= _ "And at last the dead shall have their rest."
		[/message]
		[if]
			[variable]
				name=rescued_elves
				not_equals=5
			[/variable]
			[then]
				[message]
					description=Kaleh
					message= _ "The necromancer is dead, but I don't think we've explored the entire village. There may still be elves that need rescuing. We should go back and check. "
				[/message]
				[event]
                    name=moveto
                    first_time_only=no
					[filter]
						x=1-60
						y=1-60
						side=1
					[/filter]
					[if]
						[variable]
							name=rescued_elves
                            equals=5
						[/variable]
						[then]
							[message]
								description=Kaleh
								message= _ "We've explored the village and I think we've rescued the last of the survivors."
							[/message]
							[endlevel]
								result=victory
								bonus=yes
							[/endlevel]
						[/then]
					[/if]
				[/event]
			[/then]
			[else]
				[endlevel]
					result=victory
					bonus=yes
				[/endlevel]
			[/else]
		[/if]
	[/event]

# This event prevents player from running to dark sorcerer's base before he shows up on turn 11. If the player 
# approaches his base before turn 11 he appears and attacks. Either way the unit moving into the area also comments 
# on the plight of those elves who lived out in the open sands.
	
	[event]
		name=moveto
		[filter]
			x=37-60
			y=1-12
			side=1
		[/filter]

		[if]
			[not]
				[have_unit]
					side=3
				[/have_unit]
			[/not]
			[then]
				{DARKSORCERER_INTRO}
			[/then]
		[/if]
		[message]
			speaker=unit
			message= _ "Some of our people felt crowded in the village, and wanted to live out on the open sands. They thought they could flee to the safety of our walls if danger came. I shudder to think what has happened to them."
		[/message]
	[/event]

	# Elvish hunting party shows up on turn 16
    [event]
		name=turn 16
		[remove_shroud]
			side=1
			x=24-32
			y=1-6
		[/remove_shroud]
        {LOYAL_UNIT 1 "Desert Hunter" 29 2 "Pythos" (_"Pythos")}
		[+unit]
			random_traits=yes
		[/unit]
        {LOYAL_UNIT 1 "Desert Fighter" 28 2 "Shea" ( _ "Shea")}
		[+unit]
			random_traits=yes
		[/unit]
        {LOYAL_UNIT 1 "Desert Fighter" 29 1 "Narn" ( _ "Narn")}
		[+unit]
			random_traits=yes
		[/unit]
        {LOYAL_UNIT 1 "Desert Scout" 27 2 "Jokli" ( _ "Jokli")}
		[+unit]
			random_traits=yes
		[/unit]
        {LOYAL_UNIT 1 "Desert Archer" 28 1 "Lyia" ( _ "Lyia")}
		[+unit]
			gender=female
			random_traits=yes
		[/unit]
		[message]
			description=Pythos
			message= _ "Hail, is anyone still alive?"
		[/message]
		[message]
			description=Kaleh
			message= _ "Yes, and we could certainly use your help. A necromancer has been attacking us, he intends to use our fallen comrades as fodder for his evil magics. Where have you been?"
		[/message]
		[message]
			description=Pythos
			message= _ "We were out far in the sands, searching for prey and roaming orcs. As soon as we saw the rock storm we raced back as fast as we could. I only wish we could have come sooner."
		[/message]
		[message]
			description=Nym
			message= _ "No use crying over spilt water. But we're sure glad you're here now."
		[/message]
	[/event]

# On victory dialogue
	[event]
		name=victory
		[message]
			description=Nym
			message= _ "It seems that we finally have some peace. But what do we do now?"
		[/message]
		[message]
			description=Garak
			message= _ "Where is Tanuil and his family?"
		[/message]
		[message]
			description=Kaleh
			message= _ "The keep has been crushed by the rocks. We could find no survivors."
		[/message]
		[message]
			description=Zhul
			message= _ "Too many have died this night."
		[/message]
		[message]
			description=Nym
			message= _ "Our village is in ruins. The walls that were built by our ancestors over generations have been demolished in a space of hours. Most of our dwellings are destroyed. And the great tree itself is no more. One thing is obvious, we cannot stay here."
		[/message]
		[message]
			description=Garak
			message= _ "You are a fool to despair. This has always been our home. The water here is good, we know this land. We can rebuild; Eloh willing, we can thrive again."
		[/message]
		[message]
			description=Nym
			message= _ "Think for a moment. Who else has seen the rock storm? What other foes are coming to pick over the remains of our people? There is no mercy in the desert, and we have many enemies who would seek to gain in our time of weakness."
		[/message]
		[message]
			description=Garak
			message= _ "Impudent girl, you should not speak so to your elders, or to your betters."
		[/message]
		[message]
			description=Nym
			message= _ "I have a right to speak my mind!"
		[/message]
		[message]
			description=Zhul
			message= _ "Peace, please calm yourselves. In chaos there is nothing but death and destruction. Even in this time of trial we must show our fortitude, and follow our laws. Without laws we are like beasts in the desert, fighting over scraps of meat. Among the survivors Kaleh is by heritage the closest relative to Tanuil and thus our leader. What say you Kaleh?"
		[/message]
		[message]
			description=Kaleh
			message= _ "Last night, before the rock storm, I heard a voice in my sleep. It sounded like sweet music, and somehow I knew it was Eloh. I still remember her exact words: 'You must be strong, young elf, for you enter a time of peril. The home you know will be destroyed, and you must lead your people to a new land. To the north you will find salvation and peace. Cross the desert and head to the mountains. Fear not, for I will guide you and protect you.' I'm not sure why I'm the one she chose to appeal to, but if this is her will, I will see it done. Our home is gone and the desert is a harsh place. If Eloh has prepared a new home for us, then I will lead us there."
		[/message]
		[message]
			description=Garak
			message= _ "I fear what dangers lurk in the harsh sands and beyond to the north, but because you are our leader, I will follow your counsel."
		[/message]
		[message]
			description=Zhul
			message= _ "Then let us collect what supplies we can from the wreckage and head north with great haste. Our home is protection no longer, we must find a new haven for our people."
		[/message]
		[message]
			description=Nym
			message= _ "What about the bodies of the dead? We can't leave them to be torn by crows or desecrated by other dark mages."
		[/message]
		[message]
			description=Kaleh
			message= _ "I agree, we should not forget our dead. We should build a huge pyre and burn them with proper ceremony, so that the smoke may carry them on to the next realm."
		[/message]
		[message]
			description=Zhul
			message= _ "Kaleh, I don't want to tarry longer than necessary, but I agree that we must see to the dead before we leave. Garak, you and your men start collecting our dead. Nym, help me find oil and wood so that we may build a pyre."
		[/message]
		[message]
			speaker=narrator
			message= _ "And so it was done. The dead were laid reverently on top of what little wood we could find. But the fire was big enough to burn the bodies to ashes and speed their souls to the hereafter. I remember at the time that the death of so many of our people was not the best omen for the start of such a large journey. They were the first of our people to die in this great endeavor, but they were to be far from the last."
		[/message]

        # Clear variables
        {CLEAR_VARIABLE seen_mudcrawler}
        {CLEAR_VARIABLE rescued_elves}
    [/event]

    [event]
        name=time over
        [message]
            description=Kaleh
            message= _ "What's that to the north? It looks like even more undead! The rock storm must have attracted other necromancers. There's no way we can defeat them all. We've run out of time. There's no escape. Eloh save us!"
        [/message]
    [/event]



