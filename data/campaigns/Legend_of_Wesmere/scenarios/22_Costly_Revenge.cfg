#textdomain wesnoth-low
[scenario]
    id=22_Costly_Revenge
    next_scenario=23_Council_Ruling
    name= _ "Costly Revenge"
    {LOW_MAP 21_Costly_Revenge.map}
    {campaigns/Legend_of_Wesmere/maps/Saurgath_utils.cfg}
    victory_when_enemies_defeated=no
    experience_modifier=100
    carryover_percentage=40
    carryover_add=yes
    {DEFAULT_SCHEDULE_DUSK}
    {TURNS 40 37 34}

    {INTRO_AND_SCENARIO_MUSIC revelation.ogg the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC                         vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC                casualties_of_war.ogg}
    {EXTRA_SCENARIO_MUSIC           the_dangerous_symphony.ogg}
    {EXTRA_SCENARIO_MUSIC                 into_the_shadows.ogg}
    {EXTRA_SCENARIO_MUSIC                weight_of_revenge.ogg}
    {EXTRA_SCENARIO_MUSIC                    nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC                         suspense.ogg}

    [story]
        [part]
            show_title=yes
            story= _ "But Kalenz failed to persuade his comrades. Olurf left, and Landar insisted the elves must march on the empire of the saurians..."
            {LOW_BIGMAP}
        [/part]
        [part]
            story={CAPTION ( _ "Cleodil")} + _ "Kalenz... the shydes and druids are not happy with this. The saurians are already beaten, and there is too much hate in Landar’s heart. Something is not right here."
            background=story/characters/cleodil.webp
            scale_background=no
        [/part]
        [part]
            story={CAPTION ( _ "Kalenz")} + _ "I am not entirely easy with this myself, Cleodil. But there is something to what Landar says; the wide green world must know there is a price, a heavy price for the death and suffering inflicted upon the elvish people."
            background=story/characters/kalenz.webp
            scale_background=no
        [/part]
        [part]
            story={CAPTION ( _ "Cleodil")} + _ "Then you who walk the earth path and carry steel can collect that price. Those on the faerie path will not be with you. Not this time."
            background=story/characters/cleodil.webp
            scale_background=no
        [/part]
        [part]
            story={CAPTION ( _ "Kalenz")} + _ "We do as we must."
            background=story/characters/kalenz.webp
            scale_background=no
        [/part]
    [/story]

    {LOW_TRACK {SCENARIO_21} }

    [side]
        side=1
        {SIDE_1_ESSENTIALS}
        {KALENZ_LORD}
        {SIDE_1_GOLD_FIXED 300 200}
        income=-2
        village_gold=1
        fog=no
        shroud=no
        [unit]
            {CLEODIL_COMPANION}
            placement=leader
        [/unit]
        [unit]
            {GALTRID_COMPANION}
            placement=leader
        [/unit]
#ifndef MULTIPLAYER
        [unit]
            {LANDAR}
            location_id=2
        [/unit]
        [unit]
            {ERADION_COMPANION}
            placement=leader
        [/unit]
#endif
    [/side]

    [side]
        side=2
        {SIDE_2_ESSENTIALS}
        {LANDAR}
        gold=200
        income=-2
        village_gold=1
        fog=no
        shroud=no
#ifdef MULTIPLAYER
        [unit]
            {ERADION_COMPANION}
            placement=leader
        [/unit]
#endif
    [/side]

    {STARTING_VILLAGES 3 7}

    [side]
        side=3
        {UNPLAYABLE_SIDE}
        team_name=saurians
        user_team_name= _ "Lizards"
        {FLAG_VARIANT undead}
        type=Saurian Flanker
        id=Fayl
        name=_ "Fayl"
        {GOLD 180 240 280}
        {INCOME 4 8 12}
#ifdef EASY
        recruit=Saurian Skirmisher, Saurian Augur
#else
        recruit=Saurian Skirmisher, Saurian Augur, Saurian Ambusher, Saurian Oracle, Saurian Soothsayer, Saurian Flanker, LoW Saurian Impaler, LoW Saurian Pikebearer
#endif
        [ai]
            passive_leader=yes
#ifdef EASY
            recruitment_pattern=scout,scout,healer,scout
#else
            recruitment_pattern=scout,scout,healer,archer,archer,fighter,scout
#endif
        [/ai]
    [/side]

    {STARTING_VILLAGES 4 6}

    [side]
        side=4
        {UNPLAYABLE_SIDE}
        team_name=saurians
        user_team_name= _ "Lizards"
        {FLAG_VARIANT undead}
        type=Saurian Flanker
        id=An-Meez
        name=_ "An-Meez"
        {GOLD 180 240 280}
        {INCOME 4 8 12}
#ifdef EASY
        recruit=Saurian Skirmisher, Saurian Augur
#else
        recruit=Saurian Skirmisher, Saurian Augur, Saurian Ambusher, Saurian Oracle, Saurian Soothsayer, Saurian Flanker, LoW Saurian Impaler, LoW Saurian Pikebearer
#endif
        [ai]
            passive_leader=yes
#ifdef EASY
            recruitment_pattern=scout,scout,healer,scout
#else
            recruitment_pattern=scout,scout,healer,archer,archer,fighter,scout
#endif
        [/ai]
    [/side]

    {STARTING_VILLAGES 5 9}

    [side]
        side=5
        {UNPLAYABLE_SIDE}
        team_name=saurians
        user_team_name= _ "Lizards"
        {FLAG_VARIANT undead}
        type=Saurian Flanker
        id=Inair
        name= _ "Inair"
        {GOLD 180 240 280}
        {INCOME 4 8 12}
#ifdef EASY
        recruit=Saurian Skirmisher, Saurian Augur
#else
        recruit=Saurian Skirmisher, Saurian Augur, Saurian Ambusher, Saurian Flanker, LoW Saurian Impaler, LoW Saurian Pikebearer
#endif
        [ai]
            passive_leader=yes
#ifdef EASY
            recruitment_pattern=scout,scout,healer,scout
#else
            recruitment_pattern=scout,scout,healer,archer,archer,fighter,scout
#endif
        [/ai]
    [/side]
    [side]
        side=6
        {UNPLAYABLE_SIDE}
        team_name=saurians
        user_team_name= _ "Lizards"
        {FLAG_VARIANT undead}
        [ai]
            passive_leader=yes
        [/ai]
    [/side]

    [event]
        name=prestart

        {NEED_KALENZ_LORD}

        {PLACE_IMAGE "items/dummy.png~RC(magenta<red)" 21 22}

        {MODIFY_UNIT side=1,2 facing se}
        {MODIFY_UNIT side=3 facing sw}
        {MODIFY_UNIT side=4,5 facing nw}

        [store_unit]
            [filter]
                id=Cleodil
            [/filter]
            kill=yes
            variable=cleodil
        [/store_unit]

        [store_unit]
            [filter]
                side=1,2
                type_adv_tree=Elvish Shaman,Wose
            [/filter]
            kill=yes
            variable=shamans
        [/store_unit]

        [disallow_recruit]
            side=1,2
            type=Elvish Shaman,Wose
        [/disallow_recruit]

        [store_unit]
            [filter]
                id=Olurf
            [/filter]
            kill=yes
            variable=olurf_stored
        [/store_unit]

        [if]
            [variable]
                name=fizz_stored.hitpoints
                greater_than=0
            [/variable]
            [then]
                [unstore_unit]
                    variable=fizz_stored
                    x,y=33,2
                [/unstore_unit]
                {FULL_HEAL id=Fizz}
                {MODIFY_UNIT id=Fizz side 6}

                [role]
                    id=Fizz
                    role=Fizz
                [/role]
            [/then]
            [else]
                [role]
                    side=3
                    canrecruit=yes
                    role=Fizz
                [/role]
            [/else]
        [/if]

        [objectives]
            side=0
            [objective]
                description= _ "Defeat all enemy units, and destroy all villages"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kalenz"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Landar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Eradion"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Galtrid"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                carryover_percentage=40
                bonus=yes
            [/gold_carryover]
        [/objectives]
    [/event]

    [event]
        name=start

        [message]
            speaker=Galtrid
            message= _ "And here we are at the walls of Saurgrath, their capital. Do not forget — these beasts ruined Lord Erlornas!"
        [/message]
        [message]
            id=Landar
            message= _ "Now is our chance to finish them off..."
        [/message]
        [message]
            id=Kalenz
            message= _ "I fear this will be a bloodbath..."
        [/message]
        [message]
            id=Landar
            message= _ "Destroy them, root and branch. Burn out their homes. Let none remain alive!"
        [/message]

        [scroll_to_unit]
            id=Kalenz
        [/scroll_to_unit]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Kalenz is not able to recruit or recall shamans or any of their advancements in this scenario."
        [/message]
    [/event]

    #TODO update this comment
    # every time one of the saurian gets killed this event checks if it
    # was the last one and if there are any villages left.
#define VICTORY_CONDITIONAL
    [if]
        [not]
            [have_unit]
                race=lizard
            [/have_unit]
        [/not]
        [not]
            [have_location]
                terrain=*^V*
            [/have_location]
        [/not]
        [then]
            [endlevel]
                result=victory
#ifdef MULTIPLAYER
                bonus=0.5
#else
                bonus=yes
#endif
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/then]
    [/if]
#enddef

    [event]
        name=die
        first_time_only=no
        [filter]
            [filter_side]
                [enemy_of]
                    side=1
                [/enemy_of]
            [/filter_side]
        [/filter]
        {VICTORY_CONDITIONAL}
    [/event]
    [event]
        name=die
        id=village_message

        [filter]
            [filter_side]
                [enemy_of]
                    side=1
                [/enemy_of]
            [/filter_side]
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    [filter_side]
                        [enemy_of]
                            side=1
                        [/enemy_of]
                    [/filter_side]
                [/have_unit]
            [/not]
            [and]
                [have_location]
                    terrain=*^V*
                [/have_location]
            [/and]
        [/filter_condition]

        [message]
            speaker=Landar
            message= _ "The lizards are dead. Now let’s raze the remaining villages to the ground!"
        [/message]
    [/event]

    [event]
        name=capture
        first_time_only=yes

        [filter]
            side=1,2
        [/filter]

        [switch]
            variable=unit.id
            [case]
                value=Landar
                [sound]
                    name=hiss-die.wav
                [/sound]
                [sound]
                    name=torch.ogg
                [/sound]
                [delay]
                    time=200
                [/delay]
                [sound]
                    name=wose-die.ogg
                [/sound]
                [terrain]
                    x=$x1
                    y=$y1
                    terrain=Dd^Dr
                    layer=overlay
                [/terrain]
                [redraw][/redraw]

                [message]
                    speaker=Kalenz
                    message= _ "What are you doing, Landar! These were but eggs and hatchlings!"
                [/message]
                [message]
                    id=Landar
                    message= _ "There’s no need spare them. When they grow up, they will desecrate our forests."
                [/message]
                [message]
                    id=Kalenz
                    message= _ "Elves must not stain their hands with the blood of children."
                [/message]
                [message]
                    id=Landar
                    message= _ "Perhaps you are too tender-minded to do what must be done, but many of us are not."
                [/message]
                [message]
                    id=Kalenz
                    message= _ "I will not set elf against elf. But, Landar, I fear you are storing up a dreadful price for yourself."
                [/message]
                [message]
                    role=Fizz
                    message= _ "Their revenge is terrible! I fear for our kind. Flee!"
                [/message]
                {MOVE_UNIT id=Fizz 35 4}
                [kill]
                    id=Fizz
                    animate=no
                [/kill]
                [message]
                    side=4
                    message= _ "Don’t flee. We cannot abandon our capital."
                [/message]
            [/case]
            [case]
                value=Kalenz
                [message]
                    speaker=Kalenz
                    message= _ "These are but eggs and hatchlings."
                [/message]
                [message]
                    id=Landar
                    message= _ "We must destroy them along with the rest. When they grow up, they will desecrate our forests."
                [/message]
                [message]
                    side=3
                    canrecruit=yes
                    message= _ "They even shatter our eggs!"
                [/message]
                [message]
                    id=Kalenz
                    message= _ "Elves must not stain their hands with the blood of children."
                [/message]
                [message]
                    id=Landar
                    message= _ "Perhaps you are too tender-minded to do what must be done, but many of us are not."
                [/message]
                [message]
                    id=Kalenz
                    message= _ "I will not set elf against elf. But, Landar, I fear you are storing up a dreadful price for yourself."
                [/message]
                [message]
                    id=Landar
                    message= _ "Stand aside. I will do what is needful."
                [/message]
                [message]
                    role=Fizz
                    message= _ "Their revenge is terrible! I fear for our kind. Flee!"
                [/message]
                {MOVE_UNIT id=Fizz 35 4}
                [kill]
                    id=Fizz
                    animate=no
                [/kill]
                [message]
                    side=4
                    message= _ "Don’t flee. We cannot abandon our capital."
                [/message]
                [scroll_to]
                    x=$x1
                    y=$y1
                [/scroll_to]
            [/case]
            [else]
                [message]
                    x=$x1
                    y=$y1
                    message= _ "These are but eggs and hatchlings."
                [/message]
                [message]
                    id=Landar
                    message= _ "Do not spare them. When they grow up, they will desecrate our forests."
                [/message]
                [message]
                    side=3
                    [not]
                        canrecruit=yes
                    [/not]
                    message= _ "They even shatter our eggs!"
                [/message]
                [message]
                    x=$x1
                    y=$y1
                    message= _ "But... to kill their young? Are we to go that far?"
                [/message]
                [message]
                    id=Kalenz
                    message= _ "Elves must not stain their hands with the blood of children."
                [/message]
                [message]
                    id=Landar
                    message= _ "Perhaps you are too tender-minded to do what must be done, but many of us are not."
                [/message]
                [message]
                    id=Kalenz
                    message= _ "I will not set elf against elf. But, Landar, I fear you are storing up a dreadful price for yourself."
                [/message]
                [message]
                    id=Landar
                    message= _ "Stand aside. I will do what is needful."
                [/message]
                [message]
                    role=Fizz
                    message= _ "Their revenge is terrible! I fear for our kind. Flee!"
                [/message]
                {MOVE_UNIT id=Fizz 35 4}
                [kill]
                    id=Fizz
                    animate=no
                [/kill]
                [message]
                    side=4
                    message= _ "Don’t flee. We cannot abandon our capital."
                [/message]
                [scroll_to]
                    x=$x1
                    y=$y1
                [/scroll_to]
            [/else]
        [/switch]
    [/event]

    # capture event lifted from IftU.
    [event]
        name=moveto
        first_time_only=no
        [filter]
            [filter_location]
                terrain=*^V*
            [/filter_location]
            side=1,2
        [/filter]
        [sound]
            name=hiss-die.wav
        [/sound]
        [sound]
            name=torch.ogg
        [/sound]
        [delay]
            time=200
        [/delay]
        [sound]
            name=wose-die.ogg
        [/sound]
        [terrain]
            x=$x1
            y=$y1
            terrain=Dd^Dr
            layer=overlay
        [/terrain]
        [redraw][/redraw]
        [if]
            [not]
                [have_location]
                    terrain=*^V*
                [/have_location]
            [/not]
            [and]
                [have_unit]
                    side=3,4,5
                [/have_unit]
            [/and]
            [then]
                [message]
                    race=lizard
                    message= _ "Our last village has been destroyed!"
                [/message]
                [message]
                    speaker=Landar
                    message= _ "Their wretched dwellings are destroyed! Now let’s wipe out the survivors!"
                [/message]
            [/then]
        [/if]
        {VICTORY_CONDITIONAL}
    [/event]

    [event]
        name=victory
        # dialog
        [message]
            id=Kalenz
            message= _ "That was the last. A bitter day’s work, and no memory to be proud of."
        [/message]
        [message]
            id=Landar
            message={WHISPER _"The saurians got what they deserved. Dwarves and humans are next!"}
        [/message]

        # we destroy all villages in this scenario, so we get 0 early finish bonus
        # to compensate that, we'll add that gold manually as if all those villages be intact
        # TODO: we have 24 villages, maybe worth storing it into variable at start instead of hardcoding?
        [store_turns]
            variable=turn_limit
        [/store_turns]
        {VARIABLE carryover_gold "$(($turn_limit - $turn_number) * 24)"}
#ifdef MULTIPLAYER
        {VARIABLE_OP carryover_gold divide 2}
#endif
        [gold]
            amount=$carryover_gold
            side=1
        [/gold]
#ifdef MULTIPLAYER
        [gold]
            amount=$carryover_gold
            side=2
        [/gold]
#endif
        {CLEAR_VARIABLE carryover_gold}
        {CLEAR_VARIABLE turn_limit}

        [foreach]
            array=shamans
            index_var=i
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall
                [/unstore_unit]
            [/do]
        [/foreach]
        [allow_recruit]
            side=1,2
            type=Elvish Shaman,Wose
        [/allow_recruit]
    [/event]

    {campaigns/Legend_of_Wesmere/utils/deaths.cfg}
[/scenario]

#undef VICTORY_CONDITIONAL
