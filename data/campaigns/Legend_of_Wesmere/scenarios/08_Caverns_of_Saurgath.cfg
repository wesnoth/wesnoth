#textdomain wesnoth-low
[scenario]
    id=08_Caverns_of_Saurgath
    next_scenario=09_The_Gate_of_Doom
    name= _ "Caverns of Saurgath"
    {LOW_MAP 08_Caverns_of_Saurgath.map}
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes
    {UNDERGROUND}
    {TURNS 53 48 43}

    {SCENARIO_MUSIC       the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC   underground.ogg}

    [side]
        side=1
        {SIDE_1_ESSENTIALS}
        {KALENZ}
        {SIDE_1_GOLD_FIXED 120 85}
        income=-2
        village_gold=1
        fog=no
        shroud=yes
#ifndef MULTIPLAYER
        [unit]
            {LANDAR_YOUNG}
            location_id=2
        [/unit]
#endif
    [/side]

    [side]
        side=2
        {SIDE_2_ESSENTIALS}
        gold=85
        {LANDAR}
        income=-2
        village_gold=1
        fog=no
        shroud=yes
    [/side]

    #Outpost guard:

    [side]
        side=3
        {UNPLAYABLE_SIDE}
        team_name=saurians
        user_team_name= _ "Enemies"
        {FLAG_VARIANT undead}
        {GOLD 50 100 150}
        {INCOME 2 4 6}
        type=Saurian Prophet
        id=Gil-Ja
        name=_ "Gil-Ja"
#ifdef EASY
        recruit=Giant Scorpling, Vampire Bat
#else
        recruit=Giant Scorpling, Vampire Bat, Giant Scorpion, Blood Bat
#endif
        [ai]
            passive_leader=yes
            aggression=0.85
            grouping=no
        [/ai]
    [/side]

    [side]
        side=4
        {UNPLAYABLE_SIDE}
        team_name=saurians
        user_team_name= _ "Enemies"
        {FLAG_VARIANT undead}
        no_leader=yes
    [/side]

    {STARTING_VILLAGES_ALL 3}

    [event]
        name=prestart

        #enter guard
        {LOYAL_UNIT 3 "Saurian Ambusher" 7 41}{GUARDIAN}
        {LOYAL_UNIT 3 "Saurian Ambusher" 8 42}{GUARDIAN}
        {UNIT 3 "Saurian Oracle" 7 42 (id=Fizz
        name= _ "Fizz")}{GUARDIAN}

        {MODIFY_UNIT side=3 facing sw}

        [recall]
            id=Erlornas
            placement=leader
        [/recall]
        [if]
            [not]
                [have_unit]
                    id=Erlornas
                [/have_unit]
            [/not]
            [then]
                [unit]
                    {ERLORNAS}
                    placement=leader
                [/unit]
            [/then]
        [/if]

        [unit]
            {CLEODIL_COMPANION}
            placement=leader
        [/unit]

        [hide_unit]
            side=1,2
        [/hide_unit]
    [/event]

    [event]
        name=start

        [unhide_unit]
            id=Erlornas
        [/unhide_unit]

        {MOVE_UNIT id=Erlornas 5 44}

        [unhide_unit]
            id=Kalenz
        [/unhide_unit]

        {MOVE_UNIT id=Kalenz 6 44}

        [unhide_unit]
            id=Landar
        [/unhide_unit]

        {MOVE_UNIT id=Landar 4 44}

        [unhide_unit]
            id=Cleodil
        [/unhide_unit]

        {MOVE_UNIT id=Cleodil 5 45}

        [redraw]
            clear_shroud=yes
        [/redraw]

        [message]
            speaker=Landar
            message= _ "The lizards are chasing us!"
        [/message]
        [message]
            speaker=Cleodil
            message= _ "I will command the roots to seal the passage!"
        [/message]

        [animate_unit]
            flag=healing
            [filter]
                id=Cleodil
            [/filter]
            [facing]
                x,y=5,48
            [/facing]
        [/animate_unit]

        {QUAKE "cave-in.ogg"}

        [terrain]
            x=4,5,6
            y=48,48,48
            terrain=Xue
        [/terrain]

        [redraw][/redraw]

        [animate_unit]
            flag=healing
            [filter]
                id=Cleodil
            [/filter]
            [facing]
                x,y=5,48
            [/facing]
        [/animate_unit]

        {QUAKE "entangle.wav"}

        [terrain]
            x=4,5,6
            y=48,48,48
            terrain=Xuf
        [/terrain]
        [redraw][/redraw]

        [message]
            speaker=Kalenz
            message= _ "Excellent, Cleodil, you've bought us time!"
        [/message]
        [message]
            speaker=Fizz
            message= _ "Elves! Elves in the caves! Hold them back, I'll call Gil-Ja!"
        [/message]

        {MOVE_UNIT id=Fizz 12 11}

        [message]
            speaker=Erlornas
            message= _ "There's a lizard outpost ahead, we need to capture it."
        [/message]

        [objectives]
            side=0
            [objective]
                caption= _ "Your first task:"
                description= _ "Defeat the outpost guardians"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kalenz"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Landar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Cleodil"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Erlornas"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage=40
                bonus=yes
            [/gold_carryover]
        [/objectives]
    [/event]

    [event]
        name=die
        first_time_only=no

        [filter]
            type=Saurian Ambusher
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    type=Saurian Ambusher
                [/have_unit]
            [/not]
        [/filter_condition]

        [message]
            speaker=Kalenz
            message= _ "The outpost is ours!"
        [/message]
        [message]
            speaker=Erlornas
            message= _ "You act boldly and swiftly, Kalenz. Few would have dared to follow me into the saurian capital, and even fewer would have reached the caves alive."
        [/message]
        [message]
            speaker=Kalenz
            message= _ "There is a reason for that, my lord. I did it because I am in desperate need of your help against the orcs."
        [/message]
        [message]
            speaker=Erlornas
            message= _ "Yes, Cleodil told me. I will help you, but know that more is at stake than just your home. The orcs threaten our entire people. We face a brutal struggle for survival."
        [/message]
        [message]
            speaker=Kalenz
            message= _ "I have felt that since the first day of the war."
        [/message]
        [message]
            speaker=Landar
            message= _ "We are ready for the fight, my lord. Under your banner, we will exterminate the filthy orcs!"
        [/message]
        [message]
            speaker=Erlornas
            message= _ "Your spirit will be a pillar for the warriors, Landar. But enough words; only an underground swamp separates us from the exit."
        [/message]

        [objectives]
            side=0
            [objective]
                caption= _ "Final task:"
                description= _ "Move Kalenz or Landar to the northern map border"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kalenz"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Landar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Cleodil"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Erlornas"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage=40
                bonus=yes
            [/gold_carryover]
            [note]
                [show_if]
                    {VARIABLE_CONDITIONAL swamp equals yes}
                [/show_if]
                description= _ "Any of your units that start their turn on a swamp hex will be poisoned. In addition, units who die on a swamp hex will become mudcrawler."
            [/note]
        [/objectives]
    [/event]

    [event]
        name=enter hex

        [filter]
            side=1
            [filter_location]
                terrain=S*
            [/filter_location]
        [/filter]

        {VARIABLE swamp yes}

        [message]
            speaker=Cleodil
            message= _ "It's not just a swamp, it emits poisonous fumes. And... I can feel it seething with primal malice."
        [/message]

        [remove_shroud]
            side=1,2
            terrain=S*,S*^*
        [/remove_shroud]
        [remove_shroud]
            x,y,radius=23,21,1
        [/remove_shroud]
        [redraw][/redraw]

        {TELEPORT_UNIT id=Gil-Ja 23 21}
        {TELEPORT_UNIT id=Fizz 22 20}
        {MODIFY_UNIT id=Gil-Ja facing s}
        {MODIFY_UNIT id=Fizz facing s}

        [message]
            speaker=Gil-Ja
            message= _ "You have gone mad from torture, elven lord! Why run here? To sacrifice your squad to the sorcerous swamp? Well, go ahead! The swamp will gladly swallow you!"
        [/message]
        [message]
            speaker=Erlornas
            message= _ "Beware, mockery will not help you when we meet face to face."
        [/message]
        [message]
            speaker=Gil-Ja
            message= _ "You will choke, weaken! The muck will flow into your eyes, your mouth, fill your insides! And you will become one of my slaves! All of you!"
        [/message]

        {FLASH_RED (
            [sound]
                name="magic-dark-big.ogg"
            [/sound])}

            {SCATTER_UNITS {ON_DIFFICULTY 4 5 6} "Giant Mudcrawler" 6 (
                terrain=S*,S*^*
                [and]
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                [/and]
            ) (
                side=3
                animate=yes
            )}

            [message]
                speaker=Gil-Ja
                message= _ "And those who escape the swamp will be torn apart by claws and mandibles!"
            [/message]

            {MOVE_UNIT id=Gil-Ja 11 10}
            {MOVE_UNIT id=Fizz 12 11}
            {MODIFY_UNIT id=Gil-Ja facing s}
            {MODIFY_UNIT Id=Fizz facing s}

            [micro_ai]
                side=3
                ai_type=stationed_guardian
                action=add
                ca_id=first_station

                [filter]
                    id=Fizz
                [/filter]
                distance=0
                station_x,station_y=12,11
                guard_x,guard_y=12,11
            [/micro_ai]

            [message]
                speaker=Landar
                message= _ "How do we get through this hell?!"
            [/message]
            [message]
                speaker=Erlornas
                message= _ "Be brave! Walk on the dry patches, stay close to the healers, and we will get out!"
            [/message]
            [message]
                speaker=narrator
                image=wesnoth-icon.png
                message= _ "Any of your units that start their turn on a swamp hex will be poisoned. In addition, units who die on a swamp hex will become mudcrawlers."
            [/message]

            [event]
                name=sighted

                [filter]
                    id=Gil-Ja
                [/filter]
                [filter_second]
                    side=1,2
                [/filter_second]

                [message]
                    speaker=Gil-Ja
                    message= _ "What?! How is this possible?!"
                [/message]
                [message]
                    speaker=Erlornas
                    message= _ "You are a fool to think you could stop elvish warriors with mud and vermin."
                [/message]
                [message]
                    speaker=Gil-Ja
                    message= _ "The fight is not over yet! Remember my words, you will never see the sun again! Fizz, my apprentice, delay them!"
                [/message]

                {MOVE_UNIT id=Gil-Ja 13 1}
                [kill]
                    id=Gil-Ja
                    animate=no
                [/kill]
                {MOVE_UNIT id=Fizz 11 10}
                {MODIFY_UNIT id=Fizz canrecruit yes}

                [message]
                    speaker=Erlornas
                    message= _ "Out of the way, hatchling, or you'll perish with your master!"
                [/message]
                [message]
                    speaker=Fizz
                    message= _ "<i>(frightened hiss)</i>"
                [/message]
            [/event]
        [/event]

        [event]
            name=last breath

            [filter]
                id=Fizz
            [/filter]

            {VARIABLE fizz_died yes}

            [message]
                speaker=unit
                message= _ "Fizz has delayed the elves... enough?"
            [/message]
        [/event]

        [event]
            name=moveto

            [filter]
                side=1,2
                id=Kalenz,Landar
                [filter_location]
                    y=1
                [/filter_location]
            [/filter]

            {CLEAR_VARIABLE swamp}

            [message]
                speaker=unit
                message= _ "I can feel a breath of fresh air! The exit is close!"
            [/message]

            [if]
                [have_unit]
                    id=Fizz
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            id=Fizz
                        [/filter]
                        kill=no
                        variable=fizz_stored
                    [/store_unit]
                [/then]
            [/if]

            [endlevel]
                result=victory
#ifdef MULTIPLAYER
                bonus=0.5
#else
                bonus=yes
#endif
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
        [event]
            name=last breath

            [filter]
                side=1,2
                [not]
                    id=Kalenz,Landar,Erlornas,Cleodil
                [/not]
                [filter_location]
                    terrain=S*,S*^*
                [/filter_location]
            [/filter]

            [message]
                speaker=unit
                message= _ "Kalenz... help..."
            [/message]
        [/event]
        [event]
            name=die
            first_time_only=no

            [filter]
                side=1,2
                [not]
                    id=Kalenz,Landar,Erlornas,Cleodil
                [/not]
                [filter_location]
                    terrain=S*,S*^*
                [/filter_location]
            [/filter]

            [kill]
                find_in=unit
            [/kill]

            [sound]
                name=mud-glob.ogg
            [/sound]

            [switch]
                variable=unit.level
                [case]
                    value=1
                    {UNIT 3 "Mudcrawler" $unit.x $unit.y (animate=yes
                    name= _ "$unit.name"
                    moves=0
                    attacks_left=0
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications])}
                    [fire_event]
                        name=first_transform
                    [/fire_event]
                [/case]
                [else]
                    {UNIT 3 "Giant Mudcrawler" $unit.x $unit.y (animate=yes
                    name= _ "$unit.name"
                    moves=0
                    attacks_left=0
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications])}
                    [fire_event]
                        name=first_transform
                    [/fire_event]
                [/else]
            [/switch]
        [/event]
        [event]
            name=first_phrase
            [message]
                speaker=unit
                message= _ "Kalenz... help..."
            [/message]
        [/event]

        [event]
            name=first_transform

            [message]
                speaker=Cleodil
                message= _ "How awful! The swamp is turning fallen elves into mud monsters!"
            [/message]
            [message]
                speaker=Landar
                message= _ "That wicked sorcerer will pay dearly for this!"
            [/message]
        [/event]

        [event]
            name=side 1 turn
            first_time_only=no

            [store_unit]
                variable=elves_to_poison
                [filter]
                    side=1
                    [filter_location]
                        terrain=S*,S*^*
                    [/filter_location]
                [/filter]
            [/store_unit]
            [foreach]
                array=elves_to_poison
                [do]
                    [modify_unit]
                        [filter]
                            id=$this_item.id
                        [/filter]
                        [status]
                            poisoned=yes
                        [/status]
                    [/modify_unit]
                [/do]
            [/foreach]
        [/event]
        [event]
            name=side 2 turn
            first_time_only=no

            [store_unit]
                variable=elves_to_poison
                [filter]
                    side=2
                    [filter_location]
                        terrain=S*,S*^*
                    [/filter_location]
                [/filter]
            [/store_unit]
            [foreach]
                array=elves_to_poison
                [do]
                    [modify_unit]
                        [filter]
                            id=$this_item.id
                        [/filter]
                        [status]
                            poisoned=yes
                        [/status]
                    [/modify_unit]
                [/do]
            [/foreach]
        [/event]
        {campaigns/Legend_of_Wesmere/utils/deaths.cfg}
    [/scenario]
#undef OPEN_LION_GATE
