#textdomain wesnoth-low

#TODO make the ugly map border nicer
[scenario]
    id=03_Kalian
    name= _ "Ka'lian under attack"
    next_scenario=04_Elvish_Treasury

    {LOW_MAP  Kalian.map}
    {LOW_MASK 03_Kalian.mask}
    [event]
        name=prestart
        # make some parts of the map unpassable
        [terrain]
            terrain=_off^_usr #wmllint: noconvert
            x=0-45,0-9 , 0-45
            y=0-5 ,0-44,39-44
        [/terrain]
    [/event]

    {TURNS 5 7 9}

    {INTRO_AND_SCENARIO_MUSIC northerners.ogg elvish-theme.ogg}
    {EXTRA_SCENARIO_MUSIC siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    #TODO add some more titles   
    {EXTRA_SCENARIO_MUSIC suspense.ogg}

    {DEFAULT_SCHEDULE}

    [story]
        [part]
            #TODO ESR
            #I wanted to pronounce that Kalenz isnt't right there now.
            story= _ "Kalenz and his band finally were on their way to the Ka'lian, but things were not as they had hoped..."
            delay=4000
        [/part]
        [part]
            delay=4000
            show_title=yes
            {TO_KALIAN}
        [/part]
    [/story]

    [side]
        side=1
        controller=human
        team_name=kalenz
        no_leader=yes
        recruit={ELVES}
        save_id=Kalenz
        fog=yes
        {GOLD 300 200 100}
        [unit]
            {GALTRID}
            # wmllint: recognize Galtrid
            x=33
            y=26
        [/unit]
    [/side]
    {STARTING_VILLAGES_ALL 1}

    #wml_disabled_lint: validate-off
    [side]
        side=2
        no_leader=yes
        controller=ai
        team_name=kalenz
        recruit={ELVES}
        gold=0

        [ai]
            #{AI_NO_SCOUTS}
            #{AI_ASPECT_FOR_TIME_OF_DAY aggression "night" dusk,first_watch,second_watch 1}
            #{AI_ASPECT_FOR_TIME_OF_DAY caution "night" dusk,first_watch,second_watch 0}
            #{AI_ASPECT_FOR_TIME_OF_DAY grouping "night" dusk,first_watch,second_watch offensive}
            #{AI_ASPECT village_value 0}
            #{AI_ASPECT recruitment_ignore_bad_movement yes}
            #{AI_ASPECT recruitment_pattern "scout,fighter,fighter,archer,mixed fighter"}



            recruitment_pattern=healer,archer,fighter,archer,fighter,archer,healer,scout
            villages_per_scout=10
            grouping=defensive
            caution=0.5
            aggression=0.5
        [/ai]
    [/side]

    #### Side3 code ####
    [side]
        side=3
        no_leader=yes
        team_name=orcs
        shroud=yes
        fog=yes
        share_view=yes
        [unit]
            type=Orcish Warlord
            id=Mutaf-uru
            name= _ "Mutaf-uru"
            profile=portraits/orcs/warlord3.png
            canrecruit=yes
            x=17
            y=6
        [/unit]
#ifdef EASY
        recruit={ORCS1}, Orcish Crossbowman, Goblin Pillager, Goblin Knight
#endif
#ifdef NORMAL
        recruit={ORCS1}, Orcish Crossbowman, Goblin Pillager, Goblin Knight, Orcish Slayer, Goblin Impaler, Goblin Rouser, Orcish Warrior
#endif
#ifdef HARD
        recruit={ORCS1}, Orcish Crossbowman, Goblin Pillager, Goblin Knight, Orcish Slayer, Goblin Impaler, Goblin Rouser, Orcish Warrior
#endif
        gold=0
        {INCOME 4 8 12}
        [ai]
            {AI_NO_SCOUTS}
            {AI_ASPECT_FOR_TIME_OF_DAY aggression "night" dusk,first_watch,second_watch 1}
            {AI_ASPECT_FOR_TIME_OF_DAY caution "night" dusk,first_watch,second_watch 0}
            {AI_ASPECT_FOR_TIME_OF_DAY grouping "night" dusk,first_watch,second_watch offensive}
            {AI_ASPECT village_value 0}
            {AI_ASPECT recruitment_ignore_bad_movement yes}
            {AI_ASPECT recruitment_pattern "scout,fighter,fighter,archer,mixed fighter"}
        [/ai]
        {ai/dev/formula_ai_poisoning.cfg}
    [/side]
    [event]
        name=last breath
        [filter]
            id=Mutaf-uru
        [/filter]
        [message]
            speaker=unit
            message= _ "We die, but more come after us, Orcs will rule all!"
        [/message]
    [/event]
    #### /Side3 code ####

    [side]
        side=4
        no_leader=yes
        team_name=orcs
        fog=yes
        shroud=yes
        share_view=yes
        [unit]
            type=Orcish Warlord
            id=Murudin
            name= _ "Murudin"
            canrecruit=yes
            x=11
            y=14
        [/unit]
#ifdef EASY
        recruit=Orcish Archer, Orcish Assassin, Orcish Grunt, Wolf Rider, Orcish Crossbowman, Goblin Knight, Goblin Pillager, Goblin Spearman
#endif
#ifdef NORMAL
        recruit=Orcish Archer, Orcish Assassin, Orcish Grunt, Wolf Rider, Orcish Crossbowman, Goblin Knight, Goblin Pillager, Goblin Spearman, Orcish Slayer, Orcish Warrior
#endif
#ifdef HARD
        recruit=Orcish Archer, Orcish Assassin, Orcish Grunt, Wolf Rider, Orcish Crossbowman, Goblin Knight, Goblin Pillager, Goblin Spearman, Orcish Slayer, Orcish Warrior
#endif
	gold=0
        {INCOME 4 8 12}
        [ai]
            aggression=1
            villages_per_scout=3
            village_value=0
            scout_village_targeting=0
            recruitment_pattern=scout,scout,scout,fighter,archer,mixed fighter
        [/ai]
        {ai/dev/formula_ai_poisoning.cfg}

    [/side]

    [side]
        side=5
        no_leader=yes
        team_name=orcs
        fog=yes
        shroud=yes
        share_view=yes
        gold=0
        [unit]
            type="Orcish Slayer"
            id=orc_leader 
            name= _ "Urudin" #TODO ESR: this slayer needs a name
            canrecruit=yes
            x=29
            y=15
            hitpoints=45
            max_hitpoints=45
        [/unit]
        recruit=""
        [ai]
        version=10703
        [stage]
                engine=cpp
                #TODO CRAB: add 'move leader to target' phase
                name=testing_ai_default::candidate_action_evaluation_loop
                [candidate_action]
                    engine=cpp
                    name=testing_ai_default::combat_phase
                    score=40
                [/candidate_action]
                [candidate_action]
                    engine=cpp
                    name=testing_ai_default::simple_move_and_targeting_phase
                    score=15
                [/candidate_action]
            [/stage]
        [/ai]
    [/side]

    #### Player's code ####
    [event]
        name=prestart
        [store_unit]
            variable=kalenz
            kill=yes
            [filter]
                race=elf
                [not]
                    id=Galtrid
                [/not]
            [/filter]
        [/store_unit]

        {UNIT 1 "Elvish Scout" 31 24 (id=guard) }
        # wmllint: recognize guard

        {GENERIC_UNIT 1 "Elvish Scout" 27 26}
        {GENERIC_UNIT 1 "Elvish Scout" 35 26}

        [store_gold]
            side=1
            variable=kalenz_gold
        [/store_gold]

        [modify_side]
            side=1
#ifdef EASY
            gold=160
#endif
#ifdef NORMAL
            gold=100
#endif
#ifdef HARD
            gold=50
#endif
        [/modify_side]
    [/event]
    #### /Player's code ####

    #### Kalenz arrives ####
    #wml_disabled_lint: validate-on
    [event]
        name="time over" 

        [modify_turns]
#ifdef EASY
            add=35
#endif
#ifdef NORMAL
            add=30
#endif
#ifdef HARD
            add=25
#endif
        [/modify_turns]

        {MODIFY_UNIT (side=1 
        x=1-99 
        y=1-99) side 2}

        [store_villages]
            variable=villages
            owner_side=1
        [/store_villages]

        {FOREACH villages village}
            [capture_village]
                side=2
                x=$villages[$village].x
                y=$villages[$village].y
            [/capture_village]
            {NEXT village}

        {CLEAR_VARIABLE villages}

        {FOREACH kalenz elf}
            [unstore_unit]
                variable=kalenz[$elf]
                x=recall
                y=recall
            [/unstore_unit]

            {NEXT elf}

        {CLEAR_VARIABLE kalenz}

        # {RECALL_KALENZ 43 15}
        [recall]
            id=Kalenz
            x=43
            y=15
        [/recall]

        {RECALL_LOYALS}
        {CHECK_LANDAR}
        # wmllint: recognize Landar

        [store_gold]
            variable=galdrid_gold
            side=1
        [/store_gold]

        [modify_side]
            side=1
            gold=$kalenz_gold
            fog=no
        [/modify_side]

        [modify_side]
            side=2
            gold=$galdrid_gold
        [/modify_side]

        {CLEAR_VARIABLE kalenz_gold}
        {CLEAR_VARIABLE galdrid_gold}

        [objectives]
            side=1
            [objective]
                description= _ "Defeat all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kalenz"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Landar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Galtrid"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}
        [/objectives]

        [message]
            #TODO ESR
            speaker=narrator
            image=wesnoth.png
            message= _ "For days, Kalenz traveled with his small host of followers,  moving closer and closer to Ka'lian... Thanks to the dense fog, he was able to evade the orcs who were trying to hunt down his small company. Then, the north wind blew, and the fog finally lifted..." 
        [/message]
        [message]
            #TODO ESR 
            id=Kalenz
            message= _ "Oh no! The Ka'lian is under attack! We must help them!"
        [/message]
        [message]
            #TODO ESR
            id=Galtrid
            message= _ "Are you our army's vanguard? Hurry, we are under attack!"
        [/message]
        [message]
            #TODO ESR
            id=Kalenz
            message= _ "No, we are fleeing an attack on our home, northeast of here. Time enough for talk later; we must defeat these orcs together, or at least hold them off long enough for the humans to come to our aid."
        [/message]
        [message]
            #TODO ESR
            id=Galtrid
            message= _ "Then you have not heard. King Haldric has broken the treaty. The humans will not come to our help!"
        [/message]

        #TODO: CRAB add strategy selection
        [message]
            #TODO ESR
            id=Mutaf-uru
            message= _ "What's that? More meat for my troops? Get them!"
        [/message]
        [modify_side]
            side=3
            {GOLD 200 280 460}
        [/modify_side]
        [modify_side]
            side=4
           {GOLD 200 360 500}
        [/modify_side]

        [event]
            name="time over" 
            [message]
                id=Kalenz
                #TODO ESR 
                message= _ "We have lost for some reason!"
            [/message]
        [/event]
    [/event]
    #### /Kalenz arrives ####

    [event]
        name=prestart
        [objectives]
            [objective]
                description= _ "Death of Galtrid"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=win
            [/objective]
        [/objectives]
    [/event]

    [event]
        name=start
        [scroll_to]
            x,y=31,26
        [/scroll_to]
 	#TODO ESR : the player should know : 1) that the elves have learned that the orcish attack is imminent. 2) that elves expect elven reinforcements, so they holed up in the Ka'lian until they come.
	#NOTE ESR : The initial player's objective is 'hold until end of turns' - i.e. 'hold until those reinforcement arrive'. Of course, those reinforcements won't arrive (maybe, because of the attack on the treasury). Luckily for the elves, Kalenz will arrive instead, and save the day.
        [delay]
            time=3000 #this delay is to give the player the sightseening opportunity
        [/delay]
        [scroll_to_unit]
            id=orc_leader
        [/scroll_to_unit]
        {MOVE_UNIT (id=orc_leader) 29 15}
        [message]
            id=guard
            #TODO ESR 
            message= _ "Watch out! Someone is sneaking around in the mist."
        [/message]
        [message]
            id=orc_leader
            #TODO ESR 
            message= _ "Hand over the stone and we <i>might</i> not destroy your pinky Elvencitadel and we <i>might</i> spare you. Or, at the very least, we'll give you a quick and painless death."
        [/message]
        [message]
            id=Galtrid
            #TODO ESR
            message= _ "What stone? The Ka'lian is older than you foul creatures walk under the sun and it was never raided. It will still stand after the last of you beasts have vanished and your wrongdoings are long forgotten."
        [/message]

        {MOVE_UNIT (id=orc_leader) 29 17}
        [terrain]
             terrain = Gg^Dr
             x,y=29,17
        [/terrain]
        {MOVE_UNIT (id=orc_leader) 29 17}
        [message]
            id=orc_leader
            #TODO ESR 
            message= _ "Punch his arrogant words back down his throat!"
        [/message]

	{GENERIC_UNIT 3 "Orcish Assassin" 25 19}
        {MOVE_UNIT (x,y=25,19) 27 21}

	{GENERIC_UNIT 3 "Orcish Assassin" 25 18}
        {MOVE_UNIT (x,y=25,18) 29 19}

	{GENERIC_UNIT 4 "Orcish Assassin" 21 21}
        {MOVE_UNIT (x,y=21,21) 24 22}

	{GENERIC_UNIT 4 "Orcish Assassin" 19 23}
        {MOVE_UNIT (x,y=19,23) 24 23}

	{GENERIC_UNIT 4 "Orcish Assassin" 20 24}
        {MOVE_UNIT (x,y=20,24) 23 25}

	{GENERIC_UNIT 4 "Orcish Assassin" 20 26}
        {MOVE_UNIT (x,y=20,26) 24 26}

	{GENERIC_UNIT 4 "Orcish Assassin" 21 32}
        {MOVE_UNIT (x,y=21,32) 25 30}

	{GENERIC_UNIT 4 "Orcish Assassin" 28 34}
        {MOVE_UNIT (x,y=28,34) 30 31}

	{GENERIC_UNIT 4 "Orcish Assassin" 35 34}
        {MOVE_UNIT (x,y=35,34) 32 31}

	{GENERIC_UNIT 4 "Orcish Assassin" 34 34}
        {MOVE_UNIT (x,y=34,34) 32 32}

	{GENERIC_UNIT 3 "Orcish Assassin" 38 19}
        {MOVE_UNIT (x,y=38,19) 36 21}

	{GENERIC_UNIT 3 "Orcish Assassin" 41 22}
        {MOVE_UNIT (x,y=41,22) 38 23}

	{GENERIC_UNIT 3 "Orcish Assassin" 41 23}
        {MOVE_UNIT (x,y=41,23) 39 25}

	{GENERIC_UNIT 3 "Orcish Assassin" 42 26}
        {MOVE_UNIT (x,y=42,26) 38 26}

        [message]
            id=Galtrid
            #TODO ESR 
            message= _ "To arms, brothers and sisters! Hopefully, our army will return to aid us soon."
        [/message]
        [scroll_to]
            x,y=31,26
        [/scroll_to]

        {GENERIC_UNIT 1 "Elvish Fighter" 30 21}
        {GENERIC_UNIT 1 "Elvish Fighter" 32 21}
        {GENERIC_UNIT 1 "Elvish Fighter" 32 28}
        {GENERIC_UNIT 1 "Elvish Fighter" 30 28}
        {GENERIC_UNIT 1 "Elvish Archer" 27 27}
        {GENERIC_UNIT 1 "Elvish Archer" 35 27}
        {GENERIC_UNIT 1 "Elvish Archer" 27 25}
        {GENERIC_UNIT 1 "Elvish Fighter" 28 23}
        {GENERIC_UNIT 1 "Elvish Fighter" 34 23}
        {GENERIC_UNIT 1 "Elvish Archer" 35 25}
        {GENERIC_UNIT 1 "Elvish Archer" 29 29}
        {GENERIC_UNIT 1 "Elvish Archer" 33 29}

        #village grabbers
        {GENERIC_UNIT 3 "Wolf Rider" 25 13}
        {GENERIC_UNIT 4 "Wolf Rider" 13 16}

        #spotter
        {GENERIC_UNIT 3 "Wolf Rider" 20 9}
        {GENERIC_UNIT 4 "Wolf Rider" 16 16}


        #second wave - north
        {GENERIC_UNIT 5 "Orcish Archer" 26 13}
        {GENERIC_UNIT 5 "Orcish Grunt" 27 13}
        {GENERIC_UNIT 5 "Orcish Grunt" 29 13}
        {GENERIC_UNIT 5 "Orcish Archer" 30 13}

        #second wave - east
        {GENERIC_UNIT 5 "Orcish Archer" 41 21}
        {GENERIC_UNIT 5 "Orcish Grunt" 42 22}
        {GENERIC_UNIT 5 "Orcish Grunt" 43 25}
        {GENERIC_UNIT 5 "Orcish Archer" 43 26}

        #second wave - west
        {GENERIC_UNIT 5 "Orcish Archer" 19 23}
        {GENERIC_UNIT 5 "Orcish Grunt" 19 25}
        {GENERIC_UNIT 5 "Orcish Grunt" 19 26}
        {GENERIC_UNIT 5 "Orcish Archer" 19 27}

        #second wave - south
        {GENERIC_UNIT 5 "Orcish Archer" 29 38}
        {GENERIC_UNIT 5 "Orcish Grunt" 30 37}
        {GENERIC_UNIT 5 "Orcish Grunt" 32 37}
        {GENERIC_UNIT 5 "Orcish Archer" 33 38}

    [/event]

    [event]
        name=victory
        [message]
            id=Kalenz
            message= _ "We won! The Ka'lian is safe!"
        [/message]

        [sound]
            name=horse-canter.wav
        [/sound]

        [move_unit_fake]
            type=Elvish Scout
            x=44,42,40,34,32,31
            y=13,12,12,15,18,22
        [/move_unit_fake]

        #TODO Move Huraldur to characters?
        [unit]
            id=Huraldur
            name= _ "Huraldur"
            type=Elvish Scout
            side=1
            x=31
            y=22
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_RESILIENT}
                {TRAIT_LOYAL}
            [/modifications]
            facing=se
        [/unit]

        [message]
            id=Huraldur
            message= _ "The elvish treasury is under attack! They need help desperately!"
        [/message]
        [message]
            id=Kalenz
            message= _ "Galtrid, your men are weary from long combat. Mine are fresher; I'll go."
        [/message]
        [message]
            id=Huraldur
            message= _ "Hurry! We were near overwhelmed as I left."
        [/message]
        [message]
            id=Galtrid
            message= _ "Yes, go, Kalenz, I'll guard the Ka'lian till our army returns from the front."
        [/message]
    [/event]

    [event]
        name=victory
        [store_unit]
            kill=no
            variable=galtrid_store
            [filter]
                id=Galtrid
            [/filter]
        [/store_unit]
        [store_unit]
            kill=no
            variable=galtrid_party
            [filter]
                side=2
                [not]
                    id=Galtrid
                [/not]
            [/filter]
        [/store_unit]
    [/event]

    {campaigns/Legend_of_Wesmere/utils/deaths.cfg}
[/scenario]
