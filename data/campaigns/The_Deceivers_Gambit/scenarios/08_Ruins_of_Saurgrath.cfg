#textdomain wesnoth-tdg

#
# why do the matriarchs recruit mostly augurs?
#   1) females are away at war, only males left at home
#   2) to make swamp's low defense less painful
#   3) the matriarchs are all flankers/javelineers
#   4) so skill_counterspell is more useful (though blizzard, polymorph, and especially animate fire are also very strong here)
#   5) their cold damage is good againt fire guardians, which are the strongest player strategy
#

#
# easiest way to beat this scenario is to kill poachers, then take Animate Fire + Panacea + Polymorph(for mobility) and wreck the saurians
# then you have lots of bonus gold carryover for S09 Omaranth - and you'll need it.
# unfortunately, you also won't be able to recruit poachers in S09, and poachers are very strong against the drakes
#

#
# intent is to make both poacher options reasonable choices, though recruiting poachers is helpful in the next scenario
#
# paying the fee gives you:
#    loyal trapper
#    2 poachers (good in swamps, but pierce is weak vs saurians)
#    ability to recruit poachers
#    intel on where the saurian matriarchs are located (randomized each time, so this doesn't lose value on subsequent playthroughs)
#    saves time and delfador-hp spent fighting the poachers
#    less restrictive spell selection (you don't need to fight)
# fighting the poachers gives you:
#    keep all your gold for recalling veterans; probably more than the cost of the poachers
#    free choice of unit selection - fire guardians are incredibly strong in this scenario, but you can't recruit as many unless you kill the poachers
#    more xp. Especially useful to safely level fire wraiths, which are in turn incredibly strong with panacea
#

#define TURNS
30#enddef
#define TURNS_LOW_WARNING
25#enddef

[scenario]
    id,map_file,name=08_Ruins_of_Saurgrath,08_Ruins_of_Saurgrath.map,_"Ruins of Saurgrath"
    next_scenario,victory_when_enemies_defeated=08x_Field_Hospital,no
    {DEFAULT_SCHEDULE_SECOND_WATCH} turns={TURNS}
    {SCENARIO_MUSIC weight_of_revenge.ogg}
    {EXTRA_SCENARIO_MUSIC nunc_dimittis.ogg}
    {ADD_WEATHER_RAIN}

    {DE_TRACK {JOURNEY_08_NEW}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,{ON_DIFFICULTY4 80 80 80 40}
        team_name,user_team_name=wesnoth,_"Delfador’s Hirelings"
        fog,shroud=yes,yes
        {FLAG_VARIANT loyalist}
    [/side]

    #############################
    # SAURIANS
    #############################
#define SAURIAN_SIDE SIDE TYPE NAME MODS
    [side]
        side,controller,color={SIDE},ai,black
        type,id,name={TYPE},matriarch{SIDE},{NAME}
        x,y=1,1 # being near 1,1 is used for checking if a leader is still "homeless"
        {MODS}
        gold,income={ON_DIFFICULTY4 0 16 16 16},-2 # enough for 0-1 initial recruits, and then nothing else until we manually give gold
        recruit={ON_DIFFICULTY4 "Saurian Devotee" "Saurian Augur" "Saurian Augur" "Saurian Augur"}
        team_name,user_team_name=saurians,_"Blackcrest Saurians"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
#define TRAIT_AGED2
    # aged, but also affects ranged attacks
    [trait]
        id=aged2
        male_name= _ "aged"
        female_name= _ "female^aged"
        help_text= _ "Units with the <italic>text='aged'</italic> trait have 8 hitpoints less and suffer from a 1 point decrease in movement and damage."
        [effect]
            apply_to=hitpoints
            increase_total=-8
        [/effect]
        [effect]
            apply_to=movement
            increase=-1
        [/effect]
        [effect]
            apply_to=attack
            increase_damage=-1
        [/effect]
    [/trait]
#enddef
    # nerf the saruains with aged and weak traits
    # this lets us give them plenty of minions
    {SAURIAN_SIDE 2 {ON_DIFFICULTY4 (Saurian Ambusher)     (Saurian Flanker)    (Saurian Flanker)    (Saurian Flanker)   } _"Fliiss"   ({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_QUICK}      )}) }
    {SAURIAN_SIDE 3 {ON_DIFFICULTY4 (Saurian Ambusher)     (Saurian Flanker)    (Saurian Flanker)    (Saurian Flanker)   } _"Messata"  ({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_INTELLIGENT})}) }
    {SAURIAN_SIDE 4 {ON_DIFFICULTY4 (Saurian Ambusher)     (Saurian Flanker)    (Saurian Flanker)    (Saurian Flanker)   } _"Anazz"    ({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_INTELLIGENT})}) }
    {SAURIAN_SIDE 5 {ON_DIFFICULTY4 (Saurian Ambusher)     (Saurian Flanker)    (Saurian Flanker)    (Saurian Flanker)   } _"Zilnaza"  ({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_QUICK}      )}) }
    {SAURIAN_SIDE 6 {ON_DIFFICULTY4 (Saurian Spearthrower) (Saurian Javelineer) (Saurian Javelineer) (Saurian Javelineer)} _"Ka'Kzaesz"({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_INTELLIGENT})}) }
    {SAURIAN_SIDE 7 {ON_DIFFICULTY4 (Saurian Spearthrower) (Saurian Javelineer) (Saurian Javelineer) (Saurian Javelineer)} _"Fritrais" ({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_QUICK}      )}) }
    {SAURIAN_SIDE 8 {ON_DIFFICULTY4 (Saurian Spearthrower) (Saurian Javelineer) (Saurian Javelineer) (Saurian Javelineer)} _"Artrax"   ({MODIFICATIONS( {TRAIT_AGED2} {TRAIT_QUICK}      )}) }
    [side]
        side,controller,color=9,ai,green
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=saurians,_"Saurian Juveniles"
        {FLAG_VARIANT6 ragged}
    [/side]

    #############################
    # POACHERS
    #############################
    [side]
        side,controller,color=10,ai,brown
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name=poachers
        {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=prestart
        {MODIFY_SIDE_AI 10 aggression=0.99}
        {MODIFY_SIDE_AI 10 caution=0.01}
        {MODIFY_SIDE_AI 10 retreat_factor=0}
        {MODIFY_SIDE_AI 10 village_value=0}
    [/event]
    [side]
        side,controller,color=11,null,brown
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name=poachers,wesnoth
        {FLAG_VARIANT6 ragged}
    [/side]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # SAURIAN LEADERS
        #############################
#define PLACE_LEADER SIDE XLIST YLIST
    [random_placement]
        variable,num_items=loc,1
        [filter_location]
            x={XLIST}
            y={YLIST}
            {NOT( {FILTER()} )} # no unit already there
        [/filter_location]
        [command]
            # move the leader and create a keep
            {TELEPORT_UNIT side,canrecruit={SIDE},yes $loc.x $loc.y}
            [terrain]
                x,y=$loc.x,$loc.y {AND terrain=Ch*^*}
                terrain=Khr
            [/terrain]
            [terrain]
                x,y=$loc.x,$loc.y {AND terrain=Ce*^*}
                terrain=Ker
            [/terrain]

            # initial recruits wander nearby
            [micro_ai]
                side,ai_type,action={SIDE},zone_guardian,add
                ca_id=matriarch_guard_{SIDE}
                {FILTER canrecruit=no}
                [filter_location]
                    radius=2 {FILTER side,canrecruit={SIDE},yes}
                [/filter_location]
            [/micro_ai]

            # activate saurians (fired when any saurian spots Delfador's side)
            [event]
                name=activate_saurians
                [micro_ai]
                    side,ai_type,action={SIDE},zone_guardian,delete
                    ca_id=matriarch_guard_{SIDE}
                [/micro_ai]

                [modify_side]
                    gold={ON_DIFFICULTY4 8 8 16 16}
                    side,income={SIDE},{ON_DIFFICULTY4 0 2 6 6}
                [/modify_side]

                # scale up income over time - once "activated", the saurians take a minute to mobilize
                [event]
                    name=new turn
                    [event]
                        name=new turn
                        [modify_side]
                            side,income={SIDE},{ON_DIFFICULTY4 2 4 8 8}
                        [/modify_side]
                        [event]
                            name=new turn
                            [event]
                                name=new turn
                                [modify_side]
                                    side,income={SIDE},{ON_DIFFICULTY4 4 6 10 10}
                                [/modify_side]
                                [event]
                                    name=new turn
                                    [event]
                                        name=new turn
                                        [event]
                                            [modify_side]
                                                side,income={SIDE},{ON_DIFFICULTY4 6 8 12 12}
                                            [/modify_side]
                                        [/event]
                                    [/event]
                                [/event]
                            [/event]
                        [/event]
                    [/event]
                [/event]

                # saurian AI
                [event]
                    name=side {SIDE} turn
                    first_time_only=no
                    {RESET_SIDE_AI {SIDE} defensive 0.8 0.2}
                    {VARY_AI_BY_SCHEDULE {SIDE}}
                    {RETREAT_WHEN_WEAK {SIDE} 0-2 ({GOAL_LOCATION 99 (
                        terrain=Ch*^*,Ce*^* # retreat to castle hexes near any friendly leader
                        {AND( radius=2
                        {FILTER (side=2,3,4,5,6,7,8)} )}
                    )} )}
                [/event]
            [/event]
        [/command]
    [/random_placement]
#enddef
        # Randomize Placement
        # master list:
        # x=11, 8,12,18,  19,10,22,29,  39,45,41,48,  37,38,45,46
        # y=19,14, 9,13,   8, 3, 2, 8,  14, 9, 6, 6,  25,21,22,18
        {PLACE_LEADER 2 (11, 8,12,18) (19,14, 9,13)} # 1 west
        {PLACE_LEADER 3 (19,10,22,29) ( 8, 3, 2, 8)} # 1 northwest
        {PLACE_LEADER 4 (39,45,41,48) (14, 9, 6, 6)} # 1 northeast
        {PLACE_LEADER 5 (37,38,45,46) (25,21,22,18)} # 1 southeast
        {PLACE_LEADER 6 (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)} # 3 wildcards
        {PLACE_LEADER 7 (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        {PLACE_LEADER 8 (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}

        #############################
        # SAURIAN CIVILIANS
        #############################
#define SPAWN_JUVENILE X Y
    {VARIABLE_OP image rand "saurian1.png,saurian2.png,saurian3.png,saurian4.png"}
    {GENERIC_UNIT 9 (Saurian Juvenile) {X} {Y}}
    {ADD_MODIFICATION(
        [object]
            {EFFECT new_animation (
                [standing_anim]
                    base_score=99 {FRAME image="units/civilian/$image"}
                [/standing_anim]
            )}
            {EFFECT new_animation (
                [movement_anim]
                    base_score=99 {FRAME image="units/civilian/$image"}
                [/movement_anim]
            )}
        [/object]
    )}
#enddef
#define PLACE_CIVILIANS XLIST YLIST
    [random_placement]
        variable,num_items=loc,1
        [filter_location]
            x={XLIST}
            y={YLIST}
            {NOT( {FILTER()} )} # no unit already there
        [/filter_location]
        [command]
            {VARIABLE_OP count rand "2,3,4"}
            {REPEAT $count ({SPAWN_JUVENILE $loc.x $loc.y})}
            {CLEAR_VARIABLE count,image}
        [/command]
    [/random_placement]
#enddef
        {PLACE_CIVILIANS (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        {PLACE_CIVILIANS (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        {PLACE_CIVILIANS (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        {PLACE_CIVILIANS (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        {PLACE_CIVILIANS (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        {PLACE_CIVILIANS (11,8,12,18, 19,10,22,29, 39,45,41,48, 37,38,45,46) (19,14,9,13,  8,3,2,8, 14,9,6,6, 25,21,22,18)}
        [micro_ai]
            side,ai_type,action=9,coward,add
            {FILTER ()}
            distance=6
        [/micro_ai]

        #############################
        # DELFADOR
        #############################
        {RECALL_XY Delfador 18 24}
        #         {STORE_SKILLS}
        #         {VARIABLE skill_fireball3 yes} # start with a generic l3 fireball and no other skills
        #         {FIRE_EVENT refresh_delfador_skills}

        {RECALL_COMPANION 17 26}

        {SCROLL_TO 18 24}
    [/event]

    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        [message]
            speaker=Delfador
            message=_"The seven saurian matriarchs lie somewhere in this swamp. With most of their warriors away at war, they will be vulnerable."
        [/message]
        [message]
            speaker=Delfador
            message=_"The Blackcrests have good reason to fight, but none of this should concern saurians — they’re not usually invaders. I need to figure out what’s going on with this alliance and put an end to it, even if that means roasting their slimy hides scale-by-scale!"
        [/message]
        [message]
            speaker=Delfador
            #po: $companion_name is probably the female name Lynan, but if she's died it could be any automatically-generated human name of either gender
            message=_"That is, if we can find their camps — even what little remains of Saurgrath is too vast for us to scour it all. This is where you said your guides would meet us, right $companion_name?"
        [/message]
        [message]
            speaker=$companion_id
            message=_"You’re almost there! Jus’ a lil bit further... almost..."
        [/message]

        {SCROLL_TO 28 16}
        [remove_shroud]
            side,x,y,radius=1,28,16,2
        [/remove_shroud]
        {HIGHLIGHT_IMAGE 28 16 items/gohere.png ()}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Rendezvous with $companion_name’s guides"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]

        {VARIABLE unlock_dancing_daggers yes}
        {VARIABLE unlock_contingency     yes}
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
    [/event]

    #############################
    # MEETING THE POACHERS
    #############################
    [event]
        name=side 10 turn refresh
        {FILTER_CONDITION({HAVE_UNIT( id=Delfador {FILTER_LOCATION( x,y,radius=27,17,2 )} )})}
        {FIRE_EVENT activate_poachers}
    [/event]
    [event]
        name=enter hex
        {FILTER(                      id=Delfador {FILTER_LOCATION( x,y,radius=28,15,1 )} )}
        {FIRE_EVENT activate_poachers}
    [/event]
    [event]
        name=activate_poachers
        id=activate_poachers
        {REMOVE_IMAGE 28 16}
        [cancel_action]
        [/cancel_action]

#define SCROLL_REVEAL X Y MS
    {SCROLL_TO {X} {Y}}
    [remove_shroud]
        side,x,y,radius=1,{X},{Y},1
    [/remove_shroud]
    [lift_fog]
        x,y,radius={X},{Y},1
    [/lift_fog]
    {DELAY {MS}}
#enddef
        {MODIFY_UNIT id=$companion_id side 10}
        {SCROLL_REVEAL 30 16 0}
        {MOVE_UNIT id=$companion_id 30 16}
        {MODIFY_UNIT id=$companion_id facing sw}
        [message]
            speaker=Delfador
            message=_"Hey, what—"
        [/message]

        {SCROLL_REVEAL 29 19 0}
        {NAMED_NOTRAIT_UNIT 10 Poacher 29 19 Gonnin _"Gonnin"} {ANIMATE} {FACING nw}
        {ADD_MODIFICATION( {TRAIT_RESILIENT} )}
        {ADD_MODIFICATION( {TRAIT_QUICK} )}

        {SCROLL_REVEAL 23 18 0}
        {NAMED_NOTRAIT_UNIT 10 Poacher 23 18 Milyn _"Milyn"} {ANIMATE} {FACING ne}
        {ADD_MODIFICATION( {TRAIT_INTELLIGENT} )}
        {ADD_MODIFICATION( {TRAIT_QUICK} )}

        {SCROLL_REVEAL 28 15 0}
        {NAMED_NOTRAIT_UNIT 10 Trapper 28 15 Barin _"Barin"} {ANIMATE} {FACING sw}
        {ADD_MODIFICATION( {TRAIT_STRONG} )}
        {ADD_MODIFICATION( {TRAIT_QUICK} )}

        [message]
            speaker=Barin
            message=_"Well well, look what the cat dragged in. You’re a little far from home, scholar!"
        [/message]
        [message]
            speaker=Barin
            message=_"T’would be a shame if som’thin happened to you and your coin-purse... alone, all the way out here..."
        [/message]

        [store_gold]
            side,variable=1,fee
        [/store_gold]
        {VARIABLE_OP fee multiply ({ON_DIFFICULTY4 4 4 4 6})} # 40-60% of your gold. You'll have less gold on Nightmare, so the percentage needs to be higher to stay even
        {VARIABLE_OP fee divide 5} # rounded to the nearest 5
        {VARIABLE_OP fee round -1}
        {VARIABLE_OP fee divide 2}
        [message]
            speaker=Delfador
            message= ""
            [option]
                label= _ "Pay up ($fee gold)"
                [command]
                    {FIRE_EVENT recruit_poachers}
                [/command]
            [/option]
            [option]
                label= _ "Attack"
                [command]
                    {FIRE_EVENT attack_poachers}
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE fee}
    [/event]

    #############################
    # RECRUIT THE POACHERS
    #############################
    [event]
        name=recruit_poachers
        [gold]
            side,amount=1,-$fee
        [/gold]
        {SOUND gold.ogg}

        {MODIFY_UNIT side=10 side 1}
        {MODIFY_UNIT side=11 side 1}
        #         [remove_trait]
        #             id=Barin
        #         [/remove_trait]
        #         [modify_unit]
        #             {FILTER id=Barin}
        #             {TRAIT_LOYAL}
        #             {TRAIT_QUICK}
        #         [/modify_unit]

        [message]
            speaker=Barin
            message=_"Great! Rest easy now that you’ve hired us; we’ll guide you ’round the swamp and make sure nothin’ happens to you or the rest of your coin! $companion_name said yer looking for them lizards, yeah?"
        [/message]

        [store_unit]
            {FILTER( side=2,3,4,5,6,7,8 {AND canrecruit=yes} )}
            variable=saurian_leaders
        [/store_unit]
        [foreach]
            array,variable=saurian_leaders,leader
            [do] {SCROLL_REVEAL $leader.x $leader.y 500}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE saurian_leaders}

        [message]
            speaker=Barin
            message=_"...what, you didn’t think we was trying to rob something, did ye? Naw, I’m your guide. I’d never hurt a friend of $companion_name’s."
        [/message]

        [object]
            {FILTER id=Delfador} duration=turn
            image="misc/blank-hex.png~SCALE(72,72)~BLIT(units/human-outlaws/poacher.png~RC(magenta>red),0,0)"
            name=_"New Recruit:"
            description=_"Poachers are general-purpose nighttime archers, with numerous-but-weak ranged strikes and unusually good defense in swamps."
        [/object]
        [allow_extra_recruit]
            id=Delfador
            extra_recruit=Poacher
        [/allow_extra_recruit]
        {VARIABLE poachers_were_recruited yes}

        #         {UNSTORE_SKILLS} # restore the skills we chose in S07
        #         {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
        {FIRE_EVENT play_main_scenario}
    [/event]

    #############################
    # ATTACK THE POACHERS
    #############################
    [event]
        name=attack_poachers
        {SOUND lightning.ogg}
        {COLOR_ADJUST 127 64 127}
        {DELAY 250}
        {COLOR_ADJUST 0 0 0}
        [message]
            speaker=Delfador
            message=_"Insolent fools, I am no sickly scribe, easy pickings for the robber!"
        [/message]
        [message]
            speaker=Barin
            message=_"Whoah, hey uh, what’s going on?"
        [/message]
        [message]
            speaker=Delfador
            message=_"You bandits trifle with an archmage of Wesnoth, famed and powerful. Step forth and meet your doom!"
        [/message]
        {MODIFY_UNIT id=$companion_id side 11} # don't let Delfador kill Lynyan

        [objectives]
            [objective]
                description= _ "Defeat the bandits"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]

        # if the player hasn't yet picked spells, give them a chance to do so now (since the poachers attack immediately)
        {IF} {VARIABLE_CONDITIONAL wait_to_select_spells equals yes} {THEN(
            {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
        )} {/IF}

        #         {UNSTORE_SKILLS}
        #         {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
        #         {FIRE_EVENT mousemove}
        #         # it's possible for the player to not trigger this until after poachers have already attacked.
        #         # better to just trigger it immediately (before objectives show up) so we're consistent
    [/event]
    [event]
        name=last breath
        {FILTER side=10}
        {FILTER_CONDITION( {HAVE_UNIT( side,count=10,{ON_DIFFICULTY4 2 1 0 0} )} )}
        # on lower difficulties, poachers flee before they're all dead
        [message]
            speaker=$unit.id
            message=_"Ughhh..."
        [/message]
        [event]
            name=die
            {KILL id=$unit.id} # finish off the dying unit, to prevent them from speaking and fleeing

            [message]
                side=10
                message=_"I’m gettin’ out o’ here!"
            [/message]
            {STORE_UNIT_VAR id=Milyn  x x}{MOVE_UNIT id=Milyn  $x 26}{KILL id=Milyn }
            {STORE_UNIT_VAR id=Gonnin x x}{MOVE_UNIT id=Gonnin $x 26}{KILL id=Gonnin}
            {STORE_UNIT_VAR id=Barin  x x}{MOVE_UNIT id=Barin  $x 26}{KILL id=Barin }
            {CLEAR_VARIABLE x}
            {DELAY 500}
            [message]
                speaker=Delfador
                message=_"Serves them right, preying on innocent travelers... Now, where’s these guides of yours we’re going to meet?"
            [/message]
            [message]
                speaker=$companion_id
                message=_"..."
            [/message]
            [message]
                speaker=$companion_id
                message=_"Umm... you know what, I’m thinkin’ we’re better off hunting them saurians all on our lonesomes instead. I’m still gettin’ paid after all this, right?"
            [/message]
            {MODIFY_UNIT id=$companion_id side 1}

            {FIRE_EVENT play_main_scenario}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                   MAIN SCENARIO
    #######################################################################################################################################################
#define SET_OBJECTIVE_PROGRESS PROGRESS_STRING SURPRISE_ATTACK
    [objectives]
        [objective]
            description= _ "Defeat three of the seven saurian leaders {PROGRESS_STRING}"
            condition=win
        [/objective]
        [objective]
            description= _ "Death of Delfador"
            condition=lose
        [/objective]
        {TURNS_RUN_OUT}
        [gold_carryover]
            carryover_percentage,bonus=40,yes
        [/gold_carryover]
        {SURPRISE_ATTACK}
    [/objectives]
#enddef
    [event]
        name=play_main_scenario

        {SET_OBJECTIVE_PROGRESS "(3 remaining)" (
            [note]
                description=_"Surprise attack: The saurians will not spot you until you approach within 4 hexes of a matriarch."
            [/note]
        )}

        {IF} {VARIABLE_CONDITIONAL first_spotted_turn equals $turn_number} {THEN(
            [remove_event]
                id=activate_poachers # in case we spot the saurians before finding the poachers
            [/remove_event]
            {REMOVE_IMAGE 28 16}
            {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
        )} {/IF}
    [/event]

    #############################
    # DELFADOR SPOTS JUVENILES
    #############################
    [event]
        name=sighted
        {FILTER side=9}
        [message]
            speaker=Delfador
            message=_"That saurian has different markings than the others I’ve seen, and is somewhat smaller. A juvenile or invalid, perhaps?"
        [/message]
        [event]
            name=pre attack
            {FILTER_SECOND side=9}
            [message]
                speaker=second_unit
                # po: delfador has just attacked an unarmed saurian
                message=_"The monssstersss hunt usss for sssport! Flee, flee!"
            [/message]
            [message]
                speaker=Delfador
                message=_"They really are unarmed juveniles! Hang on a minute, they’re not dangerous, maybe we should just let them be."
            [/message]
            [cancel_action]
            [/cancel_action]
        [/event]
    [/event]

    #############################
    # SAURIAN SPOTS DELFADOR
    #############################
    [event]
        name=side 2 turn,attack
        {FILTER_CONDITION({HAVE_UNIT(  side=1  {FILTER_VISION side=2,3,4,5,6,7,8 }  {FILTER_LOCATION( radius=4 {FILTER( side=2,3,4,5,6,7,8 {AND(canrecruit=yes)})} )}  )})} # within radius 4 of a matriarch
        # {FILTER_VISION} is used to exclude invisible units, like Huntsmen with Swamp Lurk

        [store_unit]
            {FILTER( side=1  {FILTER_LOCATION( radius=4 {FILTER( side=2,3,4,5,6,7,8 {AND(canrecruit=yes)})} )} )}
            variable=visible_human
        [/store_unit]
        {FIND_NEARBY side=2,3,4,5,6,7,8 $visible_human.x $visible_human.y 99}
        {SCROLL_REVEAL $found_unit.x $found_unit.y 0}
        [message]
            speaker=$found_unit.id
            message=_"We’re under assssault! Sssound the alarm and rally our warriorsss!"
        [/message]
        [message]
            speaker=Delfador
            message=_"They’ve spotted us! The time for stealth is past; now come the fire and the flame!"
        [/message]
        {CLEAR_VARIABLE $found_unit,visible_human}

        {VARIABLE first_spotted_turn $turn_number}
        {FIRE_EVENT activate_saurians}
        {FIRE_EVENT play_main_scenario} # in case we never completed the poachers objective
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # FIRST LEADER DIES
    #############################
    [event]
        name=last breath
        {FILTER( side=2,3,4,5,6,7,8 {AND canrecruit=yes} )}
        {FILTER_CONDITION({HAVE_UNIT(  count,canrecruit=7,yes  )})} # 6 saurians + delfador

        [message]
            speaker=$unit.id
            message=_"Who are you! Why bring death into my homesss..."
        [/message]
        [message]
            speaker=Delfador
            message=_"I am Delfador, war-mage of Wesnoth! Abandon the Blackcrest orcs to death by Wesnoth’s spears, or I will visit upon you the same destruction your allies would bring to us!"
        [/message]
        [message]
            speaker=$unit.id
            message=_"But tribe Earth-Becomes-Clay mussst fight Wesssnoth! The Great One has commanded us!"
        [/message]
        [message]
            speaker=Delfador
            message=_"The “Great One”? I thought you matriarchs ran the show. Tell me, elder, who is this of which you speak?"
        [/message]
        [message]
            speaker=$unit.id
            message=_"We sssauriansss are finally united... the Great One makesss usss... ssstrong..."
        [/message]
        [event]
            name=die
            [message]
                speaker=Delfador
                message=_"Alas, she has expired. Her wounds were too great. But we have learned much — we must capture another matriarch to find out who this ’great one’ is."
            [/message]
            {SET_OBJECTIVE_PROGRESS "(2 remaining)" ()}
        [/event]
    [/event]

    #############################
    # SECOND LEADER DIES
    #############################
    [event]
        name=last breath
        {FILTER( side=2,3,4,5,6,7,8 {AND canrecruit=yes} )}
        {FILTER_CONDITION({HAVE_UNIT(  count,canrecruit=6,yes  )})} # 5 saurians + delfador

        #--------------------
        # DELFADOR APPROACHES SAURIAN
        #--------------------
        [message]
            speaker=Delfador
            message=_"You are beaten, lizard! Your ’great one’ commands you to kill my people; tell me who or what the ’great one’ is, and your life shall be spared."
        [/message]
        [message]
            speaker=$unit.id
            message=_"Curssse you! We are all nothing but wormsss before her... she will dessstroy you in an inferno of flamesss!"
        [/message]
        {STORE_UNIT_VAR id=Delfador x delfadorX}
        {STORE_UNIT_VAR id=Delfador y delfadorY}
        {IF} {NOT({HAVE_UNIT( id=Delfador {FILTER_ADJACENT id=$unit.id} )})} {THEN(
            {MOVE_UNIT id=Delfador $unit.x $unit.y}
        )} {/IF}

        #--------------------
        # CANCEL BUFFS
        #--------------------
        {STORE_UNIT_VAR id=Delfador type delfador_type}
        {FIRE_EVENT skill_polymorph_stoat_cancel}
        {FIRE_EVENT skill_polymorph_bear_cancel}
        {FIRE_EVENT skill_polymorph_crab_cancel}
        {FIRE_EVENT skill_polymorph_roc_cancel}
        [message]
            speaker=Delfador
            message=_"And I shall destroy YOU in an inferno of flames if you don’t tell me what I want to know!"
        [/message]
        {VARIABLE recast_counterspell $counterspell_active}
        {FIRE_EVENT skill_counterspell_cancel}

        #--------------------
        # DELFADOR FIREBALLS SAURIAN
        #--------------------
        [object]
            id,take_only_once=skill_fakefireball,no {FILTER id=Delfador}
            {EFFECT new_attack (
                name,description,icon=fireball,_"fireball",attacks/fireball.png
                range,type,damage,number=ranged,fire,18,4
                [specials]
                    {WEAPON_SPECIAL_MAGICAL}
                [/specials]
            )}
        [/object]

        {ANIMATE_ATTACK id=Delfador name=fireball no  x,y=$unit.x,$unit.y} {DELAY 250}
        {ANIMATE_ATTACK id=Delfador name=fireball no  x,y=$unit.x,$unit.y} {DELAY 250}
        {ANIMATE_ATTACK id=Delfador name=fireball no  x,y=$unit.x,$unit.y} {DELAY 250}
        {ANIMATE_ATTACK id=Delfador name=fireball yes x,y=$unit.x,$unit.y}
        {REMOVE_OBJECT skill_fakefireball id=Delfador}
        [event]
            name=die
            [message]
                speaker=Delfador
                message=_"Wait, what! I wasn’t actually going to— that wasn’t supposed to happen! Where did that fireball come from!"
            [/message]
            [message]
                speaker=Delfador
                message=_"...it seems I’ve spent so much time building my power that I neglected the finer arts of control. Methor would be ashamed... I must redouble my efforts."
            [/message]

            {IF} {VARIABLE_CONDITIONAL delfador_type equals "Frost Stoat"} {THEN({FIRE_EVENT skill_polymorph_stoat})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL delfador_type equals "Cave Bear"  } {THEN({FIRE_EVENT skill_polymorph_bear })}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL delfador_type equals "Giant Crab" } {THEN({FIRE_EVENT skill_polymorph_crab })}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL delfador_type equals "Roc"        } {THEN({FIRE_EVENT skill_polymorph_roc  })}
            {/IF}
            {CLEAR_VARIABLE delfador_type}

            {MOVE_UNIT id=Delfador $delfadorX $delfadorY}

            {IF} {VARIABLE_CONDITIONAL recast_counterspell equals yes} {THEN({FIRE_EVENT skill_counterspell})}
            {/IF}
            {CLEAR_VARIABLE recast_counterspell}

            {SET_OBJECTIVE_PROGRESS "(1 remaining)" ()}
        [/event]
    [/event]

    #############################
    # THIRD LEADER DIES
    #############################
    [event]
        name=last breath
        {FILTER( side=2,3,4,5,6,7,8 {AND canrecruit=yes} )}
        {FILTER_CONDITION({HAVE_UNIT(  count,canrecruit=5,yes  )})} # 4 saurians + delfador

        {IF} {VARIABLE_CONDITIONAL turn_number equals $first_spotted_turn} {THEN({ACHIEVE s08})}
        {/IF}
        {CLEAR_VARIABLE first_spotted_turn}

        {STORE_UNIT_VAR id=Delfador x delfadorX}
        {STORE_UNIT_VAR id=Delfador y delfadorY}
        {IF} {NOT({HAVE_UNIT( id=Delfador {FILTER_ADJACENT id=$unit.id} )})} {THEN(
            {MOVE_UNIT id=Delfador $unit.x $unit.y}
        )} {/IF}
        [message]
            speaker=Delfador
            message=_"Cease your fighting, matriarch, for you have been bested! Heed this warning: answer my questions or be burned to ashes!"
        [/message]
        {FIRE_EVENT skill_polymorph_stoat_cancel}
        {FIRE_EVENT skill_polymorph_bear_cancel}
        {FIRE_EVENT skill_polymorph_crab_cancel}
        {FIRE_EVENT skill_polymorph_roc_cancel}
        {FIRE_EVENT skill_counterspell_cancel}
        {DELAY 250}

        {STORE_SKILLS}
        {VARIABLE skill_levitate yes}
        {VARIABLE skill_fireball3 yes}
        {CLEAR_VARIABLE skill_find_familiar} # otherwise it randomly spawns; I'm not sure why
        {FIRE_EVENT refresh_delfador_skills}
        {ANIMATE_ATTACK id=Delfador range=ranged no x,y=$unit.x,$unit.y} # animate multiple misses to look "threatening"
        {ANIMATE_ATTACK id=Delfador range=ranged no x,y=$unit.x,$unit.y} {DELAY 250}
        {ANIMATE_ATTACK id=Delfador range=ranged no x,y=$unit.x,$unit.y}
        [message]
            speaker=Delfador
            #po: Delfador was worried he would accidentally shoot a fireball, but he didn't
            message=_"(There we go. Both power and control.)"
        [/message]
        [message]
            speaker=$unit.id
            message=_"Mothersss protect me, can it be? Are you a sssecond great dragon of fire!? I am blessssed to sssee sssuch thingsss in my time..."
        [/message]
        [message]
            speaker=Delfador
            message=_"A drago— your great one is a dragon!? ...yes, I am a great dragon as well. Do you not see my fire? Do you not see my flight?"
        [/message]
        {ANIMATE_ATTACK id=Delfador range=ranged no x,y=$unit.x,$unit.y}
        {FIRE_EVENT skill_levitate}

        [message]
            speaker=Delfador
            message=_"Now you shall tell me where I may find the dragon —the other dragon. The two of us have much business together."
        [/message]
        [message]
            speaker=$unit.id
            message=_"Oh, Great One, I hear you and obey! Follow me, and I will guide you to your sister."
        [/message]

        {FULL_HEAL id=$unit.id}
        [modify_unit]
            {FILTER id=$unit.id}
            side=1 {TEAM_COLOR_OVERRIDE () black}
        [/modify_unit]
        {STORE_UNIT_VAR id=$unit.id id saurian_guide_id}

        {UNSTORE_SKILLS}
        {CLEAR_VARIABLE companion_id,companion_name}
        {CLEAR_VARIABLE delfadorX,delfadorY}
        {CLEAR_VARIABLE side2recruit,side3recruit,side4recruit,side5recruit,side6recruit,side7recruit,side8recruit}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=turn {TURNS_LOW_WARNING}
        [message]
            speaker=Delfador
            message=_"Everyone, keep moving! We’re running out of time."
        [/message]
    [/event]
    [event]
        name=turn {TURNS} end

        [modify_side]
            side,color=2,black
        [/modify_side]
        {MODIFY_TERRAIN Ker 17 25}
        {MODIFY_TERRAIN Cer 16 24}
        {MODIFY_TERRAIN Cer 17 24}
        {MODIFY_TERRAIN Cer 18 24}
        {GENERIC_UNIT 2 (Orcish Warlord) 17 25}
        [+unit]
            canrecruit=yes
        [/unit]

        {MODIFY_TERRAIN Ker 15 26}
        {MODIFY_TERRAIN Cer 13 27}
        {MODIFY_TERRAIN Cer 14 25}
        {MODIFY_TERRAIN Cer 14 26}
        {MODIFY_TERRAIN Cer 15 27}
        {GENERIC_UNIT 2 (Saurian Spearthrower) 15 26}
        [+unit]
            canrecruit=yes
        [/unit]

        {MODIFY_TERRAIN Ker 19 26}
        {MODIFY_TERRAIN Cer 18 27}
        {MODIFY_TERRAIN Cer 19 27}
        {MODIFY_TERRAIN Cer 20 26}
        {MODIFY_TERRAIN Cer 20 27}
        {MODIFY_TERRAIN Cer 21 27}
        {GENERIC_UNIT 2 (Orcish Crossbowman) 19 26}
        [+unit]
            canrecruit=yes
        [/unit]

        [remove_shroud]
            side,x,y,radius=1,17,26,6
        [/remove_shroud]
        [lift_fog]
            x,y,radius=17,26,6
        [/lift_fog]

        [message]
            x,y=17,25
            message=_"What’s this? Filthy humans grubbing around in our swamp? These lizards are Blackcrest property!"
        [/message]
        [message]
            x,y=15,26
            message=_"They ssstrike at the matriarchsss! We ssshall ssslay them all!"
        [/message]
        [message]
            speaker=Delfador
            message=_"The main orcish army has caught up to us! Even if we defeat this vanguard and flee onwards, we’ve missed our chance to break the saurian alliance..."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    {HERODEATHS}
[/scenario]

#undef TURNS
#undef TURNS_LOW_WARNING
