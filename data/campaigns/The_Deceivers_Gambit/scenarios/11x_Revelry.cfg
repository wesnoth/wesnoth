#textdomain wesnoth-tdg

[scenario]
    id,map_file,name=11x_Revelry,11x_Revelry.map,_"Revelry"
    next_scenario,victory_when_enemies_defeated=12_The_Traitor,no
    theme=Cutscene_Minimal

    {DEFAULT_SCHEDULE_DUSK}
    {SCENARIO_MUSIC breaking_the_chains.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name=wesnoth
    [/side]

    [side]
        side,controller,color=2,ai,wesred
        type,id,name,facing="Lieutenant",Moreth,_"Moreth",sw
        {MODIFICATIONS( {TRAIT_QUICK} {TRAIT_STRONG} )}
        hidden,gold,income=yes,0,-2
        team_name=wesnoth
    [/side]
    {STARTING_VILLAGES_AREA 2 15 10 9}

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE terrain/castle/encampment/tent2.png  6 12} # these are "keeps"
        {PLACE_IMAGE terrain/castle/encampment/tent2.png 11 14}
        {PLACE_IMAGE items/gold-coins-large.png 14 10} # matching S12

        #############################
        # GUARDS
        #############################
        {GENERIC_UNIT 2 "Pikeman"  10  7} {FACING ne}
        {GENERIC_UNIT 2 "Spearman"  8  8} {FACING nw}
        {GENERIC_UNIT 2 "Pikeman"   8 11} {FACING nw}
        {GENERIC_UNIT 2 "Bowman"   10 11} {FACING ne}
        {GENERIC_UNIT 2 "Spearman" 11 12} {FACING se}

        {GENERIC_UNIT 2 "Swordsman" 23 12} {FACING se}

        {GENERIC_UNIT 2 "Horseman" 15 4} {FACING nw}
        {GENERIC_UNIT 2 "Horseman" 17 5} {FACING ne}
        {GENERIC_UNIT 2 "Knight"   19 5} {FACING ne}

        {GENERIC_UNIT 2 "Bowman"   24 11} {FACING se}
        {GENERIC_UNIT 2 "Spearman" 27 13} {FACING se}

        {GENERIC_UNIT 2 "Spearman"   31 6} {FACING ne}
        {GENERIC_UNIT 2 "Javelineer" 32 6} {FACING ne}
        {GENERIC_UNIT 2 "Spearman"   29 6} {FACING ne}

        #############################
        # REVELERS
        #############################
        {GENERIC_UNIT 2 "Footpad" 13 6} {GENDER female} {FACING se}
        {RECALL_INFANTRYMAN 0 14 7 Fencer {FACING ne}} # this position is used to change side later
        {MODIFY_UNIT x,y=14,7 side 2}
        {GENERIC_UNIT 2 "Thief"   13 7} {GENDER male}   {FACING ne}
        {RECALL_COMPANION 15 7}
        {MODIFY_UNIT id=$companion_id facing nw}
        {MODIFY_UNIT id=$companion_id side 2}

        {GENERIC_UNIT 2 "Mage" 14 12} {GENDER female} {FACING ne}
        {GENERIC_UNIT 2 "Mage" 15 12} {GENDER male}   {FACING sw}

        #############################
        # UNITS
        #############################
        {RECALL_XY Delfador 22 8}
        {MODIFY_UNIT id=Delfador facing sw}
        {GIVE_OBJECT_TO id=Delfador id,duration=at_ease,scenario}
        [modify_unit]
            {FILTER id=Delfador}
            facing=sw
            [filter_recall]
            [/filter_recall]
        [/modify_unit]

        {RECALL_XY Deoran 18 17}
        [modify_unit]
            {FILTER id=Deoran}
            facing=sw
            side=2
            [filter_recall]
            [/filter_recall]
        [/modify_unit]

        [unit]
            {SINGLEUNITWML_GARARD_OLD}
            side,x,y,facing=2,19,10,ne
        [/unit]
        {RESTORE_GARARD}
    [/event]

    #######################################################################################################################################################
    #                                                                   CUTSCENE PART 1
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # THREE CHEERS
        #############################
        {DELAY 500}
        [message]
            speaker=Deoran
            message=_"Three cheers for Delfador, hero of the Abez!"
        [/message]
        [message]
            speaker=Garard
            message=_"Three cheers— three cheers for Delfador the Great! Hurrah!"
        [/message]

        {MODIFY_UNIT x,y=15,7 facing se}
        [message]
            x,y=15,7
            message=_"Hurrah for Delfador!"
        [/message]
        {MODIFY_UNIT x,y=15,7 facing nw}

        {MODIFY_UNIT x,y=10,8 facing se}
        [message]
            x,y=10,8
            message=_"Hooray for Delfador!"
        [/message]
        {MODIFY_UNIT x,y=10,8 facing nw}

        {MODIFY_UNIT x,y=15,12 facing ne}
        [message]
            x,y=15,12
            message=_"Hurrah for Del— *hic* Delfador!"
        [/message]
        {MODIFY_UNIT x,y=15,12 facing sw}

        #############################
        # ALL IS WELL
        #############################
        [message]
            speaker=Garard
            message=_"Oh ho, someone fetch me more wine! The night’s still young; I’m ready for a proper CELEBRATION!!"
        [/message]
        [message]
            speaker=Delfador
            message=_"I started as an inglorious apprentice, without even a name to call my own. And now I have saved Wesnoth from war, and in the process become the king’s most trusted advisor! Truly, this is more than I could have ever hoped for."
        [/message]
        [message]
            speaker=Delfador
            message=_"I’m giddy with joy... or perhaps ’tis also the wine, heh."
        [/message]
        [message]
            speaker=Deoran
            message=_"My friend, you deserve it. Without their saurian allies Clan Blackcrest is on the run, and Clan Whitefang is falling back out of the eastern hills."
        [/message]
        [message]
            speaker=Deoran
            message=_"At long last lift the shadows of war; the realm is finally at peace. Perchance the coming days will bring laughter to the streets of Weldyn once again."
        [/message]
        [message]
            speaker=Delfador
            message=_"For the first time in a long time, all is finally well with the world."
        [/message]

        # this is a bit of a fake-out ending
        # there's still mysteries unresolved, but the characters think they've won
        {SCREEN_FADER 0,0,0 255 3000}
    [/event]

    #######################################################################################################################################################
    #                                                                   CUTSCENE PART 2
    #######################################################################################################################################################
    [event]
        name=side 1 turn
        [lua]
            code = << wesnoth.interface.skip_messages(false) >>
        [/lua]

        #############################
        # REPOPULATE MAP
        #############################
        [replace_schedule]
            {DEFAULT_SCHEDULE_FIRST_WATCH} # same time used in S12
        [/replace_schedule]
        {MODIFY_UNIT x,y=14,7 side 1}
        {MODIFY_UNIT id=$companion_id side 1}
        {PUT_TO_RECALL_LIST side=1}
        {PUT_TO_RECALL_LIST(
            side=2
            {NOT x,y=15,4}
            {NOT x,y=11,12}
            {NOT x,y=10,8}
        )}
        {FADE_MUSIC_OUT 2000}

        #############################
        # DELFADOR USES THE LATRINES
        #############################
        {SCREEN_FADER 0,0,0 0 1000}
        {DELAY 500}
        {RECALL_XY Delfador 16 8}
        {MODIFY_UNIT id=Delfador facing sw}
        [capture_village]
            side,x,y=2,16,8
        [/capture_village]
        [message]
            speaker=Delfador
            message=_"(<i>Yawn</i>)"
        [/message]
        [message]
            speaker=Delfador
            message=_"Ugh, what a headache. I shouldn’t have drunk so much... now nature calls."
        [/message]
        {DELAY 250}
        {MOVE_UNIT id=Delfador 26 5}
        [hide_unit]
            id=Delfador
        [/hide_unit]
        {MODIFY_UNIT id=Delfador facing sw}
        {DELAY 1500}
        [unhide_unit]
            id=Delfador
        [/unhide_unit]
        {DELAY 500}
        [message]
            speaker=Delfador
            #po: Delfador's woken up in the middle of the night to go use the latrines
            message=_"Disgusting. Alduin really needs to invent a spell for cleaning latrines.

Mayhaps as High Advisor I can finally get someone to research that... (<i>yawn</i>)"
        [/message]
        {REPLACE_SCENARIO_MUSIC underground.ogg}
        {FADE_MUSIC_IN 100}
        {MOVE_UNIT id=Delfador 26 6}
        {MOVE_UNIT id=Delfador 25 7}
        {DELAY 500}
        [unit]
            {SINGLEUNITWML_ASHEVIERE}
            side,x,y,facing=2,28,7,sw
            animate=yes
        [/unit]
        {MODIFY_UNIT id=Delfador facing se}
        {DELAY 500}

        #############################
        # DELFADOR MEETS ASHEVIERE
        #############################
        [message]
            speaker=Delfador
            message=_"Oh!"
        [/message]
        [message]
            speaker=Delfador
            message=_"You have startled me, Your Majesty. The darkest hour of night is hardly a queenly time to be about — should you not be asleep with Garard? ’tis not every day that Wesnoth wins a war."
        [/message]
        {DELAY 500}
        [message]
            speaker=Asheviere
            message=_"Hello Delfador — or should I say, “Delfador the Great.”"
        [/message]
        [message]
            speaker=Asheviere
            message=_"Such pleasure to once more speak with my husband’s famous right hand. I never did properly thank you for returning me back to him, all those years ago."
        [/message]
        [message]
            speaker=Asheviere
            message=_"..."
        [/message]
        [message]
            speaker=Asheviere
            message=_"You’re a powerful man, a <i>dangerous</i> man, Delfador. I pity the fool who finds themselves on the wrong end of your staff... yet I oft pity even more so the fool who rules behind it, so consumed by the minutiae of war."
        [/message]
        {DELAY 500}
        [message]
            speaker=Delfador
            message=_"Err... I’m not sure I follow, Your Highness—"
        [/message]

        {RECALL_XY Garard 16 8}
        {MODIFY_UNIT id=Garard facing se}
        {MODIFY_UNIT id=Delfador facing sw}
        {DELAY 250}
        {MOVE_UNIT id=Garard 25 9}
        {MODIFY_UNIT id=Delfador facing se}
        {MOVE_UNIT id=Garard 27 9}
        {DELAY 250}
        [message]
            speaker=Garard
            message=_"What’s going on here? Careful, Delfador — don’t believe a word she says."
        [/message]
        [message]
            speaker=Garard
            message=_"Woman, are you not satisfied with my son; you must have my wizard too!? Away with you, wench, and save your lacquered tongue for another day!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Peace, peace! Wesnoth stands triumphant; there’s no need for quarreling!"
        [/message]
        [message]
            speaker=Asheviere
            message=_"It’s quite all right, Delfador; I take no offense at my husband’s cruel words. Far be it from me to interfere in military matters — the king and his new advisor have doubtless much to speak on. I graciously take my leave."
        [/message]
        {DELAY 250}
        {MOVE_UNIT id=Asheviere 32 9}
        {KILL id=Asheviere}

        #############################
        # GARARD IS SAD
        #############################
        {MODIFY_UNIT id=Garard facing sw}
        {DELAY 750}
        [message]
            speaker=Delfador
            message=_"That seemed a little extreme, m’lord! Surely a little politeness would not go amiss, especially with regards to your own blood! I’ve heard nothing but praise for the queen from most of the court."
        [/message]
        [message]
            speaker=Garard
            message=_"They don’t know her. You don’t know her. All is not well with my family, Delfador."
        [/message]
        {DELAY 250}{MOVE_UNIT id=Garard 26 10}{DELAY 250}
        [message]
            speaker=Garard
            message=_"..."
        [/message]
        [message]
            speaker=Garard
            message=_"My ancestors — the first king and the first queen — led the entire race of men across the ocean to found Wesnoth. Those two understood each other. They saved us all from the terrors of the west. They raised a strong prince, a good son."
        [/message]
        [message]
            speaker=Garard
            message=_"And what of I? This ruinous war, just to satisfy my own ambition? All was nearly lost. Without your magic, all might have been. I’ve made so many mistakes, my friend."
        [/message]
        {DELAY 250}
        {MOVE_UNIT id=Delfador 25 8}
        {MODIFY_UNIT id=Garard facing nw}
        {DELAY 250}
        [message]
            speaker=Delfador
            message=_"No man is without flaws, Your Highness. Certainly not you and I. But I’ve followed you through thick and thin, and together we have always emerged triumphant."
        [/message]
        {DELAY 1500}

        #############################
        # ELDRED ARRIVES
        #############################
        [lua]
            code = << wesnoth.interface.skip_messages(false) >>
        [/lua]
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,38,9,nw
            hitpoints=17
            animate=yes
        [/unit]
        {MOVE_UNIT id=Eldred 37 9}
        {MOVE_UNIT id=Eldred 36 9}
        {MOVE_UNIT id=Eldred 35 9}
        {MODIFY_UNIT id=Garard facing ne}
        [harm_unit]
            {FILTER id=Eldred}
            amount,animate=4,yes
        [/harm_unit]
        {PLACE_IMAGE scenery/blood-1.png 35 9}
        {DELAY 500}
        {MOVE_UNIT id=Eldred 33 10}
        [message]
            speaker=Eldred
            message="<span size='small'>" + _"Father." + "</span>"
        [/message]
        {MOVE_UNIT id=Eldred 32 9} # the same village that Asheviere entered
        [message]
            speaker=Garard
            message=_"Boy? This is a pleasant surprise; I thought you were with your uncle, guarding Fort Garard. Come to celebrate the war’s end with us, did you? It is good to see you again."
        [/message]
        {MOVE_UNIT id=Garard 29 10}
        {MOVE_UNIT id=Delfador 28  9}
        [message]
            speaker=Garard
            message=_"Hold on, what’s the matter with— you’re <b><i>injured</i></b>!? What happened! Where’s that useless Methor when you need him?!"
        [/message]

        #############################
        # NEWS OF THE BETRAYAL
        #############################
        [message]
            speaker=Eldred
            message="<span size='small'>" + _"It’s about your—" + "</span>"
        [/message]
        [message]
            speaker=Eldred
            message=_"..."
        [/message]
        [message]
            speaker=Eldred
            message=_"...Father, it’s Uncle. Prince Arand."
        [/message]
        {DELAY 500}
        [message]
            speaker=Eldred
            #po: Eldred doesn’t show a lot of emotion here. He's lying, and not very good at it
            message=_"He’s found the Sceptre of Fire. He declared his claim to the throne, and seized control of Fort Garard. My bodyguards and I tried to stop him, but we didn’t even get close. I barely made it out alive."
        [/message]
        [message]
            speaker=Eldred
            message=_"Arand tried to kill me, Father. He’s coming for you next."
        [/message]
        {FADE_MUSIC_OUT 1000}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [message]
            speaker=Eldred
            message=_"Garard—?"
        [/message]
        [message]
            speaker=Garard
            message="<b><i>" + _"WHAT!?" + "</i></b>"
        [/message]
        {FADE_MUSIC_IN 100}
        {REPLACE_SCENARIO_MUSIC frantic.ogg}

        #############################
        # GARARD REACTS
        #############################
        [message]
            speaker=Garard
            message=_"That TREASONOUS son-of-a, son-of— I knew something felt suspicious lately."
        [/message]
        [message]
            speaker=Garard
            message=_"It all makes sense now. Arand is my spymaster — of course the spies told me nothing. And Arand warned me that others were searching for the Sceptre... to trick me into sending away Lionel, my most loyal general!"
        [/message]
        {DELAY 250}{MOVE_UNIT id=Garard 28 10}{DELAY 250}
        [message]
            speaker=Garard
            message=_"How DARE he threaten me? How dare he lay a FINGER on my son? I’ll see him hang for this."
        [/message]
        [message]
            speaker=Garard
            message=_"Delfador, take command of the cavalry; my personal royal cavalry — they’re the only ones I still trust. Ride to Fort Garard and burn it to the ground!"
        [/message]
        [message]
            speaker=Garard
            message=_"I want every one of those traitors dead! Return with Arand’s head— his HEAD! Or don’t return at all. Do you understand!?"
        [/message]
        [message]
            speaker=Delfador
            message=_"Yes, Your Majesty!"
        [/message]
        {DELAY 250}
        {MOVE_UNIT id=Delfador 24 8}
        {DELAY 250}
        {MOVE_UNIT id=Garard   31 10}
        {DELAY 500}

        #############################
        # DEORAN RAISES DOUBTS
        #############################
        {RECALL_XY Deoran 25 9}
        {MODIFY_UNIT id=Deoran facing nw}
        {MODIFY_UNIT id=Delfador facing se}
        [message]
            speaker=Deoran
            message=_"Delfador, I couldn’t help but overhear. Prince Arand, the king’s brother?? That can’t be."
        [/message]
        [message]
            speaker=Delfador
            message=_"The young Prince Eldred’s wounds are clear as day, Deoran. Will you ride with us? Every moment we delay is another chance for Arand to rally more rebels to his cause."
        [/message]
        [message]
            speaker=Deoran
            message=_"But a sentence of death, without even trial? Arand is thoughtful and quiet, and not known to be ambitious."
        [/message]
        [message]
            speaker=Deoran
            #po: this mirrors Methor's request to Lionel in S10x
            message=_"The king has commanded his death, yes. But you are the one sent to carry it out. You don’t... <b><i>have</i></b> to go, you know. At least not so hastily."
        [/message]
        [message]
            speaker=Deoran
            message=_"Refuse Garard’s order. Hold back, dispatch scouts, and gather more information before committing so much of the army to this attack. Wesnoth can scant afford a civil war, and certainly not so soon after the orcs!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Are you mad?! It’s neither your place nor mine to second-guess His Majesty. Especially not now, when he needs loyalty more than ever."
        [/message]
        [message]
            speaker=Deoran
            message=_"Delfador, I really worry—"
        [/message]
        [message]
            speaker=Delfador
            message=_"And... besides, I’ve lived half my life fighting alongside the king, fighting to gain his favor. Today I’m “The Great”, but I didn’t even have a name before I first began to battle."
        [/message]
        [message]
            speaker=Delfador
            message=_"Without that, who am I? I don’t want to end up exiled, like you were..."
        [/message]
        {DELAY 500}

        #############################
        # DELFADOR GOES TO WAR
        #############################
        {MOVE_UNIT id=Delfador 21 9}
        {MODIFY_UNIT id=Delfador facing ne}
        # spawn royal cavalry: similar as the units we start with in S11
        [unit]
            type=Knight
            id,name=Kaylan,_"Sir Kaylan" # this is Sir Kaylan from HttT's Blackwater Port, but younger
            [modifications]
                {TRAIT_LOYAL}{TRAIT_STRONG}
                {TEAM_COLOR_OVERRIDE () green}
                [object] {EFFECT profile portrait="portraits/humans/grand-knight-2.webp"}
                [/object]
            [/modifications]
            x,y,facing,animate=19,9,ne,yes
            side=2
        [/unit]
        {GENERIC_UNIT 2 Horseman   18 10} {FACING ne} {ANIMATE}
        {GENERIC_UNIT 2 Cavalryman 18  8} {FACING ne} {ANIMATE}
        {GENERIC_UNIT 2 Cavalryman 17  8} {FACING ne} {ANIMATE}
        {GENERIC_UNIT 2 Horseman   16  9} {FACING ne} {ANIMATE}
        {GENERIC_UNIT 2 Cavalryman 14  8} {FACING ne} {ANIMATE}
        {GENERIC_UNIT 2 Horseman   14  9} {FACING ne} {ANIMATE}
        {MODIFY_UNIT id=Delfador facing se}
        [message]
            speaker=Delfador
            message=_"Royal cavalry, form up on me! We go at once!"
        [/message]

        #############################
        # CLEANUP
        #############################
        {MODIFY_UNIT id=Deoran side 1}
        [store_unit]
            {FILTER id=Deoran}
            variable,kill=stored_deoran,yes
        [/store_unit]
        [store_unit]
            {FILTER( side=1 {NOT id=Delfador,familiar} )}
            variable,kill=stored_units_s10x,yes
        [/store_unit]

        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 100}
            carryover_report,linger_mode,replay_save=no,no,no
        [/endlevel]
    [/event]
[/scenario]
