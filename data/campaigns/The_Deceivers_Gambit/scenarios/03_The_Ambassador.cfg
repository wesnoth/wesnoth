#textdomain wesnoth-tdg

#
# Who's really the titular ambasasdor here?
# Is it Deoran, who only appears at the end?
# Or is it Delfador, who tries but messes things up with the woses.
# Beats me.
#

[scenario]
    id,map_file,name=03_The_Ambassador,03_The_Ambassador.map,_"The Ambassador"
    next_scenario,victory_when_enemies_defeated=04_The_Sylvan_Seer,no
    {DEFAULT_SCHEDULE} turns=30
    {SCENARIO_MUSIC knolls.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}

    {DE_TRACK {JOURNEY_03_NEW}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition=Delfador,never
        gold=50
        team_name,user_team_name=wesnoth,_"Isle of Alduin"
        {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES_AREA 1 17 23 0}

    #############################
    # WOSES
    #############################
    # remember that for new players, this might be their first time encountering both ambush and regenerates.
    # so don't make the woses too challenging.
    [side]
        side,controller,color=2,ai,green
        no_leader=yes
        team_name,user_team_name=forest,_"Woses"
        # in contrast to the last scenario's swarmy l0/l1 goblins, the woses recruit only a small number of powerful l2 units
        recruit={ON_DIFFICULTY4 "Wose" "Wose" "Wose Shaman" "Wose Shaman"}
        gold=0 # spwn units during the initial cutscene instead
        income={ON_DIFFICULTY4 -2 2 6 10} # 6 initial villages, but Delfador can capture 1-2 of them easily
        [ai]
            # woses are very slow, and there's very few of them
            {NO_SCOUTS}
        [/ai]
    [/side]
    # prefer Wose Shamans, as they're 1) less countered by Mages, so the player is encouraged to use more diverse units, and 2) less likely to randomly 1-shot a player unit, which is never fun to play against
    {LIMIT_CONTEMPORANEOUS_RECRUITS  2 "Elder Wose" ({ON_DIFFICULTY4 0 0 1 1})}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 offensive 0.4 0.25}
        {MODIFY_SIDE_AI 2 retreat_factor=0.99}
        {AUTOENRAGE 2 0}

        # avoid any hexes that aren't forest, village, castle or keep,
        # unless there's an adjacent enemy who we're probably moving to attack
        #         {MODIFY_SIDE_AI 2 (
        #             [avoid]
        #                 {NOT terrain=*^F*,*^V*,*^K*,*^C*}
        #                 {NOT({FILTER_ADJACENT_LOCATION({FILTER side=1})})}
        #             [/avoid]
        #         )}
    [/event]
    # dummy side for Deoran and his elves
    [side]
        side,controller,color=3,ai,green
        no_leader,hidden=yes,yes
        team_name=forest
    [/side]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {PLACE_IMAGE scenery/keep-overlay-high.png  27 9}
        {PLACE_IMAGE scenery/keep-overlay-low.png   27 8}
        {PLACE_IMAGE scenery/keep-overlay-low.png   26 8}
        {PLACE_IMAGE scenery/keep-overlay-low.png   26 9}

        {PLACE_IMAGE scenery/dwarven-keep-tile.png  16  7}
        {PLACE_IMAGE scenery/dwarven-keep-tile.png  25 17}

        #############################
        # DELFADOR
        #############################
        {RECALL_XY Delfador 13 26}
        {MODIFY_UNIT id=Delfador facing nw}
        [set_extra_recruit]
            id=Delfador
            extra_recruit={DELFADOR_MIDDLE_RECRUIT}
        [/set_extra_recruit]
    [/event]

    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # EXPLAINING MESSENGER DUTY
        #############################
        [message]
            speaker=Delfador
            message=_"When King Garard spoke of a special mission for me, I hadn’t been expecting something as quiet as messenger duty." + "

" + _ "But I won’t disappoint him. I am to find Wesnoth’s ambassador to Lintanir Forest, and then deliver to the elves a notice."
        [/message]
        {MOVE_UNIT id=Delfador 11 24}
        {MOVE_UNIT id=Delfador 12 21}
        {MODIFY_UNIT id=Delfador facing nw}
        {SCROLL_TO 24 1}
        [message]
            speaker=Delfador
            scroll=no
            message=_"The elvish border should be some distance northeast of here, through this cluster of trees. The undergrowth is so thick... Perhaps this is an opportunity to practice my new fire spell."
        [/message]

        #############################
        # BURNING A PATH
        #############################
        {SCROLL_TO 11 21}
        {DELAY 250}

        {STORE_SKILLS}
        {VARIABLE skill_fireball2 yes}
        {FIRE_EVENT refresh_delfador_skills}

        {ANIMATE_ATTACK id=Delfador name=fireball yes x,y=11,21}
        {MODIFY_TERRAIN Gd^Fdw 11 21}
        [redraw][/redraw]
        {DELAY 500}

        {ANIMATE_ATTACK id=Delfador name=fireball yes x,y=11,21}
        {MODIFY_TERRAIN Gd 11 21}
        [redraw][/redraw]
        {DELAY 500}

        {MOVE_UNIT id=Delfador 11 20}
        {ANIMATE_ATTACK id=Delfador name=fireball yes x,y=10,19}
        {MODIFY_TERRAIN Gd^Fdw 10 19}
        [redraw][/redraw]
        {DELAY 500}

        {ANIMATE_ATTACK id=Delfador name=fireball yes x,y=10,19}
        {MODIFY_TERRAIN Gd 10 19}

        {SOUND wose-create.wav}
        {NAMED_UNIT 2 ({ON_DIFFICULTY4 "Elder Wose" "Elder Wose" "Ancient Wose" "Ancient Wose"}) 10 19 leader2 _"Eldebetam" canrecruit=yes} {ANIMATE} {FACING se}
        [harm_unit]
            {FILTER id=leader2}
            amount=12
            animate=yes
            delay=0
        [/harm_unit]
        [capture_village]
            side=2
            x,y,radius=21,7,10
        [/capture_village]

        #############################
        # WOSE IS ANGRY
        #############################
        [message]
            speaker=leader2
            message=_"Boruroom! Burarum!"
        [/message]
        [message]
            speaker=Delfador
            message=_"What?! The tree speaks!"
        [/message]
        [message]
            speaker=Delfador
            message=_"I’ve heard tell of tree-folk... you must be a wose! Err, I’m terribly sorry for the fireball. I couldn’t tell you apart from an ordinary oak."
        [/message]
        [message]
            speaker=leader2
            message=_"Burarum! Boom-toom-hun-rum-tum-ala-lola-ala?"
        [/message]
        [message]
            speaker=leader2
            message=_"A-rumgur-gurmum-un-rumba-ala-burarum! Burarum-ala-bortum-untum! A-rumgur-gurmum-un-rumba-ala-boruroom! BURARUM!!"
        [/message]
        [message]
            speaker=Delfador
            message=_"It can’t understand me, and I can’t understand it... Oh no..."
        [/message]
        # take a specific path, so that we avoid forest and stay visible
        {MOVE_UNIT id=leader2 10 17}
        {MOVE_UNIT id=leader2 21 12}
        {MOVE_UNIT id=leader2 21 11}
        {MOVE_UNIT id=leader2 23 10}
        {MOVE_UNIT id=leader2 23  9}
        {MOVE_UNIT id=leader2 25  8}
        {MOVE_UNIT id=leader2 27  9}
        {MODIFY_UNIT id=leader2 facing sw}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "Wose" "Wose" "Wose Shaman" "Wose Shaman"} 26 9 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none" "Wose" "Wose"        "Wose Shaman"} 26 8 {ANIMATE}}
        [message]
            speaker=Delfador
            scroll=no
            message=_"They’re preparing to attack! I’m not afraid of a few walking willows, but burning down half the forest would hardly be the good first impression King Garard tasked me with making." + "

" + _ "I’m sure Methor would know what to do here. But I don’t. I think we have no choice but to fight."
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat the enemy leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]

        {VARIABLE unlock_fireball2 yes}
        {VARIABLE unlock_blizzard  yes}
        {VARIABLE unlock_polymorph yes}
        {UNSTORE_SKILLS}
        {RESELECT_SKILLS_AFTER_OBJECTIVES (
            [object]
                {FILTER id=Delfador} duration=turn
                image="units/woses/wose-elder.png~RC(magenta>green)"
                description=_"Woses have the <i>ambush</i> ability, making them invisible while in forest. Any unit can temporarily reveal a wose by moving adjacent to it, but the revealer will not be able to move afterwards — even if you have the <i>skirmisher</i> ability. Ambushers will go back into hiding the moment you move away (even if the ambusher hasn’t moved).

Woses also have the powerful <i>regeneration</i> ability, and have high resistance to several types of damage. <i><b>Make sure you recruit units with effective damage types!</b></i> To see more details, right-click on a wose and select <i>“Unit Type Description”.</i>"
            [/object]
        ) ()}
    [/event]

    #############################
    # AMBUSH HINT
    #############################
    [event]
        name=turn 4
        [message]
            speaker=Delfador
            message=_"Where are those woses hiding? If I’m worried about my valuable veterans getting ambushed, I could use new recruits as expendable pickets."
        [/message]
    [/event]

    #############################
    # LIGHT BRAZIER (COSMETIC)
    #############################
    [event]
        name=moveto
        {FILTER side,x,y=1,3,17}
        {MODIFY_TERRAIN Rb^Ebn 3 17}
        [item]
            x,y,halo=3,17,halo/fire-aura-small.png
        [/item]
        [time_area] # illuminate everything in a 1 tile radius
            id=brazier1
            x,y,radius=3,17,1
            current_time=$( ($turn_number-1) % 6 )
            {ILLUMINATED_TZ_DAWN}
            {ILLUMINATED_TZ_MORNING}
            {ILLUMINATED_TZ_AFTERNOON}
            {ILLUMINATED_TZ_DUSK}
            {ILLUMINATED_TZ_FIRSTWATCH}
            {ILLUMINATED_TZ_SECONDWATCH}
        [/time_area]
        [time_area] # undo illumination in a 0 tile radius (braizer already illuminates)
            x,y,radius=3,17,0
            current_time=$( ($turn_number-1) % 6 )
            {DEFAULT_SCHEDULE}
        [/time_area]
    [/event]

    #############################
    # DEAD TREE
    #############################
    [event]
        name=moveto
        {FILTER side,x,y=1,1,24}
        [message]
            speaker=Delfador
            message=_"This hollow tree is full of bats!"
        [/message]
        {GENERIC_UNIT 2 "Vampire Bat" 1 25} {ANIMATE} # the positioning of these ZoCs the player's unit
        {GENERIC_UNIT 2 "Blood Bat"   2 23} {ANIMATE}
    [/event]

    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=die
        {FILTER side=2}
        {VARIABLE failed_achievement yes}
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # WOSE LEADER DEFEATED
    #############################
    [event]
        name=last breath
        {FILTER id=leader2}
        [if]
            {VARIABLE_CONDITIONAL failed_achievement not_equals yes}
            {THEN({ACHIEVE s03})}
        [/if]
        {CLEAR_VARIABLE failed_achievement}

        # manually award XP to whoever killed the wose, since we heal the wose at the end of this cutscene (because Delfador ends up making peace with the woses)
        [modify_unit]
            {FILTER id=$second_unit.id}
            experience="$( $this_unit.experience + $unit.level*8 )"
        [/modify_unit]
        [message]
            speaker=leader2
            message=_"Ooohhhhoooom... Burarum..."
        [/message]

        #--------------------
        # DEORAN ARRIVES
        #--------------------
        {GENERIC_UNIT 3 "Elvish Marksman" 23 1} {ANIMATE} {FACING sw}
        {GENERIC_UNIT 3 "Elvish Champion" 26 1} {ANIMATE} {FACING sw}
        [unit]
            {SINGLEUNITWML_DEORAN}
            side=3
            x,y=24,1
            facing=sw
        [/unit]
        [message]
            speaker=Deoran
            message=_"Halt!! Who are you, and why do you trouble the trees of the Grey Grove? Speak, strangers, for the wrath of Wesnoth and the Lintanir elves is upon you!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Peace! Peace! You must be the man King Garard sent me to meet: Ambassador Deoran."
        [/message]
        [modify_side]
            side=3
            team_name=wesnoth
        [/modify_side]
        [message]
            speaker=Delfador
            message=_"Please, can you speak with these woses and tell them we’re not their enemies? This whole battle has been a terrible misunderstanding."
        [/message]
        [message]
            speaker=Deoran
            message=_"You’re a courier from Wesnoth? My apologies for the harsh words; long has it been since Weldyn sent to this lonely post."
        [/message]
        [message]
            speaker=Deoran
            message=_"But apology alone will not make right your transgressions against this rare and precious wose-grove. If you really are who you claim to be, explain yourself to me at once."
        [/message]

        {MODIFY_UNIT id=Deoran side 1}
        {FULL_HEAL id=leader2}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=time over
        [message]
            speaker=leader2
            message=_"Burarum! A-rumgur-gurmum-un-rumba-ala-burarum! Burarum-ala-bortum-untum! A-rumgur-gurmum-un-rumba-ala-boruroom!"
        [/message]
        # place the woses on non-forest hexes, so Delfador can see them
        {GENERIC_UNIT 2 Wose 16  3} {ANIMATE}
        {GENERIC_UNIT 2 Wose 13  5} {ANIMATE}
        {GENERIC_UNIT 2 Wose 23  6} {ANIMATE} {ROLE young_wose}
        {GENERIC_UNIT 2 Wose 27  5} {ANIMATE}
        {GENERIC_UNIT 2 Wose 26 10} {ANIMATE}
        [message]
            role=young_wose
            message= _"Boom-toom-hun-rum-tum-ala-lola-ala! Burarum! Boruroom!"
        [/message]
        [message]
            speaker=Delfador
            message=_"There’s more of them than I realized! And they’re really angry now! Even if I could fight my way through, the elves would never trust me after such a show of force..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    {HERODEATHS}
[/scenario]
