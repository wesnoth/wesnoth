#textdomain wesnoth-tdg

[scenario]
    id,map_file,name=14_Long_Live_the_Queen,14_Long_Live_the_Queen.map,_"Long Live the Queen"
    victory_when_enemies_defeated=no
    {DEFAULT_SCHEDULE} turns=-1
    {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}

    {DE_TRACK {JOURNEY_13_NEW}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name,user_team_name=delfador,_"Delfador’s Rebels"
        {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES_AREA 1 45 1 5}

    #############################
    # ELDRED STEALS ALL RECRUITS
    #############################
    # having all these separate sides causes a lot of lag, probably because of {VARY_AI_SCHEDULE}
    # steal all their units for Eldred to speed up the AI
    [event]
        name=unit placed
        first_time_only=no
        [filter]
            side=3,4,5,6,7
            canrecruit=no
        [/filter]
        {MODIFY_UNIT id=$unit.id side 2}
    [/event]

    # redefine this macro to care about Eldred's unit count instead of the actual side that's recruiting
#define LIMIT_LOYALIST_RECRUITS SIDES TYPE LIMIT_NUMBER
    [event]
        name=unit placed,die
        first_time_only=no
        {FILTER side=2,3,4,5,6,7}
        {IF} {HAVE_UNIT side,type,count=2,{TYPE},"{LIMIT_NUMBER}-infinity"} {THEN(
            [disallow_recruit]
                side={SIDES}
                type={TYPE}
            [/disallow_recruit]
        )} {ELSE(
            [allow_recruit]
                side={SIDES}
                type={TYPE}
            [/allow_recruit]
        )} {/IF}
    [/event]
#enddef

    #############################
    # ELDRED
    #############################
    [side]
        side,controller,color=2,ai,wesred
        no_leader,gold,income=yes,{ON_DIFFICULTY4 50 100 200 200},{ON_DIFFICULTY4 3 8 18 18} # reminder that eldred has 100% of the upkeep, so he needs a lot of income
        recruit=Heavy Infantryman
        team_name,user_team_name=eldred,_"King Eldred" {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_LOYALIST_RECRUITS 2 "Swordsman"   {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_LOYALIST_RECRUITS 2 "Javelineer"  {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_LOYALIST_RECRUITS 2 "Royal Guard" {ON_DIFFICULTY4 0 0 1 1}}
    {STARTING_VILLAGES_AREA 2 15 24 12}
    [event]
        name=prestart
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,24,20,se
            canrecruit=yes
        [/unit]
        {GIVE_OBJECT_TO id=Eldred ({EFFECT overlay remove=misc/hero-icon.png})}
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,27,21,se
            canrecruit=yes
        [/unit]
    [/event]
#define DELETE_SIDE8_MAI ID
    [micro_ai]
        side,action,ai_type=8,delete,zone_guardian
        ca_id={ID}
    [/micro_ai]
#enddef
    [event]
        name,first_time_only=side 2 turn,no
        {RESET_SIDE_AI 2 defensive 0.8 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 2 1}
        {MODIFY_SIDE_AI 2 (
            [avoid]
                x,y=21,24 # don't let units heal on Eldred's reserved village
            [/avoid]
        )}

        #--------------------
        # SHOULD ELDRED RETREAT?
        #--------------------
        # if injured, Eldred should flee and heal. This prevents Delfador from solo-killing him
        {IF} {VARIABLE_CONDITIONAL eldred_ai equals recruit} {THEN(
            {IF}      {HAVE_UNIT id,formula=Eldred,"(self.hitpoints < self.max_hitpoints)"}
            {HAVE_UNIT(                        id=Delfador  {FILTER_ADJACENT id=Eldred} )} # only trigger retreat if Delfador is trying to do a "heroic duel" (matching voiceline)
            {NOT({HAVE_UNIT( side,count=1,2-99 {NOT id=Delfador} {FILTER_ADJACENT id=Eldred} )})}
            {THEN({VARIABLE eldred_ai retreat})}
            {ELSE({VARIABLE eldred_ai recruit})}
            {/IF}
            # if we're not currently retreating and the player already has units in the retreat area, don't try to retreat
            {IF} {HAVE_UNIT side,x,y=1,20-22,22-99}{THEN( {VARIABLE eldred_ai recruit} )}
            {/IF}
        )} {ELSE(
            {IF} {HAVE_UNIT id,formula=Eldred,"(self.hitpoints = self.max_hitpoints)"}
            {THEN({VARIABLE eldred_ai recruit})}
            {ELSE({VARIABLE eldred_ai retreat})}
            {/IF}
        )} {/IF}

        #--------------------
        # IMPLEMENT RETREAT
        #--------------------
        [micro_ai]
            side,action,ai_type=2,delete,zone_guardian
            ca_id=eldred_mai
        [/micro_ai]
        {IF} {VARIABLE_CONDITIONAL eldred_ai equals recruit} {THEN(
            #--------------------
            # STAND ON HIS KEEP
            #--------------------
            [micro_ai]
                side,action,ai_type=2,add,zone_guardian
                ca_id=eldred_mai
                {FILTER id=Eldred}
                station_x,station_y=24,20
                {FILTER_LOCATION( x,y,radius=24,20,1 )}
            [/micro_ai]

            #--------------------
            # DELETE RETREATGUARD MAIS
            #--------------------
            {DELETE_SIDE8_MAI retreatguard0}
            {DELETE_SIDE8_MAI retreatguard1}
            {DELETE_SIDE8_MAI retreatguard2}
            {DELETE_SIDE8_MAI retreatguard3}
            {DELETE_SIDE8_MAI retreatguard4}
            {DELETE_SIDE8_MAI retreatguard5}
            {DELETE_SIDE8_MAI retreatguard6}
        )}

        {ELSE(
            {FIRE_EVENT explain_eldred_retreat}
            #--------------------
            # RETREAT TO THE NEARBY VILLAGE
            #--------------------
            # we use [avoid] on every side to ensure nobody else takes this village before Eldred
            [micro_ai]
                side,action,ai_type=2,add,zone_guardian
                ca_id=eldred_mai
                {FILTER id=Eldred}
                station_x,station_y=21,24
                {FILTER_LOCATION x,y,radius=21,24,1}
            [/micro_ai]

            #--------------------
            # CLEAR BODYGUARD MAIs
            #--------------------
            # we don't bother re-adding these later, as it's unlikely Eldred will manage to retreat twice in one scenario
            {DELETE_SIDE8_MAI bodyguard0}
            {DELETE_SIDE8_MAI bodyguard1}
            {DELETE_SIDE8_MAI bodyguard2}
            {DELETE_SIDE8_MAI bodyguard3}
            {DELETE_SIDE8_MAI bodyguard4}
            {DELETE_SIDE8_MAI bodyguard5}
            {DELETE_SIDE8_MAI bodyguard6}

            #--------------------
            # CREATE NEW BODYGUARD MAIs
            #--------------------
#define STATION_BODYGUARD CA_ID X Y
    [micro_ai]
        side,action,ai_type=8,add,zone_guardian
        ca_id={CA_ID}
        {FILTER id=$this_item.id}
        station_x,station_y={X},{Y}
        {FILTER_LOCATION( x,y,radius=21,24,2 {OR({FILTER_ADJACENT_LOCATION({FILTER id=Eldred})})} )}
    [/micro_ai]
#enddef
            {IF} {HAVE_UNIT id,x,y=Eldred,21,24} {THEN(
                [store_unit]
                    {FILTER role=bodyguard}
                    variable=stored_bodyguards
                [/store_unit]
                [foreach]
                    array=stored_bodyguards
                    [do]
                        {IF}{VARIABLE_CONDITIONAL i equals 0}{THEN({STATION_BODYGUARD retreatguard0 22 23})}
                        {/IF}
                        {IF}{VARIABLE_CONDITIONAL i equals 1}{THEN({STATION_BODYGUARD retreatguard1 21 23})}
                        {/IF}
                        {IF}{VARIABLE_CONDITIONAL i equals 2}{THEN({STATION_BODYGUARD retreatguard2 23 24})}
                        {/IF}
                        {IF}{VARIABLE_CONDITIONAL i equals 3}{THEN({STATION_BODYGUARD retreatguard3 20 23})}
                        {/IF}
                        {IF}{VARIABLE_CONDITIONAL i equals 4}{THEN({STATION_BODYGUARD retreatguard4 19 24})}
                        {/IF}
                        {IF}{VARIABLE_CONDITIONAL i equals 5}{THEN({STATION_BODYGUARD retreatguard5 20 22})}
                        {/IF}
                        {IF}{VARIABLE_CONDITIONAL i equals 6}{THEN({STATION_BODYGUARD retreatguard6 24 23})}
                        {/IF}
                    [/do]
                [/foreach]
                {CLEAR_VARIABLE stored_bodyguards}
            )} {/IF}
        )}{/IF}
    [/event]
    [event]
        name=explain_eldred_retreat
        [message]
            speaker=Eldred
            message= _ "A heroic duel, Delfador? Really? You forget that I have an army on my side."
        [/message]
    [/event]

    #############################
    # ARMY OF WESNOTH
    #############################
#define ELDRED_SIDE SIDE TYPE X Y ID TRAITS RECRUIT_LIST GOLD INCOME
    [side]
        side,controller,color={SIDE},ai,wesred
        type,id,x,y,facing={TYPE},{ID},{X},{Y},ne {MODIFICATIONS( {TRAITS} )}
        gold,income,recruit={GOLD},{INCOME},{RECRUIT_LIST}
        team_name,user_team_name=eldred,_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES_AREA {SIDE} {X} {Y} 4}
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
    [event]
        name,first_time_only=side {SIDE} turn,no
        {RESET_SIDE_AI {SIDE} defensive 0.8 0.25} # stay defensive; don't rush the player all at once or we'll overwhelm them
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME {SIDE} 1}
        {MODIFY_SIDE_AI {SIDE} (
            [avoid]
                x,y=21,24 # don't let units heal on Eldred's reserved village
            [/avoid]
        )}
    [/event]
#enddef
#define ELDRED_UNIT SIDE TYPE X Y ID WML TRAITS
    [event]
        name=prestart
        [unit]
            side,type,id,x,y={SIDE},{TYPE},{ID},{X},{Y}
            canrecruit=yes {MODIFICATIONS( {TRAITS} )}
            {WML}
        [/unit]
    [/event]
#enddef
    {ELDRED_SIDE 3 "Iron Mauler"    33 21 eldred3     ({TRAIT_RESILIENT}  {TRAIT_STRONG}   ) "Heavy Infantryman" {ON_DIFFICULTY4 12 25  50  50} {ON_DIFFICULTY4 -1 1 3 3}}
    {LIMIT_LOYALIST_RECRUITS 3 "Shock Trooper" {ON_DIFFICULTY4 0 1 1 1}}

    {ELDRED_SIDE 4 "Javelineer"     21 19 eldred4     ({TRAIT_STRONG}     {TRAIT_RESILIENT}) "Heavy Infantryman" {ON_DIFFICULTY4 12 25  50  50} {ON_DIFFICULTY4 -1 1 3 3}}
    {LIMIT_LOYALIST_RECRUITS 4 "Javelineer"    {ON_DIFFICULTY4 1 1 2 2}}

    {ELDRED_SIDE 5 "Swordsman"      56 24 eldred5a    ({TRAIT_STRONG}     {TRAIT_RESILIENT}) "Spearman"          {ON_DIFFICULTY4 37 75 150 150} {ON_DIFFICULTY4 2 6 10 10}}
    {ELDRED_UNIT 5 "Master at Arms" 50 23 eldred5b () ({TRAIT_RESILIENT}  {TRAIT_STRONG}   )}
    {ELDRED_UNIT 5 "Lieutenant"     42 20 eldred5c () ({TRAIT_INTELLIGENT}{TRAIT_RESILIENT})}
    {LIMIT_LOYALIST_RECRUITS 5 "Bowman"     {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_LOYALIST_RECRUITS 5 "Pikeman"    {ON_DIFFICULTY4 0 1 2 2}}
    {LIMIT_LOYALIST_RECRUITS 5 "Fencer"     {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_LOYALIST_RECRUITS 5 "Duelist"    {ON_DIFFICULTY4 0 0 1 1}}
    {STARTING_VILLAGES_AREA 5 42 22 3}

    {ELDRED_SIDE 6 "Lieutenant"   14 13 eldred6a    ({TRAIT_RESILIENT}  {TRAIT_STRONG}     ) "Bowman"            {ON_DIFFICULTY4 37 75 150 150} {ON_DIFFICULTY4 2 6 10 10}}
    {ELDRED_UNIT 6 "Silver Mage"   8 11 eldred6b gender=female ({TRAIT_QUICK}{TRAIT_RESILIENT})}
    {ELDRED_UNIT 6 "Master Bowman" 3  9 eldred6c () ({TRAIT_INTELLIGENT}{TRAIT_RESILIENT})}
    {LIMIT_LOYALIST_RECRUITS 6 "Mage"       {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_LOYALIST_RECRUITS 6 "Red Mage"   {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_LOYALIST_RECRUITS 6 "Spearman"   {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_LOYALIST_RECRUITS 6 "Longbowman" {ON_DIFFICULTY4 0 0 1 1}}
    {LIMIT_LOYALIST_RECRUITS 6 "Swordsman"  {ON_DIFFICULTY4 0 1 2 2}}
    {STARTING_VILLAGES_AREA 6 5 16 3}

    {ELDRED_SIDE 7 "Longbowman"   39 11 eldred7    ({TRAIT_RESILIENT}{TRAIT_STRONG}        ) "Spearman"          {ON_DIFFICULTY4 12 25  50  50} {ON_DIFFICULTY4 -1 1 3 3}}
    {LIMIT_LOYALIST_RECRUITS 7 "Bowman"     {ON_DIFFICULTY4 1 1 2 2}}
    {STARTING_VILLAGES_AREA 7 36 12 5}

    #############################
    # GUARDS
    #############################
    # use a separate, hidden side, so that:
    #  1) guards won't interefere with LIMIT_CONTEMPORANEOUS_RECRUITS
    #  2) we don't have to worry about upkeep
    [side]
        side,controller,color=8,ai,wesred
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=eldred,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]

    #############################
    # BANDITS
    #############################
    [side]
        side,controller,color=9,ai,blue
        type,id,x,y,facing=Bandit,bandit9a,50,15,ne
        {MODIFICATIONS( {TRAIT_RESILIENT}{TRAIT_STRONG} )}
        gold,income={ON_DIFFICULTY4 15 30 60 60},{ON_DIFFICULTY4 1 4 10 10}
        recruit=Ruffian
        team_name,user_team_name=eldred,_"Wesnoth Auxiliaries" {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 9 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Peasant" {ON_DIFFICULTY4 1 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Thug"    {ON_DIFFICULTY4 0 1 3 3}} # 1 guard on Hard/Nightmare
    {STARTING_VILLAGES_AREA 9 51 13 0}

    [side]
        side,controller,color=10,ai,blue
        type,id,x,y,facing=Trapper,bandit10a,17,6,se
        {MODIFICATIONS( {TRAIT_STRONG}{TRAIT_RESILIENT} )}
        gold,income={ON_DIFFICULTY4 25 50 100 100},{ON_DIFFICULTY4 1 4 10 10}
        recruit=Woodsman
        team_name,user_team_name=eldred,_"Wesnoth Auxiliaries" {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=prestart
        [unit]
            side,x,y,facing=10,11,3,sw
            type,id,canrecruit=Poacher,bandit10b,yes
        [/unit]
    [/event]
    {SILENTLY_LIMIT_LEADER_MOVES 10 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Peasant" {ON_DIFFICULTY4 1 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Poacher" {ON_DIFFICULTY4 0 1 4 4}} # 2 guards on Hard/Nightmare
    {STARTING_VILLAGES_AREA 10 14 3 3}

    [event]
        name,first_time_only=side 9 turn,no
        {RESET_SIDE_AI 9,10 offensive 0.8 0.25}
        # conscripts just rush in with no schedule variation - they have both lawful and chaotic units, and are 'untrained' besides
    [/event]

    # if Delfador destroys a leader's keep with Cataclysm, remove their leader status so they charge in and attack
#define ENRAGE_IF_NO_KEEP SIDE
    {IF} {NOT({HAVE_UNIT( side={SIDE} {FILTER_LOCATION(radius,terrain=4,K*^*)} )})} {THEN(
        {GIVE_OBJECT_TO side,canrecruit={SIDE},yes ({EFFECT overlay add=misc/leader-crown.png})}
        {MODIFY_UNIT side,canrecruit={SIDE},yes canrecruit no}
        [remove_event]
            id=limit_moves_leader{SIDE}
        [/remove_event]
    )} {/IF}
#enddef
    [event]
        name,first_time_only=side 1 turn end,no
        {ENRAGE_IF_NO_KEEP 7}
        {ENRAGE_IF_NO_KEEP 9}
        {ENRAGE_IF_NO_KEEP 10}
    [/event]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # ILLUMINATED BRAIZER
        #############################
        [item]
            x,y,halo=36,12,halo/fire-aura-small.png
        [/item]
        [time_area] # illuminate everything in a 1 tile radius
            id=brazier1
            x,y,radius=36,12,1
            #            current_time=0
            {ILLUMINATED_TZ_DAWN}
            {ILLUMINATED_TZ_MORNING}
            {ILLUMINATED_TZ_AFTERNOON}
            {ILLUMINATED_TZ_DUSK}
            {ILLUMINATED_TZ_FIRSTWATCH}
            {ILLUMINATED_TZ_SECONDWATCH}
        [/time_area]
        [time_area] # undo illumination in a 0 tile radius (braizer already illuminates)
            x,y,radius=36,12,0
            {DEFAULT_SCHEDULE}
        [/time_area]

        #############################
        # ROAD KEEPS
        #############################
        # these fit the "army on the move" aesthetic better than castle/keep hexes
        # also, Delfador can't destroy them with cataclysm
        {PLACE_IMAGE scenery/keep-overlay-low.png  2  8}
        {PLACE_IMAGE scenery/keep-overlay-low.png  3  9}
        {PLACE_IMAGE scenery/keep-overlay-low.png  4  9}
        {PLACE_IMAGE scenery/keep-overlay-low.png  7 11}
        {PLACE_IMAGE scenery/keep-overlay-low.png  8 11}
        {PLACE_IMAGE scenery/keep-overlay-low.png  9 11}
        {PLACE_IMAGE scenery/keep-overlay-low.png 13 13}
        {PLACE_IMAGE scenery/keep-overlay-low.png 14 13}
        {PLACE_IMAGE scenery/keep-overlay-low.png 14 14}

        {PLACE_IMAGE scenery/keep-overlay-low.png 21 18}
        {PLACE_IMAGE scenery/keep-overlay-low.png 21 19}
        {PLACE_IMAGE scenery/keep-overlay-low.png 22 18}
        {PLACE_IMAGE scenery/keep-overlay-low.png 23 20}
        {PLACE_IMAGE scenery/keep-overlay-low.png 24 20}
        {PLACE_IMAGE scenery/keep-overlay-low.png 25 20}
        {PLACE_IMAGE scenery/keep-overlay-low.png 26 20}
        {PLACE_IMAGE scenery/keep-overlay-low.png 27 21}
        {PLACE_IMAGE scenery/keep-overlay-low.png 28 20}
        {PLACE_IMAGE scenery/keep-overlay-low.png 28 21}
        {PLACE_IMAGE scenery/keep-overlay-low.png 32 21}
        {PLACE_IMAGE scenery/keep-overlay-low.png 33 21}
        {PLACE_IMAGE scenery/keep-overlay-low.png 33 22}
        {PLACE_IMAGE scenery/keep-overlay-low.png 34 21}

        {PLACE_IMAGE scenery/keep-overlay-low.png 41 21}
        {PLACE_IMAGE scenery/keep-overlay-low.png 42 20}
        {PLACE_IMAGE scenery/keep-overlay-low.png 43 21}
        {PLACE_IMAGE scenery/keep-overlay-low.png 50 22}
        {PLACE_IMAGE scenery/keep-overlay-low.png 50 23}
        {PLACE_IMAGE scenery/keep-overlay-low.png 51 23}
        {PLACE_IMAGE scenery/keep-overlay-low.png 56 24}
        {PLACE_IMAGE scenery/keep-overlay-low.png 57 24}
        {PLACE_IMAGE scenery/keep-overlay-low.png 58 24}

        #############################
        # ELDRED BODYGUARDS
        #############################
#define ZONE_GUARDIAN_ID X Y ENEMY_LOCATION ID
    [+unit]
        [ai]
            [micro_ai]
                ca_id={ID}
                ai_type=zone_guardian
                station_x,station_y={X},{Y}
                [filter_location]
                    {ENEMY_LOCATION}
                [/filter_location]
            [/micro_ai]
        [/ai]
    [/unit]
#enddef
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    } 24 19 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 24 19  x,y,radius=24,20,2  bodyguard0})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Heavy Infantryman" "Heavy Infantryman"} 23 21 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 23 21  x,y,radius=24,20,2  bodyguard1})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    } 25 20 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 25 20  x,y,radius=24,20,2  bodyguard2})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Javelineer"        "Javelineer"        "Javelineer"       } 25 21 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 25 21  x,y,radius=24,20,2  bodyguard3})}

        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    } 26 23 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 26 23  x,y,radius=26,23,6  bodyguard4})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Heavy Infantryman" "Heavy Infantryman"} 20 20 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 20 20  x,y,radius=22,21,5  bodyguard5})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Heavy Infantryman" "Heavy Infantryman"} 22 22 ({FACING ne} {ROLE bodyguard} {ZONE_GUARDIAN_ID 22 22  x,y,radius=23,22,4  bodyguard6})}

        #############################
        # ELDRED AREA GUARDS
        #############################
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Javelineer"        "Javelineer"       } 20 18 ({FACING ne} {ZONE_GUARDIAN 20 18  x,y,radius=22,24,9})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"} 23 18 ({FACING n } {ZONE_GUARDIAN 23 18  x,y,radius=22,24,9})}

        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    } 29 19 ({FACING nw} {ZONE_GUARDIAN 29 19  ( x,y,radius=24,24,6 {OR x,y,radius=31,21,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Spearman"          "Javelineer"        "Javelineer"       } 27 22 ({FACING nw} {ZONE_GUARDIAN 27 22  ( x,y,radius=24,24,6 {OR x,y,radius=31,21,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Spearman"          "Swordsman"         "Swordsman"        } 29 21 ({FACING ne} {ZONE_GUARDIAN 29 21  ( x,y,radius=24,24,6 {OR x,y,radius=31,21,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Javelineer"        "Javelineer"       } 31 22 ({FACING ne} {ZONE_GUARDIAN 31 22  ( x,y,radius=24,24,6 {OR x,y,radius=31,21,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"} 34 20 ({FACING se} {ZONE_GUARDIAN 34 20  ( x,y,radius=24,24,6 {OR x,y,radius=31,21,6} )}) }

        #############################
        # FRONT GUARDS
        #############################
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Fencer"            "Fencer"            "Duelist"           "Duelist"          } 55 24 ({FACING ne} {ZONE_GUARDIAN 55 24  ( x,y,radius=52,24,6 {OR x,y,radius=25,23,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Spearman"          "Spearman"         } 53 23 ({FACING se} {ZONE_GUARDIAN 53 22  ( x,y,radius=52,24,6 {OR x,y,radius=25,23,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Horseman"          "Horseman"          "Lancer"            "Lancer"           } 52 23 ({FACING ne} {ZONE_GUARDIAN 52 23  ( x,y,radius=52,24,6 {OR x,y,radius=25,23,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Pikeman"           "Pikeman"           "Pikeman"          } 49 23 ({FACING ne} {ZONE_GUARDIAN 49 23  ( x,y,radius=52,24,6 {OR x,y,radius=25,23,6} )}) }

        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Horseman"          "Horseman"          "Lancer"            "Lancer"           } 45 23 ({FACING se} {ZONE_GUARDIAN 45 23  ( x,y,radius=42,23,6 {OR x,y,radius=26,24,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman"          "Spearman"          "Spearman"          "Spearman"         } 44 22 ({FACING se} {ZONE_GUARDIAN 44 23  ( x,y,radius=42,23,6 {OR x,y,radius=26,24,6} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Horseman"          "Lancer"            "Lancer"           } 41 20 ({FACING ne} {ZONE_GUARDIAN 41 20  ( x,y,radius=42,23,6 {OR x,y,radius=26,24,6} )}) }

        #############################
        # BACK GUARDS
        #############################
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Bowman"            "Bowman"            "Longbowman"        "Longbowman"       } 16 15 ({FACING ne} {ZONE_GUARDIAN 16 15  ( x,y,radius=12,14,6 {OR x,y,radius=21,20,5} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman"          "Spearman"          "Spearman"          "Spearman"         } 15 14 ({FACING ne} {ZONE_GUARDIAN 15 14  ( x,y,radius=12,14,6 {OR x,y,radius=21,20,5} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Bowman"            "Longbowman"        "Longbowman"       } 13 12 ({FACING se} {ZONE_GUARDIAN 13 12  ( x,y,radius=12,14,6 {OR x,y,radius=21,20,5} )}) }

        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Bowman"            "Longbowman"        "Longbowman"       } 10 11 ({FACING ne} {ZONE_GUARDIAN 10 11  ( x,y,radius=5,15,9  {OR x,y,radius=21,23,7} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "none"              "Red Mage"          "Red Mage"         }  7 12 ({FACING se} {ZONE_GUARDIAN  7 12  ( x,y,radius=5,15,9  {OR x,y,radius=21,23,7} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"              "Mage"              "Mage"              "Mage"             }  6 10 ({FACING se} {ZONE_GUARDIAN  6 10  ( x,y,radius=5,15,9  {OR x,y,radius=21,23,7} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman"          "Spearman"          "Spearman"          "Spearman"         }  3 10 ({FACING se} {ZONE_GUARDIAN  3 10  ( x,y,radius=5,15,9  {OR x,y,radius=21,23,7} )}) }

        #############################
        # TOWN GUARDS
        #############################
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman"} 30 12 ({FACING nw} {ZONE_GUARDIAN 30 12  ( x,y,radius=39,13,4 {OR x,y,radius=34,14,4} {OR x,y,radius=31,12,2} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "Bowman"   "Bowman"   "Bowman"  } 38 12 ({FACING nw} {ZONE_GUARDIAN 38 12  ( x,y,radius=39,13,4 {OR x,y,radius=34,14,4} {OR x,y,radius=31,12,2} )}) }
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Spearman" "Spearman"} 40 10 ({FACING ne} {ZONE_GUARDIAN 40 10  ( x,y,radius=39,13,4 {OR x,y,radius=34,14,4} {OR x,y,radius=31,12,2} )}) }

        #############################
        # ORC GUARDS
        #############################
        {GENERIC_UNITC  9 {ON_DIFFICULTY4 "Peasant"  "Peasant"  "Peasant"  "Peasant" } 51 14 ({FACING ne} {ZONE_GUARDIAN 51 14  x,y,radius=51,18,5})}
        {GENERIC_UNITC  9 {ON_DIFFICULTY4 "none"     "Ruffian"  "Thug"     "Thug"    } 47 18 ({FACING ne} {ZONE_GUARDIAN 47 18  x,y,radius=51,18,5})}

        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "Woodsman" "Woodsman" "Poacher"  "Poacher" } 16  2 ({FACING se} {ZONE_GUARDIAN 16  2  x,y,radius=16,2,5})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"     "none"     "Peasant"  "Peasant" } 13  3 ({FACING se} {ZONE_GUARDIAN 13  3  x,y,radius=16,2,5})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"     "none"     "Woodsman" "Woodsman"} 11  5 ({FACING sw} {ZONE_GUARDIAN 11  5  x,y,radius=16,2,5})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"     "Woodsman" "Poacher"  "Poacher" } 21  1 ({FACING se} {ZONE_GUARDIAN 21  1  x,y,radius=16,2,5})}

        #############################
        # DELFADOR
        #############################
        {RECALL_XY Delfador 44 5}
        {MODIFY_UNIT id=Delfador facing sw}
        {SCROLL_TO 44 5}

        {IF} {VARIABLE_CONDITIONAL poachers_were_recruited equals yes} {THEN(
            [set_extra_recruit]
                id=Delfador
                extra_recruit={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT},Poacher,{DELFADOR_CAVALRY_RECRUIT}
            [/set_extra_recruit]
        )} {ELSE(
            [set_extra_recruit]
                id=Delfador
                extra_recruit={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT},{DELFADOR_CAVALRY_RECRUIT}
            [/set_extra_recruit]
        )} {/IF}

        [modify_unit]
            {FILTER id=Delfador}
            # leaving [filter_recall] blank or using [true][/true] fails to clear the filter from S11. So I have to list out every possible recruit instead...
            # I also couldn't get this working with {VARIABLE stored_delfador.filter_recall ""}
            [filter_recall]
                type_adv_tree={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT},Poacher,{DELFADOR_CAVALRY_RECRUIT}
            [/filter_recall]
        [/modify_unit]

        #############################
        # RESTORE S11 GOLD
        #############################
        [gold]
            side,amount=1,$bonus_gold
        [/gold]
        {IF} {VARIABLE_CONDITIONAL s11_carryover greater_than 0} {THEN(
            [gold]
                side,amount=1,$s11_carryover
            [/gold]
        )} {/IF}
    [/event]

    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # MAP OVERVIEW
        #############################
        {RECALL_XY Methor 45 4}
        [remove_event]
            id=herodeath_methor
        [/remove_event]
        [event]
            name=last breath {FILTER id=Methor}
            {FILTER_CONDITION( {NOT( {CONTINGENCY_GLOBAL_CONDITIONS} )} )}
            [message]
                speaker=Delfador
                message=_"No! Methor... Don’t die!"
            [/message]
            [message]
                speaker=Methor
                message=_"Delfador, my sweet, wonderful apprentice... I couldn’t be more proud of you..."
            [/message]
        [/event]

        {RECALL_HORSELORD 46 4} {MODIFY_UNIT id=$horselord_id facing sw}
        {RECALL_COMPANION 47 5} {MODIFY_UNIT id=$companion_id facing sw}
        {DELAY 500}

        {SCROLL_TO 2 7}
        {DELAY 500}
        {SCROLL_TO 26 20}
        {DELAY 500}
        {SCROLL_TO 60 21}
        {DELAY 500}
        {SCROLL_TO 45 5}

        #############################
        # DISCUSS THE SITUATION
        #############################
        [message]
            speaker=Methor
            #po: callback to S01 where Methor complains about Delfador not learning a seeker spell
            message= _ "Look at the length of that column! The prince — the king, I suppose — must have picked up more soldiers at Tath, when he forced Sir Gwido to swear fealty. Your seeker spell was excellent, Delfador; we’ve been able to find and intercept Eldred before he could turn anyone else to his cause."
        [/message]
        [message]
            speaker=$companion_id
            message= _ "Boss, how’s we supposin’ to fight that many! E’en we could, what about tha’ Queen Asheviere back in Weldyn?"
        [/message]
        [message]
            speaker=$horselord_id
            #po: "reigns" is a pun - "reigns of power", but also the kind of reins that you use to control a horse (this is a mounted unit speaking)
            message= _ "Indeed! Word is she’s killed half of the court and paid off the rest; the remaining lords of the city are loyal only to her! Eldred may be king, but Asheviere holds the reins."
        [/message]
        [message]
            speaker=Delfador
            message= _ "We don’t have to fight the entire army or deal with Weldyn. The capital is too well-defended for us to sack outright — Eldred is the objective here."
        [/message]
        [message]
            speaker=Delfador
            message= _ "Once the truth gets out about Garard’s death, we’ll have enough allies to liberate Weldyn and more besides. But only if we can stop Eldred here and now — can prove to the watchers that this coup is not yet over; that justice and honor and hope still live in Wesnoth! That’s our goal today."
        [/message]
        {DELAY 500}
        [message]
            speaker=$companion_id
            message= _ "Look sharp, I think they’ve spotted us!"
        [/message]

        #############################
        # ELDRED TAUNTS DELFADOR
        #############################
        [message]
            speaker=Eldred
            message= _ "Delfador, welcome! I was wondering if we’d get an appearance from you old has-been! ’fraid you’re not as popular with Mother and me as you were with old Garard."
        [/message]
        #         [message]
        #             speaker=Eldred
        #             message= _ "<span size='x-small'>Not as popular, no. The great Delfador, with his magic and his fire. Whispering into father’s ear; stealing my rightful place.</span>"
        #         [/message]
        [message]
            speaker=Eldred
            message= _ "Opposing me is hopeless, old mage. But it’s not too late to save yourself — surrender now, disband your little rebel rabble, and we can tell the men it was all a big misunderstanding."
        [/message]
        [message]
            speaker=Eldred
            message= _ "Just lay down your staff and greet me with open arms. You can even have your old title back! “Delfador the Great”, High Advisor to the Crown — don’t you agree that has a nice ring to it?"
        [/message]
        [message]
            speaker=Delfador
            message= _ "I am no longer so foolish as to be tempted by <b><i>that</i></b>, young prince! Enough blood has been spilled on your behalf; stop this madness and give up the throne, or I shall make you."
        [/message]
        [message]
            speaker=Eldred
            message= _ "Oh no, I don’t think so. You forget you’re speaking to your king, old man. Solders, attack! ATTACK!"
        [/message]
        {TELEPORT_UNIT id=Delfador 49 2}
        {MODIFY_UNIT id=Delfador facing sw}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Eldred"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]

        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
    [/event]

    #############################
    # ENEMY INCOME INCREASES
    #############################
    # give gold per leader. Easier way to implement this than changing each side's income individually and per-difficulty
#define BONUS_INCOME_PER_LEADER INCOME
    # newline for inline usage
    [event]
        name,first_time_only=new turn,no
        [store_unit]
            {FILTER( canrecruit=yes {NOT side=1} )}
            variable=stored_enemy_leaders
        [/store_unit]
        [foreach]
            array=stored_enemy_leaders
            [do]
                [gold]
                    side=$this_item.side
                    amount={INCOME}
                [/gold]
            [/do]
        [/foreach]
    [/event]
#enddef
    [event]
        name=turn  7 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 13 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 18 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 22 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 25 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 27 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 29 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 31 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 33 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 35 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 37 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]
    [event]
        name=turn 39 {BONUS_INCOME_PER_LEADER {ON_DIFFICULTY4 0 1 2 2}}
    [/event]

    #############################
    # ELDRED FLAVOR 1
    #############################
    [event]
        name=turn 4
        [message]
            speaker=Delfador
            message= _ "Eldred, you know full well that your father and I were close! Is this what he would have wanted? His kingdom turned against itself, his townships pillaged by orcs? He had hope; a future for Wesnoth! A future for you!"
        [/message]
        [message]
            speaker=Eldred
            message= _ "A future for me? I can count on one hand the times the old tyrant had anything kind to say about me."
        [/message]
        [message]
            speaker=Eldred
            message= _ "I wasn’t going to wait around to be disinherited, or worse. It was always going to be him or me — I just beat him to the finish."
        [/message]
        [message]
            speaker=Delfador
            message= _ "Fool. I will not bandy words with whatever madness has taken root inside your mind, Eldred. Garard was harsh; I cannot deny that. But you’re a fool if you think he ever felt anything but love for you."
        [/message]
    [/event]
    [event]
        name=side 1 turn 4 end
        [message]
            speaker=Eldred
            message= _ "I’m no fool, Delfador. Day and night, my parents fought. Whether said in truth or in anger, there are some things my father can never take back."
        [/message]
        [message]
            speaker=Eldred
            message= _ "And don’t think that I have any illusions about what sort of snake Mother is either. I know, believe me. But she’s the snake who’s made me king, and that’s good enough."
        [/message]
    [/event]

    #############################
    # ELDRED FLAVOR 3
    #############################
    [event]
        name=turn 8
        # this line might play during the duel, if you really rush down Eldred. But that's ok; the lines still make sense (Eldred's ID is different so only Delfador speaks)
        [message]
            speaker=Eldred
            message= _ "I’m surprised you haven’t given up yet, wizard! But you’re no stranger to hopeless fights, are you — you bested Malal, escaped the frozen north, scattered our saurians."
        [/message]
        [message]
            speaker=Eldred
            message= _ "Malal was powerful; <i>really</i> powerful. The fate of the whole kingdom changed, that day he and Mother first met. You weren’t supposed to survive him... you weren’t supposed to survive <i><b>any</b></i> of that."
        [/message]
        [message]
            speaker=Delfador
            message= _ "Would that more had survived along with me, Eldred. Had I only listened then to Deoran, been but a little wiser, so many lives might yet have been saved."
        [/message]
        [message]
            speaker=Delfador
            message= _ "I can never atone for the lives I cost, but I can yet honor them through my actions. And right now, honoring them means stopping you."
        [/message]
    [/event]

    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=moveto {FILTER id=Delfador}
        {VARIABLE failed_achievement yes}
    [/event]

    #############################
    # ELDRED DRINKS THE POTION
    #############################
    [event]
        name=last breath
        {FILTER id=Eldred}

        {IF} {VARIABLE_CONDITIONAL failed_achievement not_equals yes} {THEN({ACHIEVE s14})}
        {/IF}
        {CLEAR_VARIABLE failed_achievement}

        {FIRE_EVENT skill_shield_cancel}
        {FIRE_EVENT skill_levitate_cancel}
        {FIRE_EVENT skill_counterspell)cancel}
        {FIRE_EVENT skill_polymorph_stoat_cancel}
        {FIRE_EVENT skill_polymorph_bear_cancel}
        {FIRE_EVENT skill_polymorph_crab_cancel}
        {FIRE_EVENT skill_polymorph_roc_cancel}
        {FIRE_EVENT skill_illusion_cancel}

        [message]
            speaker=Eldred
            message= _ "NO!"
        [/message]
        [message]
            speaker=Delfador
            message= _ "It’s over, Eldred. Down on your knees, now! The rest of you; get back! BACK, or you’ll have to find yet another king!"
        [/message]
        [message]
            speaker=Eldred
            message= _ "I didn’t come all this way just to fail now... not at the hand of some cheap conjurer. No, I prepared for this. After my last defeat, I took... precautions."
        [/message]
        [message]
            speaker=Eldred
            message= _ "They say this elixir came all the way from the old continent, Delfador. Persuading Malal to give it up wasn’t easy.

You like magic so much? Once I drink from Jevyan’s Cup, I’ll have enough magic to turn you all to dust!"
        [/message]
        [message]
            speaker=Delfador
            # po: liches are skeletal; they don't have blood. This is a consumable artifact of unknown composition, probably captured/extracted from lich-lord Jevyan
            message= _ "Is that— are you holding <i>lich’s blood</i>!? How— Put it down, Eldred!"
        [/message]
        [message]
            speaker=Delfador
            message= _ "Whatever you do, don’t you dare drink it! We have no idea what will happen! Don’t you dare, Eldred! ELDRED!"
        [/message]
        {SCROLL_TO 24 20}
        {SOUND skill-panacea.wav}
        {FADE_MUSIC_OUT 1300}
        {FIRE_EVENT play_phase_2}
        # Eldred's potion is both an excuse for a boss fight, and also a semi-explanation for Liberty's cursed soldiers.
    [/event]

    #######################################################################################################################################################
    #                                                                      PHASE TWO
    #######################################################################################################################################################
    [event]
        name=play_phase_2

        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 0}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {QUAKE ()}
        {SCREEN_FADER 100,0,0 255 0}
        {SOUND skill-cataclysm-end.wav}

        #############################
        # CLEAR OLD UNITS
        #############################
        {MODIFY_UNIT id=Eldred hitpoints 1}
        [store_unit]
            {FILTER id=Eldred}
            variable,kill=stored_eldred,yes
        [/store_unit]
        [store_unit]
            {FILTER( {NOT id=Delfador,familiar} )}
            variable,kill=stored_units_s13,yes # from any side
        [/store_unit]

        #############################
        # REPLACE THE MAP
        #############################
        {FIRE_EVENT skill_levitate_cancel} # otherwise levitate can somehow get Delfador killed
        [replace_map]
            map_file=14b_Long_Live_the_Queen.map
            expand,shrink=yes,yes
        [/replace_map]
        {REMOVE_IMAGE 0-99 0-99}
        [replace_schedule]
            [time]
                id,name,image=void,_"Void",misc/schedule-void.png
                red,green,blue=50,-50,-50
                lawful_bonus=-25
            [/time]
        [/replace_schedule]
        [remove_time_area]
            id=brazier1
        [/remove_time_area]
        [capture_village] # clear all villages, so Delfador can't keep getting bonus income
        [/capture_village]

        #############################
        # PREPARE DELFADOR
        #############################
        {TELEPORT_UNIT id=Delfador 26 19}
        {MODIFY_UNIT id=Delfador facing sw}
        [heal_unit]
            {FILTER id=Delfador}
            moves=full
            restore_attacks=yes
        [/heal_unit]
        [modify_side]
            side=1
            gold,income={ON_DIFFICULTY4 40 40 40 20},0
            # so the player can summon a few mudcrawlers/fire guardians, if they choose those spells. But no bonus income, because it's possible to distract Eldred's AI forever with mudcrawlers
            fog,reset_view=yes,yes
        [/modify_side]

        [lift_fog]
            multiturn=yes {FILTER_SIDE side=1}
            x,y,radius=24,20,6
        [/lift_fog]
        [lift_fog]
            multiturn=yes {FILTER_SIDE side=1}
            x,y,radius=24,18,6
        [/lift_fog]
        [lift_fog]
            multiturn=yes {FILTER_SIDE side=1}
            x,y,radius=28,21,4
        [/lift_fog]
        [redraw][/redraw]

        # if we have less than 53xp, set our xp to 53.
        {STORE_UNIT_VAR id=Delfador experience delfador_xp}
        {IF} {VARIABLE_CONDITIONAL delfador_xp less_than 53} {THEN({MODIFY_UNIT id=Delfador experience 53})}
        {/IF}
        {CLEAR_VARIABLE delfador_xp}
        [set_extra_recruit]
            id=Delfador
            extra_recruit=
        [/set_extra_recruit]
        [modify_unit]
            {FILTER id=Delfador}
            [filter_recall]
                race=disable_delfador_recalling
            [/filter_recall]
        [/modify_unit]

        #############################
        # PREPARE ELDRED
        #############################
        [unit]
            id,name,type=MiddleEldred,_"Eldred",King Eldred # use a new ID so events don't interfere
            side,x,y,facing,profile=2,24,20,ne,portraits/eldred.webp
            [modifications]
                {TRAIT_RESILIENT} {TRAIT_INTELLIGENT}
                [object]{EFFECT overlay add=misc/leader-crown.png}
                [/object]
            [/modifications]
        [/unit]
        {SCROLL_TO 24 20}
        {DELAY 3000}
        {SCREEN_FADER 0,0,0 0 3000}

        #############################
        # DIALOGUE
        #############################
        {DELAY 3000}
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Finally.</span>"
        [/message]
        {DELAY 3000}
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Finally, I understand.</span>"
        [/message]
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>I can make the pain all go away. I can make everything better again.</span>"
        [/message]
        {DELAY 1500}
        [message]
            speaker=Delfador
            message= _ "...you can?"
        [/message]
        {MOVE_UNIT id=MiddleEldred 25 20}
        [harm_unit]
            {FILTER id=Delfador} {FILTER_SECOND id=MiddleEldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            animate,amount=yes,9
        [/harm_unit]
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>I just need to kill everyone else first.</span>"
        [/message]
        {REPLACE_SCENARIO_MUSIC helios.ogg}

        [change_theme]
        [/change_theme]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Eldred"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ({TELEPORT_UNIT id=familiar 27 20})}
    [/event]

    #############################
    # MIRROR IMAGES
    #############################
    [event]
        name=side 2 turn refresh
        [filter_condition]
            [have_unit]
                id=MiddleEldred
                formula=(self.hitpoints < self.max_hitpoints*3/4)
            [/have_unit]
        [/filter_condition]
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Everything is so clear now. I see the past; the future.</span>"
        [/message]
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Your eyes were clouded. You could not tell the truth from the lie.</span>"
        [/message]
        [event]
            name=explain_mirrors
            [message]
                speaker=narrator
                message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>You still can’t, can you?</span>"
            [/message]
        [/event]
        {MODIFY_UNIT id=MiddleEldred moves 0}
        {MODIFY_UNIT id=MiddleEldred attacks_left 0}

        #############################
        # DEFINE MIRRORS MACRO
        #############################
#define MAKE_MIRROR ID X Y
    {VARIABLE stored_midEldred.id {ID}}
    [unstore_unit]
        variable,x,y=stored_midEldred
        x,y,find_vacant={X},{Y},yes
    [/unstore_unit]

    {GIVE_OBJECT_TO id={ID} (
        id=mirror_object
        {EFFECT halo halo="halo/holy/light-beam-5.png~CROP(0,0,150,500)~SCALE(108,144)~CS(-159,-255,-159)~MASK(terrain/misc/smoke-A[01~12].png~SCALE(108,144)):100"}
        {EFFECT new_animation (
            [animation]
                apply_to=post_teleport
                {TELEPORT_IN_ANIMATION}
            [/animation]
        )}
        {EFFECT new_animation (
            [animation]
                apply_to,base_score=death,99 # override other death animations
                smoke_1_start_time,start_time,smoke_2_start_time=0,200,400
                [smoke_1_frame]
                    sound=skill-polymorph-quiet.wav
                    image="terrain/misc/smoke-A[01~12,01~12,01~12].png~SCALE([72~143],[144~215]):50"
                    y,auto_vflip,image_mod=0~-200,no,"~CS(-31,-255,-31)"
                    alpha=0~1,1,1,1~0
                [/smoke_1_frame]
                [frame]
                    duration,image_mod=150,"~CS(127,0,127)~BL([15,10,20,30,40,50,60,70])"
                    blend_ratio,blend_color=0~1,255,255,255
                    alpha=1,1~0
                [/frame]
                [smoke_2_frame]
                    image="terrain/misc/smoke-A[01~12,01~12,01~12].png~SCALE([72~143],[144~215]):30"
                    y,auto_vflip,image_mod=0~-200,no,"~CS(-31,-255,-31)"
                    alpha=0~1,1,1,1~0
                [/smoke_2_frame]
            [/animation]
        )}
    )}

    {SOUND skill-illusion-quiet.wav}
    {ANIMATE_UNIT id={ID} post_teleport}
#enddef

        #############################
        # REFRESH MIRRORS EACH TURN
        #############################
        [event]
            name=side 2 turn end
            first_time_only=no
            {FILTER_CONDITION( {HAVE_UNIT id=MiddleEldred} )}

            #--------------------
            # MAKE NEW ELDREDS
            #--------------------
            [store_unit]
                {FILTER id=MiddleEldred}
                variable,kill=stored_midEldred,yes
            [/store_unit]
            {VARIABLE_OP variant rand "1a,1b,2a,2b,3a,3b,4a,4b,5a,5b,6a,6b"}

            {IF} {VARIABLE_CONDITIONAL variant equals "1a"} {THEN( {MAKE_MIRROR MiddleEldred 22 19}{MAKE_MIRROR MirrorEldred 26 22} )}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL variant equals "1b"} {THEN( {MAKE_MIRROR MirrorEldred 22 19}{MAKE_MIRROR MiddleEldred 26 22} )}
            {/IF}

            {IF} {VARIABLE_CONDITIONAL variant equals "2a"} {THEN( {MAKE_MIRROR MiddleEldred 27 20}{MAKE_MIRROR MirrorEldred 22 20} )}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL variant equals "2b"} {THEN( {MAKE_MIRROR MirrorEldred 27 20}{MAKE_MIRROR MiddleEldred 22 20} )}
            {/IF}

            {IF} {VARIABLE_CONDITIONAL variant equals "3a"} {THEN( {MAKE_MIRROR MiddleEldred 24 18}{MAKE_MIRROR MirrorEldred 26 21} )}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL variant equals "3b"} {THEN( {MAKE_MIRROR MirrorEldred 24 18}{MAKE_MIRROR MiddleEldred 26 21} )}
            {/IF}

            {IF} {VARIABLE_CONDITIONAL variant equals "4a"} {THEN( {MAKE_MIRROR MiddleEldred 25 22}{MAKE_MIRROR MirrorEldred 27 20} )}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL variant equals "4b"} {THEN( {MAKE_MIRROR MirrorEldred 25 22}{MAKE_MIRROR MiddleEldred 27 20} )}
            {/IF}

            {IF} {VARIABLE_CONDITIONAL variant equals "5a"} {THEN( {MAKE_MIRROR MiddleEldred 22 20}{MAKE_MIRROR MirrorEldred 24 18} )}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL variant equals "5b"} {THEN( {MAKE_MIRROR MirrorEldred 22 20}{MAKE_MIRROR MiddleEldred 24 18} )}
            {/IF}

            {IF} {VARIABLE_CONDITIONAL variant equals "6a"} {THEN( {MAKE_MIRROR MiddleEldred 24 18}{MAKE_MIRROR MirrorEldred 26 22} )}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL variant equals "6b"} {THEN( {MAKE_MIRROR MirrorEldred 24 18}{MAKE_MIRROR MiddleEldred 26 22} )}
            {/IF}
            {CLEAR_VARIABLE variant}
            {FIRE_EVENT explain_mirrors}
        [/event]

        #############################
        # REVEAL THE REAL ELDRED
        #############################
        # attacking a mirror reveals it instantly
        # AOE effects (i.e. stasis/blizzard/cataclysm) also need to reveal the mirror
        [event]
            name=pre attack
            first_time_only=no
            {FILTER_SECOND type="King Eldred"}

            {REMOVE_OBJECT mirror_object id=MiddleEldred}
            {KILL id=MirrorEldred ANIMATE=yes}
        [/event]
        [event]
            name=skill_stasis_end
            first_time_only=no
            {FILTER_CONDITION( {HAVE_UNIT( id,status=MirrorEldred,petrified )} )}

            {REMOVE_OBJECT mirror_object id=MiddleEldred}
            {KILL id=MirrorEldred ANIMATE=yes}
        [/event]
        [event]
            name=skill_blizzard_end
            first_time_only=no
            {FILTER_CONDITION( {HAVE_UNIT( id,status=MirrorEldred,slowed )} )}

            {REMOVE_OBJECT mirror_object id=MiddleEldred}
            {KILL id=MirrorEldred ANIMATE=yes}
        [/event]
        [event]
            name=cataclysm_harmed_eldred
            first_time_only=no
            {REMOVE_OBJECT mirror_object id=MiddleEldred}
            {KILL id=MirrorEldred ANIMATE=yes}
        [/event]
        [event]
            name=side 2 turn
            first_time_only=no
            {REMOVE_OBJECT mirror_object id=MiddleEldred}
            {KILL id=MirrorEldred ANIMATE=yes}
        [/event]
    [/event]

    #############################
    # START GHOSTS PHASE
    #############################
    [event]
        name=side 2 turn refresh
        [filter_condition]
            [have_unit]
                id=MiddleEldred
                formula=(self.hitpoints < self.max_hitpoints*1/4)
            [/have_unit]
        [/filter_condition]
        {FIRE_EVENT begin_ghosts}
    [/event]
    [event]
        name=last breath
        {FILTER id=MiddleEldred}
        {MODIFY_UNIT id=MiddleEldred hitpoints 1}
        {FIRE_EVENT begin_ghosts}
    [/event]
    [event]
        name=begin_ghosts

        {KILL id=MirrorEldred}
        {MODIFY_UNIT id=Delfador moves 5}
        {MODIFY_UNIT id=Delfador attacks_left 1}
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Give up.</span>"
        [/message]

        #############################
        # TELEPORT TO CENTER
        #############################
        [store_unit]
            {FILTER x,y=24,20}
            kill,variable=yes,blocking_unit
        [/store_unit]
        {IF} {NOT({HAVE_UNIT( id,x,y=MiddleEldred,24,20 )})}{THEN(
            {ANIMATE_UNIT id=MiddleEldred dark_teleport_out}
            {TELEPORT_UNIT id=MiddleEldred 24 20}
            {MODIFY_UNIT id=MiddleEldred facing ne}
            {ANIMATE_UNIT id=MiddleEldred dark_teleport_in}
        )} {/IF}
        {IF} {VARIABLE_CONDITIONAL blocking_unit.length greater_than 0} {THEN(
            [unstore_unit]
                variable,find_vacant=blocking_unit,yes
            [/unstore_unit]
            {CLEAR_VARIABLE blocking_unit}
        )} {/IF}

        {DELAY 500}
        {STORE_UNIT_VAR id=MiddleEldred hitpoints eldred_hp}
        {KILL id=MiddleEldred}
        [unit]
            id,name,type=HunkerEldred,_"Eldred",Hunker Eldred # use a new ID so phase 1 and phase 2 events don't interfere
            side,x,y,facing,profile=2,24,20,ne,portraits/eldred.webp
            hitpoints=$eldred_hp
            [modifications]
                {TRAIT_RESILIENT} {TRAIT_INTELLIGENT}
                [object]{EFFECT overlay add=misc/leader-crown.png}
                [/object]
            [/modifications]
        [/unit]
        {DELAY 500}

        #############################
        # INVULNERABILITY SHIELD
        #############################
        [item]
            x,y,name=24,20,invulnerability_shield
            halo="halo/cataclysm/sphere/[0001~0024].png~O(0.6)~SCALE(100,100)~CROP(0,0,100,80):125"
        [/item]
        [event]
            name=skill_stasis_end
            first_time_only=no
            {FILTER_CONDITION({HAVE_UNIT( id=HunkerEldred )})}
            {FILTER_CONDITION({HAVE_UNIT( type_adv_tree=Ghost )})}
            {MODIFY_UNIT id=HunkerEldred status.petrified no}
        [/event]
        [event]
            name=skill_blizzard_end
            first_time_only=no
            {FILTER_CONDITION({HAVE_UNIT( id=HunkerEldred )})}
            {FILTER_CONDITION({HAVE_UNIT( type_adv_tree=Ghost )})}
            {MODIFY_UNIT id=HunkerEldred status.slowed no}
        [/event]
        [event]
            name=new turn
            first_time_only=no
            {MODIFY_UNIT id=HunkerEldred resting no}
        [/event]

        # allow Delfador's magical attacks to miss. HunkerEldred has 100% defense, but "magical" ignores that
        {GIVE_OBJECT_TO id=Delfador {EFFECT attack (special_id=magical
        remove_specials=magical
        [set_specials]
            mode=append
            [chance_to_hit]
                #textdomain wesnoth-help
                id,name,description=magical,_"magical",_"This attack always has a 70% chance to hit regardless of the defensive ability of the unit being attacked."
                #textdomain wesnoth-tdg
                special_note={INTERNAL:SPECIAL_NOTES_MAGICAL}
                value,cumulative=70,no
                [filter_opponent] {NOT type="Hunker Eldred"}
                [/filter_opponent]
            [/chance_to_hit]
        [/set_specials])}
        }

        #############################
        # GHOST HELPER MACRO
        #############################
#define CREATE_GHOST X Y TYPE ID FACE
    {NAMED_UNIT 2 {TYPE} {X} {Y} {ID} "" ()} {ANIMATE} {FACING {FACE}}
    [modify_unit]
        {FILTER id={ID}} moves=0
        [object]{EFFECT movement    set=2}
        [/object]
        [object]{EFFECT remove_attacks ()}
        [/object]
    [/modify_unit]
    [micro_ai]
        side,action,ai_type=2,add,goto
        ca_id={ID}_goto_mai
        {FILTER id={ID}}
        {FILTER_LOCATION x,y=24,20}
    [/micro_ai]
#enddef
#define CONSUME_GHOST ID
    [micro_ai]
        side,action,ai_type=2,delete,goto
        ca_id={ID}_goto_mai
    [/micro_ai]

    {STORE_UNIT_VAR id={ID}     hitpoints ghostHP}
    {STORE_UNIT_VAR id={ID} max_hitpoints ghostMaxHP}
    {VARIABLE heal_amount {ON_DIFFICULTY4 10 20 30 40}}
    {VARIABLE_OP heal_amount multiply $ghostHP}
    {VARIABLE_OP heal_amount divide $ghostMaxHP}
    {KILL id={ID} ANIMATE=yes}

    [heal_unit]
        {FILTER id=HunkerEldred}
        animate,amount=yes,$heal_amount
    [/heal_unit]
    {CLEAR_VARIABLE ghostHP,ghostMaxHP,heal_amount}
#enddef

        #############################
        # FIRST GHOST
        #############################
        {CREATE_GHOST 19 24 Ghost ghost0 ne}
        {MOVE_UNIT id=ghost0 23 21}
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Your king is dead. Your achievements are undone. Delafdor is a lie.</span>"
        [/message]
        {CONSUME_GHOST ghost0}

        #############################
        # MORE GHOSTS
        #############################
        {CREATE_GHOST 22 14 Ghost  ghost1 se}
        {CREATE_GHOST 29 18 Ghost  ghost2 sw}
        {CREATE_GHOST 31 23 Wraith ghost3 nw}
        {CREATE_GHOST 22 24 Ghost  ghost4 ne}
        {CREATE_GHOST 18 20 Wraith ghost5 se}
        {VARIABLE ghosts_consumed 0}

        #############################
        # GHOST TIMEOUT
        #############################
        # since ghosts have no attack, it's possible for the player to trap a ghost (with cheap mudcrawlers) and prevent it from ever moving
        # to avoid this, kill ghosts if they're taking too long to reach Eldred
        [event]
            name=side 2 turn end
            [event]
                name=side 2 turn end
                [event]
                    name=side 2 turn end
                    [event]
                        name=side 2 turn end
                        [event]
                            name=side 2 turn end
                            [event]
                                name=side 2 turn end
                                [event]
                                    name=side 2 turn end
                                    [event]
                                        name=side 2 turn end
                                        [event]
                                            name=side 2 turn end
                                            [event]
                                                name=side 2 turn end
                                                {KILL type_adv_tree=Ghost ANIMATE=yes}
                                                {FIRE_EVENT check_ghosts_gone}
                                            [/event] # look how ugly -I mean pretty the nested events are! ooooohhhhohohooooohohohooohohohhhh
                                        [/event]
                                    [/event]
                                [/event]
                            [/event]
                        [/event]
                    [/event]
                [/event]
            [/event]
        [/event]

        #############################
        # CONSUME EACH GHOST
        #############################
        [event]
            name=moveto
            first_time_only=no
            {FILTER( type_adv_tree=Ghost {FILTER_ADJACENT id=HunkerEldred} )}
            {CONSUME_GHOST $unit.id}
            {VARIABLE_OP ghosts_consumed add 1}
            {FIRE_EVENT check_ghosts_gone}
        [/event]

        #############################
        # DELFADOR KILLS GHOST
        #############################
        [event]
            name=die
            first_time_only=no
            {FILTER type_adv_tree=Ghost}
            {FILTER_SECOND side=1}

            # delfador's healing per ghost depends on how much hp he has
            # This gives players a catch-up opportunity, and also reduces snowballing somewhat. Helps make the fight feel a little closer
            # the killer might also be a summon, in which case they also get healed quite a bit
            {STORE_UNIT_VAR id=$second_unit.id hitpoints killer_hp}
            {VARIABLE killer_healing 5}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 55} {THEN({VARIABLE killer_healing 6})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 45} {THEN({VARIABLE killer_healing 7})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 35} {THEN({VARIABLE killer_healing 8})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 25} {THEN({VARIABLE killer_healing 9})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 20} {THEN({VARIABLE killer_healing 10})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 15} {THEN({VARIABLE killer_healing 11})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than 10} {THEN({VARIABLE killer_healing 13})}
            {/IF}
            {IF} {VARIABLE_CONDITIONAL killer_hp less_than  5} {THEN({VARIABLE killer_healing 15})}
            {/IF}
            [heal_unit]
                {FILTER id=$second_unit.id}
                animate,amount=yes,$killer_healing
            [/heal_unit]
            {CLEAR_VARIABLE killer_hp,killer_healing}
            {FIRE_EVENT check_ghosts_gone}
        [/event]

        #############################
        # GHOSTS ALL GONE
        #############################
        [event]
            name=check_ghosts_gone
            {FILTER_CONDITION( {HAVE_UNIT id=HunkerEldred} )}
            {FILTER_CONDITION( {HAVE_UNIT type_adv_tree,count=Ghost,0} )}

            {DELAY 500}
            {REMOVE_IMAGE 0-99 0-99}
            {DELAY 500}

            {STORE_UNIT_VAR id=HunkerEldred hitpoints eldred_hp}
            {KILL id=HunkerEldred}
            [unit]
                id,name,type=FinalEldred,_"Eldred",King Eldred # use a new ID so events don't interfere
                side,x,y,facing,profile=2,24,20,se,portraits/eldred.webp
                hitpoints=$eldred_hp
                [modifications]
                    {TRAIT_RESILIENT} {TRAIT_INTELLIGENT}
                    [object]{EFFECT overlay add=misc/leader-crown.png}
                    [/object]
                [/modifications]
            [/unit]
            {MODIFY_UNIT id=FinalEldred moves 5}
            {MODIFY_UNIT id=FinalEldred attacks_left 1}

            {DELAY 500}
            [message]
                speaker=narrator
                message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>No.</span>"
            [/message]
            {DELAY 500}

            #############################
            # FINALELDRED GETS TWO TURNS
            #############################
            [event]
                name=side 2 turn end
                first_time_only=no
                {MODIFY_UNIT id=FinalEldred side 3}
                {DELAY 500} # force a moment's delay, otherwise its not always clear Eldred has stopped attacking
            [/event]
            [event]
                name=side 3 turn end
                first_time_only=no
                {MODIFY_UNIT id=FinalEldred side 2}
            [/event]
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    [event]
        name=last breath
        {FILTER id=FinalEldred}

        #############################
        # LAST BREATH
        #############################
        {DELAY 500}
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>You really still don’t understand, do you?</span>"
        [/message]
        {STORE_UNIT_VAR id=FinalEldred x eldredX}
        {STORE_UNIT_VAR id=FinalEldred y eldredY}
        {KILL id=FinalEldred}
        [unit]
            id,name,type=FinalEldred,_"Eldred",King Eldred
            side,x,y,facing,profile=2,$eldredX,$eldredY,ne,portraits/eldred.webp
            hitpoints=1
            [modifications]
                {TRAIT_RESILIENT} {TRAIT_INTELLIGENT}
                [object]{EFFECT overlay add=misc/leader-crown.png}
                [/object]
            [/modifications]
        [/unit]
        [message]
            speaker=narrator
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Win or lose, live or die; nothing you do here matters.</span>"
        [/message]
        [message]
            speaker=narrator
            #po: prophecy callbacks
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>Every victory you ever earned was empty. Everything you ever achieved is undone. The flames of fear have consumed your world. The future is already written.</span>"
        [/message]

        {DELAY 500}
        {STORE_UNIT_VAR id=FinalEldred x eldredX}
        {STORE_UNIT_VAR id=FinalEldred y eldredY}
        {KILL id=FinalEldred}
        [unit]
            id,name,type=HunkerEldred,_"Eldred",Hunker Eldred
            side,x,y,facing,profile=2,$eldredX,$eldredY,ne,portraits/eldred.webp
            hitpoints=1
            [modifications]
                {TRAIT_RESILIENT} {TRAIT_INTELLIGENT}
                [object]{EFFECT overlay add=misc/leader-crown.png}
                [/object]
            [/modifications]
        [/unit]
        {DELAY 500}

        [message]
            speaker=narrator
            #po: prophecy callback
            message= _ "<span color='#CC0000' size='x-small' font_weight='bold'>There is no greatness within you, mage of Alduin. You are a failure.</span>"
        [/message]

        #############################
        # REPLACE THE MAP
        #############################
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {SOUND skill-stasis.wav}
        {SCREEN_FADER 100,0,0 255 250}
        [replace_map]
            map_file=14c_Long_Live_the_Queen.map
            expand,shrink=yes,yes
        [/replace_map]
        {REMOVE_IMAGE 0-99 0-99}
        [replace_schedule]
            {DEFAULT_SCHEDULE}
        [/replace_schedule]
        [modify_side]
            side,fog=1,no
        [/modify_side]

        #############################
        # RESTORE UNITS
        #############################
        {TELEPORT_UNIT id=HunkerEldred 1 2}
        {TELEPORT_UNIT id=Delfador 1 1}
        {FIRE_EVENT skill_shield_cancel}
        {FIRE_EVENT skill_levitate_cancel}
        {FIRE_EVENT skill_counterspell)cancel}
        {FIRE_EVENT skill_polymorph_stoat_cancel}
        {FIRE_EVENT skill_polymorph_bear_cancel}
        {FIRE_EVENT skill_polymorph_crab_cancel}
        {FIRE_EVENT skill_polymorph_roc_cancel}
        {FIRE_EVENT skill_illusion_cancel}

        [foreach]
            array=stored_units_s13
            [do]
                [unstore_unit]
                    variable=this_item
                    find_vacant=yes
                [/unstore_unit]
            [/do]
        [/foreach]
        {KILL( {FILTER_LOCATION( x,y,radius=24,20,1 )} )}
        {KILL( {FILTER_LOCATION( x,y,radius=25,20,1 )} )}

        {TELEPORT_UNIT id=Delfador     25 20} {MODIFY_UNIT id=Delfador     facing sw}
        {TELEPORT_UNIT id=HunkerEldred 24 20} {MODIFY_UNIT id=HunkerEldred facing ne}

        #############################
        # CUTSCENE
        #############################
        {DELAY 250}
        {SCREEN_FADER 0,0,0 0 250}
        {DELAY 2500}
        [message]
            speaker=Delfador
            message= _ "I am Delfador."
        [/message]
        [message]
            speaker=Delfador
            message= _ "And you are dust."
        [/message]
        {SOUND lightning.ogg}
        [item]
            halo=halo/lightning-bolt-2-[1~4].png
            x,y=24,19
        [/item]
        {SCREEN_FADER 255,255,255 255 250}
        {FADE_MUSIC_OUT 4000}
        {SCREEN_FADER 000,000,000 255 5000}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}
        {DELAY 500}

        #############################
        # EPILOGUE
        #############################
        [message]
            speaker,image=narrator,wesnoth-icon.png
            #po: 13 kings is made-up, because 13 is an unlucky number. 12 non-Eldred kings across 500 years makes for an average 42 year reign
            #po: given Wesnoth's access to magical healing, a 42-year reign average seems plausible, if rather high.
            message=_"Thus perishes Eldred, thirteenth king of Wesnoth.

With him ends the story of the sons of Haldric; that unbroken line of kings stretching five hundred years back to the Green Isle itself."
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"The exhausted Delfador fights valiantly against Eldred’s — now Asheviere’s — army, but reinforcements from Weldyn eventually repulse the beleaguered rebels. Neither side wins a decisive military victory."
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"As word spreads of the kings’ deaths, a terrible foreboding seems to settle over the Wesnothian countryside."
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"After all, the civil war has only just begun..."
        [/message]

        #############################
        # CLEANUP
        #############################
        [volume]
            music=100
        [/volume]
        [endlevel]
            result=victory
            linger_mode,carryover_report=no,no
        [/endlevel]
    [/event]

    {HERODEATHS}
[/scenario]

#undef TURNS
#undef ENRAGE_IF_NO_KEEP
#undef ELDRED_SIDE
