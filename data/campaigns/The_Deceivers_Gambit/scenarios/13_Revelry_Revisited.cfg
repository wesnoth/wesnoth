#textdomain wesnoth-tdg

#
# Garard's death is expected here. Plenty of foreshadowing, and any veteran Wesnoth player already knows how the story goes down.
# Deoran's death is hopefully somewhat surprising, and establishes Eldred as a credible threat to player characters.
#

#
# Mechanically, this scenario helps reconcile the difference between a player with a huge recall list vs a tiny recall list.
# If you have a large recall list, you'll need gold in the next scenario to recall them, which means you need to kill a lot of enemy leaders
# But, to recall troops, they also need to escape, which means they can't stick around and kill enemy leaders
# Therefore, the player is forced to choose between evacuating their veterans or using them to kill enemy leaders
#
# A player with a tiny recall list has no such dilemma, and can devote 100% of their gold to killing enemy leaders
#

#wmlindent: start ignoring
#define ESCAPE_TURNS
6#enddef # no variation with difficulty, so units need to be committed to escape or fight, not fight-then-escape. Only the 2 eastern leaders are easy to kill and still escape
#wmlindent: stop ignoring

[scenario]
    id,map_file,name=13_Revelry_Revisited,13_Revelry_Revisited.map,_"Revelry, Revisited"
    next_scenario,victory_when_enemies_defeated=13x_The_King_is_Dead,no
    theme=Cutscene_Minimal
    {DEFAULT_SCHEDULE_FIRST_WATCH} turns=-1 # same as S10x
    {SCENARIO_MUSIC breaking_the_chains.ogg}
    {ADD_WEATHER_RAIN}

    {DE_TRACK {JOURNEY_12_NEW}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name,user_team_name=good,_"Deoran’s Company"
        {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES 1 4}

    #############################
    # ELDRED
    #############################
#define ELDRED_SIDE SIDE TYPE X Y ID TRAITS RECRUIT_LIST
    [side]
        side,controller,color={SIDE},ai,wesred
        type,id,x,y={TYPE},{ID},{X},{Y} {MODIFICATIONS( {TRAITS} )}
        gold={ON_DIFFICULTY4    0 5 10 10} # scale income, not gold. Even if you kill leaders, orcs and boats provide the time pressure
        income={ON_DIFFICULTY4 -2 1  8  8} # assume 2 villages per side. Increased income scaling, since guards don't scale as much
        recruit={RECRUIT_LIST}
        team_name,user_team_name=good,_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES_AREA {SIDE} {X} {Y} 6}
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
    [event]
        name,first_time_only=side {SIDE} turn,no
        {RESET_SIDE_AI {SIDE} defensive 0.2 0.6}
        #         {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME {SIDE} 1} # slow
    [/event]
#enddef
    {ELDRED_SIDE 2 ({ON_DIFFICULTY4 "Red Mage"          "Silver Mage"   "Silver Mage"   "Silver Mage"  }) 15 18 eldred2 ({TRAIT_RESILIENT  }{TRAIT_STRONG     })  "Mage"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Red Mage" {ON_DIFFICULTY4 0 1 1 1}}

    {ELDRED_SIDE 3 ({ON_DIFFICULTY4 "Shock Trooper"     "Iron Mauler"   "Iron Mauler"   "Iron Mauler"  }) 10 16 eldred3 ({TRAIT_RESILIENT  }{TRAIT_INTELLIGENT})  "Spearman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Shock Trooper" {ON_DIFFICULTY4 0 0 1 1}}
    [event]
        name=prestart
        {MODIFY_UNIT id=eldred3 name _"Sir Grey"} # AD reference: this is a leader from Dan'Tonk
    [/event]

    {ELDRED_SIDE 4 ({ON_DIFFICULTY4 "General"           "General"       "General"       "General"      }) 14 12 eldred4 ({TRAIT_STRONG     }{TRAIT_RESILIENT  })  "Spearman,Bowman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Swordsman" {ON_DIFFICULTY4 0 1 1 1}}
    [event]
        name=prestart
        [store_unit]
            {FILTER id=eldred4}
            variable,kill=stored_eldred4,yes
        [/store_unit]
        [unit]
            {SINGLEUNITWML_DOMMEL}
            side=$stored_eldred4.side
            x,y=$stored_eldred4.x,$stored_eldred4.y
            id=eldred4
        [/unit]
        {CLEAR_VARIABLE stored_eldred4}
    [/event]

    {ELDRED_SIDE 5 ({ON_DIFFICULTY4 "Heavy Infantryman" "Shock Trooper" "Shock Trooper" "Shock Trooper"}) 21  9 eldred5 ({TRAIT_INTELLIGENT}{TRAIT_RESILIENT  })  "Heavy Infantryman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Swordsman" {ON_DIFFICULTY4 0 0 1 1}}

    {ELDRED_SIDE 6 ({ON_DIFFICULTY4 "Swordsman"         "Swordsman"     "Swordsman"     "Swordsman"    }) 38 15 eldred6 ({TRAIT_INTELLIGENT}{TRAIT_QUICK      })  "Spearman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Pikeman" {ON_DIFFICULTY4 0 1 1 1}}
    [event]
        name=prestart
        {MODIFY_UNIT id=eldred6 name _"Sir Johan"} # AD reference: this is Isolde's husband
    [/event]

    {ELDRED_SIDE 7 ({ON_DIFFICULTY4 "Longbowman"        "Master Bowman" "Master Bowman" "Master Bowman"}) 36 10 eldred7 ({TRAIT_QUICK      }{TRAIT_INTELLIGENT})  "Bowman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Javelineer" {ON_DIFFICULTY4 0 0 1 1}}
    [event]
        name=prestart
        {MODIFY_UNIT id=eldred7 name _"Sir Gwido"} # AD reference: this is a leader from Tath
    [/event]

    {ELDRED_SIDE 8 ({ON_DIFFICULTY4 "Fencer"            "Duelist"       "Duelist"       "Duelist"      })  1  8 eldred8 ({TRAIT_STRONG     }{TRAIT_QUICK      })  "Fencer"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Pikeman" {ON_DIFFICULTY4 0 1 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Duelist" {ON_DIFFICULTY4 0 0 1 1}}
    {STARTING_VILLAGES_AREA 8 13 1 1} # otherwise multiple side send scouts to this one village

    #############################
    # ORCS
    #############################
    [side]
        side,controller,color=9,ai,black
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=bad,_"Clan Blackcrest" {FLAG_VARIANT6 ragged}
    [/side]
    [side]
        side,controller,color=10,ai,black
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=bad,_"Clan Blackcrest" {FLAG_VARIANT6 ragged}
    [/side]

    [event]
        name,first_time_only=side 9 turn,no
        {RESET_SIDE_AI 9,10 defensive 0.9 0.1}
        # make orcs group up, so they advance a little slower. Gives the player more time to do things
        # doesn't seem to work too well though...
        #        {VARY_AI_BY_SCHEDULE 9,10} # this was slow
    [/event]

    # dummy side, used to store escaped units until the scenario ends (at which point they get swapped back to side 1, for the player to use next scenario)
    [side]
        side,controller,color=11,ai,black
        no_leader,hidden,gold,income=yes,yes,0,-2
    [/side]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # GOLD PICKUP
        #############################
        # ensure the player has enough gold to recall all their veterans. This is bad for balance, but good for enjoyment.
        # players won't be happy if they have no chance to save parts of their recall list.
        {VARIABLE gold_pickup 0}
        [store_unit]
            {FILTER( side,level=1,2-99 )}
            variable=stored_veterans
        [/store_unit]
        [foreach]
            array=stored_veterans
            [do] {VARIABLE_OP gold_pickup add 25}
            [/do] # give 25 instead of 20, to account for upkeep while recalling.
        [/foreach]
        {VARIABLE_OP gold_pickup sub 200} # the player starts with 8 free recalls
        {CLEAR_VARIABLE stored_veterans}

        # minimum 200 gold. I expect this to be plenty for the average playthrough; you only get more if you have more than 18 non-cavalry veterans
        # if you have a really massive recall list, turn limit may be a problem, but there's not much I can do about that
        {IF} {VARIABLE_CONDITIONAL gold_pickup less_than {ON_DIFFICULTY4 300 300 300 200}} {THEN({VARIABLE gold_pickup {ON_DIFFICULTY4 300 300 300 200}} )}
        {/IF}
        {GOLD_PICKUP 18 14 items/gold-coins-large.png $gold_pickup "" _"I’ve pillaged $gold_pickup gold from Eldred’s treasury!"} # matching S10x

        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE scenery/signpost.png 12 1}
        {PLACE_IMAGE terrain/castle/encampment/tent2.png 10 16} # these are "keeps"
        {PLACE_IMAGE terrain/castle/encampment/tent2.png 15 18}

        #############################
        # PRE-RECALLED GUARDS
        #############################
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman"}  4  6 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN  4  6 x,y,radius=4,8,3})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"  }  6  8 ({ANIMATE}{FACING nw} {ZONE_GUARDIAN  6  8 x,y,radius=4,8,3})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none"     "none"     "Pikeman"  "Pikeman" }  2 10 ({ANIMATE}{FACING ne} {ZONE_GUARDIAN  2 10 x,y,radius=4,8,3})}

        #############################
        # ELDRED AND GARARD
        #############################
        [unit]
            {SINGLEUNITWML_GARARD_OLD}
            side,x,y,facing=2,28,12,se
        [/unit]
        {RESTORE_GARARD}
        [unit]
            {SINGLEUNITWML_ELDRED_UNARMED}
            side,x,y,facing=2,34,13,sw
        [/unit]

        #############################
        # HIDE DELFADOR
        #############################
        [store_unit]
            {FILTER id=Delfador}
            variable,kill=stored_delfador,yes
        [/store_unit]

        #############################
        # RESTORE RECALL LIST
        #############################
        [foreach]
            array=stored_units_s10x
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y,find_vacant=recall,recall,yes
                [/unstore_unit]
                {FULL_HEAL id=$this_item.id}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_units_s10x}
        {FIRE_EVENT refresh_experience}

        #############################
        # DEORAN
        #############################
        [unstore_unit]
            variable=stored_deoran
            x,y=26,14
        [/unstore_unit]
        {MODIFY_UNIT id=Deoran facing sw}
        {FIRE_EVENT refresh_experience}
        {IF} {VARIABLE_CONDITIONAL poachers_were_recruited equals yes} {THEN(
            [set_extra_recruit]
                id=Deoran
                extra_recruit={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT},Poacher
            [/set_extra_recruit]
        )} {ELSE(
            [set_extra_recruit]
                id=Deoran
                extra_recruit={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT}
            [/set_extra_recruit]
        )} {/IF}
        [modify_unit]
            {FILTER id=Deoran}
            facing=sw
            # leaving [filter_recall] blank or using [true][/true] fails to clear the filter from S11. So I have to list out every possible recruit instead...
            # I also couldn't get this working with {VARIABLE stored_deoran.filter_recall ""}
            [filter_recall]
                type_adv_tree={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT},Poacher,{DELFADOR_CAVALRY_RECRUIT}
            [/filter_recall]
        [/modify_unit]
        [remove_event]
            id=herodeath_deoran
        [/remove_event]

        #############################
        # COMPANION
        #############################
        {RECALL_COMPANION 24 15}
        {MODIFY_UNIT id=$companion_id facing ne}

        #############################
        # GOLD
        #############################
        [store_gold]
            side,variable=1,s11_carryover
        [/store_gold]
        [modify_side]
            side,gold=1,0
        [/modify_side]
    [/event]

    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # AWKWARD CHAT
        #############################
        # the player is expecting something exciting to happen here, after the ending of S11
        # don't jump into it right away. Give a minute to build anticipation; get into the minds of the people who're bored waiting back at camp
        {DELAY 1500}
        [message]
            speaker=$companion_id
            message= _ "So."
        [/message]
        [message]
            speaker=Deoran
            message= _ "So."
        [/message]
        [message]
            speaker=$companion_id
            message= _ "..."
        [/message]
        [message]
            speaker=$companion_id
            message= _ "Guess yer th’ boss now."
        [/message]
        [message]
            speaker=Deoran
            message= _ "It would seem as such. Would that Delfador had stayed."
        [/message]
        {DELAY 5000} # awkward silence

        #         [message]
        #             speaker=$companion_id
        #             message= _ "Ooh, ooh, did’ja ever fight a dragon? I hear they’s wings’re wider than a city, and their breath hotter th’ a volcano!"
        #         [/message]
        #         [message]
        #             speaker=Deoran
        #             message= _ "No, I have not. Such a majestic crea—"
        #         [/message]
        #         {MODIFY_UNIT id=Garard facing sw}
        #         {MODIFY_UNIT id=Deoran facing se}
        #         [message]
        #             speaker=Garard
        #             message= _ "Dragonslayer? Not I, but such was my ancestor — Haldric I, first king of Wesnoth. Such great things, the achievements of my forefathers... and their brothers..."
        #         [/message]
        #         {DELAY 5000}

        [message]
            speaker=$companion_id
            message= _ "Hey, is it true what they says? Tha’ elves are th’ greatest bestest most beautifulest creatures there are? I’ve always wanted to meet ’em."
        [/message]
        [message]
            speaker=Deoran
            #po: referencing the events of TSG
            message= _ "Elves? No. Be not fooled by a pretty face — I have seen even the noblest elven sage corrupted to such darkness as to rival the foulest human or orc."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Although, I suppose there is at least one young elf of my acquaintance to whom I might ascribe such virtues. My thoughts find her often, in these dark times."
        [/message]
        {DELAY 1000}
        {MODIFY_UNIT id=Deoran facing sw}
        {DELAY 4000}

        #############################
        # GARARD DIES
        #############################
        [lua]
            code = << wesnoth.interface.skip_messages(false) >>
        [/lua]
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,40,14,sw
            animate=yes
        [/unit]
        {MOVE_UNIT id=Kestrel 35 13}
        {MODIFY_UNIT id=Eldred facing se}
        [message]
            speaker=Kestrel
            message= _ "Sir, Delfador and the Royal Cavalry are out of sight."
        [/message]
        {DELAY 500}
        {MOVE_UNIT id=Eldred 29 12}
        {MODIFY_UNIT id=Garard facing se}
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Father.</span>"
        [/message]
        [message]
            speaker=Garard
            message= _ "All healed up? Excellent. We’ll soon put this rebellion to rest."
        [/message]
        [message]
            speaker=Garard
            message= _ "I admit, I was worried about you, son. <i>“Soft”</i> I thought — if I should fall, could you truly lead our people to victory? I wanted to toughen you up."
        [/message]
        [message]
            speaker=Garard
            #po: I think this is the only time Garard actually calls Eldred by his name. Not "boy" or "son"
            message= _ "But now? Sniffing out treachery in our own family? Taking it upon yourself to bring Arand to justice! You may have failed to defeat him, but failure does not diminish the trying. You did well today, Eldred."
        [/message]
        {KILL id=Eldred}
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,29,12,sw
        [/unit]
        {MODIFY_UNIT id=Eldred side 9}
        {DELAY 500}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [harm_unit]
            {FILTER id=Garard} {FILTER_SECOND id=Eldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,63
        [/harm_unit]
        [object]
            {FILTER id=Garard}
            [effect]
                apply_to=image_mod
                add="R(100)"
            [/effect]
        [/object]
        [message]
            speaker=Garard
            message= _ "(shocked) You—"
        [/message]
        [harm_unit]
            {FILTER id=Garard} {FILTER_SECOND id=Eldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,999
        [/harm_unit]
        [color_adjust]
            red,green,blue=255,0,0
        [/color_adjust]
        {KILL id=Garard ANIMATE=yes}
        [color_adjust]
            red,green,blue=0,0,0
        [/color_adjust]
        {MODIFY_UNIT x,y=0-28,0-12 facing se}
        {MODIFY_UNIT x,y=0-28,13-99 facing ne}
        {MODIFY_UNIT x,y=29-99,0-12 facing sw}
        {MODIFY_UNIT x,y=29-99,13-99 facing nw}

        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Finally.</span>"
        [/message]
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "No!"
        [/message]

        #############################
        # ELDRED RALLIES THE TROOPS
        #############################
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>You all saw tha—</span>"
        [/message]
        [message]
            speaker=Eldred
            message= _ "(gulp, deep breath)"
        [/message]
        {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        {APPEND_MUSIC weight_of_revenge.ogg}
        {DELAY 2300} # it takes 2.3 seconds for the_dangerous_symphony to start playing properly
        [message]
            speaker=Eldred
            message= _ "You all saw that! DEORAN HAS SLAIN THE KING!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "What!? I—"
        [/message]
        [message]
            speaker=Eldred
            message= _ "He strikes in cold blood, at the height of my father’s triumph! He takes revenge for his long years of exile! Only a heart shaped by hate and twisted by elves could commit such a foul deed!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "You—"
        [/message]
        [message]
            speaker=eldred4
            message= _ "Calamity! The ambassador always seemed so polite! How could he do this? How could we let him do this?!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I—"
        [/message]
        [message]
            speaker=eldred3
            message= _ "We all know Deoran’s quarrels with the king. All this while he must have been biding his time, plotting his revenge! And look, that outlaw of Delfador’s stands beside him, witness and accomplice to the crime!"
        [/message]
        {MODIFY_UNIT id=Deoran facing sw}
        [message]
            speaker=Deoran
            message= _ "No, no! $companion_name is not my accomplice— I mean, neither of us are accomplices— that is to say—"
        [/message]
        [modify_side]
            {FILTER_SIDE side=2-99}
            team_name=bad
        [/modify_side]
        [message]
            speaker=eldred2
            message= _ "I knew it was a bad idea to let rabble like that back into our homeland! Get them both; avenge the king!"
        [/message]
        {MODIFY_UNIT id=Deoran facing se}

        #############################
        # CREATE GUARDS
        #############################
        # reduced scaling. Instead we have increased gold scaling
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "Mage"              "Mage"              "Mage"              "Mage"             } 13 19 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN 13 19 x,y,radius=12,17,4})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "Fencer"            "Duelist"           "Duelist"           "Duelist"          } 15 16 ({ANIMATE}{FACING se} )}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}  9 18 ({ANIMATE}{FACING ne} {ZONE_GUARDIAN  9 18 x,y,radius=12,17,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"              "Spearman"          "Spearman"          "Spearman"         }  9 15 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN  9 15 x,y,radius=12,17,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"              "Shock Trooper"     "Shock Trooper"     "Shock Trooper"    } 12 15 ({ANIMATE}{FACING nw} {ZONE_GUARDIAN 12 15 x,y,radius=12,17,4})}

        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "Spearman"          "Swordsman"         "Swordsman"         "Swordsman"        } 12 11 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN 12 11 x,y,radius=14,12,4})}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "Spearman"          "Spearman"          "Spearman"          "Spearman"         } 17 13 ({ANIMATE}{FACING ne} )}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none"              "Spearman"          "Spearman"          "Spearman"         } 20 12 ({ANIMATE}{FACING nw} )}

        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "Spearman"          "Swordsman"         "Swordsman"         "Swordsman"        } 22 10 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN 22 10 x,y,radius=21,8,4})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none"              "Shock Trooper"     "Shock Trooper"     "Shock Trooper"    } 19  8 ({ANIMATE}{FACING nw} {ZONE_GUARDIAN 19  8 x,y,radius=21,8,4})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"} 23  9 ({ANIMATE}{FACING ne} {ZONE_GUARDIAN 23  9 x,y,radius=21,8,4})}

        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "Bowman"            "Bowman"            "Bowman"            "Bowman"           } 40 12 ({ANIMATE}{FACING se} {ZONE_GUARDIAN 40 12 x,y,radius=40,11,6})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "Bowman"            "Longbowman"        "Longbowman"        "Longbowman"       } 37 15 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN 37 15 x,y,radius=40,11,6})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none"              "Spearman"          "Spearman"          "Spearman"         } 38 10 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN 38 10 x,y,radius=40,11,6})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "Javelineer"        "Javelineer"        "Javelineer"        "Javelineer"       } 34 10 ({ANIMATE}{FACING sw} {ZONE_GUARDIAN 34 10 x,y,radius=40,11,6})}

        #############################
        # DEORAN DECIDES ON HIS PLAN
        #############################
        {MODIFY_UNIT id=Deoran facing sw}
        [message]
            speaker=Deoran
            message= _ "(aghast) Horrors below, Garard’s own son; what has happened to my beautiful kingdom? How—"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I don’t— what do I do? They all believe Eldred!? I’m not ready for a fight!"
        [/message]
        {GET_COMPANION_ID}
        [message]
            speaker=$companion_id
            message= _ "Listen boss, I ain’t much fer politics, but I knows when to run and that’s now! We’ve got to get out of here!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I— yes, you’re right! With Garard dead, Delfador commands the greatest honest force left in Wesnoth, and he has no idea what has just transpired! Delfador must be warned."
        [/message]
        [message]
            speaker=Deoran
            message= _ "If we are lucky, we may yet be able to save Arand from Delfador’s ill-informed assault. But even barring that, Delfador’s leadership can surely rally enough soldiers to oppose Eldred by force of arms!

$companion_name, go, now! Slip away along the eastern road!"
        [/message]
        {MOVE_UNIT id=$companion_id 32 12}
        {DELAY 500}

        {MODIFY_UNIT id=$companion_id facing nw}
        {MODIFY_UNIT id=Deoran facing ne}
        [message]
            speaker=$companion_id
            message= _ "Wait jus’ a moment! How come you yerself ain’t movin’? Don’t be stayin’ behind to sacrifice yourself or nothin’ like that now, you hear?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Nothing so heroic. Wesnoth’s forces may believe me a conspirator now, but I will not give up on them so easily. If I fight my way into a private audience with each leader I’m sure I can make them see the truth about Eldred — Garard’s poor family relationships were no secret.

Even if I can but convince commanders to delay their support for the traitor prince, that will give Delfador and me much-needed time to gather gold before our next battle!"
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "<i>Defeating enemy leaders will increase your starting gold in the next scenario.</i>"
        [/message]
        [message]
            speaker=Deoran
            message= _ "When at last my strength is spent, I will flee through the forest — my steed is elf-stock, and no rival bred in Wesnoth can outpace its haste amongst the trees. But the more support I can garner now, the better our position will be in the future!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Now make haste, and godspeed! You must reunite with Delfador; I will send what soldiers I can spare after you!"
        [/message]

        {MOVE_UNIT id=$companion_id 36 11}
        {MODIFY_UNIT id=Deoran facing se}
        {MODIFY_UNIT id=Kestrel facing se}
        [message]
            x,y=36,10
            message= _ "Avenge the king! Don’t let them escape!"
        [/message]
        {MOVE_UNIT id=$companion_id 37 12}
        {ANIMATE_ATTACK x,y=36,10 () no x,y=36,11}

        {MOVE_UNIT id=$companion_id 40 13}

        {MODIFY_UNIT id=$companion_id side 11}
        {PUT_TO_RECALL_LIST id=$companion_id}

        {ANIMATE_ATTACK x,y=40,12 () no x,y=40,13}

        #############################
        # RECALL DEORAN'S STARTING TROOPS
        #############################
        # once again we use L2 units for backups, as a catch-up mechanic for a player with no recall list
        {DELAY 500}
        {MODIFY_UNIT id=Deoran facing sw}
        {RECALL_INFANTRYMAN 2 27 15 "White Mage" ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_RESILIENT}}   {ANIMATE} )}
        {RECALL_INFANTRYMAN 2 25 16 "Javelineer" ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
        {RECALL_BANDIT      2 25 13 "Rogue"      ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_INFANTRYMAN 2 26 13 "Javelineer" ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
        {RECALL_BANDIT      2 28 13 "Outlaw"     ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_RESILIENT}}   {ANIMATE} )}
        {RECALL_BANDIT      2 22 14 "Rogue"      ( {ADD_MODIFICATION {TRAIT_RESILIENT}} {ADD_MODIFICATION {TRAIT_STRONG}}      {ANIMATE} )}
        {RECALL_BANDIT      0 27 16 "Footpad"    ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_INFANTRYMAN 0 30 14 "Spearman"   ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
#ifndef NIGHTMARE
#ifndef HARD
        # on lower difficulties give the player a few more units with which to fight
        {RECALL_INFANTRYMAN 0 25 16 "Fencer"     ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
        {RECALL_BANDIT      0 25 13 "Footpad"    ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_BANDIT      0 27 16 "Thief"      ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_INFANTRYMAN 0 30 14 "Fencer"     ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
#endif
#endif
        {DELAY 500}

        #############################
        # PREPARE BATTLEFIELD
        #############################
        {VARIABLE escape_turns_remaining {ESCAPE_TURNS}}
        [event]
            name=side 1 turn end
            first_time_only=no
            {VARIABLE_OP escape_turns_remaining sub 1}
        [/event]

        {SET_LABEL 18 14 _"$gold_pickup gold"} # do this now instead of at the beginning, so it's not so obvious that this is a combat scenario
        [change_theme]
        [/change_theme]
        {VARIABLE bonus_gold 0}
        [capture_village]
            side,x,y,radius=1,26,14,3
        [/capture_village]
        {KILL id=Eldred} # do this now so that it's disguised by the objectives
        {KILL id=Kestrel}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat as many enemy leaders as possible (bonus gold next scenario)."
                condition=win
            [/objective]
            [objective]
                {OPTIONAL_OBJECTIVE_CAPTION}
                # po: $|escape_turns_remaining is probably between 0 and 10
                description= _ "Evacuate veteran units along the eastern road ($|escape_turns_remaining turns remaining)"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                description=_"When an enemy leader is defeated, their remaining soldiers will flee."
            [/note]
            [note]
                red,blue,green=0,255,255
                description="<b>" + _"This is the second-to-last scenario." + "</b>" # same formatting as {IS_LAST_SCENARIO}. Included here so players won't feel too bad about losing veterans
            [/note]
        [/objectives]

        [listen_for_mousemove]
        [/listen_for_mousemove]
        [event]
            name=mousemove_synced
            [do_command]
                [fire_event]
                    raise=mousemove # convert to a synced context
                [/fire_event]
            [/do_command]
        [/event]
        [event]
            name=select
            [do_command]
                [fire_event]
                    raise=mousemove # convert to a synced context
                [/fire_event]
            [/do_command]
        [/event]
        [event]
            name=mousemove,recruit,recall,side 1 turn end
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message= _ "Units that escape to the east will be available to recall in the next scenario, but units that do not escape will be lost (either scattered or killed) — including units on your recall list! The eastern path will remain open until the end of turn {ESCAPE_TURNS}.

You should evacuate enough veterans to have a strong recall list next scenario, but also defeat enough enemy leaders so that you’ll have gold for recalling."
            [/message]

            {PLACE_IMAGE items/gohere.png 40 10}
            {PLACE_IMAGE items/gohere.png 40 11}
            {PLACE_IMAGE items/gohere.png 40 13}
            {HIGHLIGHT_IMAGE 40 12 items/gohere.png ()}
        [/event]
    [/event]

    #############################
    # UNIT ESCAPES
    #############################
    [event]
        name,first_time_only=moveto,no
        {FILTER( side,x,y=1,40,10-13 {NOT id=Deoran} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL escape_turns_remaining greater_than 0} )}

        {MODIFY_UNIT id=$unit.id side 11}
        {PUT_TO_RECALL_LIST id=$unit.id}
    [/event]
    [event]
        name,first_time_only=moveto,no
        {FILTER( side,x,y=1,40,10-13 {AND id=Deoran} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL escape_turns_remaining greater_than 0} )}
        [message]
            speaker=Deoran
            message= _ "Fleeing too quickly will only seal my guilt in the eyes of Wesnoth’s commanders. I do not intend to run until I have no other choice!"
        [/message]
        [allow_undo]
        [/allow_undo]
    [/event]

    #############################
    # WARN ABOUT ORCS
    #############################
    [event]
        name=turn {ESCAPE_TURNS}
        {IF} {HAVE_UNIT side,count=1,4-99} {THEN(
            [message]
                speaker=Deoran
                message= _ "I hear orc-drums approaching the eastern road! Any more who wish to flee — now is your last chance."
            [/message]
        )} {ELSE(
            [message]
                speaker=Deoran
                message= _ "I hear orc-drums approaching the eastern road! Our time runs short."
            [/message]
        )} {/IF}
    [/event]

    #######################################################################################################################################################
    #                                                                   LEADER DEATHS
    #######################################################################################################################################################
#define GIVE_AIS_GOLD AMOUNT
    [gold]
        side=2,3,4,5,6,7,8
        amount={AMOUNT}
    [/gold]
#enddef
    #############################
    # GIVE BONUS GOLD
    #############################
    [event]
        name=prestart
        {VARIABLE bonus_per_leader {ON_DIFFICULTY4 75 75 75 50}}
    [/event]
    [event]
        name,first_time_only=give_bonus_gold,no

        # the first time you kill a leader, Deoran reminds you to evacuate some units
        {FIRE_EVENT keep_captured_explanation}

        # each leader gives Delfador gold in the next scenario
        {VARIABLE_OP bonus_gold add $bonus_per_leader}
        {IF} {VARIABLE_CONDITIONAL s11_carryover greater_than 0}{THEN(
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message= _ "You will now start the next scenario with $bonus_gold total gold (plus $s11_carryover carryover from Delfador)"
            [/message]
        )} {ELSE(
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message= _ "You will now start the next scenario with $bonus_gold total gold!"
            [/message]
        )} {/IF}

        # special event if you kill all leaders (which is very unlikely on high difficulties)
        {FIRE_EVENT are_all_leaders_dead}
    [/event]
    [event]
        name=keep_captured_explanation
        {DELAY 500}
        [store_gold]
            side=1
        [/store_gold]
        {IF} {VARIABLE_CONDITIONAL gold greater_than 25} {THEN(
            [message]
                speaker=Deoran
                message= _ "One leader is defeated. I had hoped to gain a new ally, but depriving Eldred and buying time is good enough. And now that this keep is ours, I can recruit more soldiers to aid in the fight."
            [/message]
        )} {ELSE(
            [message]
                speaker=Deoran
                message= _ "One leader is defeated. I had hoped to gain a new ally, but depriving Eldred and buying time is good enough."
            [/message]
        )} {/IF}
        [message]
            speaker=Deoran
            message= _ "I should remember — soldiers I evacuate east will be available to fight Eldred later, but if I evacuate too many I will be too weak to fight effectively here!"
        [/message]
    [/event]
    [event]
        name=ill_will_dialogue
        # don't trigger this on the first leader we kill
        {FILTER_CONDITION( {HAVE_UNIT(
            id=eldred2,eldred3,eldred4,eldred5,eldred6,eldred7,eldred8
            count=0-5
        )} )}
        [message]
            speaker=Deoran
            message= _ "So much ill will... The captains of old would have died for their king."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Perhaps it is not a coincidence that so many of the old guard fell in battle against the orcs."
        [/message]
    [/event]

    #         [message]
    #             speaker=unit
    #             message= _ "I would rather fall upon my own blade than be captured by you, traitor! May I rejoin my king in death!"
    #         [/message]
    #         [message]
    #             speaker=Deoran
    #             message= _ "No, wait! You don’t—"
    #         [/message]
    #         [event]
    #             name=die
    #             [message]
    #                 speaker=Deoran
    #                 message= _ "—need to die."
    #             [/message]
    #             [message]
    #                 speaker=Deoran
    #                 message= _ "Eldred, wherever you’re hiding, may you someday feel remorse for all the good men and women of Wesnoth who have died today."
    #             [/message]
    #             {KILL( side=$unit.side {NOT role=reinforcement} )}
    #             {FIRE_EVENT give_bonus_gold}
    #         [/event]

    #############################
    # ELDRED-2 DIES (SILVER MAGE)
    #############################
    [event]
        name=last breath {FILTER id=eldred2}
        [message]
            speaker=Deoran
            message= _ "You are defeated, mage! Lend me your ear and hear the truth about Garard’s death! ’twas not I who struck the blow, but Prince Eldred!"
        [/message]
        [message]
            speaker=unit
            message= _ "I’m not stupid, Deoran; I’ve heard the whispers about how Asheviere is raising her son. But isn’t it all for the best? Garard wasn’t going to give up warmongering until we were all dead; at least this way maybe I can get back to Alduin in one piece!"
        [/message]

        {IF} {HAVE_UNIT side,canrecruit=$unit.side,no} {THEN(
            [message]
                speaker=Deoran
                message= _ "You care so little for the affairs of Wesnoth? Then go; lead your magi home, and trouble the mainland no more."
            [/message]
        )} {ELSE(
            [message]
                speaker=Deoran
                message= _ "You care so little for the affairs of Wesnoth? Then go; return home to Alduin, and trouble the mainland no more."
            [/message]
        )} {/IF}

        {KILL( side=$unit.side {NOT role=reinforcement} )}
        {FIRE_EVENT give_bonus_gold}
        {FIRE_EVENT ill_will_dialogue}

        # manually award XP to whoever got the kill, since we need to manually kill the leader to prevent their death animation
        [modify_unit]
            {FILTER id=$second_unit}
            experience="$( $this_unit.experience + 24 )"
        [/modify_unit]
    [/event]

    #############################
    # ELDRED-3 DIES (SIR GREY)
    #############################
    [event]
        name=last breath {FILTER id=eldred3}
        [message]
            speaker=unit
            message= _ "(<i>spits</i>) Traitor. Kill me if you must, but I will never betray my country."
        [/message]
        [message]
            speaker=Deoran
            message= _ "My comrade-in-arms, you already have. Look around! Eldred commands you to fight and die on his behalf, while he himself has fled the battlefield.

Are these the actions of an orphaned son, filled with a righteous desire for vengeance? Or is this a scheming usurper, pitting his kingdom against itself while he watches from a safe distance?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "You know me, Sir Grey; we have fought side by side for many years now. Do you truly believe that I would conspire with Delfador to assassinate the king?"
        [/message]
        {IF} {HAVE_UNIT side,canrecruit=$unit.side,no} {THEN(
            [message]
                speaker=unit
                message= _ "I <i>thought</i> I knew you... I’m just not sure anymore. Who speaks the truth? Maybe I need to get back to Dan’Tonk, away from all this fighting, and take time to think. Men, let’s get out of here!"
            [/message]
        )} {ELSE(
            [message]
                speaker=unit
                message= _ "I <i>thought</i> I knew you... I’m just not sure anymore. Who speaks the truth? Maybe I need to get back to Dan’Tonk, away from all this fighting, and take time to think."
            [/message]
        )} {/IF}
        {KILL( side=$unit.side {NOT role=reinforcement} )}
        {FIRE_EVENT give_bonus_gold}

        # manually award XP to whoever got the kill, since we need to manually kill the leader to prevent their death animation
        [modify_unit]
            {FILTER id=$second_unit}
            experience="$( $this_unit.experience + 24 )"
        [/modify_unit]
    [/event]

    #############################
    # ELDRED-4 DIES (COLONEL DOMMEL)
    #############################
    [event]
        name=last breath {FILTER id=eldred4}
        [message]
            speaker=Deoran
            message= _ "Colonel! You’re a man of experience, and a man of wisdom. Do you not care for your king? Do you truly believe that it was by my hand he fell?"
        [/message]
        [message]
            speaker=unit
            message= _ "I cared for Garard, but I care even more for the soldiers and common folk of Wesnoth, folk who have just been plunged into civil war."
        [/message]
        [message]
            speaker=unit
            message= _ "Whether the deed was done by your hand or Eldred’s, it is my duty as a commander to end the fighting as swiftly as possible. And that means crushing your revolt."
        [/message]
        [message]
            speaker=Deoran
            message= _ "You poor fool... can you not guess what horrors will come with a kin-slayer on the throne? Sometimes we must fight not just for the people of today, but for the people who will come after."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I should finish you off, but your heart is in the right place. I cannot bear to slay a righteous man. Begone."
        [/message]

        {KILL( side=$unit.side {NOT role=reinforcement} )}
        {FIRE_EVENT give_bonus_gold}

        # manually award XP to whoever got the kill, since we need to manually kill the leader to prevent their death animation
        [modify_unit]
            {FILTER id=$second_unit}
            experience="$( $this_unit.experience + {ON_DIFFICULTY4 16 24 24 24} )"
        [/modify_unit]
    [/event]

    #############################
    # ELDRED-5 DIES (SHOCK TROOPER)
    #############################
    [event]
        name=last breath {FILTER id=eldred5}
        [message]
            speaker=Deoran
            message= _ "You—"
        [/message]
        [message]
            speaker=unit
            message= _ "Don’t even start. Garard dragged me away from my life of luxury to be an officer in his lousy war. I always wanted him dead, and I’m glad someone finally built up the courage to do it."
        [/message]
        [message]
            speaker=unit
            message= _ "Kill me if you must, but I’ll never condemn the prince’s actions. From what I hear, Garard was a pretty lousy father and husband too. Now am I free to go, or not?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "..."
        [/message]
        [message]
            speaker=unit
            message= _ "That’s what I thought. Now get out of my way — my men and I are going back home to Weldyn."
        [/message]
        {KILL( side=$unit.side {NOT role=reinforcement} )}
        {FIRE_EVENT give_bonus_gold}
        {FIRE_EVENT ill_will_dialogue}

        # manually award XP to whoever got the kill, since we need to manually kill the leader to prevent their death animation
        [modify_unit]
            {FILTER id=$second_unit}
            experience="$( $this_unit.experience + 16 )"
        [/modify_unit]
    [/event]

    #############################
    # ELDRED-6 DIES (SIR JOHAN)
    #############################
    [event]
        name=last breath {FILTER id=eldred6}
        [message]
            speaker=Deoran
            message= _ "Your sword has failed you, knight of Wesnoth! Now use your ears instead, and hear the truth about our King Garard’s death!"
        [/message]
        [message]
            speaker=unit
            message= _ "Spare me the theatrics, Deoran. I know Eldred’s the one who took down the old tyrant."
        [/message]
        [message]
            speaker=unit
            message= _ "But gold is gold, and the prince has offered my wife and me a whole lot of it to stick with the “official” story.

Prince Eldred knows how to reward his allies. Give up now, accept the blame, and he might even let you spend the rest of your days back in exile instead of prison."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Garard was no hero, but you, soldier, are a villain. May your heirs prove wiser than you were."
        [/message]
        {ANIMATE_ATTACK id=$second_unit.id () no x,y=$unit.x,$unit.y}
        [event]
            name=die
            {KILL( side=$unit.side {NOT role=reinforcement} )}
            {FIRE_EVENT give_bonus_gold}
            {FIRE_EVENT ill_will_dialogue}
        [/event]
    [/event]

    #############################
    # ELDRED-7 DIES (SIR GWIDO)
    #############################
    [event]
        name=last breath {FILTER id=eldred7}
        [message]
            speaker=unit
            message= _ "Wait, please don’t kill me Deoran! I know that you would never betray Garard, but what do you expect me to do about it!? If even the king can be killed, what hope do I have if I speak up?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Then stand alongside me, and we will fight together for the truth! Eldred’s lies cannot be allowed to spread."
        [/message]
        [message]
            speaker=unit
            message= _ "Fighting together with you didn’t do the king much good, did it? No, my company and I are getting back to Tath while we still have the chance! Maybe the witch will know what to do next..."
        [/message]
        {KILL( side=$unit.side {NOT role=reinforcement} )}
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "...witch?"
        [/message]
        {FIRE_EVENT give_bonus_gold}

        # manually award XP to whoever got the kill, since we need to manually kill the leader to prevent their death animation
        [modify_unit]
            {FILTER id=$second_unit}
            experience="$( $this_unit.experience + {ON_DIFFICULTY4 16 24 24 24} )"
        [/modify_unit]
    [/event]

    #############################
    # ELDRED-8 DIES (DUELIST)
    #############################
    [event]
        name=last breath {FILTER id=eldred8}
        [message]
            speaker=Deoran
            message= _ "Stand down! Hold your sword and hear me out! By the very Sceptre itself, I swear I did not kill the king!"
        [/message]
        [message]
            speaker=unit
            message= _ "Wait, what!? King Garard is dead!? I heard a commotion in camp and sent my fighters to help — how did the king die? What are you doing here?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Your ignorance is truly a relief to hear, for Prince Eldred has slain the king, and blamed me for the fell deed! I have been fighting most fiercely against Eldred and his allies. If you are in any shape to help, I could sorely use your aid."
        [/message]
        [message]
            speaker=unit
            message= _ "I— yes, of course! Anything I can do."
        [/message]

        {MODIFY_UNIT id=$unit.id hitpoints 23}
        {MODIFY_UNIT id=$unit.id canrecruit no}
        {MODIFY_UNIT side=8 side 1}

        {FIRE_EVENT give_bonus_gold}
    [/event]

    #############################
    # ALL LEADERS ARE DEAD
    #############################
    [event]
        name=are_all_leaders_dead
        {FILTER_CONDITION({HAVE_UNIT( count,canrecruit=0,yes {AND side=2,3,4,5,6,7,8} )})}

        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "That’s the last of the leaders. Eldred has been deprived of his entire northern force! Well done, well done all!"
        [/message]
        {ACHIEVE s13}
        [message]
            speaker=Deoran
            message= _ "All that now remains is for us to hold as long as possible, and be a nuisance to Eldred’s orcish allies! The longer we survive, the longer Delfador will have to prepare!"
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Survive as long as possible (bonus gold next scenario)."
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                red,blue,green=0,255,255
                description="<b>" + _"This is the second-to-last scenario." + "</b>"
            [/note]
        [/objectives]

        #############################
        # GAIN GOLD EACH TURN
        #############################
        [event]
            name=new turn
            first_time_only=no
            {VARIABLE_OP bonus_gold add 5} # small amount per-turn; this is only here for the rare few players who survive this long
            {IF} {VARIABLE_CONDITIONAL s11_carryover greater_than 0}{THEN(
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    message= _ "You will now start the next scenario with $bonus_gold total gold (plus $s11_carryover carryover from Delfador)"
                [/message]
            )} {ELSE(
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    message= _ "You will now start the next scenario with $bonus_gold total gold!"
                [/message]
            )} {/IF}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                 INFINITE ORC SPAWNS
    #######################################################################################################################################################
    [event]
        name=side 8 turn {ESCAPE_TURNS} end
        [replace_map]
            map_file=13b_Revelry_Revisited.map
            expand=yes
        [/replace_map]

        #############################
        # SPAWN EAST
        #############################
        # no difficulty scaling: these guys are more of a time limit rather than a force to be fought
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Adept"     "Orcish Adept"     "Orcish Adept"     "Orcish Adept"      }) 48 15 ()} # these guys were previously off-map; no need to animate
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 46 16 ()}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 48 16 ()}

        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Archer"    "Orcish Archer"    "Orcish Arcner"    "Orcish Archer"     }) 43  7 ()}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Archer"    "Orcish Archer"    "Orcish Archer"    "Orcish Archer"     }) 47  8 ()}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 48 10 ()}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 47  7 ()}

        #############################
        # SPAWN NORTHEAST
        #############################
        # no difficulty scaling: these guys are more of a time limit rather than a force to be fought
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Archer"    "Orcish Archer"    "Orcish Arcner"    "Orcish Archer"     }) 39 1 ({ANIMATE})}
        {GENERIC_UNITC 9 ({ON_DIFFICULTY4 "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 34 3 ({ANIMATE})}

        #############################
        # SPAWN NORTH
        #############################
        # no difficulty scaling: these guys are more of a time limit rather than a force to be fought
        {GENERIC_UNITC 10 ({ON_DIFFICULTY4 "Orcish Archer"   "Orcish Archer"    "Orcish Arcner"    "Orcish Archer"     })  6  1 ({ANIMATE})}
        {GENERIC_UNITC 10 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      })  5  3 ({ANIMATE})}

        {GENERIC_UNITC 10 ({ON_DIFFICULTY4 "Orcish Adept"    "Orcish Adept"     "Orcish Shaman"    "Orcish Shaman"     }) 11  1 ({ANIMATE})}
        {GENERIC_UNITC 10 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 10  1 ({ANIMATE})}
        {GENERIC_UNITC 10 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"     "Orcish Grunt"     "Orcish Grunt"      }) 12  2 ({ANIMATE})}
        {GENERIC_UNITC 10 ({ON_DIFFICULTY4 "Orcish Archer"   "Orcish Archer"    "Orcish Arcner"    "Orcish Archer"     }) 21  1 ({ANIMATE})}
        [unit]
            type,id,name=Orcish Sovereign,Ghuvog,_"Chief Ghuvog"
            profile=portraits/orcs/grunt-6.webp
            x,y=13,2 {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_RESILIENT} )}
            side,canrecruit,facing=10,yes,se
            animate=yes
        [/unit]

        #############################
        # INTRODUCE ORCS
        #############################
        {REMOVE_IMAGE 40 10}
        {REMOVE_IMAGE 40 11}
        {REMOVE_IMAGE 40 12}
        {REMOVE_IMAGE 40 13}
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,22,1,sw
            animate=yes
        [/unit]
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,23,2,sw
            animate=yes
        [/unit]

        [message]
            speaker=Ghuvog
            message= _ "Grah ha ha ha, thanks for the tip-off, kid! Time for Chief Ghuvog to have a little fun with all youse pinkskins!"
        [/message]
        [message]
            speaker=Eldred
            message= _ "<i><b>Just</b></i> the rebels, beast — remember our deal. Stay north of the river and you shall be rewarded most generously once Mother and I have consolidated our control."
        [/message]
        {SCROLL_TO 45 14}
        [message]
            speaker=Deoran
            message= _ "Eldred has betrayed our strife to the orcish clans! With grunts swarming along the riverbank, the road east to Delfador is no longer safe. There will be no more escape that way."
        [/message]
        {KILL id=Eldred} {KILL id=Kestrel}
        {KILL id=Ghuvog} {KILL id=Ragash}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat as many enemy leaders as possible (bonus gold next scenario)."
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                red,blue,green=0,255,255
                description="<b>" + _"This is the second-to-last scenario." + "</b>"
            [/note]
        [/objectives]

        #############################
        # PREVENT SURPRISE ATTACK
        #############################
        # since this is the first time the orcs have spawned, don't let them attack immediately.
        # We won't be as nice for future spawns
        [event]
            name=side 9 turn refresh
            {MODIFY_UNIT side=9 moves 2}
            {MODIFY_UNIT side=9 attacks_left 0}
        [/event]
        [event]
            name=side 10 turn refresh
            {MODIFY_UNIT side=10 moves 2}
            {MODIFY_UNIT side=10 attacks_left 0}
        [/event]
    [/event]

    #############################
    # CONSTANT ORC SPAWNS
    #############################
    # no difficulty scaling: these guys are more of a time limit rather than a force to be fought
    [event]
        name,first_time_only=side 9 turn refresh,no
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than {ESCAPE_TURNS}} )}

        # spawn fewer orcs if we already have a lot, so that the map doesn't look overly crowded
        {IF} {HAVE_UNIT side,count=9,0-99} {THEN( {VARIABLE_OP repeat rand 0,0,1,2} )}
        {/IF}
        {IF} {HAVE_UNIT side,count=9,0-9 } {THEN( {VARIABLE_OP repeat rand 0,1,2,3} )}
        {/IF}
        {IF} {HAVE_UNIT side,count=9,0-5 } {THEN( {VARIABLE_OP repeat rand 3,4,5,6} )}
        {/IF}
        {IF} {HAVE_UNIT side,count=9,0-2 } {THEN( {VARIABLE_OP repeat rand 5,6,7,8} )}
        {/IF}
        {IF} {VARIABLE_CONDITIONAL turn_number greater_than 20} {THEN( {VARIABLE_OP repeat rand 9,13,15,17} )}
        {/IF} # if the player is surviving way too long, start spawning large numbers of orcs

        {REPEAT $repeat (
            {VARIABLE_OP type  rand ("Orcish Grunt","Orcish Archer","Orcish Archer","Goblin Pillager","Goblin Pillager")}
            {VARIABLE_OP x     rand 47,48}
            {VARIABLE_OP y     rand 5,7,8,9,10,15,16,17,18,19,20}
            {VARIABLE_OP moves rand 2,3,4}
            {GENERIC_UNITC 9 $type $x $y (
                [+unit]
                    moves=$moves # don't let newly spawned units move too far (but they are allowed to attack!)
                [/unit]
            )}
        )}
        {CLEAR_VARIABLE x,y,type,rand}
    [/event]

    [event]
        name,first_time_only=side 10 turn refresh,no
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than {ESCAPE_TURNS}} )}

        # spawn fewer orcs if we already have a lot, so that the map doesn't look overly crowded
        {IF} {HAVE_UNIT side,count=10,0-99} {THEN( {VARIABLE_OP repeat rand 0,0,1,2} )}
        {/IF}
        {IF} {HAVE_UNIT side,count=10,0-9 } {THEN( {VARIABLE_OP repeat rand 0,1,2,3} )}
        {/IF}
        {IF} {HAVE_UNIT side,count=10,0-5 } {THEN( {VARIABLE_OP repeat rand 3,4,5,6} )}
        {/IF}
        {IF} {HAVE_UNIT side,count=10,0-2 } {THEN( {VARIABLE_OP repeat rand 5,6,7,8} )}
        {/IF}
        {IF} {VARIABLE_CONDITIONAL turn_number greater_than 20} {THEN( {VARIABLE_OP repeat rand 9,13,15,17} )}
        {/IF} # if the player is surviving way too long, start spawning large numbers of orcs

        {REPEAT $repeat (
            {VARIABLE_OP type rand ("Orcish Grunt","Orcish Warrior","Orcish Adept","Orcish Shaman","Orcish Assassin")}
            {VARIABLE_OP x rand 5,6,7,11,12,15,17,20,21}
            {VARIABLE_OP y rand 1,2}
            {VARIABLE_OP moves rand 2,3,4}
            {GENERIC_UNITC 10 $type $x $y (
                [+unit]
                    moves=$moves # don't let newly spawned units move too far (but they are allowed to attack!)
                [/unit]
            )}
        )}
        {CLEAR_VARIABLE x,y,type,rand}
    [/event]

    #######################################################################################################################################################
    #                                                                INFINITE HUMAN SPAWNS
    #######################################################################################################################################################
    [event]
        name=side 7 turn 10
        [message]
            side=2,3,4,5,6,7,8,9
            canrecruit=yes
            message= _ "Deoran’s still putting up a fight! Reinforcements — call reinforcements from across the river!"
        [/message]
        {GENERIC_UNITC 3 "Boat"              1 20 ({ANIMATE}{IMMOBILE}{FACING ne})}
        {GENERIC_UNITC 3 "Transport Galleon" 2 21 ({ANIMATE}{IMMOBILE}{FACING ne})}
        {GENERIC_UNITC 3 "Boat"              4 21 ({ANIMATE}{IMMOBILE}{FACING nw})}

        #############################
        # ONE SPAWN
        #############################
        [event]
            name=reinforce_eldred
            first_time_only=no

            {SCROLL_TO 14 20}
            {IF} {HAVE_UNIT type=Boat,"Transport Galleon"} {THEN(
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman"}) 2 20 ({ROLE reinforcement})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"  }) 3 21 ({ROLE reinforcement})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"  }) 3 19 ({ROLE reinforcement})}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"     "none"     "Bowman"  }) 5 21 ({ROLE reinforcement})}
            )} {/IF}

            # reduced difficulty scaling: these guys are more of a time limit rather than a force to be fought
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    }) 24 21 ({ROLE reinforcement})}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Mage"              "Mage"              "Mage"              "Mage"             }) 25 21 ({ROLE reinforcement})}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 24 20 ({ROLE reinforcement})}

            {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"  }) 30 21 ({ROLE reinforcement})}
            {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Fencer"   "Fencer"   "Duelist"  "Duelist" }) 31 21 ({ROLE reinforcement})}
            {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"     "Spearman" "Spearman" "Spearman"}) 32 21 ({ROLE reinforcement})}
        [/event]
        {FIRE_EVENT reinforce_eldred}

        #############################
        # CONTINUAL SPAWNS
        #############################
        [event]
            name,first_time_only=side 8 turn end,no
            {FILTER_CONDITION(
                {VARIABLE_CONDITIONAL turn_number equals 12}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 14}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 16}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 18}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number greater_than_equal_to 20}  )}
            )}
            {FIRE_EVENT reinforce_eldred}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # DEORAN DIES
    #############################
    [event]
        name=last breath {FILTER id=Deoran}

        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}

        #############################
        # DEORAN FLEES
        #############################
        {IF} {HAVE_UNIT side,canrecruit=1,no} {THEN(
            [message]
                speaker=unit
                message= _ "Agony! My arm goes limp, I can fight no longer. Any allies yet standing, scatter, scatter to the hills! It is me they will chase, not you."
            [/message]
            [message]
                speaker=unit
                message= _ "And as for me, well, I may have cut things rather closer than I had planned. But what’s done is done — my thoughts must now turn to flight. Make haste, my loyal steed!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Deoran
                message= _ "Agony! My arm goes limp, I can fight no longer. This may be cutting things rather closer than I had planned, but what’s done is done."
            [/message]
            [message]
                speaker=unit
                message= _ "My thoughts must now turn to flight: make haste, my loyal steed!"
            [/message]
        )} {/IF}
        {KILL( side=1 {NOT id=Deoran} )}
        {KILL( x,y=17,6 {FILTER_LOCATION radius=2} {NOT id=Deoran} )} # clear out the cutscene area
        {KILL( x,y=12,4 {FILTER_LOCATION radius=2} {NOT id=Deoran} )}
        {KILL( x,y=8,2  {FILTER_LOCATION radius=3} {NOT id=Deoran} )}

        {MOVE_UNIT id=Deoran 17 6}
        {MOVE_UNIT id=Deoran 12 4}
        {MOVE_UNIT id=Deoran  8 2}
        {REPLACE_SCENARIO_MUSIC heroes_rite.ogg}

        #############################
        # KESTREL STRIKES
        #############################
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,9,2,sw
        [/unit]
        [harm_unit]
            {FILTER id=Deoran} {FILTER_SECOND id=Kestrel}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,11
        [/harm_unit]
        [message]
            speaker=Deoran
            message= _ "<b><i>NNnrgh!</i></b>"
        [/message]

        #############################
        # ELDRED GLOATS
        #############################
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,5,1,se
            animate=yes
        [/unit]
        {MOVE_UNIT id=Eldred 7 3} # flanking Deoran with their ZoCs
        [message]
            speaker=Eldred
            message= _ "(grins)"
        [/message]
        {MODIFY_UNIT id=Deoran facing nw}
        [message]
            speaker=Eldred
            message= _ "Well, well, if it isn’t Deoran the exile, one-time commander of the South Guard; a soldier to the very end. I’ve heard all about you, you know. A perfect example of who not to be."
        [/message]
        [message]
            speaker=Eldred
            #po: "black bottle" foreshadowing
            message= _ "Did you really think you could win? Even if you had bested my army — yes, it’s <b><i>my</i></b> army now — I now carry with me so much magic that I’ll never have to lose another fight."
        [/message]

        [message]
            speaker=Deoran
            message= _ "At last the usurper dares to face me, now that I am too injured for battle. He knows his actions are unforgivable. He knows he cannot face me in a fair fight."
        [/message]
        [message]
            speaker=Eldred
            message= _ "I also know you’re a man of your word, so I’m going to give you a choice. You can surrender, leave Wesnoth, and swear to never again raise arms up against my rule."
        [/message]
        [message]
            speaker=Eldred
            message= _ "Or you can fight, die, and have your corpse hoisted upon the walls of Weldyn as a warning to others. Which will it be, exile?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "More than anything does my spirit yearn to go on fighting, to risk it all on a chance at vanquishing the one responsible for all this wretched destruction!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "But my heart remembers better places, happier times. There are... people I wish to speak to, things I have left unsaid..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Prince Eldred, I lay down my arms and accept your offer of surrender."
        [/message]

        #############################
        # DEORAN DIES
        #############################
        [harm_unit]
            {FILTER id=Deoran} {FILTER_SECOND id=Eldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,17
        [/harm_unit]
        [color_adjust]
            red,green,blue=255,0,0
        [/color_adjust]
        {KILL id=Deoran ANIMATE=yes}
        [color_adjust]
            red,green,blue=0,0,0
        [/color_adjust]
        {DELAY 500}
        [message]
            speaker=Eldred
            message= _ "Idiot."
        [/message]
        [message]
            speaker=Eldred
            message= _ "..."
        [/message]
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Not a deceitful bone in his body. I didn’t even have to drink the potion. That’s... a relief.</span>"
        [/message]
        [message]
            speaker=Kestrel
            message= _ "The traitor is vanquished! Now hail, hail to your new king!"
        [/message]

        #############################
        # HAIL TO THE KING
        #############################
        # speaker 1
        {STORE_UNIT_VAR (race,canrecruit=human,yes {AND side=3,4,5,6,7,8}) id speaker1_id}
        {IF} {VARIABLE_CONDITIONAL speaker1_id equals $null} {THEN(
            {STORE_UNIT_VAR (race,canrecruit=human,no {AND side=3,4,5,6,7,8}) id speaker1_id}
        )} {/IF}
        [message]
            id=$speaker1_id
            image_pos=left
            message= _ "Hail King Eldred!"
        [/message]

        # speaker 2
        {STORE_UNIT_VAR (race,canrecruit=human,yes {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}) id speaker2_id}
        {IF} {VARIABLE_CONDITIONAL speaker2_id equals $null} {THEN(
            {STORE_UNIT_VAR (race,canrecruit=human,no {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}) id speaker2_id}
        )} {/IF}
        [message]
            id=$speaker2_id
            image_pos,mirror=right,yes
            message= _ "Hail, long live King Eldred!"
        [/message]

        # speaker 3
        {STORE_UNIT_VAR (race,canrecruit=human,yes {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}{NOT id=$speaker2_id}) id speaker3_id}
        {IF} {VARIABLE_CONDITIONAL speaker3_id equals $null} {THEN(
            {STORE_UNIT_VAR (race,canrecruit=human,no {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}{NOT id=$speaker2_id}) id speaker3_id}
        )} {/IF}
        [message]
            id=$speaker3_id
            image_pos=left
            message= _ "Long live the king!"
        [/message]
        {CLEAR_VARIABLE speaker1_id,speaker2_id,speaker3_id}

        # closing
        {DELAY 500}
        [message]
            speaker=Eldred
            message= _ "Yes. Long live the king."
        [/message]
        {DELAY 1500}

        #############################
        # CLEANUP
        #############################
        {KILL side=1}
        {MODIFY_UNIT side=11 side 1} # so they're available for Delfador to recall
        {CLEAR_VARIABLE escape_turns_remaining}
        [unstore_unit]
            variable=stored_delfador # unstore this so we have the correct leader name / side id / whatever for the next scenario
            x,y=recall,recall
        [/unstore_unit]
        {FIRE_EVENT refresh_experience}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 0}
            music=silence.ogg
        [/endlevel]
    [/event]

    {HERODEATHS}
[/scenario]

#undef ELDRED_SIDE
#undef ESCAPE_TURNS
