#textdomain wesnoth-tdg

[scenario]
    id,map_file,name=10_Houses_of_the_Dead,10_Houses_of_the_Dead.map,_"Houses of the Dead"
    next_scenario,victory_when_enemies_defeated=10x_Elensefar_Outskirts,no
    {UNDERGROUND} turns=-1
    {SCENARIO_MUSIC the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}
    {EXTRA_SCENARIO_MUSIC suspense.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name,user_team_name=wesnoth,_"Delfador"
        income,village_gold=-2,0
        fog,shroud=yes,yes
        {FLAG_VARIANT loyalist}
    [/side]

    #############################
    # UNDEAD
    #############################
    [side]
        side,controller,color=2,ai,white
        no_leader,hidden=yes,yes
        team_name,user_team_name=undead,_"Omaranth’s Flight"
        {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI  2 no 0.99 0.01}
        {MODIFY_SIDE_AI 2 retreat_factor=0}
    [/event]
    # prevent AI undead from using their ranged attacks, or else we risk using them on Delfador and getting incinerated
    [event]
        name=unit placed
        first_time_only=no
        {FILTER type_adv_tree=Ghost}
        {GIVE_OBJECT_TO id=$unit.id (id=disable_wail {EFFECT attack range,attack_weight=ranged,0})}
    [/event]

    #############################
    # FAUNA
    #############################
    [side]
        side,controller,color=3,ai,green
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=fauna,_"Fauna"
        {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI  3 no 0.99 0.01}
        {MODIFY_SIDE_AI 3 retreat_factor=0}
    [/event]

    [side]
        side,controller,color=4,ai,white
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name=wesnoth
        {FLAG_VARIANT6 ragged}
    [/side]

    #######################################################################################################################################################
    #                                                                    ENTRYWAY
    #######################################################################################################################################################
    [event]
        name=prestart
        {PLACE_IMAGE "items/bones.png" 11 29}
        {GENERIC_UNIT 3 (Giant Rat) 11 29} {GUARDIAN}
        [unit]
            {SINGLEUNITWML_OMARANTH}
            x,y,facing,animate=6,31,se,yes
        [/unit]
        {SCROLL_TO 1 37} # bottom-left-hand corner, with a lot of empty space. This stops the portraits from [message]s in the initial cutscene from covering up Delfador/Omaranth
    [/event]
    #############################
    # INITIAL CUTSCENE
    #############################
    [event]
        name=start
        [message]
            speaker,caption,image=Omaranth,"",wesnoth-icon.png # can't use narrator unless I recall Delfador
            #po: notice that appears at the beginning of the scenario if you select Brutal difficulty
            message=_"Meanwhile..."
        [/message]

        #############################
        # OMARANTH FLEES INTO THE CAVES
        #############################
        {DELAY 500}
        [unstore_unit]
            variable=stored_delfador
            x,y,animate=1,32,yes
        [/unstore_unit]
        {MODIFY_UNIT id=Delfador facing ne}
        {CLEAR_VARIABLE stored_delfador}
        [heal_unit]
            {FILTER side=1}
            amount=full
            moves=full
            restore_attacks=yes
        [/heal_unit]
        {REFRESH_FOG} {DELAY 250}
        {MOVE_UNIT id=Delfador 2 31} {REFRESH_FOG}
        {MOVE_UNIT id=Delfador 3 32} {REFRESH_FOG}
        {MOVE_UNIT id=Delfador 4 31} {REFRESH_FOG}
        {DELAY 500}
        [message]
            speaker=Delfador
            message=_"Stand and fight me, drake! You and your saurians have caused Wesnoth enough harm. In the name of King Garard, your villainy ends here."
        [/message]
        [message]
            speaker=Omaranth
            message=_"..."
        [/message]
        {MOVE_UNIT id=Omaranth 15 22}
        {KILL id=Omaranth}
        {DELAY 750}
        [message]
            speaker=Delfador
            message=_"...I suppose we’ll have to do this the hard way."
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find Omaranth"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=100,no
            [/gold_carryover]
            [note]
                description= _ "In this scenario, you can neither gain nor spend gold."
            [/note]
        [/objectives]

        #         {STORE_SKILLS}
        #         {VARIABLE skill_fireball3 yes} # start with a generic l3 fireball and no other skills
        #         {FIRE_EVENT refresh_delfador_skills}
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
    [/event]

    #######################################################################################################################################################
    #                                                                    MEET AETHYR
    #######################################################################################################################################################
#define DRAKE_HALO X Y HALO
    [item]
        x,y={X},{Y}
        halo=units/drakes/{HALO}~GS()~CS(-65,-65,-50)
        visible_in_fog=no
    [/item]
#enddef
#define DRAKE_ITEM X Y IMG
    [item]
        x,y={X},{Y}
        image=units/drakes/{IMG}~GS()~CS(-50,-50,-50)
        visible_in_fog=no
    [/item]
#enddef
#define COFFIN X Y
    {PLACE_IMAGE "items/coffin-closed.png~CS(-50,-50,-50)" {X} {Y}}
#enddef
#define COFFIN_EMERGE X Y TYPE
    {REMOVE_IMAGE {X} {Y}}
    {PLACE_IMAGE "items/coffin-open.png~CS(-50,-50,-50)" {X} {Y}}
    {GENERIC_UNIT 2 {TYPE} {X} {Y}} {ANIMATE} {VARIATION drake}
#enddef
    #############################
    # PRESTART
    #############################
    [event]
        name=prestart
        {COFFIN  9 23}
        {COFFIN 10 22}
        {COFFIN 11 22}
        {COFFIN 13 25}
        {COFFIN 14 24}
        {COFFIN 15 24}
        {DRAKE_ITEM  8 23 "enforcer-blade-2.png"}
        {DRAKE_ITEM 12 25 "glider-kick-5.png"}
        {DRAKE_HALO 15 20 "enforcer-blade-2.png~FL()"}
        {DRAKE_HALO 19 22 "blademaster-fire-se-2.png~FL()"}
        {DRAKE_HALO 16 21 "flare-lead-2.png~FL()"}
    [/event]
    #############################
    # FORESHADOWING
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=14,22,4} )}
        [message]
            speaker=Delfador
            message=_"A drakish tomb? This looks ominous..."
        [/message]
        [event]
            name=new turn
            {SOUND zombie-attack.wav}

            {COFFIN_EMERGE 11 22 "Walking Corpse"}
            {COFFIN_EMERGE 10 22 "Walking Corpse"}
#ifndef EASY
            {COFFIN_EMERGE 13 25 "Soulless"}
            {COFFIN_EMERGE 15 24 "Walking Corpse"}
#endif
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none" "Walking Corpse" "Walking Corpse"}) 18 21 ({ANIMATE} {VARIATION drake})}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none" "Walking Corpse" "Walking Corpse"}) 17 21 ({ANIMATE} {VARIATION drake})}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none" "Soulless"       "Soulless"      }) 16 20 ({ANIMATE} {VARIATION drake})}

            # maybe the same Aethyr from TRoW, maybe just a coincidence
            # spawn him out of sight, and have him run straight towards Delfador
            {NAMED_UNIT 2 Wraith 27 16 Aethyr "" (facing=sw)} {ADD_MODIFICATION({TRAIT_LOYAL_HERO_NOSLOT})}

            #             {UNSTORE_SKILLS} # restore the skills we chose in S09
            #             {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
            #             {FIRE_EVENT mousemove}
        [/event]
    [/event]

    #############################
    # CONVERT AETHYR
    #############################
    [event]
        name=moveto
        {FILTER_CONDITION({HAVE_UNIT( id=Delfador {FILTER_ADJACENT id=Aethyr} )})}

        [message]
            speaker=Delfador
            message=_"A ghost! Walking corpses are a great evil, but mastery over spirits is far fouler still. Damned vessels, conscious but enslaved... yet where there are enchantments, there are opportunities."
        [/message]
        {FIRE_EVENT remove_polymorph}
        {FIRE_EVENT skill_counterspell_cancel}
        #         {STORE_UNIT_VAR id=Aethyr x x}
        #         {STORE_UNIT_VAR id=Aethyr y y}
        #         {MOVE_UNIT id=Delfador $x "$($y+1)"}
        #         {CLEAR_VARIABLE x,y}
        [message]
            speaker=Delfador
            message=_"I must concentrate. The slightest mistake in the casting of this spell could be fatal."
        [/message]
        {DELAY 750}
        {ANIMATE_UNIT id=Delfador skill_ghostcapture_start}
        {GIVE_OBJECT_TO id=Delfador id=skill_ghostcapture_standing}
        {SOUND lightning.ogg}
        {COLOR_ADJUST  200  100  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        {SOUND lightning.ogg}
        {COLOR_ADJUST  100  200  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        {SOUND lightning.ogg}
        {COLOR_ADJUST  100  100  200} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"I call upon the name of An-Usrukhar the Great. I invoke the Mirror of Evanescent Time!"
        [/message]
        {SOUND lightning.ogg}
        {COLOR_ADJUST  100  200  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"I challenge life against death! I invoke freedom against order! I wield light against darkness!"
        [/message]
        {SOUND lightning.ogg}
        {COLOR_ADJUST  200  100  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"May the coils of servitude be broken! Spirit of the damned, be freed from your master."
        [/message]
        {REMOVE_OBJECT skill_ghostcapture_standing id=Delfador}
        {ANIMATE_UNIT id=Delfador skill_ghostcapture_end}
        {DELAY 250}

        #############################
        # AETHYR SPEAKS
        #############################
        {REMOVE_OBJECT disable_wail id=Aethyr}
        {MODIFY_UNIT id=Aethyr side 4}
        {DELAY 250}
        [message]
            speaker=Aethyr
            message=_"..."
        [/message]
        [message]
            speaker=Aethyr
            message=_"My mind... is my own..."
        [/message]
        [message]
            speaker=Delfador
            message=_"Speak, spectre! Tell me of this place. Where is the drake they call the “Great One”?"
        [/message]
        [message]
            speaker=Aethyr
            message=_"I do not know. I know nothing of drakes. I am a man. My name is Aethyr... I had almost forgotten. I died long ago, in a great battle..."
        [/message]
        {MODIFY_UNIT id=Aethyr name _"Aethyr"}
        [message]
            speaker=Delfador
            message=_"You’re the spirit of a human? How did you come to roam these drakish halls, so far from the lands of men?"
        [/message]
        [message]
            speaker=Aethyr
            message=_"Iliah-Malal brought me here. He made me promises of life renewed, but instead bound me to his will. Perhaps Iliah-Malal will know of your drake."
        [/message]
        [message]
            speaker=Delfador
            message=_"A necromancer? Troubling. Yes, I should very much like to meet this Iliah-Malal."
        [/message]
        {MODIFY_UNIT id=Aethyr side 1}
        {FIRE_EVENT restore_polymorph}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find Omaranth"
                condition=win
            [/objective]
            [objective]
                description= _ "Find Iliah-Malal"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=100,no
            [/gold_carryover]
            [note]
                description= _ "Delfador can capture hostile ghosts by moving adjacent to them, unless he is polymorphed."
            [/note]
            [note]
                description= _ "Allied ghosts will not follow you to the next scenario."
            [/note]
            [note]
                description= _ "In this scenario, you can neither gain nor spend gold."
            [/note]
        [/objectives]
    [/event]

    #######################################################################################################################################################
    #                                                                   OTHER GHOSTS
    #######################################################################################################################################################
#define GHOST_CAPTURE_EVENT GHOST_ID WML
    [event]
        # trigger this if Delfador moves adjacent to a ghost, or if we cancel polymorph while adjacent to a ghost
        name=moveto,new turn,skill_polymorph_finished_cancelling
        {FILTER_CONDITION({HAVE_UNIT( id,race=Delfador,human {FILTER_ADJACENT id={GHOST_ID}} )})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL side_number equals 1})}

        {ANIMATE_UNIT id=Delfador skill_ghostcapture_start}
        {GIVE_OBJECT_TO id=Delfador id=skill_ghostcapture_standing}

        {FIRE_EVENT skill_counterspell_cancel} # it's not great to waste the player's XP like this, but counterspell is 100% useless in this scenario anyway
        {SOUND lightning.ogg}
        {COLOR_ADJUST  100  100  200} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        {SOUND wail.wav}

        {MODIFY_UNIT id={GHOST_ID} side 4}
        {FULL_HEAL id={GHOST_ID}}
        {REMOVE_OBJECT disable_wail id={GHOST_ID}}

        {STORE_UNIT_VAR id={GHOST_ID} x x}
        {STORE_UNIT_VAR id={GHOST_ID} y y}
        [floating_text]
            x,y=$x,$y
            text= _ "<span color='#008800' size='x-small'>Ghost Captured</span>"
        [/floating_text]
        {CLEAR_VARIABLE x,y}

        {REMOVE_OBJECT skill_ghostcapture_standing id=Delfador}
        {ANIMATE_UNIT id=Delfador skill_ghostcapture_end}
        {DELAY 500}

        {WML}
        {MODIFY_UNIT side,id=4,{GHOST_ID} side 1} # don't change side if {WML} has made the ghost hostile

        {IF} {HAVE_UNIT side,type_adv_tree,count=1,Ghost,4-99} {THEN({ACHIEVE s10})}
        {/IF}
    [/event]
#enddef
    #############################
    # MUSHROOMS
    #############################
    [event]
        name=prestart
        {NAMED_UNIT 2 Ghost 10 11 Sythan _"Sythan" ()} {ZONE_GUARDIAN 10 11 (x,y,radius=10,11,3)} {ADD_MODIFICATION({TRAIT_LOYAL_HERO_NOSLOT})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 9 15 ({GUARDIAN}{ROLE mushrooms}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 8 13 ({GUARDIAN}{ROLE mushrooms}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 9 13 ({GUARDIAN}{ROLE mushrooms}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 12 9 ({GUARDIAN}{ROLE mushrooms}{VARIATION drake})}
    [/event]
    [event]
        name=moveto,attack,die
        {FILTER role=mushrooms}
        {MODIFY_UNIT role=mushrooms ai_special ""}
        {MODIFY_UNIT role=mushrooms status.guardian "no"}
    [/event]
    {GHOST_CAPTURE_EVENT Sythan (
        [message]
            speaker=Sythan
            message=_"I was once a great lord... I commanded armies! Iliah-Malal promised I would lead again."
        [/message]
        [message]
            speaker=Sythan
            message=_"It was all a lie. I became only his slave."
        [/message]
    )}

    #############################
    # WATER / FLOODED
    #############################
    [event]
        name=prestart
        {NAMED_UNIT 2 Ghost 17 5 VellinKa _"Vellin Ka" (gender=female)} {ZONE_GUARDIAN 17 5 (x,y,radius=17,5,4)} {ADD_MODIFICATION({TRAIT_LOYAL_HERO_NOSLOT})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 20  4 ({GUARDIAN}{ROLE flood}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 19  6 ({GUARDIAN}{ROLE flood}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 16  7 ({GUARDIAN}{ROLE flood}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 21  5 ({GUARDIAN}{ROLE flood}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 16  4 ({GUARDIAN}{ROLE flood}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 20 11 ({GUARDIAN}            {VARIATION swimmer})} # not {ROLE flood}, because this guy's far away
        {PLACE_IMAGE scenery/gate-rusty-sw.png 21 4}
    [/event]
    [event]
        name=moveto,attack,die
        {FILTER role=flood}
        {MODIFY_UNIT role=flood ai_special ""}
        {MODIFY_UNIT role=flood status.guardian "no"}
    [/event]
    {GHOST_CAPTURE_EVENT VellinKa (
        [message]
            speaker=VellinKa
            message=_"Your banners were red.
Your spears were sharp.
Your hearts were cold."
        [/message]
        [message]
            speaker=VellinKa
            message=_"Iliah-Malal led your army.
Iliah-Malal burned our Eyrie.
Iliah-Malal will die."
        [/message]
        [message]
            speaker=Delfador
            message=_"You’re a drake, and Iliah-Malal fought against you alongside... an army of living men? And what of the armageddon drake; how did he survive if the rest of you did not?"
        [/message]
        [message]
            speaker=VellinKa
            message=_"Omaranth was Dominant of our Flight.
Omaranth was strongest in our Eyrie.
Omaranth’s fate was not seen by I."
        [/message]
    )}

    #############################
    # EXIT / THE SUN
    #############################
    [event]
        name=prestart
        {GENERIC_UNIT 2 "Walking Corpse" 36 19} {VARIATION drake} {ROLE sun3} {ZONE_GUARDIAN 36 19 (x,y=1,1)}
        {GENERIC_UNIT 2 "Walking Corpse" 37 19} {VARIATION drake} {ROLE sun2} {ZONE_GUARDIAN 37 19 (x,y=1,1)} # zone_guardian prevents them from moving
        {GENERIC_UNIT 2 "Soulless"       39 20} {VARIATION drake} {ROLE sun1} {ZONE_GUARDIAN 39 20 (x,y=1,1)}
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=38,19,5} )}

        {REVEAL x,y,radius=38,19,3}
        {SCROLL_TO 38 19}
        {DELAY 250}
        {MOVE_UNIT role=sun1 50 23} {KILL role=sun1}
        {MOVE_UNIT role=sun2 50 23} {KILL role=sun2}
        {MOVE_UNIT role=sun3 50 23} {KILL role=sun3}
        {DELAY 500}

        {STORE_UNIT_VAR side,type_adv_tree=1,Ghost id   sun_id}
        {STORE_UNIT_VAR side,type_adv_tree=1,Ghost name sun_name}
        {IF} {HAVE_UNIT side,id=1,$sun_id}
        [then]
            [message]
                id=$sun_id
                message=_"A passage to the world above! Oh, how I long to go through and see the sun again..."
            [/message]
            [message]
                speaker=Delfador
                message=_"Focus, $sun_name. This necromancer Iliah-Malal must have raised these corpses, and now sends them against my allies on the surface. We must not abandon our task here."
            [/message]
        [/then]
        {/IF}
        {CLEAR_VARIABLE sun_id,sun_name}
        {MODIFY_TERRAIN Ha^Xo 39 20}
    [/event]

    #############################
    # SOUTHEAST MINE
    #############################
    [event]
        name=prestart
        {NAMED_UNIT 2 Wraith 29 25 HaghaTan _"Hagha-Tan" ()} {ZONE_GUARDIAN 29 25 (x,y,radius=29,25,3)} {ADD_MODIFICATION({TRAIT_LOYAL_HERO_NOSLOT})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 27 24 ({GUARDIAN}{VARIATION drake}{ROLE southeast})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 28 26 ({GUARDIAN}{VARIATION drake}{ROLE southeast})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 33 25 ({GUARDIAN}{VARIATION drake}{ROLE southeast})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 32 25 ({GUARDIAN}{VARIATION drake}{ROLE southeast})}
    [/event]
    [event]
        name=moveto,attack,die
        {FILTER role=southeast}
        {MODIFY_UNIT role=southeast ai_special ""}
        {MODIFY_UNIT role=southeast status.guardian "no"}
    [/event]
    {GHOST_CAPTURE_EVENT HaghaTan (
        [message]
            speaker=HaghaTan
            message=_"The chief called me to war... I knew the attack was risky, but I was willing..."
        [/message]
        [message]
            speaker=Delfador
            message=_"If you’re a recently-dead orc, what can you tell me about battle plans? Troop movements? Wesnoth can use any help we can get."
        [/message]
        {MODIFY_UNIT id=HaghaTan side 2}
        [message]
            speaker=HaghaTan
            message=_"You are no lord of mine, man of Wesnoth. I serve only my clan."
        [/message]
    )}

    #############################
    # LAVA CHASM ROOM
    #############################
    # this one needs to be lured out onto solid land, so Delfador can convert her
    [event]
        name=prestart
        {NAMED_UNIT 2 Shadow 22 24 Melinna _"Melinna" ()} {GUARDIAN} {GENDER female} {ADD_MODIFICATION({TRAIT_LOYAL_HERO_NOSLOT})} # not role=lava, otherwise the player might not see us until we kill
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 26 20 ({GUARDIAN}{ROLE lava}{VARIATION bat})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 25 20 ({GUARDIAN}{ROLE lava}{VARIATION bat})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 24 21 ({GUARDIAN}{ROLE lava}{VARIATION bat})}
    [/event]
    [event]
        name=moveto,attack,die
        {FILTER role=lava}
        {MODIFY_UNIT role=lava ai_special ""}
        {MODIFY_UNIT role=lava status.guardian "no"}
    [/event]
    {GHOST_CAPTURE_EVENT Melinna (
        [message]
            speaker=Delfador
            message=_"Are you a drake? Do you know anything about Omaranth, or this necromancer Iliah-Malal?"
        [/message]
        [message]
            speaker=Melinna
            message=_"I know only what I knew in life, Delfador. Yes, I recognize you... Garard’s attack dog..."
        [/message]
        [message]
            speaker=Melinna
            message=_"I was once a lady of the court. I only wanted to make peace, to stop the fighting.

But the dead found me in the night. Now I find myself here, in a form reflecting my fate. Why did they hunt me? Why didn’t you keep us all safe..."
        [/message]
    )}

    #######################################################################################################################################################
    #                                                                     BOSS FIGHT
    #######################################################################################################################################################
    #############################
    # GATE
    #############################
    [event]
        name=prestart
        {PLACE_IMAGE "scenery/rune_line_glow.png~FL()" 31 12}
        {PLACE_IMAGE "scenery/rune_line_glow.png~FL()" 32 12}
        {PLACE_IMAGE "scenery/rune_line_glow.png~FL()" 33 13}

        {DRAKE_HALO 32  9 "enforcer-blade-2.png"}
        {DRAKE_HALO 38 13 "glider-kick-5.png"}
        {DRAKE_HALO 34  6 "enforcer-blade-2.png"}
        {DRAKE_HALO 39  5 "blademaster-fire-se-2.png~FL()"}
        {DRAKE_HALO 44  7 "flare-lead-2.png~FL()"}
        {DRAKE_HALO 45 10 "glider-kick-5.png~FL()"}
        {DRAKE_HALO 42 12 "enforcer-blade-2.png~FL()"}
    [/event]
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=31,14,3} )}
        [event]
            name=moveto
            {SCROLL_TO 33 12}
            [message]
                speaker=Delfador
                scroll=no
                message=_"There is a gate here, sealed by runic energy. My magic should be able to open it, but we must be prepared for whatever lies beyond."
            [/message]
        [/event]
    [/event]
    [event]
        name=moveto
        id=explain_gate
        {FILTER( side=1 {NOT id=Delfador} {FILTER_LOCATION(
            x=31,32,33
            y=12,12,13
        )})}
        first_time_only=no
        [message]
            speaker=unit
            message=_"Only Delfador has the power to open these gates... whatever lies beyond will be most dangerous..."
        [/message]
    [/event]
    #############################
    # OPEN THE GATE
    #############################
    [event]
        name=moveto,skill_polymorph_stoat_cancel,skill_polymorph_bear_cancel,skill_polymorph_crab_cancel,skill_polymorph_roc_cancel
        first_time_only=no
        id=open_gate
        {FILTER_CONDITION({HAVE_UNIT( id,race=Delfador,human {FILTER_LOCATION(
            x=31,32,33
            y=12,12,13
        )})})}
        [remove_event]
            id=explain_gate
        [/remove_event]

        [message]
            speaker=Delfador
            message=_"Whatever lurks behind this gate, it will be dangerous. I should make sure I am prepared before I proceed."
            [option]
                label= _ "Open the gate"
                [command]
                [/command]
            [/option]
            [option]
                label= _ "Wait"
                [command]
                    [return]
                    [/return]
                [/command]
            [/option]
        [/message]
        [remove_event]
            id=open_gate
        [/remove_event]

        #------------------------
        # PREPARE OMARANTH
        #------------------------
        [unit]
            {SINGLEUNITWML_OMARANTH}
            x,y,facing,animate=41,7,sw,yes
        [/unit]
        {ZONE_GUARDIAN 38 9 x,y,radius=40,7,6} # don't let Omaranth enter the gate area; make the player leave instead

        #------------------------
        # OPEN THE GATE
        #------------------------
        {MODIFY_UNIT id=Delfador facing ne}
        {FIRE_EVENT skill_counterspell_cancel} # it's not great to waste the player's XP like this, but counterspell is 100% useless in this scenario anyway
        {REMOVE_IMAGE 31 12}
        {REMOVE_IMAGE 32 12}
        {REMOVE_IMAGE 33 13}
        {PLACE_IMAGE "scenery/rune_line.png~FL()" 31 12}
        {PLACE_IMAGE "scenery/rune_line.png~FL()" 32 12}
        {PLACE_IMAGE "scenery/rune_line.png~FL()" 33 13}
        {SOUND lightning.ogg}
        {COLOR_ADJUST  100  100  200} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}

        {SOUND gate-fall.ogg}
        {MODIFY_TERRAIN "Urb^Pr\" 29 13}
        {MODIFY_TERRAIN "Urb^Pr\" 30 13}
        {MODIFY_TERRAIN "Urb^Pr\" 31 14}
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud =yes
        [/redraw]
        {DELAY 500}
        {SOUND gate-fall.ogg}
        {MODIFY_TERRAIN "Urb^Pr\o" 32 11}
        {MODIFY_TERRAIN "Urb^Pr\o" 33 12}
        {MODIFY_TERRAIN "Urb^Pr\o" 34 12}
        {REVEAL x,y,radius=39,9,6}
        [redraw]
            clear_shroud=yes
        [/redraw]
        {DELAY 250}
        {SCROLL_TO 38 8}

        #------------------------
        # MOVE GHOSTS INTO THE CHAMBER
        #------------------------
        # in case the player left their ghosts outside, move them inside so they can be useful
        [store_unit]
            {FILTER( side=1
            {FILTER_LOCATION({NOT(
                x=30,31,   32,   33
                y=12,12-13,12-13,13
            )})} )}
            variable,kill=stored_ghosts,yes
        [/store_unit]
        [foreach]
            array=stored_ghosts
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y,find_vacant=32,12,yes
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_ghosts}

        #------------------------
        # INTRODUCE OMARANTH
        #------------------------
        {FADE_MUSIC_OUT 1000}
        [message]
            speaker=Omaranth
            message=_"..."
        [/message]
        [message]
            speaker=Delfador
            message=_"You! With so many undead about I was expecting to find the necromancer... I don’t entirely understand what’s going on here, but I do know that you’re an enemy of Wesnoth, and that’s good enough for me."
        [/message]
        [message]
            speaker=Omaranth
            message=_"YOU INVADE MY HOME.
YOU SLAY MY SERVANTS.
YOU UNDERSTAND NOTHING."
        [/message]
        [message]
            speaker=Omaranth
            message=_"NOW, YOU DIE."
        [/message]
        {REPLACE_SCENARIO_MUSIC battle-epic.ogg}
        {FADE_MUSIC_IN 100}

        [heal_unit]
            {FILTER side=1}
            amount=0
            moves,restore_attacks=full,yes
        [/heal_unit]

        #------------------------
        # OBJECTIVES
        #------------------------
        [objectives]
            [objective]
                description= _ "Defeat Omaranth"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=100,no
            [/gold_carryover]
            [note]
                description= _ "Allied ghosts will not follow you to the next scenario."
            [/note]
            [note]
                description= _ "In this scenario, you can neither gain nor spend gold."
            [/note]
        [/objectives]
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
    [/event]

    #############################
    # OMARANTH DEFEATED
    #############################
    [event]
        name=last breath
        {FILTER id=Omaranth}

        [store_unit]
            {FILTER id=Omaranth}
            kill,variable=no,stored_omaranth
        [/store_unit]
        [unit]
            {SINGLEUNITWML_MALAL}
            id,name=Omaranth,_"Omaranth"
            x,y,overwrite=1,1,yes
        [/unit]
        {MODIFY_TERRAIN Ai^Qhu $stored_omaranth.x $stored_omaranth.y} # convert to ice before we spawn malal, or else he might be standing on lava
        {DELAY 250}

        [modify_unit]
            {FILTER id=Omaranth}
            canrecruit,facing=yes,$stored_omaranth.facing
            x,y=$stored_omaranth.x,$stored_omaranth.y
            hitpoints=1
            [object]
                id=omaranth_illusion_animation
                {EFFECT new_animation (
                    [standing_anim] # use a standin anim so this isn't affected by acceleration
                        base_score=99
                        {FRAME image=misc/blank-hex.png}
                        overlay_start_time =-400 {OVERLAY_FRAME  alpha,image=1~0,"units/drakes/armageddon-defend-1.png~MASK(masks/teleport-mask-[9~0].png):100"}
                        overlay2_start_time=-600 {OVERLAY2_FRAME (halo_x,halo_y,halo= 10,-30~30,halo/teleport-[9,8,1~9].png:75)}
                        overlay3_start_time=-400 {OVERLAY3_FRAME (halo_x,halo_y,halo=  0,-40~40,halo/teleport-[9,8,1~9].png:75)}
                        overlay4_start_time=-200 {OVERLAY4_FRAME (halo_x,halo_y,halo=-10,-30~30,halo/teleport-[9,8,1~9].png:75)}
                    [/standing_anim]
                )}
            [/object]
        [/modify_unit]

        {SOUND skill-illusion.wav}
        {FADE_MUSIC_OUT 1000}

        #############################
        # REVEAL TO BE ILIAH-MALAL
        #############################
        {KILL id=Omaranth}
        [unit]
            {SINGLEUNITWML_MALAL}
            x,y=$stored_omaranth.x,$stored_omaranth.y
            facing=$stored_omaranth.facing
        [/unit]
        {DELAY 1000}
        [message]
            speaker=Iliah-Malal
            message=_"Ah ha, ha ha ha..."
        [/message]
        {DELAY 500}
        [message]
            speaker=Iliah-Malal
            message=_"Well fought, Delfador! They warned me you were dangerous, but to have found me amidst all the vastness of the north — you have truly exceeded all expectations!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Now the story begins to make sense. The Omaranth I saw was never more than an illusion. You are Iliah-Malal."
        [/message]
        [message]
            speaker=Delfador
            message=_"You wiped out this flight of drakes, and took the visage of their leader. You led the saurians to join Clan Blackcrest, and you sent them to war against Wesnoth. But why? How does all this fighting benefit a mage?"
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"How does all <i><b>your</b></i> fighting benefit <i><b>you</b></i>? Decades of war, and what has been gained? While you bleed for a failing country and an aging king, your whole life is passing you by. You’re on the wrong side of history, Delfador war-mage."
        [/message]
        {DELAY 500}
        [message]
            speaker=Iliah-Malal
            message=_"But you don’t have to be. Walk away! Stop wasting your life in service of a warmonger, and finally act for yourself! Delfador, I have allies under whose patronage you could live like a king, if you would only accept them!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Like a king? I already serve a king, Iliah-Malal, and am well-treated for it. Protecting Wesnoth is my <b><i>duty</i></b>. King Garard is my <b><i>friend</i></b>. I hope you did not think to break me down so easily."
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"Bah, remain a fool, then. You will not find me so easily broken either."
        [/message]
        {ANIMATE_UNIT id=Iliah-Malal fakerecruit} {DELAY 250}

        #############################
        # CLOSE THE GATES
        #############################
        {SOUND gate-fall.ogg}
        {MODIFY_TERRAIN "Urb^Pr\" 32 11}
        {MODIFY_TERRAIN "Urb^Pr\" 33 12}
        {MODIFY_TERRAIN "Urb^Pr\" 34 12}
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]

        # in case the player left their ghosts (or Delfador) outside, we want to move them in so they can be useful
        [store_unit]
            {FILTER( side=1 {FILTER_LOCATION({NOT x,y,radius=39,8,6})} )}
            variable,kill=stored_ghosts,yes
        [/store_unit]
        [foreach]
            array=stored_ghosts
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y,find_vacant=34,11,yes
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_ghosts}

        #############################
        # DARKNESS CLOSES IN
        #############################
        {REPLACE_SCENARIO_MUSIC helios.ogg}
        {FADE_MUSIC_IN 100}
        [message]
            speaker=Iliah-Malal
            message=_"Powers of darkness, confound my foes!"
        [/message]
#define CONTRACT_SHROUD TOTAL_VISION
    # specify x,y so we don't give this to units on the recall list (since REMOVE_OBJECT's SUF doesn't catch these for some reason)
    {REMOVE_OBJECT reduced_vision ()}
    {GIVE_OBJECT_TO (side,x,y=1,0-99,0-99) (id=reduced_vision {EFFECT vision set={TOTAL_VISION}})}
    [place_shroud]
        side,x,y=1,0-99,0-99 # cover all tiles with shroud, including ones we've seen earlier
    [/place_shroud]
    [redraw]
        clear_shroud=yes
    [/redraw]
    {DELAY 750}
#enddef
        {ANIMATE_UNIT id=Iliah-Malal fakerecruit} {CONTRACT_SHROUD 5} # ghosts usually have 7mp/vp
        {ANIMATE_UNIT id=Iliah-Malal fakerecruit} {CONTRACT_SHROUD 3}
        {ANIMATE_UNIT id=Iliah-Malal fakerecruit} {CONTRACT_SHROUD 1}
        {ANIMATE_UNIT id=Iliah-Malal fakerecruit} {CONTRACT_SHROUD 0}
        [event]
            name=unit placed # refresh this every time Delfador polymorphs
            {FILTER side=1}
            {GIVE_OBJECT_TO id=$unit.id (id=reduced_vision {EFFECT vision set=0})}
        [/event]

        #############################
        # SPAWN ZOMBIES
        #############################
        # every X turns, spawn one enemy non-adjacent to the player, out of vision
        [event]
            name=new turn
            first_time_only=no
            {VARIABLE_OP undead_timer add 1}
            {FIRE_EVENT check_undead}
        [/event]
        [event]
            name=check_undead
            first_time_only=no
            {FILTER_CONDITION({VARIABLE_CONDITIONAL undead_timer greater_than_equal_to {ON_DIFFICULTY4 3 2 1 1}})}
            {VARIABLE undead_timer 0}
            [random_placement]
                variable,allow_less=loc,no
                num_items,min_distance=1,1
                [filter_location]
                    terrain=U*^* {AND x,y,radius=40,8,6} # radius needs a separate filter or this breaks
                    {NOT( {FILTER()} )} # only empty hexes
                    {NOT( {FILTER_ADJACENT_LOCATION({FILTER side=1})} )}
                [/filter_location]
                [command] {GENERIC_UNIT 2 "Walking Corpse" $loc.x $loc.y} {ANIMATE} {VARIATION drake}
                [/command]
            [/random_placement]
        [/event]
        {VARIABLE undead_timer 0}
        {REPEAT 3 ({VARIABLE_OP undead_timer add 1} {FIRE_EVENT check_undead})}

        #############################
        # ILIAH-MALAL "TELEPORTS"
        #############################
        {GIVE_OBJECT_TO id=Iliah-Malal ({EFFECT new_animation (
            [standing_anim]
                start_time=-900
                teleport_ring_start_time=-900
                teleport_fill_start_time=-610
                [teleport_ring_frame]
                    duration=900
                    image=halo/dark-teleportA.png
                    alpha=0~1:290,1:320,1~0:290
                [/teleport_ring_frame]
                [teleport_fill_frame]
                    duration=320
                    image=halo/dark-teleportB.png
                    alpha=0~1:150,1:20,1~0:150
                [/teleport_fill_frame]
                [frame]
                    # default frame
                    duration=450
                [/frame]
                [frame]
                    image=misc/blank-hex.png
                    duration=500
                [/frame]
            [/standing_anim]
        )})}
        {DELAY 900}
        {KILL id=Iliah-Malal}

        #############################
        # CREATE MALAL MIRRORS
        #############################
#define CREATE_MALAL_MIRROR ID X Y
    {MODIFY_TERRAIN Cud {X} {Y}} # remove the impassable overlay
    {REMOVE_IMAGE       {X} {Y}} # remove the drake statue overlay
    [unit]
        {SINGLEUNITWML_MALAL}
        id,x,y={ID},{X},{Y}
        facing=se
    [/unit]
    {IF} {HAVE_UNIT id,x={ID},39-99}
    {THEN( {MODIFY_UNIT id={ID} facing sw} )}
    {/IF}
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {MODIFY_UNIT id={ID} moves        0}
        {MODIFY_UNIT id={ID} attacks_left 0}
    [/event]
    [event]
        name=attack
        {FILTER_SECOND id={ID}}
        {SOUND skill-illusion.wav}
        {GIVE_OBJECT_TO id={ID} (
            {EFFECT new_animation (
                [standing_anim] # use a standin anim so this isn't affected by acceleration
                    base_score=99
                    {FRAME image=misc/blank-hex.png}
                    overlay_start_time =-400 {OVERLAY_FRAME  alpha,image=1~0,"units/undead-necromancers/necromancer-defend.png~MASK(masks/teleport-mask-[9~0].png):100"}
                    overlay2_start_time=-600 {OVERLAY2_FRAME (halo_x,halo_y,halo= 10,-30~30,halo/teleport-[9,8,1~9].png:75)}
                    overlay3_start_time=-400 {OVERLAY3_FRAME (halo_x,halo_y,halo=  0,-40~40,halo/teleport-[9,8,1~9].png:75)}
                    overlay4_start_time=-200 {OVERLAY4_FRAME (halo_x,halo_y,halo=-10,-30~30,halo/teleport-[9,8,1~9].png:75)}
                [/standing_anim]
            )}
        )}
        {DELAY 1000}
        {KILL id={ID}}
        {FIRE_EVENT illusion_killed}
    [/event]
#enddef
#define CREATE_MALAL_MIRROR_IF_ID_UNUSED ID
    {IF} {NOT({HAVE_UNIT id={ID}})}
    [then]
        {CREATE_MALAL_MIRROR {ID} $loc.x $loc.y}
        [continue]
        [/continue]
    [/then]
    {/IF}
#enddef
        # replace some statues with illusions of Malal
        [random_placement]
            variable,allow_less=loc,no # if no placement available, Malal doesn't teleport
            num_items={ON_DIFFICULTY4 2 3 4 5}
            [filter_location]
                x=32,34,39,45,42,38 # only put Malal in castles with at least 2 open hexes.
                y= 9, 6, 5,10,12,13 # note that 3-open-hex castles all have light on the adjacent lava tiles, to help balance them with the 2-hex ones
                {NOT( {FILTER_ADJACENT_LOCATION({FILTER side=1})} )}
            [/filter_location]
            [command]
                {CREATE_MALAL_MIRROR_IF_ID_UNUSED mirror1} # awful workaround; I couldn't get other methods of dynamically assigning ID to work consistently
                {CREATE_MALAL_MIRROR_IF_ID_UNUSED mirror2}
                {CREATE_MALAL_MIRROR_IF_ID_UNUSED mirror3}
                {CREATE_MALAL_MIRROR_IF_ID_UNUSED mirror4}
                {CREATE_MALAL_MIRROR_IF_ID_UNUSED mirror5}
                {CREATE_MALAL_MIRROR_IF_ID_UNUSED mirror6}
            [/command]
        [/random_placement]
        {DELAY 500}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find and defeat Iliah-Malal, before his undead overwhelm you."
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            [note]
                description= _ "Allied ghosts will not follow you to the next scenario."
            [/note]
            [note]
                description= _ "In this scenario, you can neither gain nor spend gold."
            [/note]
        [/objectives]
    [/event]

    #############################
    # FIRST MIRROR DIES
    #############################
    [event]
        name=illusion_killed
        [message]
            type_adv_tree="Dark Sorcerer"
            message=_"Nice try, Delfador! You’ve only destroyed another illusion."
        [/message]
    [/event]

    #############################
    # FINAL MIRROR IS DISCOVERED
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_ADJACENT type_adv_tree="Dark Sorcerer"} )}
        {FILTER_CONDITION({HAVE_UNIT count,type_adv_tree=1,"Dark Sorcerer"})}
        {STORE_UNIT_VAR type_adv_tree="Dark Sorcerer" x x}
        {STORE_UNIT_VAR type_adv_tree="Dark Sorcerer" y y}
        {STORE_UNIT_VAR type_adv_tree="Dark Sorcerer" facing facing}
        [unit]
            {SINGLEUNITWML_MALAL}
            x,y,facing=$x,$y,$facing
            overwrite=yes
        [/unit]
        {CLEAR_VARIABLE x,y,facing}
        [message]
            speaker=Iliah-Malal
            message=_"So you have found the real me. No matter. I shall have you yet, Delfador!"
        [/message]
    [/event]

    #############################
    # ILIAH-MALAL ATTACKS
    #############################
    [event]
        name=die
        {FILTER_SECOND id=Iliah-Malal}
        [event]
            name=attack
            {FILTER id=Iliah-Malal}
            [message]
                speaker=Iliah-Malal
                message=_"Shadows consume you!"
            [/message]
        [/event]
    [/event]

    #############################
    # ILIAH-MALAL DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Iliah-Malal}
        [message]
            speaker=Iliah-Malal
            message=_"I should... have kept... my potion..."
        [/message]

        [event]
            name=die
            {KILL id=Iliah-Malal} # or else the animation plays again when we {KILL ANIMATE=yes}

            # spawn a couple undead out of vision, so that they can visibly die later-on
            {VARIABLE undead_timer 99} {FIRE_EVENT check_undead}
            {VARIABLE undead_timer 99} {FIRE_EVENT check_undead}

            # restore the player's vision
            {SOUND magicmissile.wav} {CONTRACT_SHROUD 1}
            {SOUND magicmissile.wav} {CONTRACT_SHROUD 3}
            {SOUND magicmissile.wav} {CONTRACT_SHROUD 5}
            {SOUND magicmissile.wav} {REVEAL x,y,radius=39,9,6}
            {KILL (side=2 {FILTER_LOCATION x,y,radius=39,9,9}) ANIMATE=yes}

            #------------------------
            # DELFADOR AND GHOSTS
            #------------------------
            [message]
                speaker=Delfador
                message=_"Good riddance. With the necromancer dead, his mindless minions have followed. His meddling in life and death has been the cause of great evil."
            [/message]
            {FIRE_EVENT skill_counterspell_cancel}
            {FIRE_EVENT skill_polymorph_stoat_cancel} # must cancel, so we can later banish any remaining chosts.
            {FIRE_EVENT skill_polymorph_bear_cancel}
            {FIRE_EVENT skill_polymorph_crab_cancel}
            {FIRE_EVENT skill_polymorph_roc_cancel}

            {IF} {NOT({HAVE_UNIT side,type_adv_tree=1,Ghost})}
            [then]
                {GENERIC_UNIT 1 Ghost 37  8} {ANIMATE}
                {GENERIC_UNIT 1 Ghost 39 10} {ANIMATE}
            [/then]
            {/IF}

            [message]
                side,type_adv_tree=1,Ghost
                message=_"I am free... free! You have breathed into me a ravenousness for life anew, life to drain from those who roam unfettered under the pale sun. Take us into your service, Delfador; lead us to your foes! Lead us against the living!"
            [/message]
            [message]
                speaker=Delfador
                message=_"No, no! Do not tempt me, I beg you, for that way madness lies... should I ever start down that dark path I would never become free of it."
            [/message]
            [message]
                speaker=Delfador
                message=_"No. But you have been of great service today, and for that you shall be rewarded with peace."
            [/message]
            {DELAY 250}
            {ANIMATE_UNIT id=Delfador skill_ghostcapture_start}
            {GIVE_OBJECT_TO id=Delfador id=skill_ghostcapture_standing}

            {SOUND lightning.ogg}
            {COLOR_ADJUST  100  100  200} {DELAY 150}
            {COLOR_ADJUST    0    0    0} {DELAY 250}
            {REMOVE_OBJECT skill_ghostcapture_standing id=Delfador}
            {ANIMATE_UNIT id=Delfador skill_ghostcapture_end}
            {KILL side,type_adv_tree=1,Ghost ANIMATE=yes}
            [message]
                speaker=Delfador
                message=_"Return to your land of calm and quiet, and trouble the living no longer. I shall save my country without your help."
            [/message]

            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 100}
                music=
            [/endlevel]
        [/event]
    [/event]

    #############################
    # GHOST LAST BREATHS
    #############################
#define GHOST_LAST_BREATH ID MESSAGE
    [event]
        name=last breath
        {FILTER id,side={ID},1}
        [message]
            speaker={ID}
            message={MESSAGE}
        [/message]
    [/event]
#enddef
    {GHOST_LAST_BREATH Aethyr _"From the dead I came, and to the dead I return..."}
    {GHOST_LAST_BREATH Sythan _"Rock and dust, bone and stone..."}
    {GHOST_LAST_BREATH VellinKa _"Avenge my flight..."}
    {GHOST_LAST_BREATH Melinna _"Good luck, Delfador... Don’t trust anyone..."}

    {HERODEATHS}
[/scenario]

#undef CONTRACT_SHROUD
