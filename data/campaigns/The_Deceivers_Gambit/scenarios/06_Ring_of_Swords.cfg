#textdomain wesnoth-tdg

#
# this is a hard mission. You need to both survive and recapture asheviere
# fortunately, you lose your veterans for a large portion of the remianing scenarios, so it's ok to suffer some losses
#   that's also why skill_panacea unlocks
#

[scenario]
    id,map_file,name=06_Ring_of_Swords,06_Ring_of_Swords.map,_"Ring of Swords"
    victory_when_enemies_defeated=no
    {WINTER_SCHEDULE} turns=10 # the actual starting time is set in prestart, and varies depending on S05

    {SCENARIO_MUSIC the_dangerous_symphony.ogg}
    {EXTRA_SCENARIO_MUSIC helios.ogg}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,{ON_DIFFICULTY4 80 80 80 40} # plus a fencer and 2x HI (low hp), and the nigh-guaranteed gold pickup from S05
        team_name,user_team_name=wesnoth,_"Isle of Alduin"
        {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES 1 5}

    #############################
    # WESNOTH ARMY
    #############################
    [side]
        side,controller,color=2,ai,wesred
        {SINGLEUNITWML_GARARD} facing=nw
        gold,income={ON_DIFFICULTY4 50 50 50 50},{ON_DIFFICULTY4 2 4 8 8}
        recruit=Cavalryman,Horseman
        team_name,user_team_name=wesnoth,_"Army of Wesnoth"
        {FLAG_VARIANT loyalist}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Horseman)   2}
    {SILENTLY_LIMIT_MOVES 2 id=Methor 0}
    {SILENTLY_LIMIT_LEADER_MOVES 2 1} # garard can move 1 hex until he arrives at his keep, since Delfador might block it off
    [event]
        name=moveto {FILTER id,x,y=Garard,17,12}
        {SILENTLY_LIMIT_MOVES 2 id=Garard 0} # but once he's at his keep, don't let him move. He likes to get himself cut off and killed
    [/event]
    {STARTING_VILLAGES 2 5}

    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI  2 no -1 1}
        {MODIFY_SIDE_AI 2 (leader_aggression=0.1)} # for some reason, garard almost never attacks with aggression on -1
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=15,12})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=16,11})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y=19,10})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 2 x,y=14,13})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 1 x,y=15,13})}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 1 x,y=18,10})}
        {MODIFY_SIDE_AI 2 (
            [avoid]
                x=0-13, 14,   15,   16,   17,   18,  19, 20-99
                y=0-99, 0-12, 0-11, 0-10, 0-10, 0-9, 0-9, 0-99
            [/avoid]
        )}
    [/event]

    #############################
    # CLAN WHITEFANG
    #############################
    # reduced scaling, since these guys mostly fight Garard
    [side]
        side,controller,color=3,ai,white
        type,id,name,facing=Orcish Warlord,Ghazgir,_"Ghazgir",se
        {MODIFICATIONS( {TRAIT_INTELLIGENT} {TRAIT_STRONG} )}
        gold,income={ON_DIFFICULTY4 50 50 50 50},{ON_DIFFICULTY4 7 11 15 15} # + 2 base + 2 core villages
        recruit=Orcish Grunt,Orcish Archer,Orcish Crossbowman,Orcish Assassin
        team_name,user_team_name=orcs,_"Whitefang Orcs"
        {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Orcish Crossbowman) {ON_DIFFICULTY4 0 1 1 2}}
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}
    {STARTING_VILLAGES 3 5}

    [side]
        side,controller,color=4,ai,white
        type,id,name,facing=Direwolf Rider,Mukhu,_"Muhku",sw
        {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_RESILIENT} )}
        gold,income={ON_DIFFICULTY4 50 50 50 50},{ON_DIFFICULTY4 7 11 15 15} # + 2 base + 1 core villages
        recruit=Wolf Rider,Goblin Knight,Goblin Pillager
        team_name,user_team_name=orcs,_"Whitefang Orcs"
        {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Goblin Knight)   {ON_DIFFICULTY4 0 1 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Goblin Pillager) {ON_DIFFICULTY4 0 0 1 1}}
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    {STARTING_VILLAGES 4 5}

    #############################
    # CLAN BLACKCREST
    #############################
    [side]
        side,controller,color=5,ai,black
        type,id,name,facing,profile=Orcish Leader,Irbirch,_"Irbirch",se,portraits/orcs/ruler.webp
        {MODIFICATIONS( {TRAIT_QUICK} {TRAIT_STRONG} )}
        gold,income=0,{ON_DIFFICULTY4 -1 0 0 1} # + 2 base + 1 core villages
        recruit=Orcish Grunt,Orcish Adept
        team_name,user_team_name=orcs,_"Blackcrest Orcs"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 5 1}
    {STARTING_VILLAGES 5 5}

    [side]
        side,controller,color=6,ai,black
        type,id,name,facing=Saurian Flanker,Ssisaix,_"Ssisaix",se
        {MODIFICATIONS( {TRAIT_RESILIENT} {TRAIT_STRONG} )}
        gold,income={ON_DIFFICULTY4 30 40 50 50},{ON_DIFFICULTY4 8 14 22 22} # + 2 base + 0 core villages. Increased gold/income at low difficulties, due to no villages and high upkeep
        recruit={ON_DIFFICULTY4 "Saurian Spike" "Saurian Skirmisher" "Saurian Skirmisher" "Saurian Skirmisher"}
        team_name,user_team_name=orcs,_"Blackcrest Saurians"
        {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 (Saurian Ambusher) {ON_DIFFICULTY4 0 1 2 2}}
    {SILENTLY_LIMIT_LEADER_MOVES 6 1}

    [side]
        side,controller,color=7,ai,black
        type,id,name,facing=Saurian Javelineer,Xairr,_"Xairr",nw
        {MODIFICATIONS( {TRAIT_RESILIENT} {TRAIT_INTELLIGENT} )}
        gold,income={ON_DIFFICULTY4 30 40 50 50},{ON_DIFFICULTY4 8 14 22 22} # + 2 base + 0 core villages. Increased income at low difficulties, due to no villages and high upkeep
        recruit={ON_DIFFICULTY4 "Saurian Devotee" "Saurian Augur" "Saurian Augur" "Saurian Augur"}
        team_name,user_team_name=orcs,_"Blackcrest Saurians"
        {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 (Saurian Spearthrower) {ON_DIFFICULTY4 0 1 2 2}}
    {SILENTLY_LIMIT_LEADER_MOVES 7 1}

    # Asheviere
    [side]
        side,controller=8,null
        no_leader,hidden=yes,yes
        team_name=wesnoth,orcs
    [/side]

    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI  3,4,6,7 offensive 0.8 0.2}
        {MODIFY_SIDE_AI 3,4,6,7 ({GOAL_LOCATION 99 x,y=17,12})}
        {VARY_AI_BY_SCHEDULE_ENEMY 3,4,5,6,7 1,2}
        {MODIFY_SIDE_AI 6 (
            [avoid]
                x,y=0-26,16-99
                {OR x,y=27-99,0-10}
            [/avoid]
        )}
        {MODIFY_SIDE_AI 7 (
            [avoid]
                x,y=26-99,0-14
            [/avoid]
        )}

        # if we start on a bad ToD, disable attacking completely until a more favorable time
        [store_time_of_day]
        [/store_time_of_day]
        {IF}{LUA(<< return wesnoth.current.turn<=3 >>)}
        [and]
            {VARIABLE_CONDITIONAL time_of_day.id equals dawn}
            {OR( {VARIABLE_CONDITIONAL time_of_day.id equals midday} )}
        [/and]
        [then]
            {DISABLE_ATTACKING 3,4,5,6,7}
            {MODIFY_SIDE_AI 3,4,5 (
                [avoid]
                    {FILTER side=1,2} radius=4
                [/avoid]
            )}
            {MODIFY_SIDE_AI 6 (
                [avoid]
                    {FILTER side=1,2} radius=5
                    {OR x,y=0-26,16-99}
                    {OR x,y=27-99,0-10}
                [/avoid]
            )}
            {MODIFY_SIDE_AI 7 (
                [avoid]
                    {FILTER side=1,2} radius=5
                    {OR x,y=26-99,0-14}
                [/avoid]
            )}
        [/then]
        {/IF}

        {RESET_SIDE_AI  5 defensive 0.4 0.25}
        {MODIFY_SIDE_AI 5 ({GOAL_LOCATION 1 x,y=33,8})}
        {MODIFY_SIDE_AI 5 (
            [avoid]
                x=0-30, 0-32,  0-99
                y=0-99, 7-99, 10-99
            [/avoid]
        )}
    [/event]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # STARTING TIME
        #############################
        # to make the transition from S05 more seamless, start at the same time
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals dawn        } {THEN( {VARIABLE current_time 0} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals morning     } {THEN( {VARIABLE current_time 1} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals midday      } {THEN( {VARIABLE current_time 1} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals afternoon   } {THEN( {VARIABLE current_time 1} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals dusk        } {THEN( {VARIABLE current_time 2} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals first_watch } {THEN( {VARIABLE current_time 3} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals midnight    } {THEN( {VARIABLE current_time 4} )}{/IF}
        {IF} {VARIABLE_CONDITIONAL s05_tod.id equals second_watch} {THEN( {VARIABLE current_time 5} )}{/IF}
        [replace_schedule]
            {WINTER_SCHEDULE}
            current_time=$current_time
        [/replace_schedule]
        {CLEAR_VARIABLE s05_tod,current_time}

        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE items/straw-bale1.png 29 12}
        {PLACE_IMAGE "scenery/whitefang-flag.png"      25 10}
        {PLACE_IMAGE "scenery/whitefang-flag.png~FL()" 23 16}
        {PLACE_IMAGE "scenery/whitefang-flag.png~FL()" 17 15}
        {PLACE_IMAGE "scenery/whitefang-flag.png"       3  8}

        #############################
        # INITIAL HUMANS
        #############################
        {RECALL_XY Delfador 24 14}
        {RECALL_XY Deoran   23 15}
        {RECALL_INFANTRYMAN 0 22 12 Spearman ( {ADD_MODIFICATION {TRAIT_QUICK}}       {ADD_MODIFICATION {TRAIT_STRONG}} )}
        {RECALL_INFANTRYMAN 0 21 13 Spearman ( {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ADD_MODIFICATION {TRAIT_STRONG}} )}
        [harm_unit]
            {FILTER x,y=22,12} amount=11
        [/harm_unit]

        {GENERIC_UNIT 2 (Heavy Infantryman) 19 16} {FACING sw} {EXPERIENCE 3} {HITPOINTS 11}
        {GENERIC_UNIT 2 (Fencer)            17 16} {FACING se} {EXPERIENCE 11}
        {GENERIC_UNIT 3 (Orcish Grunt)      18 16} {FACING ne} {EXPERIENCE 8} {HITPOINTS 9}
        {GENERIC_UNIT 2 (Heavy Infantryman) 26 10} {FACING ne} {EXPERIENCE 5} {HITPOINTS 1}
        {MODIFY_UNIT x,y=26,10 status.poisoned yes}

        {GENERIC_UNIT 2 (Knight)     16 11} {FACING nw} {EXPERIENCE 11} {HITPOINTS 47}
        {GENERIC_UNIT 2 (Horseman)   17 14} {FACING nw} {EXPERIENCE  3}
        {GENERIC_UNIT 2 (Cavalryman) 28 11} {FACING sw} {EXPERIENCE  9} {HITPOINTS 11}
        [unit]
            {SINGLEUNITWML_METHOR}
            side,x,y,facing=2,16,12,nw
        [/unit]
        {RESTORE_METHOR}
        {RESTORE_GARARD}

        #############################
        # INITIAL ENEMIES
        #############################
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 (Saurian Devotee) (Saurian Augur)      (Saurian Oracle)   (Saurian Oracle)  } 32 21 ({FACING nw} {ZONE_GUARDIAN 32 21 x,y,radius=32,21,4})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 (Saurian Spike)   (Saurian Skirmisher) (Saurian Ambusher) (Saurian Ambusher)} 34 18 ({FACING nw} {ZONE_GUARDIAN 34 18 x,y,radius=34,18,4})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 (Saurian Devotee) (Saurian Augur)      (Saurian Oracle)   (Saurian Oracle)  } 32 18 ({FACING nw} {ZONE_GUARDIAN 32 18 x,y,radius=34,18,4})}

        {GENERIC_UNIT  3 (Orcish Slayer) 1 2} {GUARDIAN} {FACING se}
        {GENERIC_UNIT  3 (Orcish Slayer) 3 1} {GUARDIAN} {FACING se}

        {GENERIC_UNITC 7 {ON_DIFFICULTY4 (Saurian Spike)   (Saurian Skirmisher) (Saurian Spearthrower) (Saurian Spearthrower)} 29 22 ()}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 (Saurian Devotee) (Saurian Augur)      (Saurian Augur)        (Saurian Augur)       } 30 21 ()}

        #############################
        # PREPARE CUTSCENE
        #############################
        {PUT_TO_RECALL_LIST id=Irbirch}
        {PUT_TO_RECALL_LIST id=Ssisaix}
        {SCROLL_TO 20 13}
    [/event]

    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        {DELAY 1000}

        {RECALL_XY Irbirch 4 2}
        {RECALL_XY Ssisaix 5 2}
        {NAMED_UNIT 3 (Orcish Sovereign) 4 3 Ushka'e _"Chief Ushka'e" ()} {GUARDIAN} {FACING se} {ANIMATE}
        {GIVE_OBJECT_TO id=Ushka'e ({EFFECT overlay add=misc/leader-crown.png})}

        [message]
            speaker=Ushka'e
            #po: this is the whitefang chief. He's happy that Garard has walked into his trap
            message=_"You see? What did I tell you! Their king is nothing but a feeble-minded goblin runt, who does exactly what I want. The trap is sprung! Now we crush them."
        [/message]

        {RECALL_XY Ghazgir 5 10}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)          (Orcish Grunt)  (Orcish Grunt)    (Orcish Grunt)      }  6 10 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (Orcish Archer) (Orcish Archer) (Orcish Archer)   (Orcish Crossbowman)}  5 11 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)          (none)          (Orcish Grunt)    (Orcish Grunt)      }  4 10 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)          (none)          (Orcish Assassin) (Orcish Assassin)   }  4  9 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)          (none)          (none)            (Orcish Archer)     }  3  9 ({ANIMATE})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (Orcish Grunt)  (Orcish Grunt)  (Orcish Grunt)    (Orcish Warrior)    }  3 11 ({ANIMATE} {FACING se} {ZONE_GUARDIAN  3 11 x,y,radius=4,10,4 })}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 (Orcish Grunt)  (Orcish Grunt)  (Orcish Grunt)    (Orcish Warrior)    } 27  4 ({ANIMATE} {FACING se} {ZONE_GUARDIAN 27  4 x,y,radius=25,3,3 })}

        {RECALL_XY Muhku 23 1}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 (none)       (none)            (Wolf Rider)      (Wolf Rider)     } 21 1 ({ANIMATE})}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 (none)       (Wolf Rider)      (Goblin Pillager) (Goblin Pillager)} 22 1 ({ANIMATE})}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 (Wolf Rider) (Wolf Rider)      (Wolf Rider)      (Goblin Knight)  } 23 2 ({ANIMATE})}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 (none)       (none)            (none)            (Wolf Rider)     } 24 1 ({ANIMATE})}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 (Wolf Rider) (Goblin Knight)   (Goblin Knight)   (Goblin Knight)  } 19 1 ({ANIMATE} {FACING se} {ZONE_GUARDIAN 19  1 x,y,radius=21,1,4 })}

        [message]
            speaker=Irbirch
            #po: Irbirch is a representative of clan blackcrest, now (tenuously) allied with whitefang. The "spy" references Asheviere (probably; might be an agent of Iliah-Malal instead), who came up with the plan and told it to the orcs
            message=_"Bwahaha, when did you Whitefangs become so weak as to follow the ploy of a spy? Blackcrest warriors would never have let humans advance so far into our lands!"
        [/message]
        [message]
            speaker=Ushka'e
            #po: referencing clan blackcrest's saurian allies.
            message=_"Your “warriors” only survive by cowering behind your slimy lizard allies! But since Clan Blackcrest has begged so-like trembling goblins, Clan Whitefang will agree to work together."
        [/message]
        [message]
            speaker=Irbirch
            #po: neither side has actually offered to work together. Subversive messengers poised as members of each clan and manipulated them into working together against Garard
            message=_"Since WE begged!? YOU invited US here; your messenger was quaking in his boots when he groveled before Chief Ghuvog asking for help!"
        [/message]
        [message]
            speaker=Ushka'e
            message=_"What are you talking abo— Oh forget it, just make sure your clan does its job! No human leaves this valley alive!"
        [/message]
        {MOVE_UNIT id=Ssisaix 1 1}  {PUT_TO_RECALL_LIST id=Ssisaix}
        {MOVE_UNIT id=Irbirch 1 1}  {PUT_TO_RECALL_LIST id=Irbirch}

        {SCROLL_TO 35 1}
        {RECALL_XY Irbirch 35 2}
        {MOVE_UNIT id=Irbirch 35 6}
        {GENERIC_UNITC 5     {ON_DIFFICULTY4 (none)         (none)         (Orcish Adept) (Orcish Adept)} 34 5 ({ANIMATE} {ZONE_GUARDIAN 35 5 x,y,radius=35,5,4 })}
        [event]
            name=side 5 turn 2 end
            {GENERIC_UNITC 5 {ON_DIFFICULTY4 (none)         (none)         (none)         (Orcish Adept)} 34 5 ({ANIMATE} {ZONE_GUARDIAN 34 6 x,y,radius=35,5,4 })}
        [/event]
        {DELAY 500}

        {SCROLL_TO 1 1}
        {MOVE_UNIT id=Ushka'e 2 1} {MODIFY_UNIT id=Ushka'e facing se}
        {GENERIC_UNIT       3 (Orcish Grunt)  2 3               } {GUARDIAN} {ANIMATE} {FACING se}
        {GENERIC_UNIT       3 (Orcish Grunt)  5 3               } {GUARDIAN} {ANIMATE} {FACING se}
        {NAMED_NOTRAIT_UNIT 3 (Orcish Leader) 6 1 Bazur _"Bazur"} {GUARDIAN} {ANIMATE} {FACING se} # reference to Asheviere's Dogs
        {ADD_MODIFICATION( {TRAIT_LOYAL} {TRAIT_QUICK} )}
        {MODIFY_UNIT id=Bazur profile portraits/orcs/grunt-3.webp}
        [event]
            name=last breath
            {FILTER id=Bazur}
            [message]
                speaker=Bazur
                message=_"Lousy chief! Lousy plan! Next time I’m doing this on my own terms!"
            [/message]
            {MOVE_UNIT id=Bazur 3 1}
            {KILL id=Bazur}
        [/event]
        {DELAY 500}

        {SCROLL_TO 35 22}
        {RECALL_XY Ssisaix 34 22}
        {MOVE_UNIT id=Ssisaix 35 17}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 (Saurian Skirmisher) (Saurian Skirmisher) (Saurian Skirmisher) (Saurian Ambusher)  } 34 16 {ANIMATE}}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 (none)               (Saurian Augur)      (Saurian Augur)      (Saurian Augur)     } 35 16 {ANIMATE}}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 (none)               (none)               (Saurian Skirmisher) (Saurian Skirmisher)} 35 18 {ANIMATE}}
        {DELAY 500}

        [message]
            speaker=Garard
            #po: Garard has just realized he's surrounded
            message=_"What devilry is this? How did they sneak in behind us. I’m separated from my generals and most of my soldiers..."
        [/message]
        [message]
            speaker=Garard
            message=_"Foul orcs, come at me then! If this is where I am to fall, I shall make such a stand as to stir the gods themselves to tears!"
        [/message]
        {GENERIC_UNITC 5 (Orcish Grunt) 30 8 ({ANIMATE} {ZONE_GUARDIAN 34 6 x,y,radius=35,5,4 })}
        [unit]
            {SINGLEUNITWML_ASHEVIERE}
            side,x,y,facing,animate=8,31,9,sw,yes
        [/unit]
        [message]
            speaker=Irbirch
            #po: Asheviere is next to Irbirch. The player is led to think she's been captured, but it's possible she actually went of her own free will to escape Garard
            message=_"Nice speech! I wonder what your wife thinks of it? Don’t worry, we’ll have plenty of fun with her, <b><i>and</i></b> your unborn heir. Haw, haw, haw!"
        [/message]
        {MOVE_UNIT id=Asheviere 35 7} {MODIFY_UNIT id=Asheviere facing sw}
        {MOVE_UNIT x,y=30,8     34 6} {MODIFY_UNIT x,y=34,6     facing sw}
#define TOGGLE_GOHERE
    {DELAY 250}
    [hide_unit]
        id=Asheviere
    [/hide_unit]
    {PLACE_IMAGE items/gohere.png 35 7}
    {DELAY 250}
    {REMOVE_IMAGE 35 7}
    [unhide_unit]
        id=Asheviere
    [/unhide_unit]
#enddef
        {TOGGLE_GOHERE}
        {TOGGLE_GOHERE}
        {TOGGLE_GOHERE}
        {TOGGLE_GOHERE}

        # was Asheviere actually captured here, or did she go to the orcs willingly? I leave it ambiguous
        [message]
            speaker=Methor
            message=_"(aghast) That’s— They’ve captured the queen! Asheviere’s no warrior, and fragile with pregnancy. We have to rescue her!"
        [/message]
        [message]
            speaker=Deoran
            message=_"Surrounded and absent the queen; this is a disaster! Quick, we must rally what’s left of the crown’s infantry. Send a detachment to rescue Queen Asheviere, and have the rest protect King Garard until Lionel and Arand can break through to us!"
        [/message]
        {MODIFY_UNIT (type=Fencer,Heavy Infantryman) side 1}
        [capture_village]
            side=1 {FILTER side=1}
        [/capture_village]
        [message]
            speaker=Delfador
            message=_"(nervous) I’ll never make a name for myself if I get killed! This— this is really serious. I swear, I won’t let you down."
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Defeat Irbirch, recapturing Queen Asheviere"
                condition=win
            [/objective]
            [objective]
                description= _ "Fail to rescue Asheviere before turns run out"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Delfador or Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Garard, Asheviere, or Methor"
                condition=lose
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                description=_"Amidst the craggy mountains, daylight is scarce. <i>(shorter days / longer nights)</i>"
            [/note]
            {IS_LAST_SCENARIO}
        [/objectives]

        {VARIABLE unlock_enervate yes}
        {VARIABLE unlock_counterspell yes}
        {VARIABLE unlock_panacea yes}
        {RESELECT_SKILLS_AFTER_OBJECTIVES (
            [object]
                {FILTER id=Delfador} duration=turn
                image="misc/blank-hex.png~SCALE(72,144)~BLIT(units/human-loyalists/heavyinfantry.png~RC(magenta>red),0,0)~BLIT(units/human-loyalists/fencer.png~RC(magenta>red),0,72)"
                name=_"New Recruits:"
                description=_"Heavy Infantrymen are tough-but-slow powerhouses that resist physical damage.

Fencers are fragile but evasive, and possess the “<i>skirmisher</i>” ability for slipping unhindered around enemy units."
            [/object]
        ) ()}

        [set_extra_recruit]
            id=Delfador
            extra_recruit={DELFADOR_MIDDLE_RECRUIT}
        [/set_extra_recruit]
    [/event]

    #############################
    # REDUCE AI-VS-AI RNG
    #############################
    # because garard has so few units, all with charge, and all benefitting from +100% leadership,
    # a couple lucky/unlucky charges can drastically swing his portion of the battle.
    # to amoreliate this, force his attacks to alternate hit-and-miss
#define FORCE_SIDE_ACCURACY SIDE VALUE
    {REMOVE_OBJECT force_cth_side{SIDE} ()}
    [modify_unit]
        {FILTER side={SIDE}}
        [object]
            id=force_cth_side{SIDE}
            {EFFECT attack (
                [set_specials]
                    mode=append
                    [chance_to_hit]
                        value={VALUE}
                    [/chance_to_hit]
                [/set_specials]
            )}
        [/object]
    [/modify_unit]
#enddef
    [event]
        name=attacker hits {FILTER side=2}
        first_time_only=no {FORCE_SIDE_ACCURACY 2 0}
    [/event]
    [event]
        name=defender hits {FILTER_SECOND side=2}
        first_time_only=no {FORCE_SIDE_ACCURACY 2 0}
    [/event]
    [event]
        name=attacker misses {FILTER side=2}
        first_time_only=no   {FORCE_SIDE_ACCURACY 2 100}
    [/event]
    [event]
        name=defender misses {FILTER_SECOND side=2}
        first_time_only=no   {FORCE_SIDE_ACCURACY 2 100}
    [/event]

    #############################
    # GOLD BOOSTS
    #############################
    [event]
        name=side 2 turn 6
        {IF} {HAVE_UNIT id=Ssisaix} {THEN(
            [message]
                speaker=Ssisaix
                #po: the player (and Garard) is still alive. The orcs and saurians expected them to die by now
                message=_"They ssstill sssurvive! Thisss was not the plan!"
            [/message]
            [message]
                speaker=Ushka'e
                message=_"Then send in more warriors and finish them off, you worthless Blackcrest lizards! This is <b>our</b> homeland; our ranks swell by the hour, while these humans dwindle every moment."
            [/message]
        )} {ELSE(
            [message]
                speaker=Ushka'e
                message=_"Useless lizards! Can’t even keep themselves alive, much less win a war. Send in more orcs! This is <b>our</b> homeland; our ranks swell by the hour, while these humans dwindle every moment."
            [/message]
        )} {/IF}
        [gold]
            side=3,4,6
            amount={ON_DIFFICULTY4 5 10 20 20}
        [/gold]
        [gold]
            side=7 # the player is probably pushing towards asheviere, so boost the further-away saurian leader more
            amount={ON_DIFFICULTY4 10 20 40 40}
        [/gold]
    [/event]
    [event]
        name=side 2 turn 7
        [gold]
            side=3,4,6,7
            amount={ON_DIFFICULTY4 5 10 20 20}
        [/gold]
    [/event]
    [event]
        name=side 2 turn 8
        [gold]
            side=3,4,6,7
            amount={ON_DIFFICULTY4 10 20 40 40}
        [/gold]
    [/event]
    [event] # these won't arrive in time to affect the battle, but add to the feeling of being overwhelmed
        name=side 2 turn 9
        [gold]
            side=3,4,6,7
            amount=60
        [/gold]
    [/event]
    [event]
        name=side 2 turn 10
        [gold]
            side=3,4,6,7
            amount=90
        [/gold]
    [/event]

    #############################
    # METHOR COMPLAINS
    #############################
    [event]
        name=turn 2
        [message]
            speaker=Deoran
            message=_"This alliance between races is a great ill fortune! I’ve oft known orcs to recruit trolls, but seldom saurians. And with these three factions fighting together, soon all the warlords will hear of their prowess."
        [/message]
        [message]
            speaker=Deoran
            message=_"It takes a great show of strength to unite the fractious orcs, but after this disaster countless more will surely flock to the Blackcrest and Whitefang banners. Orcs follow might above all else, even clan blood."
        [/message]
        [message]
            speaker=Methor
            message=_"Utter madness, all of this! The orcish clans are a hornet’s nest that should never have been kicked. Pillagers and raids we can deal with, but total war is something else entirely."
        [/message]
        [message]
            speaker=Garard
            message=_"Quiet, both of you! If I wanted your advice I would have asked for it!"
        [/message]
    [/event]

    #############################
    # USHKA'E FLEES
    #############################
    [event]
        name=attacker hits {FILTER_SECOND id=Ushka'e}
        [message]
            speaker=Ushka'e
            #po: the player has just attacked the whitefang chief. He then flees
            message=_"Worthless humans! You’ll never defeat me, or clan Whitefang!"
        [/message]
        {MOVE_UNIT id=Ushka'e 1 1}
        {KILL id=Ushka'e}
        [message]
            speaker=Garard
            message=_"Coward! Stand and fight!"
        [/message]
    [/event]

    #############################
    # EXPLAIN AI
    #############################
    # saurian AI won't chase you near Asheviere. Explain that to the player
    [event]
        name=side 1 turn end
        {FILTER_CONDITION({HAVE_UNIT( side,count=1,2-99 {FILTER_LOCATION x,y,radius=31,7,4 })})}
        {FILTER_CONDITION({HAVE_UNIT( id=Ssisaix )})}
        {FILTER_CONDITION({HAVE_UNIT( id=Irbirch )})}
        [message]
            speaker=Ssisaix
            message=_"They sssneak off to the northeassst, towardsss their queen! Ssshould I pursssue?"
        [/message]
        [message]
            speaker=Irbirch
            message=_"Finish off their king, lizard! I’ll handle things here."
        [/message]
    [/event]

    #############################
    # ATTACK IRBIRCH'S SIDE
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=35,6,3} )}
        [message]
            speaker=Irbirch
            message=_"Come to ransom back your queen? Too bad, she’s mine!"
        [/message]
        [message]
            speaker=Irbirch
            message=_"Maybe once she pops out her kid you can pay me double for both! Haw, haw, haw."
        [/message]
    [/event]

    #############################
    # RESCUE ASHEVERE
    #############################
    [event]
        name=last breath {FILTER id=Irbirch}
        [message]
            speaker=Irbirch
            #po: a representative of clan blackcrest has died
            message=_"Great Chief Ghuvog will avenge me! Clan Blackcrest will never rest.. until Wesnoth is... razed to... ash..."
        [/message]

        [event]
            name=die
            {MODIFY_UNIT id=Asheviere side 1}
            [modify_unit]
                {FILTER id=Asheviere}
                moves=$( $this_unit.max_moves )
            [/modify_unit]
            [message]
                speaker=Asheviere
                #po: Asheviere tries to say something, but gets interrupted
                message=_"Thank yo—"
            [/message]
            [message]
                speaker=Deoran
                #po: both Deoran and Garard talk over Asheviere. She doesn't get any agency of her own, even from Deoran (who generally stands up for her)
                message=_"Not now, milady! We have to get you out of here!"
            [/message]

            [event]
                name=side 1 turn end,asheviere_speaks_to_garard
                [message]
                    speaker=Asheviere
                    #po: asheviere tries to say something, but gets interrupted
                    message=_"Garard, I—"
                [/message]
                [message]
                    speaker=Garard
                    #po: both Deoran and Garard talk over Asheviere. She doesn't get any agency of her own, even from Deoran (who generally stands up for her)
                    message=_"Now now, woman! I have a battle to fight!"
                [/message]
            [/event]
        [/event]
    [/event]

    #############################
    # ENEMY LAST BREATHS
    #############################
    [event]
        name=last breath {FILTER id=Ghazgir}
        [message]
            speaker=Ghazgir
            message=_"I’m not dying! Just... need a moment..."
        [/message]
    [/event]
    [event]
        name=last breath {FILTER id=Mukhu}
        [message]
            speaker=Mukhu
            message=_"Nooo! Help meeee!"
        [/message]
    [/event]
    [event]
        name=last breath {FILTER id=Xairr}
        [message]
            speaker=Xairr
            message=_"Ssssuch ssssskill!"
        [/message]
    [/event]
    [event]
        name=last breath {FILTER id=Ssisaix}
        [message]
            speaker=Ssisaix
            message=_"Cursessss, I am sssslain!"
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
#define KILL_ADJACENT ID
    [store_unit]
        {FILTER( side=3,4,5,6,7 {FILTER_ADJACENT id={ID}} )}
        variable=units_to_kill
    [/store_unit]
    [foreach]
        array,variable=units_to_kill,unit
        [do]  {ANIMATE_ATTACK id={ID} () yes x,y=$unit.x,$unit.y}  {KILL id=$unit.id ANIMATE=yes}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE units_to_kill}
#enddef
#define LIONEL_REINFORCEMENT ID TYPE X Y WML
    {RANDOM "24,26"}
    {PUT_TO_RECALL_LIST x,y=$random,22} # so there's no interference
    {NAMED_UNIT 2 {TYPE} $random 22 {ID} "" ()} {ANIMATE} {WML}
    {MOVE_UNIT id={ID} {X} {Y}}
    {KILL_ADJACENT {ID}}
#enddef
    #############################
    # TIME OVER
    #############################
    [event]
        name=time over
        {FIRE_EVENT asheviere_speaks_to_garard}

        #--------------------
        # LIONEL ARRIVES
        #--------------------
        [unit]
            {SINGLEUNITWML_LIONEL}
            side,x,y,facing,animate=2,25,21,se,yes
            hitpoints=31
        [/unit]
        {KILL_ADJACENT Lionel}
        {PUT_TO_RECALL_LIST x,y=18,13}
        {PUT_TO_RECALL_LIST x,y=17,14}
        {PUT_TO_RECALL_LIST x,y=17,13}
        [message]
            speaker=Lionel
            #po: Lionel appears with reinforcments to help Garard
            message=_"Rally b’hind me, men! We swore our oaths, now we do our duty. Fight, fight through to the king!"
        [/message]
        {LIONEL_REINFORCEMENT unit1 (Swordsman)   26 21 {HITPOINTS 31}}
        {LIONEL_REINFORCEMENT unit2 (Spearman)    23 20 {HITPOINTS  7}}
        {LIONEL_REINFORCEMENT unit3 (Pikeman)     23 18 (            )}
        {LIONEL_REINFORCEMENT unit4 (Swordsman)   21 17 {HITPOINTS 19}}
        {LIONEL_REINFORCEMENT unit5 (Royal Guard) 20 14 (            )}
        {MOVE_UNIT id=Lionel 18 13}
        {KILL_ADJACENT Lionel}
        {MODIFY_UNIT id=Garard facing se}
        {MODIFY_UNIT id=Methor facing se}

        #--------------------
        # DEFEAT: NO ASHEVIERE
        #--------------------
        {IF} {NOT({HAVE_UNIT side,id=1,Asheviere})} {THEN(
            [message]
                speaker=Deoran
                #po: the player has survived, but failed ot rescue the queen
                message=_"But the queen! If we leave her in the hands of the orcs she’ll surely be tortured and killed!"
            [/message]
            [message]
                speaker=Lionel
                message=_"I’m sorry, there’s no time! We have to get the king out of here!"
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
            [return]
            [/return]
        )} {/IF}

        #--------------------
        # NIGHTBLADE APPEARES
        #--------------------
        {GENERIC_UNIT 3 "Orcish Nightblade" 14 15} {FACING se} {ROLE killer} {ANIMATE}
        {DELAY 500}
        {KILL role=killer}
        {FAKE_UNIT_MOVE 14 15 15 16 3 "Orcish Nightblade" ()}
        {FAKE_UNIT_MOVE 15 17 16 15 3 "Orcish Nightblade" ()}
        {FAKE_UNIT_MOVE 17 17 15 14 3 "Orcish Nightblade" ()}
        {GENERIC_UNIT 3 "Orcish Nightblade" 17 14} {FACING se} {ROLE killer}
        [message]
            speaker=Lionel
            message=_"Sir, look out!"
        [/message]
        {MOVE_UNIT id=Lionel 17 13}
        [harm_unit]
            {FILTER id=Lionel} {FILTER_SECOND role=killer}
            amount,animate,poisoned=19,yes,yes
            [primary_attack]
                range=melee
            [/primary_attack]
            [secondary_attack]
                range=melee
            [/secondary_attack]
        [/harm_unit]
        [message]
            speaker=Lionel
            message=_"<b><i>NNnrgh!</i></b>"
        [/message]
        [harm_unit]
            {FILTER role=killer} {FILTER_SECOND id=Lionel}
            amount,animate=99,yes
            [primary_attack]
                range=melee
            [/primary_attack]
            [secondary_attack]
                range=melee
            [/secondary_attack]
        [/harm_unit]

        #--------------------
        # DISCUSSION
        #--------------------
        [message]
            speaker=Lionel
            #po: Lionel has appeared with reinforcments to help Garard
            message=_"You ain’t dyin’ while I draw breath, sir. By the sceptre, I got here just in time!"
        [/message]
        [message]
            speaker=Lionel
            message=_"They caught us completely by surprise! My forces are holding a corridor but I don’t know for how long — we’ve got to get you back to Fort Garard."
        [/message]
        [message]
            speaker=Garard
            message=_"Lionel, my best general, you’ve saved the day once again! I’d almost feared this was the end, and it might have been if not for you and young Delfador."
        [/message]
        [heal_unit]
            {FILTER id=Lionel} {FILTER_SECOND id=Methor}
            amount,animate=8,yes
        [/heal_unit]
        {DELAY 250}
        [heal_unit]
            {FILTER id=Lionel} {FILTER_SECOND id=Methor}
            amount,animate=8,yes
        [/heal_unit]
        [message]
            speaker=Garard
            message=_"But how did this disaster happen? We were on the eve of victory! Did someone betray our plans to the enemy? Or am I really just that predictable!?"
        [/message]
        [message]
            speaker=Lionel
            message=_"Couldn’t tell you, m’lord. But I do know that when I became a general I swore an oath to keep you in one piece, and I don’ intend to break it here."
        [/message]
        [message]
            speaker=Lionel
            message=_"Now c’mon, sir, we’re gettin’ you home."
        [/message]

        #--------------------
        # VICTORY
        #--------------------
        {STORE_UNIT_VAR id=Garard hitpoints achievement_hp}
        {STORE_UNIT_VAR id=Garard max_hitpoints achievement_max_hp}
        {IF} {VARIABLE_CONDITIONAL achievement_hp equals $achievement_max_hp} {THEN({ACHIEVE s06})}
        {/IF}
        {CLEAR_VARIABLE achievement_hp,achievement_max_hp}

        # clear your recall list (and treat Deoran separately)
        {FIRE_EVENT kill_panacea}
        {KILL id=Asheviere}
        {FULL_HEAL ()}
        [store_unit]
            {FILTER id=Deoran}
            variable,kill=stored_deoran,yes
        [/store_unit]
        [store_unit]
            {FILTER( side=1 {NOT id=Delfador,familiar} )}
            variable,kill=stored_units_s06,yes
        [/store_unit]

        [store_unit]
            {FILTER id=Methor}
            variable,kill=stored_methor,yes
        [/store_unit]
        [store_unit]
            {FILTER id=Garard}
            variable,kill=stored_garard,yes
        [/store_unit]

        {LOCAL_VARAIBLE_TO_GLOBAL stored_deoran    stored_deoran}
        {LOCAL_VARAIBLE_TO_GLOBAL stored_units_s06 stored_units_s06}
        {LOCAL_VARAIBLE_TO_GLOBAL stored_methor    stored_methor}
        {LOCAL_VARAIBLE_TO_GLOBAL stored_garard    stored_garard}

        {IF}{HAVE_UNIT id,search_recall_list=familiar,yes}{THEN(
            [store_unit] # only do this if the familiar actually exists, otherwise we overwrite the variable
                {FILTER id=familiar}
                variable,kill=stored_familiar,yes
            [/store_unit]
        )}{/IF}
        {LOCAL_VARAIBLE_TO_GLOBAL stored_familiar stored_familiar}

        # victory (no carryover)
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 0}
            linger_mode,carryover_report=no,no
        [/endlevel]
    [/event]

    {HERODEATHS}
[/scenario]
