#textdomain wesnoth-tdg

#undef TURNS
#define TURNS
25#enddef

[scenario]
    id,map_file,name=01_Stirrings_of_War,01_Stirrings_of_War.map,_"Stirrings of War"
    next_scenario,victory_when_enemies_defeated=02_Fort_Garard,no
    {DEFAULT_SCHEDULE_AFTERNOON} turns={TURNS}
    {SCENARIO_MUSIC knolls.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    {ADD_WEATHER_RAIN}

    [story]
        [part]
            # newlines at the beginning help to (depending on the screen size) center this vertically. The space at the end stops the last letter from getting cut off
            title="<span font_family='WesScript' size='90000'>


<i>" + _"The Deceiver’s Gambit" + " </i></span>"
            title_alignment=center
        [/part]

        [part]
            story=_"In the year 481 after the founding of Wesnoth, King Garard the Second grew discontent."
        [/part]
        [part]
            story=_"With the Estmarks secured and the southern bandits pacified, his empire had grown large and powerful. Garard’s marriage to the young Asheviere had secured him a queen, as well as the promise of an heir. Yet despite these achievements, the restless king could find no peace."
            background=story/bride-wp.png
        [/part]
        [part]
            story=_"The king’s love lay in sword and shield, in battle and blood. Dissatisfied with a life of languor among the estates of Weldyn, Garard looked instead to the orcs of the Heart Mountains, whose raids had long been a nuisance across his northern border."
            background=story/knight-wp.png
        [/part]
        [part]
            story=_"Eager to retaliate, the king sent messengers far and wide. He called to arms an expeditionary force to cross the Great River and lay claim to orcish lands; a great show of power to secure Wesnoth’s might."
            background=story/soldiers-wp.png
        [/part]
        [part]
            story=_"One of these messengers rode to the venerable Academy of Magic on Alduin, summoning a contingent of magi to support Garard’s endeavor. A particular young apprentice was especially enthusiastic..."
            background=story/alduin-wp.png
        [/part]
    [/story]
    {DE_TRACK {JOURNEY_01_NEW}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,50
        team_name,user_team_name=wesnoth,_"Isle of Alduin"
        {FLAG_VARIANT loyalist}
    [/side]

    #############################
    # ORCS
    #############################
    [side]
        side,controller,color=2,ai,white
        type={ON_DIFFICULTY4 "Orcish Grunt" "Orcish Warrior" "Orcish Warrior" "Orcish Warrior"}
        id,name,profile,facing=Ozgob,_"Ozgob",portraits/orcs/grunt-4.webp,se
        {MODIFICATIONS( {TRAIT_RESILIENT} {TRAIT_STRONG} )}
        gold=0
        income={ON_DIFFICULTY4 -2 2 6 10} # ~4 villages, <4 upkeep
        recruit=Goblin Spearman
        team_name,user_team_name=orcs,_"Clan Whitefang"
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 4}
    {STARTING_VILLAGES 2 9}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Goblin Impaler" {ON_DIFFICULTY4 0 1 2 3}}

    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 offensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE 2}
        # 2 guards on all difficulties
        {RETREAT_WHEN_WEAK 2 {ON_DIFFICULTY4 0-4 0-5 0-6 0-7} (
            {GOAL_LOCATION 3 x,y=20,15}
            {GOAL_LOCATION 3 x,y=26,12}
            {GOAL_LOCATION 1 x,y,radius=23,15,1}
        )}
    [/event]

    #############################
    # HORSES
    #############################
    [side]
        side,controller,color=3,null,brown
        team_name=wesnoth,orcs # allied with Wesnoth so you can't farm them for raven XP, and allied with orcs so they don't hover around there trying to kill them
        no_leader,hidden=yes,yes
    [/side]

    #############################
    # WESNOTH ARMY
    #############################
    [side]
        side,controller,color=4,null,wesred
        no_leader,hidden=yes,yes
        team_name,user_team_name=wesnoth,_"Weldyn"
    [/side]

    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE items/straw-bale1.png 21 4}
        {PLACE_IMAGE items/straw-bale1.png 12 1}
        {PLACE_IMAGE items/straw-bale2.png 12 2}
        {PLACE_IMAGE items/straw-bale1.png 13 2}

        {PLACE_IMAGE scenery/whitefang-flag.png 24 12}
        {PLACE_IMAGE scenery/whitefang-flag.png 21 17}

        {PLACE_IMAGE_SUBMERGED items/bones.png 3 13}
        {GOLD_PICKUP 2 12 items/gold-coins-small.png 15 _"15 gold" _"Treasure! Looks like a previous victim of the goblins."}

        #############################
        # ENEMIES
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Grunt" "Orcish Grunt" "Orcish Warrior"})  20 15  ({FACING nw}{ZONE_GUARDIAN 20 15 x,y,radius=23,17,4})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Goblin Spearman" "Orcish Grunt" "Orcish Grunt" "Orcish Warrior"})  26 12  ({FACING nw}{ZONE_GUARDIAN 26 12 x,y,radius=26,16,5})}

        {GENERIC_UNIT 3 (Great Horse) 15 1} {FACING se}
        {GENERIC_UNIT 3 (Bay Horse)   16 1} {FACING sw}

        #############################
        # DELFADOR AND METHOR
        #############################
        {RECALL_XY Delfador 9 5}
        {MODIFY_UNIT id=Delfador facing ne}
        {GIVE_OBJECT_TO id=Delfador ({EFFECT overlay remove=misc/leader-crown.png})}
        {GIVE_OBJECT_TO id=Delfador ({EFFECT overlay add=misc/leader-expendable.png})}

        {RECALL_XY Methor 10 4}
        {MODIFY_UNIT id=Methor facing ne}
        {MODIFY_UNIT id=Methor canrecruit yes}
        {GIVE_OBJECT_TO id=Methor (id=methor_remove_crown {EFFECT overlay remove=misc/hero-icon.png})}

        [allow_extra_recruit]
            id,extra_recruit=Methor,Mage # if the player's only played TSG/PaP before, this may the first time they get to recruit mages
        [/allow_extra_recruit]
    [/event]

    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        [message]
            speaker=Delfador
            message=_"Are we there yet?"
        [/message]
        [message]
            speaker=Methor
            #po: a "seeker spell" is a made-up word to describe some kind of spell that helps you find your way to a destination
            message=_"Nearer than the last time you asked, yet further than we will be the next. Really apprentice, would it kill you to learn a proper seeker spell?"
        [/message]
        [message]
            speaker=Delfador
            #po: Delfador has never met King Garard II, but rather idolizes him
            #po: "no need to be so glum" is echoed by Methor in S13x
            message=_"There’s no need to be so glum, master. As the head of our delegation, you’ll even get to counsel with the king himself! What I wouldn’t give for a chance to prove myself to him..."
        [/message]
        [message]
            speaker=Methor
            message="<i>" + _"Quiet!" + "</i>" + " <span size='small'>" + _"Do you hear that?" + "</span>"
        [/message]
        {FAKE_UNIT_MOVE 2 14 8 13 7 (Goblin Spearman)()}
        {DELAY 1000}

        {GENERIC_UNIT 2 (Goblin Spearman) 18 14} {ROLE gobbo1}
        {MOVE_UNIT role=gobbo1 22 13}
        [message]
            speaker=Ozgob
            #po: 'stragglers' refers to soldiers (like Delfador and Methor) who are joining Garard's war-camp, but are arriving late
            message=_"“Kill the stragglers”, they says. “You’ll have our best warriors”, they says. N’ all I get are a bunch o’ lousy goblins? Lousy lazy lying—"
        [/message]
        {MODIFY_UNIT id=Ozgob facing nw}
        [message]
            role=gobbo1
            message=_"They’re here, they’re here! Humans on the clan road!"
        [/message]
        [message]
            speaker=Ozgob
            message=_"—then grab your spear, you loathsome lout! Don’t let them link up with the rest of their army!"
        [/message]
        [message]
            role=gobbo1
            message=_"No, no, no! No fight! I run away!"
        [/message]
        {MOVE_UNIT role=gobbo1 30 11}
        {KILL role=gobbo1}

        [message]
            speaker=Ozgob
            message=_"Why you runtish, yellow—"
        [/message]
        {GENERIC_UNIT 2 (Goblin Spearman) 19 16} {ANIMATE} {ROLE gobbo2}
        {GENERIC_UNIT 2 (Goblin Spearman) 21 17} {ANIMATE} {ROLE gobbo3}
        [message]
            role,image=gobbo2,portraits/goblins/impaler.webp
            #po: multiple goblins are running away
            message=_"Wait for me!"
        [/message]
        [message]
            role=gobbo3
            message=_"Run away! Back to the swamp!"
        [/message]
        {MOVE_UNIT role=gobbo2 24 13}
        {ANIMATE_ATTACK id=Ozgob () yes x,y=24,13}
        {KILL role=gobbo2 ANIMATE=yes}
        [message]
            speaker=Ozgob
            #po: Ozgob has just killed one of the fleeing goblins
            message=_"I said FORM RANKS! Rousers, get these runts organized!"
        [/message]

        {NAMED_UNITC   2 {ON_DIFFICULTY4 (Goblin Spearman) (Goblin Rouser)   (Goblin Rouser)   (Goblin Rouser)  } 30 14 rouser2 _"Bork" ({ANIMATE}{ADD_MODIFICATION({TRAIT_SLOW})}) }
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman) (Goblin Spearman) (Goblin Spearman) (Goblin Spearman)} 30 15 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (Goblin Spearman) (Goblin Spearman) (Goblin Spearman)} 29 15 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (none)            (Goblin Spearman)} 30 13 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (none)            (Goblin Spearman)} 29 13 {ANIMATE}}

        {NAMED_UNITC   2 {ON_DIFFICULTY4 (Goblin Spearman) (Goblin Rouser)   (Goblin Rouser)   (Goblin Rouser)  }  7 16 rouser3 _"Mirnik" ({ANIMATE}{ADD_MODIFICATION({TRAIT_DIM})}) }
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman) (Goblin Spearman) (Goblin Spearman) (Goblin Spearman)}  8 15 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (Goblin Spearman) (Goblin Spearman) (Goblin Spearman)}  8 16 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (none)            (Goblin Spearman)}  6 15 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (none)            (Goblin Spearman)}  6 16 {ANIMATE}}

        {NAMED_UNITC   2 {ON_DIFFICULTY4 (none)            (none)            (Goblin Rouser)   (Goblin Rouser)  } 21 11  rouser4 _"Gump" ({ANIMATE}{ADD_MODIFICATION({TRAIT_DIM})}{FACING nw}) }
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (Goblin Spearman) (Goblin Spearman)} 20 11 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (Goblin Spearman) (Goblin Spearman)} 22 10 {ANIMATE}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)            (none)            (none)            (Goblin Spearman)} 24 10 {ANIMATE}}

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Ozgob"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Methor or the Apprentice"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]

        #############################
        # EXPLAIN SPELL SELECTION
        #############################
        {VARIABLE unlock_find_familiar yes}
        {VARIABLE unlock_animate_mud   yes}
        {RESELECT_SKILLS_AFTER_OBJECTIVES (
            [object]
                {FILTER id=Delfador} duration=turn
                image=icons/book.png
                name=_"Choosing Spells:"
                #po: Delfador does not yet have a true name; he's only called "apprentice"
                description=_"Before each scenario in this campaign, you will have the opportunity to select which spells to equip for the upcoming battle. Remember, double- or right-click on the apprentice to cast chosen spells!"
            [/object]
        ) ()}
    [/event]

    #############################
    # METHOR DIALOGUES
    #############################
    # explain Methor is leader
    [event]
        name=moveto
        {FILTER id,x,y=Methor,12,3}
        {FIRE_EVENT explain_mages}
        [allow_undo]
        [/allow_undo]
    [/event]
    [event]
        name=moveto
        {FILTER id,x,y=Delfador,12,3}
        {IF} {VARIABLE_CONDITIONAL skill_animate_mud equals yes} {THEN(
            [message]
                speaker=Methor
                #po: Methor says this when Delfador stands on their keep. Delfador can only recruit mudcrawlers; Methor recruits mages
                message=_"You’re not yet a journeyman, apprentice! Your mudcrawlers are not without use, but to recruit mages I’ll need to stand on our keep."
            [/message]
            {FIRE_EVENT explain_mages}
        )} {ELSE(
            [message]
                speaker=Methor
                #po: Methor says this when Delfador stands on their keep. Delfador can not recruit; Methor recruits mages
                message=_"You’re not yet a journeyman, apprentice! To recruit mages I’ll need to stand on our keep."
            [/message]
            {FIRE_EVENT explain_mages}
        )} {/IF}
        [allow_undo]
        [/allow_undo]
    [/event]
    [event]
        name=explain_mages
        [object]
            {FILTER id=Delfador} duration=turn
            image="misc/blank-hex.png~SCALE(108,72)~BLIT(units/human-magi/mage+female.png~RC(magenta>red),0,12)~BLIT(units/human-magi/mage.png~RC(magenta>red),36,12)"
            name=_"New Recruit:"
            description=_"The apprentice is the main character of this campaign, but right now he’s not your leader. Methor is your leader, and he can recruit Mages." + "

" + _ "Mages are deadly ranged attackers, with accurate <i>magical</i> attacks that are difficult to dodge. They have few hitpoints and are highly vulnerable in melee combat, so take good care of them!"
        [/object]
        [allow_undo]
        [/allow_undo]
    [/event]

    #############################
    # RAIN HINT
    #############################
    [event]
        name=turn end
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message=_"<i>Rain is purely visual, and has no impact on gameplay. If rain is distracting or reduces performance, you can disable it by opening the Preferences menu (Ctrl-P), selecting “Display”, and unchecking “Animate Map.”</i>"
        [/message]
    [/event]

    #############################
    # METHOR DIALOGUES
    #############################
    # mourn deaths (both human and goblin)
    # put this AFTER goblins flee dialogue
    [event]
        name=die
        {FILTER type=Mage}
        {FIRE_EVENT methor_mourns}
    [/event]
    [event]
        name=die
        {FILTER type="Goblin Rouser"}
        {FILTER_CONDITION({HAVE_UNIT count,type=1,"Goblin Rouser"})} # trigger this on the second-to-last goblin rouser
        {FIRE_EVENT methor_mourns}
    [/event]
    [event]
        name=methor_mourns
        [message]
            speaker=Methor
            #po: said after any living unit dies (both human and goblin)
            message=_"(sigh) More casualties of pointless politics. I joined the order to do some <i><b>good</b></i> in the world..."
        [/message]
    [/event]

    #############################
    # ENRAGE OZGOB
    #############################
    [event]
        name=attack
        {FILTER type_adv_tree="Orcish Grunt,Orcish Archer"}
        [message]
            speaker=Ozgob
            #po: Ozgob has lost most of his goblins ('runts'), and is about to charge at Delfador personally
            message=_"I’ve had it with this! Never send a runt to do a warrior’s job. The real orcs will bring you down ourselves!"
        [/message]
    [/event]

    #############################
    # HINT ABOUT GOLD
    #############################
    [event]
        name=side 1 turn refresh
        first_time_only=no
        [filter_condition]
            {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
            {VARIABLE_CONDITIONAL turn_number greater_than 5}
            {VARIABLE_CONDITIONAL explained_high_gold not_equals yes}
        [/filter_condition]

        [store_unit]
            [filter]
                side=1
                formula="( $this_unit.hitpoints>$this_unit.max_hitpoints/2 )"
            [/filter]
            variable=player_healthy_army
        [/store_unit]
        [store_unit]
            {FILTER side=2}
            variable=enemy_army
        [/store_unit]

        [store_gold]
            side=1
        [/store_gold]
        [if]
            {VARIABLE_CONDITIONAL gold greater_than 70}
            {VARIABLE_CONDITIONAL enemy_army.length greater_than "$( 3 * $player_healthy_army.length )"}
            [then]
                [message]
                    speaker=Methor
                    message= _ "We’ve accumulated a great deal of gold, apprentice. While my magic is powerful on the front lines, if we’re ever struggling it’s also important that I have the chance to recruit new magi from our keep."
                [/message]
                {VARIABLE explained_high_gold yes}
            [/then]
        [/if]
        {CLEAR_VARIABLE player_healthy_army,enemy_army,gold}
    [/event]

    #############################
    # TRACK ACHIEVEMENT
    #############################
    [event]
        name=die {FILTER type="Goblin Spearman","Goblin Impaler"}
        {VARIABLE failed_achievement yes}
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # ENEMY LEADER DIES
    #############################
    [event]
        name=last breath {FILTER id=Ozgob}

        [message]
            type_adv_tree="Goblin Spearman"
            #po: Ozgob has died, and any remaining goblins are deserting him
            message=_"Run away!"
        [/message]
        {CUTSCENE_ENEMIES_RETREAT 3 30 17}
        [message]
            speaker=Ozgob
            message=_"Useless... goblins..."
        [/message]

        [event]
            name=die
            {KILL side=2}
            {IF} {VARIABLE_CONDITIONAL failed_achievement not_equals yes} {THEN(
                {ACHIEVE s01}
            )}{/IF}
            {CLEAR_VARIABLE failed_achievement}
            {DELAY 1000}

            {SOUND horse-canter.wav}
            [unit]
                {SINGLEUNITWML_GARARD}
                side,x,y,facing=4,30,4,sw
            [/unit]
            [message]
                speaker=Garard
                #po: King Garard has just appeared, along with a few knights
                message=_"Ride forth, knights of Wesnoth! No orc who sets foot on our soil shall leave alive!"
            [/message]
            {GENERIC_UNIT 4 (Knight) 30 3}{FACING sw}  {MOVE_UNIT x,y=30,1 27 4}
            {GENERIC_UNIT 4 (Knight) 30 3}{FACING sw}  {MOVE_UNIT x,y=30,1 29 4}
            {GENERIC_UNIT 4 (Lancer) 30 5}{FACING sw}
            [message]
                speaker=Garard
                #po: Garard came to kill the goblins, but Delfador has already done it.
                message=_"But what’s this? It seems some magi have beaten us to battle and already slain our foe! I wasn’t making a mistake bringing Alduin into the fold after all. Who commands this detachment?"
            [/message]
            [message]
                speaker=Methor
                message=_"(bowing) My Lord, Alduin dispatched these apprentices as response to your war-call. I volunteered to lead them, and I now place my medicinal arts at your service."
            [/message]
            [message]
                speaker=Garard
                message=_"A healer? Well, we’ll have need of your services soon enough. Follow me back to camp. We attack on the morrow!"
            [/message]
            {CLEAR_VARIABLE explained_high_gold}
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
    [/event]

    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {TURNS} end
        [unit]
            {SINGLEUNITWML_GARARD}
            side,x,y,facing=4,30,4,sw
        [/unit]
        [message]
            speaker=Garard
            #po: King Garard has just appeared, along with a few knights
            message=_"Ride forth, knights of Wesnoth! No orc who sets foot on our soil shall leave alive!"
        [/message]
        {GENERIC_UNIT 4 (Knight) 30 3}{FACING sw}  {MOVE_UNIT x,y=30,1 27 4}
        {GENERIC_UNIT 4 (Knight) 30 3}{FACING sw}  {MOVE_UNIT x,y=30,1 29 4}
        {GENERIC_UNIT 4 (Lancer) 30 5}{FACING sw}
        [message]
            speaker=Garard
            #po: Delfador has failed to defeat the goblins. Garard does not respect him.
            message=_"But what’s this? Some pencil-necked magi have beaten us to battle, yet can’t even finish off a few goblins! Bah, go back to Alduin, you scholars have no place in war after all."
        [/message]
        [message]
            speaker=Delfador
            message=_"Now I’ll never make a name for myself..."
        [/message]
    [/event]

    {HERODEATHS}
[/scenario]

#undef SPAWN_GRUNT
#undef TURNS
