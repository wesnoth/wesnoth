#textdomain wesnoth-tsg

#define TURN_LIMIT
25#enddef
#define TURN_WARNING
20#enddef

[scenario]
    id=01_Born_to_the_Banner
    map_file=01_Born_to_the_Banner.map
    name= _ "Born to the Banner"
    next_scenario=02_Proven_by_the_Sword
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    {DEFAULT_SCHEDULE_DUSK} # so there's no ToD effects on the first turn, and so that it's daytime when our recruits fight the quintain
    turns=-1

    {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC battle.ogg}
    {EXTRA_SCENARIO_MUSIC knolls.ogg}
    {RESET_SAVELOAD_TIP}
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=South_Guard
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]

    #############################
    # MARI
    #############################
    [side]
        side=2
        color=red
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=South_Guard,quintain
    [/side]
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=quintain
        [ai]
            aggression=1
        [/ai]
    [/side]

    #############################
    # BANDITS
    #############################
    [side]
        side=4
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=bandits
        user_team_name=_"Urza Mathin"
        recruit=Thug
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    [event]
        name=side 4 turn
        first_time_only=no
        {RESET_SIDE_AI 4 offensive 0.4 0.25}
        {MODIFY_SIDE_AI 4 (
            [avoid]
                terrain=Ww^*
            [/avoid]
        )}
    [/event]

    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart

        #############################
        # MARI
        #############################
        [unit]
            {SINGLEUNITWML_MARI}
            side,x,y,facing=2,10,4,ne
        [/unit]
        {TRANSFORM_UNIT id=Mari "Veteran Fencer Relaxed"}
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
#ifdef HARD
        {MODIFY_UNIT id=Mari name _"The Author"}
        [message]
            speaker,image=Mari,wesnoth-icon.png # can't use narrator unless I create Deoran
            #po: notice that appears at the beginning of the scenario if you select Hard difficulty
            message=_"NOTE: ‘Hard’ difficulty is intended to be a challenge even for experienced players! If you’re new to Wesnoth, you may want to try a lower difficulty."
        [/message]
        {MODIFY_UNIT id=Mari name _"Captain Mari"}
#endif

        {DELAY 500}
        [unit]
            id=Deoran
            name= _ "Deoran"
            profile=portraits/deoran.webp
            type=Cavalryman Commander
            [modifications]
                [trait]
                    id,name=loyal_dummy,_"loyal"
                    description= _ "Zero upkeep"
                    [effect]
                        apply_to=loyal
                    [/effect]
                [/trait]
                {TRAIT_INTELLIGENT}
            [/modifications]
            canrecruit=yes
            unrenamable=yes
            side=1
            x,y=17,1
            facing=sw
            animate=yes
        [/unit]

        #############################
        # OPENING CUTSCENE
        #############################
        [message]
            speaker=Deoran
            image=portraits/deoran-glad.webp
            #po: deoran is fresh out of training, bright-eyed and eager to prove himself
            message= _ "Lieutenant Deoran, reporting for duty SIR! ...err, ma’am."
        [/message]
        [message]
            speaker=Mari
            #po: "academy" refers to some sort of Wesnoth military academy
            message= _ "Relax, Lieutenant. Fresh from the academy, are we?"
        [/message]
        [message]
            speaker=Deoran
            #po: "the prince" refers to Prince Arand, Garard II's brother
            message= _ "Yes ma’am. —sir. And as the prince ordered, I’ve brought with me a contingent of fresh soldiers to reinforce Westin’s faltering South Guard!"
        [/message]
        [message]
            speaker=Mari
            #po: Mari is somewhat sarcastic and not particularly emotive. She can come across as somewhat cold.
            message= _ "I’m Mari. Got the same orders as you; guess Prince Arand wanted an officer with experience to keep an eye on you and your “fresh” company. Can’t imagine why."
        [/message]
        [message]
            speaker=Mari
            message= _ "Well, orders are orders. Come on over here, Deoran — let’s get a closer look at you."
        [/message]
        [message]
            speaker=Deoran
            [option]
                label= _ "On my way!"
                [command]
                    {VARIABLE enable_tutorial_elements yes}
                    [fire_event]
                        name=play_tutorial
                    [/fire_event]
                [/command]
            [/option]
            [option]
                label= _ "I know what I’m doing. (Skip tutorial)"
                [command]
                    #                     {VARIABLE enable_tutorial_elements no}
                    {VARIABLE enable_tutorial_elements yes} # leave tips on by default, unless the player makes a point of disabling them
                    [modify_turns]
                        current=7 # ensure we don't get a time advantage by skipping the tutorial. Same ToD so it's not jarring.
                    [/modify_turns]
                    [gold]
                        side,amount=1,15 # compensate for the income we lost by skipping the tutorial
                    [/gold]
                    [message]
                        speaker=Mari
                        message= _ "Suit yourself. I’m sure you won’t need my help against those bandits anyway."
                    [/message]
                    [fire_event]
                        name=play_battle
                    [/fire_event]
                [/command]
            [/option]
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY TUTORIAL
    #######################################################################################################################################################
#define EXPLAIN_UNDO VALID_HEXES
    [event]
        name=moveto
        id=explain_undo
        [filter]
            id,formula=Deoran,(self.moves=0)
            {FILTER_LOCATION( {NOT({VALID_HEXES})} )}
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL tutorial_undo_explained not_equals yes}
        [/filter_condition]
        {UNDO_REMINDER}
        {VARIABLE tutorial_undo_explained yes}
    [/event]
#enddef
    [event]
        name=play_tutorial

        #############################
        # TUTORIAL 1: MOVE DEORAN
        #############################
        {TUTORIAL_ARROW 17 1}
        [event]
            name=select
            {FILTER id=Deoran}
            {REMOVE_ARROW}
            {TUTORIAL_ARROW 11 5}
        [/event]
        {EXPLAIN_UNDO x,y=11,5}
        [disallow_end_turn]
            reason=_"Move Deoran next to Mari first!
(press “u” if you need to undo a move)"
        [/disallow_end_turn]

        #------------------------
        # SHOW DESTINATION HEX
        #------------------------
        [objectives]
            [objective]
                description= _ "Move Deoran next to Mari"
                condition=win
            [/objective]
            [objective]
                description= _ "Get yourself killed"
                condition=lose
            [/objective]
        [/objectives]

        #############################
        # TUTORIAL 2: ATTACK QUINTAIN
        #############################
        [event]
            name=moveto
            {FILTER id,x,y=Deoran,11,5}
            #------------------------
            # INTRO
            #------------------------
            {REMOVE_ARROW}
            [remove_event]
                id=explain_undo
            [/remove_event]
            [message]
                speaker=Deoran
                message= _ "<i>(Bows)</i> A pleasure to make your acquaintance, Captain."
            [/message]
            [message]
                speaker=Mari
                #po: Mari is speaking sarcastically, and poking fun at game tutorials. Deoran is a trained soldier and obviously knows how to ride his horse and swing a sword - but the player needs to be taught how to move and attack
                message= _ "Amazing, you know how to ride your horse. Now let’s see if you know how to swing your sword."
            [/message]
            [store_unit]
                {FILTER id=Mari}
                variable,kill=stored_mari,yes
            [/store_unit]
            {NAMED_UNIT 3 Quintain 10 4 quintain "" ()} {FACING se} {GUARDIAN}
            {FAKE_UNIT_MOVE 10 9 4 5 2 (Mari) ()}
            [unstore_unit]
                variable=stored_mari
                x,y=9,5
            [/unstore_unit]
            [message]
                speaker=Deoran
                message= _ "...a quintain? You want me to attack a practice dummy?"
            [/message]
            {STORE_UNIT_VAR id=Deoran hitpoints deoran_hitpoints}
            [message]
                speaker=Mari
                message= _ "You have $deoran_hitpoints hitpoints and a sword, rookie. I’m fairly sure you’ll win."
            [/message]
            {CLEAR_VARIABLE deoran_hitpoints}
            #------------------------
            # OBJECTIVES
            #------------------------
            [disallow_end_turn]
                reason=_"Attack the dummy first!"
            [/disallow_end_turn]
            [objectives]
                [objective]
                    description= _ "Attack the dummy"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]

            #------------------------
            # ATTACK INDICATORS
            #------------------------
            {TUTORIAL_ARROW 11 5}
            [event]
                name=select
                {REMOVE_ARROW}
                {TUTORIAL_ARROW 10 4}
            [/event]
            [event]
                name=attack
                {REMOVE_ARROW}
            [/event]

            #------------------------
            # HARDCODE HITS/MISSES
            #------------------------
            # make the tutorial more consistent, so that dialogue is guaranteed to be sensible regardless of RNG
#define FORCE_ACCURACY UNIT VALUE
    [remove_object]
        object_id=force_cth_{UNIT}
    [/remove_object]
    [modify_unit]
        {FILTER id={UNIT}}
        [object]
            id=force_cth_{UNIT}
            [effect]
                apply_to=attack
                [set_specials]
                    mode=append
                    [chance_to_hit]
                        value={VALUE}
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
        [/object]
    [/modify_unit]
#enddef
            [event]
                name=attack
                {FILTER id=Deoran}
                # hardcode Deoran's first 3 strikes - show the player what a hit looks like twice, then show them what a miss looks like
                # also hardcode the second 3 strikes, so that the quintain gets to a consistently low amount of HP
                {FORCE_ACCURACY Deoran 100}
                [event]
                    name=attacker hits
                    {FILTER id=Deoran}
                    [event]
                        name=attacker hits
                        {FILTER id=Deoran}
                        {FORCE_ACCURACY Deoran 0}
                        [event]
                            name=attacker misses
                            {FILTER id=Deoran}
                            {FORCE_ACCURACY Deoran 100}
                            [event]
                                name=defender hits
                                {FILTER_SECOND id=Deoran}
                                {FORCE_ACCURACY Deoran 0}
                                [event]
                                    name=defender misses
                                    {FILTER_SECOND id=Deoran}
                                    {FORCE_ACCURACY Deoran 100}
                                    [event]
                                        name=defender hits
                                        {FILTER_SECOND id=Deoran}
                                        [remove_object]
                                            object_id=force_cth_Deoran
                                        [/remove_object]
                                    [/event]
                                [/event]
                            [/event]
                        [/event]
                    [/event]
                [/event]

                # hardcode the quintian's first 4 strikes (2 defending, 2 attacking) - get Deoran low, but don't kill him
                {FORCE_ACCURACY quintain 100}
                [event]
                    name=defender hits
                    {FILTER_SECOND id=quintain}
                    {FORCE_ACCURACY quintain 0}
                    [event]
                        name=defender misses
                        {FILTER_SECOND id=quintain} # the quintain gets deleted and replaced after this
                        [event]
                            name=attack
                            {FORCE_ACCURACY quintain 100}
                            [event]
                                name=new turn
                                [remove_object]
                                    object_id=force_cth_quintain
                                [/remove_object]
                            [/event]
                        [/event]
                    [/event]
                [/event]
            [/event]
        [/event]

        #############################
        # TUTORIAL 3: TURNS
        #############################
        [event]
            name=attack end

            # or else the quintain keeps playing it's defense anim
            {STORE_UNIT_VAR id=quintain hitpoints hitpoints}
            {KILL id=quintain}
            {NAMED_UNIT 3 Quintain 10 4 quintain "" ( experience,hitpoints=1,$hitpoints )} {FACING se}  {GUARDIAN}
            {CLEAR_VARIABLE hitpoints}
            #------------------------
            # INTRO
            #------------------------
            [message]
                speaker=Deoran
                image=portraits/deoran-mad.webp
                message= _ "Hey, this quintain fights back! I’m not about to lose to a dummy — let me attack again!"
            [/message]
            [message]
                speaker=Mari
                message= _ "Nice try, but you used up your turn attacking the quintain. The quintain now gets to attack."
            [/message]
            [message]
                speaker=Deoran
                message= _ "The <i>dummy</i> gets a turn?"
            [/message]
            [message]
                speaker=Mari
                message= _ "It’s a magical quintain, on loan from the wizards’ academy at Alduin. It strikes twice per attack, and does 13 “impact” damage with every strike. Brace yourself!"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"To end your turn, click the <b>“End Turn”</b> button in the bottom-right corner of the screen, or press <b>Ctrl+Space</b>."}
            [/message]
            [allow_end_turn][/allow_end_turn]

            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "End your turn"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
        [/event]

        #############################
        # TUTORIAL 4: VILLAGES
        #############################
        [event]
            name=turn 2
            [message]
                speaker=Deoran
                image=portraits/deoran-sad.webp
                message= _ "I’m injured; this is more dangerous than I expected. I need to retreat to a village and regain some hitpoints."
            [/message]
            {TUTORIAL_ARROW  8 6}
            {TUTORIAL_ARROW 12 7}
            [disallow_end_turn]
                reason=_"Move to a village first!
(press “u” if you need to undo a move)"
            [/disallow_end_turn]
            {EXPLAIN_UNDO terrain=*^V*}
            #------------------------
            # PREVENT ATTACKING
            #------------------------
            # need to check for moveto as well, because [allow_undo] doesn't work in an attack event
            [event]
                name=pre attack
                first_time_only=no
                id=prevent_attacking1
                [fire_event]
                    name=prevent_attacking3
                [/fire_event]
                [allow_undo][/allow_undo]
            [/event]
            [event]
                name=moveto
                first_time_only=no
                id=prevent_attacking2
                {FILTER( {FILTER_ADJACENT id=quintain} )}
                [fire_event]
                    name=prevent_attacking3
                [/fire_event]
                [allow_undo][/allow_undo]
            [/event]
            [event]
                name=prevent_attacking3
                id=prevent_attacking3
                first_time_only=no
                {STORE_UNIT_VAR id=Deoran hitpoints hitpoints}
                [message]
                    speaker=Deoran
                    message= _"I have only $hitpoints hitpoints left! If I attack now, I am sure to be vanquished. By a dummy, no less."
                [/message]
                {CLEAR_VARIABLE hitpoints}
                [cancel_action][/cancel_action]
                [allow_undo][/allow_undo]
            [/event]

            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "End your turn on a village"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]

            #------------------------
            # VILLAGE EXPLANATION
            #------------------------
            [event]
                name=capture
                {REMOVE_ARROW}
                [remove_event]
                    id=explain_undo
                [/remove_event]
                [message]
                    speaker=Mari
                    message= _"You have captured a village, which now flies the red-and-white colors of our banner. Each village you own generates 1 gold per turn, and supports 1 unit’s worth of upkeep."
                [/message]
                [message]
                    speaker=Mari
                    message= _"More importantly for you, villages also provide healing. Starting your turn on a village will <i>heal</i> you for 8 hitpoints. End your turn now."
                [/message]
                [allow_end_turn][/allow_end_turn]
            [/event]
        [/event]

        #############################
        # TUTORIAL 5: RECRUITING
        #############################
        [event]
            name=side 1 turn 3 refresh
            [remove_event]
                id=prevent_attacking1 # remove this early, or else it's possible to get softlocked
            [/remove_event]
            [message]
                speaker=Mari
                message= _"Congratulations, you ran away from the quintain and have regained 8 hitpoints from your village. I hope you’re proud."
            [/message]
            [message]
                speaker=Deoran
                message= _"I’ve had enough of being humiliated by this dummy. Time to recruit some proper soldiers and smash that thing to pieces."
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"The golden crown above Deoran’s HP bar indicates that he’s a leader: he can <b>recruit</b> new units when standing on a castle’s <b>keep</b> hex.

In most scenarios, you will lose if your leader is killed. Use Deoran enough to build his experience, but not so aggressively that he’s at risk of dying!"}
            [/message]
            {TUTORIAL_ARROW 9 10}
            [disallow_end_turn]
                reason=_"Use “Ctrl+R” to recruit a soldier first!
(press “u” if you need to undo a move)"
            [/disallow_end_turn]
            {EXPLAIN_UNDO x,y=9,10}
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "Recruit some soldiers"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]

            #------------------------
            # EXPLAIN RECRUITING
            #------------------------
            [event]
                name=moveto
                {FILTER id,x,y=Deoran,9,10}
                {REMOVE_ARROW}
                [remove_event]
                    id=explain_undo
                [/remove_event]
                [message]
                    speaker=Deoran
                    message= _"Good, I’m on the keep. If I press <b>Ctrl+R</b>, I can recruit new soldiers to help fight."
                [/message]
                {EXPLAIN_UNDO( x,y=9,10 {OR terrain=*^V*} )} # don't remove this 3rd undo explanation, even after we're past the risk of being softlocked. This is useful info for the player to know regardless
            [/event]

            [event]
                name=recruit
                priority=99
                [message]
                    speaker=unit
                    message= _"At your service, Commander Deoran! You’ll need to wait until next turn before I can move or attack. I suggest you keep recruiting more soldiers!"
                [/message]
                [remove_event]
                    id=prevent_attacking2
                [/remove_event]
                [remove_event]
                    id=prevent_attacking3
                [/remove_event]
                [allow_end_turn][/allow_end_turn] # at this point we never disallow ending the turn again, so there's no longer any risk of being softlocked
            [/event]
        [/event]

        #############################
        # TUTORIAL 6: KILLING THE QUINTAIN
        #############################
        [event]
            name=turn 4
            [message]
                speaker=Deoran
                message= _"The quintain is healing itself! Come on men, let’s go finish it off!"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"In addition to the +8 healing provided by a village, units will also regenerate 2 hitpoints if they spend their turn resting: neither moving nor fighting.

This “rest-healing” stacks with village healing."}
            [/message]

            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "Destroy Mari’s quintain"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]

            #------------------------
            # QUINTAIN KILLS
            #------------------------
            [event]
                name=die
                {FILTER( {NOT id=Deoran} )}
                {FILTER_SECOND id=quintain}
                [message]
                    speaker=Mari
                    message= _ "...he’s fine. Just out cold, and of no use to you for the rest of our journey."
                [/message]
            [/event]

            #------------------------
            # QUINTAIN DIES
            #------------------------
            [event]
                name=die
                {FILTER id=quintain}
                [message]
                    speaker=second_unit
                    message= _ "Hooray! The dummy is destroyed, and I have gained 8 experience!"
                [/message]
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    {TUTOR: _"Units gain a small amount of experience when attacking or defending, but gain much more by striking a finishing blow, especially against high-level enemies.

With enough experience, a soldier will advance to a powerful level 2 unit."}
                [/message]
                [message]
                    speaker=Mari
                    message= _ "Not bad, you’ve smashed it to splinters. ...is it too late to mention that I was supposed to return that after we finished training? Maybe I can find a replacement once we reach Westin."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Mari
                    message= _ "Of course before we can reach Westin, we’ll first have to fight our way past these bandits."
                [/message]
                [store_unit]
                    {FILTER side=1}
                    variable=quintain_killers
                [/store_unit]
                [fire_event]
                    name=play_battle
                [/fire_event]
            [/event]
        [/event]

        #############################
        # BANDIT SHOWS UP EVENTUALLY
        #############################
        [event]
            name=turn 5
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "Are you... actually trying to fight the quintain? We don’t have all day."
            [/message]
        [/event]
        [event]
            name=turn 7
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "We’re going to have to cut things short, rookie. Look: bandits on the south road!"
            [/message]
            {KILL id=quintain}
            [fire_event]
                name=play_battle
            [/fire_event]
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                        PLAY BATTLE
    #######################################################################################################################################################
    [event]
        name=play_battle
        [message]
            speaker=Deoran
            message= _ "Bandits! Where?"
        [/message]

        #############################
        # PREPARE MAP
        #############################
        [replace_map]
            map_file=01b_Born_to_the_Banner.map
            expand,shrink=yes,yes
        [/replace_map]
        {NAMED_UNIT 4 Bandit 16 20 "Urza Mathin" _"Urza Mathin" ( canrecruit=yes {MODIFICATIONS({TRAIT_STRONG}{TRAIT_INTELLIGENT})} )}
        [modify_side]
            side=4
            hidden=no
            gold={ON_DIFFICULTY 0 0 60}
            income={ON_DIFFICULTY -1 1 5} # plus 1 village
        [/modify_side]
        [capture_village]
            side=4
            x,y,radius=19,20,8
        [/capture_village]
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug Thug Thug}) 11 20 ({FACING nw})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug Thug Thug}) 13 22 ({FACING ne})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none Thug Thug}) 18 20 ({FACING nw}{GUARDIAN}{ROLE tod_guard})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none Thug Thug}) 16 21 ({FACING nw}{GUARDIAN}{ROLE tod_guard})}
        [modify_turns]
            value={TURN_LIMIT}
        [/modify_turns]

        #############################
        # INTRO CUTSCENE
        #############################
        {SCROLL_TO 16 20}
        {DELAY 500}
        [message]
            speaker=Urza Mathin
            message= _ "Oh, what’s this? A lady and her loyal squire travelin’ south on this dangerous road? Tell ya what, we can offer ya protection ’round here for a small fee."
        [/message]
        [if] {HAVE_UNIT id,x,y=Deoran,17,1}
            [then]
                {TELEPORT_UNIT id=Deoran 9 10}
                {MODIFY_UNIT id=Deoran facing se}
                [capture_village]
                    side=1
                    x,y,radius=10,6,3
                [/capture_village]
            [/then]
        [/if]
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Do you take us for fools? I ride south to reinforce Westin’s venerable South Guard, on orders from Prince Arand to ensure the region is kept safe and secure!"
        [/message]
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "The only danger around here is you, and I intend to put an end to it. Men, raise your spears!"
        [/message]
        [message]
            speaker=Urza Mathin
            message= _ "Hah, like it would be that easy, child. I’m Urza Mathin, eldest of the four Uzra brothers, and these are my thugs. Time to show you who the real power is in these parts!"
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Defeat Urza Mathin"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Mari"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        #######################################################################################################################################################
        #                                                                       S01 TIPS
        #######################################################################################################################################################
        #############################
        # MARI SPECTATES
        #############################
        [event]
            name=side 1 turn end
            {TRANSFORM_UNIT id=Mari "Veteran Fencer"}
            {MOVE_UNIT id=Mari 14 10}
            [if] {NOT({HAVE_UNIT x,y=14,11})}
                [then]
                    {MOVE_UNIT id=Mari 14 11}
                [/then]
            [/if]
            {MODIFY_UNIT id=Mari facing sw}
            {DELAY 500}
            {TRANSFORM_UNIT id=Mari "Veteran Fencer Relaxed"}
            [message]
                speaker=Deoran
                message= _ "Are you going to help fight? We must drive these villains from the road!"
            [/message]

            [if] {VARIABLE_CONDITIONAL quintain_killers.length greater_than 0}
                [then]
                    [message]
                        speaker=Mari
                        message= _ "Officially, I’m only here as an observer. These ruffians don’t look too dangerous — you and your professional soldiers should be able to make short work of them, even without my sword."
                    [/message]
                    [message]
                        speaker=Mari
                        #po: sarcasm. $quintain_killers.length is probably between 3 and 5
                        message= _ "Besides, it only took $quintain_killers.length of you to deal with my dummy. What’s a dozen muscly bandits compared to that?"
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Mari
                        message= _ "Oh, <i><b>now</b></i> you want my help? I thought you were too clever to listen to my tutorial."
                    [/message]
                    [message]
                        speaker=Mari
                        message= _ "Look, officially I’m only here as an observer. These ruffians don’t look too dangerous — you and your professional soldiers should be able to make short work of them, even without my sword."
                    [/message]
                [/else]
            [/if]

            [if] {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                [then]
                    [message]
                        speaker,image=narrator,wesnoth-icon.png
                        {TUTOR: _"You may toggle tips on or off at any time during the campaign by right-clicking anywhere and selecting “Tips: On/Off” in the menu."}
                    [/message]
                [/then]
                [else] # NOTE - skipping the tutorial no longer disables tips, but I'm leaving this message here in case I revert that in the future
                    [message]
                        speaker,image=narrator,wesnoth-icon.png
                        {TUTOR: _"You may toggle tips on or off at any time during the campaign by right-clicking anywhere and selecting “Tips: On/Off” in the menu.

Because you skipped the tutorial, tips are currently off."}
                    [/message]
                [/else]
            [/if]
            [micro_ai]
                side,action,ai_type=2,add,zone_guardian
                {FILTER id=Mari}
                {FILTER_LOCATION x,y,radius=14,11,1}
                station_x,station_y=14,11
            [/micro_ai]

            #############################
            # MARI FIGHTS
            #############################
            [event]
                name=attack
                {FILTER id=Mari}
                {FIRE_EVENT mari_fights}
            [/event]
            [event]
                name=attack
                {FILTER_SECOND id=Mari}
                {FIRE_EVENT mari_fights}
            [/event]
            [event]
                name=mari_fights
                {FILTER id=Mari}
                [message]
                    speaker=Mari
                    message= _ "Get out of my face!"
                [/message]
                [event]
                    name=attack end
                    [message]
                        speaker=Deoran
                        message= _ "What happened to being a passive observer?"
                    [/message]
                    [message]
                        speaker=Mari
                        message= _ "...self-defense doesn’t count."
                    [/message]
                [/event]
            [/event]

            #############################
            # TUTORIAL TOGGLE
            #############################
            [set_menu_item]
                id=tutorial_toggle_on
                description= _ "Tip Dialogue & Popups: On"
                image="wesnoth-icon.png~SCALE(18,18)"
                [show_if]
                    {VARIABLE_CONDITIONAL enable_tutorial_elements     equals yes}
                [/show_if]
                [command]
                    {VARIABLE enable_tutorial_elements no}
                    [hint_message]
                        remove=yes
                    [/hint_message]
                    {FIRE_EVENT clear_tips}
                [/command]
            [/set_menu_item]
            [set_menu_item]
                id=tutorial_toggle_off
                description= _ "Tip Dialogue & Popups: Off"
                image="wesnoth-icon.png~SCALE(18,18)"
                [show_if]
                    {VARIABLE_CONDITIONAL enable_tutorial_elements not_equals yes}
                [/show_if]
                [command]
                    {VARIABLE enable_tutorial_elements yes}
                [/command]
            [/set_menu_item]
        [/event]

        #############################
        # TIP: MARI EXPLAINS DEFENSE
        #############################
        [event]
            name=new turn
            [event]
                name=new turn
                [event]
                    name=new turn
                    {FILTER_CONDITION( {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes} )}
                    [message]
                        speaker=Mari
                        message= _ "Wondering about those percentages that appear on the ground every time you try to move a unit? That’s your soldiers’ terrain defense — their <i><b>chance to dodge</b></i> enemy attacks."
                    [/message]
                    [display_tip]
                        title=_"Dodging Attacks"
                        image=tutor/dodge.png
                        message=_"In Wesnoth, every attack has a chance to miss.

Units on favorable terrain (such as castles, villages,
forest, or hills) are more likely to dodge attacks, while
units on poor terrain (such as water, sand, or ice)
are much easier to hit.

Try to position your units on good terrain, and attack
your enemies while they’re on poor terrain!"
                    [/display_tip]
                [/event]
            [/event]
        [/event]

        #############################
        # TIP: TIME OF DAY
        #############################
        [event]
            name=tod_popup
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes} )}
            [display_tip]
                title=_"Time of Day"
                image=tutor/tod.png
                message=_"Every turn, the time of day changes,
affecting how much damage units do.

In this campaign, <i><b>most of your units
will be deadliest during the day,
while most of your enemies will
be deadliest at night.</b></i>

See the current time of day and its
effects by mousing over the right-side
panel."
            [/display_tip]
        [/event]
        [event]
            name=new turn # don't trigger this on the initial turn, regardless of the ToD
            [event]
                name=new turn
                first_time_only=no
                [store_time_of_day]
                [/store_time_of_day]
            [/event]
            [event]
                name=side 1 turn
                {FILTER_CONDITION(
                    {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                    {VARIABLE_CONDITIONAL time_of_day.id equals morning} # at morning, so it coincides with the AI's retreat
                )}
                [message]
                    speaker=Deoran
                    message= _ "Day has come! We will be strongest in the light — now is the time for us to attack and drive these bandits from our lands. To me, men of the South Guard!"
                [/message]
                [fire_event]
                    name=tod_popup
                [/fire_event]
            [/event]
            [event]
                name=side 2 turn refresh
                {FILTER_CONDITION(
                    {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                    {VARIABLE_CONDITIONAL time_of_day.id equals dusk} # at dusk, so it coincides with the AI's attack
                )}
                [message]
                    speaker=Urza Mathin
                    message= _ "The sun begins to set! Soon these Wesnoth soldiers will falter in the dark, while my thugs and I will fight at our best!"
                [/message]
                [gold]
                    side=2
                    amount={ON_DIFFICULTY 10 20 40}
                [/gold]
                [fire_event]
                    name=tod_popup
                [/fire_event]
                {MODIFY_UNIT role=tod_guard status.guardian no}
            [/event]
        [/event]

        #############################
        # TIP: ATTACKING AT BAD TODs
        #############################
        [event]
            name=attack end
            first_time_only=no
            {FILTER_CONDITION(
                {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
                {OR( {VARIABLE_CONDITIONAL time_of_day.id equals second_watch} )}
            )}
            {VARIABLE_OP unfavorable_attacks add 1}
        [/event]
        [event]
            name=new turn,side 1 turn end
            {FILTER_CONDITION(
                {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                {VARIABLE_CONDITIONAL unfavorable_attacks greater_than_equal_to {ON_DIFFICULTY 4 5 6}}
                {HAVE_UNIT( side,count=2,2-99 {FILTER_ADJACENT side=1} )} # only trigger this if we're still in combat, not if we already won
            )}
            [message]
                speaker=Urza Mathin
                message= _ "Ha, this will be an easy victory! These soldiers’ young commander must be a fool, for he fights my thugs at night while I am strong and he is weak."
            [/message]
            [fire_event]
                name=tod_popup
            [/fire_event]
        [/event]
        [event]
            name=prestart,side 1 turn end
            first_time_only=no
            {VARIABLE unfavorable_attacks 0}
        [/event]
        [event]
            name=victory
            {CLEAR_VARIABLE unfavorable_attacks}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TIME ALMOST OVER
    #############################
    [event]
        name=turn {TURN_WARNING}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes} )}
        [message]
            speaker=Mari
            message= _ "Get a move on, rookie! You’re running out of time to finish off these bandits. You can see the turn counter in the upper-left-hand corner — once you run out of turns, you’ll lose the scenario."
        [/message]
        [fire_event]
            name=explain_turn_limit
        [/fire_event]
    [/event]
    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {TURN_LIMIT} end
        {GENERIC_UNIT 2 (Footpad) 10 23} {ANIMATE}
        {GENERIC_UNIT 2 (Outlaw)   9 22} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad) 12 22} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad)  7 23} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad)  6 23} {ANIMATE}
        {GENERIC_UNIT 2 (Trapper)  1 17} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  2 17} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  1 15} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  3 16} {ANIMATE}
        [message]
            speaker=Urza Mathin
            message= _ "Reinforcements from my brothers! Excellent. These lands belong to the brothers Urza!"
        [/message]
        [message]
            speaker=Mari
            message= _ "We’ve run out of turns, and now more enemies have arrived! We’ll have to retreat and bring more soldiers some other time. I really thought Deoran could handle this on his own..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #############################
    # URZA MATHIN DIES
    #############################
    [event]
        name=last breath
        {FILTER( id=Urza Mathin )}
        #------------------------
        # URZA MATHIN DIES
        #------------------------
        {ACHIEVE s01}
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "You are beaten, you bloodthirsty, balding bandit! Accosting travelers between Weldyn and Westin; what is the meaning of this? How have you become so bold as to strike at even trained soldiers!?"
        [/message]
        [message]
            speaker=Urza Mathin
            message= _ "How... impossible... no! If I die... so will you!"
        [/message]
        [object]
            {FILTER id="Urza Mathin"}
            [effect]
                apply_to=new_animation
                id=urza_mathin_black_magic
                [animation]
                    apply_to=black_magic
                    start_time=0
                    [frame]
                        image="units/human-outlaws/bandit-defend-1.png:150"
                    [/frame]
                    [frame]
                        image="units/human-outlaws/bandit-defend-2.png"
                        halo=halo/undead/dark-magic-[1~6].png:50
                        halo_x,halo_y=0,0
                    [/frame]
                    [frame]
                        image="units/human-outlaws/bandit-defend-1.png:150"
                    [/frame]
                    sound_start_time=-40
                    [sound_frame]
                        sound=magic-dark.ogg
                    [/sound_frame]
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            {FILTER id="Urza Mathin"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Mathin"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Mathin"}
            flag=black_magic
        [/animate_unit]
    [/event]
    [event]
        name=die
        {FILTER( id=Urza Mathin )}
        {STORE_UNIT_VAR id="Urza Mathin" x      urzX}
        {STORE_UNIT_VAR id="Urza Mathin" y      urzY}
        {STORE_UNIT_VAR id="Urza Mathin" facing urzF}
        {KILL id="Urza Mathin"}
        #------------------------
        # ZOMBIE APPEARS
        #------------------------
        {NAMED_UNIT 4 Soulless $urzX $urzY "Zombie Mathin" _"Urza Mathin" (canrecruit,facing=yes,$urzF)} {ANIMATE}
        [message]
            speaker=Deoran
            message= _ "What the—"
        [/message]
        [message]
            speaker=Zombie Mathin
            message= _ "Gruhh..."
        [/message]
        {TRANSFORM_UNIT id=Mari "Veteran Fencer"}
        {TELEPORT_UNIT id=Mari 11 17} # so she has less distance to walk
        {MOVE_UNIT id=Mari $urzX $urzY}
        {CLEAR_VARIABLE urzX,urzY,urzF}
        [message]
            speaker=Mari
            message= _ "Look out!"
        [/message]
        [harm_unit]
            {FILTER id="Zombie Mathin"}
            {FILTER_SECOND id=Mari}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount=999
            animate=yes
            delay=0
            experience=no
        [/harm_unit]

        #------------------------
        # WONDERING ABOUT ZOMBIES
        #------------------------
        [message]
            speaker=Mari
            #po: Mari lost her left arm fighting undead in the Estmarks
            message= _ "Undead again. As if losing one arm to these things wasn’t bad enough, now they’re back for my second."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’ve never seen the like before in my life! That man clearly died, then stood right back up again! You say you’ve fought these things before, Mari?"
        [/message]
        [message]
            speaker=Mari
            message= _ "Yeah, I have. And no, simple bandits aren’t supposed to know how to create them. This reeks of black magic; powerful black magic."
        [/message]
        [message]
            speaker=Deoran
            message= _ "This brother said he was the eldest of four — the other three are doubtless still alive and causing trouble. How did petty outlaws get their hands on magic like this?"
        [/message]
        [message]
            speaker=Mari
            message= _ "Maybe the locals in town will know something. Come on, let’s hurry onwards towards Westin, and hope we don’t run into any more trouble on the way."
        [/message]

        [store_unit]
            {FILTER id=Mari}
            variable=stored_mari
            kill=yes
        [/store_unit]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]

#undef TURN_LIMIT
#undef TURN_WARNING
