[scenario]
    id=6a_Tidings_Good_And_Ill
    #textdomain wesnoth-tsg

    name= _ "Tidings, Good and Ill"
    next_scenario=7a_Into_The_Depths
    [music]
        name=battle.ogg
        ms_before=500
    [/music]
    [music]
        name=loyalists.ogg
        ms_before=500
        append=yes
    [/music]

    map_data="{campaigns/The_South_Guard/maps/6a_Tidings_Good_And_Ill.map}"

    {campaigns/The_South_Guard/utils/sg_deaths.cfg}
    {campaigns/The_South_Guard/utils/sg_help.cfg}

    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    {DAWN}
    {MORNING}
    {AFTERNOON}

    turns=18
    victory_when_enemies_defeated=no

    # Deoran will be removed and Gerrick instated as the leader in a prestart
    # event.

    [side]
        side=1
        type=Horseman Commander
        description=Deoran
        user_description= _ "Deoran"
        unrenamable=yes

        team_name=South_Guard
        controller=human
        {CUSTOM_SG_FLAG}

        gold=0
        income=0

        shroud=yes
        fog=yes

        canrecruit=1
    [/side]

    # Miscellaneous Enemy Combatants

    [side]
        side=2

        team_name=Various_Baddies
        no_leader=yes

        controller=ai

        {SG_GUARD (Saurian Skirmisher) (Ssesseth) (_"Ssesseth") 2 8 21}
        {SG_GUARD (Saurian Skirmisher) (Zasz) (_"Zasz") 2 17 16}
        {SG_GUARD (Saurian Skirmisher) (Zerix) (_"Zerix") 2 8 16}

        {SG_GUARD (Giant Scorpion) (Scorpion) (_"Scorpion") 2 14 16}
        {SG_GUARD (Ogre) (Kramak) (_"Kramak") 2 4 10}

        {SG_GUARD (Naga Fighter) (Issorai) (_"Issorai") 2 13 9}
        {SG_GUARD (Naga Fighter) (Zarr) (_"Zarr") 2 14 9}

#ifdef EASY
        {SG_GUARD (Dark Adept) (Abdur) (_"Abdur") 2 8 1}
        {SG_GUARD (Naga Fighter) (Queen Xeila) (_"Queen Xeila") 2 12 8}
#endif

#ifdef NORMAL
        {SG_GUARD (Saurian Skirmisher) (Ssanur) (_"Ssanur") 2 9 14}
        {SG_GUARD (Dark Adept) (Abdur) (_"Abdur") 2 8 1}
        {SG_GUARD (Naga Warrior) (Queen Xeila) (_"Queen Xeila") 2 12 8}
        {SG_GUARD (Naga Fighter) (Lesssh) (_"Lesssh") 2 13 7}
#endif

#ifdef HARD
        {SG_GUARD (Saurian Ambusher) (Ssanur) (_"Ssanur") 2 9 14}
        {SG_GUARD (Dark Adept) (Abdur) (_"Abdur") 2 8 1}
        {SG_GUARD (Dark Adept) (Kallen) (_"Kallen") 2 7 1}
        {SG_GUARD (Naga Myrmidon) (Queen Xeila) (_"Queen Xeila") 2 12 8}
        {SG_GUARD (Naga Warrior) (Lesssh) (_"Lesssh") 2 13 7}
#endif
    [/side]

    #prestart

    [event]
        name=prestart

        # Store away Deoran, his human troops, Ethiliel and her bodyguards, so
        # that only Gerrick and the rest of the elves remain.

        [store_unit]
            [filter]
                description=Deoran
            [/filter]

            kill=yes
            variable=stored_Deoran
        [/store_unit]

        [store_unit]
            [filter]
                description=Ethiliel
            [/filter]

            kill=yes
            variable=stored_Ethiliel
        [/store_unit]

        [store_unit]
            [filter]
                description=Minister Hylas
            [/filter]

            kill=yes
            variable=stored_Hylas
        [/store_unit]

        [store_unit]
            [filter]
                side=1

                [not]
                    description=Sir Gerrick
                [/not]

                [not]
                    race=elf

                    [not]
                        description=Ethiliel
                    [/not]

                    [not]
                        description=Elvish Bodyguard
                    [/not]
                [/not]
            [/filter]

            kill=yes
            variable=stored_Deoran_army
        [/store_unit]

        # Store Deoran's gold so it can be restored in Into the Depths and set
        # Gerrick's gold to 100.

        [store_side]
            side=1
            variable=stored_Deoran_side
        [/store_side]

        [modify_side]
            side=1
            gold=100
        [/modify_side]

        # Recall Gerrick and set him as the leader.

        [recall]
            description=Sir Gerrick
            x,y=16,23
        [/recall]

        {MODIFY_UNIT (description=Sir Gerrick) canrecruit 1}

        [set_recruit]
            side=1
            recruit=Elvish Fighter,Elvish Shaman
        [/set_recruit]

        [unit]
            type=Elvish Ranger
            description=Eliomir
            user_description= _ "Eliomir"
            x,y=17,22
            facing=sw
            side=1
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
    [/event]

    #start

    [event]
        name=start

        [message]
            speaker=Eliomir
            message= _ "Sir Gerrick, you must make it back to Kerlath Province and warn your people of the danger from the south. We will lead you through the forest and clear any foes from your path. You may choose some of our veterans to go with you as well, and any ones you leave behind will still have time to catch up with Ethiliel and Deoran."
        [/message]

        [remove_shroud]
            side=1
            x=8-10
            y=0-2
        [/remove_shroud]

        {HIGHLIGHT_IMAGE 9 1 items/gohere.png ()}

        [message]
            speaker=Sir Gerrick
            message= _ "With the bandits and undead vanquished behind us, what foes can there be ahead? Let us hope this is a speedy journey, for the spectre of winter looms."
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Move Sir Gerrick to the north end of the woods"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Sir Gerrick"
                condition=lose
            [/objective]
            [objective]
                description= _ "Time runs out"
                condition=lose
            [/objective]
        [/objectives]
    [/event]

    # The nagas are sighted, and move to defend their home.
    # They are enraged if you allied with the mermen in "Born to the Banner"

    [event]
        name=sighted
        [filter]
            description=Queen Xeila
        [/filter]

        [if]
            [variable]
                name=has_mermen
                equals="yes"
            [/variable]
            [then]
                [message]
                    speaker=Queen Xeila
                    message= _ "Hss... Here are the humans who have made a pact with the cursed mermen! Hss..."
                [/message]
                [message]
                    speaker=Eliomir
                    message= _ "We have stumbled into a den of nagas!"
                [/message]
                [message]
                    speaker=Queen Xeila
                    message= _ "Hss... We will kill them all, my brood. Hss..."
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "We must clear this road for Deoran and Ethiliel! We must destroy the naga lair!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Queen Xeila
                    message= _ "Hss... elves! Are they friends or enemies? Hss..."
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "We are weary travelers, seeking our homes. If you but let us pass..."
                [/message]
                [message]
                    speaker=Queen Xeila
                    message= _ "Hss... And humans! Humans drained our swamps and made them fields for farms, and now they have found my winter nest. The Land-Walkers must die! Hss..."
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "She won't listen. If we leave these nagas here, they will ambush Deoran and Ethiliel! We must destroy them!"
                [/message]
            [/else]
        [/if]

        {VARIABLE naga_queen_sighted yes}

        [objectives]
            side=1
            [objective]
                description= _ "Move Sir Gerrick to the north end of the woods"
                condition=win
            [/objective]
            [objective]
                description= _ "Defeat the Queen Xeila"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Sir Gerrick"
                condition=lose
            [/objective]
            [objective]
                description= _ "Time runs out"
                condition=lose
            [/objective]
        [/objectives]
    [/event]

    [event]
        name=sighted
        [filter]
            type=Naga Fighter,Naga Warrior,Naga Myrmidon

            [not]
                description=Queen Xeila
            [/not]
        [/filter]

        [if]
            [variable]
                name=naga_queen_sighted
                not_equals=yes
            [/variable]

            [then]
                [message]
                    speaker=second_unit
                    message= _ "There are a group of naga occupying this area... they don't look very friendly."
                [/message]

                [message]
                    speaker=Sir Gerrick
                    message= _ "if they are hostile to us, they could endanger Deoran and Ethiliel as well. Perhaps their leader can be reasoned with."
                [/message]
            [/then]
        [/if]
    [/event]

    # Queen Xeila dies...

    [event]
        name=die
        [filter]
            description=Queen Xeila
        [/filter]
        [message]
            speaker=Queen Xeila
            message= _ "Hss... Who will watch over my brood now? Hss..."
        [/message]
    [/event]

    # Kramak, the wild ogre
    # @Translators: The ogre purposely has very bad grammar, because he is very stupid.

    [event]
        name=sighted
        [filter]
            description=Kramak
        [/filter]
        [message]
            speaker=Kramak
            message= _ "Ho! Me see elves. Elves tasty? Me take elves to eat."
        [/message]
        [message]
            speaker=Eliomir
            message= _ "Err, Mr. Ogre, we are not very tasty."
        [/message]
        [message]
            speaker=Kramak
            message= _ "Oh. Me only want tasty food. Go away."
        [/message]
        [message]
            speaker=Kramak
            message= _ "..."
        [/message]
        [message]
            speaker=Kramak
            message= _ "Wait! Me not believe you. Me eat you!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            description=Kramak
        [/filter]
        [message]
            speaker=Ogre
            message= _ "Bad food! It hurt me. Arrrrggghhhh!!"
        [/message]
    [/event]

    # The Dark Adept's Story
    [event]
        name=sighted
        [filter]
            description=Abdur
        [/filter]
        [message]
            speaker=Abdur
            message= _ "Travelers in this desolate land! I seek that dark Sage who is rumored to dwell in these lands. Surely you have come from him?"
        [/message]
        [message]
            speaker=Sir Gerrick
            message= _ "Indeed! I just left my comrades, who were preparing to kill the vile Necromancer."
        [/message]
        [message]
            speaker=Abdur
            message= _ "Unworthy fools! I'll kill you for this sacrilege!"
        [/message]
    [/event]

    # Sir Gerrick moves to the head of the road
    [event]
        name=moveto
        first_time_only=no
        [filter]
            description=Sir Gerrick
            x,y=9,1
        [/filter]

        [if]
            [have_unit]
                description=Queen Xeila
            [/have_unit]

            [then]
                [message]
                    speaker=Sir Gerrick
                    message= _ "These naga are still in control of the road. We must clear the way for Deoran and Ethiliel!"
                [/message]

                [allow_undo][/allow_undo]
            [/then]

            [else]
                [removeitem]
                    x,y=9,1
                [/removeitem]

                [message]
                    speaker=Sir Gerrick
                    message= _ "I will hasten back to Kerlath Province now and seek the advice of the Council of Westin..."
                [/message]
                [message]
                    speaker=Eliomir
                    message= _ "We too will return to our councils. We have much to tell them... Much indeed."
                [/message]
                [message]
                    speaker=narrator
                    message= _ "While the council debated the best course of action, Deoran and Ethiliel prepared to enter the caves under Mebrin's fortress..."
                    image=wesnoth-icon.png
                [/message]

                # The next scenario is again led by Deoran, so store away Gerrick and
                # his troops, except those remaining on the recall list.

                [store_unit]
                    [filter]
                        description=Sir Gerrick
                    [/filter]

                    kill=yes
                    variable=stored_Sir_Gerrick
                [/store_unit]

                {VARIABLE stored_Sir_Gerrick.canrecruit 0}

                [store_unit]
                    variable=stored_Sir_Gerrick_army
                    [filter]
                        side=1
                        x,y=1-99,1-99
                    [/filter]
                    kill=yes
                [/store_unit]

                # Reinstate Deoran as the leader and unstore Hylas, Ethiliel and
                # troops so they're all again recallable in the next scenario.

                {VARIABLE stored_Deoran.x 16}
                {VARIABLE stored_Deoran.y 23}

                [unstore_unit]
                    variable=stored_Deoran
                [/unstore_unit]

                [unstore_unit]
                    variable=stored_Ethiliel
                [/unstore_unit]

                [unstore_unit]
                    variable=stored_Hylas
                [/unstore_unit]

                {FOREACH stored_Deoran_army i}
                [unstore_unit]
                    variable=stored_Deoran_army[$i]
                [/unstore_unit]
                {NEXT i}

                [endlevel]
                    bonus=no
                    result=continue
                [/endlevel]
            [/else]
        [/if]
    [/event]
[/scenario]
