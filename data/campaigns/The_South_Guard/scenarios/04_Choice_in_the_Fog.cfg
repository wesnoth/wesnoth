#textdomain wesnoth-tsg

#define TURN_LIMIT
25#enddef
#define TURN_WARNING
20#enddef

[scenario]
    id=04_Choice_in_the_Fog
    map_file=04_Choice_in_the_Fog.map
    name= _ "Choice in the Fog"
    next_scenario=04_Choice_in_the_Fog
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    {DEFAULT_SCHEDULE_AFTERNOON}
    turns=15
    {ADD_WEATHER_RAIN}
    {SCENARIO_MUSIC into_the_shadows.ogg}
    {EXTRA_SCENARIO_MUSIC nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC suspense.ogg}
    {SG_BLIGHT}
    {TSG_BIGMAP {JOURNEY_04_NEW} }
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        fog,shroud=yes,yes
    [/side]
    {STARTING_VILLAGES 1 5}
    #############################
    # BANDITS
    #############################
    # wmllint: local spelling Afalas
    [side]
        side=2
        color=blue
        controller=ai
        type=Outlaw
        id=Afalas
        name= _ "Urza Afalas"
        profile=portraits/urza-afalas-masked.webp
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
        facing=se
        team_name=bandits
        user_team_name=_"Urza Afalas"
        gold,income=30,7 # fixed income, so he looks competent as an ally on all difficulties. If we fight him, his income gets manually changed
        recruit=Poacher
        {FLAG_VARIANT6 ragged}
        hidden=yes
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Thug" {ON_DIFFICULTY 2 3 4}}
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {STARTING_VILLAGES 2 5}
    [event]
        name=side 2 turn # this defensive AI gets overwritten if we ally with Afalas
        first_time_only=no
        {RESET_SIDE_AI 2 defensive 0.4 0.25}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y,radius=27,10,1})} # a couple "staging areas" to prevent afalas from idling his units on his keep
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 3 x,y,radius=20,10,1})}
        {MODIFY_SIDE_AI 2 (
            [avoid] # play defensive. This also prevents Afalas from killing the cutscene zombie before the cutscene triggers
                x=0-17,    18,   19,   20,   21,   22,   23,   24,   25,   26,   27,   28,   29,  29,  30
                y=0-99, 12-99,13-99,12-99,13-99,12-99,13-99,12-99,11-99,11-99,11-99,11-99,10-99, 0-6,0-99
                {OR terrain=W*^*}
            [/avoid]
        )}
    [/event]

    #############################
    # UNDEAD
    #############################
#define UNDEAD_SIDE SIDE ID NAME
    [side]
        side={SIDE}
        color=black
        controller=ai
        hidden=yes
        type=Ghoul
        id={ID}
        name={NAME}
        team_name=undead
        user_team_name=_"Undead"
        gold={ON_DIFFICULTY 8 16 32}
        income={ON_DIFFICULTY 0 3 9} # assuming 1 village on average
        recruit=Walking Corpse
        {FLAG_VARIANT undead}
    [/side]
    {STARTING_VILLAGES {SIDE} 5}
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    {UNDEAD_SIDE 3 Gruth _"Gruth"}
    {UNDEAD_SIDE 4 Gerd  _"Gerd" }
    {UNDEAD_SIDE 5 Gral  _"Gral" }
    {UNDEAD_SIDE 6 Grish _"Grish"}
    {RECRUIT_UNIT_VARIATIONS 2 "Walking Corpse" swimmer}
    {UNDEAD_SIDE 7 Gart  _"Gart" }
    {UNDEAD_SIDE 8 Gruu  _"Gruu" }
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3,4,5,6,7,8 offensive 0.99 0.01}
        {VARY_AI_BY_SCHEDULE_ENEMY 3,4,5,6,7,8 1,2}
        {MODIFY_SIDE_AI 3,4,5,6,7,8 retreat_factor=0}
        {MODIFY_SIDE_AI 3,4,5,6,7,8 ({GOAL_SEEK_SIDE 99 1 0})}
    [/event]

    [side]
        side,controller,color=9,null,blue
        hidden,no_leader=yes,yes
        team_name=undead,bandits
    [/side]

    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
#define SOUTH_GUARD_LOCS
    x=17-22,   23, 24-25
    y= 5-12, 6-18,  6-12
    {NOT terrain=Wo*^*}
#enddef
#define NORTH_GUARD_LOCS
    x=21-25,   26, 27-30
    y= 6-11, 6-11,  7-10
    {NOT terrain=Wo*^*}
#enddef
    [event]
        name=prestart

        #############################
        # BANDIT GUARDS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    Poacher Poacher}) 18 11  ({ZONE_GUARDIAN 18 11 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Thug    Thug    Thug   }) 23 12  ({ZONE_GUARDIAN 23 12 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    none    Poacher}) 25 10  ({ZONE_GUARDIAN 25 10 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Poacher Poacher Poacher}) 29  8  ({ZONE_GUARDIAN 29  8 {NORTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    none    Thug   }) 25  7  ({ZONE_GUARDIAN 26  7 {NORTH_GUARD_LOCS}})}
#ifdef EASY
        {MODIFY_TERRAIN "Gd^Qhh"   18 11} #endif
#ifndef HARD
        {MODIFY_TERRAIN "Gll^Qhhf" 25  7} #endif
        #############################
        # UNDEAD GUARDS
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY none             "Walking Corpse" "Walking Corpse"})   9 16  ({ZONE_GUARDIAN  9 16 x,y,radius=9,19,4})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY none             none             "Walking Corpse"})  13 18  ({ZONE_GUARDIAN 13 18 x,y,radius=9,19,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY "Walking Corpse" "Walking Corpse" "Walking Corpse"})   6 23  ({ZONE_GUARDIAN  6 23 x,y,radius=4,25,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none             "Walking Corpse" "Walking Corpse"})   3 25  ({ZONE_GUARDIAN  3 25 x,y,radius=4,25,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none             none             "Walking Corpse"})   3 24  ({ZONE_GUARDIAN  3 24 x,y,radius=4,25,4})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY "Walking Corpse" "Walking Corpse" "Walking Corpse"})  20 24  ({ZONE_GUARDIAN 20 24 x,y,radius=22,25,3})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY none             "Walking Corpse" "Walking Corpse"})  36 14  ({ZONE_GUARDIAN 36 14 x,y,radius=39,14,4})}
        {GENERIC_UNITC 7 ({ON_DIFFICULTY none             none             "Walking Corpse"})  33 12  ({ZONE_GUARDIAN 33 12 x,y,radius=33,12,1})}
        # have some underground ToD so it's not too weird,
        # but put it out of the fighting area so the player won't be affected
        [time_area]
            x,y=28-99,23-99
            {UNDERGROUND}
        [/time_area]

        [remove_shroud]
            side,x,y,radius=1,4,4,6
        [/remove_shroud]
        {SCROLL_TO 3 1}
    [/event]

    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # DISCUSSING THE SITUATION
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 4 4}
        {MODIFY_UNIT id=Deoran facing se}
        [redraw]
            side=1
        [/redraw]
        {DELAY 500}
        {RECALL_XY Ethiliel 5 3}
        {MODIFY_UNIT id=Ethiliel facing se}
        [redraw]
            side=1
        [/redraw]
        {DELAY 500}
        {RECALL_XY $companion_id 3 5}
        {MODIFY_UNIT id=$companion_id facing se}
        [redraw]
            side=1
        [/redraw]

        [message]
            speaker=Deoran
            message= _ "It’s so cold here! And this fog is so thick. This is quite a change from fighting bandits in the farmlands near Westin!"
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"This cannot be natural. Dark magic? Black Forest, this place is called? I see where it gets its name..."
        MESSAGE_GERRICK=_"Mus’ be black magic, sir. I’ve fought on many a dark and foggy night, but never seen anythin’ like this."
        MESSAGE_HYLAS=_"Dark magic — an apt name, in this case. It would take a foul and powerful spell to shadow such an expanse."
        }
        [message]
            speaker=Ethiliel
            message= _ "Indeed. Before us lies the Black River — and so too must Mebrin, great sage of the elves. He is here! I feel wisps of his magic reaching out to me from nearby..."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Listen well, humans, for the great sage Mebrin is ancient, and has no love for your kind. He personally bore witness to Lich-Lord Jevyan and his terrible invasion, in days back when the land was still young. Should anyone truly understand the undead and how the Urzas learned to summon them, it will be Mebrin."
        [/message]
        [message]
            speaker=Deoran
            message= _ "With the three elder Urza brothers defeated, only the youngest remains to oppose us. Mebrin must be his captive, and these woods must be filled with bandits and undead.

Dangerous though the task may be, I promise to help rescue your sage, Ethiliel."
        [/message]
        {DELAY 500}
        #############################
        # NEW RECRUITS
        #############################
#define NEW_RECRUIT COMPANION TYPE IMAGE MESSAGE
    [if] {HAVE_UNIT id={COMPANION}}
        [then]
            [object]
                {FILTER id=Deoran}
                image="misc/blank-hex.png~SCALE(72,72)~BLIT(units/{IMAGE}~RC(magenta>red),0,0)"
                name=_"New Recruit:"
                description={MESSAGE}
            [/object]
            [allow_extra_recruit]
                id,extra_recruit=Deoran,{TYPE}
            [/allow_extra_recruit]
        [/then]
    [/if]
#enddef
        {NEW_RECRUIT "Mari"           "Fencer"            human-loyalists/fencer.png            (_"You can now recruit Fencers!")}
        {NEW_RECRUIT "Sir Gerrick"    "Heavy Infantryman" human-loyalists/heavy-infantryman.png (_"You can now recruit Heavy Infantrymen!")}
        {NEW_RECRUIT "Minister Hylas" "Mage"              human-magi/mage.png                   (_"You can now recruit Mages!")}
        {SAY_COMPANION
        MESSAGE_MARI=_"Rookie, you’re in luck. Despite looking like sacks of flour, some of our soldiers are surprisingly nimble. I’ve been training them during our march south."
        MESSAGE_GERRICK=_"Deoran, we’ve got some brawny lads among us. They’re good men, willing to learn, an’ on the march I’ve been training ’em to fight in heavy armor."
        MESSAGE_HYLAS=_"Fortunate news, Deoran: several amongst our company once trained at the Mages’ Academy on Alduin. Though they dropped out before completion, our journey southwards has given me an opportunity to remediate their education."
        }
        {SAY_COMPANION
        MESSAGE_MARI=_"Like me, Fencers have the <b><i>skirmisher</i></b> ability. They’re fragile but fast, and make for good scouts. They also deal <b><i>blade damage</i></b>, unlike our other recruits’ pierce damage."
        MESSAGE_GERRICK=_"Like me, Heavy Infantrymen are slow and tough. They ain’t so good at movin’ through forests, but their <b><i>impact damage</i></b> will be great for beatin’ down any Ghouls or Skeletons we run into."
        MESSAGE_HYLAS=_"Though frail and expensive, Mages’ ranged attack deals <b><i>fire damage</i></b> — highly effective against both Ghouls and Skeletons, should we encounter any."
        }
        [display_tip]
            title=_"Resistances and Damage Types"
            image=tutor/resistances.png
            message=_"Different units have resistances
to different damage types.
To see a unit’s resistances,
<b><i>right-click on it and select
“Unit Description.”</i></b>

Most undead are resistant to
pierce damage, but vulnerable
to fire, impact, and arcane."
        [/display_tip]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find the final Urza brother"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        {VARIABLE s04_phase intro}
    [/event]

    #############################
    # BANDIT ATTACKS UNDEAD
    #############################
    [event]
        name=turn 2
        {GENERIC_UNIT 9 Thug 16 13}             {ROLE cutscene_thug  } {ZONE_GUARDIAN 16 13 x,y,radius=16,13,99}
        {GENERIC_UNIT 9 "Walking Corpse" 16 14} {ROLE cutscene_corpse} {ZONE_GUARDIAN 16 14 x,y,radius=16,14,99}
        {TEAM_COLOR_OVERRIDE role=cutscene_thug   blue}
        {TEAM_COLOR_OVERRIDE role=cutscene_corpse black}
    [/event]
    [event]
        name=sighted
        {FILTER role=cutscene_thug} {FILTER_SECOND side=1}
        {MODIFY_UNIT role=cutscene_thug   side 2}
        {MODIFY_UNIT role=cutscene_corpse side 3}
        [event]
            name=side 2 turn refresh
            {MODIFY_UNIT role=cutscene_thug moves 0}
        [/event]
        [event]
            name=attack end
            {FILTER role=cutscene_thug} {FILTER_SECOND role=cutscene_corpse}
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals intro} )}
            {SAY_COMPANION # guaranteed to be a "him", since Afalas only recruits Thugs and Poachers
            MESSAGE_MARI=_"This bandit fights against the undead instead of alongside them? That’s new."
            MESSAGE_GERRICK=_"Good lad, that bandit. I wonder what turned him ’gainst the dead?"
            MESSAGE_HYLAS=_"That outlaw struck at one of his own undead allies. How unexpected."
            }
            [message]
                speaker=Deoran
                message= _ "We should find their leader, the final Urza brother. That will surely shed some light on the situation."
            [/message]
        [/event]
    [/event]
    [event] # if we spot Afalas before the cutscene guys, switch the cutscene guys' side
        name=choice
        {MODIFY_UNIT role=cutscene_thug   side 2}
        {MODIFY_UNIT role=cutscene_corpse side 3}
    [/event]

    #############################
    # AFALAS DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Afalas}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals intro} )}
        [message]
            speaker=Afalas
            message= _ "These undead are too much! I am slain..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "We came here to fight the bandits, but for them to have perished on their own? Something feels very wrong here..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #############################
    # URZA SPOTTED
    #############################
    [event]
        name=sighted
        {FILTER id=Afalas} {FILTER_SECOND side=1}
        {FIRE_EVENT choice}
    [/event]
    [event]
        name=moveto # don't let the player cheese Afalas by disabling fog/shroud updates (and also make him show up earlier if you're using slow units)
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=23,10,5}  )}
        {FIRE_EVENT choice}
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=37,12,15} )} # if we're getting close to Mebrin's cave, make Afalas spot you before you can
        {FIRE_EVENT choice}
    [/event]
    [event]
        name=choice
        [modify_side]
            side=2,3,4,5,6,7,8
            hidden=no
        [/modify_side]
        [cancel_action]
        [/cancel_action]
        [remove_shroud]
            side,x,y,radius=1,23,10,2
        [/remove_shroud]
        [lift_fog]
            x,y,radius=23,10,2
        [/lift_fog]

        [message]
            speaker=Afalas
            message= _ "I see torches movin’ in the fog... Thank th’ light, it’s living men!"
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"What, do women not count as “living”? You Urzas have caused enough havoc with your undead raising, and I for one am fed up with it. Prepare to join your brothers, boy."
        MESSAGE_GERRICK=_"Ye need not thank anyone for our presence, wretch. You and yer brothers’ve killed too many good men, and defiled too many peaceful corpses. You’ll pay for what ye’ve done to our home."
        MESSAGE_HYLAS=_"Dare not invoke the light in my presence, wielder of evil. You and your brothers have spread darkness and filth across this land. We are here to excise your corruption."
        }
        [message]
            speaker=Afalas
            message= _ "Please, please, jus’ hear me out. I knows my men and I’ve done evil, and I knows that you seek to destroy us out o’ revenge. Ah’m sorry my brothers attacked you. It was never my intention to cause everyone so much sufferin’."
        [/message]
        #        [message]
        #            speaker=Deoran
        #            message= _ "If you’re truly sorry, then cease your fighting and tell us what you know of the undead. How did you gain your dark powers? Make one wrong move and we will not hesitate to attack!"
        #        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "It was “never your intention”!? You loathsome vermin locked me in a cage! You dragged Mebrin off in chains; my kind, gentle teacher! Deoran, why are we stooping so low as to even speak with this pig?"
        [/message]
        [message]
            speaker=Afalas
            message= _ "I swear I ain’t your enemy! I’ll gladly tell ye what I know. I admit that near a year ago, me brothers and I ventured into the valley of the elves in secret, to plunder and steal. Many we killed, but one we captured; a powerful and magical sage. Away from his people, he offered to teach us the secrets o’ summonin’ the dead."
        [/message]
        [message]
            speaker=Afalas
            message= _ "I saw the folly in doin’ such a thing, but m’ brothers were weak an’ foolish, and soon fell under the sway of the corrupting magic — becomin’ thralls of the very elf they’d sought to enslave. They called ’im “master”, and went from here to do ’is bidding."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "A complete and utter lie from complete and utter scum. I studied magic under Mebrin for many decades and know him well — my teacher would never lead undead, he would destroy them!"
        [/message]
        [message]
            speaker=Afalas
            message= _ "It’s true that Mebrin was more powerful than any o’ the corpses we raised, yet he didn’ resist ’em. They took ’im into the caves, and soon after skeletal horrors started to emerge."
        [/message]
        [message]
            speaker=Afalas
            message= _ "Now my boys and I have returned to try an’ put a stop to it, but there’s jus’ too many. Unless ye helps me now, Mebrin’s undead may soon be strong enough to besiege Westin itself!"
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"<i>(to Deoran) Elves aren’t so incorruptible and pure as they like to believe, but I trust Afalas about as far as I can throw him — and I’ve only got one arm. Shame neither Gerrick nor Hylas is here to weigh in...</i>"
        MESSAGE_GERRICK=_"<i>(to Deoran) I’ve dealt with plenty o’ outlaws before, an’ my gut says this Afalas ain’t no different. He ain’t outright lyin’, but he ain’t tellin’ us everythin’ neither.</i>"
        MESSAGE_HYLAS=_"<i>(to Deoran) Sages and mystics of great skill and age are often the first to succumb to the taint of black magic. Knowledge and power are not enough to master undeath — the only way to conquer it is to resist the temptation altogether.</i>"
        }
        [message]
            speaker=Afalas
            message= _ "I knows I’m a criminal. My men and I have committed wrongdoin’s in the past, but at least in the fight against the undead, we can be your friends! They’re as much our enemies as they’re yours!

If ye spare my life and the lifes of m’ followers, I promise we’ll fight loyally by your side forevermore. Cross me heart and hope to die, I do."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Deoran, you would trust the word of a thief and murderer over me, your friend and ally? This criminal will abandon you the moment he finds a chance!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Think of the destruction this man and his brothers wrought on your people. Think of the horrors they inflicted upon me, caged and left to suffer amidst the stinking corpses of my friends!

Believe the truths you have seen, not the lies you have heard. No fake niceties can reverse the deaths that have already happened; no atonement taken now can set right the transgressions that have already come to pass!"
        [/message]
        [lua]
            code = << wesnoth.interface.skip_messages(false) >>
        [/lua]
        [message]
            speaker=Deoran
            message= _ "Peace, let me think! <i>If I listen to Ethiliel I must fight the bandits, but if I ally with the bandits Ethiliel will surely abandon us...</i>"
            [option]
                label= _ "Side with Ethiliel"
                [command]
                    {FIRE_EVENT elf_alliance}
                [/command]
            [/option]
            [option]
                label= _ "Side with Afalas"
                [command]
                    {FIRE_EVENT bandit_alliance}
                [/command]
            [/option]
        [/message]
        [modify_turns]
            value={TURN_LIMIT}
        [/modify_turns]
    [/event]

    #######################################################################################################################################################
    #                                                                     ELF ALLIANCE
    #######################################################################################################################################################
    [event]
        name=elf_alliance
        {VARIABLE s04_phase elf_alliance}
        [message]
            speaker=Deoran
            message= _ "Your crimes are too great, Urza Afalas, and your word cannot be trusted. You will fall alongside the undead you helped create!"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "You will pay for taking Mebrin from us! Once I rescue him from your clutches, I never again intend to leave his side."
        [/message]
        [message]
            speaker=Afalas
            message= _ "Then this parley is over! You may have caused the doom of all of us!"
        [/message]
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]

        #############################
        # PREPARE AI
        #############################
        [modify_side]
            side=2
            gold={ON_DIFFICULTY 30 60 120}
            income={ON_DIFFICULTY 1 4 10}
        [/modify_side]
        [modify_side]
            side=3,4,5,6,7,8
            gold={ON_DIFFICULTY 15 30 60}
        [/modify_side]

        {GENERIC_UNITC 8 (Walking Corpse)  30 20  ({ZONE_GUARDIAN 30 20 x,y,radius=33,21,4})}
        {GENERIC_UNITC 8 (Walking Corpse)  33 19  ({ZONE_GUARDIAN 33 19 x,y,radius=33,21,4})}
        {GENERIC_UNITC 8 (Walking Corpse)  36 21  ({ZONE_GUARDIAN 36 21 x,y,radius=36,21,2})}
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Urza Afalas"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #############################
    # ENTER CAVE
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=33,19,4} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        [message]
            speaker=Deoran
            message= _ "This must be the cave the bandit spoke about, but there is no sign of Mebrin. Perhaps Afalas really was lying."
        [/message]
    [/event]

    #############################
    # GHOUL DIES
    #############################
    [event]
        name=die
        {FILTER side,canrecruit=8,yes}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        [message]
            speaker=Deoran
            message= _ "The ghoul guarding the cave is defeated! I agreed to help Ethiliel bring Urza Afalas to justice, but perhaps there would be merit in venturing further inside..."
            [option]
                label= _ "Continue fighting Urza Afalas"
                [command]
                    [return]
                    [/return]
                [/command]
            [/option]
            [option]
                label= _ "Enter the cave"
                [command]
                [/command]
            [/option]
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Deoran, what are you doing? You would abandon our fight and let this criminal walk free!?"
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "Author’s note — this is a “secret” path, and somewhat more challenging than the regular options. Are you sure you want to proceed?"
            [option]
                label= _ "Continue fighting Urza Afalas"
                [command]
                    [return]
                    [/return]
                [/command]
            [/option]
            [option]
                label= _ "Enter the cave"
                [command]
                [/command]
            [/option]
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’m sorry, Ethiliel, but fighting these bandits doesn’t feel right. My soldiers and I are going to descend down into this cave, to find out the truth for ourselves."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "And how shall I defeat Urza Afalas without your help? He will surely escape, free from justice for his foul deeds! Was this your plan all along, to string me along with false promises?"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Humans! All you humans are the same! I should never have expected your kind to help me find Mebrin. Deoran, even your vile conspiracies shall not keep the elves from our greatest sage. Soon all of you humans shall learn that the Aethenwood protects its own!"
        [/message]
        {MOVE_UNIT id=Ethiliel 3 1}
        [store_unit]
            {FILTER id=Ethiliel}
            variable,kill=stored_ethiliel,yes
        [/store_unit]
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "Well, that could have gone better... I only hope that we will find the truth of the matter down in these caves."
        [/message]

        {CLEAR_VARIABLE s04_phase}
        [endlevel]
            result=victory
            bonus=yes
            next_scenario=05c_Into_the_Depths
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # AFALAS DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Afalas}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        [message]
            speaker=Afalas
            message= _ "You... have doomed us all..."
        [/message]
    [/event]
    [event]
        name=die
        {FILTER id=Afalas}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        {KILL side=2}
        [message]
            speaker=Ethiliel
            message= _ "Justice. Thank you for your aid, Deoran. I know it was hard for you to turn against your own kind — you have earned my respect."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’ve searched all the tents, but cannot find Mebrin anywhere in the bandit camp. Ethiliel, do you still sense his magic nearby?"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Yes I do, and without that distracting criminal on my mind I can feel Mebrin clearer than ever. I sense joy. I sense power... I sense..."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "..."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "...Humans, we should leave."
        [/message]
        [message]
            speaker=Deoran
            message= _ "What? But what about rescuing—"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "We need to leave, now!!"
        [/message]

        {CLEAR_VARIABLE s04_phase}
        [endlevel]
            result=victory
            bonus=yes
            next_scenario=05b_Pebbles_in_the_Flood
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #######################################################################################################################################################
    #                                                                     BANDIT ALLIANCE
    #######################################################################################################################################################
    [event]
        name=bandit_alliance
        {VARIABLE s04_phase bandit_alliance}
        [message]
            speaker=Deoran
            message= _ "I am sorry Ethiliel, but Afalas’s words ring true. If Mebrin has truly fallen to undeath, then mankind must unite against him."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "You would free me from one Urza, only to betray me to another? All you humans are the same! You are no better than these outlaws, the very pigs who defiled your dead and sacked your farms."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Deoran, even your conspiring with criminals shall not keep from us our greatest sage. Soon all of you vile humans shall learn that the Aethenwood protects its own!"
        [/message]
        {MOVE_UNIT id=Ethiliel 3 1}
        [store_unit]
            {FILTER id=Ethiliel}
            variable,kill=stored_ethiliel,yes
        [/store_unit]
        {DELAY 500}
        [modify_unit]
            {FILTER id=Afalas}
            profile=portraits/urza-afalas.webp
        [/modify_unit]
        [message]
            speaker=Afalas
            message= _ "That must’ve been a tough decision. Thank ye."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Don’t make me regret it. Guide us to Mebrin, and we will verify your story ourselves."
        [/message]

        #############################
        # AFALAS JOINS YOU
        #############################
        [modify_side]
            side,team_name=2,good
        [/modify_side]
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [remove_shroud]
            side,x,y,radius=1,34,21,4
        [/remove_shroud]
        [remove_shroud]
            side,x,y,radius=1,30,19,2
        [/remove_shroud]
        {SCROLL_TO 34 21}
        {DELAY 500}
        [message]
            speaker,scroll=Afalas,no
            message= _ "The old elf’s cave is southeast of m’ camp. My outlaws’ll fight his shamblin’ hordes, but I leave it up to you soldiers to push into Mebrin’s cave and strike the finishin’ blow."
        [/message]

        #############################
        # PREPARE AI
        #############################
        [event]
            name=side 2 turn
            first_time_only=no
            {RESET_SIDE_AI 2 offensive 0.4 0.25}
            {VARY_AI_BY_SCHEDULE_ENEMY 2 3,4,5,6} # retreat at day, so we better match up with the player
            {MODIFY_SIDE_AI 2 ({GOAL_SEEK_SIDE 7 5,7 0})}
            {MODIFY_SIDE_AI 2 (
                [avoid]
                    x,y,radius=32,20,7 # let Afalas attack the zombies, but don't let him enter Mebrin's cave
                [/avoid]
            )}
        [/event]

        {KILL side,canrecruit=8,yes}
        [unit]
            side=8
            x,y,facing=34,21,nw
            {SINGLEUNITWML_MEBRIN}
        [/unit]
        {SILENTLY_LIMIT_LEADER_MOVES 8 0}
        [modify_side]
            side=8
            recruit= # mebrin doesn't recruit until he's sighted, but he will continue to amass gold
        [/modify_side]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Mebrin"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #############################
    # AFALAS FLEES
    #############################
    [event]
        name=attacker hits
        [filter_second]
            id,formula=Afalas,(self.hitpoints < self.max_hitpoints/2)
        [/filter_second]
        {FIRE_EVENT afalas_flees}
    [/event]
    [event]
        name=defender hits
        [filter]
            id,formula=Afalas,(self.hitpoints < self.max_hitpoints/2)
        [/filter]
        {FIRE_EVENT afalas_flees}
    [/event]
    [event]
        name=afalas_flees
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        [message]
            speaker=Afalas
            message = _ "Ack! Well, thanks for yer help with th’ dead — now it’s time for me men an’ I to make our great escape."
        [/message]
        [message]
            speaker=Deoran
            message = _ "You’re leaving? What happened to fighting loyally by my side forevermore? We still need your aid!"
        [/message]
        [message]
            speaker=Afalas
            message = _ "Did I ever say somethin’ like that? Don’ ring a bell."
        [/message]
        {MOVE_UNIT id=Afalas 3 1}
        [store_unit]
            {FILTER id=Afalas}
            variable,kill=stored_afalas,yes
        [/store_unit]
        {KILL side=2}
        [message]
            speaker=Deoran
            message = _ "I suppose that’s what I get for trusting an outlaw... We’ll have to defeat Mebrin and his undead on our own."
        [/message]
        {VARIABLE afalas_fled yes}
    [/event]

    #############################
    # MEBRIN SIGHTED
    #############################
    [event]
        name=sighted
        {FILTER id=Mebrin}
        {FIRE_EVENT trigger_mebrin}
    [/event]
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=32,21,3} )}
        {FIRE_EVENT trigger_mebrin}
    [/event]
    [event]
        name=trigger_mebrin
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        [message]
            speaker=Mebrin
            message = _ "Who comes... My old tormentors?"
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"Gods... that skull, those eyes. I had almost hoped the lady was right, but now... even in the Estmarks I never thought I’d live to lay eyes on a lich."
        MESSAGE_GERRICK=_"Dear Haldric! I had almost hoped the lady was right, but now... Whatever that elf used to be in life, in death it’s become something far, far worse."
        MESSAGE_HYLAS=_"Light protect us. I had almost hoped the lady was right, but now... Here lies the source of the spreading corruption: a lich most foul."
        }
        [message]
            speaker=Deoran
            message = _ "I am Deoran, soldier of the South Guard! We have come to put an end to your villainy, Mebrin of the elves — if that is who you are."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "Mebrin? No, I am called Mal M’Brin now, mortals. It is the name I took when I unchained myself from the shallow-mindedness of my kind and passed over into enlightenment."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "There is infinity at the brink of death... I have touched the void at the heart of all things, and I have begun to probe the mystic arts far beyond what any living elf knows."
        [/message]
        [if] {HAVE_UNIT id=Afalas}
            #--------------------
            # AFALAS CONFRONTS MEBRIN
            #--------------------
            [then]
                [message]
                    speaker=Afalas
                    message = _ "You’ve gone even more mad than before! I wish to Haldric my brothers and I had never laid eyes upon you."
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "Mad? I am furious!! You accursed mudlings took me and tormented me, tortured me for sport! I did not know day from night... the light and the shadows, heat and cold all bled together amidst my pain..."
                [/message]
                [message]
                    speaker=Afalas
                    message = _ "He’s lyin’, Deoran! Me an’ my brothers questioned him, maybe roughed him up a little, but we ne’er did nothin’ worse!"
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "You thought me weak; powerless under your lash. But I have had my revenge — I taught the summoning of powers beyond the control of your feeble kin, powers that fed upon your race’s filth and greed. I knew that once the first strand of black magic left my hands, there would be no turning back. But I would suffer this humiliation no longer..."
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "Content with only meagre tricks, you mayflies never even noticed as I slowly brought you under my thrall! The Urza brothers sought to enslave me, but it is they who became my slaves in the end."
                [/message]
            [/then]
            #--------------------
            # AFALAS HAS FLED
            #--------------------
            # Afalas is unlikely to be gone here, but dialogue should at least still make sense
            [else]
                [message]
                    speaker,image=Deoran,portraits/deoran-mad.webp
                    message = _ "Urza Afalas was right! Whatever you were like in life, in death you’ve gone mad with power!"
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "Mad? I am furious!! You accursed mudlings took me and tormented me, tortured me for sport! I knew that once the first strand of black magic left my hands, there would be no turning back. But I would suffer this humiliation no longer..."
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "I taught the summoning of powers beyond the control of your feeble kin, powers that fed upon your race’s filth and greed. Content with only meagre tricks, you mayflies never even noticed as I slowly brought you under my thrall! The Urza brothers sought to enslave me, but it is they who became my slaves in the end."
                [/message]
            [/else]
        [/if]

        #--------------------
        # ACTIVATE MEBRIN
        #--------------------
#define MEBRIN_RECRUIT_ANIM
    [animate_unit]
        {FILTER id=Mebrin}
        flag=recruiting
    [/animate_unit]
#enddef

        {MEBRIN_RECRUIT_ANIM} {GENERIC_UNITC 6 ({ON_DIFFICULTY "Skeleton Archer" "Skeleton Archer" "Skeleton Archer"})  30 20  ({ANIMATE}{ZONE_GUARDIAN 30 20 x,y,radius=33,21,4})}
        {MEBRIN_RECRUIT_ANIM} {GENERIC_UNITC 6 ({ON_DIFFICULTY "Skeleton"        "Skeleton"        "Skeleton"       })  33 19  ({ANIMATE}{ZONE_GUARDIAN 30 20 x,y,radius=33,21,4})}
#ifndef EASY
        {MEBRIN_RECRUIT_ANIM} {GENERIC_UNITC 6 ({ON_DIFFICULTY "none"            "Skeleton Archer" "Skeleton Archer"})  35 21  ({ANIMATE})}
        {MEBRIN_RECRUIT_ANIM} {GENERIC_UNITC 6 ({ON_DIFFICULTY "none"            "Skeleton"        "Skeleton"       })  36 21  ({ANIMATE}{ZONE_GUARDIAN 30 18 x,y,radius=36,22,3})}
#endif
#ifdef HARD
        {GENERIC_UNITC 6 ({ON_DIFFICULTY "none"            "none"            "Bone Shooter"   })  35 20  ({ANIMATE})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY "none"            "none"            "Skeleton"       })  35 22  ({ANIMATE})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY "none"            "none"            "Skeleton Archer"})  33 22  ({ANIMATE}{ZONE_GUARDIAN 33 17 x,y,radius=36,22,3})}
#endif
        [modify_side]
            side=8
            recruit=Skeleton Archer
        [/modify_side]
        {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Skeleton" {ON_DIFFICULTY 0 1 2}}
        [message]
            speaker=Mebrin
            message = _ "Rise, my minions, and let all vermin tremble! The race of man shall be stricken off the face of the green world. Your corpses will serve me! Your bones will dance for my pleasure! I’ll make humanity into the mindless slaves that you all deserve to be!"
        [/message]
        {SAY_COMPANION SPEAKER=Deoran
        MESSAGE_MARI=_"After all Ethiliel’s kind words about you, I had yet a glimmer of hope that you might still be reasoned with. But it is now clear that words are of no further use. Captain Mari, are you with me?"
        MESSAGE_GERRICK=_"After all Ethiliel’s kind words about you, I had yet a glimmer of hope that you might still be reasoned with. But it is now clear that words are of no further use. Sir Gerrick, are you with me?"
        MESSAGE_HYLAS=_"After all Ethiliel’s kind words about you, I had yet a glimmer of hope that you might still be reasoned with. But it is now clear that words are of no further use. Minister Hylas, are you with me?"
        }
        {SAY_COMPANION
        MESSAGE_MARI=_"The rookie’s all grown up. I’m with you."
        MESSAGE_GERRICK=_"On your order, Master Deoran."
        MESSAGE_HYLAS=_"Evil never rests — nor does the light that seeks to exterminate it."
        }
        [message]
            speaker=Afalas
            message = _ "I done enough evil in my life. Time t’ do somethin’ good fer a change."
        [/message]
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message = _ "Attack!"
        [/message]
    [/event]

    #############################
    # ENTERING MEBRIN'S CAVE AT NIGHT
    #############################
    [event]
        name=new turn
        first_time_only=no
        [store_time_of_day]
        [/store_time_of_day]
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=32,18,2} )}
        {FILTER_CONDITION(
            {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
            {AND(
                {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
                {OR( {VARIABLE_CONDITIONAL time_of_day.id equals second_watch} )}
            )}
            {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance}
        )}
        [message]
            speaker=Mebrin
            message = _ "Yes, yes, step into the mouth of my cave. Fight me in the dead of night, when I am at my best!"
        [/message]
    [/event]

    #############################
    # ATTACKING MEBRIN
    #############################
    [event]
        name=attack end
        {FILTER_SECOND id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        [event]
            name=side 8 turn
            [message]
                speaker=Mebrin
                message = _ "You dare strike me?! Puny humans, I’m darkness incarnate! I’m power beyond your comprehension!"
            [/message]
            {SAY_COMPANION
            MESSAGE_MARI=_"Oh, I understand just fine: you’re nothing but a pile of dead bones glued together into a crude imitation of life. I’ve smashed plenty of skeletons before you, and I’ll smash plenty after."
            MESSAGE_GERRICK=_"Aye, beyond my comprehension you may be, but I don’ need to understand you to destroy you. I know you’re evil, an’ that’s enough. Prepare to meet your maker, lich."
            MESSAGE_HYLAS=_"You’re merely a servant of the power that corrupted you, lich! You’ve not mastered the darkness; it, instead, has enslaved you. We will put you out of your misery."
            }
            [message]
                speaker=Mebrin
                message = _ "<b><i>You</i></b> think you can destroy <b><i>me</i></b>? Were Ethiliel here I might have held back, but you humans are nothing but a worthless blight upon this wretched world. Suffer and die."
            [/message]
        [/event]
    [/event]

    #############################
    # MEBRIN DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        {SAY_COMPANION
        MESSAGE_MARI=_"Time to un-die, un-dead. I’m fed up with this."
        MESSAGE_GERRICK=_"Ah’ve watched enough friends fall to yer creatures, lich. They didn’t die in vain."
        MESSAGE_HYLAS=_"As the scalpel cuts away a tumor, so shall I cut your corruption out of this world. Your blight is ended, Mebrin of the elves."
        }
        [message]
            speaker=Mebrin
            message = _ "Ah ha, ha ha ha ha. You think I am beaten so easily, beaten by mere mortals? I should flee down into my caves, should summon my great armies up from below..."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "But why bother? I am no stranger to pain, Deoran of the humans. At least peace may finally come... for me. But not for you..."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "You have only sown the seeds of your own destruction, for Ethiliel will avenge me. I felt her emotions, felt her intentions, <b><i>fed</i></b> her intentions... Accursed humans, you may have struck me down, but I have already won my revenge..."
        [/message]
        #For all his talk, he was just another two-bit villain. It’s a good thing we stopped him here, before his armies had a chance to get out of control.
    [/event]
    [event]
        name=die
        {FILTER id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        {CLEAR_VARIABLE s04_phase}
        {FULL_HEAL id=Afalas}
        [store_unit]
            {FILTER id=Afalas}
            variable=stored_afalas
        [/store_unit]
        [endlevel]
            result=victory
            bonus=yes
            next_scenario=05a_The_Long_March
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #############################
    # ACHIEVEMENT
    #############################
    [event]
        name=victory
        [if] {NOT({HAVE_UNIT({FILTER_SIDE(
            [enemy_of]
                side=1
            [/enemy_of]
        )})})}
        [then]
            {ACHIEVE s04}
        [/then]
    [/if]
[/event]

#############################
# TIME LOW
#############################
[event]
    name=turn {TURN_WARNING}
    [if] {VARIABLE_CONDITIONAL s04_phase equals elf_alliance}
        [then]
            [message]
                speaker=Ethiliel
                message= _ "Do not delay, Deoran! If we do not finish off this vermin Afalas soon, he shall surely make his escape!"
            [/message]
        [/then]
    [/if]
    [if] {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance}
        [then]
            [message]
                speaker=Afalas
                message= _ "Better hurry, Deoran. Whatever Mebrin’s plans are, he gets closer to finishin’ them every day. We’ve got to finish him off soon!"
            [/message]
        [/then]
    [/if]
    [message]
        speaker,image=narrator,wesnoth-icon.png
        {TUTOR: _"You are running out of turns to complete this scenario! See your objectives by pressing Ctrl+J, and remember that the turn limit can be seen in the top-left-hand corner."}
    [/message]
[/event]
[event]
    name=time over
    [message]
        speaker=Deoran
        message= _ "We have moved so slowly! If the last Urza brother was ever here, he has surely fled by now, and we still have no answers..."
    [/message]
    [message]
        speaker,image=narrator,wesnoth-icon.png
        {TUTOR: _"You have run out of turns to complete the scenario, and have been defeated!"}
    [/message]
    [endlevel]
        result=defeat
    [/endlevel]
[/event]

#############################
# TIME OVER
#############################
[event]
    name=side 1 turn {TURN_LIMIT} end
    [if] {VARIABLE_CONDITIONAL s04_phase equals elf_alliance}
        [then]
            {REVEAL x,y,radius=21,7,2}
            {REVEAL x,y,radius=22,5,2}
            {GENERIC_UNIT 2 Boat 24 4}
            {SOUND ambient/ship.ogg}
            {MOVE_UNIT type=Boat 20 7}
            [message]
                type,caption,image=boat,_"Sailor",portaits/humans/ruffian.webp
                message= _ "Hey, boss, it’s me. Anyone still alive out here?"
            [/message]
            [message]
                speaker=Afalas
                message= _ "Finally, what took ye so long! C’mon, let’s get us all out o’ here afore that crazy elf lady kills any more o’ us!"
            [/message]
            {MOVE_UNIT id=Afalas 21 8}
            {KILL id=Afalas}
            {MOVE_UNIT type=Boat 35 1}
            {KILL side=2}
            [message]
                speaker=Deoran
                message= _ "Urza Afalas has fled up the river! If he ever held Mebrin prisoner, the gentle sage is now far beyond our reach..."
            [/message]
        [/then]
    [/if]

    [if] {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance}
        [then]
            {GENERIC_UNIT 6 "Vampire Bat" 30 13} {ROLE messenger}
            {REVEAL x,y,radius=32,19,4}
            {MOVE_UNIT role=messenger 33 19}
            [message]
                role=messenger
                message= _ "Neep, neep!"
            [/message]
            [message]
                speaker=Mebrin
                message= _ "Ah ha, ha ha ha ha. You have tarried too long, mayflies! My messenger brings news — your beloved town of Westin has been destroyed!"
            [/message]
            [message]
                speaker=Deoran
                message= _ "What? How is this possible! With the undead armies fighting us here, how could Westin have already fallen?"
            [/message]
        [/then]
    [/if]

    [message]
        speaker,image=narrator,wesnoth-icon.png
        {TUTOR: _"You have run out of turns to complete the scenario, and have been defeated!"}
    [/message]
    [endlevel]
        result=defeat
    [/endlevel]
[/event]
[/scenario]

#undef TURN_LIMIT
#undef TURN_WARNING
#undef UNDEAD_SIDE
#undef NORTH_GUARD_LOCS
#undef SOUTH_GUARD_LOCS
