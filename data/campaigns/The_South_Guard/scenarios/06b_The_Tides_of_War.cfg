#textdomain wesnoth-tsg

#define TURN_LIMIT
    15#enddef # Ethiliel arrives at dawn

    [scenario]
        id=06b_The_Tides_of_War
        map_file=06b_The_Tides_of_War.map
        name= _ "The Tides of War"
        next_scenario=06x_Epilogue
        victory_when_enemies_defeated=no
        {EXPERIENCE_MODIFIER_SCENARIO}
        {DEFAULT_SCHEDULE} # remember that the braziers' ToD is tied to this. There are also ToD dialogue events
        turns={TURN_LIMIT}
        {ADD_WEATHER_SNOW}
        {SCENARIO_MUSIC loyalists.ogg}
        {EXTRA_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}
        {TSG_BIGMAP {JOURNEY_06b_NEW} }
        #######################################################################################################################################################
        #                                                                   DEFINE SIDES
        #######################################################################################################################################################
        #############################
        # DEORAN
        #############################
        [side]
            side=1
            controller=human
            no_leader=yes
            team_name=good
            user_team_name=_"South Guard"
            gold=20
            recruit=Spearman,Bowman
            {CUSTOM_SG_FLAG}
            defeat_condition=never
            save_id=player_side
        [/side]

        #############################
        # ELVES
        #############################
        [side]
            side=2
            color=green
            controller=ai
            team_name,user_team_name=good,_"Aethenwood"
            no_leader,hidden=yes,yes
            recruit=Elvish Fighter # no archers. Archers are signature elf units, but pretty useless vs skeletons
            {FLAG_VARIANT wood-elvish}
        [/side]
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Shaman"    2} # 1 guardian
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Druid"     1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Sorceress" 2}
        [event]
            name=side 2 turn
            first_time_only=no
            {RESET_SIDE_AI 2 offensive 0.6 0.2}
            {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 99 x,y=24,29})}
            {MODIFY_SIDE_AI 2 retreat_factor=0.75}
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 2 main_loop grab_villages} # go straight for the undead; don't spread out and cap villages (unless we retreat to them for healing)
        [/event]

        #############################
        # UNDEAD
        #############################
#define UNDEAD_SIDE SIDE INITIAL_GOLD INITLAL_INCOME RECRUITS
    [side]
        side={SIDE}
        color=black
        controller=ai
        no_leader=yes
        team_name=undead
        user_team_name=_"Undead"
        gold,income={INITIAL_GOLD},{INITLAL_INCOME}
        recruit={RECRUITS}
        {FLAG_VARIANT undead}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
        {UNDEAD_SIDE 3 {ON_DIFFICULTY 0 0 80} {ON_DIFFICULTY  6 14 30} "Skeleton Archer"} # mebrin pays an enormous amount of upkeep for all his guards
        {UNDEAD_SIDE 4 {ON_DIFFICULTY 0 0 60} {ON_DIFFICULTY  0  2  6} "Walking Corpse" } # 0 villages
        {UNDEAD_SIDE 5 {ON_DIFFICULTY 0 0 60} {ON_DIFFICULTY  0  2  6} "Walking Corpse" } # 0 villages
        {UNDEAD_SIDE 6 {ON_DIFFICULTY 0 0  0} {ON_DIFFICULTY  0  2  6} "Walking Corpse" } # 0 villages
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Skeleton {ON_DIFFICULTY 1 2 3}} # 1 guard. Prefer archers over skeletons, to make HI less strong (and Fencers marginally better)
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul    {ON_DIFFICULTY 3 4 5}} # 3 guards.
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul    {ON_DIFFICULTY 2 3 4}} # 2 guards.
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul    {ON_DIFFICULTY 1 2 3}} # 1 guard.
        [event]
            name=side 3 turn
            first_time_only=no
            {RESET_SIDE_AI 3     offensive 0.6 0.2}
            {RESET_SIDE_AI 4,5,6 offensive 0.9 0.1}
            [if] {VARIABLE_CONDITIONAL turn_number greater_than 5}
                [then]
                    {VARY_AI_BY_SCHEDULE 3,4,5,6}
                [/then]
            [/if]
            {MODIFY_SIDE_AI 3,4,5,6 retreat_factor=0}
            [if] {HAVE_UNIT id=Ethiliel}
                [then]
                    {MODIFY_SIDE_AI 3,4 (
                        [goal] # not 5 because they're on the opposite side of the map
                            name=target_unit
                            [criteria]
                                race=elf
                            [/criteria]
                            value=10
                        [/goal]
                    )}
                [/then]
            [/if]

            #wmlindent: start ignoring
            {RETREAT_WHEN_WEAK 3 {ON_DIFFICULTY 0-5 0-8 0-10} ( # 3/5/5 guards
                {GOAL_LOCATION 77 x,y=23,26}
                {GOAL_LOCATION 77 x,y=22,27}
                {GOAL_LOCATION 77 x,y=20,25}
                {GOAL_LOCATION 55 x,y=20,26}
                {GOAL_LOCATION 55 x,y=21,26}
                {GOAL_LOCATION 33 x,y=25,26}
                {GOAL_LOCATION 33 x,y=23,25}
                {GOAL_LOCATION 11 x,y=23,28}
                {GOAL_LOCATION 11 x,y=24,27}
                {GOAL_LOCATION 11 x,y=26,28}
                {GOAL_LOCATION 11 x,y=27,28}
                {GOAL_LOCATION 11 x,y=26,27}
            )}
            #wmlindent: stop ignoring
        [/event]

        # Statue
        [side]
            side,controller,color=7,null,wesred
            team_name=good,undead
            no_leader,hidden=yes,yes
        [/side]

        # Trapdoor
        [side]
            side,controller,color=8,null,wesred
            team_name=good,undead
            no_leader,hidden=yes,yes
        [/side]
        [event] # only allow undead to attack the trapdoor if there's no side=1,2 units adjacent
            name=side 2 turn end
            first_time_only=no
            [if] {HAVE_UNIT( side=1,2 {FILTER_ADJACENT side=8} )}
                [then]
                    [modify_side]
                        side=8
                        team_name=good,undead
                    [/modify_side]
                [/then]
                [else]
                    [modify_side]
                        side=8
                        team_name=good
                    [/modify_side]
                [/else]
            [/if]
        [/event]

        #######################################################################################################################################################
        #                                                                     PREPARE MAP
        #######################################################################################################################################################
        [event]
            name=prestart

            #############################
            # SCENERY
            #############################
            {BRAZIER_ILLUMINATION 18 8}
            {BRAZIER_ILLUMINATION 22 9}
            {BRAZIER_ILLUMINATION 17 13}
            {PLACE_IMAGE scenery/stairway.png 22 7}
            [item]
                x,y,halo=22,7,"scenery/trapdoor-centered.png~FL()"
                name=trapdoor
            [/item]
            {GENERIC_UNIT 8 Trapdoor 22 7}
            {PLACE_IMAGE scenery/temple1.png 20 5}
            {PLACE_IMAGE scenery/tent-fancy-red.png 16 13}
            {PLACE_IMAGE scenery/tent-shop-weapons.png 17 14}
            {GENERIC_UNIT 7 Statue 23 9}
            #############################
            # UNDEAD GUARDS
            #############################
            [unit]
                side,x,y,facing=3,23,27,nw
                {SINGLEUNITWML_MEBRIN}
            [/unit]
            [unit]
                side,x,y,facing=4,4,23,nw
                type,canrecruit=Necrophage,yes
            [/unit]
            [capture_village]
                side,x,y,radius=3,4,23,3 # give these to mebrin, as he has lots of upkeep
            [/capture_village]
            [unit]
                side,x,y,facing=5,34,20,nw
                type,canrecruit=Necrophage,yes
            [/unit]
            {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Bone Shooter"    "Banebow"     } 20 25 ({ZONE_GUARDIAN 20 25 x,y,radius=23,27,4} {ROLE vip_escort})}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Bone Shooter"    "Banebow"     } 24 27 ({ZONE_GUARDIAN 24 27 x,y,radius=23,27,4} {ROLE vip_escort})}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "none"            "Skeleton Archer" "Bone Shooter"} 26 25 ({ZONE_GUARDIAN 26 25 x,y,radius=23,27,4} {ROLE vip_escort})}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton"        "Skeleton"        "Revenant"    } 21 26 ({ZONE_GUARDIAN 21 26 x,y,radius=23,27,4} {ROLE vip_escort})}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "none"            "Skeleton"        "Skeleton"    } 20 26 ({ZONE_GUARDIAN 20 26 x,y,radius=23,27,4} {ROLE vip_escort})}
            {GENERIC_UNITC 4 (Ghoul)         5 22 ({ZONE_GUARDIAN  5 22 x,y,radius=4,24,4})}
            {GENERIC_UNITC 4 (Ghoul)         3 25 ({ZONE_GUARDIAN  3 25 x,y,radius=4,24,4})}
            {GENERIC_UNITC 4 (Ghoul)         6 25 ({ZONE_GUARDIAN  6 25 x,y,radius=4,24,4})}
            {GENERIC_UNITC 5 (Ghoul)        35 19 ({ZONE_GUARDIAN 35 19 x,y,radius=34,21,4})}
            {GENERIC_UNITC 5 (Ghoul)        31 20 ({ZONE_GUARDIAN 31 20 x,y,radius=34,21,4})}
            #############################
            # UNDEAD ATTACKERS
            #############################
            # spawn instead of recruiting, so they arrive sooner with less downtime
            {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Skeleton Archer" "Skeleton Archer"} 22 27 ()}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton"        "Skeleton"        "Skeleton"       } 23 23 ()}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Skeleton Archer" "Skeleton Archer"} 24 23 ()}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "none"            "Skeleton Archer" "Skeleton Archer"} 20 22 ()}
            {GENERIC_UNITC 3 {ON_DIFFICULTY "none"            "Skeleton"        "Skeleton"       } 21 25 ()}
            {GENERIC_UNITC 4 {ON_DIFFICULTY "Walking Corpse"  "Ghoul"           "Ghoul"          }  3 23 ()}
            {GENERIC_UNITC 4 {ON_DIFFICULTY "Walking Corpse"  "Ghoul"           "Ghoul"          }  7 23 ()}
            {GENERIC_UNITC 4 {ON_DIFFICULTY "Walking Corpse"  "Ghoul"           "Ghoul"          }  8 22 ()}
            {GENERIC_UNITC 4 {ON_DIFFICULTY "Walking Corpse"  "Walking Corpse"  "Walking Corpse" }  4 20 ()}
            {GENERIC_UNITC 4 {ON_DIFFICULTY "none"            "Walking Corpse"  "Walking Corpse" }  3 21 ()}
            {GENERIC_UNITC 5 {ON_DIFFICULTY "Walking Corpse"  "Ghoul"           "Ghoul"          } 33 20 ()}
            {GENERIC_UNITC 5 {ON_DIFFICULTY "Walking Corpse"  "Ghoul"           "Ghoul"          } 33 21 ()}
            {GENERIC_UNITC 5 {ON_DIFFICULTY "Walking Corpse"  "Walking Corpse"  "Walking Corpse" } 35 21 ()}
            #############################
            # DEORAN
            #############################
            [unstore_unit]
                variable=stored_deoran
                x,y=24,8
            [/unstore_unit]
            {MODIFY_UNIT id=Deoran facing sw}
            [capture_village]
                side,x,y,radius=1,20,10,7
                {NOT( {FILTER side=2} )}
            [/capture_village]
            {VARIABLE ignore_companion_defeat yes}
            [foreach]
                array=stored_recall_list
                [do]
                    [unstore_unit]
                        variable=this_item
                        x,y,find_vacant=recall,recall,yes
                    [/unstore_unit]
                    {FULL_HEAL id=$this_item.id}
                [/do]
            [/foreach]
            {CLEAR_VARIABLE stored_recall_list}
            {FIRE_EVENT refresh_experience}
            #############################
            # HEROES
            #############################
            [unit]
                side,x,y,facing=1,19,6,sw
                {SINGLEUNITWML_HYLAS}
            [/unit]
            [unit]
                side,x,y,facing=1,15,7,sw
                {SINGLEUNITWML_GERRICK}
            [/unit]
            [unit]
                side,x,y,facing=1,20,10,sw
                {SINGLEUNITWML_MARI}
            [/unit]
            {KILL id=$companion_id} # our companion died last scenario
            #############################
            # GUARDS
            #############################
#define DO_IF_PEBBLES LIMIT WML
    [if] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to {LIMIT}}
        [then]
            {WML}
        [/then]
    [/if]
#enddef
#define DO_IF_EXACTLY LIMIT WML
    [if] {VARIABLE_CONDITIONAL pebbles_defense_length equals {LIMIT}}
        [then]
            {WML}
        [/then]
    [/if]
#enddef
            # these timings line up with the messages given in PEBBLES_DIALOGUE_SWITCH
            {WML_COMPANION
            (WML_MARI={VARIABLE tahn_type Fencer})
            (WML_GERRICK={VARIABLE tahn_type "Heavy Infantryman"})
            (WML_HYLAS={VARIABLE tahn_type Mage})
            }

            {DO_IF_PEBBLES  1 ( {GENERIC_UNIT 1 Peasant    14  7}{FACING sw} {ADD_MODIFICATIONS({TRAIT_INTELLIGENT}{TRAIT_STRONG})} )} # with quick, this guy can reach a village. Hardcode traits to remove randomness
            {DO_IF_PEBBLES  2 ( {GENERIC_UNIT 1 Woodsman   18  4}{FACING sw} )}
            {DO_IF_PEBBLES  3 ( {GENERIC_UNIT 1 Woodsman   19 11}{FACING se} )}
            {DO_IF_PEBBLES  4 ( {GENERIC_UNIT 1 Peasant    25  9}{FACING se} {ADD_MODIFICATIONS({TRAIT_STRONG}{TRAIT_INTELLIGENT})} )} # with quick, these guys can get to the east shore much quicker
            {DO_IF_PEBBLES  5 ( {GENERIC_UNIT 1 Woodsman   24  9}{FACING sw} {ADD_MODIFICATIONS({TRAIT_RESILIENT}{TRAIT_STRONG})}   )} # hardcode traits to remove randomness.
            {DO_IF_PEBBLES  6 ( {GENERIC_UNIT 1 Peasant    15  8}{FACING sw} )}
            {DO_IF_PEBBLES  7 ( {GENERIC_UNIT 1 Woodsman   20 11}{FACING se} )}
            {DO_IF_PEBBLES  8 ( {GENERIC_UNIT 1 Woodsman   18  9}{FACING se} )}
            {DO_IF_PEBBLES  9 ( {GENERIC_UNIT 1 Woodsman   19  9}{FACING se} )}
            {DO_IF_PEBBLES 10 ( {GENERIC_UNIT 1 Peasant    19  8}{FACING se} )}
            {DO_IF_PEBBLES 11 (
                {GENERIC_UNIT 1 $tahn_type 15 14}{FACING sw}
                {GENERIC_UNIT 1 $tahn_type 18 14}{FACING sw}
                {GENERIC_UNIT 1 $tahn_type 17 14}{FACING sw}
                {WML_COMPANION (WML_MARI={GENERIC_UNIT 1 Duelist 16 12}{FACING se})} # fencers are cheaper than HI/mages and also weak vs undead, so spawn an extra one
            )}
            {CLEAR_VARIABLE tahn_type}
            {DO_IF_EXACTLY 11 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} {KILL x,y=20,11} {KILL x,y=15,8} )}
            {DO_IF_EXACTLY 12 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} {KILL x,y=20,11} )}
            {DO_IF_EXACTLY 13 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} )}
            {DO_IF_EXACTLY 14 ( {KILL x,y=19,8} {KILL x,y=19,9} )}
            {DO_IF_EXACTLY 15 ( {KILL x,y=19,8} )}
            {DO_IF_EXACTLY 16 ( {KILL x,y=19,8} )}
            {DO_IF_PEBBLES 18 ( {TRANSFORM_UNIT x,y=18,9  Bowman  } )}
            {DO_IF_PEBBLES 20 ( {TRANSFORM_UNIT x,y=19,9  Bowman  } )}
            {DO_IF_PEBBLES 22 ( {TRANSFORM_UNIT x,y=19,8  Spearman} )}
            {DO_IF_PEBBLES 24 ( {TRANSFORM_UNIT x,y=14,7  Spearman} )}
            {DO_IF_PEBBLES 26 ( {TRANSFORM_UNIT x,y=18,4  Bowman  } )}
            {DO_IF_PEBBLES 28 ( {TRANSFORM_UNIT x,y=19,11 Bowman  } )}
            {DO_IF_PEBBLES 30 ( {TRANSFORM_UNIT x,y=25,9  Spearman} )}
            {DO_IF_PEBBLES 32 ( {TRANSFORM_UNIT x,y=24,9  Bowman  } )}
            {DO_IF_PEBBLES 34 ( {TRANSFORM_UNIT x,y=15,8  Spearman} )}
            {DO_IF_PEBBLES 36 ( {TRANSFORM_UNIT x,y=20,11 Bowman  } )}
            {FULL_HEAL side=1} # {TRANSORM_UNIT} doesn't heal. {ADVANCE_UNIT} heals to full, but plays an animation even during prestart (and for some reason only the first one gets executed?)
            {DO_IF_PEBBLES 37 (
                [gold]
                    side,amount=1,"$( ($pebbles_defense_length-36)*1 )" # 1 extra gold for each overflow turn survived
                [/gold]
            )}

            {SCROLL_TO 23 27}
        [/event]

        #######################################################################################################################################################
        #                                                                    PLAY SCENARIO
        #######################################################################################################################################################
#define PEBBLES_DIALOGUE_SWITCH SPEAKER  MSG_NOT_ENOUGH_TIME  MSG_UNTRAINED_FARMERS  MSG_GARRISON_RECALLED  MSG_EQUIPPED_FARMERS
    [if] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 23}
        [then]
            [message]
                speaker={SPEAKER}
                message={MSG_EQUIPPED_FARMERS}
            [/message]
        [/then]
        [elseif] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 11}
            [then]
                [message]
                    speaker={SPEAKER}
                    message={MSG_GARRISON_RECALLED}
                [/message]
            [/then]
        [/elseif]
        [elseif] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 5}
            [then]
                [message]
                    speaker={SPEAKER}
                    message={MSG_UNTRAINED_FARMERS}
                [/message]
            [/then]
        [/elseif]
        [else]
            [message]
                speaker={SPEAKER}
                message={MSG_NOT_ENOUGH_TIME}
            [/message]
        [/else]
    [/if]
#enddef
        [event]
            name=start
            {DELAY 500}
            #wmlindent: start ignoring
            {WML_COMPANION
                #############################
                # IF MARI DIED...
                #############################
                (WML_MARI=
                    [message]
                        speaker,scroll=Deoran,no
                        message= _ "Look there! The undead army has broken through Captain Mari’s lines! I had almost dared to hope... but alas, she is lost."
                    [/message]
                    [message]
                        speaker=Sir Gerrick
                        message= _ "It takes one hell of a soldier to keep on fighting’ after losin’ an arm. I wish I’d gotten to know ’er better. Now I’ll never get the chance."
                    [/message]
                    {PEBBLES_DIALOGUE_SWITCH "Minister Hylas"
                    _"Another poor soul claimed by the spreading darkness. If only we’d had more time to prepare... but we’ve done our best."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we’ve had sufficient time to gather most of the region’s farmers and woodsmen. They’re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we’ve had sufficient time to gather most of the region’s farmers and woodsmen, as well as recall the small squad of fencers manning Fort Tahn."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we’ve had sufficient time to gather, train, and equip most of the region’s farmers and woodsmen, as well as recall the squad of fencers manning Fort Tahn."}
                    [message]
                        speaker=Sir Gerrick
                        message= _ "Aye... I’ve got most o’ the civilians safe underground in th’ cellars, with our trapdoor shut an’ barred. If we’re lucky, we can clean up this mess without any more gettin’ hurt."
                    [/message]
                    [message]
                        speaker=Deoran
                        message= _ "Captain Mari bought us time — I only hope it was enough. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                    [/message]
                    [message]
                        speaker=Deoran
                        message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                    [/message]
                )

                #############################
                # IF GERRICK DIED...
                #############################
                (WML_GERRICK=
                    [message]
                        speaker,scroll=Deoran,no
                        message= _ "Look there! The undead army has broken through Sir Gerrick’s lines! I had almost dared to hope... but alas, he is lost."
                    [/message]
                    [message]
                        speaker=Mari
                        message= _ "Shame. I didn’t really get a chance to know him, but I know you don’t survive to his age unless you’re one hell of a soldier. He’ll be missed."
                    [/message]
                    {PEBBLES_DIALOGUE_SWITCH "Minister Hylas"
                    _"Another poor soul claimed by the spreading darkness. If only we’d had more time to prepare... but we’ve done our best."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we’ve had sufficient time to gather most of the region’s farmers and woodsmen. They’re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we’ve had sufficient time to gather most of the region’s farmers and woodsmen, as well as recall the small squad of heavy infantrymen manning Fort Tahn."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we’ve had sufficient time to gather, train, and equip most of the region’s farmers and woodsmen, as well as recall the small squad of heavy infantry manning Fort Tahn."}
                    [message]
                        speaker=Mari
                        message= _ "Yeah... I’ve got most of the civilians safely underground in the cellars, with the trapdoor shut and barred. If we’re lucky, we can clean us this mess without any more getting hurt."
                    [/message]
                    [message]
                        speaker=Deoran
                        message= _ "Sir Gerrick bought us time — I only hope it was enough. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                    [/message]
                    [message]
                        speaker=Deoran
                        message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                    [/message]
                )

                #############################
                # IF HYLAS DIED...
                #############################
                (WML_HYLAS=
                    [message]
                        speaker,scroll=Deoran,no
                        message= _ "Look there! The undead army has broken through Minister Hylas’s lines! I had almost dared to hope... but alas, he is lost."
                    [/message]
                    [message]
                        speaker=Sir Gerrick
                        message= _ "Th’ good minister turned down the luxurious life o’ a city mage to come down ’ere an’ care for us rural folk. ’e was a good man."
                    [/message]
                    {PEBBLES_DIALOGUE_SWITCH "Mari"
                    _"Me, I’d have taken the life of luxury — but maybe the world needs crazy people like Hylas. If only we’d had more time... but we’ve done our best."
                    _"Me, I’d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas’s sacrifice bought us enough time to gather most of the region’s farmers and woodsmen. They’re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Me, I’d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas’s sacrifice bought us enough time to gather most of the region’s farmers and woodsmen, as well as recall the small squad of mages manning Fort Tahn."
                    _"Me, I’d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas’s sacrifice bought us enough time to gather, train, and equip most of the region’s farmers and woodsmen, as well as recall the small squad of mages manning Fort Tahn."}
                    [message]
                        speaker=Sir Gerrick
                        message= _ "Aye... I’ve got most o’ the civilians safe underground in th’ cellars, with our trapdoor shut an’ barred. If we’re lucky, we can clean up this mess without any more gettin’ hurt."
                    [/message]
                    [message]
                        speaker=Deoran
                        message= _ "Minister Hylas bought us time — I only hope it was enough. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                    [/message]
                    [message]
                        speaker=Deoran
                        message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                    [/message]
                )
            }
            #wmlindent: stop ignoring

            {S06_SACRIFICIAL_LAMB_TIP}
            #############################
            # OBJECTIVES
            #############################
            [objectives]
                side=1
                [objective]
                    description= _ "Survive until turns run out"
                    condition=win
                [/objective]
                [objective]
                    description= _ "The town cellars are breached"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Deoran"
                    condition=lose
                [/objective]
                {IS_LAST_SCENARIO}
            [/objectives]

            #############################
            # MEBRIN TAUNTS DEORAN
            #############################
            [event]
                name=side 1 turn end
                [message]
                    speaker=Mebrin
                    message= _ "So, the fleshbags have managed to mount a defense. I would seem that the pesky fly turned out to be more than a minor annoyance after all."
                [/message]
                [message]
                    speaker=Mebrin
                    message= _ "No matter. Slay them all, my servants! Even if we sustain losses here, the town’s inhabitants will be more than enough to replenish our ranks."
                [/message]
            [/event]
        [/event]

        #############################
        # "FOR $COMPANION_NAME"
        #############################
        [event]
            name=attack
            {FILTER side=1}
            {WML_COMPANION
            (WML_MARI={VARIABLE message _"For mistress Mari! For all the fallen!"})
            (WML_GERRICK={VARIABLE message _"For master Gerrick! For all the fallen!"})
            (WML_HYLAS={VARIABLE message _"For master Hylas! For all the fallen!"})
            }
            [message]
                speaker=unit
                message=$message
            [/message]
            {CLEAR_VARIABLE message}
        [/event]

        #############################
        # LAMENTING
        #############################
        [event]
            name=turn 3
            [message]
                speaker=Deoran
                message= _ "If only Ethiliel had not fled! I curse our isolation, so far removed from the great cities of the north. The capital garrison alone would make short work of this lich, if only we could have contacted them in time!"
            [/message]
            # it's possible but extremely unlikely that both Hylas and Gerrick are dead here
            {SAY_IF_HAVE
            Mari             _"That’s assuming Weldyn would even bother to help out a podunk like this. Capital of the southern province, sure, but that’s not saying much. Without Prince Arand’s ambitions for this place, I doubt anybody — you and me included — would much care what happened here."
            "Minister Hylas" _"Even then, Westin is small and remote, and thus easy for others to overlook. Prince Arand’s ambitions for this place are the better part of the reason we have any significance at all — as well as the reason you were deployed here, Deoran."
            }
            {SAY_IF_HAVE
            "Sir Gerrick" _"O’ course, if th’ prince had actually come here himself instead o’ spendin’ all ’is time up in Weldyn with the king, we might’ve not gotten in such trouble in th’ first place..."
            Mari _"Of course, if the prince had actually come here himself instead of spending all his time up at Weldyn with the king, we might’ve not gotten in such trouble in the first place..."
            }
        [/event]

        #############################
        # NIGHT FALLS (AND DAY RISES)
        #############################
        [event]
            name=turn 4
            [message]
                speaker=Mebrin
                message= _ "The shroud of darkness descends once more. Night seeps through the cracks and crannies in the humans’ defenses, plaguing their minds and bodies with dreadful fear. As surely as the sanctity of the psyche is shattered, so is the physical form, and all that’s left is unthinking, unfeeling servitude."
            [/message]
            [message]
                speaker=Deoran
                message= _ "We don’t fear your unholy power, lich. We won’t succumb to your dark magics and we won’t be turned into your undead slaves."
            [/message]
            [message]
                speaker=Mebrin
                message= _ "Believe what you will, human. We shall see if you survive the night."
            [/message]
        [/event]
        [event]
            name=turn 7
            [message]
                speaker=Deoran
                message= _ "Dawn breaks over the horizon! We’ve weathered the nighttime attack!"
            [/message]
        [/event]

        #############################
        # MEBRIN GETS REINFORCEMENTS
        #############################
        [event]
            name=turn 8
            [gold]
                side=3
                amount={ON_DIFFICULTY 15 30 60}
            [/gold]
            [gold]
                side=4,5
                amount={ON_DIFFICULTY 10 20 40}
            [/gold]
        [/event]
        [event]
            name=side 6 turn 10 refresh

            [if]
                {NOT({HAVE_UNIT( side,count=1,1-99 {FILTER_LOCATION x,y,radius=33,1,3} )})}
                {NOT({HAVE_UNIT( side,count=1,3-99 {FILTER_LOCATION x,y,radius=31,1,5} )})}
                [then]
                    {GENERIC_UNITC 6 (Ghoul)          35 3 ({ANIMATE}{ZONE_GUARDIAN 35 3 x,y,radius=37,1,4})}
                    {GENERIC_UNITC 6 (Walking Corpse) 34 2 ({ANIMATE})}
                    {GENERIC_UNITC 6 (Walking Corpse) 33 2 ({ANIMATE})}
                    [unit]
                        side,x,y,facing=6,35,2,nw
                        type,canrecruit=Necrophage,yes
                        animate=yes
                    [/unit]
                    {MOVE_UNIT side,canrecruit=6,yes 33 1}
                    {MODIFY_TERRAIN Ke 33 1} [redraw][/redraw] {DELAY 150}
                    {MODIFY_TERRAIN Ce 33 2} [redraw][/redraw] {DELAY 150}
                    {MODIFY_TERRAIN Ce 32 1} [redraw][/redraw] {DELAY 150}
                    {MODIFY_TERRAIN Ce 31 1} [redraw][/redraw] {DELAY 150}
                [/then]
                [else]
                    {GENERIC_UNITC 6 (Ghoul)          3 1 ({ANIMATE}{ZONE_GUARDIAN 3 1 x,y,radius=37,1,4})}
                    {GENERIC_UNITC 6 (Walking Corpse) 1 2 ({ANIMATE})}
                    {GENERIC_UNITC 6 (Walking Corpse) 2 2 ({ANIMATE})}
                    [unit]
                        side,x,y,facing=6,5,1,nw
                        type,canrecruit=Necrophage,yes
                        animate=yes
                    [/unit]
                    {MODIFY_TERRAIN Ke 5 1} [redraw][/redraw] {DELAY 150}
                    {MODIFY_TERRAIN Ce 5 2} [redraw][/redraw] {DELAY 150}
                    {MODIFY_TERRAIN Ce 6 1} [redraw][/redraw] {DELAY 150}
                    {MODIFY_TERRAIN Ce 7 1} [redraw][/redraw] {DELAY 150}
                [/else]
            [/if]

            {MODIFY_UNIT side=6 moves        2} # let them move immediately to counter spawncamping, but not far enough that they're likely to hit any normally-positioned player units
            {MODIFY_UNIT side=6 attacks_left 1}
            [modify_side]
                side=6
                gold={ON_DIFFICULTY 0 15 45} # 2 free corpses, so real gold is 15/30/60
                hidden=no
            [/modify_side]

            [message]
                speaker=Deoran
                message= _ "They’ve come around behind us! Stand fast, soldiers of the South Guard!"
            [/message]
        [/event]

        #############################
        # TRAPDOOR OBJECTIVE REMINDER
        #############################
        [event]
            name=attack end
            {FILTER_SECOND type=Trapdoor}
            [message]
                speaker=Deoran
                message= _ "The undead are trying to break into the cellars! If they get among the refugees, all will be lost."
            [/message]
        [/event]

        #############################
        # PLAYER SUFFERS CASUALTIES
        #############################
        [event]
            name=die {FILTER side=1}
            [event]
                name=die {FILTER side=1}
                [event]
                    name=die {FILTER side=1}
                    {FILTER_CONDITION( {NOT({HAVE_UNIT id=Ethiliel})} )}
                    [message]
                        speaker=Deoran
                        message= _ "Hold fast, men of the South Guard! No matter how daunting the evil that opposes us, we must weather this darkness and defend our homes!"
                    [/message]
                    [message]
                        speaker=Mebrin
                        message= _ "Fool boy, you overestimate the strength of these decrepit peasants that you call soldiers. The rivers will run red with your blood! The smoke and ashes from your ruined homes will blot out the sky, and from the swamps and the black earth, your bones will rise again to serve me!"
                    [/message]
                [/event]
            [/event]
        [/event]

        #############################
        # NECROPHAGE DIES
        #############################
        [event]
            name=die
            {FILTER type_adv_tree,canrecruit=Ghoul,yes}
            #         {FILTER_SECOND side=1}
            [event]
                name=side 3 turn
                [message]
                    speaker=Mebrin
                    message = _ "So, you’ve defeated my lackey. A great accomplishment, for ones so pitiful."
                [/message]
                [message]
                    speaker=Deoran
                    message = _ "What’s truly pitiful is the plight you’ve put yourself in, once wise sage of the elves. You’ve fallen to the black arts, twisted and corrupted by its use. Though you and your undead have ravaged our lands with your profane sorceries, I feel nothing but pity for the shambling shell you’ve become. Perhaps we can take solace in putting you out of your misery."
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "How little you understand. Such pompous words don’t benefit such an ignorant boy. Your foolish babble means nothing in the face of my insurmountable power! Rise, my warriors!"
                [/message]
                [gold]
                    side,amount=3,{ON_DIFFICULTY 20 40 60}
                [/gold]
            [/event]
        [/event]

        #############################
        # PLAYER ATTACKS MEBRIN
        #############################
        [event]
            name=attack end
            {FILTER side=1}
            {FILTER_SECOND id=Mebrin}
            [message]
                speaker=Mebrin
                message = _ "You dare strike me?! Puny humans, I’m darkness incarnate! I’m power beyond your comprehension!"
            [/message]
        [/event]

        #############################
        # ELVES ATTACK MEBRIN
        #############################
        [event]
            name=attack end
            {FILTER side=2}
            {FILTER_SECOND id=Mebrin}
            [message]
                speaker=Mebrin
                message = _ "Ungrateful elves! I offer you secrets beyond your comprehension! I offer you immortality itself!"
            [/message]
        [/event]

        #######################################################################################################################################################
        #                                                                 ETHILIEL ARRIVES
        #######################################################################################################################################################
        # ensure Mebrin won't have troops near Ethiliel's spawn, to ensure she doesn't die
        # it helps that she spawns in the middle of snow, which slows down skeletons
        [event]
            name=side 3 turn $( {TURN_LIMIT}-7 ) refresh
            {MODIFY_SIDE_AI (3) (
                [avoid]
                    x,y,radius=5,16,1
                [/avoid]
            )}
        [/event]
        [event]
            name=side 3 turn $( {TURN_LIMIT}-6 ) refresh
            {MODIFY_SIDE_AI (3) (
                [avoid]
                    x,y,radius=5,16,2
                [/avoid]
            )}
        [/event]
        [event]
            name=side 3 turn $( {TURN_LIMIT}-5 ) refresh
            {MODIFY_SIDE_AI (3) (
                [avoid]
                    x,y,radius=5,16,3
                [/avoid]
            )}
        [/event]
        [event]
            name=side 3 turn $( {TURN_LIMIT}-4 ) refresh
            {MODIFY_SIDE_AI (3) (
                [avoid]
                    x,y,radius=5,16,4
                [/avoid]
            )}
        [/event]
        #############################
        # ETHILIEL ARRIVES
        #############################
        # if we make this happen exactly when turns run out, you might still die before the elves reach the battle
        # instead, trigger it 2 turns early. If you could have survived for 2 more turns, you'll probably be fine with the elves' help
        # hopefully this timing feels exciting, not unfair...
        [event]
            name=side 3 turn $( {TURN_LIMIT}-2 ) # arrive at dawn
            #############################
            # HORNS IN THE FOREST
            #############################
            {REPLACE_SCENARIO_MUSIC silence.ogg}
            {SOUND horn-signals/horn-2.ogg}
            {DELAY 1000}
            [message]
                speaker=Deoran
                message = _ "Did you hear that!? There are horns blowing in the west!"
            [/message]
            [unstore_unit]
                variable=stored_ethiliel
                x,y,animate=1,14,yes
            [/unstore_unit]
            {CLEAR_VARIABLE stored_ethiliel}
            {FIRE_EVENT refresh_experience}
            [modify_unit]
                {FILTER id=Ethiliel}
                side,canrecruit=2,yes
                facing=se
                [object]
                    {EFFECT overlay remove=misc/hero-icon.png}
                [/object]
            [/modify_unit]
            {MOVE_UNIT id=Ethiliel 5 16} # 6 hexes away from her keep, so she can reach it in 1 turn
            {REPLACE_SCENARIO_MUSIC vengeful.ogg}
            {APPEND_MUSIC battle-epic.ogg}
            {APPEND_MUSIC siege_of_laurelmor.ogg}
            #############################
            # ETHILIEL COMFRONTS MEBRIN
            #############################
            [message]
                speaker=Ethiliel
                message = _ "Mebrin! This has gone far enough."
            [/message]
            [message]
                speaker=Mebrin
                message = _ "Ethiliel, my student... How pleased am I to see you again! What wonderful secrets have I to share..."
            [/message]
            [message]
                speaker=Mebrin
                message = _ "I have touched the void at the heart of all things, and I have begun to probe the mystic arts far beyond what any living elf knows. There is infinity at the brink of death, Ethiliel... If you thought me wise before, I have now become omniscient!"
            [/message]
            [message]
                speaker=Ethiliel
                message = _ "You’ve become <b><i>evil</i></b>, Mebrin. Surely you see it! Take a good look at yourself! Your servants are abominations worse than any human. They stink of death, tainted magic and... and corruption! Even you! Mebrin... you were the kindest and gentlest of the sages..."
            [/message]
            [message]
                speaker=Ethiliel
                message = _ "No, the sage Mebrin is dead. You’re not the master I once revered. I have come to cleanse your soul and put you to rest, my beloved teacher."
            [/message]
            [message]
                speaker=Mebrin
                message = _ "Is that why you returned? Bah, I see you still have much foolishness to be rid of. I shall deal with you personally. You were always more of a hands-on learner, after all..."
            [/message]

            #############################
            # MEBRIN FOCUSES ON ETHILIEL
            #############################
            # only change attack/defend stats on the first turn
            {RESET_SIDE_AI 3,4 offensive -1 1} # still allow attacking the player this round, if we have a particularly juicy target
            {MODIFY_SIDE_AI 3,4 (
                [goal]        # but not side 5, since they're on the opposite side of the map from the elves
                    name=target_unit
                    [criteria]
                        side=2
                    [/criteria]
                    value=10
                [/goal]
            )}

            #############################
            # MEBRIN ENRAGES
            #############################
            {REPEAT 99 (
                [micro_ai]
                    side,ai_type,action=3,zone_guardian,delete
                [/micro_ai]
            )}
            [micro_ai]
                side,ai_type,action=3,zone_guardian,add
                {FILTER role=vip_escort}
                [filter_location]
                    radius=1 {FILTER id=Mebrin}
                [/filter_location]
                [filter_location_enemy]
                    radius=5 {FILTER id=Mebrin}
                [/filter_location_enemy]
            [/micro_ai]

            [gold]
                side=3
                amount={ON_DIFFICULTY 15 30 60}
            [/gold]
            {MODIFY_SIDE_AI 3 retreat_factor=0}
            {MODIFY_SIDE_AI 3 village_value=0}
            [event]
                name=side 3 turn end
                {MODIFY_UNIT id=Mebrin canrecruit no} # for some reason leaders behave differently even with leader_ignores_keep=yes
                {GIVE_OBJECT_TO id=Mebrin ({EFFECT overlay add=misc/leader-crown.png})}
            [/event]
            [event]
                name=side 3 turn end
                {FILTER_CONDITION( {NOT({HAVE_UNIT( side=1 {FILTER_LOCATION x,y,radius=22,25,3} )})} )}
                {MOVE_UNIT id=Mebrin 22 24} # it's possible but unlikely that enough hexes are around here to make mebrin move weirdly
            [/event]

            #############################
            # MORE ELVES ARRIVE
            #############################
            [event]
                name=side 3 turn end
                {GENERIC_UNIT 2 "Elvish Fighter"     3 13}{ANIMATE}{FACING ne} # none of these elves have NE sprites
                {GENERIC_UNIT 2 "Elvish Hero"        2 14}{ANIMATE}{FACING ne} # but spawn them NE so that if any sprites get added we have some facing variety
                {GENERIC_UNIT 2 "Elvish Shaman"      4 14}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Enchantress" 2 15}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Sorceress"   1 16}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Fighter"     3 17}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Shaman"      2 17}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Fighter"     3 18}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Fighter"     1 19}{ANIMATE}{FACING ne}
                {GENERIC_UNIT 2 "Elvish Shaman"      4 11}{ANIMATE}{FACING se}{GUARDIAN}
                [message]
                    speaker=Ethiliel
                    message = _ "Deoran, Mebrin is as much my people’s fault as he is yours. Forgive me for my cowardice at the river. With me come warriors of the Aethenwood — together, men and elves shall finally put my teacher’s tortured soul to rest."
                [/message]

                [modify_side]
                    side=2
                    gold={ON_DIFFICULTY 50 60 70}
                    income={ON_DIFFICULTY 12 14 16}
                    hidden=no
                [/modify_side]
                [modify_turns]
                    value=-1
                [/modify_turns]

                #############################
                # OBJECTIVES
                #############################
                [objectives]
                    side=1
                    [objective]
                        description= _ "Defeat Mebrin"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "The town cellars are breached"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Deoran"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Ethiliel"
                        condition=lose
                    [/objective]
                    {IS_LAST_SCENARIO}
                [/objectives]
            [/event]
        [/event]

        #############################
        # MEBRIN ASKS ETHILIEL TO JOIN HIM
        #############################
        [event]
            name=side 3 turn "$( {TURN_LIMIT} + 2 )"
            [message]
                speaker=Mebrin
                message = _ "Why do you aid these fools, Ethiliel? Join me! Stand by my side! The race of man shall be stricken off the face of the green world. Their corpses will serve us! Their bones will dance for our pleasure! We’ll make humanity into the mindless slaves that they all deserve to be!"
            [/message]
            [message]
                speaker=Ethiliel
                message = _ "And when that’s done, what will us elves have become? Naught but hungering shadows, devouring all we once cherished."
            [/message]
            [message]
                speaker=Deoran
                message = _ "Even a mere human can see that you have become a mockery of all that you once believed in, Mebrin of the elves. We will destroy you and bury your perverse corruption!"
            [/message]
            [message]
                speaker=Mebrin
                message = _ "Ethiliel I respect, but you? Destroy me? Your man-flesh will provide a fine feast for my ghouls, and once they’re through, your bones will serve me forever in undeath!"
            [/message]
        [/event]

        #######################################################################################################################################################
        #                                                                 VICTORY / DEFEAT
        #######################################################################################################################################################
        #############################
        # MEBRIN DIES (TO HUMANS)
        #############################
        [event]
            name=last breath
            {FILTER id=Mebrin}
            {FILTER_SECOND side=1}
            [message]
                speaker=Mebrin
                message = _ "Fools! Imbeciles! You humans are a worthless blight upon this wretched world! I must purge you all — I must take revenge on all your race... I must..."
            [/message]
            [message]
                speaker=Deoran
                message = _ "These worthless humans just bested you and your armies. Your time has come, once-wise sage of the elves."
            [/message]
            [message]
                speaker=Mebrin
                message = _ "I curse you, Deoran of Wesnoth! I curse you... may you one day know the same pain that your kind have inflicted on me..."
            [/message]
            [event]
                name=die
                [message]
                    speaker=Deoran
                    message = _ "At long last, it is done."
                [/message]
                {DELAY 500}
                [endlevel]
                    result=victory
                    linger_mode=no
                    carryover_report=no
                    save=no
                [/endlevel]
            [/event]
        [/event]

        #############################
        # MEBRIN DIES (TO ELVES)
        #############################
        [event]
            name=last breath
            {FILTER id=Mebrin}
            {FILTER_SECOND side=2}
            [message]
                speaker=Mebrin
                message = _ "Wait! Ethiliel... think about it! Think of everything you’re throwing away! We could build an empire together, where the humans are our slaves and you and I are the immortal rulers of the world!"
            [/message]
            [message]
                speaker=Ethiliel
                message = _ "It would only be an empire of misery, Mebrin. I wish it hadn’t come to this, but you’ve been corrupted beyond saving. Still, I’ll fondly cherish the memories I had with the old you."
            [/message]
            [message]
                speaker=Mebrin
                message = _ "You wouldn’t dare strike me! I’m the darkness incarnate! I’m your master! You’ll obey me!"
            [/message]
            [event]
                name=die
                [message]
                    speaker=Ethiliel
                    message = _ "Goodbye, Mebrin."
                [/message]
                [endlevel]
                    result=victory
                    carryover_report,linger_mode=no,no
                [/endlevel]
            [/event]
        [/event]

        [event]
            name=victory
            {VARIABLE epilogue undead}
            [if] {NOT({HAVE_UNIT id=Ethiliel})}
                [then]
                    {VARIABLE won_without_elves yes}
                    {ACHIEVE s06b}
                [/then]
            [/if]
        [/event]
    [/scenario]

#undef TURN_LIMIT
#undef TURN_WARNING
