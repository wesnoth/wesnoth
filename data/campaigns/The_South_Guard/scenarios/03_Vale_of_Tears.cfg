#textdomain wesnoth-tsg

#define TURN_LIMIT
6#enddef

[scenario]
    id=03_Vale_of_Tears
    map_file=03_Vale_of_Tears.map
    name= _ "Vale of Tears"
    next_scenario=04_Choice_in_the_Fog
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    {DEFAULT_SCHEDULE_NOWEATHER}
    current_time=2
    turns={TURN_LIMIT}
    {ADD_WEATHER_RAIN}
    {SCENARIO_MUSIC elvish-theme.ogg}
    {TSG_BIGMAP {JOURNEY_03_NEW} }
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        fog=yes
    [/side]

    #############################
    # BANDITS
    #############################
#define UNDEAD_SIDE SIDE INCOME RECRUIT
    # wmllint: local spelling Nalmath
    [side]
        side,controller,color={SIDE},ai,blue
        no_leader,hidden=yes,no
        team_name,user_team_name=bandits,_"Urza Nalmath"
        gold=0 # all enemies start with 0 gold, but high income. By the time the player frees Ethiliel, they will have amassed a significant gold reserve
        income={INCOME}
        recruit={RECRUIT}
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    {UNDEAD_SIDE 2 ({ON_DIFFICULTY 2 5 11}) "Ghoul"}
    {UNDEAD_SIDE 3 ({ON_DIFFICULTY 1 3  7}) "Walking Corpse"}
    {UNDEAD_SIDE 4 ({ON_DIFFICULTY 0 2  6}) "Walking Corpse"}
    {UNDEAD_SIDE 5 ({ON_DIFFICULTY 0 2  6}) "Walking Corpse"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Walking Corpse" {ON_DIFFICULTY 3 4 5}} # 2 guards on all difficulties
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    #############################
    # BANDIT AI
    #############################
    [event]
        name=side 2 turn
        first_time_only=no
        {FILTER_CONDITION({VARIABLE_CONDITIONAL phase_two equals yes})}
        {RESET_SIDE_AI 2,3,4,5 offensive 0.99 0.01}
        {MODIFY_SIDE_AI 2,3,4,5 retreat_factor=0}
        # custom VARY_AI_BY_SCHEDULE. The normal macro has corpses retreat too far, because they're in water and move slowly
        {IF_TIME_OF_DAY morning}
        {AND_NO_ENEMIES_NEAR_MY_LEADER 2,3,4,5}
        [then]
            {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9 2,3,4,5 1 2})} # avoid staying too close
            {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_SEEK_SIDE                          8         1 4})} # but seek staying close enough
            {MODIFY_SIDE_AI (2,3,4,5) (aggression=-9)}
            {MODIFY_SIDE_AI (2,3,4,5) (caution=9)}
        [/then]
        {ENDIF}
        {IF_TIME_OF_DAY afternoon}
        {AND_NO_ENEMIES_NEAR_MY_LEADER 2,3,4,5}
        [then]
            {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9 2,3,4,5 1 1})} # avoid staying too close
            {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_SEEK_SIDE                          8         1 3})} # but seek staying close enough
            {MODIFY_SIDE_AI (2,3,4,5) (aggression=-9)}
            {MODIFY_SIDE_AI (2,3,4,5) (caution=9)}
        [/then]
        {ENDIF}
    [/event]

    # make zombies slightly less useless in shallow water.
    [event]
        name=unit placed
        first_time_only=no
        {FILTER type_adv_tree="Walking Corpse",Ghoul}
        [object]
            {FILTER id=$unit.id}
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    shallow_water=2
                [/movement_costs]
            [/effect]
        [/object]
    [/event]

    [side] # dummy side for the illusionary elves
        side=6
        color=green
        controller=null
        no_leader=yes
        hidden=yes
    [/side]

    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        [item]
            x,y,halo=22,17,scenery/fountain-[01~13].png~FL():100
        [/item]

        #############################
        # ILLUSION RUNES
        #############################
        # usually I'd expect runes to be dwarvish, but I think we can make an exception here
        {PLACE_IMAGE "scenery/rune4-glow.png~CS(-50,100,-50)~O(0.5)" 28 12}
        [event]
            name=moveto
            {FILTER side,x,y=1,28,12}
            [message]
                speaker=Deoran
                message= _ "This magical rune must have triggered the illusions we saw earlier. Whatever magic it once held is now gone."
            [/message]
            [allow_undo][/allow_undo]
        [/event]

        {PLACE_IMAGE "scenery/rune4.png~CS(-50,100,-50)~O(0.5)" 8 20}
        [event]
            name=moveto
            {FILTER side,x,y=1,8,20}
            [message]
                speaker=Deoran
                message= _ "Whatever runic magic once guarded this side of the isthmus, it has already been exhausted."
            [/message]
            [allow_undo][/allow_undo]
        [/event]

        #############################
        # DEORAN ARRIVES
        #############################
        {PUT_TO_RECALL_LIST id=Deoran}
        {SCROLL_TO 38 2}
    [/event]

    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
#define REFRESH_FOG
    [reset_fog]
        reset_view=yes
    [/reset_fog]
    [redraw]
        clear_shroud=yes
    [/redraw]
#enddef
    [event]
        name=start
        #############################
        # DEORAN ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 38 2}
        [redraw]
            clear_shroud=yes
        [/redraw]
        {DELAY 500}{MOVE_UNIT id=Deoran 34  7} {REFRESH_FOG}
        {DELAY 500}{MOVE_UNIT id=Deoran 27  7} {REFRESH_FOG}
        {DELAY 500}{MOVE_UNIT id=Deoran 28 12} {REFRESH_FOG}
        {MODIFY_UNIT id=Deoran facing sw}
        {RECALL_XY $companion_id 29 13}
        {MODIFY_UNIT id=$companion_id facing sw}
        {SCROLL_TO 28 12}
        {SAY_COMPANION SPEAKER=Deoran
        MESSAGE_MARI=_"Captain Mari, are we going in the right direction? I can hardly see a thing through this fog..."
        MESSAGE_GERRICK=_"Sir Gerrick, are we going in the right direction? I can hardly see a thing through this fog..."
        MESSAGE_HYLAS=_"Minister Hylas, are we going in the right direction? I can hardly see a thing through this fog..."
        }

        #############################
        # ELVES APPEAR
        #############################
#define ELF TYPE IMAGE PROFILE X Y ID NAME FACE GEND DURATION ALPHA
    {NAMED_NOTRAIT_UNIT 6 {TYPE} {X} {Y} {ID} {NAME}} {FACING {FACE}} {ANIMATE} {GENDER {GEND}} # no traits because 1) saves the trouble of staying comaptible with future portrayals, and 2) hints that these are illusions
    [modify_unit]
        {FILTER id={ID}}
        [object]
            {EFFECT profile portrait="portraits/{PROFILE}~O(0.75)"} # partially transparent, because they're illusions
            {EFFECT remove_attacks ()} # no attacks, because they're illusions
            {EFFECT new_animation([standing_anim]
            base_score=99
            [frame]
                image=units/elves-wood/{IMAGE}
                duration={DURATION} # make the elves fade in and out, beacuse they're illusions
                alpha={ALPHA}
            [/frame]
        [/standing_anim])}
        {EFFECT new_animation ([death]
        base_score=99
        [frame]
            duration,image_mod=500,"~CS(127,0,127)~BL([15,10,20,30,40,50,60,70])"
            blend_ratio,blend_color=0~1,255,255,255
            alpha=1,1~0
        [/frame]
    [/death] )}
[/object]
[/modify_unit]
{DELAY 150}
#enddef
        {REMOVE_IMAGE 28 12} {PLACE_IMAGE "scenery/rune4.png~CS(-50,100,-50)~O(0.5)" 28 12}
        {ELF (Elvish Captain  ) "captain.png"   "elves/captain.webp"   26 12 Ithelden  _"Ithelden" se   male   6000        "1~0.6:2250,0.6:500,0.6~1:2250,1:1000"}
        {ELF (Elvish Champion ) "champion.png"  "elves/hero.webp"      31 11 Galdrad   _"Galdrad"  sw   male   5000 "1:500, 1~0.6:2000,0.6:500,0.6~1:2000"       } # Galdrad from HttT
        {ELF (Elvish Sorceress) "sorceress.png" "elves/sorceress.webp" 28 15 Vaenuith  _"Vaenuith" ne female   6000        "1~0.8:2500,0.8:500,0.8~1:2500,1:500" }
        {ELF (Elvish Shyde    ) "shyde.png"     "ethiliel.webp"        27 11 Ethiliel  _"Ethiliel" se female   5000        "1~0.7:2000,0.7:500,0.7~1:2000,1:500" }
        {ELF (Elvish Marksman ) "marksman.png"  "elves/marksman.webp"  32 13 Talchar   _"Talchar"  sw   male   6000 "1:1000,1~0.7:2250,0.7:500,0.7~1:2250"       }
        #############################
        # ELVES SPEAK
        #############################
        [message]
            speaker=Galdrad
            message= _ "Halt! Who enters our sacred vale without leave?"
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"Deoran, I’m gonna say... yes."
        MESSAGE_GERRICK=_"...aye, Deoran, looks to be that way."
        MESSAGE_HYLAS=_"Given the evidence at hand, Deoran, I believe the answer is “yes.”"
        }
        {DELAY 500}
        [message]
            speaker=Galdrad
            message= _ "Choose your words wisely, bandits. Speak, knowing that the penalty for trespassing on our lands is death."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I—"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "This is no bandit, for these humans bear the banner of the South Guard, not those rags of the Urzas. Though it remains to be seen whether this proves an improvement — why do you enter the hallowed isle of Elrath?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "To—"
        [/message]
        [message]
            speaker=Vaenuith
            message= _ "To ask our help, no doubt. There is darkness in the air, corruption in the earth. Someone has been meddling in the black magic. Let us not forget that it is you humans who first brought this perverse sorcery to our great continent, when you arrived here centuries ago."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I—"
        [/message]
        [message]
            speaker=Talchar
            message= _ "The past has shown that your race cannot be trusted. A human untrained in the mystic arts is much more likely to be corrupted by such a force than to have the knowledge or ability to banish it."
        [/message]
        [message]
            speaker=Deoran
            message= _ "But—"
        [/message]
        [message]
            speaker=Vaenuith
            message= _ "Why should we treat with you now, when it is your kind’s inaction that has allowed this blight to grow unchecked? Begone with you, mayfly, and leave to us our peace."
        [/message] # ; allowed it to ensnare your minds and consume your souls
        {DELAY 500}
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "—but, but, I have scarcely been here a month! I could not have acted on something that began before my arrival! And besides, this is not the fault of “my kind” but of the Urza brothe—"
        [/message]
        {DELAY 500}
        [message]
            speaker,image=Deoran,misc/blank-hex.png
            message= _ "(deep breath)"
        [/message]
        {DELAY 1000}
        [message]
            speaker=Deoran
            message= _ "...honorable elves, I am Commander Deoran, of Westin’s South Guard. I cannot speak for the past, but in the present we need your help."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Our farms and villages are plundered by criminals, casting dark spells and defiling the dead. We learned that this vale is a place of importance to them, and came seeking answers."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Whence did our foes learn their grim power? How do we find the source of this spreading corruption, so that we may destroy it? Good elves of the vale, can you not aid us in our plight?"
        [/message]
        {DELAY 500}
        [message]
            speaker=Ithelden
            message= _ "..."
        [/message]
        {DELAY 500}
        [message]
            speaker=Ithelden
            message= _ "...very well, outlander. The challenge is passed. Enter, and greet us as we are in life."
        [/message]
        {SOUND skill-illusion-quiet.wav}
        {KILL side=6 ANIMATE=yes}
        [message]
            speaker=Deoran
            message= _ "!?"
        [/message]
        {FADE_MUSIC_OUT 500}
        #############################
        # REPLACE THE MAP
        #############################
        {SOUND skill-polymorph-quiet.wav}
        {SCREEN_FADER 255,255,255 255 250}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}
        [replace_map]
            map_file=03b_Vale_of_Tears.map
            expand,shrink=yes,yes
        [/replace_map]
        [replace_schedule]
            {DEFAULT_SCHEDULE_AFTERNOON}
        [/replace_schedule]
        {REFRESH_FOG}
        {REMOVE_IMAGE 22 17} # remove the fountain
        {PLACE_IMAGE scenery/great-tree-smashed.png 17 13}
        {PLACE_IMAGE scenery/great-tree-smashed.png 23 13}
        {PLACE_IMAGE scenery/great-tree-smashed.png 15 22}
        {NAMED_UNIT 2 Cage 16 18 Ethiliel _"Ethiliel" profile=portraits/ethiliel.webp}
        [item]
            x,y=16,18
            image="units/elves-wood/shyde.png~BLIT(items/cage.png)"
            visible_in_fog=no
        [/item]

        {GENERIC_UNIT 2 "Walking Corpse" 19 19} {ZONE_GUARDIAN 19 19 x,y,radius=19,19,2}
        {GENERIC_UNIT 2 "Walking Corpse" 17 18} {ZONE_GUARDIAN 17 18 x,y,radius=17,18,3}
        {GENERIC_UNIT 2 "Walking Corpse" 17 13} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99}
        {GENERIC_UNIT 2 "Walking Corpse" 17 19} {ZONE_GUARDIAN 17 19 x,y,radius=17,19,2}
#ifndef EASY
        {GENERIC_UNIT 2 "Walking Corpse" 16 17} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99}
        {GENERIC_UNIT 2 "Walking Corpse" 19 17} {ZONE_GUARDIAN 19 17 x,y,radius=19,17,3}
        {GENERIC_UNIT 2 "Walking Corpse" 15 15} {ZONE_GUARDIAN 15 15 x,y,radius=15,15,4}
        {GENERIC_UNIT 2 "Walking Corpse" 15 19} {ZONE_GUARDIAN 15 19 x,y,radius=15,19,2}
#endif
        {REPEAT {ON_DIFFICULTY 1 1 3} (
            {GENERIC_UNIT 2 "Walking Corpse" 16 28} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99} {ROLE slow}
            {GENERIC_UNIT 2 "Walking Corpse"  8 20} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99} {ROLE slow}
            {GENERIC_UNIT 2 "Walking Corpse" 10 12} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99} {ROLE slow}
            {GENERIC_UNIT 2 "Walking Corpse" 20  5} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99} {ROLE slow}
            {GENERIC_UNIT 2 "Walking Corpse"  5 26} {ZONE_GUARDIAN 1 1 x,y=0-99,0-99} {ROLE slow}
        )}
        [event]
            name=side 2 turn refresh
            {MODIFY_UNIT role=slow moves 0} # give the player a one extra turn before these guys attack
        [/event]
        {SCREEN_FADER 000,000,000 0 250}
        #############################
        # EXPLAIN ETHILIEL
        #############################
        {DELAY 1000}
        [message]
            speaker=Deoran
            message= _ "They weren’t real elves at all! It was some kind of... prerecorded illusion? Half-alive echo? Was this something to help protect the valley from intruders?"
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"If that’s what it was, it didn’t work. Look!"
        MESSAGE_GERRICK=_"If that’s what it were, it dinnae work. Look there!"
        MESSAGE_HYLAS=_"If such was the intent, it does not seem to have worked. Look."
        }
        [lift_fog]
            x,y,radius=19,16,6
        [/lift_fog]
        {SCROLL_TO 16 18}
        {REPLACE_SCENARIO_MUSIC battle-epic.ogg}
        {APPEND_MUSIC battle.ogg}
        [message]
            speaker=Deoran
            message= _ "Undead! In an elven valley?? And a caged elf, too!"
        [/message]

        {SAY_COMPANION SPEAKER=Deoran
        MESSAGE_MARI=_"The elven prisoner must have answers about what’s happened here. We shall break her free at once — make ready, Captain Mari!"
        MESSAGE_GERRICK=_"The elven prisoner must have answers about what’s happened here. We shall break her free at once — make ready, Sir Gerrick!"
        MESSAGE_HYLAS=_"The elven prisoner must have answers about what’s happened here. We shall break her free at once — make ready, Minister Hylas!"
        } # There’s no time to deploy the men; we must break her free at once.

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Break the trapped elf out of her cage"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description= _ "To recruit units, you must first move Deoran onto a keep.
    There are two elven keeps near the center of the map."
            [/note]
        [/objectives]
        #
        # this initial segment serves two purposes.
        #	1) to give the player a chance to learn how to use their new companion
        #	2) to spread out the dialogue and hints, so they're not as overwhelming
        #
        [event]
            name=select,turn end
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message=_"<i>Rain or snow have no impact on gameplay. If weather is distracting or reduces performance, you can disable it by opening the Preferences menu (Ctrl-P), by selecting “Display” and unchecking “Animate Map.”</i>"
            [/message]
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                  ETHILIEL IS FREED
    #######################################################################################################################################################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION( radius=2 {FILTER type=Cage} )} )}
        [message]
            speaker=Ethiliel
            message= _ "The humans return, but this time bearing the banners of Westin... If you’re here to help, attack this foul cage and smash it open!"
        [/message]
    [/event]
    [event]
        name=die
        {FILTER type=Cage}
        #############################
        # CREATE ETHILIEL
        #############################
        {REMOVE_IMAGE $unit.x $unit.y}
        [unit]
            type=Elvish Shyde
            id=Ethiliel
            name= _ "Ethiliel"
            profile=portraits/ethiliel.webp
            x,y=$unit.x,$unit.y
            random_traits=no
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_RESILIENT}
                {TEAM_COLOR_OVERRIDE () green}
            [/modifications]
            overwrite=yes
        [/unit]
        {FADE_MUSIC_OUT 500}
        #         {REPLACE_SCENARIO_MUSIC elvish-theme.ogg}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 500}
        [message]
            speaker=Ethiliel
            message= _ "Oh, the joy of once more spreading my wings! And to be saved by humans, of all things... who are you? Is this not some new deceit of the Urzas?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I recognize you from the illusion! Peace, friend, for I am Deoran of the South Guard, and my allegiance lies with Westin, not those deplorable Urza brothers. But by Haldric, will you please tell what has happened here!?"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "What has happened? You mudlings have slain my friends, taken our sage, imprisoned me here these long and terrible moons! ...but if you truly are of the South Guard, then you are not to blame."
        [/message]
        {DELAY 500}
        [message]
            speaker=Ethiliel
            message= _ "They came at night, more than a season ago. I did not see all that transpired, but I heard the screams... Most of us were artisans and scholars, no match the clubs and axes of your kind! My mentor, our great sage Mebrin, was taken away in chains; a foul insult for such a wise old elf."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "I, too, was left alive — perhaps by dint of my high status — but the rest of the survivors were executed one-by-one in cold blood. Not long after, their bodies began to be defiled by wicked undeath, raised anew by the outlaw brothers to do their dark bidding..."
        [/message]
        [if] {VARIABLE_CONDITIONAL phase_two not_equals yes}
            [then]
                #                 [message]
                #                     speaker,image=Ethiliel,portraits/ethiliel-mad.webp
                #                     message= _ "Even now, one of those Urzas lurks somewhere nearby, doubtless causing more harm. Deoran, you claim the South Guard is a friend of the Aethenwood — what shall your people do to make amends for this great evil?"
                #                 [/message]
                {FIRE_EVENT phase_two}
            [/then]
            [else]
            [/else]
        [/if]
    [/event]

    #######################################################################################################################################################
    #                                                                   CREATE URZA NALMATH
    #######################################################################################################################################################
#define MAGIC
    [animate_unit]
        {FILTER id="Urza Nalmath"}
        flag=recruiting
    [/animate_unit]
#enddef
    [event]
        name=side 1 turn {TURN_LIMIT} end # the player should have plenty of time to rescue Ethiliel before Nalmath activates, but if they're delaying we should activate him manually
        {FILTER_CONDITION({VARIABLE_CONDITIONAL phase_two not_equals yes})}
        {FIRE_EVENT phase_two}
    [/event]
    [event]
        name=phase_two
        {VARIABLE phase_two yes}
        #############################
        # URZA NALMATH
        #############################
        {REVEAL x,y,radius=12,4,3}
        {SCROLL_TO 12 4}
        {NAMED_UNIT 2 Rogue 8 1 "Urza Nalmath" _"Urza Nalmath" (
            canrecruit,facing,animate=yes,sw,yes
            [modifications]
                {TRAIT_RESILIENT}{TRAIT_STRONG}
            [/modifications]
        )}
        [object]
            {FILTER id="Urza Nalmath"}
            {EFFECT new_animation (id=urza_nalmath_black_magic
            [animation]
                apply_to=recruiting
                start_time=0
                [frame]
                    image="units/human-outlaws/rogue-defend-1.png:150"
                [/frame]
                [frame]
                    image="units/human-outlaws/rogue.png"
                    halo=halo/undead/dark-magic-[1~6].png:50
                    halo_x,halo_y=0,0
                [/frame]
                [frame]
                    image="units/human-outlaws/rogue-defend-1.png:150"
                [/frame]
                sound_start_time=-40
                [sound_frame]
                    sound=magic-dark.ogg
                [/sound_frame]
            [/animation])}
        [/object]
        {FORCEMOVE_DO 12 4 ({MOVE_UNIT id="Urza Nalmath" 12 4})}
        {MAGIC}
        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        {FADE_MUSIC_IN 100}
        {MAGIC}
        [message]
            speaker=Urza Nalmath
            message= _ "Ah, such a beautiful tingling in my fingertips! Intoxicating, exalting... the master’s magic whispers promises of life eternal, whispers beautiful secrets..."
        [/message]
        {MAGIC}
        {DELAY 250}
        [message]
            speaker=Urza Nalmath
            message= _ "But what’s this? I’ve arrived just in time, for we have guests, human guests! Welcome, welcome. I’m so pleased to have visitors, for I’ve seen nary a living soul since the last of my living followers joined the hordes of eternal unlife."
        [/message]

        [if] {HAVE_UNIT id,race=Ethiliel,elf}
            [then]
                [message]
                    speaker,image=Ethiliel,portraits/ethiliel-mad.webp
                    message= _ "Vermin! Scum! You black-souled degenerate! Where is your younger brother? What have you done with my sage Mebrin?"
                [/message]
                [message]
                    speaker=Urza Nalmath
                    message= _ "Ethiliel, I’m aghast! Have you not enjoyed our lovely times together? So many good memories... if only the master hadn’t instructed me to leave you intact, we could have had even more!"
                [/message]
                [message]
                    speaker=Urza Nalmath
                    message= _ "But that command was so many moons ago... now that the little bird has slipped her cage, perhaps the rules can be different, hmm?"
                [/message]
                [message]
                    speaker,image=Ethiliel,portraits/ethiliel-mad.webp
                    message= _ "You always were the cruelest of my captors, Urza Nalmath. May your creator have mercy on you now that I am free, for I will not!"
                [/message]
                [message]
                    speaker=Urza Nalmath
                    message= _ "Ethiliel, you poor, deluded girl. You of all people should know <b><i>just how many</i></b> undead I’ve raised up from the ruins of your little village. You and I and all your new human friends are going to have such <b><i>fun</i></b> together..."
                [/message]
            [/then]
            [else]
                {REVEAL x,y,radius=22,17,3}
                [message]
                    speaker,image=Ethiliel,portraits/ethiliel-mad.webp
                    message= _ "Vermin! Scum! You black-souled degenerate! You always were the cruelest of my captors, Urza Nalmath. May your creator have mercy on you once I get free, for I will not!"
                [/message]
                [message]
                    speaker=Urza Nalmath
                    message= _ "Ethiliel, I’m aghast! Have you not been enjoying our lovely times together? So many good memories... if only the master hadn’t instructed me to leave you intact, we could have had even more!"
                [/message]
                [message]
                    speaker=Urza Nalmath
                    message= _ "But I certainly can’t allow you to be freed by these human visitors. You of all people should know <b><i>just how many</i></b> undead I’ve raised up from the ruins of your little village. You and I and all your new human friends are going to have such <b><i>fun</i></b> together..."
                [/message]
            [/else]
        [/if]

        #############################
        # SPAWN UNDEAD
        #############################
        {MODIFY_TERRAIN Ker     12 4} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 13 4} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Qhh 12 3} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 12 5} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer     11 5} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 15 4} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 11 7} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 11 8} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 12 7} [redraw][/redraw]
        # spawncamping easter egg and discouragement
        [if]     {HAVE_UNIT( side,count=1,1-99 {FILTER_LOCATION x,y,radius=12,4,4} )}
            {OR({HAVE_UNIT( side,count=1,2-99 {FILTER_LOCATION x,y,radius=12,4,7} )})}
            [then]
                [message]
                    speaker=Urza Nalmath
                    message= _ "Wait a moment, did you humans know I was coming? You’re not supposed to be so close to my camp, not supposed to be here at all... No, this simply won’t do. I’ll have to raise a few more of my beauties to slow you down."
                [/message]
                {MAGIC} {FORCEMOVE_DO 13 4 ({GENERIC_UNIT 2 ({ON_DIFFICULTY Ghoul Ghoul      Ghoul     }) 13 4} {ANIMATE})}
                {MAGIC} {FORCEMOVE_DO 12 3 ({GENERIC_UNIT 2 ({ON_DIFFICULTY Ghoul Ghoul      Ghoul     }) 12 3} {ANIMATE})}
                {MAGIC} {FORCEMOVE_DO 12 5 ({GENERIC_UNIT 2 ({ON_DIFFICULTY Ghoul Ghoul      Necrophage}) 12 5} {ANIMATE})}
                {MAGIC} {FORCEMOVE_DO 11 5 ({GENERIC_UNIT 2 ({ON_DIFFICULTY Ghoul Necrophage Necrophage}) 11 5} {ANIMATE})}
                {MAGIC} {FORCEMOVE_DO 11 4 ({GENERIC_UNIT 2 ({ON_DIFFICULTY Ghoul Ghoul      Ghoul     }) 11 4} {ANIMATE})}
            [/then]
        [/if]

        {MAGIC} {GENERIC_UNIT 2 (Ghoul)          10  4} {FACING sw} {ANIMATE} {ZONE_GUARDIAN 10  4 x,y,radius=11,4,5}
        {MAGIC} {GENERIC_UNIT 2 (Ghoul)          15  4} {FACING se} {ANIMATE} {ZONE_GUARDIAN 15  4 x,y,radius=11,4,5}
        {MAGIC} {GENERIC_UNIT 2 (Necrophage)     12  7} {FACING se} {ANIMATE} {ZONE_GUARDIAN 12  7 x,y,radius=11,4,5}
        {GENERIC_UNIT 2 (Walking Corpse) 11  8} {FACING se} {ANIMATE} {ZONE_GUARDIAN 11  8 x,y,radius=11,4,5}
        {GENERIC_UNIT 2 (Walking Corpse) 11  7} {FACING sw} {ANIMATE} {ZONE_GUARDIAN 11  7 x,y,radius=11,4,5}
        {REVEAL x,y,radius=5,26,3}
        {NAMED_UNIT 3 Necrophage  1 28 necrophage3 "" (canrecruit=yes)}
        {MOVE_UNIT id=necrophage3 5 26}
        {MODIFY_TERRAIN Ker     5 26} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 6 26} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 6 25} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 4 24} [redraw][/redraw] {DELAY 150}
        {GENERIC_UNIT 3 (Ghoul)           1 24} {FACING ne} {ANIMATE} {GUARDIAN} # extra guards for the southwest leader, since he's the most accessible one
        {GENERIC_UNIT 3 (Walking Corpse)  1 26} {FACING ne} {ANIMATE} {GUARDIAN} # we don't want to make the optimal strategy to attack and hide in the corner
        {GENERIC_UNIT 3 (Walking Corpse)  2 25} {FACING ne} {ANIMATE} {GUARDIAN}
        {GENERIC_UNIT 3 (Ghoul)           1 21} {FACING ne} {ANIMATE} {GUARDIAN}
        {GENERIC_UNIT 3 (Walking Corpse)  3 21} {FACING ne} {ANIMATE} {GUARDIAN}
        {GENERIC_UNIT 3 (Walking Corpse)  4 19} {FACING ne} {ANIMATE} {GUARDIAN}
        {GENERIC_UNIT 3 (Ghoul)           4 24} {FACING ne} {ANIMATE} {ZONE_GUARDIAN  4 24 x,y,radius=5,27,4}
        {GENERIC_UNIT 3 (Walking Corpse)  5 27} {FACING nw} {ANIMATE} {ZONE_GUARDIAN  5 24 x,y,radius=5,27,4}
        {GENERIC_UNIT 3 (Walking Corpse)  6 24} {FACING nw} {ANIMATE} {ZONE_GUARDIAN  6 24 x,y,radius=5,27,4}
        {REVEAL x,y,radius=25,26,3}
        {NAMED_UNIT 4 Necrophage 30 28 necrophage4 "" (canrecruit=yes)}
        {MOVE_UNIT id=necrophage4 25 26}
        {MODIFY_TERRAIN Ker     25 26} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 26 25} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 25 25} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 24 26} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 23 25} [redraw][/redraw] {DELAY 150}
        {GENERIC_UNIT 4 (Ghoul)          23 25} {FACING nw} {ANIMATE} {ZONE_GUARDIAN 23 25 x,y,radius=26,26,4}
        {GENERIC_UNIT 4 (Walking Corpse) 27 28} {FACING nw} {ANIMATE} {ZONE_GUARDIAN 27 28 x,y,radius=26,26,4}
        {GENERIC_UNIT 4 (Walking Corpse) 23 28} {FACING ne} {ANIMATE} {ZONE_GUARDIAN 23 28 x,y,radius=26,26,4}
        {REVEAL x,y,radius=38,17,3}
        {NAMED_UNIT 5 Necrophage 38 21 necrophage5 "" (canrecruit=yes)}
        {MOVE_UNIT id=necrophage5 38 17}
        {MODIFY_TERRAIN Ker     38 17} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 39 17} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 38 16} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Cer^Edt 37 17} [redraw][/redraw] {DELAY 150}
        {GENERIC_UNIT 5 (Ghoul)          37 15} {FACING nw} {ANIMATE} {ZONE_GUARDIAN 37 15 x,y,radius=38,16,3}
        {GENERIC_UNIT 5 (Walking Corpse) 35 18} {FACING ne} {ANIMATE} {ZONE_GUARDIAN 36 18 x,y,radius=38,16,3}
        {GENERIC_UNIT 5 (Walking Corpse) 37 19} {FACING nw} {ANIMATE} {ZONE_GUARDIAN 38 19 x,y,radius=38,16,3}
        # create some nearby undead to harry the player, before the recruited units arrive en masse
        {REPEAT {ON_DIFFICULTY 1 2 4} (
            {GENERIC_UNIT 2 "Walking Corpse" 34 15} {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 16 28} {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse"  8 20} {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 10 12} {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 20 5}  {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 31 7}  {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 5 26}  {ANIMATE}
        )}

        # make it harder to camp in the top-right corner (this is also why the terrain there is poor)
        {REPEAT {ON_DIFFICULTY 0 1 3} (
            {GENERIC_UNIT 2 "Ghoul"          38 1} {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 38 1} {ANIMATE}
            {GENERIC_UNIT 2 "Walking Corpse" 38 1} {ANIMATE}
        )}

        #############################
        # PREPARE NEW GAME-STATE
        #############################
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [modify_turns]
            value=16 # turns end at the start of 17, which is dawn
        [/modify_turns]
        {SAY_COMPANION
        MESSAGE_MARI=_"It’s an ambush! I’d hoped to never again see undead in these terrible numbers..."
        MESSAGE_GERRICK=_"’tis an ambush! I’ve never e’en heard o’ so many elven undead!"
        MESSAGE_HYLAS=_"We are ambushed! Never-before have I seen so many elven undead."
        }
        [message]
            speaker=Deoran
            message= _ "Even the largest hordes have their limits — we must defend these ruins until this bandit’s magic runs low! Prepare for battle, soldiers of the South Guard, and brace for incoming attack!"
        [/message]
        [display_tip]
            title=_"Turn Limits"
            image=tutor/turns.png
            message=_"Most scenarios have a turn limit, as
shown in the upper left-hand corner.
Usually, running out of turns will
result in defeat — check your
<i><b>objectives</b></i> by clicking the <i><b>“Menu”</b></i>
button in the top-left corner 
(or use the hotkey <i><b>Ctrl+J</b></i>).

Finishing early will usually reward 
a gold boost (“early finish bonus”) 
in the next scenario, so don’t delay!

<i><b>In this scenario, your objective is 
to survive until turns run out.</b></i>"
        [/display_tip]
        {VARIABLE sg_turns_explained yes}
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        [event]
            name=side 1 turn end
            {FIRE_EVENT recruit_hint}
        [/event]
    [/event]

    #######################################################################################################################################################
    #                                                                 TIPS AND MISC EVENTS
    #######################################################################################################################################################
    #############################
    # TIP: FOG
    #############################
    [event]
        name=side 1 turn 2 end
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes} )}
        [message]
            speaker=Deoran
            message= _ "I’m not used to fighting in fog like this! What a mess..."
        [/message]
        [display_tip]
            title=_"Fog and Vision"
            image=tutor/fog.png
            message=_"In fog, <b><i>units can see 1 hex further
than their movement</i></b>. Fast units,
such as Deoran, make for great
scouts.

Clearing fog will prevent you from
using “undo”, so be careful where
you move!"
        [/display_tip]
    [/event]

    #############################
    # TIP: CLIFFS
    #############################
    [event]
        name=side 1 turn 4 end
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes} )}
        [display_tip]
            title=_"Bluffs and Gulches"
            image=tutor/bluffs.png
            message=_"Have you been wondering
what effect these cliffs
have on gameplay?

They... don’t actually
do anything. But they
do look pretty! <i>(or at
least we devs think so)</i>"
        [/display_tip]
    [/event]

    #############################
    # TIP: INCOME AND SUPPORT
    #############################
    [event]
        name=side 1 turn 11 end # recruit_hint fires on the first turn after phase_two, so try to avoid giving two hints on the same turn
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes} )}
        # we mentioned this in S01, but bring it up again since the player had a lot of more important things to learn in S01
        [display_tip]
            title=_"Income and Upkeep"
            image=tutor/gold.png
            message=_"Each village you own generates 1 gold per
turn, and supports 1 unit’s worth of upkeep.
Level 2 units cost 2 upkeep, level 3 units 
cost 3 upkeep, etc.

To ensure a healthy supply of gold, 
capture as many villages as you can!"
        [/display_tip]
    [/event]

    #############################
    # EMERGENCY GOLD BOOST
    #############################
    # give enemies a small gold boost when you get near them
    # not massive, but enough that they at least appear to be fighting back
#define EMERGENCY_GOLD_BOOST SIDE AMOUNT
    [event]
        name=moveto
        {FILTER side=1}
        {FILTER_CONDITION({HAVE_UNIT( side,count=1,3-99 {FILTER_LOCATION( radius=6 {FILTER side,canrecruit,radius={SIDE},yes} )} )})}
        [gold]
            side={SIDE}
            amount={AMOUNT}
        [/gold]
    [/event]
    [event]
        name=moveto
        {FILTER side=1}
        {FILTER_CONDITION({HAVE_UNIT( side,count=1,4-99 {FILTER_LOCATION( radius=2 {FILTER side,canrecruit,radius={SIDE},yes} )} )})}
        [gold]
            side={SIDE}
            amount={AMOUNT}
        [/gold]
    [/event]
#enddef
    {EMERGENCY_GOLD_BOOST 2 {ON_DIFFICULTY 10 15 20}}
    {EMERGENCY_GOLD_BOOST 3 {ON_DIFFICULTY 10 15 20}}
    {EMERGENCY_GOLD_BOOST 4 {ON_DIFFICULTY 10 15 20}}
    {EMERGENCY_GOLD_BOOST 5 {ON_DIFFICULTY 10 15 20}}
    #############################
    # REMIND ABOUT RECRUITING
    #############################
    [event]
        name=recruit
        {FILTER side=1}
        {VARIABLE s03_units_recruited yes}
    [/event]
    [event]
        name=recall
        {FILTER side=1}
        {VARIABLE s03_units_recalled yes}
    [/event]
    [event]
        name=recruit_hint
        {FILTER_CONDITION(
            {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
            {VARIABLE_CONDITIONAL s03_units_recalled not_equals yes}
        )}
        [if] {VARIABLE_CONDITIONAL s03_units_recruited not_equals yes}
            [then]
                [message]
                    speaker=Deoran
                    message= _ "I will need to recruit units if I want to weather the undead assault! I should first move to a keep, then press <b>Ctrl+R</b> to recruit or <b>Alt+R</b> to recall."
                [/message]
                {TUTORIAL_ARROW 18 18}
                {TUTORIAL_ARROW 16 15}
                [event]
                    name=recruit
                    {FILTER side=1}
                    {REMOVE_ARROW}
                [/event]
                [event]
                    name=clear_tips
                    {REMOVE_ARROW}
                [/event]
            [/then]
            [else]
                [message]
                    speaker=Deoran
                    message= _ "I have recruited fresh soldiers, but not yet recalled any of my veterans! If I have high-XP survivors from my previous battles, I should press <b>Alt+R</b> to recall them so they can continue gaining experience."
                [/message]
            [/else]
        [/if]
    [/event]

    #############################
    # EXPLAIN POISON
    #############################
    [event]
        name=sighted
        first_time_only=no
        {FILTER type=Ghoul}
        {FILTER_SECOND side=1}
        [event]
            name=side 1 turn end
            {FILTER_CONDITION(
                {VARIABLE_CONDITIONAL sg_ghoul_info not_equals yes}
                {HAVE_UNIT(
                    type=Ghoul
                    [filter_vision]
                        side=1
                    [/filter_vision]
                )}
            )}
            {VARIABLE sg_ghoul_info yes}
            [message]
                type=Ghoul
                [filter_vision]
                    side=1
                [/filter_vision]
                message= _ "Guuuhhh..."
            [/message]
            [message]
                speaker=Deoran
                message= _ "What manner of undeath have you inflicted upon this poor elf! This is even worse than the walking corpses we’ve already fought, if such a thing is possible."
            [/message]
            [message]
                speaker=Urza Nalmath
                message= _ "Undeath!? You offend me, good sir — this lovely lady is still alive... although come to think of it, she might wish she weren’t. Such a supple body; such an alluring voice. Isn’t she charming?"
            [/message]
            [message]
                type=Ghoul
                [filter_vision]
                    side=1
                [/filter_vision]
                message= _ "Graaahhh..."
            [/message]
            {SAY_COMPANION
            MESSAGE_MARI=_"Just what we needed: ghouls. I’ve fought these things before, and I don’t miss the smell. But the worst part is their claws — one scratch and you’ll be poisoned until healed at a village, or by a healer like Ethiliel."
            MESSAGE_GERRICK=_"By Haldric, they’re real! The old-timers used to talk about fighting bloated, half-dead, half-alive “ghouls”... they say it takes but one scratch to poison a man half-dead, unless healed at a village or by a healer like Ethiliel."
            MESSAGE_HYLAS=_"A most putrid creation: ghouls. The corruption is spreading; we must act carefully. Be wary of their claws, Deoran — one scratch and you’ll be poisoned until healed at a village, or by a healer like me or Ethiliel."
            }
            [if] {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                [then]
                    [display_tip]
                        title=_"Poison"
                        image=tutor/poison.png
                        message=_"Ghouls inflict <i><b>poison</b></i> whenever they
damage one of your units. A poisoned
unit will lose <i><b>8 hitpoints</b></i> at the start
of every turn. Poison can never kill a unit,
but it can reduce them to 1 hitpoint!

<i><b>Receiving healing</b></i> from a village or
a healer (such as Ethiliel) will
<i><b>cure poison.</b></i>"
                    [/display_tip]
                [/then]
            [/if]
        [/event]
    [/event]

    #############################
    # EXPLAIN POISON (AGAIN)
    #############################
    [event]
        name=new turn
        {FILTER_CONDITION(
            {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
            {HAVE_UNIT( side,count,status=1,5-99,poisoned )}
        )}
        [message]
            speaker=Deoran
            message= _ "So many of my soldiers are poisoned! I should end their turn on a village or next to Ethiliel, so they can begin to recover."
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                     VICTORY
    #######################################################################################################################################################
    [event]
        name=time over
        [message]
            speaker,image=Deoran,portraits/deoran-glad.webp
            message= _ "Look! The fog is fading! I think we’ve survived the attack!"
        [/message]
        [modify_side]
            side,fog=1,no
        [/modify_side]
        {FIRE_EVENT ending_cutscene}
    [/event]
    [event]
        name=last breath
        {FILTER id="Urza Nalmath"}
        {ACHIEVE s03}
        {MODIFY_UNIT id="Urza Nalmath" hitpoints 11}
        {FIRE_EVENT ending_cutscene}
    [/event]
    [event]
        name=ending_cutscene
        #############################
        # GURANTEE UNIT POSITIONS
        #############################
        {PUT_TO_RECALL_LIST x,y=10,4}
        {PUT_TO_RECALL_LIST x,y=11,5}
        {PUT_TO_RECALL_LIST x,y=12,5}
        {PUT_TO_RECALL_LIST x,y=13,4}
        {PUT_TO_RECALL_LIST x,y=13,5}
        {RECALL_XY Deoran 15 7}
        {RECALL_XY $companion_id 15 7}
        {RECALL_XY Ethiliel 15 7}
        {PUT_TO_RECALL_LIST x,y=12,4}
        {RECALL_XY "Urza Nalmath" 12 4}
        {MOVE_UNIT id="Urza Nalmath" 12 4}
        #############################
        # SUMMONING SKELETONS
        #############################
        [message]
            speaker=Urza Nalmath
            message= _ "No, my magic is waning! The beautiful whispers are fading! My hands shake, my face sweats; I need you back, please... I can’t bear to experience the world like this!"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "More power, I need more powerful minions. More power will exalt me again, intoxicate me again! The others warned me not to, but the master always told me what I needed to know. Yes, yes!"
        [/message]
        {MAGIC} {GENERIC_UNIT 2 Revenant          13 4} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Skeleton          12 3} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 "Skeleton Archer" 12 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Deathblade        11 5} {ANIMATE}
        {SAY_COMPANION
        MESSAGE_MARI=_"Skeletons! Watch out, Deoran, these things are nasty!"
        MESSAGE_GERRICK=_"Look sharp, skeletons! Those old bones are comin’ straight for us!"
        MESSAGE_HYLAS=_"Skeletons. The darkness grows."
        }

        #############################
        # SKELETONS TURN ON NALMATH
        #############################
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND type=Deathblade}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,damage_type=7,blade
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND type=Skeleton}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,damage_type=7,blade
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "Nnrrgh!! No, I created you! Attack them, not me! The master never taught me how to control these things!"
        [/message]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND type=Revenant}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,damage_type=7,blade
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "You won’t even exist without me! My power is what keeps you standing! You’re sealing your own re-deaths!"
        [/message]
        [message]
            type=Revenant # because its portrait is pretty
            message= _ "More... power..."
        [/message]
        [message]
            type=Deathblade # because its portrait is pretty
            message= _ "More... death..."
        [/message]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND type=Deathblade}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,damage_type=999,blade
            animate,delay=yes,0
            kill=yes
        [/harm_unit]
        {KILL type=Skeleton          ANIMATE=yes}
        {KILL type="Skeleton Archer" ANIMATE=yes}
        {KILL type=Deathblade        ANIMATE=yes}
        {KILL type=Revenant          ANIMATE=yes}
        {KILL side=2,3,4,5}
        {FADE_MUSIC_OUT 1000}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}
        #############################
        # TIME TO GO FIND MEBRIN
        #############################
        [if] {HAVE_UNIT id,race=Ethiliel,elf}
            [then]
                [message]
                    speaker,image=Deoran,portraits/deoran-mad.webp
                    message= _ "Slain by his own creations; a fitting end for such a villain! Good riddance to him."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "As for you, Ethiliel, you have endured much. I know this was just a small settlement in comparison to the great elven forests, but they were still your friends."
                [/message]
            [/then]
            [else]
                # if the player has deliberately not freed Ethiliel, free her now
                {KILL type=Cage ANIMATE=yes FIRE_EVENT=yes}
                [message]
                    speaker,image=Deoran,portraits/deoran-sad.webp
                    message= _ "Ethiliel, you have endured much. I know this was just a small settlement in comparison to the great elven forests, but they were still your friends."
                [/message]
            [/else]
        [/if]
        [message]
            speaker=Deoran
            message= _ "Come, let us remove you from this accursed place. My men and I will be happy to escort you north to the Aethenwood, where you will be among more of your kind and safe from any further harm."
        [/message]
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "...Ethiliel? I know you must be distraught to be the last of your town, but—"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Distraught? <b><i>Distraught!?</i></b> I am vengeful! I am NOT the last of the valefolk — do not forget that our great sage Mebrin yet lives. I saw him dragged off in chains, taken south from here towards the Black Forest."
        [/message]
        {SAY_COMPANION
        MESSAGE_MARI=_"I know it’s tough to accept, Ethiliel, but if your sage was taken into the Black Forest he’s probably not coming back out. You say it’s been months, and neither the Urza brothers nor their mysterious “master” seem the type to take prisoners — present company excluded."
        MESSAGE_GERRICK=_"Aye, he were alive then, but is he now? The Black Forest, Ethiliel... an’ you say it’s been months? Neither th’ Urza brothers nor tha’ mysterious “master” seem th’ type t’ take prisoners — present company aside, o’ course."
        MESSAGE_HYLAS=_"I fear the odds are not in your sage’s favor, Ethiliel. The Black Forest oft attracts evil, and neither the Urza brothers nor their mysterious “master” have shown an inclination for prisoners — present company excluded."
        }
        [message]
            speaker=Ethiliel
            message= _ "Do not speak ill of that which you do not understand, human. My teacher may be old, but I know him to be clever and resilient: a master of magic, both the light and the dark, and held in the highest esteem by all from the Aethenwood. We must not abandon the last of my friends to an uncertain fate — shall you not help me find him and rescue him?"
        [/message]
        {DELAY 500}
        {SAY_COMPANION SPEAKER=Deoran
        MESSAGE_MARI=_"I must agree with Captain Mari about this Mebrin’s poor odds... And it truly would be a great risk for us to venture so far afield, isolated from Westin and in unknown territories."
        MESSAGE_GERRICK=_"I must agree with Sir Gerrick about this Mebrin’s poor odds... And it truly would be a great risk for us to venture so far afield, isolated from Westin and in unknown territories."
        MESSAGE_HYLAS=_"I must agree with Minister Hylas about this Mebrin’s poor odds... And it truly would be a great risk for us to venture so far afield, isolated from Westin and in unknown territories."
        }
        [message]
            speaker=Deoran
            message= _ "But despite the danger, my instinct is to help. One Urza brother yet remains. If we can find and catch him in the Black Forest, we could finally put an end to all this necromancy! And if Mebrin really does still live, then rescuing him is simply the right thing to do."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Ethiliel, we’ll go."
        [/message]

        {CLEAR_VARIABLE s03_units_recruited,s03_units_recalled,phase_two}
        [endlevel]
            result=victory
            bonus=yes # usually 0 because turns are over, but if we rushed down the bandit we may get a bonus
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]

#undef BANDIT_SIDE
#undef MAGIC
#undef TURN_LIMIT
#undef UNDEAD_SIDE
