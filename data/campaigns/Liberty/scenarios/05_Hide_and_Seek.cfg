[scenario]
    #textdomain wesnoth-l

    id=hide_and_seek
    name= _ "Hide and Seek"
    map_data="{campaigns/Liberty/maps/hide_and_seek.map}"
    {TURNS 34 28 20}

    next_scenario=the_gray_woods
    {SCENARIO_MUSIC "frantic.ogg"}
    victory_when_enemies_defeated=no

    [story]
        [part]
            music="battle.ogg"
            show_title=yes
            background="maps/wesnoth.png"
            {DOT 135 204}
            {DOT 150 210}
            {DOT 164 223}
            {CROSS 176 225}
        [/part]
    [/story]

    [time]
        id=midnight
        name= _ "Midnight"
        image=schedule-midnight.png
        lawful_bonus=-25
    [/time]

    [side]
        type=Bandit
        description=Baldras
        side=1
        canrecruit=1
        controller=human
        recruit=Thug,Footpad,Poacher
        gold=100
        team_name=good_guys
        shroud=yes
        fog=yes
        share_maps=no
        share_view=no
    [/side]

    [side]
        type=Lieutenant
        description=Quentin
        user_description= _ "Quentin"
        side=2
        canrecruit=1
        controller=ai
        team_name=bad_guys
        [ai]
            passive_leader=yes
        [/ai]
        shroud=yes
        fog=yes
    [/side]
    
    {STARTING_VILLAGES 2 99}

    [side]
        type=Rogue
        description=Hans
        user_description= _ "Hans"
        side=3
        canrecruit=1
        controller=ai
        facing=sw
        [ai]
            passive_leader=yes
        [/ai]
        team_name=good_guys
        shroud=yes
        fog=yes
        share_maps=no
        share_view=no
    [/side]

    #
    # Prestart events
    #
    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _ "Take Baldras to meet the leader of the insurgency"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Baldras"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Harper"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
        [/objectives]
        
        [store_unit]
            [filter]
                description=Baldras
            [/filter]

            kill=yes
            variable=stored_Baldras
        [/store_unit]

        [remove_shroud]
            side=1
            x=1-20,4-8,5,7
            y=1-5,6-10,11,11
        [/remove_shroud]

        #sign to mark the victory location
        {PLACE_IMAGE scenery/signpost.png 20 45}
        #some various city props
        {PLACE_IMAGE scenery/well.png 10 35}
        
        {PLACE_IMAGE items/scarecrow.png 15 22}

        {PLACE_IMAGE items/straw-bale1.png 1 21}
        {PLACE_IMAGE "items/straw-bale2.png~FL(horiz)" 2 21}
        {PLACE_IMAGE "items/straw-bale1.png~FL(horiz)" 1 22}
        
        {PLACE_IMAGE "items/archery-target-right.png~FL(horiz)" 10 43}
        {PLACE_IMAGE "items/archery-target-right.png~FL(horiz)" 11 44}
        {PLACE_IMAGE "items/archery-target-right.png~FL(horiz)" 8 43}

        #place the hiders...
        [unit]
            type=Thief
            side=3
            x,y=16,5
            random_traits=yes
            description=Amman
            user_description= _ "Amman"
            facing=sw
            ai_special=guardian
        [/unit]
        [unit]
            type=Thief
            side=3
            x,y=18,16
            random_traits=yes
            description=Link
            user_description= _ "Link"
            facing=sw
            ai_special=guardian
        [/unit]
        [unit]
            type=Thief
            side=3
            x,y=1,28
            random_traits=yes
            description=Porus
            user_description= _ "Porus"
            ai_special=guardian
        [/unit]

        #...and the seekers
#define SEEKER X Y TYPE
    [unit]
        type={TYPE}
        generate_description=yes
        x,y={X},{Y}
        side=2
        ai_special=guardian
        random_traits=yes
    [/unit]
#enddef

        #guarding the woods
        {SEEKER 5 13 Halberdier}
        {SEEKER 7 12 (Pikeman)}
        {SEEKER 7 14 (Heavy Infantryman)}
        {SEEKER 1 12 (Shock Trooper)}
        {SEEKER 20 11 (Heavy Infantryman)}

        #main gate
        {SEEKER 8 25 (Shock Trooper)}
        {SEEKER 12 25 Halberdier}
        {SEEKER 9 30 (Pikeman)}
        {SEEKER 10 30 (Iron Mauler)}
        {SEEKER 11 30 (Shock Trooper)}

        #east gate
        {SEEKER 15 33 (Iron Mauler)}
        {SEEKER 18 34 (Shock Trooper)}
        {SEEKER 16 29 (Heavy Infantryman)}

        #guarding the LT
        {SEEKER 3 42 (Pikeman)}
        {SEEKER 5 42 (Shock Trooper)}
        {SEEKER 6 41 (Iron Mauler)}
#ifdef EASY
        {SEEKER 7 42 (Bowman)}
        {SEEKER 9 45 (Bowman)}
#endif
#ifdef NORMAL
        {SEEKER 7 42 (Bowman)}
        {SEEKER 9 45 (Bowman)}
#endif
#ifdef HARD
        {SEEKER 7 42 (Bowman)}
        {SEEKER 9 45 (Bowman)}
#endif
    [/event]

    #
    # Starting conversation and actions
    #
    [event]
        name=start
        
        [message]
            speaker=narrator
            message= _ "Relentlessly pursued by riders patrolling the road to Elensefar, Baldras and his men traveled unseen along the swampy banks of the Great River to the city of Carcyn."
            image="wesnoth-icon.png"
        [/message]
        [message]
            speaker=narrator
            message= _ "They hid until nightfall, then crept out to find the help Lord Maddock hinted was here."
            image="wesnoth-icon.png"
        [/message]
        
        [move_unit_fake]
            side=1
            type=Boat
            x=1,6
            y=4,4
        [/move_unit_fake]

        [item]
            x,y=6,4
            image=units/transport/boat.png
        [/item]

        [move_unit_fake]
            side=1
            type=$stored_Baldras.type
            x=6,6
            y=4,5
        [/move_unit_fake]

        [unstore_unit]
            variable=stored_Baldras
        [/unstore_unit]

        [recall]
            description=Harper
            x,y=7,5
        [/recall]
        
        [message]
            description=Baldras
            message= _ "I'm not sure where we're supposed to go now. If we go into town we can start asking around for information."
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            side=2
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "Looks like there are guards stationed around the town. It looks like they hold stationary posts, so if we're careful enough we should be able to slip our way around them."
        [/message]
        [message]
            description=Baldras
            message= _ "Harper, you younger and faster folks need to be our eyes now. Scout ahead and try to find a way for us to get past the guards, but make sure to not stay where they can see you or we're all in big trouble..."
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            x,y=5,13
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            description=Harper
            message= _ "Wait - I hear something..."
        [/message]

        [message]
            x,y=5,13
            message= _ "I'm glad we finally get to spend some time near a city.  I was sick of marching through swamps and woods chasing down locals. If this terrorist shows up at Carcyn I'll put his head at the end of my pole."
        [/message]
        [message]
            x,y=7,12
            message= _ "If we let him into the city, the commander will put our heads on poles... damn moonless night! Did you hear something?"
        [/message]
        [message]
            x,y=5,13
            message= _ "Umm, I don't know. It is pitch black out there..."
        [/message]
        [message]
            x,y=5,13
            message= _ "I don't see anything. Let's keep going."
        [/message]
        [message]
            description=Baldras
            message= _ "I think we need to find a way to sneak past these patrols. We would be slaughtered if we tried to fight them."
        [/message]
        [message]
            description=Harper
            message= _ "Let's go around then."
        [/message]
    [/event]

    #
    # Special event - if you are attacked, set a switch.  This will affect the conversations you have with the thieves
    #
    {VARIABLE sneak_attacked 0}
    [event]
        name=attack
        [filter]
            side=2
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        {VARIABLE sneak_attacked 1}
        [message]
            speaker=second_unit
            message= _ "They've seen us, RUN!"
        [/message]
    [/event]

    [event]
        name=attack_end
        [filter]
            side=2
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {IF_VARIABLE $second_unit.hitpoints greater_than 0 (
        [then]
            [message]
                speaker=Baldras
                message= _ "Fall back, quickly! Maybe we can yet lose them!"
            [/message]
        [/then]
        )}
    [/event]

    #
    # Special events - when you see thieves, they talk to you
    #
    [event]
        name=sighted
        [filter]
            description=Amman
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "Who is that?"
        [/message]
        [message]
            speaker=unit
            message= _ "I have come to find you.  You must make it into the city without being seen. The soldiers are normally out hunting for my kind, but a company of heavy infantry arrived three days ago and took over the patrols."
        [/message]
        [message]
            speaker=second_unit
            message= _ "They're looking for us."
        [/message]
        [message]
            speaker=unit
            message= _ "Well, good thing I found you first. Now hurry."
        [/message]
        [if]
            [variable]
                name=sneak_attacked
                numerical_equals=1
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "No, THEY found us first! Let's go!"
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=sighted
        [filter]
            description=Link
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=unit
            message= _ "Shhhhh!! I could hear you coming from bottom of the city dungeon."
        [/message]
        [message]
            speaker=second_unit
            message= _ "I can barely see where we are going. Is the city near?"
        [/message]
        [message]
            speaker=unit
            message= _ "Yes, just south of here.  You should avoid the main gate.  The west gate is heavily traveled but is less guarded than the east gate. Try to sneak in that way."
        [/message]
        [if]
            [variable]
                name=sneak_attacked
                numerical_equals=1
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "Unfortunately, they know we are here already. We can only hope that the cover of night will be adequate despite their stepped-up efforts to find us."
                [/message]
            [/then]
        [/if]
    [/event]
    [event]
        name=sighted
        [filter]
            description=Porus
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=unit
            message= _ "Hello, our leader is on the other side of the city."
        [/message]
        [if]
            [variable]
                name=sneak_attacked
                numerical_equals=1
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "We already tangled with some guards.  The city is probably swarming with soldiers by now. We cannot go that way. "
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "We have to go through the city? Impossible!"
                [/message]
            [/else]
        [/if]
        [message]
            speaker=unit
            message= _ "You must.  Make a run for it if you have to.  There is a small path that leads out of the city to the southeast and into the forest; look for the signpost. My brother Hans is waiting for you at that gate so he can take you to our master."
        [/message]
    [/event]
    [event]
        name=sighted
        [filter]
            description=Hans
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=unit
            message= _ "Gentlemen, please come this way and follow the path into the forest. Our leader is anxious to meet you."
        [/message]
        [message]
            speaker=second_unit
            message= _ "As soon as we escape the Wesnoth death squad, we will be happy to oblige."
        [/message]
        [message]
            speaker=Baldras
            message= _ "I haven't run this much in years. If you were to ask me to infiltrate a heavily guarded city relying on nothing but the cover of darkness and my wits, I would say you were crazy."
        [/message]
        [message]
            speaker=Baldras
            message= _ "As it turns out, I'm the crazy one. Let's finish this folly."
        [/message]
    [/event]

    #
    # Special event - if someone besides Baldras goes to the end, you get a
    # message
    #
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=20
            y=45
            [not]
                description=Baldras
            [/not]
        [/filter]

        [message]
            description=Hans
            message= _ "You can come if you wish, but the leader is only interested in speaking to Baldras."
        [/message]
    [/event]

    #
    # Victory
    #
    [event]
        name=moveto
        [filter]
            x=20
            y=45
            description=Baldras
        [/filter]
        [message]
            speaker=Hans
            message= _ "Fly, and we may yet evade them in the Gray Woods."
        [/message]
        [message]
            speaker=Baldras
            message= _ "Lead the way..."
        [/message]
        {CLEAR_VARIABLE sneak_attacked}
        [endlevel]
            result=continue
            bonus=no
        [/endlevel]
    [/event]

    #
    # Loss conditions - turns run out
    #
    [event]
        name=time over
        [message]
            description=Baldras
            message= _ "We have spent too much time here.  Surely the Queen's forces have returned to Dallben. Our mission is unfinished, but we must return to fight a suicide battle."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    {LIBERTY_DEATHS}
[/scenario]
