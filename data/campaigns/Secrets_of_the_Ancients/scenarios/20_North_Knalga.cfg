#textdomain wesnoth-sota

# There is a lot of terrain dedicated to this map. There is a twinkling overlay, two
# versions of a stone gate, and a passable hex that looks very small to represent a
# narrow passage. The twinkling overlay is pretty generic, but for the others, no attempt
# has been made to make them work anywhere other than where they are drawn.

[scenario]
	name= _ "North Knalga"
	map_data="{campaigns/Secrets_of_the_Ancients/maps/North_Knalga.map}"

	id=20_North_Knalga
	next_scenario=21_Against_the_World
	
	[story]
		[part]
			story= _ "27 VI, 23 YW

We left the fires of the mountain behind and plunged once more into darkness. After a long trek, we were brought up short by a dead end in the tunnel...but the wall was not solid."
		[/part]
		{JOURNEY_PART 20}
	[/story]
	
	{UNDERGROUND}
	{DEFAULT_MUSIC_PLAYLIST}
	{TURNS 32 31 30}
	
	[side]
		{SIDE_1_BOTH}
		# The player should have a lot of gold after the last scenario, so:
		{GOLD 100 40 20}
		shroud=yes
	[/side]

	[side]
		side=2
		controller=ai
		user_team_name= _ "Dwarves"
		team_name=bad
		type=Dwarvish Lord
		name= _ "Golbanduth"
		id=Golbanduth
		{GOLD 600 800 1000}
		recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Lord, Dwarvish Thunderguard, Dwarvish Pathfinder, Dwarvish Runesmith
		# The castle tiles are connected through two posts (stone walls), but that
		# means the AI could recruit on the posts. These two units sit on those
		# locations in order to prevent that. In prestart, they will be hidden and
		# petrified so they don't affect the gameplay.
		[unit]
			x,y=18, 26
			type=Dummy
		[/unit]
		[unit]
			x,y=22, 26
			type=Dummy
		[/unit]
		{FLAG_VARIANT knalgan}
	[/side]
	{STARTING_VILLAGES 2 10}

	{ANIMATED_MAUSOLEUM 33 4}
	{ANIMATED_MAUSOLEUM 33 6}
	{ANIMATED_MAUSOLEUM 33 8}

# *************************** PRESTART ***************************
	[event]
		name=prestart
		
		[objectives]
			side=1
			[objective]
				description= _ "Defeat the enemy leader"
				condition=win
			[/objective]

			{HOW_TO_LOSE_WITH_BOTH}

			[gold_carryover]
				bonus=yes
				carryover_percentage=40
			[/gold_carryover]
		[/objectives]
		
		[hide_unit]
			id=Ardonna
		[/hide_unit]
		
		[petrify]
			type=Dummy
		[/petrify]
		[hide_unit]
			type=Dummy
		[/hide_unit]
		
		# Add a few miners to the Crystal Caves for flavor. They will run away as the
		# player approaches, but could be used to level up a unit.
		[store_locations]
			x=3-25
			y=1-11
			terrain=!,X*
			variable=possible_dwarf_locations
		[/store_locations]
		
		{REPEAT 4 (
				# Choose a location by selecting an array index:
				[set_variable]
					name=location_index
					rand="0..$($possible_dwarf_locations.length-1)"
				[/set_variable]

				[unit]
					type=Dwarvish Miner
					x=$possible_dwarf_locations[$location_index].x
					y=$possible_dwarf_locations[$location_index].y
					side=2
				[/unit]
		)}
		
		[clear_variable]
			name=possible_dwarf_locations, location_index, dwarf_index
		[/clear_variable]
		
		# Add one more miner who will have some dialog:
		[unit]
			type=Dwarvish Miner
			placement=map_passable
			x,y=25,12
			side=2
			id=spotter
		[/unit]
		
		# All miners run away from side 1 because they are not soldiers.
		[micro_ai]
			side=2
			action=add
			ai_type=coward
			distance=4
			attack_if_trapped=yes  # In case running away doesn't work.
			[filter]
				type=Dwarvish Miner
			[/filter]
		[/micro_ai]
		
		# Unit that will go get more gold for the leader.
		[unit]
			type=Dwarvish Berserker
			x,y=19,27
			id=porter
			side=2
		[/unit]
		{FREEZE_UNIT porter}
		
		# We want the dwarves to reach the caves ahead of the player's units, but
		# player 1 gets a head start. To compensate for that, we will give side 2 an
		# initial castle-full of recruits. In effect, side 2 goes first. The player
		# doesn't see that because of the shroud, so it doesn't need to be explained.
		{REPEAT 11 (
			{FIND_CASTLE_HEX 2 location}
			[set_variable]
				name=dwarf_type
				rand=Dwarvish Steelclad, Dwarvish Lord, Dwarvish Thunderguard, Dwarvish Pathfinder, Dwarvish Runesmith
			[/set_variable]
			[unit]
				type=$dwarf_type
				side=2
				x=$location.x
				y=$location.y
			[/unit]
		)}
		[clear_variable]
			name=dwarf_type
		[/clear_variable]
		
		[item]
			image=scenery/rune4.png
			x,y=32,15
		[/item]

# ----- Hall of Heroes -----
		[item]
			image=items/coffin-dwarf.png~FL()
			x,y=36,2
		[/item]
		[item]
			image=items/coffin-dwarf.png
			x,y=30,2
		[/item]
		[item]
			image=items/coffin-dwarf.png~FL()
			x,y=36,4
		[/item]
		[item]
			image=items/coffin-dwarf.png
			x,y=30,4
		[/item]
		[item]
			image=items/coffin-dwarf.png~FL()
			x,y=36,6
		[/item]
		[item]
			image=items/coffin-dwarf.png
			x,y=30,6
		[/item]
		[item]
			image=items/coffin-dwarf.png~FL()
			x,y=36,8
		[/item]
		[item]
			image=items/coffin-dwarf.png
			x,y=30,8
		[/item]
		# These images are statues. They are scaled so they are larger than life.
		[item]
			image=units/dwarves/dragonguard/dragonguard-se-blade-defend1.png~GS()~SCALE(90,90)~CROP(0,20,60,60)
			x,y=31,3
		[/item]
		[item]
			image=units/dwarves/explorer-ranged-1.png~FL()~GS()~SCALE(90,90)~CROP(0,15,70,70)
			x,y=35,3
		[/item]
		[item]
			image=units/dwarves/lord.png~GS()~SCALE(90,90)~CROP(0,20,70,60)
			x,y=31,5
		[/item]
		[item]
			image=units/dwarves/dragonguard/dragonguard-s-ranged6.png~FL()~GS()~SCALE(90,90)~CROP(0,30,65,60)
			x,y=35,5
		[/item]
		[item]
			image=units/dwarves/arcanister.png~GS()~SCALE(90,90)~CROP(0,20,70,60)
			x,y=31,7
		[/item]
		[item]
			image=units/dwarves/sentinel.png~FL()~GS()~SCALE(90,90)~CROP(0,20,66,60)
			x,y=35,7
		[/item]
		[item]
			image=units/dwarves/explorer-melee-3.png~FL()~GS()~SCALE(90,90)~CROP(0,20,85,60)
			x,y=35,9
		[/item]
		[item]
			image=units/dwarves/lord-se-axe2.png~GS()~SCALE(90,90)~CROP(0,10,60,60)
			x,y=31,9
		[/item]

		# The statues are not passable, but we want the player to be able to *see*
		# behind them, so we'll remove the shroud in those hexes.
		[remove_shroud]
			radius=1
			x,y=36,2
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=30,2
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=36,4
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=30,4
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=36,6
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=30,6
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=30,8
		[/remove_shroud]
		[remove_shroud]
			radius=1
			x,y=36,8
		[/remove_shroud]

# ----- Water Barrels -----
		[item]
			image=items/barrel.png
			x,y=39,23
		[/item]
		[item]
			image=items/barrel.png
			x,y=39,24
		[/item]
		[item]
			image=items/barrel.png
			x,y=38,23
		[/item]
		[item]
			image=items/barrel.png
			x,y=36,23
		[/item]
		
# ----- Workshop -----
		[item]
			image=items/anvil.png
			x,y=4,33
		[/item]
		[item]
			image=items/anvil.png
			x,y=7,35
		[/item]
# 		[item]
# 			image=items/armor-golden.png
# 			x,y=5,33
# 		[/item]
		[item]
			image=items/axe.png
			x,y=6,34
		[/item]
		[item]
			image=items/axe.png
			x,y=7,34
		[/item]
		[item]
			image=items/gold.png
			x,y=8,32
		[/item]
		[item]
			image=items/gold.png
			x,y=9,33
		[/item]
		[item]
			image=items/coal.png
			x,y=7,32
		[/item]
# 		[item]
# 			image=items/hammer-runic.png
# 			x,y=11,33
# 		[/item]
	[/event]
	
# *************************** PLAY ***************************
	[event]
		name=sighted
		[filter]
			id=spotter
		[/filter]
		[message]
			speaker=spotter
			message= _ "Th’ invaders have made it inna the Crystal Caves!"
		[/message]
	[/event]

	[event]
		name=sighted
		[filter]
			id=Golbanduth
		[/filter]

		[message]
			speaker=Golbanduth
			message= _ "The invaders approach! Fetch the last chest o’ gold. We’re equippin’ more soldiers."
		[/message]

		[message]
			speaker=porter
			message= _ "Yes, sire."
		[/message]
		{THAW_UNIT porter}
		[move_unit]
			id=porter
			to_x=15, 18
			to_y=35, 27
		[/move_unit]
		
		[gold]
			side=2
#ifdef EASY
			amount=400
#endif
#ifdef NORMAL
			amount=500
#endif
#ifdef HARD
			amount=600
#endif
		[/gold]
	[/event]
# *************************** ENDING / OPENING ***************************

#define SHAKE X Y
	[scroll]
		x,y={X},{Y}
	[/scroll]
	[delay]
		time=150
	[/delay]
#enddef

#define BREAK_STATUE
		[animate_unit]
			[filter]
				id=demolition
			[/filter]
			flag=attack
			[primary_attack]
				range=melee
			[/primary_attack]
			hits=yes
			[facing]
				x,y=31,9
			[/facing]
		[/animate_unit]
		[remove_item]
			x,y=31,9
		[/remove_item]
#enddef

	[event]
		name=start

		[teleport]
			[filter]
				id=Ardonna
			[/filter]
			x,y=33,1
			animate=no
			clear_shroud=yes
			check_passability=no
		[/teleport]
		[message]
			speaker=Ardonna
			message= _ "Actually, I don’t think this is the end. There is air coming through here. Help me shift these stones."
		[/message]
		[sound]
			name=cave-in.ogg
		[/sound]
		[delay]
			time=1000
		[/delay]
		[terrain]
			x,y=33,1
			terrain=Uu
		[/terrain]
		[unhide_unit]
			id=Ardonna
		[/unhide_unit]
		[delay]
			time=1000
		[/delay]
		[move_unit]
			id=Ardonna
			to_x=33
			to_y=9
		[/move_unit]
		[unit]
			side=1
			type=Skeleton
			x,y=32,9
			id=demolition
		[/unit]
		{RECALL_LOYAL_UNITS}
		[terrain]
			x,y=31,9
			terrain=^Kov
			layer=overlay
		[/terrain]
		[message]
			speaker=Ardonna
			message= _ "Now, where are we?"
		[/message]
		[message]
			speaker=Ras-Tabahn
			message= _ "We are in a Dwarvish burial chamber. That is good. We could always use some more soldiers."
		[/message]
		[move_unit_fake]
			type=Dwarvish Sentinel
			side=2
			x=31, 33
			y=17, 12
		[/move_unit_fake]
		[unit]
			x,y=33,12
			type=Dwarvish Sentinel
			side=2
			name= _ "Aigondur"
			id=Aigondur
		[/unit]
		[message]
			speaker=Aigondur
			message= _ "Human invaders be comin’ through the Hall o’ Heroes! I’m closin’ th’ Troll Gate!"
		[/message]
		[move_unit]
			id=Aigondur
			to_x=32
			to_y=15
		[/move_unit]
		
		[remove_item]
			image=scenery/rune4.png
			x,y=32,15
		[/remove_item]
		[item]
			image=scenery/rune4-glow.png
			x,y=32,15
		[/item]
		[redraw][/redraw]
		[delay]
			time=100
		[/delay]
		[terrain]
			x,y=33,15
			terrain=^Gytc
			layer=overlay
		[/terrain]
		[redraw][/redraw]
		[sound]
			name=explosion.ogg
		[/sound]
		{SHAKE 2 1}
		{SHAKE -1 -3}
		{SHAKE -3 1}
		{SHAKE 1 3}
		{SHAKE 1 -2}
		[delay]
			time=500
		[/delay]
		[message]
			speaker=Ardonna
			message= _ "Well, we are not going that way."
		[/message]
		[message]
			speaker=Ras-Tabahn
			message= _ "But look. There is a large crack in the wall to our left! I’m certain we could squeeze through."
		[/message]
		[message]
			speaker=Ras-Tabahn
			message= _ "We’ll just remove the statue..."
		[/message]

		{BREAK_STATUE}
		[item]
			image=items/debris1.png
			x,y=31,9
		[/item]
		[item]
			image=misc/blank-hex.png~BLIT(units/dwarves/lord-se-axe2.png~GS()~SCALE(90,90)~CROP(0,30,60,40),0,20)
			x,y=31,9
		[/item]

		{BREAK_STATUE}
		[item]
			image=items/debris2.png
			x,y=31,9
		[/item]
		[item]
			image=misc/blank-hex.png~BLIT(units/dwarves/lord-se-axe2.png~GS()~SCALE(90,90)~CROP(0,45,60,25),0,35)
			x,y=31,9
		[/item]

		{BREAK_STATUE}
		[item]
			image=items/debris3.png
			x,y=31,9
		[/item]
		[message]
			speaker=Ras-Tabahn
			message= _ "...and push the coffin out of the way."
		[/message]
		[move_unit]
			id=demolition
			to_x=30
			to_y=8
		[/move_unit]
		[modify_unit]
			[filter]
				id=demolition
			[/filter]
			facing=n
		[/modify_unit]
		[remove_item]
			x,y=30,8
		[/remove_item]
		[item]
			image=items/coffin-dwarf-back.png
			x,y=30,8
		[/item]
		[message]
			speaker=Ras-Tabahn
			message= _ "Good. Now, away with you."
		[/message]
		[terrain]
			x,y=29,9
			terrain=''
			layer=overlay
		[/terrain]
		[kill]
			id=demolition
		[/kill]
		[message]
			speaker=narrator
			image=logo.png
			message= _ "You can recruit from anywhere in the Hall of Heroes."
		[/message]
	[/event]
	
	[event]
		name=enemies defeated
		[endlevel]
			result=victory
			bonus=yes
			{NEW_GOLD_CARRYOVER 40}
		[/endlevel]
	[/event]

	{TURN_INTO_A_LICH}
	{HERO_DEATHS}
	{MANAGE_PROFILE}
	{KIDS_ADVANCE}
[/scenario]