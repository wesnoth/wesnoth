#textdomain wesnoth-sof
[scenario]
    name= _ "Searching for the Runecrafter"
    id=3_Searching_for_the_Runecrafter
    turns=20
    map_file=3_Searching_for_the_Runecrafter.map
    next_scenario=3t_The_Council_Regathers
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC wanderer.ogg}
    {EXTRA_SCENARIO_MUSIC elvish-theme.ogg}

    {DEFAULT_SCHEDULE}

    [side]
        type=Dwarvish Fighter
        id=Rugnur
        side=1
        canrecruit=yes
        controller=human
        recruit=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout
        team_name=dwarves
        user_team_name= _ "Dwarves"
        shroud=yes
        fog=yes
        {FLAG_VARIANT knalgan}
        {GOLD 160 140 120}
    [/side]

    {STARTING_VILLAGES 1 4}

    [side]
        no_leader=yes
        side=2
        team_name=monsters
        user_team_name= _ "Monsters"
    [/side]

    [story]
        [part]
            story= _ "It was a couple more weeks of marching along the tracks before a chill breeze touched Rugnur’s group, washing over them from a side tunnel leading up to the surface. Had they reached the Northlands?"
        [/part]
        [part]
            story= _ "Much to his chagrin, Alanin was dispatched to scout further up the rails, but he soon came back and claimed the rails ended — the main tunnel was unfinished to the north. For this reason, Rugnur led the dwarves up the cold passage and began to search for the runesmith named Thursagan. Thursagan, the Sage of Fire."
            background="story/cave-rails-beam.webp"
        [/part]
    [/story]

    {SOF_TRACK {JOURNEY_03_NEW} }

#define WINTERENEMY X Y
    [set_variable]
        name=typeofenemy
        rand=Frost Stoat,Icemonax,Wolf,Wolf,Great Wolf,Troll Whelp,Troll Whelp,Troll
    [/set_variable]
    [unit]
        x,y={X},{Y}
        generate_name=yes
        random_traits=yes
        type=$typeofenemy
        side=2
    [/unit]
    [if]
        [variable]
            name=typeofenemy
            equals=Wolf,Frost Stoat
        [/variable]
        [then]
            [unit]
                x,y={X},{Y}
                type=$typeofenemy
                side=2
            [/unit]
            [unit]
                x,y={X},{Y}
                type=$typeofenemy
                side=2
            [/unit]
#ifdef HARD
            [unit]
                x,y={X},{Y}
                type=$typeofenemy
                side=2
            [/unit]
#endif
        [/then]
    [/if]
    [clear_variable]
        name=typeofenemy
    [/clear_variable]
#enddef

    {SOF_DEATHS}
    {SOF_RUNIC_EVENTS}

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _ "Find Thursagan and convince him to come back to the dwarvish city"
                condition=win
                [show_if]
                    [not]
                        [have_unit]
                            # wmllint: recognize Krawg
                            id=Krawg
                        [/have_unit]
                    [/not]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Find Thursagan and convince him to come back to the dwarvish city, then bring him back to the caves"
                condition=win
                [show_if]
                    [have_unit]
                        id=Krawg
                    [/have_unit]
                    [not]
                        [have_unit]
                            # wmllint: recognize Thursagan
                            id=Thursagan
                        [/have_unit]
                    [/not]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Move Thursagan to the signpost"
                condition=win
                [show_if]
                    [have_unit]
                        id=Thursagan
                    [/have_unit]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of Rugnur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Alanin"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Baglur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Krawg"
                condition=lose
                [show_if]
                    [have_unit]
                        id=Krawg
                    [/have_unit]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of Thursagan"
                condition=lose
                [show_if]
                    [have_unit]
                        id=Thursagan
                    [/have_unit]
                [/show_if]
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        # Logic is this: -1 or less disables Thursagan events, and if below -3 there is a dialog; 0=Thursagan joins and this part is over; 1 or more, the player must find Thursagan
        [set_variable]
            name=thursagan_hunt
            value=-5
        [/set_variable]
        {WINTERENEMY 5 5}
        {WINTERENEMY 15 15}
        {WINTERENEMY 25 25}
#ifdef NORMAL
        {WINTERENEMY 30 18}
#endif
#ifdef HARD
        {WINTERENEMY 30 18}
        {WINTERENEMY 20 2}
#endif
    [/event]

    [event]
        name=turn 3
        {WINTERENEMY 20 20}
    [/event]

    [event]
        name=turn 5
        {WINTERENEMY 10 10}
        {WINTERENEMY 30 30}
    [/event]

    [event]
        name=turn 10
        [unit]
            x,y=2,17
            generate_name=yes
            random_traits=yes
            type=Snow Golem
            side=2
        [/unit]
        [unit]
            x,y=25,30
            generate_name=yes
            random_traits=yes
            type=Great Wolf
            side=2
        [/unit]
    [/event]

    [event]
        name=turn 15
        {WINTERENEMY 18 6}
        {WINTERENEMY 30 7}
    [/event]

    [event]
        name=start
        [recall]
            id=Baglur
        [/recall]
        [recall]
            id=Alanin
        [/recall]
        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
        [delay]
            time=300
        [/delay]

        {MODIFY_UNIT id=Alanin profile "portraits/alanin.webp~BLIT(portraits/alanin-winter-overlay.webp,0,0)"}

        [message]
            speaker=Alanin
            message= _ "Now where are we going, anyway? I’ve had to ride down cold, dark, unknown caves... it’s been quite harrowing, this trip had better be worth all that!"
        [/message]
        [message]
            speaker=Baglur
            message= _ "We need to find the sage Thursagan and convince him to return to the citadel with us. He’s somewhere up here."
        [/message]
        [message]
            speaker=Rugnur
            message= _ "Well, how are we supposed to find him?"
        [/message]
        [message]
            speaker=Baglur
            message= _ "His will probably be the only house up here. No one else is insane enough to live this far north! Even the elves won’t challenge us here."
        [/message]
        [message]
            speaker=Alanin
            message= _ "Elves may not challenge us, but I've heard of many other dangers lurking in the far Northlands. Wolves and trolls, but even the snow and ice itself comes alive!  We should be careful!"
        [/message]
        [message]
            speaker=Baglur
            message= _ "Right, we’ll probably have to fight our way through to his house. But we need to find it first."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            x=1-32,17-32
            y=1-21,1-31
            side=1
        [/filter]
        [move_unit_fake]
            type=Gryphon
            side=1
            x=1,5
            y=16,24
        [/move_unit_fake]
        [unit]
            type=Gryphon
            id=Krawg
            name= _ "Krawg"
            unrenamable=yes
            x,y=5,24
            side=1
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [message]
            speaker=Krawg
            #po: Krawg's speech is purposely very distorted -- he has the
            #po: vocal tract of a bird and is speaking through a beak.
            #po: "Will you speak with us?"
            message= _ "Kwill yooo spakkk wit uus?!" # wmllint: no spellcheck
        [/message]
        [message]
            speaker=Alanin
            # wmllint: local spelling Aah
            message= _ "Aah! What is that?!"
        [/message]
        [message]
            speaker=Baglur
            message= _ "Is that... is that a gryphon?"
        [/message]
        [message]
            speaker=Krawg
            message= _ "Screech!
<i>(Makes eye contact, bobs and cocks head.)</i>"
        [/message]
        [message]
            speaker=Rugnur
            message= _ "It’s talking to us! What do you want, gryphon?"
        [/message]
        [message]
            speaker=Krawg
            message= _ "Krawg!
<i>(Looks out over the icy taiga, turns gaze back toward the dwarves.)</i>"
        [/message]
        [message]
            speaker=Krawg
            message= _ "Urrrsagan?"
        [/message]
        [message]
            speaker=Rugnur
            message= _ "Well, um, yes, Thursagan. Why, can you help us find him?"
        [/message]
        [message]
            speaker=Krawg
            message= _ "Yes...
<i>(Quickly shifts gaze to nearby woods, adopts a hostile stance, then glances back at the dwarves.)</i>"
        [/message]
        [message]
            speaker=Baglur
            message= _ "Aye, trolls and wolves are closing in... sure, Krawg, we’ll help you fight them."
        [/message]
        [show_objectives]
        [/show_objectives]

        [redraw]
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto

        [filter]
            side=1
            x,y=16,17
        [/filter]
        [message]
            speaker=narrator
            caption=_"Thursagan"
            image=portraits/thursagan.webp
            message= _ "Ah!  Go away!"
        [/message]
        [move_unit_fake]
            type=Dwarvish Runemaster
            x=16,20
            y=17,15
            side=2
        [/move_unit_fake]
        [message]
            speaker=Rugnur
            message= _ "Was that Thursagan?  Finding him wasn't as difficult as I thought it would be."
        [/message]
        [message]
            speaker=Baglur
            #po: A bit of the accent, to make him more distinct from Rugnur
            #po: "Aye, but it doesn't mean much unless he stops running away from us."
            message= _ "Och, but it donna mean much unless he stops running away from us."
        [/message]
        [set_variable]
            name=thursagan_hunt
            value=-1
        [/set_variable]
        [event]
            name=moveto
            [filter]
                side=1
                x,y=20,15
                [not]
                    type=Gryphon
                [/not]
            [/filter]
            [message]
                speaker=$unit.id
                message= _ "This is just an empty shack, where could that old Runecrafter be hiding...  Wait, this scrap of wood is actually a trap door!"
            [/message]
            [message]
                speaker=Baglur
                #po: "Come on out, Thursagan!  We need your help with some serious business!"
                message= _ "C'mon out, Thursagan!  We need'ya help with some serious business!"
            [/message]
            [message]
                speaker=$unit.id
                message= _ "It's no good, he's not hiding under it, there's just this collapsed tunnel."
            [/message]
            [message]
                speaker=Rugnur
                message= _ "We have to find him!  Fan out!"
            [/message]
            [message]
                speaker=Alanin
                message= _ "I don't like this, we should stick together."
            [/message]
            [set_variable]
                name=thursagan_hunt
                {QUANTITY value 4 5 6}
            [/set_variable]
        [/event]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            [filter_location]
                terrain=*^Eshy
            [/filter_location]
            [not]
                type=Gryphon
            [/not]
        [/filter]
        [filter_condition]
            [variable]
                name=thursagan_hunt
                less_than=-3
            [/variable]
        [/filter_condition]
        [set_variable]
            name=thursagan_hunt
            value=-1
        [/set_variable]
        [message]
            speaker=$unit.id
            message= _ "An empty shack...  I thought I'd found the Runecrafter, but there's no sign of anyone having been here recently."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                terrain=*^Eshy
                [not]
                    x,y=20,15
                [/not]
            [/filter_location]
            [not]
                type=Gryphon
            [/not]
        [/filter]
        [filter_condition]
            [variable]
                name=thursagan_hunt
                greater_than=0
            [/variable]
        [/filter_condition]
        [set_variable]
            name=thursagan_hunt
            add=-1
        [/set_variable]
        [message]
            speaker=$unit.id
            message= _ "Another empty shack...  But there is this suspicious slab of wood.  Let's see what's underneath, shall we?"
        [/message]
        [switch]
            variable=thursagan_hunt
            [case]
                value=3
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "What do you people want?! Leave me alone!"
                [/message]
                [message]
                    speaker=Rugnur
                    message= _ "Old sage, we come with a message from Lord Durstorn. He asks you to come back to the city."
                [/message]
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "Ha! That fool thinks he can order me around. Why does he want me to go back, anyway?"
                [/message]
                [message]
                    speaker=Baglur
                    message= _ "We have entered into a bargain with the King of Wesnoth to craft a sceptre for him."
                [/message]
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "Oh, and now I suppose Durstorn wants me to craft it, eh? Well I’m not going to."
                [/message]
                [message]
                    speaker=$unit.id
                    message= _ "He just ducked back down underground..."
                [/message]
                {QUAKE rumble.ogg}
                [message]
                    speaker=$unit.id
                    message= _ "... and collapsed the tunnel.  He got away!"
                [/message]
                [message]
                    speaker=Rugnur
                    message= _ "He can't get far, can he?"
                [/message]
                [message]
                    speaker=Baglur
                    message= _ "Aye, the search continues."
                [/message]
            [/case]
            [case]
                value=1
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "You are playing a dangerous game!  I gave you my answer, now leave me be!"
                [/message]
                [message]
                    speaker=Rugnur
                    message= _ "You don’t want to make a sceptre to contain the power of the Ruby of Fire? It would be quite a challenge, I could see why you wouldn’t want to touch it!"
                [/message]
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "Whoa, now! The Ruby of Fire, what is that, some worthless Wesnothian gem?"
                [/message]
                [message]
                    speaker=Baglur
                    message= _ "It is a Wesnothian gem, but it is also supposedly the most powerful magical artifact ever seen. Even an untrained hand can use it to cast fiery bolts as powerful as those of arch mages."
                [/message]
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "Oh, really? And what does the King of Wesnoth want us to do with it?"
                [/message]
                [message]
                    speaker=Rugnur
                    message= _ "Contain and intensify its power."
                [/message]
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "I see. The king would cast fire like a mage. Well, good for him. Send him my regards!"
                [/message]
                [message]
                    speaker=$unit.id
                    message= _ "He just ducked back down underground..."
                [/message]
                {QUAKE rumble.ogg}
                [message]
                    speaker=$unit.id
                    message= _ "... and collapsed the tunnel.  He got away!"
                [/message]
            [/case]
            [case]
                value=0
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "You people just don't seem to understand!  I'm out here because I want no part of the nonsense of kings and those who crave power!"
                [/message]
                [message]
                    speaker=Rugnur
                    message= _ "No wait, I wasn’t clear! We need to contain this power, build some sort of magical cage!"
                [/message]
                [message]
                    speaker=Alanin
                    message= _ "The Ruby causes madness, it is said.  A magical cage that could protect the King would help us all."
                [/message]
                [message]
                    speaker=Baglur
                    message= _ "Aye, a cage, and we can’t do it on our own, Thursagan. We need your skill and expertise!"
                [/message]
                [message]
                    speaker=narrator
                    caption=_"Thursagan"
                    image=portraits/thursagan.webp
                    message= _ "Hrmph, so you need to deliver this power to the king, but also seek to contain that foolish man... I see your dilemma, and I do love a challenge, so let’s build this powerful artifact. I expect it will take years."
                [/message]
                [unit]
                    x,y=$x1,$y1
                    side=1
                    type=Dwarvish Runemaster
                    id=Thursagan
                    name= _ "Thursagan"
                    unrenamable=yes
                    profile=portraits/thursagan.webp
                    [modifications]
                        {TRAIT_LOYAL_HERO}
                        {TRAIT_STRONG}
                        [object]
                            [effect]
                                [filter]
                                    type=Dwarvish Runemaster
                                [/filter]
                                apply_to=remove_advancement
                                amlas=amla_default
                            [/effect]
                            [effect]
                                [filter]
                                    type=Dwarvish Runemaster
                                [/filter]
                                apply_to=new_advancement
                                replace=yes
                                types=Dwarvish Arcanister
                            [/effect]
                            [effect]
                                [filter]
                                    type=Dwarvish Runemaster
                                [/filter]
                                apply_to=max_experience
                                set=210
                            [/effect]
                        [/object]
                    [/modifications]
                [/unit]
                [music]
                    name=knolls.ogg
                    immediate=no
                    append=yes
                [/music]
                [message]
                    speaker=Baglur
                    message= _ "Good. Now, there are still wild animals here... we have to get back into the caves."
                [/message]
                {WINTERENEMY 19 30}
                {WINTERENEMY 1 21}
                {WINTERENEMY 31 21}
                {WINTERENEMY 1 15}
#ifdef NORMAL
                {WINTERENEMY 32 1}
#endif
#ifdef HARD
                {WINTERENEMY 32 1}
                {WINTERENEMY 32 30}
#endif

                [modify_turns]
                    add=10
                [/modify_turns]

                {HIGHLIGHT_IMAGE 4 28 scenery/signpost.png ()}

                [scroll_to]
                    x,y=$x1,$y1
                [/scroll_to]

                [show_objectives]
                [/show_objectives]
            [/case]
            [else]
                [unit]
                    x,y=$x1,$y1
                    generate_name=yes
                    random_traits=yes
                    type=Snow Golem
                    side=2
                    animate=yes
                [/unit]
                [message]
                    type=Snow Golem
                    message= _ "Ghaaah!"
                [/message]
                [message]
                    speaker=$unit.id
                    message= _ "Yikes!"
                [/message]
                [unit]
                    x,y=$x1,$y1
                    generate_name=yes
                    random_traits=yes
                    type=Snow Imp
                    side=2
                    animate=yes
                [/unit]
                [unit]
                    x,y=$x1,$y1
                    generate_name=yes
                    random_traits=yes
                    type=Snow Imp
                    side=2
                    animate=yes
                [/unit]
            [/else]
        [/switch]
    [/event]

    # Event to tell players about Thursagan's rune shop so they do not need to discover it by chance

    [event]
        name=moveto
        [filter]
            x=5-8
            y=25-29
            id=Thursagan
        [/filter]
        [message]
            speaker=Thursagan
            message= _ "If we want to make this work, we will need every rune-blasted edge we can get. If I have some time to set up shop at a keep, I can prepare a little rune-craft for your troops. My goods do not come cheap though, I will not stoop to trifling apprentice-work..."
        [/message]
    [/event]

    # Thursagan reaches the signpost

    [event]
        name=moveto
        [filter]
            x,y=4,28
            id=Thursagan
        [/filter]
        [message]
            speaker=Rugnur
            message= _ "Well, we can finally get back in our caves — away from these trolls and ogres! Come on, let’s head back south, to the city."
        [/message]
        {MAKE_LOYAL_NORMAL Baglur}
        {CLEAR_VARIABLE thur_x,thur_y}
        {SOF_CLEAR_RUNE_VARS 1}
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            id=Baglur
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]

#undef WINTERENEMY
