[scenario]
    #textdomain wesnoth-sof
    name= _ "Gathering Materials"
    id=4_Gathering_Materials
    scenario_generation=cave
    next_scenario=4t_The_Jeweler

    [generator]
        [settings]
            id=4_Gathering_Materials
            name= _ "Gathering Materials"
            {TURNS 40 37 34}
            victory_when_enemies_defeated=no
            next_scenario=4t_The_Jeweler

            {DEFAULT_MUSIC_PLAYLIST}

            [story]
                [part]
                    story= _ "Those who went to the eastern mines were brave indeed. They were infested with trolls and other vile creatures, who thrived in the dark and gloom of the caves."
                [/part]
                [part]
                    story= _ "And braver still were Rugnur and his companions, who had to spend two years in those tunnels. For mining is a lengthy business. But they could for the most part avoid the enemy. They only once had to venture into the very heart of the trolls' territory."
                [/part]
                [part]
                    background=maps/wesnoth.png
                    show_title=yes
                    {DOT 271 109}
                    {DOT 281 110}
                    {DOT 292 111}
                    {DOT 302 113}
                    {CROSS 312 116}
                [/part]
            [/story]

            {UNDERGROUND}

            {SOF_DEATHS}

            [event]
                name=prestart

                # Alanin and Krawg are taking a break

                [store_unit]
                    [filter]
                        description=Alanin
                    [/filter]

                    variable=alanin
                    kill=yes
                [/store_unit]
                [store_unit]
                    [filter]
                        description=Krawg
                    [/filter]

                    variable=krawg
                    kill=yes
                [/store_unit]

                [store_locations]
                    [filter]
                        side=1
                        canrecruit=1
                    [/filter]

                    radius=4

                    [filter_radius]
                        terrain=Cud,Kud
                    [/filter_radius]

                    variable=resource_return_locations
                [/store_locations]

                # Here we need to randomize the coal and gold locations by
                # hand, because the map generator can otherwise sometimes place
                # them inside cavewall.

                # The first coal pile is somewhere near where side 2 starts

                [store_locations]
                    [filter]
                        side=2
                        canrecruit=1
                    [/filter]

                    radius=5

                    [filter_radius]
                        terrain=!,Xu,Qxu
                    [/filter_radius]

                    variable=possible_coal_1_locations
                [/store_locations]

                {RANDOM 1..$possible_coal_1_locations.length}
                {VARIABLE_OP random add -1}

                {VARIABLE coal_1.x $possible_coal_1_locations[$random].x}
                {VARIABLE coal_1.y $possible_coal_1_locations[$random].y}

                # The second coal pile is somewhere near where side 2 starts

                [store_locations]
                    [filter]
                        side=4
                        canrecruit=1
                    [/filter]

                    radius=5

                    [filter_radius]
                        terrain=!,Xu,Qxu
                    [/filter_radius]

                    variable=possible_coal_2_locations
                [/store_locations]

                {RANDOM 1..$possible_coal_2_locations.length}
                {VARIABLE_OP random add -1}

                {VARIABLE coal_2.x $possible_coal_2_locations[$random].x}
                {VARIABLE coal_2.y $possible_coal_2_locations[$random].y}

                # And the gold pile is 8-12 hexes away from where side 3 starts

                [store_locations]
                    [and]
                        [filter]
                            side=3
                            canrecruit=1
                        [/filter]

                        radius=12

                        [filter_radius]
                            terrain=!,Xu,Qxu
                        [/filter_radius]
                    [/and]

                    [not]
                        [filter]
                            side=3
                            canrecruit=1
                        [/filter]

                        radius=8

                        [filter_radius]
                            terrain=!,Xu,Qxu
                        [/filter_radius]
                    [/not]

                    variable=possible_gold_locations
                [/store_locations]

                {RANDOM 1..$possible_gold_locations.length}
                {VARIABLE_OP random add -1}

                {VARIABLE gold_1.x $possible_gold_locations[$random].x}
                {VARIABLE gold_1.y $possible_gold_locations[$random].y}

                [item]
                    image=items/gold.png
                    x,y=$gold_1.x,$gold_1.y
                [/item]

                [item]
                    image=items/coal.png
                    x,y=$coal_1.x,$coal_1.y
                [/item]

                [item]
                    image=items/coal.png
                    x,y=$coal_2.x,$coal_2.y
                [/item]

                {VARIABLE coalin 0}
                {VARIABLE goldin 0}

                {CLEAR_VARIABLE possible_coal_1_locations}
                {CLEAR_VARIABLE possible_coal_2_locations}
                {CLEAR_VARIABLE possible_gold_locations}

                # Here we overlay a mask containing a rather random pattern of
                # suitable terrains on the map, because the map generator itself
                # only places the very basic terrains (floor, walls, etc)

                [terrain_mask]
                    x,y=1,1
                    mask="{@campaigns/Sceptre_of_Fire/maps/4_Gathering_Materials-random.mask}"

                    [rule]
                        old=Uu
                        new=Uu^Ii,Uu^Uf,Uh,Ww,Cud
                    [/rule]

                    [rule]
                        old=Xu,Cud,Kud
                        use_old=yes
                    [/rule]
                [/terrain_mask]

                [objectives]
                    side=1
                    [objective]
                        description= _ "Bring the necessary gold and coal to create the sceptre to the starting castle"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "1 load of gold and 2 loads of coal are needed"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Death of Rugnur"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Thursagan"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Time runs out"
                        condition=lose
                    [/objective]
                [/objectives]
            [/event]

            [event]
                name=start
                [recall]
                    description=Baglur
                [/recall]
                [recall]
                    description=Thursagan
                [/recall]
                [recall]
                    description=Kinan
                [/recall]
                [recall]
                    description=Rynan
                [/recall]
                [message]
                    description=Rugnur
                    message= _ "Well, these are the eastern mines. Trolls and ogres live here, be prepared to fight them; also be prepared to spend quite some time here - mining can take a while."
                [/message]
                [message]
                    description=Thursagan
                    message= _ "For me to make the artifact Haldric wants, I need a special type of gold. I do not know where it was found, but Baglur said these mines were the source of it."
                [/message]
                [message]
                    description=Baglur
                    message= _ "Also, the only coal that will melt this gold is also here."
                [/message]
                [message]
                    description=Rugnur
                    message= _ "So we're down here to, what, mine this gold and coal? That should be easy enough."
                [/message]
                [message]
                    description=Thursagan
                    message= _ "Yes, although we will have to hire the miners - they don't work for free. But beware, there are trolls and such down here..."
                [/message]
            [/event]

            [event]
                name=turn 20
                [gold]
                    side=3
                    amount=100
                [/gold]
                [allow_recruit]
                    side=3
                    recruit=Troll,Ogre
                [/allow_recruit]
            [/event]

            [event]
                name=moveto

                [filter]
                    x,y=$coal_1.x,$coal_1.y

                    [or]
                        x,y=$coal_2.x,$coal_2.y
                    [/or]

                    [and]
                        side=1

                        [not]
                            type=Dwarvish Miner
                        [/not]
                    [/and]
                [/filter]

                [message]
                    speaker=unit
                    message= _ "Here is some of the coal that we need! Bring the miners to take it!"
                [/message]

                [allow_undo][/allow_undo]
            [/event]

            [event]
                name=moveto

                [filter]
                    x,y=$coal_1.x,$coal_1.y
                    side=1
                    type=Dwarvish Miner

                    [not]
                        role=has_coal
                    [/not]

                    [not]
                        role=has_gold
                    [/not]
                [/filter]

                [message]
                    speaker=unit
                    message= _ "I have all the coal I can carry..."
                [/message]
                {VARIABLE unit.role has_coal}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [unit_overlay]
                    x,y=$x1,$y1
                    image=misc/coal-icon.png
                [/unit_overlay]
                [removeitem]
                    x,y=$x1,$y1
                [/removeitem]
            [/event]

            [event]
                name=moveto

                [filter]
                    x,y=$coal_2.x,$coal_2.y
                    side=1
                    type=Dwarvish Miner

                    [not]
                        role=has_coal
                    [/not]

                    [not]
                        role=has_gold
                    [/not]
                [/filter]

                [message]
                    speaker=unit
                    message= _ "I have all the coal I can carry..."
                [/message]
                {VARIABLE unit.role has_coal}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [unit_overlay]
                    x,y=$x1,$y1
                    image=misc/coal-icon.png
                [/unit_overlay]
                [removeitem]
                    x,y=$x1,$y1
                [/removeitem]
            [/event]

            [event]
                name=moveto

                [filter]
                    x,y=$gold_1.x,$gold_1.y
                    side=1

                    [not]
                        type=Dwarvish Miner
                    [/not]
                [/filter]

                [message]
                    speaker=unit
                    message= _ "Here is the mine of precious gold! Send the miners this way."
                [/message]

                [allow_undo][/allow_undo]
            [/event]

            [event]
                name=moveto

                [filter]
                    x,y=$gold_1.x,$gold_1.y
                    side=1
                    type=Dwarvish Miner

                    [not]
                        role=has_coal
                    [/not]

                    [not]
                        role=has_gold
                    [/not]
                [/filter]

                [message]
                    speaker=unit
                    message= _ "I have all the gold I can carry..."
                [/message]
                {VARIABLE unit.role has_gold}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [unit_overlay]
                    x,y=$x1,$y1
                    image=misc/gold-icon.png
                [/unit_overlay]
                [removeitem]
                    x,y=$x1,$y1
                [/removeitem]
            [/event]

            # If a miner carrying coal dies, we let others pick it up

            [event]
                name=die
                first_time_only=no

                [filter]
                    side=1
                    type=Dwarvish Miner
                    role=has_coal
                [/filter]

                [item]
                    x,y=$x1,$y1
                    image=items/coal.png
                [/item]

                {VARIABLE hex_$x1|_$y1|_coal yes}
            [/event]

            [event]
                name=moveto
                first_time_only=no

                [filter]
                    side=1
                    type=Dwarvish Miner

                    [not]
                        role=has_coal
                    [/not]

                    [not]
                        role=has_gold
                    [/not]
                [/filter]

                [if]
                    [variable]
                        name=hex_$x1|_$y1|_coal
                        equals=yes
                    [/variable]

                    [then]
                        [message]
                            speaker=unit
                            message= _ "I have all the coal I can carry..."
                        [/message]

                        {VARIABLE unit.role has_coal}

                        [unstore_unit]
                            variable=unit
                            find_vacant=no
                        [/unstore_unit]

                        [unit_overlay]
                            x,y=$x1,$y1
                            image=misc/coal-icon.png
                        [/unit_overlay]

                        [removeitem]
                            x,y=$x1,$y1
                        [/removeitem]

                        {CLEAR_VARIABLE hex_$x1|_$y1|_coal}
                    [/then]

                    [else]
                        [allow_undo][/allow_undo]
                    [/else]
                [/if]
            [/event]

            # Exactly same as above, but for gold

            [event]
                name=die
                first_time_only=no

                [filter]
                    side=1
                    type=Dwarvish Miner
                    role=has_gold
                [/filter]

                [item]
                    x,y=$x1,$y1
                    image=items/gold.png
                [/item]

                {VARIABLE hex_$x1|_$y1|_gold yes}
            [/event]

            [event]
                name=moveto
                first_time_only=no

                [filter]
                    side=1
                    type=Dwarvish Miner

                    [not]
                        role=has_coal
                    [/not]

                    [not]
                        role=has_gold
                    [/not]
                [/filter]

                [if]
                    [variable]
                        name=hex_$x1|_$y1|_gold
                        equals=yes
                    [/variable]

                    [then]
                        [message]
                            speaker=unit
                            message= _ "I have all the gold I can carry..."
                        [/message]

                        {VARIABLE unit.role has_gold}

                        [unstore_unit]
                            variable=unit
                            find_vacant=no
                        [/unstore_unit]

                        [unit_overlay]
                            x,y=$x1,$y1
                            image=misc/gold-icon.png
                        [/unit_overlay]

                        [removeitem]
                            x,y=$x1,$y1
                        [/removeitem]

                        {CLEAR_VARIABLE hex_$x1|_$y1|_gold}
                    [/then]

                    [else]
                        [allow_undo][/allow_undo]
                    [/else]
                [/if]
            [/event]

            [event]
                name=moveto
                first_time_only=no
                [filter]
                    type=Dwarvish Miner
                    role=has_coal

                    [filter_location]
                        find_in=resource_return_locations
                    [/filter_location]
                [/filter]
                [message]
                    speaker=unit
                    message= _ "My load of coal is delivered!"
                [/message]

                {CLEAR_VARIABLE unit.role}

                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]

                [remove_unit_overlay]
                    x,y=$x1,$y1
                    image=misc/coal-icon.png
                [/remove_unit_overlay]

                [set_variable]
                    name=coalin
                    add=1
                [/set_variable]

                [if]
                    [variable]
                        name=coalin
                        greater_than_equal_to=2
                    [/variable]
                    [then]
                        [message]
                            speaker=unit
                            message= _ "That's the last load of coal we need."
                        [/message]
                        [if]
                            [variable]
                                name=goldin
                                greater_than_equal_to=1
                            [/variable]
                            [then]
                                [message]
                                    description=Thursagan
                                    message= _ "This is all we need from these mines. Now we should go back further west, where there are no trolls and ogres, and mine there."
                                [/message]
                                [clear_variable]
                                    name=coalin
                                [/clear_variable]
                                [clear_variable]
                                    name=goldin
                                [/clear_variable]
                                [endlevel]
                                    result=victory
                                    bonus=yes
                                [/endlevel]
                            [/then]
                        [/if]
                    [/then]
                [/if]
            [/event]

            [event]
                name=moveto
                first_time_only=no
                [filter]
                    type=Dwarvish Miner
                    role=has_gold

                    [filter_location]
                        find_in=resource_return_locations
                    [/filter_location]
                [/filter]
                [message]
                    speaker=unit
                    message= _ "Here's the gold."
                [/message]

                {CLEAR_VARIABLE unit.role}

                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]

                [remove_unit_overlay]
                    x,y=$x1,$y1
                    image=misc/gold-icon.png
                [/remove_unit_overlay]

                [set_variable]
                    name=goldin
                    add=1
                [/set_variable]

                [if]
                    [variable]
                        name=goldin
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=coalin
                                greater_than_equal_to=2
                            [/variable]
                            [then]
                                [message]
                                    description=Thursagan
                                    message= _ "This is all we need from these mines. Now we should go back further west, where there are no trolls and ogres, and mine there."
                                [/message]

                                [endlevel]
                                    result=victory
                                    bonus=yes
                                [/endlevel]
                            [/then]
                        [/if]
                    [/then]
                [/if]
            [/event]

            [event]
                name=victory

                [unstore_unit]
                    variable=alanin
                [/unstore_unit]

                [unstore_unit]
                    variable=krawg
                [/unstore_unit]

                {CLEAR_VARIABLE alanin}
                {CLEAR_VARIABLE krawg}

                {CLEAR_VARIABLE coalin}
                {CLEAR_VARIABLE goldin}
                {CLEAR_VARIABLE coal_1}
                {CLEAR_VARIABLE coal_2}
                {CLEAR_VARIABLE gold_1}
                {CLEAR_VARIABLE resource_return_locations}

                [kill]
                    type=Dwarvish Miner
                [/kill]
            [/event]
        [/settings]

        map_width=45
        map_height=45
        flipx_chance=0
        village_density=50

        #the chamber with the player. Near the south-west corner
        [chamber]
            id=player
            x=10-15
            y=32-38
            size=7
            jagged=40
            [items]
                [side]
                    type=Dwarvish Fighter
                    description=Rugnur
                    side=1
                    canrecruit=1
                    recruit=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Gryphon Rider,Dwarvish Miner
                    controller=human
                    shroud=yes
                [/side]
            [/items]
        [/chamber]

        #the chamber with the coal. Somewhere in the southeast.
        [chamber]
            id=coal1
            x=28-35
            y=28-35
            size=8
            [passage]
                chance=70
                width=1
                windiness=5
                destination=gold
            [/passage]
            [passage]
                chance=50
                width=2
                windiness=5
                destination=coal2
            [/passage]
            [passage]
                chance=50
                width=2
                windiness=5
                destination=gold
            [/passage]
            [passage]
                chance=50
                width=2
                windiness=10
                destination=coal2
            [/passage]
            [items]
                [side]
                    type=Troll
                    side=2
                    canrecruit=1
                    controller=ai
                    [ai]
                        leader_value=10
                        recruitment_pattern=fighter
                    [/ai]
                    recruit=Troll Whelp,Goblin Spearman
                    team_name=trolls
                    {GOLD 50 70 90}
                [/side]
            [/items]
        [/chamber]

        #the northern chamber with only bad guys. Somewhere in the north-east.
        [chamber]
            id=gold
            x=28-35
            y=5-12
            size=8
            jagged=50
            [passage]
                chance=100
                width=2
                windiness=10
                destination=coal1
            [/passage]
            [passage]
                chance=100
                width=2
                windiness=10
                destination=coal2
            [/passage]
            [passage]
                chance=50
                width=1
                windiness=5
                destination=coal1
            [/passage]
            [passage]
                chance=50
                width=1
                windiness=5
                destination=coal2
            [/passage]
            [items]
                [side]
                    type=Troll
                    side=3
                    canrecruit=1
                    controller=ai
                    [ai]
                        leader_value=20
                        recruitment_pattern=fighter
                    [/ai]
                    recruit=Troll Whelp,Goblin Spearman,Young Ogre
                    team_name=trolls
                    {GOLD 50 70 90}
                [/side]
            [/items]
        [/chamber]

        #chamber with the second coal mine. Somewhere in the north-west.
        [chamber]
            id=coal2
            x=8-12
            y=8-12
            size=7
            [passage]
                chance=70
                width=1
                windiness=5
                destination=gold
            [/passage]
            [passage]
                chance=50
                width=2
                windiness=5
                destination=coal1
            [/passage]
            [passage]
                chance=50
                width=2
                windiness=5
                destination=gold
            [/passage]
            [passage]
                chance=50
                width=1
                windiness=5
                destination=coal1
            [/passage]
            [items]
                [side]
                    type=Troll
                    side=4
                    canrecruit=1
                    controller=ai
                    [ai]
                        leader_value=10
                        recruitment_pattern=fighter
                    [/ai]
                    recruit=Goblin Spearman,Young Ogre
                    {GOLD 50 70 90}
                [/side]
            [/items]
        [/chamber]

        #chamber with gold in it that connects to all the others
        [chamber]
            id=connector
            x=15-20
            y=15-20
            size=4
            #passages to both the troll's chamber and the player's chamber
            [passage]
                destination=player
                width=2
                windiness=10
            [/passage]
            [passage]
                destination=coal1
                width=2
                windiness=10
            [/passage]
            [passage]
                destination=coal2
                width=2
                windiness=10
            [/passage]
            [passage]
                destination=gold
                width=2
                windiness=10
            [/passage]
        [/chamber]
    [/generator]
[/scenario]
