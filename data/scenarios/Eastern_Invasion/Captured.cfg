[scenario]
id=Captured
#textdomain wesnoth-ei
name= _ "Captured"
map_data="{maps/Eastern_Invasion/Captured}"

	{TURNS 96 80 64}

	{UNDERGROUND}

next_scenario=Evacuation

music="wesnoth-5.ogg"

	{scenarios/Eastern_Invasion/deaths.cfg}

victory_when_enemies_defeated=no

	[story]
		[part]
			background=campaigns/Eastern_Invasion/maps/eastern_invasion.png
			show_title=yes
		[/part]
	[/story]

	#########################
	#names for all the rooms#
	#########################
	[label]
	x,y=8,23
	text=_"The Cells"
	[/label]
	[label]
	x,y=10,18
	text=_"Guard Room"
	[/label]
	[label]
	x,y=19,15
	text=_"Prison"
	[/label]
	[label]
	x,y=23,14
	text=_"Torture Chamber"
	[/label]
	[label]
	x,y=16,8
	text=_"Storage Room"
	[/label]
	[label]
	x,y=23,8
	text=_"The City"
	[/label]
	[label]
	x,y=26,11
	text=_"Exit"
	[/label]

	#######
	#sides#
	#######
	[side]
	type=General
	description=Gweddry
	user_description= _ "Gweddry"
	side=1
	canrecruit=0
	controller=human
	team_name=good
	fog=yes
	shroud=yes
	[/side]
	
	[side]
	type=Orcish Warlord
	description=King Dra-Nak
	user_description= _ "King Dra-Nak"
	side=2
	canrecruit=1
	controller=ai
	recruit=
	{GOLD 40 50 60}
		[ai]
		passive_leader=yes
		grouping=no
		recruitment_ignore_bad_combat=yes
		aggressive=0.4
			[avoid]
			x=1-7,7-14,14-21
			y=1-24,21-24,16-24
			[/avoid]
		[/ai]
	team_name=bad
	[/side]

	[side]
	type=Elvish Hero
	side=3
	team_name=good
	[/side]

	[side]
	type=Blood Bat
	side=4
		[ai]
		aggression=100.0
			[avoid]
			type=Gate
			[/avoid]
		[/ai]
	team_name=bad
	[/side]

	#####################
	#lots of definitions#
	#####################

#define TELEPORT X1 Y1 X2 Y2 X3 Y3
[teleport]
	[filter]
	description=Gweddry
	[/filter]
x={X1}
y={Y1}
[/teleport]
[teleport]
	[filter]
	description=Dacyn
	[/filter]
x={X2}
y={Y2}
[/teleport]
[teleport]
	[filter]
	description=Owaec
	[/filter]
x={X3}
y={Y3}
[/teleport]
[scroll_to_unit]
description=Gweddry
[/scroll_to_unit]
[delay]
time=500
[/delay]
#enddef

#define WHIP
[sound]
name=gunshot.wav
[/sound]
[colour_adjust]
red=100
green=0
blue=0
[/colour_adjust]
[delay]
time=100
[/delay]
[sound]
name=groan.wav
[/sound]
[colour_adjust]
red=0
green=0
blue=0
[/colour_adjust]
#enddef

#define GUARD X Y T
[unit]
type={T}
side=2
x={X}
y={Y}
ai_special=guardian
[/unit]
#enddef

#define SIDE4 X Y T
[unit]
type={T}
side=4
x={X}
y={Y}
[/unit]
#enddef

#define DOOR X Y
{GUARD {X} {Y} Gate}
#enddef

#define PRISON X Y
[set_variable]
name=type
random=Elvish Archer,Elvish Fighter,Dwarvish Fighter,Dwarvish Thunderer,Elvish Shaman,Spearman,Bowman
[/set_variable]
[unit]
type=$type
side=3
x={X}
y={Y}
	[modifications]
		[trait]
			[effect]
			apply_to=attack
			range=short
			increase_damage=-50%
			[/effect]
			[effect]
			apply_to=attack
			range=long
			increase_damage=-75%
			[/effect]
			[effect]
			apply_to=hitpoints
			increase=-75%
			[/effect]
		[/trait]
	[/modifications]
[/unit]
#enddef

#define TRUESTORE D V
[store_unit]
	[filter]
	description={D}
	[/filter]
variable={V}
[/store_unit]
[kill]
description={D}
[/kill]
#enddef

#define ROLE T R X Y V L
[role]
type={T}
side=1
role={R}
[/role]
[recall]
role={R}
[/recall]
[teleport]
	[filter]
	role={R}
	[/filter]
x={X}
y={Y}
[/teleport]

[store_unit]
	[filter]
	role={R}
	[/filter]
variable={V}
kill=yes
[/store_unit]
[set_variable]
name={V}.description
value={L}
[/set_variable]
#enddef

#define TRUEUNSTORE X Y V
[filter]
x={X}
y={Y}
side=1
[/filter]
[unstore_unit]
variable={V}
find_vacant=yes
[/unstore_unit]
#enddef

	######################
	#/lots of definitions#
	######################

	[event]
	name=prestart
		[objectives]
		side=1
			[objective]
			description= _ "Escape from the Orcish Prisons"
			condition=win
			[/objective]
			[objective]
			description= _ "Death of Gweddry"
			condition=lose
			[/objective]
			[objective]
			description= _ "Death of Dacyn"
			condition=lose
			[/objective]
			[objective]
			description= _ "Death of Owaec"
			condition=lose
			[/objective]
		[/objectives]
	[/event]

	########################################
	#starting units (like guards and doors)#
	########################################
	[event]
	name=prestart
	# a bunch of doors
		{DOOR 5 22}
		{DOOR 5 19}
		{DOOR 5 13}
		{DOOR 5 9}
		{DOOR 5 6}
		{DOOR 10 15}
		{DOOR 14 13}
		{DOOR 18 15}
		{DOOR 23 15}
		{DOOR 29 18}
		{DOOR 17 7}
		{DOOR 23 7}
		{DOOR 29 4}
		{DOOR 27 11}
		{DOOR 32 11}

	#the first guards
		{GUARD 41 5 Troll}
#ifdef HARD
		{GUARD 44 5 Troll}
#endif
		{GUARD 34 9 Troll}
#ifdef EASY
#else
		{GUARD 35 12 Troll}
#endif


	#adding the last guards
	#high-security jail cell guards
		{GUARD 8 17 (Troll Whelp)}
		{GUARD 8 19 (Troll Whelp)}
#ifdef HARD
		{GUARD 12 17 (Troll Whelp)}
		{GUARD 12 19 (Troll Whelp)}
#endif
		{GUARD 10 16 Troll}
		
	#kings chamber guards
#ifdef EASY
		{GUARD 16 10 (Orcish Grunt)}
		{GUARD 16 12 (Orcish Grunt)}
		{GUARD 19 14 (Orcish Grunt)}
		{GUARD 22 13 (Orcish Grunt)}
		{GUARD 25 11 (Orcish Grunt)}
		{GUARD 22 8 (Orcish Grunt)}
		{GUARD 18 8 (Orcish Grunt)}
#else
		{GUARD 16 10 (Orcish Warrior)}
		{GUARD 16 12 (Orcish Warrior)}
		{GUARD 19 14 (Orcish Warrior)}
		{GUARD 22 13 (Orcish Warrior)}
		{GUARD 25 11 (Orcish Warrior)}
		{GUARD 22 8 (Orcish Warrior)}
		{GUARD 18 8 (Orcish Warrior)}
#endif

	#torture chamber guards
		{GUARD 34 20 (Orcish Slayer)}
		{GUARD 30 20 (Orcish Assassin)}
		{GUARD 32 17 (Orcish Assassin)}
			
	#these are bats that inhabit the dungeons (i needed to make it somewhat interesting)
	#these ones live in the cells themselves
		{SIDE4 2 22 (Blood Bat)}
		{SIDE4 5 16 (Vampire Bat)}
		{SIDE4 8 12 (Vampire Bat)}
		{SIDE4 8 8 (Vampire Bat)}
		{SIDE4 8 4 (Vampire Bat)}
		
	#to make sure you know where the door is
		{ITM_BALL_GREEN 10 21}
	[/event]


	#############################
	#THE START EVENT BEGINS HERE#
	#############################
	[event]
	name=start
	################
	#getting people#
	################
	#getting Dacyn and Owaec
		[recall]
		description=Dacyn
		[/recall]
		[recall]
		description=Owaec
		[/recall]
		
	#getting the sidekicks
		{ROLE (Red Mage,Longbowman,Master Bowman,Arch Mage,Silver Mage,Great Mage) SIDE1 7 9 R1 Ranged}
		{ROLE (Swordsman,Pikeman,Royal Guard,Halbardier) SIDE2 7 13 R2 Melee}
		
	##################
	#huge intro scene#
	##################
	#teleporting madness
		{WHIP}
		{TELEPORT 34 11 33 9 34 13}
		{WHIP}
		{TELEPORT 23 10 23 11 23 9}
		
	#some talking
		[message]
		description=King Dra-Nak
		id=msg_cmpgn_ei_14_01
		message= _ "Why have you entered my lands?!?"
		[/message]
		[message]
		description=Gweddry
		id=msg_cmpgn_ei_14_02
		message= _ "We were traveling-"
		[/message]
		[message]
		description=King Dra-Nak
		id=msg_cmpgn_ei_14_03
		message= _ "Silence! Did I ask you?"
		[/message]
		[message]
		description=Dacyn
		id=msg_cmpgn_ei_14_04
		message= _ "Um... yes."
		[/message]
		[message]
		description=King Dra-Nak
		id=msg_cmpgn_ei_14_05
		message= _ "That's enough! I'm putting you in the high-security cave!"
		[/message]
		
	#and more teleporting
		{TELEPORT 10 19 11 18 10 16}
		{WHIP}
		{TELEPORT 3 22 7 5 5 17}
		{WHIP}
		
	#storing Dacyn and Owaec
		{TRUESTORE Dacyn D}
		{TRUESTORE Owaec O}
		
	#Gweddry talks to himself
		[message]
		description=Gweddry
		id=msg_cmpgn_ei_14_06
		message= _ "Ugh..."
		[/message]
		[message]
		description=Gweddry
		id=msg_cmpgn_ei_14_07
		message= _ "Huh? Where am I? I'm tied to the ground!"
		[/message]
		[message]
		description=Gweddry
		id=msg_cmpgn_ei_14_08
		message= _ "I must be in some sort of prison... hmm the guard didn't tie me very well. I can escape from these knots."
		[/message]
		#add sounds of Gweddry escaping
		[message]
		description=Gweddry
		id=msg_cmpgn_ei_14_09
		message= _ "That's better! I wonder how many other prisoners have been captured that I will have to rescue."
		[/message]
		[message]
		description=Gweddry
		id=msg_cmpgn_ei_14_10
		message= _ "Since they are probably tied down like I was, I will have to get into their cells in order to see them."
		[/message]
		
		#######################
		#event inside an event#
		#######################
		[event]
		name=sighted
			[filter]
			type=Orcish Grunt,Orcish Warrior
			[/filter]
			[message]
			speaker=unit
			id=msg_cmpgn_ei_14_23
			message= _ "The high security prisoners are escaping!"
			[/message]
			[message]
			description=King Dra-Nak
			id=msg_cmpgn_ei_14_24
			message= _ "Kill them."
			[/message]
		#these are prisoners even though the macro is called PRISON
		#first group of prisoners- in the large cell
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
#ifdef NORMAL
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
#endif

#ifdef EASY
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
			{PRISON 17 19}
#endif
		#a prisoner says something
			[message]
			speaker=narrator
			message= _ "The guards are distracted! Now is the time to escape!"
			[/message]
			[message]
			description=Gweddry
			message= _ "Huh? Who's there, who said that?"
			[/message]
		[/event]
		########################
		#/event inside an event#
		########################
		
	[/event]
	###########################
	#THE START EVENT ENDS HERE#
	###########################


	##########################################
	#rescuing Dacyn, Owaec and the two others#
	##########################################

	#Owaec
	[event]
	name=moveto
		{TRUEUNSTORE 4-6 16-18 O}
		[message]
		description=Gweddry
		message= _ "So you are in this cell! Come on, we have to escape!"
		[/message]
		[message]
		description=Owaec
		message= _ "Very well. I think the rest of the cells are further down this path."
		[/message]
	[/event]
	
	#Melee sidekick
	[event]
	name=moveto
		{TRUEUNSTORE 6-8 12-14 R2}
		[message]
		description=Gweddry
		message= _ "So, they have captured some of our best fighters as well as me, Dacyn and Owaec. $R2.user_description, follow me! We must get out of this dungeon."
		[/message]
	[/event]
	
	#Ranged sidekick
	[event]
	name=moveto
		{TRUEUNSTORE 6-8 8-10 R1}
		[message]
		description=Gweddry
		message= _ "Interesting, they put the most powerful of us in the high security prisons. Where are the others, I wonder?"
		[/message]
	[/event]

	#Dacyn
	[event]
	name=moveto
		{TRUEUNSTORE 6-8 4-6 D}
		[message]
		description=Gweddry
		message= _ "Dacyn! This looks like the last cell, so we should just get out of here now. But how can we do that?"
		[/message]
		[message]
		description=Owaec
		message= _ "Well, we could try going out the way we came in, but that door is probably locked."
		[/message]
		[message]
		description=Dacyn
		message= _ "The guard who took us down here went into a hidden room when he closed this door. It was right outside this cell. If we can find and kill this guard, the key should be nearby."
		[/message]
		[item]
		image=items/castle-ruins.png
		x,y=4,5
		[/item]
		##########################
		#the key in all its glory#
		##########################
		#getting into the chamber
		[event]
		name=moveto
			[filter]
			x=4,3
			y=5,6
			side=1
			[/filter]
			[message]
			speaker=unit
			message= _ "Here is the thin spot in the wall. Well, actually, no- it's not a thin spot at all! It's really a door!"
			[/message]
			[terrain]
			x,y=3,5
			letter=r
			[/terrain]
			[removeitem]
			x,y=4,5
			[/removeitem]
			{GUARD 3 3 (Troll Warrior)}
			[message]
			description=Owaec
			message= _ "Huh! A guard. Once we kill him, we should be able to get out of these cells..."
			[/message]
			#barrel
			{ITM_BARREL 3 2}
		[/event]
		#the key itself
		[event]
		name=moveto
			[filter]
			x,y=3,2
			side=1
			[/filter]
			[message]
			speaker=unit
			id=msg_cmpgn_ei_14_21
			message= _ "I have found the key! Let's get out of here!"
			[/message]
			[set_variable]
			name=key
			value=yes
			[/set_variable]
			#opening the door with the key
			[event]
			name=moveto
				[filter]
				x=10
				y=22
				side=1
				[/filter]
				[message]
				description=Gweddry
				message= _ "This is the right key! come on, let's open the door, quick!"
				[/message]
				[terrain]
				x=10
				y=21
				letter=u
				[/terrain]
				[set_variable]
				name=key
				value=no
				[/set_variable]
			[/event]
		[/event]
	[/event]

	###########
	#Bat stuff#
	###########
	#some more bats appear when you kill the first gate gate
	#these ones live in the halls
	[event]
	name=die
		[filter]
		type=Gate
		[/filter]
		{SIDE4 2 6 (Blood Bat)}
		{SIDE4 2 8 (Vampire Bat)}
		{SIDE4 2 10 (Vampire Bat)}
		{SIDE4 2 12 (Vampire Bat)}
		{SIDE4 2 14 (Vampire Bat)}
	[/event]
	
	#this was added to stop the bats from attacking the doors
	[event]
	name=die
	first_time_only=no
		[filter]
		type=Gate
		[/filter]
		[terrain]
		x=$x1
		y=$y1
		letter=E
		[/terrain]
	[/event]



	#opening the door
	
	
	######################################
	#Valand and his worthless compatriots#
	######################################
	[event]
	name=die
		[filter]
		x,y=29,18
		[/filter]
		[unit]
		type=Elvish Hero
		description=Valand
		user_description= _ "Valand"
		side=1
		x,y=32,19
		[/unit]
		{PRISON 32 19}
		{PRISON 32 19}
		[message]
		description=Valand
		message= _ "Help us! The guards are planning to execute us tomorrow!"
		[/message]
		[message]
		x,y=34,20
		message= _ "Hah! Tomorrow? You make a big mistake if you believe you will live that long."
		[/message]
		[message]
		x,y=30,20
		message= _ "Right, boss, especially since they're invading, and we need to kill them now before they escape!"
		[/message]
	[/event]

	#######################################
	#when the king dies, bad stuff happens#
	#######################################
	[event]
	name=die
		[filter]
		description=King Dra-Nak
		[/filter]
		[message]
		speaker=unit
		message= _ "Argh! Oh well, at least my vast hordes will defeat you!"
		[/message]
		{GUARD 20 10 (Orcish Grunt)}
		{GUARD 20 10 (Orcish Grunt)}
		{GUARD 20 10 (Orcish Grunt)}
		{GUARD 20 10 (Orcish Grunt)}
		{GUARD 20 10 (Orcish Grunt)}
		{GUARD 20 10 (Orcish Grunt)}
		[unit]
		side=2
		x=26
		y=5
		type=Orcish Warrior
		[/unit]
		[unit]
		side=2
		x=27
		y=5
		type=Orcish Warrior
		[/unit]
		[unit]
		side=2
		x=28
		y=4
		type=Orcish Warrior
		[/unit]
	[/event]
	
	##################################
	#eternal holy water is always fun#
	##################################
	[item]
	x=12
	y=4
	image=misc/item-holywater.png
	[/item]

	[event]
	name=moveto
		[filter]
		side=1
		x=12
		y=4
		[/filter]
		[object]
		id=holywater
		name= _ "Holy Water"
		image=misc/item-holywater.png
		duration=forever
		description= _ "This water will make all of your weapons holy for your whole life!"
		cannot_use_message= _ "I am not suited to using this item! Let another take it."
			[then]
				[removeitem]
				x=12
				y=4
				[/removeitem]
			[/then]
			[effect]
			apply_to=attack
			range=short
			set_type=holy
			[/effect]
			[effect]
			apply_to=attack
			range=long
			set_type=holy
			[/effect]
		[/object]
	[/event]

	#########
	#victory#
	#########
	#when you exit the caves, you win
	[event]
	name=moveto
		[filter]
		x=37,38,39,40
		y=9,8,8,7
		description=Gweddry
		[/filter]
		[message]
		description=Gweddry
		message= _ "Good! We have escaped these accursed caves! Let's get out of these mountains as quickly as possible!"
		[/message]
		[message]
		description=Valand
		message= _ "I will come with you and help you on your quest, whatever it is."
		[/message]
		[endlevel]
		result=victory
		bonus=yes
		[/endlevel]
	[/event]
[/scenario]
